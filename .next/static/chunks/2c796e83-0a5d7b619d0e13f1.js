(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[634],{6158:function(en,el,eu){var ec=eu(3454);en.exports=function(){"use strict";var en,el,eu;function define(ec,ed){if(en){if(el){var ef="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+en+")(sharedChunk); ("+el+")(sharedChunk); self.onerror = null;",em={};en(em),eu=ed(em),"undefined"!=typeof window&&window&&window.URL&&window.URL.createObjectURL&&(eu.workerUrl=window.URL.createObjectURL(new Blob([ef],{type:"text/javascript"})))}else el=ed}else en=ed}return define(["exports"],function(en){let el,eu,ed,ef,em,e_,ew,eT,eM,eE,eS;var eA,eI="3.2.0";let eC={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(null==el){let en=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{el=null!=ec.env.API_URL_REGEX?new RegExp(ec.env.API_URL_REGEX):en}catch(eu){el=en}}return el},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!eC.API_URL)return null;try{let en=new URL(eC.API_URL);return"api.mapbox.cn"===en.hostname?"https://events.mapbox.cn/events/v2":"api.mapbox.com"===en.hostname?"https://events.mapbox.com/events/v2":null}catch(en){return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},eP={supported:!1,testSupport:function(en){!eL&&eD&&(ek?c(en):ez=en)}},ez,eD,eL=!1,ek=!1,eR="undefined"!=typeof self?self:{};function c(en){let el=en.createTexture();en.bindTexture(en.TEXTURE_2D,el);try{if(en.texImage2D(en.TEXTURE_2D,0,en.RGBA,en.RGBA,en.UNSIGNED_BYTE,eD),en.isContextLost())return;eP.supported=!0}catch(en){}en.deleteTexture(el),eL=!0}function p(en){return en&&en.__esModule&&Object.prototype.hasOwnProperty.call(en,"default")?en.default:en}function d(en,el,eu,ec){this.cx=3*en,this.bx=3*(eu-en)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*el,this.by=3*(ec-el)-this.cy,this.ay=1-this.cy-this.by,this.p1x=en,this.p1y=el,this.p2x=eu,this.p2y=ec}eR.document&&((eD=eR.document.createElement("img")).onload=function(){ez&&c(ez),ez=null,ek=!0},eD.onerror=function(){eL=!0,ez=null},eD.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA="),d.prototype={sampleCurveX:function(en){return((this.ax*en+this.bx)*en+this.cx)*en},sampleCurveY:function(en){return((this.ay*en+this.by)*en+this.cy)*en},sampleCurveDerivativeX:function(en){return(3*this.ax*en+2*this.bx)*en+this.cx},solveCurveX:function(en,el){if(void 0===el&&(el=1e-6),en<0)return 0;if(en>1)return 1;for(var eu=en,ec=0;ec<8;ec++){var ed=this.sampleCurveX(eu)-en;if(Math.abs(ed)<el)return eu;var ef=this.sampleCurveDerivativeX(eu);if(1e-6>Math.abs(ef))break;eu-=ed/ef}var em=0,e_=1;for(eu=en,ec=0;ec<20&&!(Math.abs((ed=this.sampleCurveX(eu))-en)<el);ec++)en>ed?em=eu:e_=eu,eu=.5*(e_-em)+em;return eu},solve:function(en,el){return this.sampleCurveY(this.solveCurveX(en,el))}};var eO=p(d);function g(en,el){this.x=en,this.y=el}g.prototype={clone:function(){return new g(this.x,this.y)},add:function(en){return this.clone()._add(en)},sub:function(en){return this.clone()._sub(en)},multByPoint:function(en){return this.clone()._multByPoint(en)},divByPoint:function(en){return this.clone()._divByPoint(en)},mult:function(en){return this.clone()._mult(en)},div:function(en){return this.clone()._div(en)},rotate:function(en){return this.clone()._rotate(en)},rotateAround:function(en,el){return this.clone()._rotateAround(en,el)},matMult:function(en){return this.clone()._matMult(en)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(en){return this.x===en.x&&this.y===en.y},dist:function(en){return Math.sqrt(this.distSqr(en))},distSqr:function(en){var el=en.x-this.x,eu=en.y-this.y;return el*el+eu*eu},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(en){return Math.atan2(this.y-en.y,this.x-en.x)},angleWith:function(en){return this.angleWithSep(en.x,en.y)},angleWithSep:function(en,el){return Math.atan2(this.x*el-this.y*en,this.x*en+this.y*el)},_matMult:function(en){var el=en[2]*this.x+en[3]*this.y;return this.x=en[0]*this.x+en[1]*this.y,this.y=el,this},_add:function(en){return this.x+=en.x,this.y+=en.y,this},_sub:function(en){return this.x-=en.x,this.y-=en.y,this},_mult:function(en){return this.x*=en,this.y*=en,this},_div:function(en){return this.x/=en,this.y/=en,this},_multByPoint:function(en){return this.x*=en.x,this.y*=en.y,this},_divByPoint:function(en){return this.x/=en.x,this.y/=en.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var en=this.y;return this.y=this.x,this.x=-en,this},_rotate:function(en){var el=Math.cos(en),eu=Math.sin(en),ec=eu*this.x+el*this.y;return this.x=el*this.x-eu*this.y,this.y=ec,this},_rotateAround:function(en,el){var eu=Math.cos(en),ec=Math.sin(en),ed=el.y+ec*(this.x-el.x)+eu*(this.y-el.y);return this.x=el.x+eu*(this.x-el.x)-ec*(this.y-el.y),this.y=ed,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},g.convert=function(en){return en instanceof g?en:Array.isArray(en)?new g(en[0],en[1]):en};var eB=p(g);let eF=Math.PI/180,eN=180/Math.PI,eU=[[0,0],[1,0],[1,1],[0,1]];function A(en){if(en<=0)return 0;if(en>=1)return 1;let el=en*en,eu=el*en;return 4*(en<.5?eu:3*(en-el)+eu-.75)}function S(en,el,eu,ec){let ed=new eO(en,el,eu,ec);return function(en){return ed.solve(en)}}let eV=S(.25,.1,.25,1);function k(en,el,eu){return Math.min(eu,Math.max(el,en))}function T(en,el,eu){return(eu=k((eu-en)/(el-en),0,1))*eu*(3-2*eu)}function P(en,el,eu){let ec=eu-el,ed=((en-el)%ec+ec)%ec+el;return ed===el?eu:ed}function z(en,el,eu){if(!en.length)return eu(null,[]);let ec=en.length,ed=Array(en.length),ef=null;en.forEach((en,em)=>{el(en,(en,el)=>{en&&(ef=en),ed[em]=el,0==--ec&&eu(ef,ed)})})}function E(en){let el=[];for(let eu in en)el.push(en[eu]);return el}function B(en,...el){for(let eu of el)for(let el in eu)en[el]=eu[el];return en}let ej=1;function C(){return ej++}function R(){return function t(en){return en?(en^Math.random()*(16>>en/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,t)}()}function L(en){return en<=1?1:Math.pow(2,Math.ceil(Math.log(en)/Math.LN2))}function V(en){return!!en&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(en)}function O(en,el){en.forEach(en=>{el[en]&&(el[en]=el[en].bind(el))})}function F(en,el){return -1!==en.indexOf(el,en.length-el.length)}function j(en,el,eu){let ec={};for(let ed in en)ec[ed]=el.call(eu||this,en[ed],ed,en);return ec}function U(en,el,eu){let ec={};for(let ed in en)el.call(eu||this,en[ed],ed,en)&&(ec[ed]=en[ed]);return ec}function N(en){return Array.isArray(en)?en.map(N):"object"==typeof en&&en?j(en,N):en}let eG={};function q(en){eG[en]||("undefined"!=typeof console&&console.warn(en),eG[en]=!0)}function G(en,el,eu){return(eu.y-en.y)*(el.x-en.x)>(el.y-en.y)*(eu.x-en.x)}function Z([en,el,eu]){let ec=(el+90)*eF,ed=eu*eF;return{x:en*Math.cos(ec)*Math.sin(ed),y:en*Math.sin(ec)*Math.sin(ed),z:en*Math.cos(ed),azimuthal:el,polar:eu}}function X(){return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope}function K(en){let el={};if(en.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(en,eu,ec,ed)=>{let ef=ec||ed;return el[eu]=!ef||ef.toLowerCase(),""}),el["max-age"]){let en=parseInt(el["max-age"],10);isNaN(en)?delete el["max-age"]:el["max-age"]=en}return el}let eq=null;function H(en){try{let el=self[en];return el.setItem("_mapbox_test_",1),el.removeItem("_mapbox_test_"),!0}catch(en){return!1}}function J(en,el){return[en[4*el],en[4*el+1],en[4*el+2],en[4*el+3]]}function Q(en,el,eu,ec){for(;el<eu;){let ed=el+eu>>1;en[ed]<ec?el=ed+1:eu=ed}return el}function tt(en,el,eu,ec){for(;el<eu;){let ed=el+eu>>1;en[ed]<=ec?el=ed+1:eu=ed}return el}let eZ="mapbox-tiles",e$=500,eW=50;function at(){try{return caches}catch(en){}}function ot(){let en=at();en&&!eu&&(eu=en.open(eZ))}function lt(en){let el=en.indexOf("?");if(el<0)return en;let eu=function(en){let el=en.indexOf("?");return el>0?en.slice(el+1).split("&"):[]}(en),ec=eu.filter(en=>{let el=en.split("=");return"language"===el[0]||"worldview"===el[0]});return ec.length?`${en.slice(0,el)}?${ec.join("&")}`:en.slice(0,el)}let eH=1/0,eX={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image",Model:"Model"};"function"==typeof Object.freeze&&Object.freeze(eX);let ht=class ht extends Error{constructor(en,el,eu){401===el&&wt(eu)&&(en+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(en),this.status=el,this.url=eu}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}};let eK=X()?()=>self.worker&&self.worker.referrer:()=>("blob:"===location.protocol?parent:self).location.href,ft=function(en,el){var ec;if(!(/^file:/.test(ec=en.url)||/^file:/.test(eK())&&!/^\w+:/.test(ec))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(en,el){var ec;let ef=new AbortController,em=new Request(en.url,{method:en.method||"GET",body:en.body,credentials:en.credentials,headers:en.headers,referrer:eK(),referrerPolicy:en.referrerPolicy,signal:ef.signal}),e_=!1,ew=!1,eT=(ec=em.url).indexOf("sku=")>0&&wt(ec);"json"===en.type&&em.headers.set("Accept","application/json");let l=(eu,ec,ed)=>{if(ew)return;if(eu&&"SecurityError"!==eu.message&&q(eu.toString()),ec&&ed)return u(ec);let ef=Date.now();fetch(em).then(eu=>{if(eu.ok){let en=eT?eu.clone():null;return u(eu,en,ef)}return el(new ht(eu.statusText,eu.status,en.url))}).catch(eu=>{"AbortError"!==eu.name&&el(Error(`${eu.message} ${en.url}`))})},u=(ec,ef,eT)=>{("arrayBuffer"===en.type?ec.arrayBuffer():"json"===en.type?ec.json():ec.text()).then(en=>{ew||(ef&&eT&&function(en,el,ec){if(ot(),!eu)return;let ef={status:el.status,statusText:el.statusText,headers:new Headers};el.headers.forEach((en,el)=>ef.headers.set(el,en));let em=K(el.headers.get("Cache-Control")||"");if(em["no-store"])return;em["max-age"]&&ef.headers.set("Expires",new Date(ec+1e3*em["max-age"]).toUTCString());let e_=ef.headers.get("Expires");e_&&(new Date(e_).getTime()-ec<42e4||function(en,el){if(void 0===ed)try{new Response(new ReadableStream),ed=!0}catch(en){ed=!1}ed?el(en.body):en.blob().then(el)}(el,el=>{let ec=new Response(el,ef);ot(),eu&&eu.then(el=>el.put(lt(en.url),ec)).catch(en=>q(en.message))}))}(em,ef,eT),e_=!0,el(null,en,ec.headers.get("Cache-Control"),ec.headers.get("Expires")))}).catch(en=>{ew||el(Error(en.message))})};return eT?function(en,el){if(ot(),!eu)return el(null);let ec=lt(en.url);eu.then(en=>{en.match(ec).then(eu=>{let ed=function(en){if(!en)return!1;let el=new Date(en.headers.get("Expires")||0),eu=K(en.headers.get("Cache-Control")||"");return el>Date.now()&&!eu["no-cache"]}(eu);en.delete(ec),ed&&en.put(ec,eu.clone()),el(null,eu,ed)}).catch(el)}).catch(el)}(em,l):l(null,null),{cancel:()=>{ew=!0,e_||ef.abort()}}}(en,el);if(X()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",en,el,void 0,!0)}return function(en,el){let eu=new XMLHttpRequest;for(let el in eu.open(en.method||"GET",en.url,!0),"arrayBuffer"===en.type&&(eu.responseType="arraybuffer"),en.headers)eu.setRequestHeader(el,en.headers[el]);return"json"===en.type&&(eu.responseType="text",eu.setRequestHeader("Accept","application/json")),eu.withCredentials="include"===en.credentials,eu.onerror=()=>{el(Error(eu.statusText))},eu.onload=()=>{if((eu.status>=200&&eu.status<300||0===eu.status)&&null!==eu.response){let ec=eu.response;if("json"===en.type)try{ec=JSON.parse(eu.response)}catch(en){return el(en)}el(null,ec,eu.getResponseHeader("Cache-Control"),eu.getResponseHeader("Expires"))}else el(new ht(eu.statusText,eu.status,en.url))},eu.send(en.body),{cancel:()=>eu.abort()}}(en,el)},dt=function(en,el){return ft(B(en,{type:"arrayBuffer"}),el)},eJ="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";ef=[],em=0;let vt=function(en,el){if(eP.supported&&(en.headers||(en.headers={}),en.headers.accept="image/webp,*/*"),em>=eC.MAX_PARALLEL_IMAGE_REQUESTS){let eu={requestParameters:en,callback:el,cancelled:!1,cancel(){this.cancelled=!0}};return ef.push(eu),eu}em++;let eu=!1,s=()=>{if(!eu)for(eu=!0,em--;ef.length&&em<eC.MAX_PARALLEL_IMAGE_REQUESTS;){let en=ef.shift(),{requestParameters:el,callback:eu,cancelled:ec}=en;ec||(en.cancel=vt(el,eu).cancel)}},ec=dt(en,(en,eu,ec,ed)=>{s(),en?el(en):eu&&(self.createImageBitmap?function(en,el){let eu=new Blob([new Uint8Array(en)],{type:"image/png"});createImageBitmap(eu).then(en=>{el(null,en)}).catch(en=>{el(Error(`Could not load image because of ${en.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(eu,(en,eu)=>el(en,eu,ec,ed)):function(en,el){let eu=new Image;eu.onload=()=>{el(null,eu),URL.revokeObjectURL(eu.src),eu.onload=null,requestAnimationFrame(()=>{eu.src=eJ})},eu.onerror=()=>el(Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));let ec=new Blob([new Uint8Array(en)],{type:"image/png"});eu.src=en.byteLength?URL.createObjectURL(ec):eJ}(eu,(en,eu)=>el(en,eu,ec,ed)))});return{cancel:()=>{ec.cancel(),s()}}},eY="NO_ACCESS_TOKEN";function _t(en){return 0===en.indexOf("mapbox:")}function wt(en){return eC.API_URL_REGEX.test(en)}function Mt(en){return eC.API_CDN_URL_REGEX.test(en)}function At(en){return eC.API_STYLE_REGEX.test(en)&&!St(en)}function St(en){return eC.API_SPRITE_REGEX.test(en)}let eQ=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function kt(en){let el=en.match(eQ);if(!el)throw Error("Unable to parse URL object");return{protocol:el[1],authority:el[2],path:el[3]||"/",params:el[4]?el[4].split("&"):[]}}function Tt(en){let el=en.params.length?`?${en.params.join("&")}`:"";return`${en.protocol}://${en.authority}${en.path}${el}`}let e0="mapbox.eventData";function zt(en){if(!en)return null;let el=en.split(".");if(!el||3!==el.length)return null;try{return JSON.parse(decodeURIComponent(atob(el[1]).split("").map(en=>"%"+("00"+en.charCodeAt(0).toString(16)).slice(-2)).join("")))}catch(en){return null}}let Et=class Et{constructor(en){this.type=en,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(en){let el=zt(eC.ACCESS_TOKEN),eu="";return eu=el&&el.u?btoa(encodeURIComponent(el.u).replace(/%([0-9A-F]{2})/g,(en,el)=>String.fromCharCode(Number("0x"+el)))):eC.ACCESS_TOKEN||"",en?`${e0}.${en}:${eu}`:`${e0}:${eu}`}fetchEventData(){let en=H("localStorage"),el=this.getStorageKey(),eu=this.getStorageKey("uuid");if(en)try{let en=localStorage.getItem(el);en&&(this.eventData=JSON.parse(en));let ec=localStorage.getItem(eu);ec&&(this.anonId=ec)}catch(en){q("Unable to read from LocalStorage")}}saveEventData(){let en=H("localStorage"),el=this.getStorageKey(),eu=this.getStorageKey("uuid"),ec=this.anonId;if(en&&ec)try{localStorage.setItem(eu,ec),Object.keys(this.eventData).length>=1&&localStorage.setItem(el,JSON.stringify(this.eventData))}catch(en){q("Unable to write to LocalStorage")}}processRequests(en){}postEvent(en,el,eu,ec){if(!eC.EVENTS_URL)return;let ed=kt(eC.EVENTS_URL);ed.params.push(`access_token=${ec||eC.ACCESS_TOKEN||""}`);let ef={event:this.type,created:new Date(en).toISOString()},em=el?B(ef,el):ef,e_={url:Tt(ed),headers:{"Content-Type":"text/plain"},body:JSON.stringify([em])};this.pendingRequest=ft(B(e_,{method:"POST"}),en=>{this.pendingRequest=null,eu(en),this.saveEventData(),this.processRequests(ec)})}queueRequest(en,el){this.queue.push(en),this.processRequests(el)}};let e1=new class extends Et{constructor(en){super("appUserTurnstile"),this._customAccessToken=en}postTurnstileEvent(en,el){eC.EVENTS_URL&&eC.ACCESS_TOKEN&&Array.isArray(en)&&en.some(en=>_t(en)||wt(en))&&this.queueRequest(Date.now(),el)}processRequests(en){if(this.pendingRequest||0===this.queue.length)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();let el=zt(eC.ACCESS_TOKEN),eu=el?el.u:eC.ACCESS_TOKEN,ec=eu!==this.eventData.tokenU;V(this.anonId)||(this.anonId=R(),ec=!0);let ed=this.queue.shift();if(this.eventData.lastSuccess){let en=new Date(this.eventData.lastSuccess),el=new Date(ed),eu=(ed-this.eventData.lastSuccess)/864e5;ec=ec||eu>=1||eu<-1||en.getDate()!==el.getDate()}else ec=!0;ec?this.postEvent(ed,{sdkIdentifier:"mapbox-gl-js",sdkVersion:eI,skuId:"01","enabled.telemetry":!1,userId:this.anonId},en=>{en||(this.eventData.lastSuccess=ed,this.eventData.tokenU=eu)},en):this.processRequests()}},e2=e1.postTurnstileEvent.bind(e1),e3=new class extends Et{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(en,el,eu,ec){this.skuToken=el,this.errorCb=ec,eC.EVENTS_URL&&(eu||eC.ACCESS_TOKEN?this.queueRequest({id:en,timestamp:Date.now()},eu):this.errorCb(Error(eY)))}processRequests(en){if(this.pendingRequest||0===this.queue.length)return;let{id:el,timestamp:eu}=this.queue.shift();el&&this.success[el]||(this.anonId||this.fetchEventData(),V(this.anonId)||(this.anonId=R()),this.postEvent(eu,{sdkIdentifier:"mapbox-gl-js",sdkVersion:eI,skuId:"01",skuToken:this.skuToken,userId:this.anonId},en=>{en?this.errorCb(en):el&&(this.success[el]=!0)},en))}},e4=e3.postMapLoadEvent.bind(e3),e5=new class extends Et{constructor(){super("gljs.performance")}postPerformanceEvent(en,el){eC.EVENTS_URL&&(en||eC.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:el},en)}processRequests(en){if(this.pendingRequest||0===this.queue.length)return;let{timestamp:el,performanceData:eu}=this.queue.shift(),ec=function(en){let el=performance.getEntriesByType("resource"),eu=performance.getEntriesByType("mark"),ec=function(en){let el={};if(en){for(let eu in en)if("other"!==eu)for(let ec of en[eu]){let en=`${eu}ResolveRangeMin`,ed=`${eu}ResolveRangeMax`,ef=`${eu}RequestCount`,em=`${eu}RequestCachedCount`;el[en]=Math.min(el[en]||1/0,ec.startTime),el[ed]=Math.max(el[ed]||-1/0,ec.responseEnd);let o=en=>{void 0===el[en]&&(el[en]=0),++el[en]};void 0!==ec.transferSize&&0===ec.transferSize&&o(em),o(ef)}}return el}(function(en,el){let eu={};if(en)for(let ec of en){let en=el(ec);void 0===eu[en]&&(eu[en]=[]),eu[en].push(ec)}return eu}(el,Nt)),ed=window.devicePixelRatio,ef=navigator.connection||navigator.mozConnection||navigator.webkitConnection,em=ef?ef.effectiveType:void 0,e_={counters:[],metadata:[],attributes:[]},u=(en,el,eu)=>{null!=eu&&en.push({name:el,value:eu.toString()})};for(let en in ec)u(e_.counters,en,ec[en]);if(en.interactionRange[0]!==1/0&&en.interactionRange[1]!==-1/0&&(u(e_.counters,"interactionRangeMin",en.interactionRange[0]),u(e_.counters,"interactionRangeMax",en.interactionRange[1])),eu)for(let en of Object.keys(ti)){let el=ti[en],ec=eu.find(en=>en.name===el);ec&&u(e_.counters,el,ec.startTime)}return u(e_.counters,"visibilityHidden",en.visibilityHidden),u(e_.attributes,"style",function(en){if(en)for(let el of en){let en=el.name.split("?")[0];if(At(en)){let el=en.split("/").slice(-2);if(2===el.length)return`mapbox://styles/${el[0]}/${el[1]}`}}}(el)),u(e_.attributes,"terrainEnabled",en.terrainEnabled?"true":"false"),u(e_.attributes,"fogEnabled",en.fogEnabled?"true":"false"),u(e_.attributes,"projection",en.projection),u(e_.attributes,"zoom",en.zoom),u(e_.metadata,"devicePixelRatio",ed),u(e_.metadata,"connectionEffectiveType",em),u(e_.metadata,"navigatorUserAgent",navigator.userAgent),u(e_.metadata,"screenWidth",window.screen.width),u(e_.metadata,"screenHeight",window.screen.height),u(e_.metadata,"windowWidth",window.innerWidth),u(e_.metadata,"windowHeight",window.innerHeight),u(e_.metadata,"mapWidth",en.width/ed),u(e_.metadata,"mapHeight",en.height/ed),u(e_.metadata,"webglRenderer",en.renderer),u(e_.metadata,"webglVendor",en.vendor),u(e_.metadata,"sdkVersion",eI),u(e_.metadata,"sdkIdentifier","mapbox-gl-js"),e_}(eu);for(let en of ec.metadata);for(let en of ec.counters);for(let en of ec.attributes);this.postEvent(el,ec,()=>{},en)}},e6=e5.postPerformanceEvent.bind(e5),e8=new class extends Et{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(en,el,eu,ec){if(!eC.API_URL||!eC.SESSION_PATH)return;let ed=kt(eC.API_URL+eC.SESSION_PATH);ed.params.push(`sku=${el||""}`),ed.params.push(`access_token=${ec||eC.ACCESS_TOKEN||""}`);let ef={url:Tt(ed),headers:{"Content-Type":"text/plain"}};this.pendingRequest=ft(B(ef,{method:"GET"}),en=>{this.pendingRequest=null,eu(en),this.saveEventData(),this.processRequests(ec)})}getSessionAPI(en,el,eu,ec){this.skuToken=el,this.errorCb=ec,eC.SESSION_PATH&&eC.API_URL&&(eu||eC.ACCESS_TOKEN?this.queueRequest({id:en,timestamp:Date.now()},eu):this.errorCb(Error(eY)))}processRequests(en){if(this.pendingRequest||0===this.queue.length)return;let{id:el,timestamp:eu}=this.queue.shift();el&&this.success[el]||this.getSession(eu,this.skuToken,en=>{en?this.errorCb(en):el&&(this.success[el]=!0)},en)}},e7=e8.getSessionAPI.bind(e8),e9=new Set,ti={create:"create",load:"load",fullLoad:"fullLoad"};function Nt(en){let el=en.name.split("?")[0];return Mt(el)&&el.includes("mapbox-gl.js")?"javascript":Mt(el)&&el.includes("mapbox-gl.css")?"css":eC.API_FONTS_REGEX.test(el)?"fontRange":St(el)?"sprite":At(el)?"style":eC.API_TILEJSON_REGEX.test(el)?"tilejson":"other"}function $t(en){let el=en?en.url.toString():void 0;return el?performance.getEntriesByName(el):[]}function Kt(){return null==e_&&(e_=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof self.createImageBitmap),e_}let ta={now:()=>void 0!==eM?eM:performance.now(),setNow(en){eM=en},restoreNow(){eM=void 0},frame(en){let el=requestAnimationFrame(en);return{cancel:()=>cancelAnimationFrame(el)}},getImageData(en,el=0){let{width:eu,height:ec}=en;eE||(eE=document.createElement("canvas"));let ed=eE.getContext("2d",{willReadFrequently:!0});if(!ed)throw Error("failed to create canvas 2d context");return(eu>eE.width||ec>eE.height)&&(eE.width=eu,eE.height=ec),ed.clearRect(-el,-el,eu+2*el,ec+2*el),ed.drawImage(en,0,0,eu,ec),ed.getImageData(-el,-el,eu+2*el,ec+2*el)},resolveURL:en=>(ew||(ew=document.createElement("a")),ew.href=en,ew.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(null==eT&&(eT=window.matchMedia("(prefers-reduced-motion: reduce)")),eT.matches)},hasCanvasFingerprintNoise(){if(!Kt())return!1;let en=new OffscreenCanvas(85,1),el=en.getContext("2d",{willReadFrequently:!0}),eu=0;for(let ec=0;ec<en.width;++ec)el.fillStyle=`rgba(${eu++},${eu++},${eu++}, 255)`,el.fillRect(ec,0,1,1);let ec=el.getImageData(0,0,en.width,en.height);eu=0;for(let en=0;en<ec.data.length;++en)if(en%4!=3&&eu++!==ec.data[en])return!0;return!1}};function Ht(en,el,eu){eu[en]&&-1!==eu[en].indexOf(el)||(eu[en]=eu[en]||[],eu[en].push(el))}function Jt(en,el,eu){if(eu&&eu[en]){let ec=eu[en].indexOf(el);-1!==ec&&eu[en].splice(ec,1)}}let Qt=class Qt{constructor(en,el={}){B(this,el),this.type=en}};let te=class te extends Qt{constructor(en,el={}){super("error",B({error:en},el))}};let ee=class ee{on(en,el){return this._listeners=this._listeners||{},Ht(en,el,this._listeners),this}off(en,el){return Jt(en,el,this._listeners),Jt(en,el,this._oneTimeListeners),this}once(en,el){return el?(this._oneTimeListeners=this._oneTimeListeners||{},Ht(en,el,this._oneTimeListeners),this):new Promise(el=>this.once(en,el))}fire(en,el){"string"==typeof en&&(en=new Qt(en,el||{}));let eu=en.type;if(this.listens(eu)){en.target=this;let el=this._listeners&&this._listeners[eu]?this._listeners[eu].slice():[];for(let eu of el)eu.call(this,en);let ec=this._oneTimeListeners&&this._oneTimeListeners[eu]?this._oneTimeListeners[eu].slice():[];for(let el of ec)Jt(eu,el,this._oneTimeListeners),el.call(this,en);let ed=this._eventedParent;ed&&(B(en,"function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData),ed.fire(en))}else en instanceof te&&console.error(en.error);return this}listens(en){return!!(this._listeners&&this._listeners[en]&&this._listeners[en].length>0||this._oneTimeListeners&&this._oneTimeListeners[en]&&this._oneTimeListeners[en].length>0||this._eventedParent&&this._eventedParent.listens(en))}setEventedParent(en,el){return this._eventedParent=en,this._eventedParentData=el,this}};var tc=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"camera":{"type":"camera"},"imports":{"type":"array","value":"import"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","required":true},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"expression":{},"property-type":"data-constant"},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"required":true,"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":1}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":1}},"url":{"required":false,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","private":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"property-type":"constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-color-saturation":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","default":[0,1],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"raster-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');let ne=class ne{constructor(en,el,eu,ec){this.message=(en?`${en}: `:"")+eu,ec&&(this.identifier=ec),null!=el&&el.__line__&&(this.line=el.__line__)}};let ie=class ie extends ne{};function se(en,...el){for(let eu of el)for(let el in eu)en[el]=eu[el];return en}function ae(en){return en instanceof Number||en instanceof String||en instanceof Boolean?en.valueOf():en}function oe(en){if(Array.isArray(en))return en.map(oe);if(en instanceof Object&&!(en instanceof Number||en instanceof String||en instanceof Boolean)){let el={};for(let eu in en)el[eu]=oe(en[eu]);return el}return ae(en)}var tm=class extends Error{constructor(en,el){super(el),this.message=el,this.key=en}};let ce=class ce{constructor(en,el=[]){for(let[eu,ec]of(this.parent=en,this.bindings={},el))this.bindings[eu]=ec}concat(en){return new ce(this,en)}get(en){if(this.bindings[en])return this.bindings[en];if(this.parent)return this.parent.get(en);throw Error(`${en} not found in scope.`)}has(en){return!!this.bindings[en]||!!this.parent&&this.parent.has(en)}};let t_={kind:"null"},tg={kind:"number"},tb={kind:"string"},tw={kind:"boolean"},tT={kind:"color"},tM={kind:"object"},tE={kind:"value"},tS={kind:"collator"},tA={kind:"formatted"},tI={kind:"resolvedImage"};function we(en,el){return{kind:"array",itemType:en,N:el}}function Me(en){if("array"===en.kind){let el=Me(en.itemType);return"number"==typeof en.N?`array<${el}, ${en.N}>`:"value"===en.itemType.kind?"array":`array<${el}>`}return en.kind}let tC=[t_,tg,tb,tw,tT,tA,tM,we(tE),tI];function Se(en,el){if("error"===el.kind)return null;if("array"===en.kind){if("array"===el.kind&&(0===el.N&&"value"===el.itemType.kind||!Se(en.itemType,el.itemType))&&("number"!=typeof en.N||en.N===el.N))return null}else{if(en.kind===el.kind)return null;if("value"===en.kind){for(let en of tC)if(!Se(en,el))return null}}return`Expected ${Me(en)} but found ${Me(el)} instead.`}function Ie(en,el){return el.some(el=>el.kind===en.kind)}function ke(en,el){return el.some(el=>"null"===el?null===en:"array"===el?Array.isArray(en):"object"===el?en&&!Array.isArray(en)&&"object"==typeof en:el===typeof en)}var tP,tz={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function ze(en){return(en=Math.round(en))<0?0:en>255?255:en}function Ee(en){return ze("%"===en[en.length-1]?parseFloat(en)/100*255:parseInt(en))}function Be(en){var el;return(el="%"===en[en.length-1]?parseFloat(en)/100:parseFloat(en))<0?0:el>1?1:el}function De(en,el,eu){return eu<0?eu+=1:eu>1&&(eu-=1),6*eu<1?en+(el-en)*eu*6:2*eu<1?el:3*eu<2?en+(el-en)*(2/3-eu)*6:en}try{tP=({}).parseCSSColor=function(en){var el,eu=en.replace(/ /g,"").toLowerCase();if(eu in tz)return tz[eu].slice();if("#"===eu[0])return 4===eu.length?(el=parseInt(eu.substr(1),16))>=0&&el<=4095?[(3840&el)>>4|(3840&el)>>8,240&el|(240&el)>>4,15&el|(15&el)<<4,1]:null:7===eu.length&&(el=parseInt(eu.substr(1),16))>=0&&el<=16777215?[(16711680&el)>>16,(65280&el)>>8,255&el,1]:null;var ec=eu.indexOf("("),ed=eu.indexOf(")");if(-1!==ec&&ed+1===eu.length){var ef=eu.substr(0,ec),em=eu.substr(ec+1,ed-(ec+1)).split(","),e_=1;switch(ef){case"rgba":if(4!==em.length)break;e_=Be(em.pop());case"rgb":return 3!==em.length?null:[Ee(em[0]),Ee(em[1]),Ee(em[2]),e_];case"hsla":if(4!==em.length)break;e_=Be(em.pop());case"hsl":if(3!==em.length)break;var ew=(parseFloat(em[0])%360+360)%360/360,eT=Be(em[1]),eM=Be(em[2]),eE=eM<=.5?eM*(eT+1):eM+eT-eM*eT,eS=2*eM-eE;return[ze(255*De(eS,eE,ew+1/3)),ze(255*De(eS,eE,ew)),ze(255*De(eS,eE,ew-1/3)),e_]}}return null}}catch(en){}let Ce=class Ce{constructor(en,el,eu,ec=1){this.r=en,this.g=el,this.b=eu,this.a=ec}static parse(en){if(!en)return;if(en instanceof Ce)return en;if("string"!=typeof en)return;let el=tP(en);return el?new Ce(el[0]/255*el[3],el[1]/255*el[3],el[2]/255*el[3],el[3]):void 0}toString(){let[en,el,eu,ec]=this.toArray();return`rgba(${Math.round(en)},${Math.round(el)},${Math.round(eu)},${ec})`}toArray(){let{r:en,g:el,b:eu,a:ec}=this;return 0===ec?[0,0,0,0]:[255*en/ec,255*el/ec,255*eu/ec,ec]}toArray01(){let{r:en,g:el,b:eu,a:ec}=this;return 0===ec?[0,0,0,0]:[en/ec,el/ec,eu/ec,ec]}toArray01Scaled(en){let{r:el,g:eu,b:ec,a:ed}=this;return 0===ed?[0,0,0]:[el/ed*en,eu/ed*en,ec/ed*en]}toArray01PremultipliedAlpha(){let{r:en,g:el,b:eu,a:ec}=this;return[en,el,eu,ec]}toArray01Linear(){let{r:en,g:el,b:eu,a:ec}=this;return 0===ec?[0,0,0,0]:[Math.pow(en/ec,2.2),Math.pow(el/ec,2.2),Math.pow(eu/ec,2.2),ec]}};Ce.black=new Ce(0,0,0,1),Ce.white=new Ce(1,1,1,1),Ce.transparent=new Ce(0,0,0,0),Ce.red=new Ce(1,0,0,1),Ce.blue=new Ce(0,0,1,1);let Le=class Le{constructor(en,el,eu){this.sensitivity=en?el?"variant":"case":el?"accent":"base",this.locale=eu,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(en,el){return this.collator.compare(en,el)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}};let Ve=class Ve{constructor(en,el,eu,ec,ed){this.text=en.normalize?en.normalize():en,this.image=el,this.scale=eu,this.fontStack=ec,this.textColor=ed}};let Oe=class Oe{constructor(en){this.sections=en}static fromString(en){return new Oe([new Ve(en,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some(en=>0!==en.text.length||en.image&&0!==en.image.namePrimary.length)}static factory(en){return en instanceof Oe?en:Oe.fromString(en)}toString(){return 0===this.sections.length?"":this.sections.map(en=>en.text).join("")}serialize(){let en=["format"];for(let el of this.sections){if(el.image){en.push(["image",el.image.namePrimary]);continue}en.push(el.text);let eu={};el.fontStack&&(eu["text-font"]=["literal",el.fontStack.split(",")]),el.scale&&(eu["font-scale"]=el.scale),el.textColor&&(eu["text-color"]=["rgba"].concat(el.textColor.toArray())),en.push(eu)}return en}};let Fe=class Fe{constructor(en){this.namePrimary=en.namePrimary,en.nameSecondary&&(this.nameSecondary=en.nameSecondary),this.available=en.available}toString(){return this.nameSecondary?`[${this.namePrimary},${this.nameSecondary}]`:this.namePrimary}static fromString(en,el){return en?new Fe({namePrimary:en,nameSecondary:el,available:!1}):null}serialize(){return this.nameSecondary?["image",this.namePrimary,this.nameSecondary]:["image",this.namePrimary]}};function je(en,el,eu,ec){return"number"==typeof en&&en>=0&&en<=255&&"number"==typeof el&&el>=0&&el<=255&&"number"==typeof eu&&eu>=0&&eu<=255?void 0===ec||"number"==typeof ec&&ec>=0&&ec<=1?null:`Invalid rgba value [${[en,el,eu,ec].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof ec?[en,el,eu,ec]:[en,el,eu]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Ue(en){if(null===en||"string"==typeof en||"boolean"==typeof en||"number"==typeof en||en instanceof Ce||en instanceof Le||en instanceof Oe||en instanceof Fe)return!0;if(Array.isArray(en)){for(let el of en)if(!Ue(el))return!1;return!0}if("object"==typeof en){for(let el in en)if(!Ue(en[el]))return!1;return!0}return!1}function Ne(en){if(null===en)return t_;if("string"==typeof en)return tb;if("boolean"==typeof en)return tw;if("number"==typeof en)return tg;if(en instanceof Ce)return tT;if(en instanceof Le)return tS;if(en instanceof Oe)return tA;if(en instanceof Fe)return tI;if(Array.isArray(en)){let el;let eu=en.length;for(let eu of en){let en=Ne(eu);if(el){if(el===en)continue;el=tE;break}el=en}return we(el||tE,eu)}return tM}function $e(en){let el=typeof en;return null===en?"":"string"===el||"number"===el||"boolean"===el?String(en):en instanceof Ce||en instanceof Oe||en instanceof Fe?en.toString():JSON.stringify(en)}let qe=class qe{constructor(en,el){this.type=en,this.value=el}static parse(en,el){if(2!==en.length)return el.error(`'literal' expression requires exactly one argument, but found ${en.length-1} instead.`);if(!Ue(en[1]))return el.error("invalid value");let eu=en[1],ec=Ne(eu),ed=el.expectedType;return"array"===ec.kind&&0===ec.N&&ed&&"array"===ed.kind&&("number"!=typeof ed.N||0===ed.N)&&(ec=ed),new qe(ec,eu)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof Ce?["rgba"].concat(this.value.toArray()):this.value instanceof Oe?this.value.serialize():this.value}};var tD=class{constructor(en){this.name="ExpressionEvaluationError",this.message=en}toJSON(){return this.message}};let tL={string:tb,number:tg,boolean:tw,object:tM};let Xe=class Xe{constructor(en,el){this.type=en,this.args=el}static parse(en,el){if(en.length<2)return el.error("Expected at least one argument.");let eu,ec=1,ed=en[0];if("array"===ed){let ed,ef;if(en.length>2){let eu=en[1];if("string"!=typeof eu||!(eu in tL)||"object"===eu)return el.error('The item type argument of "array" must be one of string, number, boolean',1);ed=tL[eu],ec++}else ed=tE;if(en.length>3){if(null!==en[2]&&("number"!=typeof en[2]||en[2]<0||en[2]!==Math.floor(en[2])))return el.error('The length argument to "array" must be a positive integer literal',2);ef=en[2],ec++}eu=we(ed,ef)}else eu=tL[ed];let ef=[];for(;ec<en.length;ec++){let eu=el.parse(en[ec],ec,tE);if(!eu)return null;ef.push(eu)}return new Xe(eu,ef)}evaluate(en){for(let el=0;el<this.args.length;el++){let eu=this.args[el].evaluate(en);if(!Se(this.type,Ne(eu)))return eu;if(el===this.args.length-1)throw new tD(`Expected value to be of type ${Me(this.type)}, but found ${Me(Ne(eu))} instead.`)}return null}eachChild(en){this.args.forEach(en)}outputDefined(){return this.args.every(en=>en.outputDefined())}serialize(){let en=this.type,el=[en.kind];if("array"===en.kind){let eu=en.itemType;if("string"===eu.kind||"number"===eu.kind||"boolean"===eu.kind){el.push(eu.kind);let ec=en.N;("number"==typeof ec||this.args.length>1)&&el.push(ec)}}return el.concat(this.args.map(en=>en.serialize()))}};let We=class We{constructor(en){this.type=tA,this.sections=en}static parse(en,el){if(en.length<2)return el.error("Expected at least one argument.");let eu=en[1];if(!Array.isArray(eu)&&"object"==typeof eu)return el.error("First argument must be an image or text section.");let ec=[],ed=!1;for(let eu=1;eu<=en.length-1;++eu){let ef=en[eu];if(ed&&"object"==typeof ef&&!Array.isArray(ef)){ed=!1;let en=null;if(ef["font-scale"]&&!(en=el.parse(ef["font-scale"],1,tg)))return null;let eu=null;if(ef["text-font"]&&!(eu=el.parse(ef["text-font"],1,we(tb))))return null;let em=null;if(ef["text-color"]&&!(em=el.parse(ef["text-color"],1,tT)))return null;let e_=ec[ec.length-1];e_.scale=en,e_.font=eu,e_.textColor=em}else{let ef=el.parse(en[eu],1,tE);if(!ef)return null;let em=ef.type.kind;if("string"!==em&&"value"!==em&&"null"!==em&&"resolvedImage"!==em)return el.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");ed=!0,ec.push({content:ef,scale:null,font:null,textColor:null})}}return new We(ec)}evaluate(en){return new Oe(this.sections.map(el=>{let eu=el.content.evaluate(en);return Ne(eu)===tI?new Ve("",eu,null,null,null):new Ve($e(eu),null,el.scale?el.scale.evaluate(en):null,el.font?el.font.evaluate(en).join(","):null,el.textColor?el.textColor.evaluate(en):null)}))}eachChild(en){for(let el of this.sections)en(el.content),el.scale&&en(el.scale),el.font&&en(el.font),el.textColor&&en(el.textColor)}outputDefined(){return!1}serialize(){let en=["format"];for(let el of this.sections){en.push(el.content.serialize());let eu={};el.scale&&(eu["font-scale"]=el.scale.serialize()),el.font&&(eu["text-font"]=el.font.serialize()),el.textColor&&(eu["text-color"]=el.textColor.serialize()),en.push(eu)}return en}};let He=class He{constructor(en,el){this.type=tI,this.inputPrimary=en,this.inputSecondary=el}static parse(en,el){if(en.length<2)return el.error("Expected two or more arguments.");let eu=el.parse(en[1],1,tb);if(!eu)return el.error("No image name provided.");if(2===en.length)return new He(eu);let ec=el.parse(en[2],1,tb);return ec?new He(eu,ec):el.error("Secondary image variant is not a string.")}evaluate(en){let el=Fe.fromString(this.inputPrimary.evaluate(en),this.inputSecondary?this.inputSecondary.evaluate(en):void 0);return el&&en.availableImages&&(el.available=en.availableImages.indexOf(el.namePrimary)>-1,el.nameSecondary&&el.available&&en.availableImages&&(el.available=en.availableImages.indexOf(el.nameSecondary)>-1)),el}eachChild(en){en(this.inputPrimary),this.inputSecondary&&en(this.inputSecondary)}outputDefined(){return!1}serialize(){return this.inputSecondary?["image",this.inputPrimary.serialize(),this.inputSecondary.serialize()]:["image",this.inputPrimary.serialize()]}};function Je(en){return en instanceof Number?"number":en instanceof String?"string":en instanceof Boolean?"boolean":Array.isArray(en)?"array":null===en?"null":typeof en}let tk={"to-boolean":tw,"to-color":tT,"to-number":tg,"to-string":tb};let tr=class tr{constructor(en,el){this.type=en,this.args=el}static parse(en,el){if(en.length<2)return el.error("Expected at least one argument.");let eu=en[0],ec=[],ed=t_;if("to-array"===eu){if(!Array.isArray(en[1]))return null;let eu=en[1].length;if(el.expectedType){if("array"!==el.expectedType.kind)return el.error(`Expected ${el.expectedType.kind} but found array.`);ed=we(el.expectedType.itemType,eu)}else{if(!(eu>0&&Ue(en[1][0])))return null;ed=we(Ne(en[1][0]),eu)}for(let ef=0;ef<eu;ef++){let eu;let em=en[1][ef];if("array"===Je(em))eu=el.parse(em,void 0,ed.itemType);else{let en=Je(em);if(en!==ed.itemType.kind)return el.error(`Expected ${ed.itemType.kind} but found ${en}.`);eu=el.registry.literal.parse(["literal",void 0===em?null:em],el)}if(!eu)return null;ec.push(eu)}}else{if(("to-boolean"===eu||"to-string"===eu)&&2!==en.length)return el.error("Expected one argument.");ed=tk[eu];for(let eu=1;eu<en.length;eu++){let ed=el.parse(en[eu],eu,tE);if(!ed)return null;ec.push(ed)}}return new tr(ed,ec)}evaluate(en){if("boolean"===this.type.kind)return!!this.args[0].evaluate(en);if("color"===this.type.kind){let el,eu;for(let ec of this.args){if(el=ec.evaluate(en),eu=null,el instanceof Ce)return el;if("string"==typeof el){let eu=en.parseColor(el);if(eu)return eu}else if(Array.isArray(el)&&!(eu=el.length<3||el.length>4?`Invalid rbga value ${JSON.stringify(el)}: expected an array containing either three or four numeric values.`:je(el[0],el[1],el[2],el[3])))return new Ce(el[0]/255,el[1]/255,el[2]/255,el[3])}throw new tD(eu||`Could not parse color from value '${"string"==typeof el?el:String(JSON.stringify(el))}'`)}if("number"===this.type.kind){let el=null;for(let eu of this.args){if(null===(el=eu.evaluate(en)))return 0;let ec=Number(el);if(!isNaN(ec))return ec}throw new tD(`Could not convert ${JSON.stringify(el)} to number.`)}return"formatted"===this.type.kind?Oe.fromString($e(this.args[0].evaluate(en))):"resolvedImage"===this.type.kind?Fe.fromString($e(this.args[0].evaluate(en))):"array"===this.type.kind?this.args.map(el=>el.evaluate(en)):$e(this.args[0].evaluate(en))}eachChild(en){this.args.forEach(en)}outputDefined(){return this.args.every(en=>en.outputDefined())}serialize(){if("formatted"===this.type.kind)return new We([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new He(this.args[0]).serialize();let en="array"===this.type.kind?[]:[`to-${this.type.kind}`];return this.eachChild(el=>{en.push(el.serialize())}),en}};let tR=["Unknown","Point","LineString","Polygon"];var tO=class{constructor(en,el){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=en,this.options=el}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?tR[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(en){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){let en=this.featureDistanceData.center,el=this.featureDistanceData.scale,{x:eu,y:ec}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(eu*el-en[0])+this.featureDistanceData.bearing[1]*(ec*el-en[1])}return 0}parseColor(en){let el=this._parseColorCache[en];return el||(el=this._parseColorCache[en]=Ce.parse(en)),el}getConfig(en){return this.options?this.options.get(en):null}};let ir=class ir{constructor(en,el,eu,ec,ed){this.name=en,this.type=el,this._evaluate=eu,this.args=ec,this._overloadIndex=ed}evaluate(en){if(!this._evaluate){let en=ir.definitions[this.name];this._evaluate=Array.isArray(en)?en[2]:en.overloads[this._overloadIndex][1]}return this._evaluate(en,this.args)}eachChild(en){this.args.forEach(en)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(en=>en.serialize()))}static parse(en,el){let eu=en[0],ec=ir.definitions[eu];if(!ec)return el.error(`Unknown expression "${eu}". If you wanted a literal array, use ["literal", [...]].`,0);let ed=Array.isArray(ec)?ec[0]:ec.type,ef=Array.isArray(ec)?[[ec[1],ec[2]]]:ec.overloads,em=[],e_=null,ew=-1;for(let[ec,eT]of ef){if(Array.isArray(ec)&&ec.length!==en.length-1)continue;em.push(ec),ew++,e_=new tG(el.registry,el.path,null,el.scope,void 0,el._scope,el.options);let ef=[],eM=!1;for(let el=1;el<en.length;el++){let eu=en[el],ed=Array.isArray(ec)?ec[el-1]:ec.type,em=e_.parse(eu,1+ef.length,ed);if(!em){eM=!0;break}ef.push(em)}if(!eM){if(Array.isArray(ec)&&ec.length!==ef.length)e_.error(`Expected ${ec.length} arguments, but found ${ef.length} instead.`);else{for(let en=0;en<ef.length;en++){let el=Array.isArray(ec)?ec[en]:ec.type,eu=ef[en];e_.concat(en+1).checkSubtype(el,eu.type)}if(0===e_.errors.length)return new ir(eu,ed,eT,ef,ew)}}}if(1===em.length)el.errors.push(...e_.errors);else{let eu=(em.length?em:ef.map(([en])=>en)).map(sr).join(" | "),ec=[];for(let eu=1;eu<en.length;eu++){let ed=el.parse(en[eu],1+ec.length);if(!ed)return null;ec.push(Me(ed.type))}el.error(`Expected arguments of type ${eu}, but found (${ec.join(", ")}) instead.`)}return null}static register(en,el){for(let eu in ir.definitions=el,el)en[eu]=ir}};function sr(en){return Array.isArray(en)?`(${en.map(Me).join(", ")})`:`(${Me(en.type)}...)`}let or=class or{constructor(en,el,eu){this.type=tS,this.locale=eu,this.caseSensitive=en,this.diacriticSensitive=el}static parse(en,el){if(2!==en.length)return el.error("Expected one argument.");let eu=en[1];if("object"!=typeof eu||Array.isArray(eu))return el.error("Collator options argument must be an object.");let ec=el.parse(void 0!==eu["case-sensitive"]&&eu["case-sensitive"],1,tw);if(!ec)return null;let ed=el.parse(void 0!==eu["diacritic-sensitive"]&&eu["diacritic-sensitive"],1,tw);if(!ed)return null;let ef=null;return!eu.locale||(ef=el.parse(eu.locale,1,tb))?new or(ec,ed,ef):null}evaluate(en){return new Le(this.caseSensitive.evaluate(en),this.diacriticSensitive.evaluate(en),this.locale?this.locale.evaluate(en):null)}eachChild(en){en(this.caseSensitive),en(this.diacriticSensitive),this.locale&&en(this.locale)}outputDefined(){return!1}serialize(){let en={};return en["case-sensitive"]=this.caseSensitive.serialize(),en["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(en.locale=this.locale.serialize()),["collator",en]}};var tB={exports:{}};tB.exports=function(){function e(en,el,eu){var ec=en[el];en[el]=en[eu],en[eu]=ec}function r(en,el){return en<el?-1:en>el?1:0}return function(en,el,eu,ec,ed){!function t(en,el,eu,ec,ed){for(;ec>eu;){if(ec-eu>600){var ef=ec-eu+1,em=el-eu+1,e_=Math.log(ef),ew=.5*Math.exp(2*e_/3),eT=.5*Math.sqrt(e_*ew*(ef-ew)/ef)*(em-ef/2<0?-1:1);t(en,el,Math.max(eu,Math.floor(el-em*ew/ef+eT)),Math.min(ec,Math.floor(el+(ef-em)*ew/ef+eT)),ed)}var eM=en[el],eE=eu,eS=ec;for(e(en,eu,el),ed(en[ec],eM)>0&&e(en,eu,ec);eE<eS;){for(e(en,eE,eS),eE++,eS--;0>ed(en[eE],eM);)eE++;for(;ed(en[eS],eM)>0;)eS--}0===ed(en[eu],eM)?e(en,eu,eS):e(en,++eS,ec),eS<=el&&(eu=eS+1),el<=eS&&(ec=eS-1)}}(en,el,eu||0,ec||en.length-1,ed||r)}}();var tF=p(tB.exports);function hr(en,el){en[0]=Math.min(en[0],el[0]),en[1]=Math.min(en[1],el[1]),en[2]=Math.max(en[2],el[0]),en[3]=Math.max(en[3],el[1])}function pr(en,el){return!(en[0]<=el[0]||en[2]>=el[2]||en[1]<=el[1]||en[3]>=el[3])}function dr(en,el,eu=!1){let ec=!1;for(let ed=0,ef=el.length;ed<ef;ed++){let ef=el[ed];for(let el=0,ed=ef.length,em=ed-1;el<ed;em=el++){let ed=ef[em],e_=ef[el];if(function(en,el,eu){let ec=en[0]-el[0],ed=en[1]-el[1],ef=en[0]-eu[0],em=en[1]-eu[1];return ec*em-ef*ed==0&&ec*ef<=0&&ed*em<=0}(en,ed,e_))return eu;ed[1]>en[1]!=e_[1]>en[1]&&en[0]<(e_[0]-ed[0])*(en[1]-ed[1])/(e_[1]-ed[1])+ed[0]&&(ec=!ec)}}return ec}function mr(en,el,eu,ec){let ed=ec[0]-eu[0],ef=ec[1]-eu[1],em=(en[0]-eu[0])*ef-ed*(en[1]-eu[1]),e_=(el[0]-eu[0])*ef-ed*(el[1]-eu[1]);return em>0&&e_<0||em<0&&e_>0}function yr(en,el,eu,ec){var ed,ef;return 0!=(ed=[ec[0]-eu[0],ec[1]-eu[1]])[0]*(ef=[el[0]-en[0],el[1]-en[1]])[1]-ed[1]*ef[0]&&!(!mr(en,el,eu,ec)||!mr(eu,ec,en,el))}function _r(en,el){for(let eu=0;eu<en.length;++eu)if(!dr(en[eu],el))return!1;for(let eu=0;eu<en.length-1;++eu)if(function(en,el,eu){for(let ec of eu)for(let eu=0,ed=ec.length,ef=ed-1;eu<ed;ef=eu++)if(yr(en,el,ec[ef],ec[eu]))return!0;return!1}(en[eu],en[eu+1],el))return!1;return!0}function Mr(en,el,eu){let ec=[];for(let ed=0;ed<en.length;ed++){let ef=[];for(let ec=0;ec<en[ed].length;ec++){let em=function(en,el){let eu=(180+en[0])/360,ec=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+en[1]*Math.PI/360)))/360,ed=Math.pow(2,el.z);return[Math.round(eu*ed*8192),Math.round(ec*ed*8192)]}(en[ed][ec],eu);hr(el,em),ef.push(em)}ec.push(ef)}return ec}function Ar(en,el,eu){let ec=[];for(let ed=0;ed<en.length;ed++){let ef=Mr(en[ed],el,eu);ec.push(ef)}return ec}function Sr(en,el,eu,ec){if(en[0]<eu[0]||en[0]>eu[2]){let el=.5*ec,ed=en[0]-eu[0]>el?-ec:eu[0]-en[0]>el?ec:0;0===ed&&(ed=en[0]-eu[2]>el?-ec:eu[2]-en[0]>el?ec:0),en[0]+=ed}hr(el,en)}function Ir(en,el,eu,ec){let ed=8192*Math.pow(2,ec.z),ef=[8192*ec.x,8192*ec.y],em=[];if(!en)return em;for(let ec of en)for(let en of ec){let ec=[en.x+ef[0],en.y+ef[1]];Sr(ec,el,eu,ed),em.push(ec)}return em}function kr(en,el,eu,ec){let ed=8192*Math.pow(2,ec.z),ef=[8192*ec.x,8192*ec.y],em=[];if(!en)return em;for(let eu of en){let en=[];for(let ec of eu){let eu=[ec.x+ef[0],ec.y+ef[1]];hr(el,eu),en.push(eu)}em.push(en)}if(el[2]-el[0]<=ed/2)for(let en of(el[0]=el[1]=1/0,el[2]=el[3]=-1/0,em))for(let ec of en)Sr(ec,el,eu,ed);return em}let Tr=class Tr{constructor(en,el){this.type=tw,this.geojson=en,this.geometries=el}static parse(en,el){if(2!==en.length)return el.error(`'within' expression requires exactly one argument, but found ${en.length-1} instead.`);if(Ue(en[1])){let el=en[1];if("FeatureCollection"===el.type)for(let en=0;en<el.features.length;++en){let eu=el.features[en].geometry.type;if("Polygon"===eu||"MultiPolygon"===eu)return new Tr(el,el.features[en].geometry)}else if("Feature"===el.type){let en=el.geometry.type;if("Polygon"===en||"MultiPolygon"===en)return new Tr(el,el.geometry)}else if("Polygon"===el.type||"MultiPolygon"===el.type)return new Tr(el,el)}return el.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(en){if(null!=en.geometry()&&null!=en.canonicalID()){if("Point"===en.geometryType())return function(en,el){let eu=[1/0,1/0,-1/0,-1/0],ec=[1/0,1/0,-1/0,-1/0],ed=en.canonicalID();if(!ed)return!1;if("Polygon"===el.type){let ef=Mr(el.coordinates,ec,ed),em=Ir(en.geometry(),eu,ec,ed);if(!pr(eu,ec))return!1;for(let en of em)if(!dr(en,ef))return!1}if("MultiPolygon"===el.type){let ef=Ar(el.coordinates,ec,ed),em=Ir(en.geometry(),eu,ec,ed);if(!pr(eu,ec))return!1;for(let en of em)if(!function(en,el){for(let eu=0;eu<el.length;eu++)if(dr(en,el[eu]))return!0;return!1}(en,ef))return!1}return!0}(en,this.geometries);if("LineString"===en.geometryType())return function(en,el){let eu=[1/0,1/0,-1/0,-1/0],ec=[1/0,1/0,-1/0,-1/0],ed=en.canonicalID();if(!ed)return!1;if("Polygon"===el.type){let ef=Mr(el.coordinates,ec,ed),em=kr(en.geometry(),eu,ec,ed);if(!pr(eu,ec))return!1;for(let en of em)if(!_r(en,ef))return!1}if("MultiPolygon"===el.type){let ef=Ar(el.coordinates,ec,ed),em=kr(en.geometry(),eu,ec,ed);if(!pr(eu,ec))return!1;for(let en of em)if(!function(en,el){for(let eu=0;eu<el.length;eu++)if(_r(en,el[eu]))return!0;return!1}(en,ef))return!1}return!0}(en,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}};var tN={exports:{}};tN.exports=function(){var en={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},el=1/298.257223563*(2-1/298.257223563),eu=Math.PI/180,i=function(ec,ed){if(void 0===ec)throw Error("No latitude given.");if(ed&&!en[ed])throw Error("Unknown unit "+ed+". Use one of: "+Object.keys(en).join(", "));var ef=6378.137*eu*(ed?en[ed]:1),em=Math.cos(ec*eu),e_=1/(1-el*(1-em*em)),ew=Math.sqrt(e_);this.kx=ef*ew*em,this.ky=ef*ew*e_*(1-el)},ec={units:{configurable:!0}};function a(en,el){return en[0]===el[0]&&en[1]===el[1]}function o(en,el,eu){var ec=l(el[0]-en[0]);return[en[0]+ec*eu,en[1]+(el[1]-en[1])*eu]}function l(en){for(;en<-180;)en+=360;for(;en>180;)en-=360;return en}return i.fromTile=function(en,el,ec){var ed=Math.PI*(1-2*(en+.5)/Math.pow(2,el)),ef=Math.atan(.5*(Math.exp(ed)-Math.exp(-ed)))/eu;return new i(ef,ec)},ec.units.get=function(){return en},i.prototype.distance=function(en,el){var eu=l(en[0]-el[0])*this.kx,ec=(en[1]-el[1])*this.ky;return Math.sqrt(eu*eu+ec*ec)},i.prototype.bearing=function(en,el){return Math.atan2(l(el[0]-en[0])*this.kx,(el[1]-en[1])*this.ky)/eu},i.prototype.destination=function(en,el,ec){var ed=ec*eu;return this.offset(en,Math.sin(ed)*el,Math.cos(ed)*el)},i.prototype.offset=function(en,el,eu){return[en[0]+el/this.kx,en[1]+eu/this.ky]},i.prototype.lineDistance=function(en){for(var el=0,eu=0;eu<en.length-1;eu++)el+=this.distance(en[eu],en[eu+1]);return el},i.prototype.area=function(en){for(var el=0,eu=0;eu<en.length;eu++)for(var ec=en[eu],ed=0,ef=ec.length,em=ef-1;ed<ef;em=ed++)el+=l(ec[ed][0]-ec[em][0])*(ec[ed][1]+ec[em][1])*(eu?-1:1);return Math.abs(el)/2*this.kx*this.ky},i.prototype.along=function(en,el){var eu=0;if(el<=0)return en[0];for(var ec=0;ec<en.length-1;ec++){var ed=en[ec],ef=en[ec+1],em=this.distance(ed,ef);if((eu+=em)>el)return o(ed,ef,(el-(eu-em))/em)}return en[en.length-1]},i.prototype.pointToSegmentDistance=function(en,el,eu){var ec=el[0],ed=el[1],ef=l(eu[0]-ec)*this.kx,em=(eu[1]-ed)*this.ky,e_=0;return 0===ef&&0===em||((e_=(l(en[0]-ec)*this.kx*ef+(en[1]-ed)*this.ky*em)/(ef*ef+em*em))>1?(ec=eu[0],ed=eu[1]):e_>0&&(ec+=ef/this.kx*e_,ed+=em/this.ky*e_)),Math.sqrt((ef=l(en[0]-ec)*this.kx)*ef+(em=(en[1]-ed)*this.ky)*em)},i.prototype.pointOnLine=function(en,el){for(var eu,ec,ed,ef,em=1/0,e_=0;e_<en.length-1;e_++){var ew=en[e_][0],eT=en[e_][1],eM=l(en[e_+1][0]-ew)*this.kx,eE=(en[e_+1][1]-eT)*this.ky,eS=0;0===eM&&0===eE||((eS=(l(el[0]-ew)*this.kx*eM+(el[1]-eT)*this.ky*eE)/(eM*eM+eE*eE))>1?(ew=en[e_+1][0],eT=en[e_+1][1]):eS>0&&(ew+=eM/this.kx*eS,eT+=eE/this.ky*eS));var eA=(eM=l(el[0]-ew)*this.kx)*eM+(eE=(el[1]-eT)*this.ky)*eE;eA<em&&(em=eA,eu=ew,ec=eT,ed=e_,ef=eS)}return{point:[eu,ec],index:ed,t:Math.max(0,Math.min(1,ef))}},i.prototype.lineSlice=function(en,el,eu){var ec=this.pointOnLine(eu,en),ed=this.pointOnLine(eu,el);if(ec.index>ed.index||ec.index===ed.index&&ec.t>ed.t){var ef=ec;ec=ed,ed=ef}var em=[ec.point],e_=ec.index+1,ew=ed.index;!a(eu[e_],em[0])&&e_<=ew&&em.push(eu[e_]);for(var eT=e_+1;eT<=ew;eT++)em.push(eu[eT]);return a(eu[ew],ed.point)||em.push(ed.point),em},i.prototype.lineSliceAlong=function(en,el,eu){for(var ec=0,ed=[],ef=0;ef<eu.length-1;ef++){var em=eu[ef],e_=eu[ef+1],ew=this.distance(em,e_);if((ec+=ew)>en&&0===ed.length&&ed.push(o(em,e_,(en-(ec-ew))/ew)),ec>=el)return ed.push(o(em,e_,(el-(ec-ew))/ew)),ed;ec>en&&ed.push(e_)}return ed},i.prototype.bufferPoint=function(en,el){var eu=el/this.ky,ec=el/this.kx;return[en[0]-ec,en[1]-eu,en[0]+ec,en[1]+eu]},i.prototype.bufferBBox=function(en,el){var eu=el/this.ky,ec=el/this.kx;return[en[0]-ec,en[1]-eu,en[2]+ec,en[3]+eu]},i.prototype.insideBBox=function(en,el){return l(en[0]-el[0])>=0&&0>=l(en[0]-el[2])&&en[1]>=el[1]&&en[1]<=el[3]},Object.defineProperties(i,ec),i}();var tU=p(tN.exports),tV={exports:{}};tV.exports=function(){var t=function(en,el){if(void 0===en&&(en=[]),void 0===el&&(el=e),this.data=en,this.length=this.data.length,this.compare=el,this.length>0)for(var eu=(this.length>>1)-1;eu>=0;eu--)this._down(eu)};function e(en,el){return en<el?-1:en>el?1:0}return t.prototype.push=function(en){this.data.push(en),this.length++,this._up(this.length-1)},t.prototype.pop=function(){if(0!==this.length){var en=this.data[0],el=this.data.pop();return this.length--,this.length>0&&(this.data[0]=el,this._down(0)),en}},t.prototype.peek=function(){return this.data[0]},t.prototype._up=function(en){for(var el=this.data,eu=this.compare,ec=el[en];en>0;){var ed=en-1>>1,ef=el[ed];if(eu(ec,ef)>=0)break;el[en]=ef,en=ed}el[en]=ec},t.prototype._down=function(en){for(var el=this.data,eu=this.compare,ec=this.length>>1,ed=el[en];en<ec;){var ef=1+(en<<1),em=el[ef],e_=ef+1;if(e_<this.length&&0>eu(el[e_],em)&&(ef=e_,em=el[e_]),eu(em,ed)>=0)break;el[en]=em,en=ef}el[en]=ed},t}();var tj=p(tV.exports);function Rr(en,el){return el.dist-en.dist}function Or(en){let el=[1/0,1/0,-1/0,-1/0];if(el.length!==en.length)return!1;for(let eu=0;eu<el.length;eu++)if(el[eu]!==en[eu])return!1;return!0}function Fr(en){return en[1]-en[0]+1}function jr(en,el){let eu=en[1]>=en[0]&&en[1]<el;return eu||console.warn("Distance Expression: Index is out of range"),eu}function Ur(en,el){if(en[0]>en[1])return[null,null];let eu=Fr(en);if(el){if(2===eu)return[en,null];let el=Math.floor(eu/2);return[[en[0],en[0]+el],[en[0]+el,en[1]]]}{if(1===eu)return[en,null];let el=Math.floor(eu/2)-1;return[[en[0],en[0]+el],[en[0]+el+1,en[1]]]}}function Nr(en,el){let eu=[1/0,1/0,-1/0,-1/0];if(!jr(el,en.length))return eu;for(let ec=el[0];ec<=el[1];++ec)hr(eu,en[ec]);return eu}function $r(en){let el=[1/0,1/0,-1/0,-1/0];for(let eu=0;eu<en.length;++eu)for(let ec=0;ec<en[eu].length;++ec)hr(el,en[eu][ec]);return el}function qr(en,el,eu){if(Or(en)||Or(el))return NaN;let ec=0,ed=0;return en[2]<el[0]&&(ec=el[0]-en[2]),en[0]>el[2]&&(ec=en[0]-el[2]),en[1]>el[3]&&(ed=en[1]-el[3]),en[3]<el[1]&&(ed=el[1]-en[3]),eu.distance([0,0],[ec,ed])}function Gr(en,el){let eu=Math.pow(2,el.z);return[360*((en.x/8192+el.x)/eu)-180,360/Math.PI*Math.atan(Math.exp((180-360*((en.y/8192+el.y)/eu))*Math.PI/180))-90]}function Zr(en,el,eu){let ec=eu.pointOnLine(el,en).point;return eu.distance(en,ec)}function Xr(en,el,eu,ec,ed){let ef=eu.slice(ec[0],ec[1]+1),em=1/0;for(let eu=el[0];eu<=el[1];++eu)if(0===(em=Math.min(em,Zr(en[eu],ef,ed))))return 0;return em}function Kr(en,el,eu,ec,ed){let ef=Math.min(ed.pointToSegmentDistance(en,eu,ec),ed.pointToSegmentDistance(el,eu,ec)),em=Math.min(ed.pointToSegmentDistance(eu,en,el),ed.pointToSegmentDistance(ec,en,el));return Math.min(ef,em)}function tn(en,el){for(let eu of en)for(let en=0;en<=eu.length-1;++en)if(dr(eu[en],el,!0))return!0;return!1}function rn(en,el,eu,ec,ed,ef,em){if(null===ef||null===em)return;let e_=qr(Nr(ec,ef),Nr(ed,em),eu);e_<el&&en.push({dist:e_,range1:ef,range2:em})}function sn(en,el,eu,ec,ed,ef=1/0){let em=Math.min(ef,ed.distance(en[0],eu[0]));if(0===em)return em;let e_=new tj([{dist:0,range1:[0,en.length-1],range2:[0,eu.length-1]}],Rr),ew=el?50:100,eT=ec?50:100;for(;e_.length;){let ef=e_.pop();if(ef.dist>=em)continue;let eM=ef.range1,eE=ef.range2;if(Fr(eM)<=ew&&Fr(eE)<=eT){if(!jr(eM,en.length)||!jr(eE,eu.length))return NaN;if(el&&ec?em=Math.min(em,function(en,el,eu,ec,ed){if(!jr(el,en.length)||!jr(ec,eu.length))return NaN;let ef=1/0;for(let em=el[0];em<el[1];++em)for(let el=ec[0];el<ec[1];++el){if(yr(en[em],en[em+1],eu[el],eu[el+1]))return 0;ef=Math.min(ef,Kr(en[em],en[em+1],eu[el],eu[el+1],ed))}return ef}(en,eM,eu,eE,ed)):el||ec?el&&!ec?em=Math.min(em,Xr(eu,eE,en,eM,ed)):!el&&ec&&(em=Math.min(em,Xr(en,eM,eu,eE,ed))):em=Math.min(em,function(en,el,eu,ec,ed){if(!jr(el,en.length)||!jr(ec,eu.length))return NaN;let ef=1/0;for(let em=el[0];em<=el[1];++em)for(let el=ec[0];el<=ec[1];++el)if(0===(ef=Math.min(ef,ed.distance(en[em],eu[el]))))return ef;return ef}(en,eM,eu,eE,ed)),0===em)break}else{let ef=Ur(eM,el),ew=Ur(eE,ec);rn(e_,em,ed,en,eu,ef[0],ew[0]),rn(e_,em,ed,en,eu,ef[0],ew[1]),rn(e_,em,ed,en,eu,ef[1],ew[0]),rn(e_,em,ed,en,eu,ef[1],ew[1])}}return em}function an(en,el,eu,ec,ed=1/0){let ef=ed,em=Nr(en,[0,en.length-1]);for(let ed of eu)if(!(ef!==1/0&&qr(em,Nr(ed,[0,ed.length-1]),ec)>=ef)&&0===(ef=Math.min(ef,sn(en,el,ed,!0,ec,ef))))break;return ef}function on(en,el,eu,ec,ed=1/0){let ef=ed,em=Nr(en,[0,en.length-1]);for(let ed of eu){if(ef!==1/0&&qr(em,$r(ed),ec)>=ef)continue;let eu=function(en,el,eu,ec,ed=1/0){let ef=Math.min(ec.distance(en[0],eu[0][0]),ed);if(0===ef)return ef;let em=new tj([{dist:0,range1:[0,en.length-1],range2:[0,0]}],Rr),e_=el?50:100,ew=$r(eu);for(;em.length;){let ed=em.pop();if(ed.dist>=ef)continue;let eT=ed.range1;if(Fr(eT)<=e_){if(!jr(eT,en.length))return NaN;if(el){let el=function(en,el,eu,ec){if(!jr(el,en.length))return NaN;for(let ec=el[0];ec<=el[1];++ec)if(dr(en[ec],eu,!0))return 0;let ed=1/0;for(let ef=el[0];ef<el[1];++ef)for(let el of eu)for(let eu=0,em=el.length,e_=em-1;eu<em;e_=eu++){if(yr(en[ef],en[ef+1],el[e_],el[eu]))return 0;ed=Math.min(ed,Kr(en[ef],en[ef+1],el[e_],el[eu],ec))}return ed}(en,eT,eu,ec);if(0===(ef=Math.min(ef,el)))break}else for(let el=eT[0];el<=eT[1];++el){let ed=function(en,el,eu){if(dr(en,el,!0))return 0;let ec=1/0;for(let ed of el){let el=ed.length;if(el<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(ed[0]!==ed[el-1]&&0===(ec=Math.min(ec,eu.pointToSegmentDistance(en,ed[el-1],ed[0])))||0===(ec=Math.min(ec,Zr(en,ed,eu))))break}return ec}(en[el],eu,ec);if(0===(ef=Math.min(ef,ed)))return ef}}else{let eu=Ur(eT,el);if(null!==eu[0]){let el=qr(Nr(en,eu[0]),ew,ec);el<ef&&em.push({dist:el,range1:eu[0],range2:[0,0]})}if(null!==eu[1]){let el=qr(Nr(en,eu[1]),ew,ec);el<ef&&em.push({dist:el,range1:eu[1],range2:[0,0]})}}}return ef}(en,el,ed,ec,ef);if(isNaN(eu))return eu;if(0===(ef=Math.min(ef,eu)))break}return ef}function ln(en){return"Point"===en||"MultiPoint"===en||"LineString"===en||"MultiLineString"===en||"Polygon"===en||"MultiPolygon"===en}let un=class un{constructor(en,el){this.type=tg,this.geojson=en,this.geometries=el}static parse(en,el){if(2!==en.length)return el.error(`'distance' expression requires either one argument, but found ' ${en.length-1} instead.`);if(Ue(en[1])){let el=en[1];if("FeatureCollection"===el.type){for(let en=0;en<el.features.length;++en)if(ln(el.features[en].geometry.type))return new un(el,el.features[en].geometry)}else if("Feature"===el.type){if(ln(el.geometry.type))return new un(el,el.geometry)}else if(ln(el.type))return new un(el,el)}return el.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(en){let el=en.geometry(),eu=en.canonicalID();if(null!=el&&null!=eu){if("Point"===en.geometryType())return function(en,el,eu){let ec=[];for(let eu of en)for(let en of eu)ec.push(Gr(en,el));let ed=new tU(ec[0][1],"meters");return"Point"===eu.type||"MultiPoint"===eu.type||"LineString"===eu.type?sn(ec,!1,"Point"===eu.type?[eu.coordinates]:eu.coordinates,"LineString"===eu.type,ed):"MultiLineString"===eu.type?an(ec,!1,eu.coordinates,ed):"Polygon"===eu.type||"MultiPolygon"===eu.type?on(ec,!1,"Polygon"===eu.type?[eu.coordinates]:eu.coordinates,ed):null}(el,eu,this.geometries);if("LineString"===en.geometryType())return function(en,el,eu){let ec=[];for(let eu of en){let en=[];for(let ec of eu)en.push(Gr(ec,el));ec.push(en)}let ed=new tU(ec[0][0][1],"meters");if("Point"===eu.type||"MultiPoint"===eu.type||"LineString"===eu.type)return an("Point"===eu.type?[eu.coordinates]:eu.coordinates,"LineString"===eu.type,ec,ed);if("MultiLineString"===eu.type){let en=1/0;for(let el=0;el<eu.coordinates.length;el++){let ef=an(eu.coordinates[el],!0,ec,ed,en);if(isNaN(ef))return ef;if(0===(en=Math.min(en,ef)))break}return en}if("Polygon"===eu.type||"MultiPolygon"===eu.type){let en=1/0;for(let el=0;el<ec.length;el++){let ef=on(ec[el],!0,"Polygon"===eu.type?[eu.coordinates]:eu.coordinates,ed,en);if(isNaN(ef))return ef;if(0===(en=Math.min(en,ef)))break}return en}return null}(el,eu,this.geometries);if("Polygon"===en.geometryType())return function(en,el,eu){let ec=[];for(let eu of function(en,el){let eu,ec;let ed=en.length;if(ed<=1)return[en];let ef=[];for(let el=0;el<ed;el++){let ed=function(en){let el=0;for(let eu,ec,ed=0,ef=en.length,em=ef-1;ed<ef;em=ed++)eu=en[ed],el+=((ec=en[em]).x-eu.x)*(eu.y+ec.y);return el}(en[el]);0!==ed&&(en[el].area=Math.abs(ed),void 0===ec&&(ec=ed<0),ec===ed<0?(eu&&ef.push(eu),eu=[en[el]]):eu.push(en[el]))}return eu&&ef.push(eu),ef}(en)){let en=[];for(let ec=0;ec<eu.length;++ec)en.push(function(en,el){let eu=[];for(let ec=0;ec<en.length;++ec)eu.push(Gr(en[ec],el));return eu}(eu[ec],el));ec.push(en)}let ed=new tU(ec[0][0][0][1],"meters");if("Point"===eu.type||"MultiPoint"===eu.type||"LineString"===eu.type)return on("Point"===eu.type?[eu.coordinates]:eu.coordinates,"LineString"===eu.type,ec,ed);if("MultiLineString"===eu.type){let en=1/0;for(let el=0;el<eu.coordinates.length;el++){let ef=on(eu.coordinates[el],!0,ec,ed,en);if(isNaN(ef))return ef;if(0===(en=Math.min(en,ef)))break}return en}return"Polygon"===eu.type||"MultiPolygon"===eu.type?function(en,el,eu){let ec=1/0;for(let ed of en)for(let en of el){let el=function(en,el,eu,ec=1/0){let ed=$r(en),ef=$r(el);if(ec!==1/0&&qr(ed,ef,eu)>=ec)return ec;if(pr(ed,ef)){if(tn(en,el))return 0}else if(tn(el,en))return 0;let em=ec;for(let ec of en)for(let en=0,ed=ec.length,ef=ed-1;en<ed;ef=en++)for(let ed of el)for(let el=0,e_=ed.length,ew=e_-1;el<e_;ew=el++){if(yr(ec[ef],ec[en],ed[ew],ed[el]))return 0;em=Math.min(em,Kr(ec[ef],ec[en],ed[ew],ed[el],eu))}return em}(ed,en,eu,ec);if(isNaN(el))return el;if(0===(ec=Math.min(ec,el)))return ec}return ec}("Polygon"===eu.type?[eu.coordinates]:eu.coordinates,ec,ed):null}(el,eu,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}};function hn(en){if(en instanceof ir&&("get"===en.name&&1===en.args.length||"feature-state"===en.name||"has"===en.name&&1===en.args.length||"properties"===en.name||"geometry-type"===en.name||"id"===en.name||/^filter-/.test(en.name))||en instanceof Tr||en instanceof un)return!1;let el=!0;return en.eachChild(en=>{el&&!hn(en)&&(el=!1)}),el}function pn(en){if(en instanceof ir&&"feature-state"===en.name)return!1;let el=!0;return en.eachChild(en=>{el&&!pn(en)&&(el=!1)}),el}function fn(en){if(en instanceof ir&&"config"===en.name)return!1;let el=!0;return en.eachChild(en=>{el&&!fn(en)&&(el=!1)}),el}function dn(en,el){if(en instanceof ir&&el.indexOf(en.name)>=0)return!1;let eu=!0;return en.eachChild(en=>{eu&&!dn(en,el)&&(eu=!1)}),eu}let mn=class mn{constructor(en,el){this.type=el.type,this.name=en,this.boundExpression=el}static parse(en,el){if(2!==en.length||"string"!=typeof en[1])return el.error("'var' expression requires exactly one string literal argument.");let eu=en[1];return el.scope.has(eu)?new mn(eu,el.scope.get(eu)):el.error(`Unknown variable "${eu}". Make sure "${eu}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(en){return this.boundExpression.evaluate(en)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}};let gn=class gn{constructor(en,el=[],eu,ec=new ce,ed=[],ef,em){this.registry=en,this.path=el,this.key=el.map(en=>`[${en}]`).join(""),this.scope=ec,this.errors=ed,this.expectedType=eu,this._scope=ef,this.options=em}parse(en,el,eu,ec,ed={}){return el||eu?this.concat(el,eu,ec)._parse(en,ed):this._parse(en,ed)}_parse(en,el){function r(en,el,eu){return"assert"===eu?new Xe(el,[en]):"coerce"===eu?new tr(el,[en]):en}if(null!==en&&"string"!=typeof en&&"boolean"!=typeof en&&"number"!=typeof en||(en=["literal",en]),Array.isArray(en)){if(0===en.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');let eu="string"==typeof en[0]?this.registry[en[0]]:void 0;if(eu){let ec=eu.parse(en,this);if(!ec)return null;if(this.expectedType){let en=this.expectedType,eu=ec.type;if("string"!==en.kind&&"number"!==en.kind&&"boolean"!==en.kind&&"object"!==en.kind&&"array"!==en.kind||"value"!==eu.kind){if("color"!==en.kind&&"formatted"!==en.kind&&"resolvedImage"!==en.kind||"value"!==eu.kind&&"string"!==eu.kind){if(this.checkSubtype(en,eu))return null}else ec=r(ec,en,el.typeAnnotation||"coerce")}else ec=r(ec,en,el.typeAnnotation||"assert")}if(!(ec instanceof qe)&&"resolvedImage"!==ec.type.kind&&function vn(en){if(en instanceof mn)return vn(en.boundExpression);if(en instanceof ir&&"error"===en.name||en instanceof ir&&"config"===en.name||en instanceof or||en instanceof Tr||en instanceof un)return!1;let el=en instanceof tr||en instanceof Xe,eu=!0;return en.eachChild(en=>{eu=el?eu&&vn(en):eu&&en instanceof qe}),!!eu&&hn(en)&&dn(en,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light"])}(ec)){let en=new tO(this._scope,this.options);try{ec=new qe(ec.type,ec.evaluate(en))}catch(en){return this.error(en.message),null}}return ec}return tr.parse(["to-array",en],this)}return this.error(void 0===en?"'undefined' value invalid. Use null instead.":"object"==typeof en?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof en} instead.`)}concat(en,el,eu){let ec="number"==typeof en?this.path.concat(en):this.path,ed=eu?this.scope.concat(eu):this.scope;return new gn(this.registry,ec,el||null,ed,this.errors,this._scope,this.options)}error(en,...el){let eu=`${this.key}${el.map(en=>`[${en}]`).join("")}`;this.errors.push(new tm(eu,en))}checkSubtype(en,el){let eu=Se(en,el);return eu&&this.error(eu),eu}};var tG=gn;function bn(en,el){let eu=en.length-1,ec,ed,ef=0,em=eu,e_=0;for(;ef<=em;)if(ec=en[e_=Math.floor((ef+em)/2)],ed=en[e_+1],ec<=el){if(e_===eu||el<ed)return e_;ef=e_+1}else{if(!(ec>el))throw new tD("Input is not a number.");em=e_-1}return 0}let _n=class _n{constructor(en,el,eu){for(let[ec,ed]of(this.type=en,this.input=el,this.labels=[],this.outputs=[],eu))this.labels.push(ec),this.outputs.push(ed)}static parse(en,el){if(en.length-1<4)return el.error(`Expected at least 4 arguments, but found only ${en.length-1}.`);if((en.length-1)%2!=0)return el.error("Expected an even number of arguments.");let eu=el.parse(en[1],1,tg);if(!eu)return null;let ec=[],ed=null;el.expectedType&&"value"!==el.expectedType.kind&&(ed=el.expectedType);for(let eu=1;eu<en.length;eu+=2){let ef=1===eu?-1/0:en[eu],em=en[eu+1],e_=eu,ew=eu+1;if("number"!=typeof ef)return el.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',e_);if(ec.length&&ec[ec.length-1][0]>=ef)return el.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',e_);let eT=el.parse(em,ew,ed);if(!eT)return null;ed=ed||eT.type,ec.push([ef,eT])}return new _n(ed,eu,ec)}evaluate(en){let el=this.labels,eu=this.outputs;if(1===el.length)return eu[0].evaluate(en);let ec=this.input.evaluate(en);if(ec<=el[0])return eu[0].evaluate(en);let ed=el.length;return ec>=el[ed-1]?eu[ed-1].evaluate(en):eu[bn(el,ec)].evaluate(en)}eachChild(en){for(let el of(en(this.input),this.outputs))en(el)}outputDefined(){return this.outputs.every(en=>en.outputDefined())}serialize(){let en=["step",this.input.serialize()];for(let el=0;el<this.labels.length;el++)el>0&&en.push(this.labels[el]),en.push(this.outputs[el].serialize());return en}};function Mn(en,el,eu){return en*(1-eu)+el*eu}function An(en,el,eu){return en.map((en,ec)=>Mn(en,el[ec],eu))}var tq=Object.freeze({__proto__:null,array:An,color:function(en,el,eu){return new Ce(Mn(en.r,el.r,eu),Mn(en.g,el.g,eu),Mn(en.b,el.b,eu),Mn(en.a,el.a,eu))},number:Mn});let tZ=4/29,t$=6/29,tW=3*t$*t$,tH=t$*t$*t$,tX=Math.PI/180,tK=180/Math.PI;function Cn(en){return en>tH?Math.pow(en,1/3):en/tW+tZ}function Rn(en){return en>t$?en*en*en:tW*(en-tZ)}function Ln(en){return 255*(en<=.0031308?12.92*en:1.055*Math.pow(en,1/2.4)-.055)}function Vn(en){return(en/=255)<=.04045?en/12.92:Math.pow((en+.055)/1.055,2.4)}function On(en){let el=Vn(en.r),eu=Vn(en.g),ec=Vn(en.b),ed=Cn((.4124564*el+.3575761*eu+.1804375*ec)/.95047),ef=Cn((.2126729*el+.7151522*eu+.072175*ec)/1);return{l:116*ef-16,a:500*(ed-ef),b:200*(ef-Cn((.0193339*el+.119192*eu+.9503041*ec)/1.08883)),alpha:en.a}}function Fn(en){let el=(en.l+16)/116,eu=isNaN(en.a)?el:el+en.a/500,ec=isNaN(en.b)?el:el-en.b/200;return el=1*Rn(el),eu=.95047*Rn(eu),ec=1.08883*Rn(ec),new Ce(Ln(3.2404542*eu-1.5371385*el-.4985314*ec),Ln(-.969266*eu+1.8760108*el+.041556*ec),Ln(.0556434*eu-.2040259*el+1.0572252*ec),en.alpha)}let tJ={forward:On,reverse:Fn,interpolate:function(en,el,eu){return{l:Mn(en.l,el.l,eu),a:Mn(en.a,el.a,eu),b:Mn(en.b,el.b,eu),alpha:Mn(en.alpha,el.alpha,eu)}}},tY={forward:function(en){let{l:el,a:eu,b:ec}=On(en),ed=Math.atan2(ec,eu)*tK;return{h:ed<0?ed+360:ed,c:Math.sqrt(eu*eu+ec*ec),l:el,alpha:en.a}},reverse:function(en){let el=en.h*tX,eu=en.c;return Fn({l:en.l,a:Math.cos(el)*eu,b:Math.sin(el)*eu,alpha:en.alpha})},interpolate:function(en,el,eu){return{h:function(en,el,eu){let ec=el-en;return en+eu*(ec>180||ec<-180?ec-360*Math.round(ec/360):ec)}(en.h,el.h,eu),c:Mn(en.c,el.c,eu),l:Mn(en.l,el.l,eu),alpha:Mn(en.alpha,el.alpha,eu)}}};var tQ=Object.freeze({__proto__:null,hcl:tY,lab:tJ});let qn=class qn{constructor(en,el,eu,ec,ed){for(let[ef,em]of(this.type=en,this.operator=el,this.interpolation=eu,this.input=ec,this.labels=[],this.outputs=[],ed))this.labels.push(ef),this.outputs.push(em)}static interpolationFactor(en,el,eu,ec){let ed=0;if("exponential"===en.name)ed=Gn(el,en.base,eu,ec);else if("linear"===en.name)ed=Gn(el,1,eu,ec);else if("cubic-bezier"===en.name){let ef=en.controlPoints;ed=new eO(ef[0],ef[1],ef[2],ef[3]).solve(Gn(el,1,eu,ec))}return ed}static parse(en,el){let[eu,ec,ed,...ef]=en;if(!Array.isArray(ec)||0===ec.length)return el.error("Expected an interpolation type expression.",1);if("linear"===ec[0])ec={name:"linear"};else if("exponential"===ec[0]){let en=ec[1];if("number"!=typeof en)return el.error("Exponential interpolation requires a numeric base.",1,1);ec={name:"exponential",base:en}}else{if("cubic-bezier"!==ec[0])return el.error(`Unknown interpolation type ${String(ec[0])}`,1,0);{let en=ec.slice(1);if(4!==en.length||en.some(en=>"number"!=typeof en||en<0||en>1))return el.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);ec={name:"cubic-bezier",controlPoints:en}}}if(en.length-1<4)return el.error(`Expected at least 4 arguments, but found only ${en.length-1}.`);if((en.length-1)%2!=0)return el.error("Expected an even number of arguments.");if(!(ed=el.parse(ed,2,tg)))return null;let em=[],e_=null;"interpolate-hcl"===eu||"interpolate-lab"===eu?e_=tT:el.expectedType&&"value"!==el.expectedType.kind&&(e_=el.expectedType);for(let en=0;en<ef.length;en+=2){let eu=ef[en],ec=ef[en+1],ed=en+3,ew=en+4;if("number"!=typeof eu)return el.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',ed);if(em.length&&em[em.length-1][0]>=eu)return el.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',ed);let eT=el.parse(ec,ew,e_);if(!eT)return null;e_=e_||eT.type,em.push([eu,eT])}return"number"===e_.kind||"color"===e_.kind||"array"===e_.kind&&"number"===e_.itemType.kind&&"number"==typeof e_.N?new qn(e_,eu,ec,ed,em):el.error(`Type ${Me(e_)} is not interpolatable.`)}evaluate(en){let el=this.labels,eu=this.outputs;if(1===el.length)return eu[0].evaluate(en);let ec=this.input.evaluate(en);if(ec<=el[0])return eu[0].evaluate(en);let ed=el.length;if(ec>=el[ed-1])return eu[ed-1].evaluate(en);let ef=bn(el,ec),em=qn.interpolationFactor(this.interpolation,ec,el[ef],el[ef+1]),e_=eu[ef].evaluate(en),ew=eu[ef+1].evaluate(en);return"interpolate"===this.operator?tq[this.type.kind.toLowerCase()](e_,ew,em):"interpolate-hcl"===this.operator?tY.reverse(tY.interpolate(tY.forward(e_),tY.forward(ew),em)):tJ.reverse(tJ.interpolate(tJ.forward(e_),tJ.forward(ew),em))}eachChild(en){for(let el of(en(this.input),this.outputs))en(el)}outputDefined(){return this.outputs.every(en=>en.outputDefined())}serialize(){let en;en="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);let el=[this.operator,en,this.input.serialize()];for(let en=0;en<this.labels.length;en++)el.push(this.labels[en],this.outputs[en].serialize());return el}};function Gn(en,el,eu,ec){let ed=ec-eu,ef=en-eu;return 0===ed?0:1===el?ef/ed:(Math.pow(el,ef)-1)/(Math.pow(el,ed)-1)}let Zn=class Zn{constructor(en,el){this.type=en,this.args=el}static parse(en,el){if(en.length<2)return el.error("Expectected at least one argument.");let eu=null,ec=el.expectedType;ec&&"value"!==ec.kind&&(eu=ec);let ed=[];for(let ec of en.slice(1)){let en=el.parse(ec,1+ed.length,eu,void 0,{typeAnnotation:"omit"});if(!en)return null;eu=eu||en.type,ed.push(en)}let ef=ec&&ed.some(en=>Se(ec,en.type));return new Zn(ef?tE:eu,ed)}evaluate(en){let el,eu=null,ec=0;for(let ed of this.args){if(ec++,(eu=ed.evaluate(en))&&eu instanceof Fe&&!eu.available&&(el||(el=eu),eu=null,ec===this.args.length))return el;if(null!==eu)break}return eu}eachChild(en){this.args.forEach(en)}outputDefined(){return this.args.every(en=>en.outputDefined())}serialize(){let en=["coalesce"];return this.eachChild(el=>{en.push(el.serialize())}),en}};let Kn=class Kn{constructor(en,el){this.type=el.type,this.bindings=[].concat(en),this.result=el}evaluate(en){return this.result.evaluate(en)}eachChild(en){for(let el of this.bindings)en(el[1]);en(this.result)}static parse(en,el){if(en.length<4)return el.error(`Expected at least 3 arguments, but found ${en.length-1} instead.`);let eu=[];for(let ec=1;ec<en.length-1;ec+=2){let ed=en[ec];if("string"!=typeof ed)return el.error(`Expected string, but found ${typeof ed} instead.`,ec);if(/[^a-zA-Z0-9_]/.test(ed))return el.error("Variable names must contain only alphanumeric characters or '_'.",ec);let ef=el.parse(en[ec+1],ec+1);if(!ef)return null;eu.push([ed,ef])}let ec=el.parse(en[en.length-1],en.length-1,el.expectedType,eu);return ec?new Kn(eu,ec):null}outputDefined(){return this.result.outputDefined()}serialize(){let en=["let"];for(let[el,eu]of this.bindings)en.push(el,eu.serialize());return en.push(this.result.serialize()),en}};let Hn=class Hn{constructor(en,el,eu){this.type=en,this.index=el,this.input=eu}static parse(en,el){if(3!==en.length)return el.error(`Expected 2 arguments, but found ${en.length-1} instead.`);let eu=el.parse(en[1],1,tg),ec=el.parse(en[2],2,we(el.expectedType||tE));return eu&&ec?new Hn(ec.type.itemType,eu,ec):null}evaluate(en){let el=this.index.evaluate(en),eu=this.input.evaluate(en);if(el<0)throw new tD(`Array index out of bounds: ${el} < 0.`);if(el>=eu.length)throw new tD(`Array index out of bounds: ${el} > ${eu.length-1}.`);if(el!==Math.floor(el))throw new tD(`Array index must be an integer, but found ${el} instead.`);return eu[el]}eachChild(en){en(this.index),en(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}};let Qn=class Qn{constructor(en,el){this.type=tw,this.needle=en,this.haystack=el}static parse(en,el){if(3!==en.length)return el.error(`Expected 2 arguments, but found ${en.length-1} instead.`);let eu=el.parse(en[1],1,tE),ec=el.parse(en[2],2,tE);return eu&&ec?Ie(eu.type,[tw,tb,tg,t_,tE])?new Qn(eu,ec):el.error(`Expected first argument to be of type boolean, string, number or null, but found ${Me(eu.type)} instead`):null}evaluate(en){let el=this.needle.evaluate(en),eu=this.haystack.evaluate(en);if(null==eu)return!1;if(!ke(el,["boolean","string","number","null"]))throw new tD(`Expected first argument to be of type boolean, string, number or null, but found ${Me(Ne(el))} instead.`);if(!ke(eu,["string","array"]))throw new tD(`Expected second argument to be of type array or string, but found ${Me(Ne(eu))} instead.`);return eu.indexOf(el)>=0}eachChild(en){en(this.needle),en(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}};let ei=class ei{constructor(en,el,eu){this.type=tg,this.needle=en,this.haystack=el,this.fromIndex=eu}static parse(en,el){if(en.length<=2||en.length>=5)return el.error(`Expected 3 or 4 arguments, but found ${en.length-1} instead.`);let eu=el.parse(en[1],1,tE),ec=el.parse(en[2],2,tE);if(!eu||!ec)return null;if(!Ie(eu.type,[tw,tb,tg,t_,tE]))return el.error(`Expected first argument to be of type boolean, string, number or null, but found ${Me(eu.type)} instead`);if(4===en.length){let ed=el.parse(en[3],3,tg);return ed?new ei(eu,ec,ed):null}return new ei(eu,ec)}evaluate(en){let el=this.needle.evaluate(en),eu=this.haystack.evaluate(en);if(!ke(el,["boolean","string","number","null"]))throw new tD(`Expected first argument to be of type boolean, string, number or null, but found ${Me(Ne(el))} instead.`);if(!ke(eu,["string","array"]))throw new tD(`Expected second argument to be of type array or string, but found ${Me(Ne(eu))} instead.`);if(this.fromIndex){let ec=this.fromIndex.evaluate(en);return eu.indexOf(el,ec)}return eu.indexOf(el)}eachChild(en){en(this.needle),en(this.haystack),this.fromIndex&&en(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){let en=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),en]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}};let ni=class ni{constructor(en,el,eu,ec,ed,ef){this.inputType=en,this.type=el,this.input=eu,this.cases=ec,this.outputs=ed,this.otherwise=ef}static parse(en,el){let eu,ec;if(en.length<5)return el.error(`Expected at least 4 arguments, but found only ${en.length-1}.`);if(en.length%2!=1)return el.error("Expected an even number of arguments.");el.expectedType&&"value"!==el.expectedType.kind&&(ec=el.expectedType);let ed={},ef=[];for(let em=2;em<en.length-1;em+=2){let e_=en[em],ew=en[em+1];Array.isArray(e_)||(e_=[e_]);let eT=el.concat(em);if(0===e_.length)return eT.error("Expected at least one branch label.");for(let en of e_){if("number"!=typeof en&&"string"!=typeof en)return eT.error("Branch labels must be numbers or strings.");if("number"==typeof en&&Math.abs(en)>Number.MAX_SAFE_INTEGER)return eT.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof en&&Math.floor(en)!==en)return eT.error("Numeric branch labels must be integer values.");if(eu){if(eT.checkSubtype(eu,Ne(en)))return null}else eu=Ne(en);if(void 0!==ed[String(en)])return eT.error("Branch labels must be unique.");ed[String(en)]=ef.length}let eM=el.parse(ew,em,ec);if(!eM)return null;ec=ec||eM.type,ef.push(eM)}let em=el.parse(en[1],1,tE);if(!em)return null;let e_=el.parse(en[en.length-1],en.length-1,ec);return e_?"value"!==em.type.kind&&el.concat(1).checkSubtype(eu,em.type)?null:new ni(eu,ec,em,ed,ef,e_):null}evaluate(en){let el=this.input.evaluate(en);return(Ne(el)===this.inputType&&this.outputs[this.cases[el]]||this.otherwise).evaluate(en)}eachChild(en){en(this.input),this.outputs.forEach(en),en(this.otherwise)}outputDefined(){return this.outputs.every(en=>en.outputDefined())&&this.otherwise.outputDefined()}serialize(){let en=["match",this.input.serialize()],el=Object.keys(this.cases).sort(),eu=[],ec={};for(let en of el){let el=ec[this.cases[en]];void 0===el?(ec[this.cases[en]]=eu.length,eu.push([this.cases[en],[en]])):eu[el][1].push(en)}let i=en=>"number"===this.inputType.kind?Number(en):en;for(let[el,ec]of eu)en.push(1===ec.length?i(ec[0]):ec.map(i)),en.push(this.outputs[el].serialize());return en.push(this.otherwise.serialize()),en}};let si=class si{constructor(en,el,eu){this.type=en,this.branches=el,this.otherwise=eu}static parse(en,el){let eu;if(en.length<4)return el.error(`Expected at least 3 arguments, but found only ${en.length-1}.`);if(en.length%2!=0)return el.error("Expected an odd number of arguments.");el.expectedType&&"value"!==el.expectedType.kind&&(eu=el.expectedType);let ec=[];for(let ed=1;ed<en.length-1;ed+=2){let ef=el.parse(en[ed],ed,tw);if(!ef)return null;let em=el.parse(en[ed+1],ed+1,eu);if(!em)return null;ec.push([ef,em]),eu=eu||em.type}let ed=el.parse(en[en.length-1],en.length-1,eu);return ed?new si(eu,ec,ed):null}evaluate(en){for(let[el,eu]of this.branches)if(el.evaluate(en))return eu.evaluate(en);return this.otherwise.evaluate(en)}eachChild(en){for(let[el,eu]of this.branches)en(el),en(eu);en(this.otherwise)}outputDefined(){return this.branches.every(([en,el])=>el.outputDefined())&&this.otherwise.outputDefined()}serialize(){let en=["case"];return this.eachChild(el=>{en.push(el.serialize())}),en}};let oi=class oi{constructor(en,el,eu,ec){this.type=en,this.input=el,this.beginIndex=eu,this.endIndex=ec}static parse(en,el){if(en.length<=2||en.length>=5)return el.error(`Expected 3 or 4 arguments, but found ${en.length-1} instead.`);let eu=el.parse(en[1],1,tE),ec=el.parse(en[2],2,tg);if(!eu||!ec)return null;if(!Ie(eu.type,[we(tE),tb,tE]))return el.error(`Expected first argument to be of type array or string, but found ${Me(eu.type)} instead`);if(4===en.length){let ed=el.parse(en[3],3,tg);return ed?new oi(eu.type,eu,ec,ed):null}return new oi(eu.type,eu,ec)}evaluate(en){let el=this.input.evaluate(en),eu=this.beginIndex.evaluate(en);if(!ke(el,["string","array"]))throw new tD(`Expected first argument to be of type array or string, but found ${Me(Ne(el))} instead.`);if(this.endIndex){let ec=this.endIndex.evaluate(en);return el.slice(eu,ec)}return el.slice(eu)}eachChild(en){en(this.input),en(this.beginIndex),this.endIndex&&en(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){let en=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),en]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}};function ui(en,el){return"=="===en||"!="===en?"boolean"===el.kind||"string"===el.kind||"number"===el.kind||"null"===el.kind||"value"===el.kind:"string"===el.kind||"number"===el.kind||"value"===el.kind}function ci(en,el,eu,ec){return 0===ec.compare(el,eu)}function hi(en,el,eu){let ec="=="!==en&&"!="!==en;return class i{constructor(en,el,eu){this.type=tw,this.lhs=en,this.rhs=el,this.collator=eu,this.hasUntypedArgument="value"===en.type.kind||"value"===el.type.kind}static parse(en,el){if(3!==en.length&&4!==en.length)return el.error("Expected two or three arguments.");let eu=en[0],ed=el.parse(en[1],1,tE);if(!ed)return null;if(!ui(eu,ed.type))return el.concat(1).error(`"${eu}" comparisons are not supported for type '${Me(ed.type)}'.`);let ef=el.parse(en[2],2,tE);if(!ef)return null;if(!ui(eu,ef.type))return el.concat(2).error(`"${eu}" comparisons are not supported for type '${Me(ef.type)}'.`);if(ed.type.kind!==ef.type.kind&&"value"!==ed.type.kind&&"value"!==ef.type.kind)return el.error(`Cannot compare types '${Me(ed.type)}' and '${Me(ef.type)}'.`);ec&&("value"===ed.type.kind&&"value"!==ef.type.kind?ed=new Xe(ef.type,[ed]):"value"!==ed.type.kind&&"value"===ef.type.kind&&(ef=new Xe(ed.type,[ef])));let em=null;if(4===en.length){if("string"!==ed.type.kind&&"string"!==ef.type.kind&&"value"!==ed.type.kind&&"value"!==ef.type.kind)return el.error("Cannot use collator to compare non-string types.");if(!(em=el.parse(en[3],3,tS)))return null}return new i(ed,ef,em)}evaluate(ed){let ef=this.lhs.evaluate(ed),em=this.rhs.evaluate(ed);if(ec&&this.hasUntypedArgument){let el=Ne(ef),eu=Ne(em);if(el.kind!==eu.kind||"string"!==el.kind&&"number"!==el.kind)throw new tD(`Expected arguments for "${en}" to be (string, string) or (number, number), but found (${el.kind}, ${eu.kind}) instead.`)}if(this.collator&&!ec&&this.hasUntypedArgument){let en=Ne(ef),eu=Ne(em);if("string"!==en.kind||"string"!==eu.kind)return el(ed,ef,em)}return this.collator?eu(ed,ef,em,this.collator.evaluate(ed)):el(ed,ef,em)}eachChild(en){en(this.lhs),en(this.rhs),this.collator&&en(this.collator)}outputDefined(){return!0}serialize(){let el=[en];return this.eachChild(en=>{el.push(en.serialize())}),el}}}let t0=hi("==",function(en,el,eu){return el===eu},ci),t1=hi("!=",function(en,el,eu){return el!==eu},function(en,el,eu,ec){return!ci(0,el,eu,ec)}),t2=hi("<",function(en,el,eu){return el<eu},function(en,el,eu,ec){return 0>ec.compare(el,eu)}),t3=hi(">",function(en,el,eu){return el>eu},function(en,el,eu,ec){return ec.compare(el,eu)>0}),t4=hi("<=",function(en,el,eu){return el<=eu},function(en,el,eu,ec){return 0>=ec.compare(el,eu)}),t5=hi(">=",function(en,el,eu){return el>=eu},function(en,el,eu,ec){return ec.compare(el,eu)>=0});let xi=class xi{constructor(en,el,eu,ec,ed,ef){this.type=tb,this.number=en,this.locale=el,this.currency=eu,this.unit=ec,this.minFractionDigits=ed,this.maxFractionDigits=ef}static parse(en,el){if(3!==en.length)return el.error("Expected two arguments.");let eu=el.parse(en[1],1,tg);if(!eu)return null;let ec=en[2];if("object"!=typeof ec||Array.isArray(ec))return el.error("NumberFormat options argument must be an object.");let ed=null;if(ec.locale&&!(ed=el.parse(ec.locale,1,tb)))return null;let ef=null;if(ec.currency&&!(ef=el.parse(ec.currency,1,tb)))return null;let em=null;if(ec.unit&&!(em=el.parse(ec.unit,1,tb)))return null;let e_=null;if(ec["min-fraction-digits"]&&!(e_=el.parse(ec["min-fraction-digits"],1,tg)))return null;let ew=null;return!ec["max-fraction-digits"]||(ew=el.parse(ec["max-fraction-digits"],1,tg))?new xi(eu,ed,ef,em,e_,ew):null}evaluate(en){return new Intl.NumberFormat(this.locale?this.locale.evaluate(en):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(en):void 0,unit:this.unit?this.unit.evaluate(en):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(en):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(en):void 0}).format(this.number.evaluate(en))}eachChild(en){en(this.number),this.locale&&en(this.locale),this.currency&&en(this.currency),this.unit&&en(this.unit),this.minFractionDigits&&en(this.minFractionDigits),this.maxFractionDigits&&en(this.maxFractionDigits)}outputDefined(){return!1}serialize(){let en={};return this.locale&&(en.locale=this.locale.serialize()),this.currency&&(en.currency=this.currency.serialize()),this.unit&&(en.unit=this.unit.serialize()),this.minFractionDigits&&(en["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(en["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),en]}};let vi=class vi{constructor(en){this.type=tg,this.input=en}static parse(en,el){if(2!==en.length)return el.error(`Expected 1 argument, but found ${en.length-1} instead.`);let eu=el.parse(en[1],1);return eu?"array"!==eu.type.kind&&"string"!==eu.type.kind&&"value"!==eu.type.kind?el.error(`Expected argument of type string or array, but found ${Me(eu.type)} instead.`):new vi(eu):null}evaluate(en){let el=this.input.evaluate(en);if("string"==typeof el||Array.isArray(el))return el.length;throw new tD(`Expected value to be of type string or array, but found ${Me(Ne(el))} instead.`)}eachChild(en){en(this.input)}outputDefined(){return!1}serialize(){let en=["length"];return this.eachChild(el=>{en.push(el.serialize())}),en}};function bi(en){return function(){let el=Math.imul((en=1831565813+(en|=0)|0)^en>>>15,1|en);return(((el=el+Math.imul(el^el>>>7,61|el)^el)^el>>>14)>>>0)/4294967296}}let t6={"==":t0,"!=":t1,">":t3,"<":t2,">=":t5,"<=":t4,array:Xe,at:Hn,boolean:Xe,case:si,coalesce:Zn,collator:or,format:We,image:He,in:Qn,"index-of":ei,interpolate:qn,"interpolate-hcl":qn,"interpolate-lab":qn,length:vi,let:Kn,literal:qe,match:ni,number:Xe,"number-format":xi,object:Xe,slice:oi,step:_n,string:Xe,"to-boolean":tr,"to-color":tr,"to-number":tr,"to-string":tr,var:mn,within:Tr,distance:un};function wi(en,[el,eu,ec,ed]){el=el.evaluate(en),eu=eu.evaluate(en),ec=ec.evaluate(en);let ef=ed?ed.evaluate(en):1,em=je(el,eu,ec,ef);if(em)throw new tD(em);return new Ce(el/255*ef,eu/255*ef,ec/255*ef,ef)}function Mi(en,[el,eu,ec,ed]){var ef,em,e_;el=el.evaluate(en),eu=eu.evaluate(en),ec=ec.evaluate(en);let ew=ed?ed.evaluate(en):1,eT=(ef=el,em=eu,e_=ec,"number"==typeof ef&&ef>=0&&ef<=360?"number"==typeof em&&em>=0&&em<=100&&"number"==typeof e_&&e_>=0&&e_<=100?void 0===ew||"number"==typeof ew&&ew>=0&&ew<=1?null:`Invalid hsla value [${[ef,em,e_,ew].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${("number"==typeof ew?[ef,em,e_,ew]:[ef,em,e_]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${("number"==typeof ew?[ef,em,e_,ew]:[ef,em,e_]).join(", ")}]: 'h' must be between 0 and 360.`);if(eT)throw new tD(eT);let eM=`hsla(${el}, ${eu}%, ${ec}%, ${ew})`,eE=Ce.parse(eM);if(!eE)throw new tD(`Failed to parse HSLA color: ${eM}`);return eE}function Si(en,el){let eu=el[en];return void 0===eu?null:eu}function Ii(en,el){switch(en){case"string":return String(el);case"number":return+el;case"boolean":return!!el;case"color":return Ce.parse(el)}return el}function ki(en,el,eu,ec){return void 0!==ec&&(en=ec*Math.round(en/ec)),void 0!==el&&en<el&&(en=el),void 0!==eu&&en>eu&&(en=eu),en}function Ti(en,el,eu){el=[el,eu,en.scope].filter(Boolean).join("\x1f");let ec=en.getConfig(el);if(!ec)return null;let{type:ed,value:ef,values:em,minValue:e_,maxValue:ew,stepValue:eT}=ec,eM=ec.default.evaluate(en),eE=eM;if(ef){let el=en.scope;en.scope=(el||"").split("\x1f").slice(1).join("\x1f"),eE=ef.evaluate(en),en.scope=el}return ed&&(eE=Ii(ed,eE)),void 0!==ef&&void 0!==eE&&em&&!em.includes(eE)&&(eE=eM,ed&&(eE=Ii(ed,eE))),void 0===eE||void 0===e_&&void 0===ew&&void 0===eT||("number"==typeof eE?eE=ki(eE,e_,ew,eT):Array.isArray(eE)&&(eE=eE.map(en=>"number"==typeof en?ki(en,e_,ew,eT):en))),eE}function Pi(en){return{type:en}}function Ei(en){return{result:"success",value:en}}function Bi(en){return{result:"error",value:en}}function Di(en,el){return!!en&&!!en.parameters&&en.parameters.indexOf(el)>-1}function Ci(en){return"data-driven"===en["property-type"]}function Ri(en){return Di(en.expression,"measure-light")}function Li(en){return Di(en.expression,"zoom")}function Vi(en){return!!en.expression&&en.expression.interpolated}function Oi(en){return"object"==typeof en&&null!==en&&!Array.isArray(en)}function Fi(en){return en}function Ui(en,el,eu){return void 0!==en?en:void 0!==el?el:void 0!==eu?eu:void 0}function Ni(en,el,eu,ec,ed){return Ui(typeof eu===ed?ec[eu]:void 0,en.default,el.default)}function $i(en,el,eu){if("number"!==Je(eu))return Ui(en.default,el.default);let ec=en.stops.length;if(1===ec||eu<=en.stops[0][0])return en.stops[0][1];if(eu>=en.stops[ec-1][0])return en.stops[ec-1][1];let ed=bn(en.stops.map(en=>en[0]),eu);return en.stops[ed][1]}function qi(en,el,eu){let ec=void 0!==en.base?en.base:1;if("number"!==Je(eu))return Ui(en.default,el.default);let ed=en.stops.length;if(1===ed||eu<=en.stops[0][0])return en.stops[0][1];if(eu>=en.stops[ed-1][0])return en.stops[ed-1][1];let ef=bn(en.stops.map(en=>en[0]),eu),em=function(en,el,eu,ec){let ed=ec-eu,ef=en-eu;return 0===ed?0:1===el?ef/ed:(Math.pow(el,ef)-1)/(Math.pow(el,ed)-1)}(eu,ec,en.stops[ef][0],en.stops[ef+1][0]),e_=en.stops[ef][1],ew=en.stops[ef+1][1],eT=tq[el.type]||Fi;if(en.colorSpace&&"rgb"!==en.colorSpace){let el=tQ[en.colorSpace];eT=(en,eu)=>el.reverse(el.interpolate(el.forward(en),el.forward(eu),em))}return"function"==typeof e_.evaluate?{evaluate(...en){let el=e_.evaluate.apply(void 0,en),eu=ew.evaluate.apply(void 0,en);if(void 0!==el&&void 0!==eu)return eT(el,eu,em)}}:eT(e_,ew,em)}function Gi(en,el,eu){return"color"===el.type?eu=Ce.parse(eu):"formatted"===el.type?eu=Oe.fromString(eu.toString()):"resolvedImage"===el.type?eu=Fe.fromString(eu.toString()):Je(eu)===el.type||"enum"===el.type&&el.values[eu]||(eu=void 0),Ui(eu,en.default,el.default)}ir.register(t6,{error:[{kind:"error"},[tb],(en,[el])=>{throw new tD(el.evaluate(en))}],typeof:[tb,[tE],(en,[el])=>Me(Ne(el.evaluate(en)))],"to-rgba":[we(tg,4),[tT],(en,[el])=>el.evaluate(en).toArray()],rgb:[tT,[tg,tg,tg],wi],rgba:[tT,[tg,tg,tg,tg],wi],hsl:[tT,[tg,tg,tg],Mi],hsla:[tT,[tg,tg,tg,tg],Mi],has:{type:tw,overloads:[[[tb],(en,[el])=>el.evaluate(en) in en.properties()],[[tb,tM],(en,[el,eu])=>el.evaluate(en) in eu.evaluate(en)]]},get:{type:tE,overloads:[[[tb],(en,[el])=>Si(el.evaluate(en),en.properties())],[[tb,tM],(en,[el,eu])=>Si(el.evaluate(en),eu.evaluate(en))]]},config:{type:tE,overloads:[[[tb],(en,[el])=>Ti(en,el.evaluate(en))],[[tb,tb],(en,[el,eu])=>Ti(en,el.evaluate(en),eu.evaluate(en))]]},"feature-state":[tE,[tb],(en,[el])=>Si(el.evaluate(en),en.featureState||{})],properties:[tM,[],en=>en.properties()],"geometry-type":[tb,[],en=>en.geometryType()],id:[tE,[],en=>en.id()],zoom:[tg,[],en=>en.globals.zoom],pitch:[tg,[],en=>en.globals.pitch||0],"distance-from-center":[tg,[],en=>en.distanceFromCenter()],"measure-light":[tg,[tb],(en,[el])=>en.measureLight(el.evaluate(en))],"heatmap-density":[tg,[],en=>en.globals.heatmapDensity||0],"line-progress":[tg,[],en=>en.globals.lineProgress||0],"raster-value":[tg,[],en=>en.globals.rasterValue||0],"sky-radial-progress":[tg,[],en=>en.globals.skyRadialProgress||0],accumulated:[tE,[],en=>void 0===en.globals.accumulated?null:en.globals.accumulated],"+":[tg,Pi(tg),(en,el)=>{let eu=0;for(let ec of el)eu+=ec.evaluate(en);return eu}],"*":[tg,Pi(tg),(en,el)=>{let eu=1;for(let ec of el)eu*=ec.evaluate(en);return eu}],"-":{type:tg,overloads:[[[tg,tg],(en,[el,eu])=>el.evaluate(en)-eu.evaluate(en)],[[tg],(en,[el])=>-el.evaluate(en)]]},"/":[tg,[tg,tg],(en,[el,eu])=>el.evaluate(en)/eu.evaluate(en)],"%":[tg,[tg,tg],(en,[el,eu])=>el.evaluate(en)%eu.evaluate(en)],ln2:[tg,[],()=>Math.LN2],pi:[tg,[],()=>Math.PI],e:[tg,[],()=>Math.E],"^":[tg,[tg,tg],(en,[el,eu])=>Math.pow(el.evaluate(en),eu.evaluate(en))],sqrt:[tg,[tg],(en,[el])=>Math.sqrt(el.evaluate(en))],log10:[tg,[tg],(en,[el])=>Math.log(el.evaluate(en))/Math.LN10],ln:[tg,[tg],(en,[el])=>Math.log(el.evaluate(en))],log2:[tg,[tg],(en,[el])=>Math.log(el.evaluate(en))/Math.LN2],sin:[tg,[tg],(en,[el])=>Math.sin(el.evaluate(en))],cos:[tg,[tg],(en,[el])=>Math.cos(el.evaluate(en))],tan:[tg,[tg],(en,[el])=>Math.tan(el.evaluate(en))],asin:[tg,[tg],(en,[el])=>Math.asin(el.evaluate(en))],acos:[tg,[tg],(en,[el])=>Math.acos(el.evaluate(en))],atan:[tg,[tg],(en,[el])=>Math.atan(el.evaluate(en))],min:[tg,Pi(tg),(en,el)=>Math.min(...el.map(el=>el.evaluate(en)))],max:[tg,Pi(tg),(en,el)=>Math.max(...el.map(el=>el.evaluate(en)))],abs:[tg,[tg],(en,[el])=>Math.abs(el.evaluate(en))],round:[tg,[tg],(en,[el])=>{let eu=el.evaluate(en);return eu<0?-Math.round(-eu):Math.round(eu)}],floor:[tg,[tg],(en,[el])=>Math.floor(el.evaluate(en))],ceil:[tg,[tg],(en,[el])=>Math.ceil(el.evaluate(en))],"filter-==":[tw,[tb,tE],(en,[el,eu])=>en.properties()[el.value]===eu.value],"filter-id-==":[tw,[tE],(en,[el])=>en.id()===el.value],"filter-type-==":[tw,[tb],(en,[el])=>en.geometryType()===el.value],"filter-<":[tw,[tb,tE],(en,[el,eu])=>{let ec=en.properties()[el.value],ed=eu.value;return typeof ec==typeof ed&&ec<ed}],"filter-id-<":[tw,[tE],(en,[el])=>{let eu=en.id(),ec=el.value;return typeof eu==typeof ec&&eu<ec}],"filter->":[tw,[tb,tE],(en,[el,eu])=>{let ec=en.properties()[el.value],ed=eu.value;return typeof ec==typeof ed&&ec>ed}],"filter-id->":[tw,[tE],(en,[el])=>{let eu=en.id(),ec=el.value;return typeof eu==typeof ec&&eu>ec}],"filter-<=":[tw,[tb,tE],(en,[el,eu])=>{let ec=en.properties()[el.value],ed=eu.value;return typeof ec==typeof ed&&ec<=ed}],"filter-id-<=":[tw,[tE],(en,[el])=>{let eu=en.id(),ec=el.value;return typeof eu==typeof ec&&eu<=ec}],"filter->=":[tw,[tb,tE],(en,[el,eu])=>{let ec=en.properties()[el.value],ed=eu.value;return typeof ec==typeof ed&&ec>=ed}],"filter-id->=":[tw,[tE],(en,[el])=>{let eu=en.id(),ec=el.value;return typeof eu==typeof ec&&eu>=ec}],"filter-has":[tw,[tE],(en,[el])=>el.value in en.properties()],"filter-has-id":[tw,[],en=>null!==en.id()&&void 0!==en.id()],"filter-type-in":[tw,[we(tb)],(en,[el])=>el.value.indexOf(en.geometryType())>=0],"filter-id-in":[tw,[we(tE)],(en,[el])=>el.value.indexOf(en.id())>=0],"filter-in-small":[tw,[tb,we(tE)],(en,[el,eu])=>eu.value.indexOf(en.properties()[el.value])>=0],"filter-in-large":[tw,[tb,we(tE)],(en,[el,eu])=>(function(en,el,eu,ec){for(;eu<=ec;){let ed=eu+ec>>1;if(el[ed]===en)return!0;el[ed]>en?ec=ed-1:eu=ed+1}return!1})(en.properties()[el.value],eu.value,0,eu.value.length-1)],all:{type:tw,overloads:[[[tw,tw],(en,[el,eu])=>el.evaluate(en)&&eu.evaluate(en)],[Pi(tw),(en,el)=>{for(let eu of el)if(!eu.evaluate(en))return!1;return!0}]]},any:{type:tw,overloads:[[[tw,tw],(en,[el,eu])=>el.evaluate(en)||eu.evaluate(en)],[Pi(tw),(en,el)=>{for(let eu of el)if(eu.evaluate(en))return!0;return!1}]]},"!":[tw,[tw],(en,[el])=>!el.evaluate(en)],"is-supported-script":[tw,[tb],(en,[el])=>{let eu=en.globals&&en.globals.isSupportedScript;return!eu||eu(el.evaluate(en))}],upcase:[tb,[tb],(en,[el])=>el.evaluate(en).toUpperCase()],downcase:[tb,[tb],(en,[el])=>el.evaluate(en).toLowerCase()],concat:[tb,Pi(tE),(en,el)=>el.map(el=>$e(el.evaluate(en))).join("")],"resolved-locale":[tb,[tS],(en,[el])=>el.evaluate(en).resolvedLocale()],random:[tg,[tg,tg,tE],(en,el)=>{let eu;let[ec,ed,ef]=el.map(el=>el.evaluate(en));if(ec>ed||ec===ed)return ec;if("string"==typeof ef)eu=function(en){let el=0;if(0===en.length)return el;for(let eu=0;eu<en.length;eu++)el=(el<<5)-el+en.charCodeAt(eu),el&=el;return el}(ef);else{if("number"!=typeof ef)throw new tD(`Invalid seed input: ${ef}`);eu=ef}return ec+bi(eu)()*(ed-ec)}]});let Yi=class Yi{constructor(en,el,eu,ec){this.expression=en,this._warningHistory={},this._evaluator=new tO(eu,ec),this._defaultValue=el?"color"===el.type&&(Oi(el.default)||Array.isArray(el.default))?new Ce(0,0,0,0):"color"===el.type?Ce.parse(el.default)||null:void 0===el.default?null:el.default:null,this._enumValues=el&&"enum"===el.type?el.values:null}evaluateWithoutErrorHandling(en,el,eu,ec,ed,ef,em,e_){return this._evaluator.globals=en,this._evaluator.feature=el,this._evaluator.featureState=eu,this._evaluator.canonical=ec||null,this._evaluator.availableImages=ed||null,this._evaluator.formattedSection=ef,this._evaluator.featureTileCoord=em||null,this._evaluator.featureDistanceData=e_||null,this.expression.evaluate(this._evaluator)}evaluate(en,el,eu,ec,ed,ef,em,e_){this._evaluator.globals=en,this._evaluator.feature=el||null,this._evaluator.featureState=eu||null,this._evaluator.canonical=ec||null,this._evaluator.availableImages=ed||null,this._evaluator.formattedSection=ef||null,this._evaluator.featureTileCoord=em||null,this._evaluator.featureDistanceData=e_||null;try{let en=this.expression.evaluate(this._evaluator);if(null==en||"number"==typeof en&&en!=en)return this._defaultValue;if(this._enumValues&&!(en in this._enumValues))throw new tD(`Expected value to be one of ${Object.keys(this._enumValues).map(en=>JSON.stringify(en)).join(", ")}, but found ${JSON.stringify(en)} instead.`);return en}catch(en){return this._warningHistory[en.message]||(this._warningHistory[en.message]=!0,"undefined"!=typeof console&&console.warn(en.message)),this._defaultValue}}};function Zi(en){return Array.isArray(en)&&en.length>0&&"string"==typeof en[0]&&en[0]in t6}function Xi(en,el,eu,ec){let ed=new tG(t6,[],el?function(en){let el={color:tT,string:tb,number:tg,enum:tb,boolean:tw,formatted:tA,resolvedImage:tI};return"array"===en.type?we(el[en.value]||tE,en.length):el[en.type]}(el):void 0,void 0,void 0,eu,ec),ef=ed.parse(en,void 0,void 0,void 0,el&&"string"===el.type?{typeAnnotation:"coerce"}:void 0);return ef?Ei(new Yi(ef,el,eu,ec)):Bi(ed.errors)}let Ki=class Ki{constructor(en,el,eu){this.kind=en,this._styleExpression=el,this.isLightConstant=eu,this.isStateDependent="constant"!==en&&!pn(el.expression),this.isConfigDependent=!fn(el.expression)}evaluateWithoutErrorHandling(en,el,eu,ec,ed,ef){return this._styleExpression.evaluateWithoutErrorHandling(en,el,eu,ec,ed,ef)}evaluate(en,el,eu,ec,ed,ef){return this._styleExpression.evaluate(en,el,eu,ec,ed,ef)}};let Wi=class Wi{constructor(en,el,eu,ec,ed){this.kind=en,this.zoomStops=eu,this._styleExpression=el,this.isStateDependent="camera"!==en&&!pn(el.expression),this.isLightConstant=ed,this.isConfigDependent=!fn(el.expression),this.interpolationType=ec}evaluateWithoutErrorHandling(en,el,eu,ec,ed,ef){return this._styleExpression.evaluateWithoutErrorHandling(en,el,eu,ec,ed,ef)}evaluate(en,el,eu,ec,ed,ef){return this._styleExpression.evaluate(en,el,eu,ec,ed,ef)}interpolationFactor(en,el,eu){return this.interpolationType?qn.interpolationFactor(this.interpolationType,en,el,eu):0}};function Hi(en,el,eu,ec){if("error"===(en=Xi(en,el,eu,ec)).result)return en;let ed=en.value.expression,ef=hn(ed);if(!ef&&!Ci(el))return Bi([new tm("","data expressions not supported")]);let em=dn(ed,["zoom","pitch","distance-from-center"]);if(!em&&!Li(el))return Bi([new tm("","zoom expressions not supported")]);let e_=dn(ed,["measure-light"]);if(!e_&&!Ri(el))return Bi([new tm("","measure-light expression not supported")]);let ew=el.expression&&el.expression.relaxZoomRestriction,eT=function Qi(en){let el=null;if(en instanceof Kn)el=Qi(en.result);else if(en instanceof Zn){for(let eu of en.args)if(el=Qi(eu))break}else(en instanceof _n||en instanceof qn)&&en.input instanceof ir&&"zoom"===en.input.name&&(el=en);return el instanceof tm||en.eachChild(en=>{let eu=Qi(en);eu instanceof tm?el=eu:el&&eu&&el!==eu&&(el=new tm("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),el}(ed);return eT||em||ew?eT instanceof tm?Bi([eT]):eT instanceof qn&&!Vi(el)?Bi([new tm("",'"interpolate" expressions cannot be used with this property')]):Ei(eT?new Wi(ef?"camera":"composite",en.value,eT.labels,eT instanceof qn?eT.interpolation:void 0,e_):new Ki(ef?"constant":"source",en.value,e_)):Bi([new tm("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}let Ji=class Ji{constructor(en,el){this._parameters=en,this._specification=el,se(this,function ji(en,el){let eu,ec,ed;let ef="color"===el.type,em=en.stops&&"object"==typeof en.stops[0][0],e_=em||!(em||void 0!==en.property),ew=en.type||(Vi(el)?"exponential":"interval");if(ef&&((en=se({},en)).stops&&(en.stops=en.stops.map(en=>[en[0],Ce.parse(en[1])])),en.default=Ce.parse(en.default?en.default:el.default)),en.colorSpace&&"rgb"!==en.colorSpace&&!tQ[en.colorSpace])throw Error(`Unknown color space: ${en.colorSpace}`);if("exponential"===ew)eu=qi;else if("interval"===ew)eu=$i;else if("categorical"===ew){for(let el of(eu=Ni,ec=Object.create(null),en.stops))ec[el[0]]=el[1];ed=typeof en.stops[0][0]}else{if("identity"!==ew)throw Error(`Unknown function type "${ew}"`);eu=Gi}if(em){let eu={},ec=[];for(let el=0;el<en.stops.length;el++){let ed=en.stops[el],ef=ed[0].zoom;void 0===eu[ef]&&(eu[ef]={zoom:ef,type:en.type,property:en.property,default:en.default,stops:[]},ec.push(ef)),eu[ef].stops.push([ed[0].value,ed[1]])}let ed=[];for(let en of ec)ed.push([eu[en].zoom,ji(eu[en],el)]);let ef={name:"linear"};return{kind:"composite",interpolationType:ef,interpolationFactor:qn.interpolationFactor.bind(void 0,ef),zoomStops:ed.map(en=>en[0]),evaluate:({zoom:eu},ec)=>qi({stops:ed,base:en.base},el,eu).evaluate(eu,ec)}}if(e_){let ef="exponential"===ew?{name:"exponential",base:void 0!==en.base?en.base:1}:null;return{kind:"camera",interpolationType:ef,interpolationFactor:qn.interpolationFactor.bind(void 0,ef),zoomStops:en.stops.map(en=>en[0]),evaluate:({zoom:ef})=>eu(en,el,ef,ec,ed)}}return{kind:"source",evaluate(ef,em){let e_=em&&em.properties?em.properties[en.property]:void 0;return void 0===e_?Ui(en.default,el.default):eu(en,el,e_,ec,ed)}}}(this._parameters,this._specification))}static deserialize(en){return new Ji(en._parameters,en._specification)}static serialize(en){return{_parameters:en._parameters,_specification:en._specification}}};function ts(en){let el=en.key,eu=en.value,ec=en.valueSpec||{},ed=en.objectElementValidators||{},ef=en.style,em=en.styleSpec,e_=[],ew=Je(eu);if("object"!==ew)return[new ne(el,eu,`object expected, ${ew} found`)];for(let en in eu){let ew;let eT=en.split(".")[0];ed[eT]?ew=ed[eT]:ec[eT]?ew=Ls:ed["*"]?ew=ed["*"]:ec["*"]&&(ew=Ls),ew?e_=e_.concat(ew({key:(el?`${el}.`:el)+en,value:eu[en],valueSpec:ec[eT]||ec["*"],style:ef,styleSpec:em,object:eu,objectKey:en},eu)):e_.push(new ie(el,eu[en],`unknown property "${en}"`))}for(let en in ec)ed[en]||ec[en].required&&void 0===ec[en].default&&void 0===eu[en]&&e_.push(new ne(el,eu,`missing required property "${en}"`));return e_}function es(en){let el=en.value,eu=en.valueSpec,ec=en.style,ed=en.styleSpec,ef=en.key,em=en.arrayElementValidator||Ls;if("array"!==Je(el))return[new ne(ef,el,`array expected, ${Je(el)} found`)];if(eu.length&&el.length!==eu.length)return[new ne(ef,el,`array length ${eu.length} expected, length ${el.length} found`)];if(eu["min-length"]&&el.length<eu["min-length"])return[new ne(ef,el,`array length at least ${eu["min-length"]} expected, length ${el.length} found`)];let e_={type:eu.value,values:eu.values,minimum:eu.minimum,maximum:eu.maximum,function:void 0};ed.$version<7&&(e_.function=eu.function),"object"===Je(eu.value)&&(e_=eu.value);let ew=[];for(let en=0;en<el.length;en++)ew=ew.concat(em({array:el,arrayIndex:en,value:el[en],valueSpec:e_,style:ec,styleSpec:ed,key:`${ef}[${en}]`},!0));return ew}function rs(en){let el=en.key,eu=en.value,ec=en.valueSpec,ed=Je(eu);if("number"===ed&&eu!=eu&&(ed="NaN"),"number"!==ed)return[new ne(el,eu,`number expected, ${ed} found`)];if("minimum"in ec){let ed=ec.minimum;if("array"===Je(ec.minimum)&&(ed=ec.minimum[en.arrayIndex]),eu<ed)return[new ne(el,eu,`${eu} is less than the minimum value ${ed}`)]}if("maximum"in ec){let ed=ec.maximum;if("array"===Je(ec.maximum)&&(ed=ec.maximum[en.arrayIndex]),eu>ed)return[new ne(el,eu,`${eu} is greater than the maximum value ${ed}`)]}return[]}function ns(en){let el=en.valueSpec,eu=ae(en.value.type),ec,ed,ef,em={},e_="categorical"!==eu&&void 0===en.value.property,ew="array"===Je(en.value.stops)&&"array"===Je(en.value.stops[0])&&"object"===Je(en.value.stops[0][0]),eT=ts({key:en.key,value:en.value,valueSpec:en.styleSpec.function,style:en.style,styleSpec:en.styleSpec,objectElementValidators:{stops:function(en){if("identity"===eu)return[new ne(en.key,en.value,'identity function may not have a "stops" property')];let el=[],ec=en.value;return el=el.concat(es({key:en.key,value:ec,valueSpec:en.valueSpec,style:en.style,styleSpec:en.styleSpec,arrayElementValidator:h})),"array"===Je(ec)&&0===ec.length&&el.push(new ne(en.key,ec,"array must have at least one stop")),el},default:function(en){return Ls({key:en.key,value:en.value,valueSpec:el,style:en.style,styleSpec:en.styleSpec})}}});return"identity"===eu&&e_&&eT.push(new ne(en.key,en.value,'missing required property "property"')),"identity"===eu||en.value.stops||eT.push(new ne(en.key,en.value,'missing required property "stops"')),"exponential"===eu&&en.valueSpec.expression&&!Vi(en.valueSpec)&&eT.push(new ne(en.key,en.value,"exponential functions not supported")),en.styleSpec.$version>=8&&(e_||Ci(en.valueSpec)?e_&&!Li(en.valueSpec)&&eT.push(new ne(en.key,en.value,"zoom functions not supported")):eT.push(new ne(en.key,en.value,"property functions not supported"))),("categorical"===eu||ew)&&void 0===en.value.property&&eT.push(new ne(en.key,en.value,'"property" property is required')),eT;function h(en){let eu=[],ec=en.value,e_=en.key;if("array"!==Je(ec))return[new ne(e_,ec,`array expected, ${Je(ec)} found`)];if(2!==ec.length)return[new ne(e_,ec,`array length 2 expected, length ${ec.length} found`)];if(ew){if("object"!==Je(ec[0]))return[new ne(e_,ec,`object expected, ${Je(ec[0])} found`)];if(void 0===ec[0].zoom)return[new ne(e_,ec,"object stop key must have zoom")];if(void 0===ec[0].value)return[new ne(e_,ec,"object stop key must have value")];let el=ae(ec[0].zoom);if("number"!=typeof el)return[new ne(e_,ec[0].zoom,"stop zoom values must be numbers")];if(ef&&ef>el)return[new ne(e_,ec[0].zoom,"stop zoom values must appear in ascending order")];el!==ef&&(ef=el,ed=void 0,em={}),eu=eu.concat(ts({key:`${e_}[0]`,value:ec[0],valueSpec:{zoom:{}},style:en.style,styleSpec:en.styleSpec,objectElementValidators:{zoom:rs,value:p}}))}else eu=eu.concat(p({key:`${e_}[0]`,value:ec[0],valueSpec:{},style:en.style,styleSpec:en.styleSpec},ec));return Zi(oe(ec[1]))?eu.concat([new ne(`${e_}[1]`,ec[1],"expressions are not allowed in function stops.")]):eu.concat(Ls({key:`${e_}[1]`,value:ec[1],valueSpec:el,style:en.style,styleSpec:en.styleSpec}))}function p(en,ef){let e_=Je(en.value),ew=ae(en.value),eT=null!==en.value?en.value:ef;if(ec){if(e_!==ec)return[new ne(en.key,eT,`${e_} stop domain type must match previous stop domain type ${ec}`)]}else ec=e_;if("number"!==e_&&"string"!==e_&&"boolean"!==e_&&"number"!=typeof ew&&"string"!=typeof ew&&"boolean"!=typeof ew)return[new ne(en.key,eT,"stop domain value must be a number, string, or boolean")];if("number"!==e_&&"categorical"!==eu){let ec=`number expected, ${e_} found`;return Ci(el)&&void 0===eu&&(ec+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new ne(en.key,eT,ec)]}return"categorical"!==eu||"number"!==e_||"number"==typeof ew&&isFinite(ew)&&Math.floor(ew)===ew?"categorical"!==eu&&"number"===e_&&"number"==typeof ew&&"number"==typeof ed&&void 0!==ed&&ew<ed?[new ne(en.key,eT,"stop domain values must appear in ascending order")]:(ed=ew,"categorical"===eu&&ew in em?[new ne(en.key,eT,"stop domain values must be unique")]:(em[ew]=!0,[])):[new ne(en.key,eT,`integer expected, found ${String(ew)}`)]}}function is(en){let el=("property"===en.expressionContext?Hi:Xi)(oe(en.value),en.valueSpec);if("error"===el.result)return el.value.map(el=>new ne(`${en.key}${el.key}`,en.value,el.message));let eu=el.value.expression||el.value._styleExpression.expression;if("property"===en.expressionContext&&"text-font"===en.propertyKey&&!eu.outputDefined())return[new ne(en.key,en.value,`Invalid data expression for "${en.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===en.expressionContext&&"layout"===en.propertyType&&!pn(eu))return[new ne(en.key,en.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===en.expressionContext)return function ss(en,el){let eu=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(el.valueSpec&&el.valueSpec.expression)for(let en of el.valueSpec.expression.parameters)eu.delete(en);if(0===eu.size)return[];let ec=[];return en instanceof ir&&eu.has(en.name)?[new ne(el.key,el.value,`["${en.name}"] expression is not supported in a filter for a ${el.object.type} layer with id: ${el.object.id}`)]:(en.eachChild(en=>{ec.push(...ss(en,el))}),ec)}(eu,en);if(en.expressionContext&&0===en.expressionContext.indexOf("cluster")){if(!dn(eu,["zoom","feature-state"]))return[new ne(en.key,en.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===en.expressionContext&&!hn(eu))return[new ne(en.key,en.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function as(en){let el=en.key,eu=en.value,ec=en.valueSpec,ed=[];return Array.isArray(ec.values)?-1===ec.values.indexOf(ae(eu))&&ed.push(new ne(el,eu,`expected one of [${ec.values.join(", ")}], ${JSON.stringify(eu)} found`)):-1===Object.keys(ec.values).indexOf(ae(eu))&&ed.push(new ne(el,eu,`expected one of [${Object.keys(ec.values).join(", ")}], ${JSON.stringify(eu)} found`)),ed}function os(en){if(!0===en||!1===en)return!0;if(!Array.isArray(en)||0===en.length)return!1;switch(en[0]){case"has":return en.length>=2&&"$id"!==en[1]&&"$type"!==en[1];case"in":return en.length>=3&&("string"!=typeof en[1]||Array.isArray(en[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==en.length||Array.isArray(en[1])||Array.isArray(en[2]);case"any":case"all":for(let el of en.slice(1))if(!os(el)&&"boolean"!=typeof el)return!1;return!0;default:return!0}}function ls(en,el="fill"){if(null==en)return{filter:()=>!0,needGeometry:!1,needFeature:!1};os(en)||(en=function ms(en){if(!en)return!0;let el=en[0];return en.length<=1?"any"!==el:"=="===el?ys(en[1],en[2],"=="):"!="===el?vs(ys(en[1],en[2],"==")):"<"===el||">"===el||"<="===el||">="===el?ys(en[1],en[2],el):"any"===el?["any"].concat(en.slice(1).map(ms)):"all"===el?["all"].concat(en.slice(1).map(ms)):"none"===el?["all"].concat(en.slice(1).map(ms).map(vs)):"in"===el?gs(en[1],en.slice(2)):"!in"===el?vs(gs(en[1],en.slice(2))):"has"===el?xs(en[1]):"!has"!==el||vs(xs(en[1]))}(en));let eu=en,ec=!0;try{ec=function(en){if(!hs(en))return en;let el=oe(en);return function cs(en){let el=!1,eu=[];if("case"===en[0]){for(let ec=1;ec<en.length-1;ec+=2)el=el||hs(en[ec]),eu.push(en[ec+1]);eu.push(en[en.length-1])}else if("match"===en[0]){el=el||hs(en[1]);for(let el=2;el<en.length-1;el+=2)eu.push(en[el+1]);eu.push(en[en.length-1])}else if("step"===en[0]){el=el||hs(en[1]);for(let el=1;el<en.length-1;el+=2)eu.push(en[el+1])}el&&(en.length=0,en.push("any",...eu));for(let el=1;el<en.length;el++)cs(en[el])}(el),el=function us(en){if(!Array.isArray(en))return en;let el=function(en){if(t8.has(en[0])){for(let el=1;el<en.length;el++)if(hs(en[el]))return!0}return en}(en);return!0===el?el:el.map(en=>us(en))}(el)}(eu)}catch(en){console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(eu,null,2)}
        `)}let ed=tc[`filter_${el}`],ef=Xi(ec,ed),em=null;if("error"===ef.result)throw Error(ef.value.map(en=>`${en.key}: ${en.message}`).join(", "));em=(en,el,eu)=>ef.value.evaluate(en,el,{},eu);let e_=null,ew=null;if(ec!==eu){let en=Xi(eu,ed);if("error"===en.result)throw Error(en.value.map(en=>`${en.key}: ${en.message}`).join(", "));e_=(el,eu,ec,ed,ef)=>en.value.evaluate(el,eu,{},ec,void 0,void 0,ed,ef),ew=!hn(en.value.expression)}return{filter:em,dynamicFilter:e_||void 0,needGeometry:function ds(en){if(!Array.isArray(en))return!1;if("within"===en[0]||"distance"===en[0])return!0;for(let el=1;el<en.length;el++)if(ds(en[el]))return!0;return!1}(ec),needFeature:!!ew}}function hs(en){var el;if(!Array.isArray(en))return!1;if("pitch"===(el=en[0])||"distance-from-center"===el)return!0;for(let el=1;el<en.length;el++)if(hs(en[el]))return!0;return!1}let t8=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function fs(en,el){return en<el?-1:en>el?1:0}function ys(en,el,eu){switch(en){case"$type":return[`filter-type-${eu}`,el];case"$id":return[`filter-id-${eu}`,el];default:return[`filter-${eu}`,en,el]}}function gs(en,el){if(0===el.length)return!1;switch(en){case"$type":return["filter-type-in",["literal",el]];case"$id":return["filter-id-in",["literal",el]];default:return el.length>200&&!el.some(en=>typeof en!=typeof el[0])?["filter-in-large",en,["literal",el.sort(fs)]]:["filter-in-small",en,["literal",el]]}}function xs(en){switch(en){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",en]}}function vs(en){return["!",en]}function bs(en){return os(oe(en.value))?is(se({},en,{expressionContext:"filter",valueSpec:en.styleSpec[`filter_${en.layerType||"fill"}`]})):function _s(en){let el=en.value,eu=en.key;if("array"!==Je(el))return[new ne(eu,el,`array expected, ${Je(el)} found`)];let ec=en.styleSpec,ed,ef=[];if(el.length<1)return[new ne(eu,el,"filter array must have at least 1 element")];switch(ef=ef.concat(as({key:`${eu}[0]`,value:el[0],valueSpec:ec.filter_operator,style:en.style,styleSpec:en.styleSpec})),ae(el[0])){case"<":case"<=":case">":case">=":el.length>=2&&"$type"===ae(el[1])&&ef.push(new ne(eu,el,`"$type" cannot be use with operator "${el[0]}"`));case"==":case"!=":3!==el.length&&ef.push(new ne(eu,el,`filter array for operator "${el[0]}" must have 3 elements`));case"in":case"!in":el.length>=2&&"string"!==(ed=Je(el[1]))&&ef.push(new ne(`${eu}[1]`,el[1],`string expected, ${ed} found`));for(let em=2;em<el.length;em++)ed=Je(el[em]),"$type"===ae(el[1])?ef=ef.concat(as({key:`${eu}[${em}]`,value:el[em],valueSpec:ec.geometry_type,style:en.style,styleSpec:en.styleSpec})):"string"!==ed&&"number"!==ed&&"boolean"!==ed&&ef.push(new ne(`${eu}[${em}]`,el[em],`string, number, or boolean expected, ${ed} found`));break;case"any":case"all":case"none":for(let ec=1;ec<el.length;ec++)ef=ef.concat(_s({key:`${eu}[${ec}]`,value:el[ec],style:en.style,styleSpec:en.styleSpec}));break;case"has":case"!has":ed=Je(el[1]),2!==el.length?ef.push(new ne(eu,el,`filter array for "${el[0]}" operator must have 2 elements`)):"string"!==ed&&ef.push(new ne(`${eu}[1]`,el[1],`string expected, ${ed} found`))}return ef}(en)}function ws(en,el){let eu;let ec=en.key,ed=en.style,ef=en.layer,em=en.styleSpec,e_=en.value,ew=en.objectKey,eT=em[`${el}_${en.layerType}`];if(!eT)return[];let eM=ew.match(/^(.*)-transition$/);if("paint"===el&&eM&&eT[eM[1]]&&eT[eM[1]].transition)return Ls({key:ec,value:e_,valueSpec:em.transition,style:ed,styleSpec:em});let eE=en.valueSpec||eT[ew];if(!eE)return[new ie(ec,e_,`unknown property "${ew}"`)];if("string"===Je(e_)&&Ci(eE)&&!eE.tokens&&(eu=/^{([^}]+)}$/.exec(e_))){let en=`\`{ "type": "identity", "property": ${eu?JSON.stringify(eu[1]):'"_"'} }\``;return[new ne(ec,e_,`"${ew}" does not support interpolation syntax
Use an identity property function instead: ${en}.`)]}let eS=[];if("symbol"===en.layerType)"text-field"!==ew||!ed||ed.glyphs||ed.imports||eS.push(new ne(ec,e_,'use of "text-field" requires a style "glyphs" property')),"text-font"===ew&&Oi(oe(e_))&&"identity"===ae(e_.type)&&eS.push(new ne(ec,e_,'"text-font" does not support identity functions'));else if("model"===en.layerType&&"paint"===el&&ef&&ef.layout&&ef.layout.hasOwnProperty("model-id")&&Ci(eE)&&(Ri(eE)||Li(eE))){let en=Hi(oe(e_),eE),el=en.value.expression||en.value._styleExpression.expression;el&&!dn(el,["measure-light"])&&("model-emissive-strength"===ew&&hn(el)&&pn(el)||eS.push(new ne(ec,e_,`${ew} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return eS.concat(Ls({key:en.key,value:e_,valueSpec:eE,style:ed,styleSpec:em,expressionContext:"property",propertyType:el,propertyKey:ew}))}function Ms(en){return ws(en,"paint")}function As(en){return ws(en,"layout")}function Ss(en){let el=[],eu=en.value,ec=en.key,ed=en.style,ef=en.styleSpec;eu.type||eu.ref||el.push(new ne(ec,eu,'either "type" or "ref" is required'));let em=ae(eu.type),e_=ae(eu.ref);if(eu.id){let ef=ae(eu.id);for(let em=0;em<en.arrayIndex;em++){let en=ed.layers[em];ae(en.id)===ef&&el.push(new ne(ec,eu.id,`duplicate layer id "${eu.id}", previously used at line ${en.id.__line__}`))}}if("ref"in eu){let en;["type","source","source-layer","filter","layout"].forEach(en=>{en in eu&&el.push(new ne(ec,eu[en],`"${en}" is prohibited for ref layers`))}),ed.layers.forEach(el=>{ae(el.id)===e_&&(en=el)}),en?en.ref?el.push(new ne(ec,eu.ref,"ref cannot reference another ref layer")):em=ae(en.type):"string"==typeof e_&&el.push(new ne(ec,eu.ref,`ref layer "${e_}" not found`))}else if("background"!==em&&"sky"!==em&&"slot"!==em){if(eu.source){let en=ed.sources&&ed.sources[eu.source],ef=en&&ae(en.type);en?"vector"===ef&&"raster"===em?el.push(new ne(ec,eu.source,`layer "${eu.id}" requires a raster source`)):"raster"===ef&&"raster"!==em?el.push(new ne(ec,eu.source,`layer "${eu.id}" requires a vector source`)):"vector"!==ef||eu["source-layer"]?"raster-dem"===ef&&"hillshade"!==em?el.push(new ne(ec,eu.source,"raster-dem source can only be used with layer type 'hillshade'.")):"line"===em&&eu.paint&&(eu.paint["line-gradient"]||eu.paint["line-trim-offset"])&&("geojson"!==ef||!en.lineMetrics)&&el.push(new ne(ec,eu,`layer "${eu.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):el.push(new ne(ec,eu,`layer "${eu.id}" must specify a "source-layer"`)):el.push(new ne(ec,eu.source,`source "${eu.source}" not found`))}else el.push(new ne(ec,eu,'missing required property "source"'))}return el=el.concat(ts({key:ec,value:eu,valueSpec:ef.layer,style:en.style,styleSpec:en.styleSpec,objectElementValidators:{"*":()=>[],type:()=>Ls({key:`${ec}.type`,value:eu.type,valueSpec:ef.layer.type,style:en.style,styleSpec:en.styleSpec,object:eu,objectKey:"type"}),filter:en=>bs(se({layerType:em},en)),layout:en=>ts({layer:eu,key:en.key,value:en.value,valueSpec:{},style:en.style,styleSpec:en.styleSpec,objectElementValidators:{"*":en=>As(se({layerType:em},en))}}),paint:en=>ts({layer:eu,key:en.key,value:en.value,valueSpec:{},style:en.style,styleSpec:en.styleSpec,objectElementValidators:{"*":en=>Ms(se({layerType:em,layer:eu},en))}})}}))}function Is(en){let el=en.value,eu=en.key,ec=Je(el);return"string"!==ec?[new ne(eu,el,`string expected, ${ec} found`)]:[]}let t7={promoteId:function({key:en,value:el}){if("string"===Je(el))return Is({key:en,value:el});{let eu=[];for(let ec in el)eu.push(...Is({key:`${en}.${ec}`,value:el[ec]}));return eu}}};function Ts(en){let el=en.value,eu=en.key,ec=en.styleSpec,ed=en.style;if(!el.type)return[new ne(eu,el,'"type" is required')];let ef=ae(el.type),em=[];switch(["vector","raster","raster-dem"].includes(ef)&&(el.url||el.tiles||em.push(new ie(eu,el,'Either "url" or "tiles" is required.'))),ef){case"vector":case"raster":case"raster-dem":return em.concat(ts({key:eu,value:el,valueSpec:ec[`source_${ef.replace("-","_")}`],style:en.style,styleSpec:ec,objectElementValidators:t7}));case"geojson":if(em=ts({key:eu,value:el,valueSpec:ec.source_geojson,style:ed,styleSpec:ec,objectElementValidators:t7}),el.cluster)for(let en in el.clusterProperties){let[ec,ed]=el.clusterProperties[en],ef="string"==typeof ec?[ec,["accumulated"],["get",en]]:ec;em.push(...is({key:`${eu}.${en}.map`,value:ed,expressionContext:"cluster-map"})),em.push(...is({key:`${eu}.${en}.reduce`,value:ef,expressionContext:"cluster-reduce"}))}return em;case"video":return ts({key:eu,value:el,valueSpec:ec.source_video,style:ed,styleSpec:ec});case"image":return ts({key:eu,value:el,valueSpec:ec.source_image,style:ed,styleSpec:ec});case"canvas":return[new ne(eu,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return as({key:`${eu}.type`,value:el.type,valueSpec:{values:ec.source.reduce((en,el)=>{let eu=ec[el];return"enum"===eu.type.type&&(en=en.concat(Object.keys(eu.type.values))),en},[])},style:ed,styleSpec:ec})}}function zs(en){let el=en.value,eu=[];if(!el)return eu;let ec=Je(el);return"string"!==ec?eu=eu.concat([new ne(en.key,el,`string expected, "${ec}" found`)]):(function(en){let el=-1===en.indexOf("://");try{return new URL(en,el?"http://example.com":void 0),!0}catch(en){return!1}}(el)||(eu=eu.concat([new ne(en.key,el,`invalid url "${el}"`)])),eu)}function Es(en){let el=en.value,eu=en.styleSpec,ec=eu.light,ed=en.style,ef=[],em=Je(el);if(void 0===el)return ef;if("object"!==em)return ef.concat([new ne("light",el,`object expected, ${em} found`)]);for(let en in el){let em=en.match(/^(.*)-transition$/);ef=ef.concat(em&&ec[em[1]]&&ec[em[1]].transition?Ls({key:en,value:el[en],valueSpec:eu.transition,style:ed,styleSpec:eu}):ec[en]?Ls({key:en,value:el[en],valueSpec:ec[en],style:ed,styleSpec:eu}):[new ne(en,el[en],`unknown property "${en}"`)])}return ef}function Bs(en){let el=en.value,eu=[];if(!el)return eu;let ec=Je(el);if("object"!==ec)return eu.concat([new ne("light-3d",el,`object expected, ${ec} found`)]);let ed=en.styleSpec,ef=ed["light-3d"],em=en.key,e_=en.style,ew=en.style.lights;for(let en of["type","id"])if(!(en in el))return eu.concat([new ne("light-3d",el,`missing property ${en} on light`)]);if(el.type&&ew)for(let ec=0;ec<en.arrayIndex;ec++){let en=ae(el.type),ed=ew[ec];ae(ed.type)===en&&eu.push(new ne(em,el.id,`duplicate light type "${el.type}", previously defined at line ${ed.id.__line__}`))}let eT=`properties_light_${el.type}`;if(!(eT in ed))return eu.concat([new ne("light-3d",el,`Invalid light type ${el.type}`)]);let eM=ed[eT];for(let ec in el)if("properties"===ec){let ef=el[ec],em=Je(ef);if("object"!==em)return eu.concat([new ne("properties",ef,`object expected, ${em} found`)]);for(let el in ef)eu=eu.concat(eM[el]?Ls({key:el,value:ef[el],valueSpec:eM[el],style:e_,styleSpec:ed}):[new ie(en.key,ef[el],`unknown property "${el}"`)])}else{let en=ec.match(/^(.*)-transition$/);eu=eu.concat(en&&ef[en[1]]&&ef[en[1]].transition?Ls({key:ec,value:el[ec],valueSpec:ed.transition,style:e_,styleSpec:ed}):ef[ec]?Ls({key:ec,value:el[ec],valueSpec:ef[ec],style:e_,styleSpec:ed}):[new ie(ec,el[ec],`unknown property "${ec}"`)])}return eu}function Ds(en){let el=en.value,eu=en.key,ec=en.style,ed=en.styleSpec,ef=ed.terrain,em=[],e_=Je(el);if(void 0===el||"null"===e_)return em;if("object"!==e_)return em.concat([new ne("terrain",el,`object expected, ${e_} found`)]);for(let en in el){let eu=en.match(/^(.*)-transition$/);em=em.concat(eu&&ef[eu[1]]&&ef[eu[1]].transition?Ls({key:en,value:el[en],valueSpec:ed.transition,style:ec,styleSpec:ed}):ef[en]?Ls({key:en,value:el[en],valueSpec:ef[en],style:ec,styleSpec:ed}):[new ie(en,el[en],`unknown property "${en}"`)])}if(el.source){let en=ec.sources&&ec.sources[el.source],ed=en&&ae(en.type);en?"raster-dem"!==ed&&em.push(new ne(eu,el.source,`terrain cannot be used with a source of type ${String(ed)}, it only be used with a "raster-dem" source type`)):em.push(new ne(eu,el.source,`source "${el.source}" not found`))}else em.push(new ne(eu,el,'terrain is missing required property "source"'));return em}function Cs(en){let el=en.value,eu=en.style,ec=en.styleSpec,ed=ec.fog,ef=[],em=Je(el);if(void 0===el)return ef;if("object"!==em)return ef.concat([new ne("fog",el,`object expected, ${em} found`)]);for(let en in el){let em=en.match(/^(.*)-transition$/);ef=ef.concat(em&&ed[em[1]]&&ed[em[1]].transition?Ls({key:en,value:el[en],valueSpec:ec.transition,style:eu,styleSpec:ec}):ed[en]?Ls({key:en,value:el[en],valueSpec:ed[en],style:eu,styleSpec:ec}):[new ie(en,el[en],`unknown property "${en}"`)])}return ef}let t9={"*":()=>[],array:es,boolean:function(en){let el=en.value,eu=en.key,ec=Je(el);return"boolean"!==ec?[new ne(eu,el,`boolean expected, ${ec} found`)]:[]},number:rs,color:function(en){let el=en.key,eu=en.value,ec=Je(eu);return"string"!==ec?[new ne(el,eu,`color expected, ${ec} found`)]:null===tP(eu)?[new ne(el,eu,`color expected, "${eu}" found`)]:[]},enum:as,filter:bs,function:ns,layer:Ss,object:ts,source:Ts,model:zs,light:Es,"light-3d":Bs,terrain:Ds,fog:Cs,string:Is,formatted:function(en){return 0===Is(en).length?[]:is(en)},resolvedImage:function(en){return 0===Is(en).length?[]:is(en)},projection:function(en){let el=en.value,eu=en.styleSpec,ec=eu.projection,ed=en.style,ef=[],em=Je(el);if("object"===em)for(let en in el)ef=ef.concat(Ls({key:en,value:el[en],valueSpec:ec[en],style:ed,styleSpec:eu}));else"string"!==em&&(ef=ef.concat([new ne("projection",el,`object or string expected, ${em} found`)]));return ef},import:function(en){let{value:el,styleSpec:eu}=en,{data:ec,...ed}=el;Object.defineProperty(ed,"__line__",{value:el.__line__,enumerable:!1});let ef=ts(se({},en,{value:ed,valueSpec:eu.import}));return""===ae(ed.id)&&ef.push(new ne(`${en.key}.id`,ed,"import id can't be an empty string")),ec&&(ef=ef.concat(Os(ec,eu,{key:`${en.key}.data`}))),ef}};function Ls(en,el=!1){let eu=en.value,ec=en.valueSpec,ed=en.styleSpec;if(ec.expression&&Oi(ae(eu)))return ns(en);if(ec.expression&&Zi(oe(eu)))return is(en);if(ec.type&&t9[ec.type]){let eu=t9[ec.type](en);return!0===el&&eu.length>0&&"array"===Je(en.value)?is(en):eu}return ts(se({},en,{valueSpec:ec.type?ed[ec.type]:ec}))}function Vs(en){let el=en.value,eu=en.key,ec=Is(en);return ec.length||(-1===el.indexOf("{fontstack}")&&ec.push(new ne(eu,el,'"glyphs" url must include a "{fontstack}" token')),-1===el.indexOf("{range}")&&ec.push(new ne(eu,el,'"glyphs" url must include a "{range}" token'))),ec}function Os(en,el=tc,eu={}){return Ls({key:eu.key||"",value:en,valueSpec:el.$root,styleSpec:el,style:en,objectElementValidators:{glyphs:Vs,"*":()=>[]}})}function Fs(en,el=tc){return Ns(Os(en,el))}let js=en=>Ns(Ms(en)),Us=en=>Ns(As(en));function Ns(en){return en.slice().sort((en,el)=>en.line&&el.line?en.line-el.line:0)}function $s(en,el){let eu=!1;if(el&&el.length)for(let ec of el)ec instanceof ie?q(ec.message):(en.fire(new te(Error(ec.message))),eu=!0);return eu}function Ys(en,el,eu){var ec=this.cells=[];if(en instanceof ArrayBuffer){this.arrayBuffer=en;var ed=new Int32Array(this.arrayBuffer);en=ed[0],this.d=(el=ed[1])+2*(eu=ed[2]);for(var ef=0;ef<this.d*this.d;ef++){var em=ed[3+ef],e_=ed[3+ef+1];ec.push(em===e_?null:ed.subarray(em,e_))}var ew=ed[3+ec.length+1];this.keys=ed.subarray(ed[3+ec.length],ew),this.bboxes=ed.subarray(ew),this.insert=this._insertReadonly}else{this.d=el+2*eu;for(var eT=0;eT<this.d*this.d;eT++)ec.push([]);this.keys=[],this.bboxes=[]}this.n=el,this.extent=en,this.padding=eu,this.scale=el/en,this.uid=0;var eM=eu/el*en;this.min=-eM,this.max=en+eM}Ys.prototype.insert=function(en,el,eu,ec,ed){this._forEachCell(el,eu,ec,ed,this._insertCell,this.uid++),this.keys.push(en),this.bboxes.push(el),this.bboxes.push(eu),this.bboxes.push(ec),this.bboxes.push(ed)},Ys.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},Ys.prototype._insertCell=function(en,el,eu,ec,ed,ef){this.cells[ed].push(ef)},Ys.prototype.query=function(en,el,eu,ec,ed){var ef=this.min,em=this.max;if(en<=ef&&el<=ef&&em<=eu&&em<=ec&&!ed)return Array.prototype.slice.call(this.keys);var e_=[];return this._forEachCell(en,el,eu,ec,this._queryCell,e_,{},ed),e_},Ys.prototype._queryCell=function(en,el,eu,ec,ed,ef,em,e_){var ew=this.cells[ed];if(null!==ew)for(var eT=this.keys,eM=this.bboxes,eE=0;eE<ew.length;eE++){var eS=ew[eE];if(void 0===em[eS]){var eA=4*eS;(e_?e_(eM[eA+0],eM[eA+1],eM[eA+2],eM[eA+3]):en<=eM[eA+2]&&el<=eM[eA+3]&&eu>=eM[eA+0]&&ec>=eM[eA+1])?(em[eS]=!0,ef.push(eT[eS])):em[eS]=!1}}},Ys.prototype._forEachCell=function(en,el,eu,ec,ed,ef,em,e_){for(var ew=this._convertToCellCoord(en),eT=this._convertToCellCoord(el),eM=this._convertToCellCoord(eu),eE=this._convertToCellCoord(ec),eS=ew;eS<=eM;eS++)for(var eA=eT;eA<=eE;eA++){var eI=this.d*eA+eS;if((!e_||e_(this._convertFromCellCoord(eS),this._convertFromCellCoord(eA),this._convertFromCellCoord(eS+1),this._convertFromCellCoord(eA+1)))&&ed.call(this,en,el,eu,ec,eI,ef,em,e_))return}},Ys.prototype._convertFromCellCoord=function(en){return(en-this.padding)/this.scale},Ys.prototype._convertToCellCoord=function(en){return Math.max(0,Math.min(this.d-1,Math.floor(en*this.scale)+this.padding))},Ys.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var en=this.cells,el=3+this.cells.length+1+1,eu=0,ec=0;ec<this.cells.length;ec++)eu+=this.cells[ec].length;var ed=new Int32Array(el+eu+this.keys.length+this.bboxes.length);ed[0]=this.extent,ed[1]=this.n,ed[2]=this.padding;for(var ef=el,em=0;em<en.length;em++){var e_=en[em];ed[3+em]=ef,ed.set(e_,ef),ef+=e_.length}return ed[3+en.length]=ef,ed.set(this.keys,ef),ed[3+en.length+1]=ef+=this.keys.length,ed.set(this.bboxes,ef),ef+=this.bboxes.length,ed.buffer};var ii=p(Ys);let il={};function Ks(en,el,eu={}){Object.defineProperty(en,"_classRegistryKey",{value:el,writeable:!1}),il[el]={klass:en,omit:eu.omit||[]}}for(let en in Ks(Object,"Object"),ii.serialize=function(en,el){let eu=en.toArrayBuffer();return el&&el.add(eu),{buffer:eu}},ii.deserialize=function(en){return new ii(en.buffer)},Object.defineProperty(ii,"name",{value:"Grid"}),Ks(ii,"Grid"),Ks(Ce,"Color"),Ks(Error,"Error"),Ks(Oe,"Formatted"),Ks(Ve,"FormattedSection"),Ks(ht,"AJAXError"),Ks(Fe,"ResolvedImage"),Ks(Ji,"StylePropertyFunction"),Ks(Yi,"StyleExpression",{omit:["_evaluator"]}),Ks(Wi,"ZoomDependentExpression"),Ks(Ki,"ZoomConstantExpression"),Ks(ir,"CompoundExpression",{omit:["_evaluate"]}),t6)il[t6[en]._classRegistryKey]||Ks(t6[en],`Expression${en}`);function Ws(en){return en&&"undefined"!=typeof ArrayBuffer&&(en instanceof ArrayBuffer||en.constructor&&"ArrayBuffer"===en.constructor.name)}function Hs(en){return self.ImageBitmap&&en instanceof ImageBitmap}function Js(en,el){if(null==en||"boolean"==typeof en||"number"==typeof en||"string"==typeof en||en instanceof Boolean||en instanceof Number||en instanceof String||en instanceof Date||en instanceof RegExp)return en;if(Ws(en)||Hs(en))return el&&el.add(en),en;if(ArrayBuffer.isView(en))return el&&el.add(en.buffer),en;if(en instanceof ImageData)return el&&el.add(en.data.buffer),en;if(Array.isArray(en)){let eu=[];for(let ec of en)eu.push(Js(ec,el));return eu}if(en instanceof Map){let el={$name:"Map"};for(let[eu,ec]of en.entries())el[eu]=Js(ec);return el}if("object"==typeof en){let eu=en.constructor,ec=eu._classRegistryKey;if(!ec)throw Error(`can't serialize object of unregistered class ${ec}`);let ed=eu.serialize?eu.serialize(en,el):{};if(!eu.serialize){for(let eu in en)en.hasOwnProperty(eu)&&(il[ec].omit.indexOf(eu)>=0||(ed[eu]=Js(en[eu],el)));en instanceof Error&&(ed.message=en.message)}if(ed.$name)throw Error("$name property is reserved for worker serialization logic.");return"Object"!==ec&&(ed.$name=ec),ed}throw Error("can't serialize object of type "+typeof en)}function Qs(en){if(null==en||"boolean"==typeof en||"number"==typeof en||"string"==typeof en||en instanceof Boolean||en instanceof Number||en instanceof String||en instanceof Date||en instanceof RegExp||Ws(en)||Hs(en)||ArrayBuffer.isView(en)||en instanceof ImageData)return en;if(Array.isArray(en))return en.map(Qs);if("object"==typeof en){let el=en.$name||"Object";if("Map"===el){let el=new Map;for(let eu of Object.keys(en))"$name"!==eu&&el.set(eu,Qs(en[eu]));return el}let{klass:eu}=il[el];if(!eu)throw Error(`can't deserialize unregistered class ${el}`);if(eu.deserialize)return eu.deserialize(en);let ec=Object.create(eu.prototype);for(let el of Object.keys(en))"$name"!==el&&(ec[el]=Qs(en[el]));return ec}throw Error("can't deserialize object of type "+typeof en)}let iu={"Latin-1 Supplement":en=>en>=128&&en<=255,Arabic:en=>en>=1536&&en<=1791,"Arabic Supplement":en=>en>=1872&&en<=1919,"Arabic Extended-A":en=>en>=2208&&en<=2303,"Hangul Jamo":en=>en>=4352&&en<=4607,"Unified Canadian Aboriginal Syllabics":en=>en>=5120&&en<=5759,Khmer:en=>en>=6016&&en<=6143,"Unified Canadian Aboriginal Syllabics Extended":en=>en>=6320&&en<=6399,"General Punctuation":en=>en>=8192&&en<=8303,"Letterlike Symbols":en=>en>=8448&&en<=8527,"Number Forms":en=>en>=8528&&en<=8591,"Miscellaneous Technical":en=>en>=8960&&en<=9215,"Control Pictures":en=>en>=9216&&en<=9279,"Optical Character Recognition":en=>en>=9280&&en<=9311,"Enclosed Alphanumerics":en=>en>=9312&&en<=9471,"Geometric Shapes":en=>en>=9632&&en<=9727,"Miscellaneous Symbols":en=>en>=9728&&en<=9983,"Miscellaneous Symbols and Arrows":en=>en>=11008&&en<=11263,"CJK Radicals Supplement":en=>en>=11904&&en<=12031,"Kangxi Radicals":en=>en>=12032&&en<=12255,"Ideographic Description Characters":en=>en>=12272&&en<=12287,"CJK Symbols and Punctuation":en=>en>=12288&&en<=12351,Hiragana:en=>en>=12352&&en<=12447,Katakana:en=>en>=12448&&en<=12543,Bopomofo:en=>en>=12544&&en<=12591,"Hangul Compatibility Jamo":en=>en>=12592&&en<=12687,Kanbun:en=>en>=12688&&en<=12703,"Bopomofo Extended":en=>en>=12704&&en<=12735,"CJK Strokes":en=>en>=12736&&en<=12783,"Katakana Phonetic Extensions":en=>en>=12784&&en<=12799,"Enclosed CJK Letters and Months":en=>en>=12800&&en<=13055,"CJK Compatibility":en=>en>=13056&&en<=13311,"CJK Unified Ideographs Extension A":en=>en>=13312&&en<=19903,"Yijing Hexagram Symbols":en=>en>=19904&&en<=19967,"CJK Unified Ideographs":en=>en>=19968&&en<=40959,"Yi Syllables":en=>en>=40960&&en<=42127,"Yi Radicals":en=>en>=42128&&en<=42191,"Hangul Jamo Extended-A":en=>en>=43360&&en<=43391,"Hangul Syllables":en=>en>=44032&&en<=55215,"Hangul Jamo Extended-B":en=>en>=55216&&en<=55295,"Private Use Area":en=>en>=57344&&en<=63743,"CJK Compatibility Ideographs":en=>en>=63744&&en<=64255,"Arabic Presentation Forms-A":en=>en>=64336&&en<=65023,"Vertical Forms":en=>en>=65040&&en<=65055,"CJK Compatibility Forms":en=>en>=65072&&en<=65103,"Small Form Variants":en=>en>=65104&&en<=65135,"Arabic Presentation Forms-B":en=>en>=65136&&en<=65279,"Halfwidth and Fullwidth Forms":en=>en>=65280&&en<=65519,"CJK Unified Ideographs Extension B":en=>en>=131072&&en<=173791};function ea(en){for(let el of en)if(ia(el.charCodeAt(0)))return!0;return!1}function ia(en){return!(746!==en&&747!==en&&(en<4352||!(iu["Bopomofo Extended"](en)||iu.Bopomofo(en)||iu["CJK Compatibility Forms"](en)&&!(en>=65097&&en<=65103)||iu["CJK Compatibility Ideographs"](en)||iu["CJK Compatibility"](en)||iu["CJK Radicals Supplement"](en)||iu["CJK Strokes"](en)||!(!iu["CJK Symbols and Punctuation"](en)||en>=12296&&en<=12305||en>=12308&&en<=12319||12336===en)||iu["CJK Unified Ideographs Extension A"](en)||iu["CJK Unified Ideographs"](en)||iu["Enclosed CJK Letters and Months"](en)||iu["Hangul Compatibility Jamo"](en)||iu["Hangul Jamo Extended-A"](en)||iu["Hangul Jamo Extended-B"](en)||iu["Hangul Jamo"](en)||iu["Hangul Syllables"](en)||iu.Hiragana(en)||iu["Ideographic Description Characters"](en)||iu.Kanbun(en)||iu["Kangxi Radicals"](en)||iu["Katakana Phonetic Extensions"](en)||iu.Katakana(en)&&12540!==en||!(!iu["Halfwidth and Fullwidth Forms"](en)||65288===en||65289===en||65293===en||en>=65306&&en<=65310||65339===en||65341===en||65343===en||en>=65371&&en<=65503||65507===en||en>=65512&&en<=65519)||!(!iu["Small Form Variants"](en)||en>=65112&&en<=65118||en>=65123&&en<=65126)||iu["Unified Canadian Aboriginal Syllabics"](en)||iu["Unified Canadian Aboriginal Syllabics Extended"](en)||iu["Vertical Forms"](en)||iu["Yijing Hexagram Symbols"](en)||iu["Yi Syllables"](en)||iu["Yi Radicals"](en))))}function sa(en){return!(ia(en)||iu["Latin-1 Supplement"](en)&&(167===en||169===en||174===en||177===en||188===en||189===en||190===en||215===en||247===en)||iu["General Punctuation"](en)&&(8214===en||8224===en||8225===en||8240===en||8241===en||8251===en||8252===en||8258===en||8263===en||8264===en||8265===en||8273===en)||iu["Letterlike Symbols"](en)||iu["Number Forms"](en)||iu["Miscellaneous Technical"](en)&&(en>=8960&&en<=8967||en>=8972&&en<=8991||en>=8996&&en<=9e3||9003===en||en>=9085&&en<=9114||en>=9150&&en<=9165||9167===en||en>=9169&&en<=9179||en>=9186&&en<=9215)||iu["Control Pictures"](en)&&9251!==en||iu["Optical Character Recognition"](en)||iu["Enclosed Alphanumerics"](en)||iu["Geometric Shapes"](en)||iu["Miscellaneous Symbols"](en)&&!(en>=9754&&en<=9759)||iu["Miscellaneous Symbols and Arrows"](en)&&(en>=11026&&en<=11055||en>=11088&&en<=11097||en>=11192&&en<=11243)||iu["CJK Symbols and Punctuation"](en)||iu.Katakana(en)||iu["Private Use Area"](en)||iu["CJK Compatibility Forms"](en)||iu["Small Form Variants"](en)||iu["Halfwidth and Fullwidth Forms"](en)||8734===en||8756===en||8757===en||en>=9984&&en<=10087||en>=10102&&en<=10131||65532===en||65533===en)}function aa(en){return en>=1424&&en<=2303||iu["Arabic Presentation Forms-A"](en)||iu["Arabic Presentation Forms-B"](en)}let ic="deferred",im="loading",i_="loaded",ig=null,ib="unavailable",iw=null,ma=function(en){en&&"string"==typeof en&&en.indexOf("NetworkError")>-1&&(ib="error"),ig&&ig(en)};function ya(){iT.fire(new Qt("pluginStateChange",{pluginStatus:ib,pluginURL:iw}))}let iT=new ee,xa=function(){return ib},va=function(){if(ib!==ic||!iw)throw Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");ib=im,ya(),iw&&dt({url:iw},en=>{en?ma(en):(ib=i_,ya())})},iM={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>ib===i_||null!=iM.applyArabicShaping,isLoading:()=>ib===im,setState(en){ib=en.pluginStatus,iw=en.pluginURL},isParsed:()=>null!=iM.applyArabicShaping&&null!=iM.processBidirectionalText&&null!=iM.processStyledBidirectionalText,getPluginURL:()=>iw};let _a=class _a{constructor(en,el){this.zoom=en,el?(this.now=el.now,this.fadeDuration=el.fadeDuration,this.transition=el.transition,this.pitch=el.pitch,this.brightness=el.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(en){return function(en,el){for(let ec of en){var eu;if(eu=ec.charCodeAt(0),!el&&aa(eu)||eu>=2304&&eu<=3583||eu>=3840&&eu<=4255||iu.Khmer(eu))return!1}return!0}(en,iM.isLoaded())}};let wa=class wa{constructor(en,el,eu,ec){this.property=en,this.value=el,this.expression=function(en,el,eu,ec){if(Oi(en))return new Ji(en,el);if(Zi(en)||Array.isArray(en)&&en.length>0){let ed=Hi(en,el,eu,ec);if("error"===ed.result)throw Error(ed.value.map(en=>`${en.key}: ${en.message}`).join(", "));return ed.value}{let eu=en;return"string"==typeof en&&"color"===el.type&&(eu=Ce.parse(en)),{kind:"constant",isConfigDependent:!1,evaluate:()=>eu}}}(void 0===el?en.specification.default:el,en.specification,eu,ec)}isDataDriven(){return"source"===this.expression.kind||"composite"===this.expression.kind}possiblyEvaluate(en,el,eu){return this.property.possiblyEvaluate(this,en,el,eu)}};let Ma=class Ma{constructor(en,el,eu){this.property=en,this.value=new wa(en,void 0,el,eu)}transitioned(en,el){return new Sa(this.property,this.value,el,B({},en.transition,this.transition),en.now)}untransitioned(){return new Sa(this.property,this.value,null,{},0)}};let Aa=class Aa{constructor(en,el,eu){this._properties=en,this._values=Object.create(en.defaultTransitionablePropertyValues),this._scope=el,this._options=eu,this.isConfigDependent=!1}getValue(en){return N(this._values[en].value.value)}setValue(en,el){this._values.hasOwnProperty(en)||(this._values[en]=new Ma(this._values[en].property,this._scope,this._options)),this._values[en].value=new wa(this._values[en].property,null===el?void 0:N(el),this._scope,this._options),this.isConfigDependent=this.isConfigDependent||this._values[en].value.expression.isConfigDependent}setTransitionOrValue(en,el){el&&(this._options=el);let eu=this._properties.properties;if(en)for(let el in en){let ec=en[el];if(F(el,"-transition")){let en=el.slice(0,-11);eu[en]&&this.setTransition(en,ec)}else eu[el]&&this.setValue(el,ec)}}getTransition(en){return N(this._values[en].transition)}setTransition(en,el){this._values.hasOwnProperty(en)||(this._values[en]=new Ma(this._values[en].property)),this._values[en].transition=N(el)||void 0}serialize(){let en={};for(let el of Object.keys(this._values)){let eu=this.getValue(el);void 0!==eu&&(en[el]=eu);let ec=this.getTransition(el);void 0!==ec&&(en[`${el}-transition`]=ec)}return en}transitioned(en,el){let eu=new Ia(this._properties);for(let ec of Object.keys(this._values))eu._values[ec]=this._values[ec].transitioned(en,el._values[ec]);return eu}untransitioned(){let en=new Ia(this._properties);for(let el of Object.keys(this._values))en._values[el]=this._values[el].untransitioned();return en}};let Sa=class Sa{constructor(en,el,eu,ec,ed){let ef=ec.delay||0,em=ec.duration||0;ed=ed||0,this.property=en,this.value=el,this.begin=ed+ef,this.end=this.begin+em,en.specification.transition&&(ec.delay||ec.duration)&&(this.prior=eu)}possiblyEvaluate(en,el,eu){let ec=en.now||0,ed=this.value.possiblyEvaluate(en,el,eu),ef=this.prior;if(ef){if(ec>this.end||this.value.isDataDriven())return this.prior=null,ed;if(ec<this.begin)return ef.possiblyEvaluate(en,el,eu);{let em=(ec-this.begin)/(this.end-this.begin);return this.property.interpolate(ef.possiblyEvaluate(en,el,eu),ed,A(em))}}return ed}};let Ia=class Ia{constructor(en){this._properties=en,this._values=Object.create(en.defaultTransitioningPropertyValues)}possiblyEvaluate(en,el,eu){let ec=new Pa(this._properties);for(let ed of Object.keys(this._values))ec._values[ed]=this._values[ed].possiblyEvaluate(en,el,eu);return ec}hasTransition(){for(let en of Object.keys(this._values))if(this._values[en].prior)return!0;return!1}};let ka=class ka{constructor(en,el,eu){this._properties=en,this._values=Object.create(en.defaultPropertyValues),this._scope=el,this._options=eu,this.isConfigDependent=!1}getValue(en){return N(this._values[en].value)}setValue(en,el){this._values[en]=new wa(this._values[en].property,null===el?void 0:N(el),this._scope,this._options),this.isConfigDependent=this.isConfigDependent||this._values[en].expression.isConfigDependent}serialize(){let en={};for(let el of Object.keys(this._values)){let eu=this.getValue(el);void 0!==eu&&(en[el]=eu)}return en}possiblyEvaluate(en,el,eu){let ec=new Pa(this._properties);for(let ed of Object.keys(this._values))ec._values[ed]=this._values[ed].possiblyEvaluate(en,el,eu);return ec}};let Ta=class Ta{constructor(en,el,eu){this.property=en,this.value=el,this.parameters=eu}isConstant(){return"constant"===this.value.kind}constantOr(en){return"constant"===this.value.kind?this.value.value:en}evaluate(en,el,eu,ec){return this.property.evaluate(this.value,this.parameters,en,el,eu,ec)}};let Pa=class Pa{constructor(en){this._properties=en,this._values=Object.create(en.defaultPossiblyEvaluatedValues)}get(en){return this._values[en]}};let za=class za{constructor(en){this.specification=en}possiblyEvaluate(en,el){return en.expression.evaluate(el)}interpolate(en,el,eu){let ec=tq[this.specification.type];return ec?ec(en,el,eu):en}};let Ea=class Ea{constructor(en,el){this.specification=en,this.overrides=el}possiblyEvaluate(en,el,eu,ec){return new Ta(this,"constant"===en.expression.kind||"camera"===en.expression.kind?{kind:"constant",value:en.expression.evaluate(el,null,{},eu,ec)}:en.expression,el)}interpolate(en,el,eu){if("constant"!==en.value.kind||"constant"!==el.value.kind)return en;if(void 0===en.value.value||void 0===el.value.value)return new Ta(this,{kind:"constant",value:void 0},en.parameters);let ec=tq[this.specification.type];return ec?new Ta(this,{kind:"constant",value:ec(en.value.value,el.value.value,eu)},en.parameters):en}evaluate(en,el,eu,ec,ed,ef){return"constant"===en.kind?en.value:en.evaluate(el,eu,ec,ed,ef)}};let Ba=class Ba{constructor(en){this.specification=en}possiblyEvaluate(en,el,eu,ec){return!!en.expression.evaluate(el,null,{},eu,ec)}interpolate(){return!1}};let Da=class Da{constructor(en){this.properties=en,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];let el=new _a(0,{});for(let eu in en){let ec=en[eu];ec.specification.overridable&&this.overridableProperties.push(eu);let ed=this.defaultPropertyValues[eu]=new wa(ec,void 0),ef=this.defaultTransitionablePropertyValues[eu]=new Ma(ec);this.defaultTransitioningPropertyValues[eu]=ef.untransitioned(),this.defaultPossiblyEvaluatedValues[eu]=ed.possiblyEvaluate(el)}}};function Ra(en,el){return el?`${en}${el}`:en}Ks(Ea,"DataDrivenProperty"),Ks(za,"DataConstantProperty"),Ks(Ba,"ColorRampProperty");let iE="-transition";let Va=class Va extends ee{constructor(en,el,eu,ec){if(super(),this.id=en.id,this.fqid=Ra(this.id,eu),this.type=en.type,this.scope=eu,this.options=ec,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.isConfigDependent=!1,"custom"!==en.type&&(this.metadata=en.metadata,this.minzoom=en.minzoom,this.maxzoom=en.maxzoom,"background"!==en.type&&"sky"!==en.type&&"slot"!==en.type&&(this.source=en.source,this.sourceLayer=en["source-layer"],this.filter=en.filter),en.slot&&(this.slot=en.slot),el.layout&&(this._unevaluatedLayout=new ka(el.layout,this.scope,ec),this.isConfigDependent=this.isConfigDependent||this._unevaluatedLayout.isConfigDependent),el.paint)){for(let eu in this._transitionablePaint=new Aa(el.paint,this.scope,ec),en.paint)this.setPaintProperty(eu,en.paint[eu],{validate:!1});for(let el in en.layout)this.setLayoutProperty(el,en.layout[el],{validate:!1});this.isConfigDependent=this.isConfigDependent||this._transitionablePaint.isConfigDependent,this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Pa(el.paint)}}getLayoutProperty(en){return"visibility"===en?this.visibility:this._unevaluatedLayout.getValue(en)}setLayoutProperty(en,el,eu={}){if(null!=el&&this._validate(Us,`layers.${this.id}.layout.${en}`,en,el,eu))return;if("custom"===this.type&&"visibility"===en)return void(this.visibility=el);let ec=this._unevaluatedLayout;ec._properties.properties[en]&&(ec.setValue(en,el),this.isConfigDependent=this.isConfigDependent||ec.isConfigDependent,"visibility"===en&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0})}getPaintProperty(en){return F(en,iE)?this._transitionablePaint.getTransition(en.slice(0,-11)):this._transitionablePaint.getValue(en)}setPaintProperty(en,el,eu={}){if(null!=el&&this._validate(js,`layers.${this.id}.paint.${en}`,en,el,eu))return!1;let ec=this._transitionablePaint,ed=ec._properties.properties;if(F(en,iE)){let eu=en.slice(0,-11);return ed[eu]&&ec.setTransition(eu,el||void 0),!1}if(!ed[en])return!1;let ef=ec._values[en],em=ef.value.isDataDriven(),e_=ef.value;ec.setValue(en,el),this.isConfigDependent=this.isConfigDependent||ec.isConfigDependent,this._handleSpecialPaintPropertyUpdate(en);let ew=ec._values[en].value,eT=ew.isDataDriven(),eM=F(en,"pattern")||"line-dasharray"===en;return eT||em||eM||this._handleOverridablePaintPropertyUpdate(en,e_,ew)}_handleSpecialPaintPropertyUpdate(en){}getProgramIds(){return null}getDefaultProgramParams(en,el){return null}_handleOverridablePaintPropertyUpdate(en,el,eu){return!1}isHidden(en){return!!(this.minzoom&&en<this.minzoom)||!!(this.maxzoom&&en>=this.maxzoom)||"none"===this.visibility}updateTransitions(en){this._transitioningPaint=this._transitionablePaint.transitioned(en,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(en,el){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(en,void 0,el)),this.paint=this._transitioningPaint.possiblyEvaluate(en,void 0,el)}serialize(){return U({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(en,el)=>!(void 0===en||"layout"===el&&!Object.keys(en).length||"paint"===el&&!Object.keys(en).length))}_validate(en,el,eu,ec,ed={}){return(!ed||!1!==ed.validate)&&$s(this,en.call(Fs,{key:el,layerType:this.type,objectKey:eu,value:ec,styleSpec:tc,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}resize(){}isStateDependent(){for(let en in this.paint._values){let el=this.paint.get(en);if(el instanceof Ta&&Ci(el.property.specification)&&("source"===el.value.kind||"composite"===el.value.kind)&&el.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=ls(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(){this._stats&&(this._stats.numRenderedVerticesInShadowPass=0,this._stats.numRenderedVerticesInTransparentPass=0)}};let iS={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};let Fa=class Fa{constructor(en,el){this._structArray=en,this._pos1=el*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}};let ja=class ja{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(en,el){return en._trim(),el&&(en.isTransferred=!0,el.add(en.arrayBuffer)),{length:en.length,arrayBuffer:en.arrayBuffer}}static deserialize(en){let el=Object.create(this.prototype);return el.arrayBuffer=en.arrayBuffer,el.length=en.length,el.capacity=en.arrayBuffer.byteLength/el.bytesPerElement,el._refreshViews(),el}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(en){this.reserve(en),this.length=en}reserve(en){if(en>this.capacity){this.capacity=Math.max(en,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);let el=this.uint8;this._refreshViews(),el&&this.uint8.set(el)}}_refreshViews(){throw Error("_refreshViews() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}};function Ua(en,el=1){let eu=0,ec=0;return{members:en.map(en=>{let ed=iS[en.type].BYTES_PER_ELEMENT,ef=eu=Na(eu,Math.max(el,ed)),em=en.components||1;return ec=Math.max(ec,ed),eu+=ed*em,{name:en.name,type:en.type,components:em,offset:ef}}),size:Na(eu,Math.max(ec,el)),alignment:el}}function Na(en,el){return Math.ceil(en/el)*el}let $a=class $a extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(en,el){let eu=this.length;return this.resize(eu+1),this.emplace(eu,en,el)}emplace(en,el,eu){let ec=2*en;return this.int16[ec+0]=el,this.int16[ec+1]=eu,en}};$a.prototype.bytesPerElement=4,Ks($a,"StructArrayLayout2i4");let qa=class qa extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(en,el,eu){let ec=this.length;return this.resize(ec+1),this.emplace(ec,en,el,eu)}emplace(en,el,eu,ec){let ed=3*en;return this.int16[ed+0]=el,this.int16[ed+1]=eu,this.int16[ed+2]=ec,en}};qa.prototype.bytesPerElement=6,Ks(qa,"StructArrayLayout3i6");let Ga=class Ga extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(en,el,eu,ec){let ed=this.length;return this.resize(ed+1),this.emplace(ed,en,el,eu,ec)}emplace(en,el,eu,ec,ed){let ef=4*en;return this.int16[ef+0]=el,this.int16[ef+1]=eu,this.int16[ef+2]=ec,this.int16[ef+3]=ed,en}};Ga.prototype.bytesPerElement=8,Ks(Ga,"StructArrayLayout4i8");let Ya=class Ya extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(en,el,eu,ec,ed){let ef=this.length;return this.resize(ef+1),this.emplace(ef,en,el,eu,ec,ed)}emplace(en,el,eu,ec,ed,ef){let em=5*en;return this.int16[em+0]=el,this.int16[em+1]=eu,this.int16[em+2]=ec,this.int16[em+3]=ed,this.int16[em+4]=ef,en}};Ya.prototype.bytesPerElement=10,Ks(Ya,"StructArrayLayout5i10");let Za=class Za extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(en,el,eu,ec,ed,ef,em){let e_=this.length;return this.resize(e_+1),this.emplace(e_,en,el,eu,ec,ed,ef,em)}emplace(en,el,eu,ec,ed,ef,em,e_){let ew=6*en,eT=12*en;return this.int16[ew+0]=el,this.int16[ew+1]=eu,this.uint8[eT+4]=ec,this.uint8[eT+5]=ed,this.uint8[eT+6]=ef,this.uint8[eT+7]=em,this.float32[3*en+2]=e_,en}};Za.prototype.bytesPerElement=12,Ks(Za,"StructArrayLayout2i4ub1f12");let Xa=class Xa extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(en,el,eu,ec){let ed=this.length;return this.resize(ed+1),this.emplace(ed,en,el,eu,ec)}emplace(en,el,eu,ec,ed){let ef=4*en;return this.float32[ef+0]=el,this.float32[ef+1]=eu,this.float32[ef+2]=ec,this.float32[ef+3]=ed,en}};Xa.prototype.bytesPerElement=16,Ks(Xa,"StructArrayLayout4f16");let Ka=class Ka extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(en,el,eu,ec,ed){let ef=this.length;return this.resize(ef+1),this.emplace(ef,en,el,eu,ec,ed)}emplace(en,el,eu,ec,ed,ef){let em=6*en;return this.uint16[em+0]=el,this.uint16[em+1]=eu,this.uint16[em+2]=ec,this.uint16[em+3]=ed,this.float32[3*en+2]=ef,en}};Ka.prototype.bytesPerElement=12,Ks(Ka,"StructArrayLayout4ui1f12");let Wa=class Wa extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(en,el,eu,ec){let ed=this.length;return this.resize(ed+1),this.emplace(ed,en,el,eu,ec)}emplace(en,el,eu,ec,ed){let ef=4*en;return this.uint16[ef+0]=el,this.uint16[ef+1]=eu,this.uint16[ef+2]=ec,this.uint16[ef+3]=ed,en}};Wa.prototype.bytesPerElement=8,Ks(Wa,"StructArrayLayout4ui8");let Ha=class Ha extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(en,el,eu,ec,ed,ef){let em=this.length;return this.resize(em+1),this.emplace(em,en,el,eu,ec,ed,ef)}emplace(en,el,eu,ec,ed,ef,em){let e_=6*en;return this.int16[e_+0]=el,this.int16[e_+1]=eu,this.int16[e_+2]=ec,this.int16[e_+3]=ed,this.int16[e_+4]=ef,this.int16[e_+5]=em,en}};Ha.prototype.bytesPerElement=12,Ks(Ha,"StructArrayLayout6i12");let Ja=class Ja extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE){let eS=this.length;return this.resize(eS+1),this.emplace(eS,en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE)}emplace(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS){let eA=12*en;return this.int16[eA+0]=el,this.int16[eA+1]=eu,this.int16[eA+2]=ec,this.int16[eA+3]=ed,this.uint16[eA+4]=ef,this.uint16[eA+5]=em,this.uint16[eA+6]=e_,this.uint16[eA+7]=ew,this.int16[eA+8]=eT,this.int16[eA+9]=eM,this.int16[eA+10]=eE,this.int16[eA+11]=eS,en}};Ja.prototype.bytesPerElement=24,Ks(Ja,"StructArrayLayout4i4ui4i24");let Qa=class Qa extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(en,el,eu,ec,ed,ef){let em=this.length;return this.resize(em+1),this.emplace(em,en,el,eu,ec,ed,ef)}emplace(en,el,eu,ec,ed,ef,em){let e_=10*en,ew=5*en;return this.int16[e_+0]=el,this.int16[e_+1]=eu,this.int16[e_+2]=ec,this.float32[ew+2]=ed,this.float32[ew+3]=ef,this.float32[ew+4]=em,en}};Qa.prototype.bytesPerElement=20,Ks(Qa,"StructArrayLayout3i3f20");let to=class to extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(en){let el=this.length;return this.resize(el+1),this.emplace(el,en)}emplace(en,el){return this.uint32[1*en+0]=el,en}};to.prototype.bytesPerElement=4,Ks(to,"StructArrayLayout1ul4");let eo=class eo extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(en,el){let eu=this.length;return this.resize(eu+1),this.emplace(eu,en,el)}emplace(en,el,eu){let ec=2*en;return this.uint16[ec+0]=el,this.uint16[ec+1]=eu,en}};eo.prototype.bytesPerElement=4,Ks(eo,"StructArrayLayout2ui4");let ro=class ro extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS){let eA=this.length;return this.resize(eA+1),this.emplace(eA,en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS)}emplace(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA){let eI=20*en,eC=10*en;return this.int16[eI+0]=el,this.int16[eI+1]=eu,this.int16[eI+2]=ec,this.int16[eI+3]=ed,this.int16[eI+4]=ef,this.float32[eC+3]=em,this.float32[eC+4]=e_,this.float32[eC+5]=ew,this.float32[eC+6]=eT,this.int16[eI+14]=eM,this.uint32[eC+8]=eE,this.uint16[eI+18]=eS,this.uint16[eI+19]=eA,en}};ro.prototype.bytesPerElement=40,Ks(ro,"StructArrayLayout5i4f1i1ul2ui40");let no=class no extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(en,el,eu,ec,ed,ef,em){let e_=this.length;return this.resize(e_+1),this.emplace(e_,en,el,eu,ec,ed,ef,em)}emplace(en,el,eu,ec,ed,ef,em,e_){let ew=8*en;return this.int16[ew+0]=el,this.int16[ew+1]=eu,this.int16[ew+2]=ec,this.int16[ew+4]=ed,this.int16[ew+5]=ef,this.int16[ew+6]=em,this.int16[ew+7]=e_,en}};no.prototype.bytesPerElement=16,Ks(no,"StructArrayLayout3i2i2i16");let io=class io extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(en,el,eu,ec,ed){let ef=this.length;return this.resize(ef+1),this.emplace(ef,en,el,eu,ec,ed)}emplace(en,el,eu,ec,ed,ef){let em=4*en,e_=8*en;return this.float32[em+0]=el,this.float32[em+1]=eu,this.float32[em+2]=ec,this.int16[e_+6]=ed,this.int16[e_+7]=ef,en}};io.prototype.bytesPerElement=16,Ks(io,"StructArrayLayout2f1f2i16");let so=class so extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(en,el,eu,ec){let ed=this.length;return this.resize(ed+1),this.emplace(ed,en,el,eu,ec)}emplace(en,el,eu,ec,ed){let ef=12*en,em=3*en;return this.uint8[ef+0]=el,this.uint8[ef+1]=eu,this.float32[em+1]=ec,this.float32[em+2]=ed,en}};so.prototype.bytesPerElement=12,Ks(so,"StructArrayLayout2ub2f12");let ao=class ao extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(en,el,eu){let ec=this.length;return this.resize(ec+1),this.emplace(ec,en,el,eu)}emplace(en,el,eu,ec){let ed=3*en;return this.uint16[ed+0]=el,this.uint16[ed+1]=eu,this.uint16[ed+2]=ec,en}};ao.prototype.bytesPerElement=6,Ks(ao,"StructArrayLayout3ui6");let oo=class oo extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC,eP,ez,eD,eL,ek){let eR=this.length;return this.resize(eR+1),this.emplace(eR,en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC,eP,ez,eD,eL,ek)}emplace(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC,eP,ez,eD,eL,ek,eR){let eO=30*en,eB=15*en,eF=60*en;return this.int16[eO+0]=el,this.int16[eO+1]=eu,this.int16[eO+2]=ec,this.float32[eB+2]=ed,this.float32[eB+3]=ef,this.uint16[eO+8]=em,this.uint16[eO+9]=e_,this.uint32[eB+5]=ew,this.uint32[eB+6]=eT,this.uint32[eB+7]=eM,this.uint16[eO+16]=eE,this.uint16[eO+17]=eS,this.uint16[eO+18]=eA,this.float32[eB+10]=eI,this.float32[eB+11]=eC,this.uint8[eF+48]=eP,this.uint8[eF+49]=ez,this.uint8[eF+50]=eD,this.uint32[eB+13]=eL,this.int16[eO+28]=ek,this.uint8[eF+58]=eR,en}};oo.prototype.bytesPerElement=60,Ks(oo,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");let lo=class lo extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC,eP,ez,eD,eL,ek,eR,eO,eB,eF,eN,eU,eV,ej,eG,eq,eZ){let e$=this.length;return this.resize(e$+1),this.emplace(e$,en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC,eP,ez,eD,eL,ek,eR,eO,eB,eF,eN,eU,eV,ej,eG,eq,eZ)}emplace(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC,eP,ez,eD,eL,ek,eR,eO,eB,eF,eN,eU,eV,ej,eG,eq,eZ,e$){let eW=20*en,eH=40*en;return this.float32[eW+0]=el,this.float32[eW+1]=eu,this.int16[eH+4]=ec,this.int16[eH+5]=ed,this.int16[eH+6]=ef,this.int16[eH+7]=em,this.int16[eH+8]=e_,this.int16[eH+9]=ew,this.int16[eH+10]=eT,this.int16[eH+11]=eM,this.int16[eH+12]=eE,this.uint16[eH+13]=eS,this.uint16[eH+14]=eA,this.uint16[eH+15]=eI,this.uint16[eH+16]=eC,this.uint16[eH+17]=eP,this.uint16[eH+18]=ez,this.uint16[eH+19]=eD,this.uint16[eH+20]=eL,this.uint16[eH+21]=ek,this.uint16[eH+22]=eR,this.uint16[eH+23]=eO,this.uint16[eH+24]=eB,this.uint16[eH+25]=eF,this.uint16[eH+26]=eN,this.uint16[eH+27]=eU,this.uint32[eW+14]=eV,this.float32[eW+15]=ej,this.float32[eW+16]=eG,this.float32[eW+17]=eq,this.float32[eW+18]=eZ,this.uint8[80*en+76]=e$,en}};lo.prototype.bytesPerElement=80,Ks(lo,"StructArrayLayout2f9i15ui1ul4f1ub80");let uo=class uo extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(en){let el=this.length;return this.resize(el+1),this.emplace(el,en)}emplace(en,el){return this.float32[1*en+0]=el,en}};uo.prototype.bytesPerElement=4,Ks(uo,"StructArrayLayout1f4");let co=class co extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(en,el,eu,ec,ed){let ef=this.length;return this.resize(ef+1),this.emplace(ef,en,el,eu,ec,ed)}emplace(en,el,eu,ec,ed,ef){let em=5*en;return this.float32[em+0]=el,this.float32[em+1]=eu,this.float32[em+2]=ec,this.float32[em+3]=ed,this.float32[em+4]=ef,en}};co.prototype.bytesPerElement=20,Ks(co,"StructArrayLayout5f20");let ho=class ho extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(en,el,eu,ec,ed,ef,em){let e_=this.length;return this.resize(e_+1),this.emplace(e_,en,el,eu,ec,ed,ef,em)}emplace(en,el,eu,ec,ed,ef,em,e_){let ew=7*en;return this.float32[ew+0]=el,this.float32[ew+1]=eu,this.float32[ew+2]=ec,this.float32[ew+3]=ed,this.float32[ew+4]=ef,this.float32[ew+5]=em,this.float32[ew+6]=e_,en}};ho.prototype.bytesPerElement=28,Ks(ho,"StructArrayLayout7f28");let po=class po extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(en,el,eu,ec){let ed=this.length;return this.resize(ed+1),this.emplace(ed,en,el,eu,ec)}emplace(en,el,eu,ec,ed){let ef=6*en;return this.uint32[3*en+0]=el,this.uint16[ef+2]=eu,this.uint16[ef+3]=ec,this.uint16[ef+4]=ed,en}};po.prototype.bytesPerElement=12,Ks(po,"StructArrayLayout1ul3ui12");let fo=class fo extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(en){let el=this.length;return this.resize(el+1),this.emplace(el,en)}emplace(en,el){return this.uint16[1*en+0]=el,en}};fo.prototype.bytesPerElement=2,Ks(fo,"StructArrayLayout1ui2");let mo=class mo extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(en,el,eu){let ec=this.length;return this.resize(ec+1),this.emplace(ec,en,el,eu)}emplace(en,el,eu,ec){let ed=3*en;return this.float32[ed+0]=el,this.float32[ed+1]=eu,this.float32[ed+2]=ec,en}};mo.prototype.bytesPerElement=12,Ks(mo,"StructArrayLayout3f12");let yo=class yo extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(en,el){let eu=this.length;return this.resize(eu+1),this.emplace(eu,en,el)}emplace(en,el,eu){let ec=2*en;return this.float32[ec+0]=el,this.float32[ec+1]=eu,en}};yo.prototype.bytesPerElement=8,Ks(yo,"StructArrayLayout2f8");let go=class go extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC){let eP=this.length;return this.resize(eP+1),this.emplace(eP,en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC)}emplace(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC,eP){let ez=16*en;return this.float32[ez+0]=el,this.float32[ez+1]=eu,this.float32[ez+2]=ec,this.float32[ez+3]=ed,this.float32[ez+4]=ef,this.float32[ez+5]=em,this.float32[ez+6]=e_,this.float32[ez+7]=ew,this.float32[ez+8]=eT,this.float32[ez+9]=eM,this.float32[ez+10]=eE,this.float32[ez+11]=eS,this.float32[ez+12]=eA,this.float32[ez+13]=eI,this.float32[ez+14]=eC,this.float32[ez+15]=eP,en}};go.prototype.bytesPerElement=64,Ks(go,"StructArrayLayout16f64");let xo=class xo extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(en,el,eu,ec,ed,ef,em){let e_=this.length;return this.resize(e_+1),this.emplace(e_,en,el,eu,ec,ed,ef,em)}emplace(en,el,eu,ec,ed,ef,em,e_){let ew=10*en,eT=5*en;return this.uint16[ew+0]=el,this.uint16[ew+1]=eu,this.uint16[ew+2]=ec,this.uint16[ew+3]=ed,this.float32[eT+2]=ef,this.float32[eT+3]=em,this.float32[eT+4]=e_,en}};xo.prototype.bytesPerElement=20,Ks(xo,"StructArrayLayout4ui3f20");let vo=class vo extends ja{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(en){let el=this.length;return this.resize(el+1),this.emplace(el,en)}emplace(en,el){return this.uint8[1*en+0]=el,en}};vo.prototype.bytesPerElement=1,Ks(vo,"StructArrayLayout1ub1");let bo=class bo extends Fa{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}};bo.prototype.size=40;let _o=class _o extends ro{get(en){return new bo(this,en)}};Ks(_o,"CollisionBoxArray");let wo=class wo extends Fa{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(en){this._structArray.uint8[this._pos1+49]=en}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(en){this._structArray.uint8[this._pos1+50]=en}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(en){this._structArray.uint32[this._pos4+13]=en}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(en){this._structArray.uint8[this._pos1+58]=en}};wo.prototype.size=60;let Mo=class Mo extends oo{get(en){return new wo(this,en)}};Ks(Mo,"PlacedSymbolArray");let Ao=class Ao extends Fa{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(en){this._structArray.uint32[this._pos4+14]=en}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(en){this._structArray.float32[this._pos4+18]=en}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}};Ao.prototype.size=80;let So=class So extends lo{get(en){return new Ao(this,en)}};Ks(So,"SymbolInstanceArray");let Io=class Io extends uo{getoffsetX(en){return this.float32[1*en+0]}};Ks(Io,"GlyphOffsetArray");let ko=class ko extends $a{getx(en){return this.int16[2*en+0]}gety(en){return this.int16[2*en+1]}};Ks(ko,"SymbolLineVertexArray");let To=class To extends Fa{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}};To.prototype.size=12;let Po=class Po extends po{get(en){return new To(this,en)}};Ks(Po,"FeatureIndexArray");let zo=class zo extends eo{geta_centroid_pos0(en){return this.uint16[2*en+0]}geta_centroid_pos1(en){return this.uint16[2*en+1]}};Ks(zo,"FillExtrusionCentroidArray");let iA=Ua([{name:"a_pos",components:2,type:"Int16"}],4),iI=Ua([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);let Do=class Do{constructor(en=[]){this.segments=en}_prepareSegment(en,el,eu,ec){let ed=this.segments[this.segments.length-1];return en>Do.MAX_VERTEX_ARRAY_LENGTH&&q(`Max vertices per segment is ${Do.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${en}`),(!ed||ed.vertexLength+en>Do.MAX_VERTEX_ARRAY_LENGTH||ed.sortKey!==ec)&&(ed={vertexOffset:el,primitiveOffset:eu,vertexLength:0,primitiveLength:0},void 0!==ec&&(ed.sortKey=ec),this.segments.push(ed)),ed}prepareSegment(en,el,eu,ec){return this._prepareSegment(en,el.length,eu.length,ec)}get(){return this.segments}destroy(){for(let en of this.segments)for(let el in en.vaos)en.vaos[el].destroy()}static simpleSegment(en,el,eu,ec){return new Do([{vertexOffset:en,primitiveOffset:el,vertexLength:eu,primitiveLength:ec,vaos:{},sortKey:0}])}};function Co(en,el){return 256*(en=k(Math.floor(en),0,255))+k(Math.floor(el),0,255)}Do.MAX_VERTEX_ARRAY_LENGTH=65535,Ks(Do,"SegmentVector");let iC=Ua([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),iP=Ua([{name:"a_dash",components:4,type:"Uint16"}]);var iz={exports:{}},iD={exports:{}};iD.exports=function(en,el){var eu,ec,ed,ef,em,e_;for(ec=en.length-(eu=3&en.length),ed=el,e_=0;e_<ec;)em=255&en.charCodeAt(e_)|(255&en.charCodeAt(++e_))<<8|(255&en.charCodeAt(++e_))<<16|(255&en.charCodeAt(++e_))<<24,++e_,ed=27492+(65535&(ef=5*(65535&(ed=(ed^=em=(65535&(em=(em=(65535&em)*3432918353+(((em>>>16)*3432918353&65535)<<16)&4294967295)<<15|em>>>17))*461845907+(((em>>>16)*461845907&65535)<<16)&4294967295)<<13|ed>>>19))+((5*(ed>>>16)&65535)<<16)&4294967295))+((58964+(ef>>>16)&65535)<<16);switch(em=0,eu){case 3:em^=(255&en.charCodeAt(e_+2))<<16;case 2:em^=(255&en.charCodeAt(e_+1))<<8;case 1:ed^=em=(65535&(em=(em=(65535&(em^=255&en.charCodeAt(e_)))*3432918353+(((em>>>16)*3432918353&65535)<<16)&4294967295)<<15|em>>>17))*461845907+(((em>>>16)*461845907&65535)<<16)&4294967295}return ed^=en.length,ed=2246822507*(65535&(ed^=ed>>>16))+((2246822507*(ed>>>16)&65535)<<16)&4294967295,ed=3266489909*(65535&(ed^=ed>>>13))+((3266489909*(ed>>>16)&65535)<<16)&4294967295,(ed^=ed>>>16)>>>0};var iL=iD.exports,ik={exports:{}};ik.exports=function(en,el){for(var eu,ec=en.length,ed=el^ec,ef=0;ec>=4;)eu=1540483477*(65535&(eu=255&en.charCodeAt(ef)|(255&en.charCodeAt(++ef))<<8|(255&en.charCodeAt(++ef))<<16|(255&en.charCodeAt(++ef))<<24))+((1540483477*(eu>>>16)&65535)<<16),ed=1540483477*(65535&ed)+((1540483477*(ed>>>16)&65535)<<16)^(eu=1540483477*(65535&(eu^=eu>>>24))+((1540483477*(eu>>>16)&65535)<<16)),ec-=4,++ef;switch(ec){case 3:ed^=(255&en.charCodeAt(ef+2))<<16;case 2:ed^=(255&en.charCodeAt(ef+1))<<8;case 1:ed=1540483477*(65535&(ed^=255&en.charCodeAt(ef)))+((1540483477*(ed>>>16)&65535)<<16)}return ed=1540483477*(65535&(ed^=ed>>>13))+((1540483477*(ed>>>16)&65535)<<16),(ed^=ed>>>15)>>>0};var iR=ik.exports;iz.exports=iL,iz.exports.murmur3=iL,iz.exports.murmur2=iR;var iO=p(iz.exports);let qo=class qo{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(en,el,eu,ec){this.ids.push(Go(en)),this.positions.push(el,eu,ec)}eachPosition(en,el){let eu=Go(en),ec=0,ed=this.ids.length-1;for(;ec<ed;){let en=ec+ed>>1;this.ids[en]>=eu?ed=en:ec=en+1}for(;this.ids[ec]===eu;)el(this.positions[3*ec],this.positions[3*ec+1],this.positions[3*ec+2]),ec++}static serialize(en,el){let eu=new Float64Array(en.ids),ec=new Uint32Array(en.positions);return function Yo(en,el,eu,ec){for(;eu<ec;){let ed=en[eu+ec>>1],ef=eu-1,em=ec+1;for(;;){do ef++;while(en[ef]<ed);do em--;while(en[em]>ed);if(ef>=em)break;Zo(en,ef,em),Zo(el,3*ef,3*em),Zo(el,3*ef+1,3*em+1),Zo(el,3*ef+2,3*em+2)}em-eu<ec-em?(Yo(en,el,eu,em),eu=em+1):(Yo(en,el,em+1,ec),ec=em)}}(eu,ec,0,eu.length-1),el&&(el.add(eu.buffer),el.add(ec.buffer)),{ids:eu,positions:ec}}static deserialize(en){let el;let eu=new qo;for(let ec of(eu.ids=en.ids,eu.positions=en.positions,eu.ids))ec!==el&&eu.uniqueIds.push(ec),el=ec;return eu.indexed=!0,eu}};function Go(en){let el=+en;return!isNaN(el)&&Number.MIN_SAFE_INTEGER<=el&&el<=Number.MAX_SAFE_INTEGER?el:iO(String(en))}function Zo(en,el,eu){let ec=en[el];en[el]=en[eu],en[eu]=ec}Ks(qo,"FeaturePositionMap");let Xo=class Xo{constructor(en){this.gl=en.gl,this.initialized=!1}fetchUniformLocation(en,el){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(en,el),this.initialized=!0),!!this.location}};let Ko=class Ko extends Xo{constructor(en){super(en),this.current=0}set(en,el,eu){this.fetchUniformLocation(en,el)&&this.current!==eu&&(this.current=eu,this.gl.uniform1i(this.location,eu))}};let Wo=class Wo extends Xo{constructor(en){super(en),this.current=0}set(en,el,eu){this.fetchUniformLocation(en,el)&&this.current!==eu&&(this.current=eu,this.gl.uniform1f(this.location,eu))}};let Ho=class Ho extends Xo{constructor(en){super(en),this.current=[0,0]}set(en,el,eu){this.fetchUniformLocation(en,el)&&(eu[0]===this.current[0]&&eu[1]===this.current[1]||(this.current=eu,this.gl.uniform2f(this.location,eu[0],eu[1])))}};let Jo=class Jo extends Xo{constructor(en){super(en),this.current=[0,0,0]}set(en,el,eu){this.fetchUniformLocation(en,el)&&(eu[0]===this.current[0]&&eu[1]===this.current[1]&&eu[2]===this.current[2]||(this.current=eu,this.gl.uniform3f(this.location,eu[0],eu[1],eu[2])))}};let Qo=class Qo extends Xo{constructor(en){super(en),this.current=[0,0,0,0]}set(en,el,eu){this.fetchUniformLocation(en,el)&&(eu[0]===this.current[0]&&eu[1]===this.current[1]&&eu[2]===this.current[2]&&eu[3]===this.current[3]||(this.current=eu,this.gl.uniform4f(this.location,eu[0],eu[1],eu[2],eu[3])))}};let tl=class tl extends Xo{constructor(en){super(en),this.current=Ce.transparent}set(en,el,eu){this.fetchUniformLocation(en,el)&&(eu.r===this.current.r&&eu.g===this.current.g&&eu.b===this.current.b&&eu.a===this.current.a||(this.current=eu,this.gl.uniform4f(this.location,eu.r,eu.g,eu.b,eu.a)))}};let iB=new Float32Array(16);let rl=class rl extends Xo{constructor(en){super(en),this.current=iB}set(en,el,eu){if(this.fetchUniformLocation(en,el)){if(eu[12]!==this.current[12]||eu[0]!==this.current[0])return this.current=eu,void this.gl.uniformMatrix4fv(this.location,!1,eu);for(let en=1;en<16;en++)if(eu[en]!==this.current[en]){this.current=eu,this.gl.uniformMatrix4fv(this.location,!1,eu);break}}}};let iF=new Float32Array(9),iN=new Float32Array(4);let sl=class sl extends Xo{constructor(en){super(en),this.current=iN}set(en,el,eu){if(this.fetchUniformLocation(en,el)){for(let en=0;en<4;en++)if(eu[en]!==this.current[en]){this.current=eu,this.gl.uniformMatrix2fv(this.location,!1,eu);break}}}};function al(en){return[Co(255*en.r,255*en.g),Co(255*en.b,255*en.a)]}let ol=class ol{constructor(en,el,eu){this.value=en,this.uniformNames=el.map(en=>`u_${en}`),this.type=eu}setUniform(en,el,eu,ec,ed){el.set(en,ed,ec.constantOr(this.value))}getBinding(en,el){return"color"===this.type?new tl(en):new Wo(en)}};let ll=class ll{constructor(en,el){this.uniformNames=el.map(en=>`u_${en}`),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(en){this.pixelRatio=en.pixelRatio||1,this.pattern=en.tl.concat(en.br)}setUniform(en,el,eu,ec,ed){let ef="u_pattern"===ed||"u_dash"===ed?this.pattern:"u_pixel_ratio"===ed?this.pixelRatio:null;ef&&el.set(en,ed,ef)}getBinding(en,el){return"u_pattern"===el||"u_dash"===el?new Qo(en):new Wo(en)}};let ul=class ul{constructor(en,el,eu,ec){this.expression=en,this.type=eu,this.maxValue=0,this.paintVertexAttributes=el.map(en=>({name:`a_${en}`,type:"Float32",components:"color"===eu?2:1,offset:0})),this.paintVertexArray=new ec}populatePaintArray(en,el,eu,ec,ed,ef,em){let e_=this.paintVertexArray.length,ew=this.expression.evaluate(new _a(0,{brightness:ef}),el,{},ed,ec,em);this.paintVertexArray.resize(en),this._setPaintValue(e_,en,ew)}updatePaintArray(en,el,eu,ec,ed,ef,em){let e_=this.expression.evaluate({zoom:0,brightness:em},eu,ec,void 0,ed);this._setPaintValue(en,el,e_)}_setPaintValue(en,el,eu){if("color"===this.type){let ec=al(eu);for(let eu=en;eu<el;eu++)this.paintVertexArray.emplace(eu,ec[0],ec[1])}else{for(let ec=en;ec<el;ec++)this.paintVertexArray.emplace(ec,eu);this.maxValue=Math.max(this.maxValue,Math.abs(eu))}}upload(en){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=en.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}};let cl=class cl{constructor(en,el,eu,ec,ed,ef){this.expression=en,this.uniformNames=el.map(en=>`u_${en}_t`),this.type=eu,this.useIntegerZoom=ec,this.zoom=ed,this.maxValue=0,this.paintVertexAttributes=el.map(en=>({name:`a_${en}`,type:"Float32",components:"color"===eu?4:2,offset:0})),this.paintVertexArray=new ef}populatePaintArray(en,el,eu,ec,ed,ef,em){let e_=this.expression.evaluate(new _a(this.zoom,{brightness:ef}),el,{},ed,ec,em),ew=this.expression.evaluate(new _a(this.zoom+1,{brightness:ef}),el,{},ed,ec,em),eT=this.paintVertexArray.length;this.paintVertexArray.resize(en),this._setPaintValue(eT,en,e_,ew)}updatePaintArray(en,el,eu,ec,ed,ef,em){let e_=this.expression.evaluate({zoom:this.zoom,brightness:em},eu,ec,void 0,ed),ew=this.expression.evaluate({zoom:this.zoom+1,brightness:em},eu,ec,void 0,ed);this._setPaintValue(en,el,e_,ew)}_setPaintValue(en,el,eu,ec){if("color"===this.type){let ed=al(eu),ef=al(ec);for(let eu=en;eu<el;eu++)this.paintVertexArray.emplace(eu,ed[0],ed[1],ef[0],ef[1])}else{for(let ed=en;ed<el;ed++)this.paintVertexArray.emplace(ed,eu,ec);this.maxValue=Math.max(this.maxValue,Math.abs(eu),Math.abs(ec))}}upload(en){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=en.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(en,el,eu,ec,ed){let ef=this.useIntegerZoom?Math.floor(eu.zoom):eu.zoom,em=k(this.expression.interpolationFactor(ef,this.zoom,this.zoom+1),0,1);el.set(en,ed,em)}getBinding(en,el){return new Wo(en)}};let hl=class hl{constructor(en,el,eu,ec,ed){this.expression=en,this.layerId=ed,this.paintVertexAttributes=("array"===eu?iP:iC).members;for(let en=0;en<el.length;++en);this.paintVertexArray=new ec}populatePaintArray(en,el,eu){let ec=this.paintVertexArray.length;this.paintVertexArray.resize(en),this._setPaintValues(ec,en,el.patterns&&el.patterns[this.layerId],eu)}updatePaintArray(en,el,eu,ec,ed,ef,em){this._setPaintValues(en,el,eu.patterns&&eu.patterns[this.layerId],ef)}_setPaintValues(en,el,eu,ec){if(!ec||!eu)return;let ed=ec[eu];if(!ed)return;let{tl:ef,br:em,pixelRatio:e_}=ed;for(let eu=en;eu<el;eu++)this.paintVertexArray.emplace(eu,ef[0],ef[1],em[0],em[1],e_)}upload(en){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=en.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}};let pl=class pl{constructor(en,el,eu=()=>!0){this.binders={},this._buffers=[];let ec=[];for(let ef in en.paint._values){var ed;let em=en.paint.get(ef);if(!eu(ef)||!(em instanceof Ta&&Ci(em.property.specification)))continue;let e_=(ed=en.type,iU[ef]||[ef.replace(`${ed}-`,"").replace(/-/g,"_")]),ew=em.value,eT=em.property.specification.type,eM=!!em.property.useIntegerZoom,eE="line-dasharray"===ef||ef.endsWith("pattern"),eS="line-dasharray"===ef&&"constant"!==en.layout.get("line-cap").value.kind;if("constant"!==ew.kind||eS){if("source"===ew.kind||eS||eE){let el=xl(ef,eT,"source");this.binders[ef]=eE?new hl(ew,e_,eT,el,en.id):new ul(ew,e_,eT,el),ec.push(`/a_${ef}`)}else{let en=xl(ef,eT,"composite");this.binders[ef]=new cl(ew,e_,eT,eM,el,en),ec.push(`/z_${ef}`)}}else this.binders[ef]=eE?new ll(ew.value,e_):new ol(ew.value,e_,eT),ec.push(`/u_${ef}`)}this.cacheKey=ec.sort().join("")}getMaxValue(en){let el=this.binders[en];return el instanceof ul||el instanceof cl?el.maxValue:0}populatePaintArrays(en,el,eu,ec,ed,ef,em){for(let e_ in this.binders){let ew=this.binders[e_];(ew instanceof ul||ew instanceof cl||ew instanceof hl)&&ew.populatePaintArray(en,el,eu,ec,ed,ef,em)}}setConstantPatternPositions(en){for(let el in this.binders){let eu=this.binders[el];eu instanceof ll&&eu.setConstantPatternPositions(en)}}updatePaintArrays(en,el,eu,ec,ed,ef,em,e_){let ew=!1,eT=Object.keys(en),eM=0!==eT.length,eE=eM?eT:el.uniqueIds;for(let eT in this.binders){let eS=this.binders[eT];if((eS instanceof ul||eS instanceof cl||eS instanceof hl)&&(!0===eS.expression.isStateDependent||!1===eS.expression.isLightConstant)){let eA=ed.paint.get(eT);for(let eu of(eS.expression=eA.value,eE)){let ed=en[eu.toString()];el.eachPosition(eu,(en,el,eu)=>{let ew=ec.feature(en);eS.updatePaintArray(el,eu,ew,ed,ef,em,e_)})}if(!eM)for(let el of eu.uniqueIds){let ed=en[el.toString()];eu.eachPosition(el,(en,el,eu)=>{let ew=ec.feature(en);eS.updatePaintArray(el,eu,ew,ed,ef,em,e_)})}ew=!0}}return ew}defines(){let en=[];for(let el in this.binders){let eu=this.binders[el];(eu instanceof ol||eu instanceof ll)&&en.push(...eu.uniformNames.map(en=>`#define HAS_UNIFORM_${en}`))}return en}getBinderAttributes(){let en=[];for(let el in this.binders){let eu=this.binders[el];if(eu instanceof ul||eu instanceof cl||eu instanceof hl)for(let el=0;el<eu.paintVertexAttributes.length;el++)en.push(eu.paintVertexAttributes[el].name)}return en}getBinderUniforms(){let en=[];for(let el in this.binders){let eu=this.binders[el];if(eu instanceof ol||eu instanceof ll||eu instanceof cl)for(let el of eu.uniformNames)en.push(el)}return en}getPaintVertexBuffers(){return this._buffers}getUniforms(en){let el=[];for(let eu in this.binders){let ec=this.binders[eu];if(ec instanceof ol||ec instanceof ll||ec instanceof cl)for(let ed of ec.uniformNames)el.push({name:ed,property:eu,binding:ec.getBinding(en,ed)})}return el}setUniforms(en,el,eu,ec,ed){for(let{name:el,property:ef,binding:em}of eu)this.binders[ef].setUniform(en,em,ed,ec.get(ef),el)}updatePaintBuffers(){for(let en in this._buffers=[],this.binders){let el=this.binders[en];(el instanceof ul||el instanceof cl||el instanceof hl)&&el.paintVertexBuffer&&this._buffers.push(el.paintVertexBuffer)}}upload(en){for(let el in this.binders){let eu=this.binders[el];(eu instanceof ul||eu instanceof cl||eu instanceof hl)&&eu.upload(en)}this.updatePaintBuffers()}destroy(){for(let en in this.binders){let el=this.binders[en];(el instanceof ul||el instanceof cl||el instanceof hl)&&el.destroy()}}};let fl=class fl{constructor(en,el,eu=()=>!0){for(let ec of(this.programConfigurations={},en))this.programConfigurations[ec.id]=new pl(ec,el,eu);this.needsUpload=!1,this._featureMap=new qo,this._featureMapWithoutIds=new qo,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(en,el,eu,ec,ed,ef,em,e_){for(let eu in this.programConfigurations)this.programConfigurations[eu].populatePaintArrays(en,el,ec,ed,ef,em,e_);void 0!==el.id?this._featureMap.add(el.id,eu,this._bufferOffset,en):(this._featureMapWithoutIds.add(this._idlessCounter,eu,this._bufferOffset,en),this._idlessCounter+=1),this._bufferOffset=en,this.needsUpload=!0}updatePaintArrays(en,el,eu,ec,ed,ef){for(let em of eu)this.needsUpload=this.programConfigurations[em.id].updatePaintArrays(en,this._featureMap,this._featureMapWithoutIds,el,em,ec,ed,ef||0)||this.needsUpload}get(en){return this.programConfigurations[en]}upload(en){if(this.needsUpload){for(let el in this.programConfigurations)this.programConfigurations[el].upload(en);this.needsUpload=!1}}destroy(){for(let en in this.programConfigurations)this.programConfigurations[en].destroy()}};let iU={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]},iV={"line-pattern":{source:Ka,composite:Ka},"fill-pattern":{source:Ka,composite:Ka},"fill-extrusion-pattern":{source:Ka,composite:Ka},"line-dasharray":{source:Wa,composite:Wa}},ij={color:{source:yo,composite:Xa},number:{source:uo,composite:yo}};function xl(en,el,eu){let ec=iV[en];return ec&&ec[eu]||ij[el][eu]}Ks(ol,"ConstantBinder"),Ks(ll,"PatternConstantBinder"),Ks(ul,"SourceExpressionBinder"),Ks(hl,"PatternCompositeBinder"),Ks(cl,"CompositeExpressionBinder"),Ks(pl,"ProgramConfiguration",{omit:["_buffers"]}),Ks(fl,"ProgramConfigurationSet");let vl=class vl{constructor(en,el){en&&(el?this.setSouthWest(en).setNorthEast(el):4===en.length?this.setSouthWest([en[0],en[1]]).setNorthEast([en[2],en[3]]):this.setSouthWest(en[0]).setNorthEast(en[1]))}setNorthEast(en){return this._ne=en instanceof r9?new r9(en.lng,en.lat):r9.convert(en),this}setSouthWest(en){return this._sw=en instanceof r9?new r9(en.lng,en.lat):r9.convert(en),this}extend(en){let el,eu;let ec=this._sw,ed=this._ne;if(en instanceof r9)el=en,eu=en;else{if(!(en instanceof vl))return Array.isArray(en)?4===en.length||en.every(Array.isArray)?this.extend(vl.convert(en)):this.extend(r9.convert(en)):"object"==typeof en&&null!==en&&en.hasOwnProperty("lat")&&(en.hasOwnProperty("lon")||en.hasOwnProperty("lng"))?this.extend(r9.convert(en)):this;if(el=en._sw,eu=en._ne,!el||!eu)return this}return ec||ed?(ec.lng=Math.min(el.lng,ec.lng),ec.lat=Math.min(el.lat,ec.lat),ed.lng=Math.max(eu.lng,ed.lng),ed.lat=Math.max(eu.lat,ed.lat)):(this._sw=new r9(el.lng,el.lat),this._ne=new r9(eu.lng,eu.lat)),this}getCenter(){return new r9((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new r9(this.getWest(),this.getNorth())}getSouthEast(){return new r9(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(en){let{lng:el,lat:eu}=r9.convert(en),ec=this._sw.lng<=el&&el<=this._ne.lng;return this._sw.lng>this._ne.lng&&(ec=this._sw.lng>=el&&el>=this._ne.lng),this._sw.lat<=eu&&eu<=this._ne.lat&&ec}static convert(en){return!en||en instanceof vl?en:new vl(en)}};var iG={},iq={};Object.defineProperty(iq,"__esModule",{value:!0}),iq.setMatrixArrayType=function(en){iq.ARRAY_TYPE=i$=en},iq.toRadian=function(en){return en*iH},iq.equals=function(en,el){return Math.abs(en-el)<=iZ*Math.max(1,Math.abs(en),Math.abs(el))},iq.RANDOM=iq.ARRAY_TYPE=iq.EPSILON=void 0;var iZ=1e-6;iq.EPSILON=iZ;var i$="undefined"!=typeof Float32Array?Float32Array:Array;iq.ARRAY_TYPE=i$;var iW=Math.random;iq.RANDOM=iW;var iH=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var en=0,el=arguments.length;el--;)en+=arguments[el]*arguments[el];return Math.sqrt(en)});var iX={};function kl(en){return(kl="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(en){return typeof en}:function(en){return en&&"function"==typeof Symbol&&en.constructor===Symbol&&en!==Symbol.prototype?"symbol":typeof en})(en)}Object.defineProperty(iX,"__esModule",{value:!0}),iX.create=function(){var en=new iK.ARRAY_TYPE(4);return iK.ARRAY_TYPE!=Float32Array&&(en[1]=0,en[2]=0),en[0]=1,en[3]=1,en},iX.clone=function(en){var el=new iK.ARRAY_TYPE(4);return el[0]=en[0],el[1]=en[1],el[2]=en[2],el[3]=en[3],el},iX.copy=function(en,el){return en[0]=el[0],en[1]=el[1],en[2]=el[2],en[3]=el[3],en},iX.identity=function(en){return en[0]=1,en[1]=0,en[2]=0,en[3]=1,en},iX.fromValues=function(en,el,eu,ec){var ed=new iK.ARRAY_TYPE(4);return ed[0]=en,ed[1]=el,ed[2]=eu,ed[3]=ec,ed},iX.set=function(en,el,eu,ec,ed){return en[0]=el,en[1]=eu,en[2]=ec,en[3]=ed,en},iX.transpose=function(en,el){if(en===el){var eu=el[1];en[1]=el[2],en[2]=eu}else en[0]=el[0],en[1]=el[2],en[2]=el[1],en[3]=el[3];return en},iX.invert=function(en,el){var eu=el[0],ec=el[1],ed=el[2],ef=el[3],em=eu*ef-ed*ec;return em?(en[0]=ef*(em=1/em),en[1]=-ec*em,en[2]=-ed*em,en[3]=eu*em,en):null},iX.adjoint=function(en,el){var eu=el[0];return en[0]=el[3],en[1]=-el[1],en[2]=-el[2],en[3]=eu,en},iX.determinant=function(en){return en[0]*en[3]-en[2]*en[1]},iX.multiply=zl,iX.rotate=function(en,el,eu){var ec=el[0],ed=el[1],ef=el[2],em=el[3],e_=Math.sin(eu),ew=Math.cos(eu);return en[0]=ec*ew+ef*e_,en[1]=ed*ew+em*e_,en[2]=-(ec*e_)+ef*ew,en[3]=-(ed*e_)+em*ew,en},iX.scale=function(en,el,eu){var ec=el[1],ed=el[2],ef=el[3],em=eu[0],e_=eu[1];return en[0]=el[0]*em,en[1]=ec*em,en[2]=ed*e_,en[3]=ef*e_,en},iX.fromRotation=function(en,el){var eu=Math.sin(el),ec=Math.cos(el);return en[0]=ec,en[1]=eu,en[2]=-eu,en[3]=ec,en},iX.fromScaling=function(en,el){return en[0]=el[0],en[1]=0,en[2]=0,en[3]=el[1],en},iX.str=function(en){return"mat2("+en[0]+", "+en[1]+", "+en[2]+", "+en[3]+")"},iX.frob=function(en){return Math.hypot(en[0],en[1],en[2],en[3])},iX.LDU=function(en,el,eu,ec){return en[2]=ec[2]/ec[0],eu[0]=ec[0],eu[1]=ec[1],eu[3]=ec[3]-en[2]*eu[1],[en,el,eu]},iX.add=function(en,el,eu){return en[0]=el[0]+eu[0],en[1]=el[1]+eu[1],en[2]=el[2]+eu[2],en[3]=el[3]+eu[3],en},iX.subtract=El,iX.exactEquals=function(en,el){return en[0]===el[0]&&en[1]===el[1]&&en[2]===el[2]&&en[3]===el[3]},iX.equals=function(en,el){var eu=en[0],ec=en[1],ed=en[2],ef=en[3],em=el[0],e_=el[1],ew=el[2],eT=el[3];return Math.abs(eu-em)<=iK.EPSILON*Math.max(1,Math.abs(eu),Math.abs(em))&&Math.abs(ec-e_)<=iK.EPSILON*Math.max(1,Math.abs(ec),Math.abs(e_))&&Math.abs(ed-ew)<=iK.EPSILON*Math.max(1,Math.abs(ed),Math.abs(ew))&&Math.abs(ef-eT)<=iK.EPSILON*Math.max(1,Math.abs(ef),Math.abs(eT))},iX.multiplyScalar=function(en,el,eu){return en[0]=el[0]*eu,en[1]=el[1]*eu,en[2]=el[2]*eu,en[3]=el[3]*eu,en},iX.multiplyScalarAndAdd=function(en,el,eu,ec){return en[0]=el[0]+eu[0]*ec,en[1]=el[1]+eu[1]*ec,en[2]=el[2]+eu[2]*ec,en[3]=el[3]+eu[3]*ec,en},iX.sub=iX.mul=void 0;var iK=function(en,el){if(en&&en.__esModule)return en;if(null===en||"object"!==kl(en)&&"function"!=typeof en)return{default:en};var eu=Pl(void 0);if(eu&&eu.has(en))return eu.get(en);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var ef in en)if("default"!==ef&&Object.prototype.hasOwnProperty.call(en,ef)){var em=ed?Object.getOwnPropertyDescriptor(en,ef):null;em&&(em.get||em.set)?Object.defineProperty(ec,ef,em):ec[ef]=en[ef]}return ec.default=en,eu&&eu.set(en,ec),ec}(iq);function Pl(en){if("function"!=typeof WeakMap)return null;var el=new WeakMap,eu=new WeakMap;return(Pl=function(en){return en?eu:el})(en)}function zl(en,el,eu){var ec=el[0],ed=el[1],ef=el[2],em=el[3],e_=eu[0],ew=eu[1],eT=eu[2],eM=eu[3];return en[0]=ec*e_+ef*ew,en[1]=ed*e_+em*ew,en[2]=ec*eT+ef*eM,en[3]=ed*eT+em*eM,en}function El(en,el,eu){return en[0]=el[0]-eu[0],en[1]=el[1]-eu[1],en[2]=el[2]-eu[2],en[3]=el[3]-eu[3],en}iX.mul=zl,iX.sub=El;var iJ={};function Dl(en){return(Dl="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(en){return typeof en}:function(en){return en&&"function"==typeof Symbol&&en.constructor===Symbol&&en!==Symbol.prototype?"symbol":typeof en})(en)}Object.defineProperty(iJ,"__esModule",{value:!0}),iJ.create=function(){var en=new iY.ARRAY_TYPE(6);return iY.ARRAY_TYPE!=Float32Array&&(en[1]=0,en[2]=0,en[4]=0,en[5]=0),en[0]=1,en[3]=1,en},iJ.clone=function(en){var el=new iY.ARRAY_TYPE(6);return el[0]=en[0],el[1]=en[1],el[2]=en[2],el[3]=en[3],el[4]=en[4],el[5]=en[5],el},iJ.copy=function(en,el){return en[0]=el[0],en[1]=el[1],en[2]=el[2],en[3]=el[3],en[4]=el[4],en[5]=el[5],en},iJ.identity=function(en){return en[0]=1,en[1]=0,en[2]=0,en[3]=1,en[4]=0,en[5]=0,en},iJ.fromValues=function(en,el,eu,ec,ed,ef){var em=new iY.ARRAY_TYPE(6);return em[0]=en,em[1]=el,em[2]=eu,em[3]=ec,em[4]=ed,em[5]=ef,em},iJ.set=function(en,el,eu,ec,ed,ef,em){return en[0]=el,en[1]=eu,en[2]=ec,en[3]=ed,en[4]=ef,en[5]=em,en},iJ.invert=function(en,el){var eu=el[0],ec=el[1],ed=el[2],ef=el[3],em=el[4],e_=el[5],ew=eu*ef-ec*ed;return ew?(en[0]=ef*(ew=1/ew),en[1]=-ec*ew,en[2]=-ed*ew,en[3]=eu*ew,en[4]=(ed*e_-ef*em)*ew,en[5]=(ec*em-eu*e_)*ew,en):null},iJ.determinant=function(en){return en[0]*en[3]-en[1]*en[2]},iJ.multiply=Ll,iJ.rotate=function(en,el,eu){var ec=el[0],ed=el[1],ef=el[2],em=el[3],e_=el[4],ew=el[5],eT=Math.sin(eu),eM=Math.cos(eu);return en[0]=ec*eM+ef*eT,en[1]=ed*eM+em*eT,en[2]=-(ec*eT)+ef*eM,en[3]=-(ed*eT)+em*eM,en[4]=e_,en[5]=ew,en},iJ.scale=function(en,el,eu){var ec=el[1],ed=el[2],ef=el[3],em=el[4],e_=el[5],ew=eu[0],eT=eu[1];return en[0]=el[0]*ew,en[1]=ec*ew,en[2]=ed*eT,en[3]=ef*eT,en[4]=em,en[5]=e_,en},iJ.translate=function(en,el,eu){var ec=el[0],ed=el[1],ef=el[2],em=el[3],e_=el[4],ew=el[5],eT=eu[0],eM=eu[1];return en[0]=ec,en[1]=ed,en[2]=ef,en[3]=em,en[4]=ec*eT+ef*eM+e_,en[5]=ed*eT+em*eM+ew,en},iJ.fromRotation=function(en,el){var eu=Math.sin(el),ec=Math.cos(el);return en[0]=ec,en[1]=eu,en[2]=-eu,en[3]=ec,en[4]=0,en[5]=0,en},iJ.fromScaling=function(en,el){return en[0]=el[0],en[1]=0,en[2]=0,en[3]=el[1],en[4]=0,en[5]=0,en},iJ.fromTranslation=function(en,el){return en[0]=1,en[1]=0,en[2]=0,en[3]=1,en[4]=el[0],en[5]=el[1],en},iJ.str=function(en){return"mat2d("+en[0]+", "+en[1]+", "+en[2]+", "+en[3]+", "+en[4]+", "+en[5]+")"},iJ.frob=function(en){return Math.hypot(en[0],en[1],en[2],en[3],en[4],en[5],1)},iJ.add=function(en,el,eu){return en[0]=el[0]+eu[0],en[1]=el[1]+eu[1],en[2]=el[2]+eu[2],en[3]=el[3]+eu[3],en[4]=el[4]+eu[4],en[5]=el[5]+eu[5],en},iJ.subtract=Vl,iJ.multiplyScalar=function(en,el,eu){return en[0]=el[0]*eu,en[1]=el[1]*eu,en[2]=el[2]*eu,en[3]=el[3]*eu,en[4]=el[4]*eu,en[5]=el[5]*eu,en},iJ.multiplyScalarAndAdd=function(en,el,eu,ec){return en[0]=el[0]+eu[0]*ec,en[1]=el[1]+eu[1]*ec,en[2]=el[2]+eu[2]*ec,en[3]=el[3]+eu[3]*ec,en[4]=el[4]+eu[4]*ec,en[5]=el[5]+eu[5]*ec,en},iJ.exactEquals=function(en,el){return en[0]===el[0]&&en[1]===el[1]&&en[2]===el[2]&&en[3]===el[3]&&en[4]===el[4]&&en[5]===el[5]},iJ.equals=function(en,el){var eu=en[0],ec=en[1],ed=en[2],ef=en[3],em=en[4],e_=en[5],ew=el[0],eT=el[1],eM=el[2],eE=el[3],eS=el[4],eA=el[5];return Math.abs(eu-ew)<=iY.EPSILON*Math.max(1,Math.abs(eu),Math.abs(ew))&&Math.abs(ec-eT)<=iY.EPSILON*Math.max(1,Math.abs(ec),Math.abs(eT))&&Math.abs(ed-eM)<=iY.EPSILON*Math.max(1,Math.abs(ed),Math.abs(eM))&&Math.abs(ef-eE)<=iY.EPSILON*Math.max(1,Math.abs(ef),Math.abs(eE))&&Math.abs(em-eS)<=iY.EPSILON*Math.max(1,Math.abs(em),Math.abs(eS))&&Math.abs(e_-eA)<=iY.EPSILON*Math.max(1,Math.abs(e_),Math.abs(eA))},iJ.sub=iJ.mul=void 0;var iY=function(en,el){if(en&&en.__esModule)return en;if(null===en||"object"!==Dl(en)&&"function"!=typeof en)return{default:en};var eu=Rl(void 0);if(eu&&eu.has(en))return eu.get(en);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var ef in en)if("default"!==ef&&Object.prototype.hasOwnProperty.call(en,ef)){var em=ed?Object.getOwnPropertyDescriptor(en,ef):null;em&&(em.get||em.set)?Object.defineProperty(ec,ef,em):ec[ef]=en[ef]}return ec.default=en,eu&&eu.set(en,ec),ec}(iq);function Rl(en){if("function"!=typeof WeakMap)return null;var el=new WeakMap,eu=new WeakMap;return(Rl=function(en){return en?eu:el})(en)}function Ll(en,el,eu){var ec=el[0],ed=el[1],ef=el[2],em=el[3],e_=el[4],ew=el[5],eT=eu[0],eM=eu[1],eE=eu[2],eS=eu[3],eA=eu[4],eI=eu[5];return en[0]=ec*eT+ef*eM,en[1]=ed*eT+em*eM,en[2]=ec*eE+ef*eS,en[3]=ed*eE+em*eS,en[4]=ec*eA+ef*eI+e_,en[5]=ed*eA+em*eI+ew,en}function Vl(en,el,eu){return en[0]=el[0]-eu[0],en[1]=el[1]-eu[1],en[2]=el[2]-eu[2],en[3]=el[3]-eu[3],en[4]=el[4]-eu[4],en[5]=el[5]-eu[5],en}iJ.mul=Ll,iJ.sub=Vl;var iQ={};function Fl(en){return(Fl="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(en){return typeof en}:function(en){return en&&"function"==typeof Symbol&&en.constructor===Symbol&&en!==Symbol.prototype?"symbol":typeof en})(en)}Object.defineProperty(iQ,"__esModule",{value:!0}),iQ.create=function(){var en=new i0.ARRAY_TYPE(9);return i0.ARRAY_TYPE!=Float32Array&&(en[1]=0,en[2]=0,en[3]=0,en[5]=0,en[6]=0,en[7]=0),en[0]=1,en[4]=1,en[8]=1,en},iQ.fromMat4=function(en,el){return en[0]=el[0],en[1]=el[1],en[2]=el[2],en[3]=el[4],en[4]=el[5],en[5]=el[6],en[6]=el[8],en[7]=el[9],en[8]=el[10],en},iQ.clone=function(en){var el=new i0.ARRAY_TYPE(9);return el[0]=en[0],el[1]=en[1],el[2]=en[2],el[3]=en[3],el[4]=en[4],el[5]=en[5],el[6]=en[6],el[7]=en[7],el[8]=en[8],el},iQ.copy=function(en,el){return en[0]=el[0],en[1]=el[1],en[2]=el[2],en[3]=el[3],en[4]=el[4],en[5]=el[5],en[6]=el[6],en[7]=el[7],en[8]=el[8],en},iQ.fromValues=function(en,el,eu,ec,ed,ef,em,e_,ew){var eT=new i0.ARRAY_TYPE(9);return eT[0]=en,eT[1]=el,eT[2]=eu,eT[3]=ec,eT[4]=ed,eT[5]=ef,eT[6]=em,eT[7]=e_,eT[8]=ew,eT},iQ.set=function(en,el,eu,ec,ed,ef,em,e_,ew,eT){return en[0]=el,en[1]=eu,en[2]=ec,en[3]=ed,en[4]=ef,en[5]=em,en[6]=e_,en[7]=ew,en[8]=eT,en},iQ.identity=function(en){return en[0]=1,en[1]=0,en[2]=0,en[3]=0,en[4]=1,en[5]=0,en[6]=0,en[7]=0,en[8]=1,en},iQ.transpose=function(en,el){if(en===el){var eu=el[1],ec=el[2],ed=el[5];en[1]=el[3],en[2]=el[6],en[3]=eu,en[5]=el[7],en[6]=ec,en[7]=ed}else en[0]=el[0],en[1]=el[3],en[2]=el[6],en[3]=el[1],en[4]=el[4],en[5]=el[7],en[6]=el[2],en[7]=el[5],en[8]=el[8];return en},iQ.invert=function(en,el){var eu=el[0],ec=el[1],ed=el[2],ef=el[3],em=el[4],e_=el[5],ew=el[6],eT=el[7],eM=el[8],eE=eM*em-e_*eT,eS=-eM*ef+e_*ew,eA=eT*ef-em*ew,eI=eu*eE+ec*eS+ed*eA;return eI?(en[0]=eE*(eI=1/eI),en[1]=(-eM*ec+ed*eT)*eI,en[2]=(e_*ec-ed*em)*eI,en[3]=eS*eI,en[4]=(eM*eu-ed*ew)*eI,en[5]=(-e_*eu+ed*ef)*eI,en[6]=eA*eI,en[7]=(-eT*eu+ec*ew)*eI,en[8]=(em*eu-ec*ef)*eI,en):null},iQ.adjoint=function(en,el){var eu=el[0],ec=el[1],ed=el[2],ef=el[3],em=el[4],e_=el[5],ew=el[6],eT=el[7],eM=el[8];return en[0]=em*eM-e_*eT,en[1]=ed*eT-ec*eM,en[2]=ec*e_-ed*em,en[3]=e_*ew-ef*eM,en[4]=eu*eM-ed*ew,en[5]=ed*ef-eu*e_,en[6]=ef*eT-em*ew,en[7]=ec*ew-eu*eT,en[8]=eu*em-ec*ef,en},iQ.determinant=function(en){var el=en[3],eu=en[4],ec=en[5],ed=en[6],ef=en[7],em=en[8];return en[0]*(em*eu-ec*ef)+en[1]*(-em*el+ec*ed)+en[2]*(ef*el-eu*ed)},iQ.multiply=Nl,iQ.translate=function(en,el,eu){var ec=el[0],ed=el[1],ef=el[2],em=el[3],e_=el[4],ew=el[5],eT=el[6],eM=el[7],eE=el[8],eS=eu[0],eA=eu[1];return en[0]=ec,en[1]=ed,en[2]=ef,en[3]=em,en[4]=e_,en[5]=ew,en[6]=eS*ec+eA*em+eT,en[7]=eS*ed+eA*e_+eM,en[8]=eS*ef+eA*ew+eE,en},iQ.rotate=function(en,el,eu){var ec=el[0],ed=el[1],ef=el[2],em=el[3],e_=el[4],ew=el[5],eT=el[6],eM=el[7],eE=el[8],eS=Math.sin(eu),eA=Math.cos(eu);return en[0]=eA*ec+eS*em,en[1]=eA*ed+eS*e_,en[2]=eA*ef+eS*ew,en[3]=eA*em-eS*ec,en[4]=eA*e_-eS*ed,en[5]=eA*ew-eS*ef,en[6]=eT,en[7]=eM,en[8]=eE,en},iQ.scale=function(en,el,eu){var ec=eu[0],ed=eu[1];return en[0]=ec*el[0],en[1]=ec*el[1],en[2]=ec*el[2],en[3]=ed*el[3],en[4]=ed*el[4],en[5]=ed*el[5],en[6]=el[6],en[7]=el[7],en[8]=el[8],en},iQ.fromTranslation=function(en,el){return en[0]=1,en[1]=0,en[2]=0,en[3]=0,en[4]=1,en[5]=0,en[6]=el[0],en[7]=el[1],en[8]=1,en},iQ.fromRotation=function(en,el){var eu=Math.sin(el),ec=Math.cos(el);return en[0]=ec,en[1]=eu,en[2]=0,en[3]=-eu,en[4]=ec,en[5]=0,en[6]=0,en[7]=0,en[8]=1,en},iQ.fromScaling=function(en,el){return en[0]=el[0],en[1]=0,en[2]=0,en[3]=0,en[4]=el[1],en[5]=0,en[6]=0,en[7]=0,en[8]=1,en},iQ.fromMat2d=function(en,el){return en[0]=el[0],en[1]=el[1],en[2]=0,en[3]=el[2],en[4]=el[3],en[5]=0,en[6]=el[4],en[7]=el[5],en[8]=1,en},iQ.fromQuat=function(en,el){var eu=el[0],ec=el[1],ed=el[2],ef=el[3],em=eu+eu,e_=ec+ec,ew=ed+ed,eT=eu*em,eM=ec*em,eE=ec*e_,eS=ed*em,eA=ed*e_,eI=ed*ew,eC=ef*em,eP=ef*e_,ez=ef*ew;return en[0]=1-eE-eI,en[3]=eM-ez,en[6]=eS+eP,en[1]=eM+ez,en[4]=1-eT-eI,en[7]=eA-eC,en[2]=eS-eP,en[5]=eA+eC,en[8]=1-eT-eE,en},iQ.normalFromMat4=function(en,el){var eu=el[0],ec=el[1],ed=el[2],ef=el[3],em=el[4],e_=el[5],ew=el[6],eT=el[7],eM=el[8],eE=el[9],eS=el[10],eA=el[11],eI=el[12],eC=el[13],eP=el[14],ez=el[15],eD=eu*e_-ec*em,eL=eu*ew-ed*em,ek=eu*eT-ef*em,eR=ec*ew-ed*e_,eO=ec*eT-ef*e_,eB=ed*eT-ef*ew,eF=eM*eC-eE*eI,eN=eM*eP-eS*eI,eU=eM*ez-eA*eI,eV=eE*eP-eS*eC,ej=eE*ez-eA*eC,eG=eS*ez-eA*eP,eq=eD*eG-eL*ej+ek*eV+eR*eU-eO*eN+eB*eF;return eq?(en[0]=(e_*eG-ew*ej+eT*eV)*(eq=1/eq),en[1]=(ew*eU-em*eG-eT*eN)*eq,en[2]=(em*ej-e_*eU+eT*eF)*eq,en[3]=(ed*ej-ec*eG-ef*eV)*eq,en[4]=(eu*eG-ed*eU+ef*eN)*eq,en[5]=(ec*eU-eu*ej-ef*eF)*eq,en[6]=(eC*eB-eP*eO+ez*eR)*eq,en[7]=(eP*ek-eI*eB-ez*eL)*eq,en[8]=(eI*eO-eC*ek+ez*eD)*eq,en):null},iQ.projection=function(en,el,eu){return en[0]=2/el,en[1]=0,en[2]=0,en[3]=0,en[4]=-2/eu,en[5]=0,en[6]=-1,en[7]=1,en[8]=1,en},iQ.str=function(en){return"mat3("+en[0]+", "+en[1]+", "+en[2]+", "+en[3]+", "+en[4]+", "+en[5]+", "+en[6]+", "+en[7]+", "+en[8]+")"},iQ.frob=function(en){return Math.hypot(en[0],en[1],en[2],en[3],en[4],en[5],en[6],en[7],en[8])},iQ.add=function(en,el,eu){return en[0]=el[0]+eu[0],en[1]=el[1]+eu[1],en[2]=el[2]+eu[2],en[3]=el[3]+eu[3],en[4]=el[4]+eu[4],en[5]=el[5]+eu[5],en[6]=el[6]+eu[6],en[7]=el[7]+eu[7],en[8]=el[8]+eu[8],en},iQ.subtract=$l,iQ.multiplyScalar=function(en,el,eu){return en[0]=el[0]*eu,en[1]=el[1]*eu,en[2]=el[2]*eu,en[3]=el[3]*eu,en[4]=el[4]*eu,en[5]=el[5]*eu,en[6]=el[6]*eu,en[7]=el[7]*eu,en[8]=el[8]*eu,en},iQ.multiplyScalarAndAdd=function(en,el,eu,ec){return en[0]=el[0]+eu[0]*ec,en[1]=el[1]+eu[1]*ec,en[2]=el[2]+eu[2]*ec,en[3]=el[3]+eu[3]*ec,en[4]=el[4]+eu[4]*ec,en[5]=el[5]+eu[5]*ec,en[6]=el[6]+eu[6]*ec,en[7]=el[7]+eu[7]*ec,en[8]=el[8]+eu[8]*ec,en},iQ.exactEquals=function(en,el){return en[0]===el[0]&&en[1]===el[1]&&en[2]===el[2]&&en[3]===el[3]&&en[4]===el[4]&&en[5]===el[5]&&en[6]===el[6]&&en[7]===el[7]&&en[8]===el[8]},iQ.equals=function(en,el){var eu=en[0],ec=en[1],ed=en[2],ef=en[3],em=en[4],e_=en[5],ew=en[6],eT=en[7],eM=en[8],eE=el[0],eS=el[1],eA=el[2],eI=el[3],eC=el[4],eP=el[5],ez=el[6],eD=el[7],eL=el[8];return Math.abs(eu-eE)<=i0.EPSILON*Math.max(1,Math.abs(eu),Math.abs(eE))&&Math.abs(ec-eS)<=i0.EPSILON*Math.max(1,Math.abs(ec),Math.abs(eS))&&Math.abs(ed-eA)<=i0.EPSILON*Math.max(1,Math.abs(ed),Math.abs(eA))&&Math.abs(ef-eI)<=i0.EPSILON*Math.max(1,Math.abs(ef),Math.abs(eI))&&Math.abs(em-eC)<=i0.EPSILON*Math.max(1,Math.abs(em),Math.abs(eC))&&Math.abs(e_-eP)<=i0.EPSILON*Math.max(1,Math.abs(e_),Math.abs(eP))&&Math.abs(ew-ez)<=i0.EPSILON*Math.max(1,Math.abs(ew),Math.abs(ez))&&Math.abs(eT-eD)<=i0.EPSILON*Math.max(1,Math.abs(eT),Math.abs(eD))&&Math.abs(eM-eL)<=i0.EPSILON*Math.max(1,Math.abs(eM),Math.abs(eL))},iQ.sub=iQ.mul=void 0;var i0=function(en,el){if(en&&en.__esModule)return en;if(null===en||"object"!==Fl(en)&&"function"!=typeof en)return{default:en};var eu=Ul(void 0);if(eu&&eu.has(en))return eu.get(en);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var ef in en)if("default"!==ef&&Object.prototype.hasOwnProperty.call(en,ef)){var em=ed?Object.getOwnPropertyDescriptor(en,ef):null;em&&(em.get||em.set)?Object.defineProperty(ec,ef,em):ec[ef]=en[ef]}return ec.default=en,eu&&eu.set(en,ec),ec}(iq);function Ul(en){if("function"!=typeof WeakMap)return null;var el=new WeakMap,eu=new WeakMap;return(Ul=function(en){return en?eu:el})(en)}function Nl(en,el,eu){var ec=el[0],ed=el[1],ef=el[2],em=el[3],e_=el[4],ew=el[5],eT=el[6],eM=el[7],eE=el[8],eS=eu[0],eA=eu[1],eI=eu[2],eC=eu[3],eP=eu[4],ez=eu[5],eD=eu[6],eL=eu[7],ek=eu[8];return en[0]=eS*ec+eA*em+eI*eT,en[1]=eS*ed+eA*e_+eI*eM,en[2]=eS*ef+eA*ew+eI*eE,en[3]=eC*ec+eP*em+ez*eT,en[4]=eC*ed+eP*e_+ez*eM,en[5]=eC*ef+eP*ew+ez*eE,en[6]=eD*ec+eL*em+ek*eT,en[7]=eD*ed+eL*e_+ek*eM,en[8]=eD*ef+eL*ew+ek*eE,en}function $l(en,el,eu){return en[0]=el[0]-eu[0],en[1]=el[1]-eu[1],en[2]=el[2]-eu[2],en[3]=el[3]-eu[3],en[4]=el[4]-eu[4],en[5]=el[5]-eu[5],en[6]=el[6]-eu[6],en[7]=el[7]-eu[7],en[8]=el[8]-eu[8],en}iQ.mul=Nl,iQ.sub=$l;var i1={};function Gl(en){return(Gl="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(en){return typeof en}:function(en){return en&&"function"==typeof Symbol&&en.constructor===Symbol&&en!==Symbol.prototype?"symbol":typeof en})(en)}Object.defineProperty(i1,"__esModule",{value:!0}),i1.create=function(){var en=new i2.ARRAY_TYPE(16);return i2.ARRAY_TYPE!=Float32Array&&(en[1]=0,en[2]=0,en[3]=0,en[4]=0,en[6]=0,en[7]=0,en[8]=0,en[9]=0,en[11]=0,en[12]=0,en[13]=0,en[14]=0),en[0]=1,en[5]=1,en[10]=1,en[15]=1,en},i1.clone=function(en){var el=new i2.ARRAY_TYPE(16);return el[0]=en[0],el[1]=en[1],el[2]=en[2],el[3]=en[3],el[4]=en[4],el[5]=en[5],el[6]=en[6],el[7]=en[7],el[8]=en[8],el[9]=en[9],el[10]=en[10],el[11]=en[11],el[12]=en[12],el[13]=en[13],el[14]=en[14],el[15]=en[15],el},i1.copy=function(en,el){return en[0]=el[0],en[1]=el[1],en[2]=el[2],en[3]=el[3],en[4]=el[4],en[5]=el[5],en[6]=el[6],en[7]=el[7],en[8]=el[8],en[9]=el[9],en[10]=el[10],en[11]=el[11],en[12]=el[12],en[13]=el[13],en[14]=el[14],en[15]=el[15],en},i1.fromValues=function(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC){var eP=new i2.ARRAY_TYPE(16);return eP[0]=en,eP[1]=el,eP[2]=eu,eP[3]=ec,eP[4]=ed,eP[5]=ef,eP[6]=em,eP[7]=e_,eP[8]=ew,eP[9]=eT,eP[10]=eM,eP[11]=eE,eP[12]=eS,eP[13]=eA,eP[14]=eI,eP[15]=eC,eP},i1.set=function(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC,eP){return en[0]=el,en[1]=eu,en[2]=ec,en[3]=ed,en[4]=ef,en[5]=em,en[6]=e_,en[7]=ew,en[8]=eT,en[9]=eM,en[10]=eE,en[11]=eS,en[12]=eA,en[13]=eI,en[14]=eC,en[15]=eP,en},i1.identity=Xl,i1.transpose=function(en,el){if(en===el){var eu=el[1],ec=el[2],ed=el[3],ef=el[6],em=el[7],e_=el[11];en[1]=el[4],en[2]=el[8],en[3]=el[12],en[4]=eu,en[6]=el[9],en[7]=el[13],en[8]=ec,en[9]=ef,en[11]=el[14],en[12]=ed,en[13]=em,en[14]=e_}else en[0]=el[0],en[1]=el[4],en[2]=el[8],en[3]=el[12],en[4]=el[1],en[5]=el[5],en[6]=el[9],en[7]=el[13],en[8]=el[2],en[9]=el[6],en[10]=el[10],en[11]=el[14],en[12]=el[3],en[13]=el[7],en[14]=el[11],en[15]=el[15];return en},i1.invert=function(en,el){var eu=el[0],ec=el[1],ed=el[2],ef=el[3],em=el[4],e_=el[5],ew=el[6],eT=el[7],eM=el[8],eE=el[9],eS=el[10],eA=el[11],eI=el[12],eC=el[13],eP=el[14],ez=el[15],eD=eu*e_-ec*em,eL=eu*ew-ed*em,ek=eu*eT-ef*em,eR=ec*ew-ed*e_,eO=ec*eT-ef*e_,eB=ed*eT-ef*ew,eF=eM*eC-eE*eI,eN=eM*eP-eS*eI,eU=eM*ez-eA*eI,eV=eE*eP-eS*eC,ej=eE*ez-eA*eC,eG=eS*ez-eA*eP,eq=eD*eG-eL*ej+ek*eV+eR*eU-eO*eN+eB*eF;return eq?(en[0]=(e_*eG-ew*ej+eT*eV)*(eq=1/eq),en[1]=(ed*ej-ec*eG-ef*eV)*eq,en[2]=(eC*eB-eP*eO+ez*eR)*eq,en[3]=(eS*eO-eE*eB-eA*eR)*eq,en[4]=(ew*eU-em*eG-eT*eN)*eq,en[5]=(eu*eG-ed*eU+ef*eN)*eq,en[6]=(eP*ek-eI*eB-ez*eL)*eq,en[7]=(eM*eB-eS*ek+eA*eL)*eq,en[8]=(em*ej-e_*eU+eT*eF)*eq,en[9]=(ec*eU-eu*ej-ef*eF)*eq,en[10]=(eI*eO-eC*ek+ez*eD)*eq,en[11]=(eE*ek-eM*eO-eA*eD)*eq,en[12]=(e_*eN-em*eV-ew*eF)*eq,en[13]=(eu*eV-ec*eN+ed*eF)*eq,en[14]=(eC*eL-eI*eR-eP*eD)*eq,en[15]=(eM*eR-eE*eL+eS*eD)*eq,en):null},i1.adjoint=function(en,el){var eu=el[0],ec=el[1],ed=el[2],ef=el[3],em=el[4],e_=el[5],ew=el[6],eT=el[7],eM=el[8],eE=el[9],eS=el[10],eA=el[11],eI=el[12],eC=el[13],eP=el[14],ez=el[15];return en[0]=e_*(eS*ez-eA*eP)-eE*(ew*ez-eT*eP)+eC*(ew*eA-eT*eS),en[1]=-(ec*(eS*ez-eA*eP)-eE*(ed*ez-ef*eP)+eC*(ed*eA-ef*eS)),en[2]=ec*(ew*ez-eT*eP)-e_*(ed*ez-ef*eP)+eC*(ed*eT-ef*ew),en[3]=-(ec*(ew*eA-eT*eS)-e_*(ed*eA-ef*eS)+eE*(ed*eT-ef*ew)),en[4]=-(em*(eS*ez-eA*eP)-eM*(ew*ez-eT*eP)+eI*(ew*eA-eT*eS)),en[5]=eu*(eS*ez-eA*eP)-eM*(ed*ez-ef*eP)+eI*(ed*eA-ef*eS),en[6]=-(eu*(ew*ez-eT*eP)-em*(ed*ez-ef*eP)+eI*(ed*eT-ef*ew)),en[7]=eu*(ew*eA-eT*eS)-em*(ed*eA-ef*eS)+eM*(ed*eT-ef*ew),en[8]=em*(eE*ez-eA*eC)-eM*(e_*ez-eT*eC)+eI*(e_*eA-eT*eE),en[9]=-(eu*(eE*ez-eA*eC)-eM*(ec*ez-ef*eC)+eI*(ec*eA-ef*eE)),en[10]=eu*(e_*ez-eT*eC)-em*(ec*ez-ef*eC)+eI*(ec*eT-ef*e_),en[11]=-(eu*(e_*eA-eT*eE)-em*(ec*eA-ef*eE)+eM*(ec*eT-ef*e_)),en[12]=-(em*(eE*eP-eS*eC)-eM*(e_*eP-ew*eC)+eI*(e_*eS-ew*eE)),en[13]=eu*(eE*eP-eS*eC)-eM*(ec*eP-ed*eC)+eI*(ec*eS-ed*eE),en[14]=-(eu*(e_*eP-ew*eC)-em*(ec*eP-ed*eC)+eI*(ec*ew-ed*e_)),en[15]=eu*(e_*eS-ew*eE)-em*(ec*eS-ed*eE)+eM*(ec*ew-ed*e_),en},i1.determinant=function(en){var el=en[0],eu=en[1],ec=en[2],ed=en[3],ef=en[4],em=en[5],e_=en[6],ew=en[7],eT=en[8],eM=en[9],eE=en[10],eS=en[11],eA=en[12],eI=en[13],eC=en[14],eP=en[15];return(el*em-eu*ef)*(eE*eP-eS*eC)-(el*e_-ec*ef)*(eM*eP-eS*eI)+(el*ew-ed*ef)*(eM*eC-eE*eI)+(eu*e_-ec*em)*(eT*eP-eS*eA)-(eu*ew-ed*em)*(eT*eC-eE*eA)+(ec*ew-ed*e_)*(eT*eI-eM*eA)},i1.multiply=Kl,i1.translate=function(en,el,eu){var ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC=eu[0],eP=eu[1],ez=eu[2];return el===en?(en[12]=el[0]*eC+el[4]*eP+el[8]*ez+el[12],en[13]=el[1]*eC+el[5]*eP+el[9]*ez+el[13],en[14]=el[2]*eC+el[6]*eP+el[10]*ez+el[14],en[15]=el[3]*eC+el[7]*eP+el[11]*ez+el[15]):(ed=el[1],ef=el[2],em=el[3],e_=el[4],ew=el[5],eT=el[6],eM=el[7],eE=el[8],eS=el[9],eA=el[10],eI=el[11],en[0]=ec=el[0],en[1]=ed,en[2]=ef,en[3]=em,en[4]=e_,en[5]=ew,en[6]=eT,en[7]=eM,en[8]=eE,en[9]=eS,en[10]=eA,en[11]=eI,en[12]=ec*eC+e_*eP+eE*ez+el[12],en[13]=ed*eC+ew*eP+eS*ez+el[13],en[14]=ef*eC+eT*eP+eA*ez+el[14],en[15]=em*eC+eM*eP+eI*ez+el[15]),en},i1.scale=function(en,el,eu){var ec=eu[0],ed=eu[1],ef=eu[2];return en[0]=el[0]*ec,en[1]=el[1]*ec,en[2]=el[2]*ec,en[3]=el[3]*ec,en[4]=el[4]*ed,en[5]=el[5]*ed,en[6]=el[6]*ed,en[7]=el[7]*ed,en[8]=el[8]*ef,en[9]=el[9]*ef,en[10]=el[10]*ef,en[11]=el[11]*ef,en[12]=el[12],en[13]=el[13],en[14]=el[14],en[15]=el[15],en},i1.rotate=function(en,el,eu,ec){var ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC,eP,ez,eD,eL,ek,eR,eO,eB,eF,eN,eU,eV,ej=ec[0],eG=ec[1],eq=ec[2],eZ=Math.hypot(ej,eG,eq);return eZ<i2.EPSILON?null:(ej*=eZ=1/eZ,eG*=eZ,eq*=eZ,ed=Math.sin(eu),ef=Math.cos(eu),ew=el[1],eT=el[2],eM=el[3],eS=el[5],eA=el[6],eI=el[7],eP=el[9],ez=el[10],eD=el[11],eO=ej*eG*(em=1-ef)-eq*ed,eB=eG*eG*em+ef,eF=eq*eG*em+ej*ed,eN=ej*eq*em+eG*ed,eU=eG*eq*em-ej*ed,eV=eq*eq*em+ef,en[0]=(e_=el[0])*(eL=ej*ej*em+ef)+(eE=el[4])*(ek=eG*ej*em+eq*ed)+(eC=el[8])*(eR=eq*ej*em-eG*ed),en[1]=ew*eL+eS*ek+eP*eR,en[2]=eT*eL+eA*ek+ez*eR,en[3]=eM*eL+eI*ek+eD*eR,en[4]=e_*eO+eE*eB+eC*eF,en[5]=ew*eO+eS*eB+eP*eF,en[6]=eT*eO+eA*eB+ez*eF,en[7]=eM*eO+eI*eB+eD*eF,en[8]=e_*eN+eE*eU+eC*eV,en[9]=ew*eN+eS*eU+eP*eV,en[10]=eT*eN+eA*eU+ez*eV,en[11]=eM*eN+eI*eU+eD*eV,el!==en&&(en[12]=el[12],en[13]=el[13],en[14]=el[14],en[15]=el[15]),en)},i1.rotateX=function(en,el,eu){var ec=Math.sin(eu),ed=Math.cos(eu),ef=el[4],em=el[5],e_=el[6],ew=el[7],eT=el[8],eM=el[9],eE=el[10],eS=el[11];return el!==en&&(en[0]=el[0],en[1]=el[1],en[2]=el[2],en[3]=el[3],en[12]=el[12],en[13]=el[13],en[14]=el[14],en[15]=el[15]),en[4]=ef*ed+eT*ec,en[5]=em*ed+eM*ec,en[6]=e_*ed+eE*ec,en[7]=ew*ed+eS*ec,en[8]=eT*ed-ef*ec,en[9]=eM*ed-em*ec,en[10]=eE*ed-e_*ec,en[11]=eS*ed-ew*ec,en},i1.rotateY=function(en,el,eu){var ec=Math.sin(eu),ed=Math.cos(eu),ef=el[0],em=el[1],e_=el[2],ew=el[3],eT=el[8],eM=el[9],eE=el[10],eS=el[11];return el!==en&&(en[4]=el[4],en[5]=el[5],en[6]=el[6],en[7]=el[7],en[12]=el[12],en[13]=el[13],en[14]=el[14],en[15]=el[15]),en[0]=ef*ed-eT*ec,en[1]=em*ed-eM*ec,en[2]=e_*ed-eE*ec,en[3]=ew*ed-eS*ec,en[8]=ef*ec+eT*ed,en[9]=em*ec+eM*ed,en[10]=e_*ec+eE*ed,en[11]=ew*ec+eS*ed,en},i1.rotateZ=function(en,el,eu){var ec=Math.sin(eu),ed=Math.cos(eu),ef=el[0],em=el[1],e_=el[2],ew=el[3],eT=el[4],eM=el[5],eE=el[6],eS=el[7];return el!==en&&(en[8]=el[8],en[9]=el[9],en[10]=el[10],en[11]=el[11],en[12]=el[12],en[13]=el[13],en[14]=el[14],en[15]=el[15]),en[0]=ef*ed+eT*ec,en[1]=em*ed+eM*ec,en[2]=e_*ed+eE*ec,en[3]=ew*ed+eS*ec,en[4]=eT*ed-ef*ec,en[5]=eM*ed-em*ec,en[6]=eE*ed-e_*ec,en[7]=eS*ed-ew*ec,en},i1.fromTranslation=function(en,el){return en[0]=1,en[1]=0,en[2]=0,en[3]=0,en[4]=0,en[5]=1,en[6]=0,en[7]=0,en[8]=0,en[9]=0,en[10]=1,en[11]=0,en[12]=el[0],en[13]=el[1],en[14]=el[2],en[15]=1,en},i1.fromScaling=function(en,el){return en[0]=el[0],en[1]=0,en[2]=0,en[3]=0,en[4]=0,en[5]=el[1],en[6]=0,en[7]=0,en[8]=0,en[9]=0,en[10]=el[2],en[11]=0,en[12]=0,en[13]=0,en[14]=0,en[15]=1,en},i1.fromRotation=function(en,el,eu){var ec,ed,ef,em=eu[0],e_=eu[1],ew=eu[2],eT=Math.hypot(em,e_,ew);return eT<i2.EPSILON?null:(em*=eT=1/eT,e_*=eT,ew*=eT,ec=Math.sin(el),ed=Math.cos(el),en[0]=em*em*(ef=1-ed)+ed,en[1]=e_*em*ef+ew*ec,en[2]=ew*em*ef-e_*ec,en[3]=0,en[4]=em*e_*ef-ew*ec,en[5]=e_*e_*ef+ed,en[6]=ew*e_*ef+em*ec,en[7]=0,en[8]=em*ew*ef+e_*ec,en[9]=e_*ew*ef-em*ec,en[10]=ew*ew*ef+ed,en[11]=0,en[12]=0,en[13]=0,en[14]=0,en[15]=1,en)},i1.fromXRotation=function(en,el){var eu=Math.sin(el),ec=Math.cos(el);return en[0]=1,en[1]=0,en[2]=0,en[3]=0,en[4]=0,en[5]=ec,en[6]=eu,en[7]=0,en[8]=0,en[9]=-eu,en[10]=ec,en[11]=0,en[12]=0,en[13]=0,en[14]=0,en[15]=1,en},i1.fromYRotation=function(en,el){var eu=Math.sin(el),ec=Math.cos(el);return en[0]=ec,en[1]=0,en[2]=-eu,en[3]=0,en[4]=0,en[5]=1,en[6]=0,en[7]=0,en[8]=eu,en[9]=0,en[10]=ec,en[11]=0,en[12]=0,en[13]=0,en[14]=0,en[15]=1,en},i1.fromZRotation=function(en,el){var eu=Math.sin(el),ec=Math.cos(el);return en[0]=ec,en[1]=eu,en[2]=0,en[3]=0,en[4]=-eu,en[5]=ec,en[6]=0,en[7]=0,en[8]=0,en[9]=0,en[10]=1,en[11]=0,en[12]=0,en[13]=0,en[14]=0,en[15]=1,en},i1.fromRotationTranslation=Wl,i1.fromQuat2=function(en,el){var eu=new i2.ARRAY_TYPE(3),ec=-el[0],ed=-el[1],ef=-el[2],em=el[3],e_=el[4],ew=el[5],eT=el[6],eM=el[7],eE=ec*ec+ed*ed+ef*ef+em*em;return eE>0?(eu[0]=2*(e_*em+eM*ec+ew*ef-eT*ed)/eE,eu[1]=2*(ew*em+eM*ed+eT*ec-e_*ef)/eE,eu[2]=2*(eT*em+eM*ef+e_*ed-ew*ec)/eE):(eu[0]=2*(e_*em+eM*ec+ew*ef-eT*ed),eu[1]=2*(ew*em+eM*ed+eT*ec-e_*ef),eu[2]=2*(eT*em+eM*ef+e_*ed-ew*ec)),Wl(en,el,eu),en},i1.getTranslation=function(en,el){return en[0]=el[12],en[1]=el[13],en[2]=el[14],en},i1.getScaling=Hl,i1.getRotation=function(en,el){var eu=new i2.ARRAY_TYPE(3);Hl(eu,el);var ec=1/eu[0],ed=1/eu[1],ef=1/eu[2],em=el[0]*ec,e_=el[1]*ed,ew=el[2]*ef,eT=el[4]*ec,eM=el[5]*ed,eE=el[6]*ef,eS=el[8]*ec,eA=el[9]*ed,eI=el[10]*ef,eC=em+eM+eI,eP=0;return eC>0?(eP=2*Math.sqrt(eC+1),en[3]=.25*eP,en[0]=(eE-eA)/eP,en[1]=(eS-ew)/eP,en[2]=(e_-eT)/eP):em>eM&&em>eI?(eP=2*Math.sqrt(1+em-eM-eI),en[3]=(eE-eA)/eP,en[0]=.25*eP,en[1]=(e_+eT)/eP,en[2]=(eS+ew)/eP):eM>eI?(eP=2*Math.sqrt(1+eM-em-eI),en[3]=(eS-ew)/eP,en[0]=(e_+eT)/eP,en[1]=.25*eP,en[2]=(eE+eA)/eP):(eP=2*Math.sqrt(1+eI-em-eM),en[3]=(e_-eT)/eP,en[0]=(eS+ew)/eP,en[1]=(eE+eA)/eP,en[2]=.25*eP),en},i1.fromRotationTranslationScale=function(en,el,eu,ec){var ed=el[0],ef=el[1],em=el[2],e_=el[3],ew=ed+ed,eT=ef+ef,eM=em+em,eE=ed*ew,eS=ed*eT,eA=ed*eM,eI=ef*eT,eC=ef*eM,eP=em*eM,ez=e_*ew,eD=e_*eT,eL=e_*eM,ek=ec[0],eR=ec[1],eO=ec[2];return en[0]=(1-(eI+eP))*ek,en[1]=(eS+eL)*ek,en[2]=(eA-eD)*ek,en[3]=0,en[4]=(eS-eL)*eR,en[5]=(1-(eE+eP))*eR,en[6]=(eC+ez)*eR,en[7]=0,en[8]=(eA+eD)*eO,en[9]=(eC-ez)*eO,en[10]=(1-(eE+eI))*eO,en[11]=0,en[12]=eu[0],en[13]=eu[1],en[14]=eu[2],en[15]=1,en},i1.fromRotationTranslationScaleOrigin=function(en,el,eu,ec,ed){var ef=el[0],em=el[1],e_=el[2],ew=el[3],eT=ef+ef,eM=em+em,eE=e_+e_,eS=ef*eT,eA=ef*eM,eI=ef*eE,eC=em*eM,eP=em*eE,ez=e_*eE,eD=ew*eT,eL=ew*eM,ek=ew*eE,eR=ec[0],eO=ec[1],eB=ec[2],eF=ed[0],eN=ed[1],eU=ed[2],eV=(1-(eC+ez))*eR,ej=(eA+ek)*eR,eG=(eI-eL)*eR,eq=(eA-ek)*eO,eZ=(1-(eS+ez))*eO,e$=(eP+eD)*eO,eW=(eI+eL)*eB,eH=(eP-eD)*eB,eX=(1-(eS+eC))*eB;return en[0]=eV,en[1]=ej,en[2]=eG,en[3]=0,en[4]=eq,en[5]=eZ,en[6]=e$,en[7]=0,en[8]=eW,en[9]=eH,en[10]=eX,en[11]=0,en[12]=eu[0]+eF-(eV*eF+eq*eN+eW*eU),en[13]=eu[1]+eN-(ej*eF+eZ*eN+eH*eU),en[14]=eu[2]+eU-(eG*eF+e$*eN+eX*eU),en[15]=1,en},i1.fromQuat=function(en,el){var eu=el[0],ec=el[1],ed=el[2],ef=el[3],em=eu+eu,e_=ec+ec,ew=ed+ed,eT=eu*em,eM=ec*em,eE=ec*e_,eS=ed*em,eA=ed*e_,eI=ed*ew,eC=ef*em,eP=ef*e_,ez=ef*ew;return en[0]=1-eE-eI,en[1]=eM+ez,en[2]=eS-eP,en[3]=0,en[4]=eM-ez,en[5]=1-eT-eI,en[6]=eA+eC,en[7]=0,en[8]=eS+eP,en[9]=eA-eC,en[10]=1-eT-eE,en[11]=0,en[12]=0,en[13]=0,en[14]=0,en[15]=1,en},i1.frustum=function(en,el,eu,ec,ed,ef,em){var e_=1/(eu-el),ew=1/(ed-ec),eT=1/(ef-em);return en[0]=2*ef*e_,en[1]=0,en[2]=0,en[3]=0,en[4]=0,en[5]=2*ef*ew,en[6]=0,en[7]=0,en[8]=(eu+el)*e_,en[9]=(ed+ec)*ew,en[10]=(em+ef)*eT,en[11]=-1,en[12]=0,en[13]=0,en[14]=em*ef*2*eT,en[15]=0,en},i1.perspectiveNO=Jl,i1.perspectiveZO=function(en,el,eu,ec,ed){var ef,em=1/Math.tan(el/2);return en[0]=em/eu,en[1]=0,en[2]=0,en[3]=0,en[4]=0,en[5]=em,en[6]=0,en[7]=0,en[8]=0,en[9]=0,en[11]=-1,en[12]=0,en[13]=0,en[15]=0,null!=ed&&ed!==1/0?(en[10]=ed*(ef=1/(ec-ed)),en[14]=ed*ec*ef):(en[10]=-1,en[14]=-ec),en},i1.perspectiveFromFieldOfView=function(en,el,eu,ec){var ed=Math.tan(el.upDegrees*Math.PI/180),ef=Math.tan(el.downDegrees*Math.PI/180),em=Math.tan(el.leftDegrees*Math.PI/180),e_=Math.tan(el.rightDegrees*Math.PI/180),ew=2/(em+e_),eT=2/(ed+ef);return en[0]=ew,en[1]=0,en[2]=0,en[3]=0,en[4]=0,en[5]=eT,en[6]=0,en[7]=0,en[8]=-(em-e_)*ew*.5,en[9]=(ed-ef)*eT*.5,en[10]=ec/(eu-ec),en[11]=-1,en[12]=0,en[13]=0,en[14]=ec*eu/(eu-ec),en[15]=0,en},i1.orthoNO=Ql,i1.orthoZO=function(en,el,eu,ec,ed,ef,em){var e_=1/(el-eu),ew=1/(ec-ed),eT=1/(ef-em);return en[0]=-2*e_,en[1]=0,en[2]=0,en[3]=0,en[4]=0,en[5]=-2*ew,en[6]=0,en[7]=0,en[8]=0,en[9]=0,en[10]=eT,en[11]=0,en[12]=(el+eu)*e_,en[13]=(ed+ec)*ew,en[14]=ef*eT,en[15]=1,en},i1.lookAt=function(en,el,eu,ec){var ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI=el[0],eC=el[1],eP=el[2],ez=ec[0],eD=ec[1],eL=ec[2],ek=eu[0],eR=eu[1],eO=eu[2];return Math.abs(eI-ek)<i2.EPSILON&&Math.abs(eC-eR)<i2.EPSILON&&Math.abs(eP-eO)<i2.EPSILON?Xl(en):(eM=eI-ek,eE=eC-eR,eS=eP-eO,(eA=Math.hypot(ed=eD*(eS*=eA=1/Math.hypot(eM,eE,eS))-eL*(eE*=eA),ef=eL*(eM*=eA)-ez*eS,em=ez*eE-eD*eM))?(ed*=eA=1/eA,ef*=eA,em*=eA):(ed=0,ef=0,em=0),(eA=Math.hypot(e_=eE*em-eS*ef,ew=eS*ed-eM*em,eT=eM*ef-eE*ed))?(e_*=eA=1/eA,ew*=eA,eT*=eA):(e_=0,ew=0,eT=0),en[0]=ed,en[1]=e_,en[2]=eM,en[3]=0,en[4]=ef,en[5]=ew,en[6]=eE,en[7]=0,en[8]=em,en[9]=eT,en[10]=eS,en[11]=0,en[12]=-(ed*eI+ef*eC+em*eP),en[13]=-(e_*eI+ew*eC+eT*eP),en[14]=-(eM*eI+eE*eC+eS*eP),en[15]=1,en)},i1.targetTo=function(en,el,eu,ec){var ed=el[0],ef=el[1],em=el[2],e_=ec[0],ew=ec[1],eT=ec[2],eM=ed-eu[0],eE=ef-eu[1],eS=em-eu[2],eA=eM*eM+eE*eE+eS*eS;eA>0&&(eM*=eA=1/Math.sqrt(eA),eE*=eA,eS*=eA);var eI=ew*eS-eT*eE,eC=eT*eM-e_*eS,eP=e_*eE-ew*eM;return(eA=eI*eI+eC*eC+eP*eP)>0&&(eI*=eA=1/Math.sqrt(eA),eC*=eA,eP*=eA),en[0]=eI,en[1]=eC,en[2]=eP,en[3]=0,en[4]=eE*eP-eS*eC,en[5]=eS*eI-eM*eP,en[6]=eM*eC-eE*eI,en[7]=0,en[8]=eM,en[9]=eE,en[10]=eS,en[11]=0,en[12]=ed,en[13]=ef,en[14]=em,en[15]=1,en},i1.str=function(en){return"mat4("+en[0]+", "+en[1]+", "+en[2]+", "+en[3]+", "+en[4]+", "+en[5]+", "+en[6]+", "+en[7]+", "+en[8]+", "+en[9]+", "+en[10]+", "+en[11]+", "+en[12]+", "+en[13]+", "+en[14]+", "+en[15]+")"},i1.frob=function(en){return Math.hypot(en[0],en[1],en[2],en[3],en[4],en[5],en[6],en[7],en[8],en[9],en[10],en[11],en[12],en[13],en[14],en[15])},i1.add=function(en,el,eu){return en[0]=el[0]+eu[0],en[1]=el[1]+eu[1],en[2]=el[2]+eu[2],en[3]=el[3]+eu[3],en[4]=el[4]+eu[4],en[5]=el[5]+eu[5],en[6]=el[6]+eu[6],en[7]=el[7]+eu[7],en[8]=el[8]+eu[8],en[9]=el[9]+eu[9],en[10]=el[10]+eu[10],en[11]=el[11]+eu[11],en[12]=el[12]+eu[12],en[13]=el[13]+eu[13],en[14]=el[14]+eu[14],en[15]=el[15]+eu[15],en},i1.subtract=tu,i1.multiplyScalar=function(en,el,eu){return en[0]=el[0]*eu,en[1]=el[1]*eu,en[2]=el[2]*eu,en[3]=el[3]*eu,en[4]=el[4]*eu,en[5]=el[5]*eu,en[6]=el[6]*eu,en[7]=el[7]*eu,en[8]=el[8]*eu,en[9]=el[9]*eu,en[10]=el[10]*eu,en[11]=el[11]*eu,en[12]=el[12]*eu,en[13]=el[13]*eu,en[14]=el[14]*eu,en[15]=el[15]*eu,en},i1.multiplyScalarAndAdd=function(en,el,eu,ec){return en[0]=el[0]+eu[0]*ec,en[1]=el[1]+eu[1]*ec,en[2]=el[2]+eu[2]*ec,en[3]=el[3]+eu[3]*ec,en[4]=el[4]+eu[4]*ec,en[5]=el[5]+eu[5]*ec,en[6]=el[6]+eu[6]*ec,en[7]=el[7]+eu[7]*ec,en[8]=el[8]+eu[8]*ec,en[9]=el[9]+eu[9]*ec,en[10]=el[10]+eu[10]*ec,en[11]=el[11]+eu[11]*ec,en[12]=el[12]+eu[12]*ec,en[13]=el[13]+eu[13]*ec,en[14]=el[14]+eu[14]*ec,en[15]=el[15]+eu[15]*ec,en},i1.exactEquals=function(en,el){return en[0]===el[0]&&en[1]===el[1]&&en[2]===el[2]&&en[3]===el[3]&&en[4]===el[4]&&en[5]===el[5]&&en[6]===el[6]&&en[7]===el[7]&&en[8]===el[8]&&en[9]===el[9]&&en[10]===el[10]&&en[11]===el[11]&&en[12]===el[12]&&en[13]===el[13]&&en[14]===el[14]&&en[15]===el[15]},i1.equals=function(en,el){var eu=en[0],ec=en[1],ed=en[2],ef=en[3],em=en[4],e_=en[5],ew=en[6],eT=en[7],eM=en[8],eE=en[9],eS=en[10],eA=en[11],eI=en[12],eC=en[13],eP=en[14],ez=en[15],eD=el[0],eL=el[1],ek=el[2],eR=el[3],eO=el[4],eB=el[5],eF=el[6],eN=el[7],eU=el[8],eV=el[9],ej=el[10],eG=el[11],eq=el[12],eZ=el[13],e$=el[14],eW=el[15];return Math.abs(eu-eD)<=i2.EPSILON*Math.max(1,Math.abs(eu),Math.abs(eD))&&Math.abs(ec-eL)<=i2.EPSILON*Math.max(1,Math.abs(ec),Math.abs(eL))&&Math.abs(ed-ek)<=i2.EPSILON*Math.max(1,Math.abs(ed),Math.abs(ek))&&Math.abs(ef-eR)<=i2.EPSILON*Math.max(1,Math.abs(ef),Math.abs(eR))&&Math.abs(em-eO)<=i2.EPSILON*Math.max(1,Math.abs(em),Math.abs(eO))&&Math.abs(e_-eB)<=i2.EPSILON*Math.max(1,Math.abs(e_),Math.abs(eB))&&Math.abs(ew-eF)<=i2.EPSILON*Math.max(1,Math.abs(ew),Math.abs(eF))&&Math.abs(eT-eN)<=i2.EPSILON*Math.max(1,Math.abs(eT),Math.abs(eN))&&Math.abs(eM-eU)<=i2.EPSILON*Math.max(1,Math.abs(eM),Math.abs(eU))&&Math.abs(eE-eV)<=i2.EPSILON*Math.max(1,Math.abs(eE),Math.abs(eV))&&Math.abs(eS-ej)<=i2.EPSILON*Math.max(1,Math.abs(eS),Math.abs(ej))&&Math.abs(eA-eG)<=i2.EPSILON*Math.max(1,Math.abs(eA),Math.abs(eG))&&Math.abs(eI-eq)<=i2.EPSILON*Math.max(1,Math.abs(eI),Math.abs(eq))&&Math.abs(eC-eZ)<=i2.EPSILON*Math.max(1,Math.abs(eC),Math.abs(eZ))&&Math.abs(eP-e$)<=i2.EPSILON*Math.max(1,Math.abs(eP),Math.abs(e$))&&Math.abs(ez-eW)<=i2.EPSILON*Math.max(1,Math.abs(ez),Math.abs(eW))},i1.sub=i1.mul=i1.ortho=i1.perspective=void 0;var i2=function(en,el){if(en&&en.__esModule)return en;if(null===en||"object"!==Gl(en)&&"function"!=typeof en)return{default:en};var eu=Zl(void 0);if(eu&&eu.has(en))return eu.get(en);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var ef in en)if("default"!==ef&&Object.prototype.hasOwnProperty.call(en,ef)){var em=ed?Object.getOwnPropertyDescriptor(en,ef):null;em&&(em.get||em.set)?Object.defineProperty(ec,ef,em):ec[ef]=en[ef]}return ec.default=en,eu&&eu.set(en,ec),ec}(iq);function Zl(en){if("function"!=typeof WeakMap)return null;var el=new WeakMap,eu=new WeakMap;return(Zl=function(en){return en?eu:el})(en)}function Xl(en){return en[0]=1,en[1]=0,en[2]=0,en[3]=0,en[4]=0,en[5]=1,en[6]=0,en[7]=0,en[8]=0,en[9]=0,en[10]=1,en[11]=0,en[12]=0,en[13]=0,en[14]=0,en[15]=1,en}function Kl(en,el,eu){var ec=el[0],ed=el[1],ef=el[2],em=el[3],e_=el[4],ew=el[5],eT=el[6],eM=el[7],eE=el[8],eS=el[9],eA=el[10],eI=el[11],eC=el[12],eP=el[13],ez=el[14],eD=el[15],eL=eu[0],ek=eu[1],eR=eu[2],eO=eu[3];return en[0]=eL*ec+ek*e_+eR*eE+eO*eC,en[1]=eL*ed+ek*ew+eR*eS+eO*eP,en[2]=eL*ef+ek*eT+eR*eA+eO*ez,en[3]=eL*em+ek*eM+eR*eI+eO*eD,en[4]=(eL=eu[4])*ec+(ek=eu[5])*e_+(eR=eu[6])*eE+(eO=eu[7])*eC,en[5]=eL*ed+ek*ew+eR*eS+eO*eP,en[6]=eL*ef+ek*eT+eR*eA+eO*ez,en[7]=eL*em+ek*eM+eR*eI+eO*eD,en[8]=(eL=eu[8])*ec+(ek=eu[9])*e_+(eR=eu[10])*eE+(eO=eu[11])*eC,en[9]=eL*ed+ek*ew+eR*eS+eO*eP,en[10]=eL*ef+ek*eT+eR*eA+eO*ez,en[11]=eL*em+ek*eM+eR*eI+eO*eD,en[12]=(eL=eu[12])*ec+(ek=eu[13])*e_+(eR=eu[14])*eE+(eO=eu[15])*eC,en[13]=eL*ed+ek*ew+eR*eS+eO*eP,en[14]=eL*ef+ek*eT+eR*eA+eO*ez,en[15]=eL*em+ek*eM+eR*eI+eO*eD,en}function Wl(en,el,eu){var ec=el[0],ed=el[1],ef=el[2],em=el[3],e_=ec+ec,ew=ed+ed,eT=ef+ef,eM=ec*e_,eE=ec*ew,eS=ec*eT,eA=ed*ew,eI=ed*eT,eC=ef*eT,eP=em*e_,ez=em*ew,eD=em*eT;return en[0]=1-(eA+eC),en[1]=eE+eD,en[2]=eS-ez,en[3]=0,en[4]=eE-eD,en[5]=1-(eM+eC),en[6]=eI+eP,en[7]=0,en[8]=eS+ez,en[9]=eI-eP,en[10]=1-(eM+eA),en[11]=0,en[12]=eu[0],en[13]=eu[1],en[14]=eu[2],en[15]=1,en}function Hl(en,el){var eu=el[4],ec=el[5],ed=el[6],ef=el[8],em=el[9],e_=el[10];return en[0]=Math.hypot(el[0],el[1],el[2]),en[1]=Math.hypot(eu,ec,ed),en[2]=Math.hypot(ef,em,e_),en}function Jl(en,el,eu,ec,ed){var ef,em=1/Math.tan(el/2);return en[0]=em/eu,en[1]=0,en[2]=0,en[3]=0,en[4]=0,en[5]=em,en[6]=0,en[7]=0,en[8]=0,en[9]=0,en[11]=-1,en[12]=0,en[13]=0,en[15]=0,null!=ed&&ed!==1/0?(en[10]=(ed+ec)*(ef=1/(ec-ed)),en[14]=2*ed*ec*ef):(en[10]=-1,en[14]=-2*ec),en}function Ql(en,el,eu,ec,ed,ef,em){var e_=1/(el-eu),ew=1/(ec-ed),eT=1/(ef-em);return en[0]=-2*e_,en[1]=0,en[2]=0,en[3]=0,en[4]=0,en[5]=-2*ew,en[6]=0,en[7]=0,en[8]=0,en[9]=0,en[10]=2*eT,en[11]=0,en[12]=(el+eu)*e_,en[13]=(ed+ec)*ew,en[14]=(em+ef)*eT,en[15]=1,en}function tu(en,el,eu){return en[0]=el[0]-eu[0],en[1]=el[1]-eu[1],en[2]=el[2]-eu[2],en[3]=el[3]-eu[3],en[4]=el[4]-eu[4],en[5]=el[5]-eu[5],en[6]=el[6]-eu[6],en[7]=el[7]-eu[7],en[8]=el[8]-eu[8],en[9]=el[9]-eu[9],en[10]=el[10]-eu[10],en[11]=el[11]-eu[11],en[12]=el[12]-eu[12],en[13]=el[13]-eu[13],en[14]=el[14]-eu[14],en[15]=el[15]-eu[15],en}i1.perspective=Jl,i1.ortho=Ql,i1.mul=Kl,i1.sub=tu;var i3={},i4={};function nu(en){return(nu="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(en){return typeof en}:function(en){return en&&"function"==typeof Symbol&&en.constructor===Symbol&&en!==Symbol.prototype?"symbol":typeof en})(en)}Object.defineProperty(i4,"__esModule",{value:!0}),i4.create=au,i4.clone=function(en){var el=new i5.ARRAY_TYPE(3);return el[0]=en[0],el[1]=en[1],el[2]=en[2],el},i4.length=ou,i4.fromValues=function(en,el,eu){var ec=new i5.ARRAY_TYPE(3);return ec[0]=en,ec[1]=el,ec[2]=eu,ec},i4.copy=function(en,el){return en[0]=el[0],en[1]=el[1],en[2]=el[2],en},i4.set=function(en,el,eu,ec){return en[0]=el,en[1]=eu,en[2]=ec,en},i4.add=function(en,el,eu){return en[0]=el[0]+eu[0],en[1]=el[1]+eu[1],en[2]=el[2]+eu[2],en},i4.subtract=lu,i4.multiply=uu,i4.divide=cu,i4.ceil=function(en,el){return en[0]=Math.ceil(el[0]),en[1]=Math.ceil(el[1]),en[2]=Math.ceil(el[2]),en},i4.floor=function(en,el){return en[0]=Math.floor(el[0]),en[1]=Math.floor(el[1]),en[2]=Math.floor(el[2]),en},i4.min=function(en,el,eu){return en[0]=Math.min(el[0],eu[0]),en[1]=Math.min(el[1],eu[1]),en[2]=Math.min(el[2],eu[2]),en},i4.max=function(en,el,eu){return en[0]=Math.max(el[0],eu[0]),en[1]=Math.max(el[1],eu[1]),en[2]=Math.max(el[2],eu[2]),en},i4.round=function(en,el){return en[0]=Math.round(el[0]),en[1]=Math.round(el[1]),en[2]=Math.round(el[2]),en},i4.scale=function(en,el,eu){return en[0]=el[0]*eu,en[1]=el[1]*eu,en[2]=el[2]*eu,en},i4.scaleAndAdd=function(en,el,eu,ec){return en[0]=el[0]+eu[0]*ec,en[1]=el[1]+eu[1]*ec,en[2]=el[2]+eu[2]*ec,en},i4.distance=hu,i4.squaredDistance=pu,i4.squaredLength=fu,i4.negate=function(en,el){return en[0]=-el[0],en[1]=-el[1],en[2]=-el[2],en},i4.inverse=function(en,el){return en[0]=1/el[0],en[1]=1/el[1],en[2]=1/el[2],en},i4.normalize=function(en,el){var eu=el[0],ec=el[1],ed=el[2],ef=eu*eu+ec*ec+ed*ed;return ef>0&&(ef=1/Math.sqrt(ef)),en[0]=el[0]*ef,en[1]=el[1]*ef,en[2]=el[2]*ef,en},i4.dot=du,i4.cross=function(en,el,eu){var ec=el[0],ed=el[1],ef=el[2],em=eu[0],e_=eu[1],ew=eu[2];return en[0]=ed*ew-ef*e_,en[1]=ef*em-ec*ew,en[2]=ec*e_-ed*em,en},i4.lerp=function(en,el,eu,ec){var ed=el[0],ef=el[1],em=el[2];return en[0]=ed+ec*(eu[0]-ed),en[1]=ef+ec*(eu[1]-ef),en[2]=em+ec*(eu[2]-em),en},i4.hermite=function(en,el,eu,ec,ed,ef){var em=ef*ef,e_=em*(2*ef-3)+1,ew=em*(ef-2)+ef,eT=em*(ef-1),eM=em*(3-2*ef);return en[0]=el[0]*e_+eu[0]*ew+ec[0]*eT+ed[0]*eM,en[1]=el[1]*e_+eu[1]*ew+ec[1]*eT+ed[1]*eM,en[2]=el[2]*e_+eu[2]*ew+ec[2]*eT+ed[2]*eM,en},i4.bezier=function(en,el,eu,ec,ed,ef){var em=1-ef,e_=em*em,ew=ef*ef,eT=e_*em,eM=3*ef*e_,eE=3*ew*em,eS=ew*ef;return en[0]=el[0]*eT+eu[0]*eM+ec[0]*eE+ed[0]*eS,en[1]=el[1]*eT+eu[1]*eM+ec[1]*eE+ed[1]*eS,en[2]=el[2]*eT+eu[2]*eM+ec[2]*eE+ed[2]*eS,en},i4.random=function(en,el){el=el||1;var eu=2*i5.RANDOM()*Math.PI,ec=2*i5.RANDOM()-1,ed=Math.sqrt(1-ec*ec)*el;return en[0]=Math.cos(eu)*ed,en[1]=Math.sin(eu)*ed,en[2]=ec*el,en},i4.transformMat4=function(en,el,eu){var ec=el[0],ed=el[1],ef=el[2],em=eu[3]*ec+eu[7]*ed+eu[11]*ef+eu[15];return en[0]=(eu[0]*ec+eu[4]*ed+eu[8]*ef+eu[12])/(em=em||1),en[1]=(eu[1]*ec+eu[5]*ed+eu[9]*ef+eu[13])/em,en[2]=(eu[2]*ec+eu[6]*ed+eu[10]*ef+eu[14])/em,en},i4.transformMat3=function(en,el,eu){var ec=el[0],ed=el[1],ef=el[2];return en[0]=ec*eu[0]+ed*eu[3]+ef*eu[6],en[1]=ec*eu[1]+ed*eu[4]+ef*eu[7],en[2]=ec*eu[2]+ed*eu[5]+ef*eu[8],en},i4.transformQuat=function(en,el,eu){var ec=eu[0],ed=eu[1],ef=eu[2],em=el[0],e_=el[1],ew=el[2],eT=ed*ew-ef*e_,eM=ef*em-ec*ew,eE=ec*e_-ed*em,eS=ed*eE-ef*eM,eA=ef*eT-ec*eE,eI=ec*eM-ed*eT,eC=2*eu[3];return eM*=eC,eE*=eC,eA*=2,eI*=2,en[0]=em+(eT*=eC)+(eS*=2),en[1]=e_+eM+eA,en[2]=ew+eE+eI,en},i4.rotateX=function(en,el,eu,ec){var ed=[],ef=[];return ed[0]=el[0]-eu[0],ed[1]=el[1]-eu[1],ed[2]=el[2]-eu[2],ef[0]=ed[0],ef[1]=ed[1]*Math.cos(ec)-ed[2]*Math.sin(ec),ef[2]=ed[1]*Math.sin(ec)+ed[2]*Math.cos(ec),en[0]=ef[0]+eu[0],en[1]=ef[1]+eu[1],en[2]=ef[2]+eu[2],en},i4.rotateY=function(en,el,eu,ec){var ed=[],ef=[];return ed[0]=el[0]-eu[0],ed[1]=el[1]-eu[1],ed[2]=el[2]-eu[2],ef[0]=ed[2]*Math.sin(ec)+ed[0]*Math.cos(ec),ef[1]=ed[1],ef[2]=ed[2]*Math.cos(ec)-ed[0]*Math.sin(ec),en[0]=ef[0]+eu[0],en[1]=ef[1]+eu[1],en[2]=ef[2]+eu[2],en},i4.rotateZ=function(en,el,eu,ec){var ed=[],ef=[];return ed[0]=el[0]-eu[0],ed[1]=el[1]-eu[1],ed[2]=el[2]-eu[2],ef[0]=ed[0]*Math.cos(ec)-ed[1]*Math.sin(ec),ef[1]=ed[0]*Math.sin(ec)+ed[1]*Math.cos(ec),ef[2]=ed[2],en[0]=ef[0]+eu[0],en[1]=ef[1]+eu[1],en[2]=ef[2]+eu[2],en},i4.angle=function(en,el){var eu=en[0],ec=en[1],ed=en[2],ef=el[0],em=el[1],e_=el[2],ew=Math.sqrt(eu*eu+ec*ec+ed*ed)*Math.sqrt(ef*ef+em*em+e_*e_);return Math.acos(Math.min(Math.max(ew&&du(en,el)/ew,-1),1))},i4.zero=function(en){return en[0]=0,en[1]=0,en[2]=0,en},i4.str=function(en){return"vec3("+en[0]+", "+en[1]+", "+en[2]+")"},i4.exactEquals=function(en,el){return en[0]===el[0]&&en[1]===el[1]&&en[2]===el[2]},i4.equals=function(en,el){var eu=en[0],ec=en[1],ed=en[2],ef=el[0],em=el[1],e_=el[2];return Math.abs(eu-ef)<=i5.EPSILON*Math.max(1,Math.abs(eu),Math.abs(ef))&&Math.abs(ec-em)<=i5.EPSILON*Math.max(1,Math.abs(ec),Math.abs(em))&&Math.abs(ed-e_)<=i5.EPSILON*Math.max(1,Math.abs(ed),Math.abs(e_))},i4.forEach=i4.sqrLen=i4.len=i4.sqrDist=i4.dist=i4.div=i4.mul=i4.sub=void 0;var i5=function(en,el){if(en&&en.__esModule)return en;if(null===en||"object"!==nu(en)&&"function"!=typeof en)return{default:en};var eu=su(void 0);if(eu&&eu.has(en))return eu.get(en);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var ef in en)if("default"!==ef&&Object.prototype.hasOwnProperty.call(en,ef)){var em=ed?Object.getOwnPropertyDescriptor(en,ef):null;em&&(em.get||em.set)?Object.defineProperty(ec,ef,em):ec[ef]=en[ef]}return ec.default=en,eu&&eu.set(en,ec),ec}(iq);function su(en){if("function"!=typeof WeakMap)return null;var el=new WeakMap,eu=new WeakMap;return(su=function(en){return en?eu:el})(en)}function au(){var en=new i5.ARRAY_TYPE(3);return i5.ARRAY_TYPE!=Float32Array&&(en[0]=0,en[1]=0,en[2]=0),en}function ou(en){return Math.hypot(en[0],en[1],en[2])}function lu(en,el,eu){return en[0]=el[0]-eu[0],en[1]=el[1]-eu[1],en[2]=el[2]-eu[2],en}function uu(en,el,eu){return en[0]=el[0]*eu[0],en[1]=el[1]*eu[1],en[2]=el[2]*eu[2],en}function cu(en,el,eu){return en[0]=el[0]/eu[0],en[1]=el[1]/eu[1],en[2]=el[2]/eu[2],en}function hu(en,el){return Math.hypot(el[0]-en[0],el[1]-en[1],el[2]-en[2])}function pu(en,el){var eu=el[0]-en[0],ec=el[1]-en[1],ed=el[2]-en[2];return eu*eu+ec*ec+ed*ed}function fu(en){var el=en[0],eu=en[1],ec=en[2];return el*el+eu*eu+ec*ec}function du(en,el){return en[0]*el[0]+en[1]*el[1]+en[2]*el[2]}i4.sub=lu,i4.mul=uu,i4.div=cu,i4.dist=hu,i4.sqrDist=pu,i4.len=ou,i4.sqrLen=fu;var i6,i8=(i6=au(),function(en,el,eu,ec,ed,ef){var em,e_;for(el||(el=3),eu||(eu=0),e_=ec?Math.min(ec*el+eu,en.length):en.length,em=eu;em<e_;em+=el)i6[0]=en[em],i6[1]=en[em+1],i6[2]=en[em+2],ed(i6,i6,ef),en[em]=i6[0],en[em+1]=i6[1],en[em+2]=i6[2];return en});i4.forEach=i8;var i7={};function xu(en){return(xu="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(en){return typeof en}:function(en){return en&&"function"==typeof Symbol&&en.constructor===Symbol&&en!==Symbol.prototype?"symbol":typeof en})(en)}Object.defineProperty(i7,"__esModule",{value:!0}),i7.create=_u,i7.clone=function(en){var el=new i9.ARRAY_TYPE(4);return el[0]=en[0],el[1]=en[1],el[2]=en[2],el[3]=en[3],el},i7.fromValues=function(en,el,eu,ec){var ed=new i9.ARRAY_TYPE(4);return ed[0]=en,ed[1]=el,ed[2]=eu,ed[3]=ec,ed},i7.copy=function(en,el){return en[0]=el[0],en[1]=el[1],en[2]=el[2],en[3]=el[3],en},i7.set=function(en,el,eu,ec,ed){return en[0]=el,en[1]=eu,en[2]=ec,en[3]=ed,en},i7.add=function(en,el,eu){return en[0]=el[0]+eu[0],en[1]=el[1]+eu[1],en[2]=el[2]+eu[2],en[3]=el[3]+eu[3],en},i7.subtract=wu,i7.multiply=Mu,i7.divide=Au,i7.ceil=function(en,el){return en[0]=Math.ceil(el[0]),en[1]=Math.ceil(el[1]),en[2]=Math.ceil(el[2]),en[3]=Math.ceil(el[3]),en},i7.floor=function(en,el){return en[0]=Math.floor(el[0]),en[1]=Math.floor(el[1]),en[2]=Math.floor(el[2]),en[3]=Math.floor(el[3]),en},i7.min=function(en,el,eu){return en[0]=Math.min(el[0],eu[0]),en[1]=Math.min(el[1],eu[1]),en[2]=Math.min(el[2],eu[2]),en[3]=Math.min(el[3],eu[3]),en},i7.max=function(en,el,eu){return en[0]=Math.max(el[0],eu[0]),en[1]=Math.max(el[1],eu[1]),en[2]=Math.max(el[2],eu[2]),en[3]=Math.max(el[3],eu[3]),en},i7.round=function(en,el){return en[0]=Math.round(el[0]),en[1]=Math.round(el[1]),en[2]=Math.round(el[2]),en[3]=Math.round(el[3]),en},i7.scale=function(en,el,eu){return en[0]=el[0]*eu,en[1]=el[1]*eu,en[2]=el[2]*eu,en[3]=el[3]*eu,en},i7.scaleAndAdd=function(en,el,eu,ec){return en[0]=el[0]+eu[0]*ec,en[1]=el[1]+eu[1]*ec,en[2]=el[2]+eu[2]*ec,en[3]=el[3]+eu[3]*ec,en},i7.distance=Su,i7.squaredDistance=Iu,i7.length=ku,i7.squaredLength=Tu,i7.negate=function(en,el){return en[0]=-el[0],en[1]=-el[1],en[2]=-el[2],en[3]=-el[3],en},i7.inverse=function(en,el){return en[0]=1/el[0],en[1]=1/el[1],en[2]=1/el[2],en[3]=1/el[3],en},i7.normalize=function(en,el){var eu=el[0],ec=el[1],ed=el[2],ef=el[3],em=eu*eu+ec*ec+ed*ed+ef*ef;return em>0&&(em=1/Math.sqrt(em)),en[0]=eu*em,en[1]=ec*em,en[2]=ed*em,en[3]=ef*em,en},i7.dot=function(en,el){return en[0]*el[0]+en[1]*el[1]+en[2]*el[2]+en[3]*el[3]},i7.cross=function(en,el,eu,ec){var ed=eu[0]*ec[1]-eu[1]*ec[0],ef=eu[0]*ec[2]-eu[2]*ec[0],em=eu[0]*ec[3]-eu[3]*ec[0],e_=eu[1]*ec[2]-eu[2]*ec[1],ew=eu[1]*ec[3]-eu[3]*ec[1],eT=eu[2]*ec[3]-eu[3]*ec[2],eM=el[0],eE=el[1],eS=el[2],eA=el[3];return en[0]=eE*eT-eS*ew+eA*e_,en[1]=-eM*eT+eS*em-eA*ef,en[2]=eM*ew-eE*em+eA*ed,en[3]=-eM*e_+eE*ef-eS*ed,en},i7.lerp=function(en,el,eu,ec){var ed=el[0],ef=el[1],em=el[2],e_=el[3];return en[0]=ed+ec*(eu[0]-ed),en[1]=ef+ec*(eu[1]-ef),en[2]=em+ec*(eu[2]-em),en[3]=e_+ec*(eu[3]-e_),en},i7.random=function(en,el){el=el||1;do em=(eu=2*i9.RANDOM()-1)*eu+(ec=2*i9.RANDOM()-1)*ec;while(em>=1);do e_=(ed=2*i9.RANDOM()-1)*ed+(ef=2*i9.RANDOM()-1)*ef;while(e_>=1);var eu,ec,ed,ef,em,e_,ew=Math.sqrt((1-em)/e_);return en[0]=el*eu,en[1]=el*ec,en[2]=el*ed*ew,en[3]=el*ef*ew,en},i7.transformMat4=function(en,el,eu){var ec=el[0],ed=el[1],ef=el[2],em=el[3];return en[0]=eu[0]*ec+eu[4]*ed+eu[8]*ef+eu[12]*em,en[1]=eu[1]*ec+eu[5]*ed+eu[9]*ef+eu[13]*em,en[2]=eu[2]*ec+eu[6]*ed+eu[10]*ef+eu[14]*em,en[3]=eu[3]*ec+eu[7]*ed+eu[11]*ef+eu[15]*em,en},i7.transformQuat=function(en,el,eu){var ec=el[0],ed=el[1],ef=el[2],em=eu[0],e_=eu[1],ew=eu[2],eT=eu[3],eM=eT*ec+e_*ef-ew*ed,eE=eT*ed+ew*ec-em*ef,eS=eT*ef+em*ed-e_*ec,eA=-em*ec-e_*ed-ew*ef;return en[0]=eM*eT+-(eA*em)+-(eE*ew)- -(eS*e_),en[1]=eE*eT+-(eA*e_)+-(eS*em)- -(eM*ew),en[2]=eS*eT+-(eA*ew)+-(eM*e_)- -(eE*em),en[3]=el[3],en},i7.zero=function(en){return en[0]=0,en[1]=0,en[2]=0,en[3]=0,en},i7.str=function(en){return"vec4("+en[0]+", "+en[1]+", "+en[2]+", "+en[3]+")"},i7.exactEquals=function(en,el){return en[0]===el[0]&&en[1]===el[1]&&en[2]===el[2]&&en[3]===el[3]},i7.equals=function(en,el){var eu=en[0],ec=en[1],ed=en[2],ef=en[3],em=el[0],e_=el[1],ew=el[2],eT=el[3];return Math.abs(eu-em)<=i9.EPSILON*Math.max(1,Math.abs(eu),Math.abs(em))&&Math.abs(ec-e_)<=i9.EPSILON*Math.max(1,Math.abs(ec),Math.abs(e_))&&Math.abs(ed-ew)<=i9.EPSILON*Math.max(1,Math.abs(ed),Math.abs(ew))&&Math.abs(ef-eT)<=i9.EPSILON*Math.max(1,Math.abs(ef),Math.abs(eT))},i7.forEach=i7.sqrLen=i7.len=i7.sqrDist=i7.dist=i7.div=i7.mul=i7.sub=void 0;var i9=function(en,el){if(en&&en.__esModule)return en;if(null===en||"object"!==xu(en)&&"function"!=typeof en)return{default:en};var eu=bu(void 0);if(eu&&eu.has(en))return eu.get(en);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var ef in en)if("default"!==ef&&Object.prototype.hasOwnProperty.call(en,ef)){var em=ed?Object.getOwnPropertyDescriptor(en,ef):null;em&&(em.get||em.set)?Object.defineProperty(ec,ef,em):ec[ef]=en[ef]}return ec.default=en,eu&&eu.set(en,ec),ec}(iq);function bu(en){if("function"!=typeof WeakMap)return null;var el=new WeakMap,eu=new WeakMap;return(bu=function(en){return en?eu:el})(en)}function _u(){var en=new i9.ARRAY_TYPE(4);return i9.ARRAY_TYPE!=Float32Array&&(en[0]=0,en[1]=0,en[2]=0,en[3]=0),en}function wu(en,el,eu){return en[0]=el[0]-eu[0],en[1]=el[1]-eu[1],en[2]=el[2]-eu[2],en[3]=el[3]-eu[3],en}function Mu(en,el,eu){return en[0]=el[0]*eu[0],en[1]=el[1]*eu[1],en[2]=el[2]*eu[2],en[3]=el[3]*eu[3],en}function Au(en,el,eu){return en[0]=el[0]/eu[0],en[1]=el[1]/eu[1],en[2]=el[2]/eu[2],en[3]=el[3]/eu[3],en}function Su(en,el){return Math.hypot(el[0]-en[0],el[1]-en[1],el[2]-en[2],el[3]-en[3])}function Iu(en,el){var eu=el[0]-en[0],ec=el[1]-en[1],ed=el[2]-en[2],ef=el[3]-en[3];return eu*eu+ec*ec+ed*ed+ef*ef}function ku(en){return Math.hypot(en[0],en[1],en[2],en[3])}function Tu(en){var el=en[0],eu=en[1],ec=en[2],ed=en[3];return el*el+eu*eu+ec*ec+ed*ed}i7.sub=wu,i7.mul=Mu,i7.div=Au,i7.dist=Su,i7.sqrDist=Iu,i7.len=ku,i7.sqrLen=Tu;var rt=(r_=_u(),function(en,el,eu,ec,ed,ef){var em,e_;for(el||(el=4),eu||(eu=0),e_=ec?Math.min(ec*el+eu,en.length):en.length,em=eu;em<e_;em+=el)r_[0]=en[em],r_[1]=en[em+1],r_[2]=en[em+2],r_[3]=en[em+3],ed(r_,r_,ef),en[em]=r_[0],en[em+1]=r_[1],en[em+2]=r_[2],en[em+3]=r_[3];return en});function zu(en){return(zu="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(en){return typeof en}:function(en){return en&&"function"==typeof Symbol&&en.constructor===Symbol&&en!==Symbol.prototype?"symbol":typeof en})(en)}i7.forEach=rt,Object.defineProperty(i3,"__esModule",{value:!0}),i3.create=Vu,i3.identity=function(en){return en[0]=0,en[1]=0,en[2]=0,en[3]=1,en},i3.setAxisAngle=Ou,i3.getAxisAngle=function(en,el){var eu=2*Math.acos(el[3]),ec=Math.sin(eu/2);return ec>ri.EPSILON?(en[0]=el[0]/ec,en[1]=el[1]/ec,en[2]=el[2]/ec):(en[0]=1,en[1]=0,en[2]=0),eu},i3.getAngle=function(en,el){var eu=rd(en,el);return Math.acos(2*eu*eu-1)},i3.multiply=Fu,i3.rotateX=function(en,el,eu){eu*=.5;var ec=el[0],ed=el[1],ef=el[2],em=el[3],e_=Math.sin(eu),ew=Math.cos(eu);return en[0]=ec*ew+em*e_,en[1]=ed*ew+ef*e_,en[2]=ef*ew-ed*e_,en[3]=em*ew-ec*e_,en},i3.rotateY=function(en,el,eu){eu*=.5;var ec=el[0],ed=el[1],ef=el[2],em=el[3],e_=Math.sin(eu),ew=Math.cos(eu);return en[0]=ec*ew-ef*e_,en[1]=ed*ew+em*e_,en[2]=ef*ew+ec*e_,en[3]=em*ew-ed*e_,en},i3.rotateZ=function(en,el,eu){eu*=.5;var ec=el[0],ed=el[1],ef=el[2],em=el[3],e_=Math.sin(eu),ew=Math.cos(eu);return en[0]=ec*ew+ed*e_,en[1]=ed*ew-ec*e_,en[2]=ef*ew+em*e_,en[3]=em*ew-ef*e_,en},i3.calculateW=function(en,el){var eu=el[0],ec=el[1],ed=el[2];return en[0]=eu,en[1]=ec,en[2]=ed,en[3]=Math.sqrt(Math.abs(1-eu*eu-ec*ec-ed*ed)),en},i3.exp=ju,i3.ln=Uu,i3.pow=function(en,el,eu){return Uu(en,el),rc(en,en,eu),ju(en,en),en},i3.slerp=Nu,i3.random=function(en){var el=ri.RANDOM(),eu=ri.RANDOM(),ec=ri.RANDOM(),ed=Math.sqrt(1-el),ef=Math.sqrt(el);return en[0]=ed*Math.sin(2*Math.PI*eu),en[1]=ed*Math.cos(2*Math.PI*eu),en[2]=ef*Math.sin(2*Math.PI*ec),en[3]=ef*Math.cos(2*Math.PI*ec),en},i3.invert=function(en,el){var eu=el[0],ec=el[1],ed=el[2],ef=el[3],em=eu*eu+ec*ec+ed*ed+ef*ef,e_=em?1/em:0;return en[0]=-eu*e_,en[1]=-ec*e_,en[2]=-ed*e_,en[3]=ef*e_,en},i3.conjugate=function(en,el){return en[0]=-el[0],en[1]=-el[1],en[2]=-el[2],en[3]=el[3],en},i3.fromMat3=$u,i3.fromEuler=function(en,el,eu,ec){var ed=.5*Math.PI/180;el*=ed,eu*=ed,ec*=ed;var ef=Math.sin(el),em=Math.cos(el),e_=Math.sin(eu),ew=Math.cos(eu),eT=Math.sin(ec),eM=Math.cos(ec);return en[0]=ef*ew*eM-em*e_*eT,en[1]=em*e_*eM+ef*ew*eT,en[2]=em*ew*eT-ef*e_*eM,en[3]=em*ew*eM+ef*e_*eT,en},i3.str=function(en){return"quat("+en[0]+", "+en[1]+", "+en[2]+", "+en[3]+")"},i3.setAxes=i3.sqlerp=i3.rotationTo=i3.equals=i3.exactEquals=i3.normalize=i3.sqrLen=i3.squaredLength=i3.len=i3.length=i3.lerp=i3.dot=i3.scale=i3.mul=i3.add=i3.set=i3.copy=i3.fromValues=i3.clone=void 0;var ri=Lu(iq),rr=Lu(iQ),ra=Lu(i4),ru=Lu(i7);function Ru(en){if("function"!=typeof WeakMap)return null;var el=new WeakMap,eu=new WeakMap;return(Ru=function(en){return en?eu:el})(en)}function Lu(en,el){if(!el&&en&&en.__esModule)return en;if(null===en||"object"!==zu(en)&&"function"!=typeof en)return{default:en};var eu=Ru(el);if(eu&&eu.has(en))return eu.get(en);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var ef in en)if("default"!==ef&&Object.prototype.hasOwnProperty.call(en,ef)){var em=ed?Object.getOwnPropertyDescriptor(en,ef):null;em&&(em.get||em.set)?Object.defineProperty(ec,ef,em):ec[ef]=en[ef]}return ec.default=en,eu&&eu.set(en,ec),ec}function Vu(){var en=new ri.ARRAY_TYPE(4);return ri.ARRAY_TYPE!=Float32Array&&(en[0]=0,en[1]=0,en[2]=0),en[3]=1,en}function Ou(en,el,eu){var ec=Math.sin(eu*=.5);return en[0]=ec*el[0],en[1]=ec*el[1],en[2]=ec*el[2],en[3]=Math.cos(eu),en}function Fu(en,el,eu){var ec=el[0],ed=el[1],ef=el[2],em=el[3],e_=eu[0],ew=eu[1],eT=eu[2],eM=eu[3];return en[0]=ec*eM+em*e_+ed*eT-ef*ew,en[1]=ed*eM+em*ew+ef*e_-ec*eT,en[2]=ef*eM+em*eT+ec*ew-ed*e_,en[3]=em*eM-ec*e_-ed*ew-ef*eT,en}function ju(en,el){var eu=el[0],ec=el[1],ed=el[2],ef=el[3],em=Math.sqrt(eu*eu+ec*ec+ed*ed),e_=Math.exp(ef),ew=em>0?e_*Math.sin(em)/em:0;return en[0]=eu*ew,en[1]=ec*ew,en[2]=ed*ew,en[3]=e_*Math.cos(em),en}function Uu(en,el){var eu=el[0],ec=el[1],ed=el[2],ef=el[3],em=Math.sqrt(eu*eu+ec*ec+ed*ed),e_=em>0?Math.atan2(em,ef)/em:0;return en[0]=eu*e_,en[1]=ec*e_,en[2]=ed*e_,en[3]=.5*Math.log(eu*eu+ec*ec+ed*ed+ef*ef),en}function Nu(en,el,eu,ec){var ed,ef,em,e_,ew,eT=el[0],eM=el[1],eE=el[2],eS=el[3],eA=eu[0],eI=eu[1],eC=eu[2],eP=eu[3];return(ef=eT*eA+eM*eI+eE*eC+eS*eP)<0&&(ef=-ef,eA=-eA,eI=-eI,eC=-eC,eP=-eP),1-ef>ri.EPSILON?(em=Math.sin(ed=Math.acos(ef)),e_=Math.sin((1-ec)*ed)/em,ew=Math.sin(ec*ed)/em):(e_=1-ec,ew=ec),en[0]=e_*eT+ew*eA,en[1]=e_*eM+ew*eI,en[2]=e_*eE+ew*eC,en[3]=e_*eS+ew*eP,en}function $u(en,el){var eu,ec=el[0]+el[4]+el[8];if(ec>0)eu=Math.sqrt(ec+1),en[3]=.5*eu,en[0]=(el[5]-el[7])*(eu=.5/eu),en[1]=(el[6]-el[2])*eu,en[2]=(el[1]-el[3])*eu;else{var ed=0;el[4]>el[0]&&(ed=1),el[8]>el[3*ed+ed]&&(ed=2);var ef=(ed+1)%3,em=(ed+2)%3;eu=Math.sqrt(el[3*ed+ed]-el[3*ef+ef]-el[3*em+em]+1),en[ed]=.5*eu,en[3]=(el[3*ef+em]-el[3*em+ef])*(eu=.5/eu),en[ef]=(el[3*ef+ed]+el[3*ed+ef])*eu,en[em]=(el[3*em+ed]+el[3*ed+em])*eu}return en}i3.clone=ru.clone,i3.fromValues=ru.fromValues,i3.copy=ru.copy,i3.set=ru.set,i3.add=ru.add,i3.mul=Fu;var rc=ru.scale;i3.scale=rc;var rd=ru.dot;i3.dot=rd,i3.lerp=ru.lerp;var rp=ru.length;i3.length=rp,i3.len=rp;var rf=ru.squaredLength;i3.squaredLength=rf,i3.sqrLen=rf;var rm=ru.normalize;i3.normalize=rm,i3.exactEquals=ru.exactEquals,i3.equals=ru.equals;var r_,ry,rx,rv,rb=(ry=ra.create(),rx=ra.fromValues(1,0,0),rv=ra.fromValues(0,1,0),function(en,el,eu){var ec=ra.dot(el,eu);return ec<-.999999?(ra.cross(ry,rx,el),1e-6>ra.len(ry)&&ra.cross(ry,rv,el),ra.normalize(ry,ry),Ou(en,ry,Math.PI),en):ec>.999999?(en[0]=0,en[1]=0,en[2]=0,en[3]=1,en):(ra.cross(ry,el,eu),en[0]=ry[0],en[1]=ry[1],en[2]=ry[2],en[3]=1+ec,rm(en,en))});i3.rotationTo=rb;var rw,rT,rM=(rw=Vu(),rT=Vu(),function(en,el,eu,ec,ed,ef){return Nu(rw,el,ed,ef),Nu(rT,eu,ec,ef),Nu(en,rw,rT,2*ef*(1-ef)),en});i3.sqlerp=rM;var rE,rS=(rE=rr.create(),function(en,el,eu,ec){return rE[0]=eu[0],rE[3]=eu[1],rE[6]=eu[2],rE[1]=ec[0],rE[4]=ec[1],rE[7]=ec[2],rE[2]=-el[0],rE[5]=-el[1],rE[8]=-el[2],rm(en,$u(en,rE))});i3.setAxes=rS;var rA={};function sc(en){return(sc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(en){return typeof en}:function(en){return en&&"function"==typeof Symbol&&en.constructor===Symbol&&en!==Symbol.prototype?"symbol":typeof en})(en)}Object.defineProperty(rA,"__esModule",{value:!0}),rA.create=function(){var en=new rI.ARRAY_TYPE(8);return rI.ARRAY_TYPE!=Float32Array&&(en[0]=0,en[1]=0,en[2]=0,en[4]=0,en[5]=0,en[6]=0,en[7]=0),en[3]=1,en},rA.clone=function(en){var el=new rI.ARRAY_TYPE(8);return el[0]=en[0],el[1]=en[1],el[2]=en[2],el[3]=en[3],el[4]=en[4],el[5]=en[5],el[6]=en[6],el[7]=en[7],el},rA.fromValues=function(en,el,eu,ec,ed,ef,em,e_){var ew=new rI.ARRAY_TYPE(8);return ew[0]=en,ew[1]=el,ew[2]=eu,ew[3]=ec,ew[4]=ed,ew[5]=ef,ew[6]=em,ew[7]=e_,ew},rA.fromRotationTranslationValues=function(en,el,eu,ec,ed,ef,em){var e_=new rI.ARRAY_TYPE(8);e_[0]=en,e_[1]=el,e_[2]=eu,e_[3]=ec;var ew=.5*ed,eT=.5*ef,eM=.5*em;return e_[4]=ew*ec+eT*eu-eM*el,e_[5]=eT*ec+eM*en-ew*eu,e_[6]=eM*ec+ew*el-eT*en,e_[7]=-ew*en-eT*el-eM*eu,e_},rA.fromRotationTranslation=hc,rA.fromTranslation=function(en,el){return en[0]=0,en[1]=0,en[2]=0,en[3]=1,en[4]=.5*el[0],en[5]=.5*el[1],en[6]=.5*el[2],en[7]=0,en},rA.fromRotation=function(en,el){return en[0]=el[0],en[1]=el[1],en[2]=el[2],en[3]=el[3],en[4]=0,en[5]=0,en[6]=0,en[7]=0,en},rA.fromMat4=function(en,el){var eu=rC.create();rP.getRotation(eu,el);var ec=new rI.ARRAY_TYPE(3);return rP.getTranslation(ec,el),hc(en,eu,ec),en},rA.copy=pc,rA.identity=function(en){return en[0]=0,en[1]=0,en[2]=0,en[3]=1,en[4]=0,en[5]=0,en[6]=0,en[7]=0,en},rA.set=function(en,el,eu,ec,ed,ef,em,e_,ew){return en[0]=el,en[1]=eu,en[2]=ec,en[3]=ed,en[4]=ef,en[5]=em,en[6]=e_,en[7]=ew,en},rA.getDual=function(en,el){return en[0]=el[4],en[1]=el[5],en[2]=el[6],en[3]=el[7],en},rA.setDual=function(en,el){return en[4]=el[0],en[5]=el[1],en[6]=el[2],en[7]=el[3],en},rA.getTranslation=function(en,el){var eu=el[4],ec=el[5],ed=el[6],ef=el[7],em=-el[0],e_=-el[1],ew=-el[2],eT=el[3];return en[0]=2*(eu*eT+ef*em+ec*ew-ed*e_),en[1]=2*(ec*eT+ef*e_+ed*em-eu*ew),en[2]=2*(ed*eT+ef*ew+eu*e_-ec*em),en},rA.translate=function(en,el,eu){var ec=el[0],ed=el[1],ef=el[2],em=el[3],e_=.5*eu[0],ew=.5*eu[1],eT=.5*eu[2],eM=el[4],eE=el[5],eS=el[6],eA=el[7];return en[0]=ec,en[1]=ed,en[2]=ef,en[3]=em,en[4]=em*e_+ed*eT-ef*ew+eM,en[5]=em*ew+ef*e_-ec*eT+eE,en[6]=em*eT+ec*ew-ed*e_+eS,en[7]=-ec*e_-ed*ew-ef*eT+eA,en},rA.rotateX=function(en,el,eu){var ec=-el[0],ed=-el[1],ef=-el[2],em=el[3],e_=el[4],ew=el[5],eT=el[6],eM=el[7],eE=e_*em+eM*ec+ew*ef-eT*ed,eS=ew*em+eM*ed+eT*ec-e_*ef,eA=eT*em+eM*ef+e_*ed-ew*ec,eI=eM*em-e_*ec-ew*ed-eT*ef;return rC.rotateX(en,el,eu),en[4]=eE*(em=en[3])+eI*(ec=en[0])+eS*(ef=en[2])-eA*(ed=en[1]),en[5]=eS*em+eI*ed+eA*ec-eE*ef,en[6]=eA*em+eI*ef+eE*ed-eS*ec,en[7]=eI*em-eE*ec-eS*ed-eA*ef,en},rA.rotateY=function(en,el,eu){var ec=-el[0],ed=-el[1],ef=-el[2],em=el[3],e_=el[4],ew=el[5],eT=el[6],eM=el[7],eE=e_*em+eM*ec+ew*ef-eT*ed,eS=ew*em+eM*ed+eT*ec-e_*ef,eA=eT*em+eM*ef+e_*ed-ew*ec,eI=eM*em-e_*ec-ew*ed-eT*ef;return rC.rotateY(en,el,eu),en[4]=eE*(em=en[3])+eI*(ec=en[0])+eS*(ef=en[2])-eA*(ed=en[1]),en[5]=eS*em+eI*ed+eA*ec-eE*ef,en[6]=eA*em+eI*ef+eE*ed-eS*ec,en[7]=eI*em-eE*ec-eS*ed-eA*ef,en},rA.rotateZ=function(en,el,eu){var ec=-el[0],ed=-el[1],ef=-el[2],em=el[3],e_=el[4],ew=el[5],eT=el[6],eM=el[7],eE=e_*em+eM*ec+ew*ef-eT*ed,eS=ew*em+eM*ed+eT*ec-e_*ef,eA=eT*em+eM*ef+e_*ed-ew*ec,eI=eM*em-e_*ec-ew*ed-eT*ef;return rC.rotateZ(en,el,eu),en[4]=eE*(em=en[3])+eI*(ec=en[0])+eS*(ef=en[2])-eA*(ed=en[1]),en[5]=eS*em+eI*ed+eA*ec-eE*ef,en[6]=eA*em+eI*ef+eE*ed-eS*ec,en[7]=eI*em-eE*ec-eS*ed-eA*ef,en},rA.rotateByQuatAppend=function(en,el,eu){var ec=eu[0],ed=eu[1],ef=eu[2],em=eu[3],e_=el[0],ew=el[1],eT=el[2],eM=el[3];return en[0]=e_*em+eM*ec+ew*ef-eT*ed,en[1]=ew*em+eM*ed+eT*ec-e_*ef,en[2]=eT*em+eM*ef+e_*ed-ew*ec,en[3]=eM*em-e_*ec-ew*ed-eT*ef,en[4]=(e_=el[4])*em+(eM=el[7])*ec+(ew=el[5])*ef-(eT=el[6])*ed,en[5]=ew*em+eM*ed+eT*ec-e_*ef,en[6]=eT*em+eM*ef+e_*ed-ew*ec,en[7]=eM*em-e_*ec-ew*ed-eT*ef,en},rA.rotateByQuatPrepend=function(en,el,eu){var ec=el[0],ed=el[1],ef=el[2],em=el[3],e_=eu[0],ew=eu[1],eT=eu[2],eM=eu[3];return en[0]=ec*eM+em*e_+ed*eT-ef*ew,en[1]=ed*eM+em*ew+ef*e_-ec*eT,en[2]=ef*eM+em*eT+ec*ew-ed*e_,en[3]=em*eM-ec*e_-ed*ew-ef*eT,en[4]=ec*(eM=eu[7])+em*(e_=eu[4])+ed*(eT=eu[6])-ef*(ew=eu[5]),en[5]=ed*eM+em*ew+ef*e_-ec*eT,en[6]=ef*eM+em*eT+ec*ew-ed*e_,en[7]=em*eM-ec*e_-ed*ew-ef*eT,en},rA.rotateAroundAxis=function(en,el,eu,ec){if(Math.abs(ec)<rI.EPSILON)return pc(en,el);var ed=Math.hypot(eu[0],eu[1],eu[2]),ef=Math.sin(ec*=.5),em=ef*eu[0]/ed,e_=ef*eu[1]/ed,ew=ef*eu[2]/ed,eT=Math.cos(ec),eM=el[0],eE=el[1],eS=el[2],eA=el[3];en[0]=eM*eT+eA*em+eE*ew-eS*e_,en[1]=eE*eT+eA*e_+eS*em-eM*ew,en[2]=eS*eT+eA*ew+eM*e_-eE*em,en[3]=eA*eT-eM*em-eE*e_-eS*ew;var eI=el[4],eC=el[5],eP=el[6],ez=el[7];return en[4]=eI*eT+ez*em+eC*ew-eP*e_,en[5]=eC*eT+ez*e_+eP*em-eI*ew,en[6]=eP*eT+ez*ew+eI*e_-eC*em,en[7]=ez*eT-eI*em-eC*e_-eP*ew,en},rA.add=function(en,el,eu){return en[0]=el[0]+eu[0],en[1]=el[1]+eu[1],en[2]=el[2]+eu[2],en[3]=el[3]+eu[3],en[4]=el[4]+eu[4],en[5]=el[5]+eu[5],en[6]=el[6]+eu[6],en[7]=el[7]+eu[7],en},rA.multiply=fc,rA.scale=function(en,el,eu){return en[0]=el[0]*eu,en[1]=el[1]*eu,en[2]=el[2]*eu,en[3]=el[3]*eu,en[4]=el[4]*eu,en[5]=el[5]*eu,en[6]=el[6]*eu,en[7]=el[7]*eu,en},rA.lerp=function(en,el,eu,ec){var ed=1-ec;return 0>rz(el,eu)&&(ec=-ec),en[0]=el[0]*ed+eu[0]*ec,en[1]=el[1]*ed+eu[1]*ec,en[2]=el[2]*ed+eu[2]*ec,en[3]=el[3]*ed+eu[3]*ec,en[4]=el[4]*ed+eu[4]*ec,en[5]=el[5]*ed+eu[5]*ec,en[6]=el[6]*ed+eu[6]*ec,en[7]=el[7]*ed+eu[7]*ec,en},rA.invert=function(en,el){var eu=rL(el);return en[0]=-el[0]/eu,en[1]=-el[1]/eu,en[2]=-el[2]/eu,en[3]=el[3]/eu,en[4]=-el[4]/eu,en[5]=-el[5]/eu,en[6]=-el[6]/eu,en[7]=el[7]/eu,en},rA.conjugate=function(en,el){return en[0]=-el[0],en[1]=-el[1],en[2]=-el[2],en[3]=el[3],en[4]=-el[4],en[5]=-el[5],en[6]=-el[6],en[7]=el[7],en},rA.normalize=function(en,el){var eu=rL(el);if(eu>0){eu=Math.sqrt(eu);var ec=el[0]/eu,ed=el[1]/eu,ef=el[2]/eu,em=el[3]/eu,e_=el[4],ew=el[5],eT=el[6],eM=el[7],eE=ec*e_+ed*ew+ef*eT+em*eM;en[0]=ec,en[1]=ed,en[2]=ef,en[3]=em,en[4]=(e_-ec*eE)/eu,en[5]=(ew-ed*eE)/eu,en[6]=(eT-ef*eE)/eu,en[7]=(eM-em*eE)/eu}return en},rA.str=function(en){return"quat2("+en[0]+", "+en[1]+", "+en[2]+", "+en[3]+", "+en[4]+", "+en[5]+", "+en[6]+", "+en[7]+")"},rA.exactEquals=function(en,el){return en[0]===el[0]&&en[1]===el[1]&&en[2]===el[2]&&en[3]===el[3]&&en[4]===el[4]&&en[5]===el[5]&&en[6]===el[6]&&en[7]===el[7]},rA.equals=function(en,el){var eu=en[0],ec=en[1],ed=en[2],ef=en[3],em=en[4],e_=en[5],ew=en[6],eT=en[7],eM=el[0],eE=el[1],eS=el[2],eA=el[3],eI=el[4],eC=el[5],eP=el[6],ez=el[7];return Math.abs(eu-eM)<=rI.EPSILON*Math.max(1,Math.abs(eu),Math.abs(eM))&&Math.abs(ec-eE)<=rI.EPSILON*Math.max(1,Math.abs(ec),Math.abs(eE))&&Math.abs(ed-eS)<=rI.EPSILON*Math.max(1,Math.abs(ed),Math.abs(eS))&&Math.abs(ef-eA)<=rI.EPSILON*Math.max(1,Math.abs(ef),Math.abs(eA))&&Math.abs(em-eI)<=rI.EPSILON*Math.max(1,Math.abs(em),Math.abs(eI))&&Math.abs(e_-eC)<=rI.EPSILON*Math.max(1,Math.abs(e_),Math.abs(eC))&&Math.abs(ew-eP)<=rI.EPSILON*Math.max(1,Math.abs(ew),Math.abs(eP))&&Math.abs(eT-ez)<=rI.EPSILON*Math.max(1,Math.abs(eT),Math.abs(ez))},rA.sqrLen=rA.squaredLength=rA.len=rA.length=rA.dot=rA.mul=rA.setReal=rA.getReal=void 0;var rI=cc(iq),rC=cc(i3),rP=cc(i1);function uc(en){if("function"!=typeof WeakMap)return null;var el=new WeakMap,eu=new WeakMap;return(uc=function(en){return en?eu:el})(en)}function cc(en,el){if(!el&&en&&en.__esModule)return en;if(null===en||"object"!==sc(en)&&"function"!=typeof en)return{default:en};var eu=uc(el);if(eu&&eu.has(en))return eu.get(en);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var ef in en)if("default"!==ef&&Object.prototype.hasOwnProperty.call(en,ef)){var em=ed?Object.getOwnPropertyDescriptor(en,ef):null;em&&(em.get||em.set)?Object.defineProperty(ec,ef,em):ec[ef]=en[ef]}return ec.default=en,eu&&eu.set(en,ec),ec}function hc(en,el,eu){var ec=.5*eu[0],ed=.5*eu[1],ef=.5*eu[2],em=el[0],e_=el[1],ew=el[2],eT=el[3];return en[0]=em,en[1]=e_,en[2]=ew,en[3]=eT,en[4]=ec*eT+ed*ew-ef*e_,en[5]=ed*eT+ef*em-ec*ew,en[6]=ef*eT+ec*e_-ed*em,en[7]=-ec*em-ed*e_-ef*ew,en}function pc(en,el){return en[0]=el[0],en[1]=el[1],en[2]=el[2],en[3]=el[3],en[4]=el[4],en[5]=el[5],en[6]=el[6],en[7]=el[7],en}function fc(en,el,eu){var ec=el[0],ed=el[1],ef=el[2],em=el[3],e_=eu[4],ew=eu[5],eT=eu[6],eM=eu[7],eE=el[4],eS=el[5],eA=el[6],eI=el[7],eC=eu[0],eP=eu[1],ez=eu[2],eD=eu[3];return en[0]=ec*eD+em*eC+ed*ez-ef*eP,en[1]=ed*eD+em*eP+ef*eC-ec*ez,en[2]=ef*eD+em*ez+ec*eP-ed*eC,en[3]=em*eD-ec*eC-ed*eP-ef*ez,en[4]=ec*eM+em*e_+ed*eT-ef*ew+eE*eD+eI*eC+eS*ez-eA*eP,en[5]=ed*eM+em*ew+ef*e_-ec*eT+eS*eD+eI*eP+eA*eC-eE*ez,en[6]=ef*eM+em*eT+ec*ew-ed*e_+eA*eD+eI*ez+eE*eP-eS*eC,en[7]=em*eM-ec*e_-ed*ew-ef*eT+eI*eD-eE*eC-eS*eP-eA*ez,en}rA.getReal=rC.copy,rA.setReal=rC.copy,rA.mul=fc;var rz=rC.dot;rA.dot=rz;var rD=rC.length;rA.length=rD,rA.len=rD;var rL=rC.squaredLength;rA.squaredLength=rL,rA.sqrLen=rL;var rk={};function xc(en){return(xc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(en){return typeof en}:function(en){return en&&"function"==typeof Symbol&&en.constructor===Symbol&&en!==Symbol.prototype?"symbol":typeof en})(en)}Object.defineProperty(rk,"__esModule",{value:!0}),rk.create=_c,rk.clone=function(en){var el=new rR.ARRAY_TYPE(2);return el[0]=en[0],el[1]=en[1],el},rk.fromValues=function(en,el){var eu=new rR.ARRAY_TYPE(2);return eu[0]=en,eu[1]=el,eu},rk.copy=function(en,el){return en[0]=el[0],en[1]=el[1],en},rk.set=function(en,el,eu){return en[0]=el,en[1]=eu,en},rk.add=function(en,el,eu){return en[0]=el[0]+eu[0],en[1]=el[1]+eu[1],en},rk.subtract=wc,rk.multiply=Mc,rk.divide=Ac,rk.ceil=function(en,el){return en[0]=Math.ceil(el[0]),en[1]=Math.ceil(el[1]),en},rk.floor=function(en,el){return en[0]=Math.floor(el[0]),en[1]=Math.floor(el[1]),en},rk.min=function(en,el,eu){return en[0]=Math.min(el[0],eu[0]),en[1]=Math.min(el[1],eu[1]),en},rk.max=function(en,el,eu){return en[0]=Math.max(el[0],eu[0]),en[1]=Math.max(el[1],eu[1]),en},rk.round=function(en,el){return en[0]=Math.round(el[0]),en[1]=Math.round(el[1]),en},rk.scale=function(en,el,eu){return en[0]=el[0]*eu,en[1]=el[1]*eu,en},rk.scaleAndAdd=function(en,el,eu,ec){return en[0]=el[0]+eu[0]*ec,en[1]=el[1]+eu[1]*ec,en},rk.distance=Sc,rk.squaredDistance=Ic,rk.length=kc,rk.squaredLength=Tc,rk.negate=function(en,el){return en[0]=-el[0],en[1]=-el[1],en},rk.inverse=function(en,el){return en[0]=1/el[0],en[1]=1/el[1],en},rk.normalize=function(en,el){var eu=el[0],ec=el[1],ed=eu*eu+ec*ec;return ed>0&&(ed=1/Math.sqrt(ed)),en[0]=el[0]*ed,en[1]=el[1]*ed,en},rk.dot=function(en,el){return en[0]*el[0]+en[1]*el[1]},rk.cross=function(en,el,eu){var ec=el[0]*eu[1]-el[1]*eu[0];return en[0]=en[1]=0,en[2]=ec,en},rk.lerp=function(en,el,eu,ec){var ed=el[0],ef=el[1];return en[0]=ed+ec*(eu[0]-ed),en[1]=ef+ec*(eu[1]-ef),en},rk.random=function(en,el){el=el||1;var eu=2*rR.RANDOM()*Math.PI;return en[0]=Math.cos(eu)*el,en[1]=Math.sin(eu)*el,en},rk.transformMat2=function(en,el,eu){var ec=el[0],ed=el[1];return en[0]=eu[0]*ec+eu[2]*ed,en[1]=eu[1]*ec+eu[3]*ed,en},rk.transformMat2d=function(en,el,eu){var ec=el[0],ed=el[1];return en[0]=eu[0]*ec+eu[2]*ed+eu[4],en[1]=eu[1]*ec+eu[3]*ed+eu[5],en},rk.transformMat3=function(en,el,eu){var ec=el[0],ed=el[1];return en[0]=eu[0]*ec+eu[3]*ed+eu[6],en[1]=eu[1]*ec+eu[4]*ed+eu[7],en},rk.transformMat4=function(en,el,eu){var ec=el[0],ed=el[1];return en[0]=eu[0]*ec+eu[4]*ed+eu[12],en[1]=eu[1]*ec+eu[5]*ed+eu[13],en},rk.rotate=function(en,el,eu,ec){var ed=el[0]-eu[0],ef=el[1]-eu[1],em=Math.sin(ec),e_=Math.cos(ec);return en[0]=ed*e_-ef*em+eu[0],en[1]=ed*em+ef*e_+eu[1],en},rk.angle=function(en,el){var eu=en[0],ec=en[1],ed=el[0],ef=el[1],em=Math.sqrt(eu*eu+ec*ec)*Math.sqrt(ed*ed+ef*ef);return Math.acos(Math.min(Math.max(em&&(eu*ed+ec*ef)/em,-1),1))},rk.zero=function(en){return en[0]=0,en[1]=0,en},rk.str=function(en){return"vec2("+en[0]+", "+en[1]+")"},rk.exactEquals=function(en,el){return en[0]===el[0]&&en[1]===el[1]},rk.equals=function(en,el){var eu=en[0],ec=en[1],ed=el[0],ef=el[1];return Math.abs(eu-ed)<=rR.EPSILON*Math.max(1,Math.abs(eu),Math.abs(ed))&&Math.abs(ec-ef)<=rR.EPSILON*Math.max(1,Math.abs(ec),Math.abs(ef))},rk.forEach=rk.sqrLen=rk.sqrDist=rk.dist=rk.div=rk.mul=rk.sub=rk.len=void 0;var rR=function(en,el){if(en&&en.__esModule)return en;if(null===en||"object"!==xc(en)&&"function"!=typeof en)return{default:en};var eu=bc(void 0);if(eu&&eu.has(en))return eu.get(en);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var ef in en)if("default"!==ef&&Object.prototype.hasOwnProperty.call(en,ef)){var em=ed?Object.getOwnPropertyDescriptor(en,ef):null;em&&(em.get||em.set)?Object.defineProperty(ec,ef,em):ec[ef]=en[ef]}return ec.default=en,eu&&eu.set(en,ec),ec}(iq);function bc(en){if("function"!=typeof WeakMap)return null;var el=new WeakMap,eu=new WeakMap;return(bc=function(en){return en?eu:el})(en)}function _c(){var en=new rR.ARRAY_TYPE(2);return rR.ARRAY_TYPE!=Float32Array&&(en[0]=0,en[1]=0),en}function wc(en,el,eu){return en[0]=el[0]-eu[0],en[1]=el[1]-eu[1],en}function Mc(en,el,eu){return en[0]=el[0]*eu[0],en[1]=el[1]*eu[1],en}function Ac(en,el,eu){return en[0]=el[0]/eu[0],en[1]=el[1]/eu[1],en}function Sc(en,el){return Math.hypot(el[0]-en[0],el[1]-en[1])}function Ic(en,el){var eu=el[0]-en[0],ec=el[1]-en[1];return eu*eu+ec*ec}function kc(en){return Math.hypot(en[0],en[1])}function Tc(en){var el=en[0],eu=en[1];return el*el+eu*eu}rk.len=kc,rk.sub=wc,rk.mul=Mc,rk.div=Ac,rk.dist=Sc,rk.sqrDist=Ic,rk.sqrLen=Tc;var rO=(eA=_c(),function(en,el,eu,ec,ed,ef){var em,e_;for(el||(el=2),eu||(eu=0),e_=ec?Math.min(ec*el+eu,en.length):en.length,em=eu;em<e_;em+=el)eA[0]=en[em],eA[1]=en[em+1],ed(eA,eA,ef),en[em]=eA[0],en[em+1]=eA[1];return en});function zc(en){return(zc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(en){return typeof en}:function(en){return en&&"function"==typeof Symbol&&en.constructor===Symbol&&en!==Symbol.prototype?"symbol":typeof en})(en)}rk.forEach=rO,Object.defineProperty(iG,"__esModule",{value:!0}),en.e=iG.vec4=en.v=iG.vec3=iG.vec2=iG.quat2=en.q=iG.quat=en.m=iG.mat4=en.bx=iG.mat3=iG.mat2d=en.h=iG.mat2=iG.glMatrix=void 0;var rB=Nc(iq);iG.glMatrix=rB;var rF=Nc(iX);en.h=iG.mat2=rF;var rN=Nc(iJ);iG.mat2d=rN;var rU=Nc(iQ);en.bx=iG.mat3=rU;var rV=Nc(i1);en.m=iG.mat4=rV;var rj=Nc(i3);en.q=iG.quat=rj;var rG=Nc(rA);iG.quat2=rG;var rq=Nc(rk);iG.vec2=rq;var rZ=Nc(i4);en.v=iG.vec3=rZ;var r$=Nc(i7);function Uc(en){if("function"!=typeof WeakMap)return null;var el=new WeakMap,eu=new WeakMap;return(Uc=function(en){return en?eu:el})(en)}function Nc(en,el){if(!el&&en&&en.__esModule)return en;if(null===en||"object"!==zc(en)&&"function"!=typeof en)return{default:en};var eu=Uc(el);if(eu&&eu.has(en))return eu.get(en);var ec={},ed=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var ef in en)if("default"!==ef&&Object.prototype.hasOwnProperty.call(en,ef)){var em=ed?Object.getOwnPropertyDescriptor(en,ef):null;em&&(em.get||em.set)?Object.defineProperty(ec,ef,em):ec[ef]=en[ef]}return ec.default=en,eu&&eu.set(en,ec),ec}en.e=iG.vec4=r$;let rW=Ua([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:rH}=rW,rX=Ua([{name:"a_pos_3",components:3,type:"Int16"}]);var rK=Ua([{name:"a_pos",type:"Int16",components:2}]),rJ={};(function(en){function e(en,el,eu){var ec=r(256*en,256*(el=Math.pow(2,eu)-el-1),eu),ed=r(256*(en+1),256*(el+1),eu);return ec[0]+","+ec[1]+","+ed[0]+","+ed[1]}function r(en,el,eu){var ec=2*Math.PI*6378137/256/Math.pow(2,eu);return[en*ec-2*Math.PI*6378137/2,el*ec-2*Math.PI*6378137/2]}en.getURL=function(en,el,eu,ec,ed,ef){return ef=ef||{},en+"?"+["bbox="+e(eu,ec,ed),"format="+(ef.format||"image/png"),"service="+(ef.service||"WMS"),"version="+(ef.version||"1.1.1"),"request="+(ef.request||"GetMap"),"srs="+(ef.srs||"EPSG:3857"),"width="+(ef.width||256),"height="+(ef.height||256),"layers="+el].join("&")},en.getTileBBox=e,en.getMercCoords=r,Object.defineProperty(en,"__esModule",{value:!0})})(rJ);let Kc=class Kc{constructor(en,el,eu){this.z=en,this.x=el,this.y=eu,this.key=Jc(0,en,en,el,eu)}equals(en){return this.z===en.z&&this.x===en.x&&this.y===en.y}url(en,el){let eu=rJ.getTileBBox(this.x,this.y,this.z),ec=function(en,el,eu){let ec,ed="";for(let ef=en;ef>0;ef--)ed+=(el&(ec=1<<ef-1)?1:0)+(eu&ec?2:0);return ed}(this.z,this.x,this.y);return en[(this.x+this.y)%en.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String("tms"===el?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",ec).replace("{bbox-epsg-3857}",eu)}toString(){return`${this.z}/${this.x}/${this.y}`}};let Wc=class Wc{constructor(en,el){this.wrap=en,this.canonical=el,this.key=Jc(en,el.z,el.z,el.x,el.y)}};let Hc=class Hc{constructor(en,el,eu,ec,ed){this.overscaledZ=en,this.wrap=el,this.canonical=new Kc(eu,+ec,+ed),this.key=0===el&&en===eu?this.canonical.key:Jc(el,en,eu,ec,ed)}equals(en){return this.overscaledZ===en.overscaledZ&&this.wrap===en.wrap&&this.canonical.equals(en.canonical)}scaledTo(en){let el=this.canonical.z-en;return en>this.canonical.z?new Hc(en,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Hc(en,this.wrap,en,this.canonical.x>>el,this.canonical.y>>el)}calculateScaledKey(en,el=!0){if(this.overscaledZ===en&&el)return this.key;if(en>this.canonical.z)return Jc(this.wrap*+el,en,this.canonical.z,this.canonical.x,this.canonical.y);{let eu=this.canonical.z-en;return Jc(this.wrap*+el,en,en,this.canonical.x>>eu,this.canonical.y>>eu)}}isChildOf(en){if(en.wrap!==this.wrap)return!1;let el=this.canonical.z-en.canonical.z;return 0===en.overscaledZ||en.overscaledZ<this.overscaledZ&&en.canonical.z<this.canonical.z&&en.canonical.x===this.canonical.x>>el&&en.canonical.y===this.canonical.y>>el}children(en){if(this.overscaledZ>=en)return[new Hc(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];let el=this.canonical.z+1,eu=2*this.canonical.x,ec=2*this.canonical.y;return[new Hc(el,this.wrap,el,eu,ec),new Hc(el,this.wrap,el,eu+1,ec),new Hc(el,this.wrap,el,eu,ec+1),new Hc(el,this.wrap,el,eu+1,ec+1)]}isLessThan(en){return this.wrap<en.wrap||!(this.wrap>en.wrap)&&(this.overscaledZ<en.overscaledZ||!(this.overscaledZ>en.overscaledZ)&&(this.canonical.x<en.canonical.x||!(this.canonical.x>en.canonical.x)&&this.canonical.y<en.canonical.y))}wrapped(){return new Hc(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(en){return new Hc(this.overscaledZ,en,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Wc(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}};function Jc(en,el,eu,ec,ed){let ef=1<<Math.min(eu,22),em=ef*(ed%ef)+ec%ef;return en&&eu<22&&(em+=ef*ef*((en<0?-2*en-1:2*en)%(1<<2*(22-eu)))),16*(32*em+eu)+(el-eu)}let rY=[en=>{let el=en.canonical.x-1,eu=en.wrap;return el<0&&(el=(1<<en.canonical.z)-1,eu--),new Hc(en.overscaledZ,eu,en.canonical.z,el,en.canonical.y)},en=>{let el=en.canonical.x+1,eu=en.wrap;return el===1<<en.canonical.z&&(el=0,eu++),new Hc(en.overscaledZ,eu,en.canonical.z,el,en.canonical.y)},en=>new Hc(en.overscaledZ,en.wrap,en.canonical.z,en.canonical.x,(0===en.canonical.y?1<<en.canonical.z:en.canonical.y)-1),en=>new Hc(en.overscaledZ,en.wrap,en.canonical.z,en.canonical.x,en.canonical.y===(1<<en.canonical.z)-1?0:en.canonical.y+1)];Ks(Kc,"CanonicalTileID"),Ks(Hc,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});let th=class th{constructor(en,el){this.pos=en,this.dir=el}intersectsPlane(el,eu,ec){let ed=en.v.dot(eu,this.dir);if(1e-6>Math.abs(ed))return!1;let ef=((el[0]-this.pos[0])*eu[0]+(el[1]-this.pos[1])*eu[1]+(el[2]-this.pos[2])*eu[2])/ed;return ec[0]=this.pos[0]+this.dir[0]*ef,ec[1]=this.pos[1]+this.dir[1]*ef,ec[2]=this.pos[2]+this.dir[2]*ef,!0}closestPointOnSphere(el,eu,ec){if(en.v.equals(this.pos,el)||0===eu)return ec[0]=ec[1]=ec[2]=0,!1;let[ed,ef,em]=this.dir,e_=this.pos[0]-el[0],ew=this.pos[1]-el[1],eT=this.pos[2]-el[2],eM=ed*ed+ef*ef+em*em,eE=2*(e_*ed+ew*ef+eT*em),eS=eE*eE-4*eM*(e_*e_+ew*ew+eT*eT-eu*eu);if(eS<0){let en=Math.max(-eE/2,0),el=e_+ed*en,eM=ew+ef*en,eS=eT+em*en,eA=Math.hypot(el,eM,eS);return ec[0]=el*eu/eA,ec[1]=eM*eu/eA,ec[2]=eS*eu/eA,!1}{let en=(-eE-Math.sqrt(eS))/(2*eM);if(en<0){let en=Math.hypot(e_,ew,eT);return ec[0]=e_*eu/en,ec[1]=ew*eu/en,ec[2]=eT*eu/en,!1}return ec[0]=e_+ed*en,ec[1]=ew+ef*en,ec[2]=eT+em*en,!0}}};let eh=class eh{constructor(en,el,eu,ec,ed){this.TL=en,this.TR=el,this.BR=eu,this.BL=ec,this.horizon=ed}static fromInvProjectionMatrix(el,eu,ec){let ed=[-1,1,1],ef=[1,1,1],em=[1,-1,1],e_=[-1,-1,1],ew=en.v.transformMat4(ed,ed,el),eT=en.v.transformMat4(ef,ef,el),eM=en.v.transformMat4(em,em,el),eE=en.v.transformMat4(e_,e_,el);return new eh(ew,eT,eM,eE,eu/ec)}};function rh(el,eu,ec){let ed=1/0,ef=-1/0,em=[];for(let e_ of el){en.v.sub(em,e_,eu);let el=en.v.dot(em,ec);ed=Math.min(ed,el),ef=Math.max(ef,el)}return[ed,ef]}function nh(el,eu){let ec=!0;for(let ed=0;ed<el.planes.length;ed++){let ef=el.planes[ed],em=0;for(let el=0;el<eu.length;el++)em+=en.v.dot(ef,eu[el])+ef[3]>=0;if(0===em)return 0;em!==eu.length&&(ec=!1)}return ec?2:1}function ih(en,el){for(let eu of en.projections){let ec=rh(el,en.points[0],eu.axis);if(eu.projection[1]<ec[0]||eu.projection[0]>ec[1])return 0}return 1}function sh(el,eu){let ec=0,ed=[0,0,0,0];for(let ef=0;ef<el.length;ef++)ed[0]=el[ef][0],ed[1]=el[ef][1],ed[2]=el[ef][2],ed[3]=1,en.e.dot(ed,eu)>=0&&ec++;return ec}let ah=class ah{constructor(el,eu){for(let ec of(this.points=el||Array(8).fill([0,0,0]),this.planes=eu||Array(6).fill([0,0,0,0]),this.bounds=oh.fromPoints(this.points),this.projections=[],this.frustumEdges=[en.v.sub([],this.points[2],this.points[3]),en.v.sub([],this.points[0],this.points[3]),en.v.sub([],this.points[4],this.points[0]),en.v.sub([],this.points[5],this.points[1]),en.v.sub([],this.points[6],this.points[2]),en.v.sub([],this.points[7],this.points[3])],this.frustumEdges)){let en=[0,-ec[2],ec[1]],el=[ec[2],0,-ec[0]];this.projections.push({axis:en,projection:rh(this.points,this.points[0],en)}),this.projections.push({axis:el,projection:rh(this.points,this.points[0],el)})}}static fromInvProjectionMatrix(el,eu,ec,ed){let ef=Math.pow(2,ec),em=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(ec=>{let em=en.e.transformMat4([],ec,el),e_=1/em[3]/eu*ef;return en.e.mul(em,em,[e_,e_,ed?1/em[3]:e_,e_])}),e_=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(el=>{let eu=en.v.sub([],em[el[0]],em[el[1]]),ec=en.v.sub([],em[el[2]],em[el[1]]),ed=en.v.normalize([],en.v.cross([],eu,ec)),ef=-en.v.dot(ed,em[el[1]]);return ed.concat(ef)}),ew=[];for(let en=0;en<em.length;en++)ew.push([em[en][0],em[en][1],em[en][2]]);return new ah(ew,e_)}intersectsPrecise(el,eu,ec){for(let en=0;en<eu.length;en++)if(!sh(el,eu[en]))return 0;for(let en=0;en<this.planes.length;en++)if(!sh(el,this.planes[en]))return 0;for(let eu of ec)for(let ec of this.frustumEdges){let ed=en.v.cross([],eu,ec),ef=en.v.length(ed);if(0===ef)continue;en.v.scale(ed,ed,1/ef);let em=rh(this.points,this.points[0],ed),e_=rh(el,this.points[0],ed);if(em[0]>e_[1]||e_[0]>em[1])return 0}return 1}};let oh=class oh{static fromPoints(el){let eu=[1/0,1/0,1/0],ec=[-1/0,-1/0,-1/0];for(let ed of el)en.v.min(eu,eu,ed),en.v.max(ec,ec,ed);return new oh(eu,ec)}static fromTileIdAndHeight(en,el,eu){let ec=1<<en.canonical.z,ed=en.canonical.x,ef=en.canonical.y;return new oh([ed/ec,ef/ec,el],[(ed+1)/ec,(ef+1)/ec,eu])}static applyTransform(el,eu){let ec=el.getCorners();for(let el=0;el<ec.length;++el)en.v.transformMat4(ec[el],ec[el],eu);return oh.fromPoints(ec)}static projectAabbCorners(el,eu){let ec=el.getCorners();for(let el=0;el<ec.length;++el)en.v.transformMat4(ec[el],ec[el],eu);return ec}constructor(el,eu){this.min=el,this.max=eu,this.center=en.v.scale([],en.v.add([],this.min,this.max),.5)}quadrant(el){let eu=[el%2==0,el<2],ec=en.v.clone(this.min),ed=en.v.clone(this.max);for(let en=0;en<eu.length;en++)ec[en]=eu[en]?this.min[en]:this.center[en],ed[en]=eu[en]?this.center[en]:this.max[en];return ed[2]=this.max[2],new oh(ec,ed)}distanceX(en){return Math.max(Math.min(this.max[0],en[0]),this.min[0])-en[0]}distanceY(en){return Math.max(Math.min(this.max[1],en[1]),this.min[1])-en[1]}distanceZ(en){return Math.max(Math.min(this.max[2],en[2]),this.min[2])-en[2]}getCorners(){let en=this.min,el=this.max;return[[en[0],en[1],en[2]],[el[0],en[1],en[2]],[el[0],el[1],en[2]],[en[0],el[1],en[2]],[en[0],en[1],el[2]],[el[0],en[1],el[2]],[el[0],el[1],el[2]],[en[0],el[1],el[2]]]}intersects(en){return this.intersectsAabb(en.bounds)?nh(en,this.getCorners()):0}intersectsFlat(en){return this.intersectsAabb(en.bounds)?nh(en,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(en,el){return el||this.intersects(en)?ih(en,this.getCorners()):0}intersectsPreciseFlat(en,el){return el||this.intersectsFlat(en)?ih(en,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(en){for(let el=0;el<3;++el)if(this.min[el]>en.max[el]||en.min[el]>this.max[el])return!1;return!0}intersectsAabbXY(en){return!(this.min[0]>en.max[0]||en.min[0]>this.max[0]||this.min[1]>en.max[1]||en.min[1]>this.max[1])}encapsulate(en){for(let el=0;el<3;el++)this.min[el]=Math.min(this.min[el],en.min[el]),this.max[el]=Math.max(this.max[el],en.max[el])}encapsulatePoint(en){for(let el=0;el<3;el++)this.min[el]=Math.min(this.min[el],en[el]),this.max[el]=Math.max(this.max[el],en[el])}closestPoint(en){return[Math.max(Math.min(this.max[0],en[0]),this.min[0]),Math.max(Math.min(this.max[1],en[1]),this.min[1]),Math.max(Math.min(this.max[2],en[2]),this.min[2])]}};Ks(oh,"Aabb");let rQ=8192/Math.PI/2,r0=[64,32,16],r1=-rQ,r2=[new oh([r1,r1,r1],[rQ,rQ,rQ]),new oh([r1,r1,r1],[0,0,rQ]),new oh([0,r1,r1],[rQ,0,rQ]),new oh([r1,0,r1],[0,rQ,rQ]),new oh([0,0,r1],[rQ,rQ,rQ])];function gh(en){return en*rQ/r8}function xh(el,eu,ec,ed=!0){let ef=en.v.scale([],el._camera.position,el.worldSize),em=[eu,ec,1,1];en.e.transformMat4(em,em,el.pixelMatrixInverse),en.e.scale(em,em,1/em[3]);let e_=en.v.sub([],em,ef),ew=en.v.normalize([],e_),eT=el.globeMatrix,eM=[eT[12],eT[13],eT[14]],eE=en.v.sub([],eM,ef),eS=en.v.length(eE),eA=en.v.normalize([],eE),eI=el.worldSize/(2*Math.PI),eC=en.v.dot(eA,ew),eP=Math.asin(eI/eS);if(eP<Math.acos(eC)){if(!ed)return null;let el=[],eu=[];en.v.scale(el,ew,eS/eC),en.v.normalize(eu,en.v.sub(eu,el,eE)),en.v.normalize(ew,en.v.add(ew,eE,en.v.scale(ew,eu,Math.tan(eP)*eS)))}let ez=[];new th(ef,ew).closestPointOnSphere(eM,eI,ez);let eD=en.v.normalize([],J(eT,0)),eL=en.v.normalize([],J(eT,1)),ek=en.v.normalize([],J(eT,2)),eR=en.v.dot(eD,ez),eO=en.v.dot(eL,ez),eB=en.v.dot(ek,ez),eF=Math.asin(-eO/eI)*eN,eU=Math.atan2(eR,eB)*eN;eU=el.center.lng+function(en,el){let eu=(el-en+180)%360-180;return eu<-180?eu+360:eu}(el.center.lng,eU);let eV=Hh(eU),ej=k(Jh(eF),0,1);return new lp(eV,ej)}let vh=class vh{constructor(el,eu,ec){this.a=en.v.sub([],el,ec),this.b=en.v.sub([],eu,ec),this.center=ec;let ed=en.v.normalize([],this.a),ef=en.v.normalize([],this.b);this.angle=Math.acos(en.v.dot(ed,ef))}};function bh(en,el){let eu;return 0===en.angle?null:(eu=0===en.a[el]?1/en.angle*.5*Math.PI:1/en.angle*Math.atan(en.b[el]/en.a[el]/Math.sin(en.angle)-1/Math.tan(en.angle)))<0||eu>1?null:function(en,el,eu,ec){let ed=Math.sin(eu);return en*(Math.sin((1-ec)*eu)/ed)+el*(Math.sin(ec*eu)/ed)}(en.a[el],en.b[el],en.angle,k(eu,0,1))+en.center[el]}function _h(en){if(en.z<=1)return r2[en.z+2*en.y+en.x];let el=kh(Ih(en));return oh.fromPoints(el)}function wh(el,eu,ec){return en.v.scale(el,el,1-ec),en.v.scaleAndAdd(el,el,eu,ec)}function Mh(el,eu){let ec=Oh(eu.zoom);if(0===ec)return _h(el);let ed=Ih(el),ef=kh(ed),em=Hh(ed.getWest())*eu.worldSize,e_=Hh(ed.getEast())*eu.worldSize,ew=Jh(ed.getNorth())*eu.worldSize,eT=Jh(ed.getSouth())*eu.worldSize,eM=[em,ew,0],eE=[e_,ew,0],eS=[em,eT,0],eA=[e_,eT,0],eI=en.m.invert([],eu.globeMatrix);return en.v.transformMat4(eM,eM,eI),en.v.transformMat4(eE,eE,eI),en.v.transformMat4(eS,eS,eI),en.v.transformMat4(eA,eA,eI),ef[0]=wh(ef[0],eS,ec),ef[1]=wh(ef[1],eA,ec),ef[2]=wh(ef[2],eE,ec),ef[3]=wh(ef[3],eM,ec),oh.fromPoints(ef)}function Ah(el,eu,ec){for(let ed of el)en.v.transformMat4(ed,ed,eu),en.v.scale(ed,ed,ec)}function Sh(el,eu,ec,ed){let ef=eu/el.worldSize,em=el.globeMatrix;if(ec.z<=1){let en=_h(ec).getCorners();return Ah(en,em,ef),oh.fromPoints(en)}let e_=Ih(ec,ed),ew=kh(e_);Ah(ew,em,ef);let eT=Number.MAX_VALUE,eM=[-eT,-eT,-eT],eE=[eT,eT,eT];if(e_.contains(el.center)){for(let el of ew)en.v.min(eE,eE,el),en.v.max(eM,eM,el);eM[2]=0;let eu=el.point,ec=[eu.x*ef,eu.y*ef,0];return en.v.min(eE,eE,ec),en.v.max(eM,eM,ec),new oh(eE,eM)}let eS=[em[12]*ef,em[13]*ef,em[14]*ef],eA=e_.getCenter(),eI=k(el.center.lat,-ai,ai),eC=k(eA.lat,-ai,ai),eP=Hh(el.center.lng),ez=Jh(eI),eD=eP-Hh(eA.lng),eL=ez-Jh(eC);eD>.5?eD-=1:eD<-.5&&(eD+=1);let ek=0;if(Math.abs(eD)>Math.abs(eL))ek=eD>=0?1:3;else{ek=eL>=0?0:2;let el=[em[4]*ef,em[5]*ef,em[6]*ef],eu=-Math.sin((eL>=0?e_.getSouth():e_.getNorth())*eF)*rQ;en.v.scaleAndAdd(eS,eS,el,eu)}let eR=ew[ek],eO=ew[(ek+1)%4],eB=new vh(eR,eO,eS),eN=[bh(eB,0)||eR[0],bh(eB,1)||eR[1],bh(eB,2)||eR[2]],eU=Oh(el.zoom);if(eU>0){let ed=function({x:en,y:el,z:eu},ec,ed,ef,em){let e_=1/(1<<eu),ew=en*e_,eT=ew+e_,eM=el*e_,eE=eM+e_,eS=0,eA=(ew+eT)/2-ef;return eA>.5?eS=-1:eA<-.5&&(eS=1),ew=((ew+eS)*ec-(ef*=ec))*ed+ef,eT=((eT+eS)*ec-ef)*ed+ef,eM=(eM*ec-(em*=ec))*ed+em,[[ew,eE=(eE*ec-em)*ed+em,0],[eT,eE,0],[eT,eM,0],[ew,eM,0]]}(ec,eu,el._pixelsPerMercatorPixel,eP,ez);for(let en=0;en<ew.length;en++)wh(ew[en],ed[en],eU);let ef=en.v.add([],ed[ek],ed[(ek+1)%4]);en.v.scale(ef,ef,.5),wh(eN,ef,eU)}for(let el of ew)en.v.min(eE,eE,el),en.v.max(eM,eM,el);return eE[2]=Math.min(eR[2],eO[2]),en.v.min(eE,eE,eN),en.v.max(eM,eM,eN),new oh(eE,eM)}function Ih({x:en,y:el,z:eu},ec=!1){let ed=1/(1<<eu),ef=new r9(tp(en*ed),el===(1<<eu)-1&&ec?-90:ep((el+1)*ed)),em=new r9(tp((en+1)*ed),0===el&&ec?90:ep(el*ed));return new vl(ef,em)}function kh(en){let el=en.getNorth()*eF,eu=en.getSouth()*eF,ec=Math.cos(el),ed=Math.cos(eu),ef=Math.sin(el),em=Math.sin(eu),e_=en.getWest(),ew=en.getEast();return[Th(ed,em,e_),Th(ed,em,ew),Th(ec,ef,ew),Th(ec,ef,e_)]}function Th(en,el,eu,ec=rQ){return[en*Math.sin(eu*=eF)*ec,-el*ec,en*Math.cos(eu)*ec]}function Ph(en,el,eu){return Th(Math.cos(en*eF),Math.sin(en*eF),el,eu)}function zh(en,el,eu,ec){let ed=1<<eu.z,ef=(en/8192+eu.x)/ed;return Ph(ep((el/8192+eu.y)/ed),tp(ef),ec)}function Eh({min:en,max:el}){return 16383/Math.max(el[0]-en[0],el[1]-en[1],el[2]-en[2])}let r3=new Float64Array(16);function Dh(el){let eu=Eh(el),ec=en.m.fromScaling(r3,[eu,eu,eu]);return en.m.translate(ec,ec,en.v.negate([],el.min))}function Ch(el){let eu=en.m.fromTranslation(r3,el.min),ec=1/Eh(el);return en.m.scale(eu,eu,[ec,ec,ec])}function Rh(en){let el=8192/(2*Math.PI);return en/(2*Math.PI)/el}function Lh(en,el){return 8192/(512*Math.pow(2,en))*Eh(_h(el))}function Vh(el,eu,ec,ed,ef){let em=Rh(ec),e_=[el,eu,-ec/(2*Math.PI)],ew=en.m.identity(new Float64Array(16));return en.m.translate(ew,ew,e_),en.m.scale(ew,ew,[em,em,em]),en.m.rotateX(ew,ew,-ef*eF),en.m.rotateY(ew,ew,-ed*eF),ew}function Oh(en){return T(5,6,en)}function Fh(el,eu){let ec=Ph(eu.lat,eu.lng),ed=function(el){let eu=Ph(el._center.lat,el._center.lng),ec=en.v.fromValues(0,1,0),ed=en.v.cross([],ec,eu),ef=en.m.fromRotation([],-el.angle,eu);ed=en.v.transformMat4(ed,ed,ef),en.m.fromRotation(ef,-el._pitch,ed);let em=en.v.normalize([],eu);return en.v.scale(em,em,gh(el.cameraToCenterDistance/el.pixelsPerMeter)),en.v.transformMat4(em,em,ef),en.v.add([],eu,em)}(el),ef=en.v.subtract([],ed,ec);return en.v.angle(ef,ec)}function jh(en,el){return Fh(en,el)>Math.PI/2*1.01}let r4=85*eF,r5=Math.cos(r4),r6=Math.sin(r4),r8=6371008.8,r7=2*Math.PI*r8;let Yh=class Yh{constructor(en,el){if(isNaN(en)||isNaN(el))throw Error(`Invalid LngLat object: (${en}, ${el})`);if(this.lng=+en,this.lat=+el,this.lat>90||this.lat<-90)throw Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Yh(P(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(en){let el=Math.PI/180,eu=this.lat*el,ec=en.lat*el,ed=Math.sin(eu)*Math.sin(ec)+Math.cos(eu)*Math.cos(ec)*Math.cos((en.lng-this.lng)*el);return r8*Math.acos(Math.min(ed,1))}toBounds(en=0){let el=360*en/40075017,eu=el/Math.cos(Math.PI/180*this.lat);return new vl(new Yh(this.lng-eu,this.lat-el),new Yh(this.lng+eu,this.lat+el))}toEcef(en){let el=gh(en);return Ph(this.lat,this.lng,rQ+el)}static convert(en){if(en instanceof Yh)return en;if(Array.isArray(en)&&(2===en.length||3===en.length))return new Yh(Number(en[0]),Number(en[1]));if(!Array.isArray(en)&&"object"==typeof en&&null!==en)return new Yh(Number("lng"in en?en.lng:en.lon),Number(en.lat));throw Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}};var r9=Yh;function Wh(en){return r7*Math.cos(en*Math.PI/180)}function Hh(en){return(180+en)/360}function Jh(en){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+en*Math.PI/360)))/360}function tp(en){return 360*en-180}function ep(en){return 360/Math.PI*Math.atan(Math.exp((180-360*en)*Math.PI/180))-90}let ai=85.051129;function ip(en){return Math.cos(k(en,-ai,ai)*eF)}function sp(en,el){let eu=k(el,0,25.5),ec=Math.pow(2,eu);return ip(en)*r7/(512*ec)}function ap(en){return 1/Math.cos(en*Math.PI/180)}function op(en,el=0){let eu=Math.exp(Math.PI*(1-(en.y+el/8192)/(1<<en.z)*2));return 80150034*eu/(eu*eu+1)/8192/(1<<en.z)}let lp=class lp{constructor(en,el,eu=0){this.x=+en,this.y=+el,this.z=+eu}static fromLngLat(en,el=0){let eu=r9.convert(en);return new lp(Hh(eu.lng),Jh(eu.lat),el/Wh(eu.lat))}toLngLat(){return new r9(tp(this.x),ep(this.y))}toAltitude(){return this.z*Wh(ep(this.y))}meterInMercatorCoordinateUnits(){return 1/r7*ap(ep(this.y))}};function cp(en,el,eu){let ec=en[0],ed=ec.x,ef=ec.y;el(ec);let em=[ec];for(let e_=1;e_<en.length;e_++){let ew=en[e_],{x:eT,y:eM}=ew;el(ew),function up(en,el,eu,ec,ed,ef,em,e_,ew){let eT=(el+ec)/2,eM=(eu+ed)/2,eE=new eB(eT,eM);e_(eE),function(en,el,eu,ec,ed,ef){let em=eu-ed,e_=ec-ef;return Math.abs((ec-el)*em-(eu-en)*e_)/Math.hypot(em,e_)}(eE.x,eE.y,ef.x,ef.y,em.x,em.y)>=ew?(up(en,el,eu,eT,eM,ef,eE,e_,ew),up(en,eT,eM,ec,ed,eE,em,e_,ew)):en.push(em)}(em,ed,ef,eT,eM,ec,ew,el,eu),ed=eT,ef=eM,ec=ew}return em}let ac=-16383-1;function yp(en,el,eu){let ec=en.loadGeometry(),ed=en.extent,ef=8192/ed;if(el&&eu&&eu.projection.isReprojectedInTileSpace){let ef=1<<el.z,{scale:em,x:e_,y:ew,projection:eT}=eu,c=en=>{let eu=tp((el.x+en.x/ed)/ef),ec=ep((el.y+en.y/ed)/ef),eM=eT.project(eu,ec);en.x=(eM.x*em-e_)*ed,en.y=(eM.y*em-ew)*ed};for(let el=0;el<ec.length;el++)if(1!==en.type)ec[el]=cp(ec[el],c,1);else{let en=[];for(let eu of ec[el])eu.x<0||eu.x>=ed||eu.y<0||eu.y>=ed||(c(eu),en.push(eu));ec[el]=en}}for(let en of ec)for(let el of en)!function(en,el){let eu=Math.round(en.x*el),ec=Math.round(en.y*el);en.x=k(eu,ac,16383),en.y=k(ec,ac,16383),(eu<en.x||eu>en.x+1||ec<en.y||ec>en.y+1)&&q("Geometry exceeds allowed extent, reduce your vector tile buffer size")}(el,ef);return ec}function gp(en,el){return{type:en.type,id:en.id,properties:en.properties,geometry:el?yp(en):[]}}function xp(en,el,eu,ec,ed){en.emplaceBack(2*el+(ec+1)/2,2*eu+(ed+1)/2)}function vp(en,el,eu){en.emplaceBack(el.x,el.y,el.z,16384*eu[0],16384*eu[1],16384*eu[2])}let bp=class bp{constructor(en){this.zoom=en.zoom,this.overscaling=en.overscaling,this.layers=en.layers,this.layerIds=this.layers.map(en=>en.fqid),this.index=en.index,this.hasPattern=!1,this.projection=en.projection,this.layoutVertexArray=new $a,this.indexArray=new ao,this.segments=new Do,this.programConfigurations=new fl(en.layers,en.zoom),this.stateDependentLayerIds=this.layers.filter(en=>en.isStateDependent()).map(en=>en.id)}populate(en,el,eu,ec){let ed=this.layers[0],ef=[],em=null;for(let{feature:el,id:e_,index:ew,sourceLayerIndex:eT}of("circle"===ed.type&&(em=ed.layout.get("circle-sort-key")),en)){let en=this.layers[0]._featureFilter.needGeometry,ed=gp(el,en);if(!this.layers[0]._featureFilter.filter(new _a(this.zoom),ed,eu))continue;let eM=em?em.evaluate(ed,{},eu):void 0,eE={id:e_,properties:el.properties,type:el.type,sourceLayerIndex:eT,index:ew,geometry:en?ed.geometry:yp(el,eu,ec),patterns:{},sortKey:eM};ef.push(eE)}em&&ef.sort((en,el)=>en.sortKey-el.sortKey);let e_=null;for(let ed of("globe"===ec.projection.name&&(this.globeExtVertexArray=new Ha,e_=ec.projection),ef)){let{geometry:ec,index:ef,sourceLayerIndex:em}=ed,ew=en[ef].feature;this.addFeature(ed,ec,ef,el.availableImages,eu,e_,el.brightness),el.featureIndex.insert(ew,ec,ef,em,this.index)}}update(en,el,eu,ec,ed){let ef=0!==Object.keys(en).length;ef&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(en,el,ef?this.stateDependentLayers:this.layers,eu,ec,ed)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(en){this.uploaded||(this.layoutVertexBuffer=en.createVertexBuffer(this.layoutVertexArray,iA.members),this.indexBuffer=en.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=en.createVertexBuffer(this.globeExtVertexArray,iI.members))),this.programConfigurations.upload(en),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(en,el,eu,ec,ed,ef,em){for(let eu of el)for(let el of eu){let eu=el.x,ec=el.y;if(eu<0||eu>=8192||ec<0||ec>=8192)continue;if(ef){let en=ef.projectTilePoint(eu,ec,ed),el=ef.upVector(ed,eu,ec),em=this.globeExtVertexArray;vp(em,en,el),vp(em,en,el),vp(em,en,el),vp(em,en,el)}let em=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,en.sortKey),e_=em.vertexLength;xp(this.layoutVertexArray,eu,ec,-1,-1),xp(this.layoutVertexArray,eu,ec,1,-1),xp(this.layoutVertexArray,eu,ec,1,1),xp(this.layoutVertexArray,eu,ec,-1,1),this.indexArray.emplaceBack(e_,e_+1,e_+2),this.indexArray.emplaceBack(e_,e_+2,e_+3),em.vertexLength+=4,em.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,en,eu,{},ec,ed,em)}};function _p(en,el){for(let eu=0;eu<en.length;eu++)if(zp(el,en[eu]))return!0;for(let eu=0;eu<el.length;eu++)if(zp(en,el[eu]))return!0;return!!Sp(en,el)}function Mp(en,el){if(1===en.length)return Pp(el,en[0]);for(let eu=0;eu<el.length;eu++){let ec=el[eu];for(let el=0;el<ec.length;el++)if(zp(en,ec[el]))return!0}for(let eu=0;eu<en.length;eu++)if(Pp(el,en[eu]))return!0;for(let eu=0;eu<el.length;eu++)if(Sp(en,el[eu]))return!0;return!1}function Sp(en,el){if(0===en.length||0===el.length)return!1;for(let ed=0;ed<en.length-1;ed++){let ef=en[ed],em=en[ed+1];for(let en=0;en<el.length-1;en++){var eu,ec;if(G(ef,eu=el[en],ec=el[en+1])!==G(em,eu,ec)&&G(ef,em,eu)!==G(ef,em,ec))return!0}}return!1}function kp(en,el,eu){let ec=eu*eu;if(1===el.length)return en.distSqr(el[0])<ec;for(let eu=1;eu<el.length;eu++)if(Tp(en,el[eu-1],el[eu])<ec)return!0;return!1}function Tp(en,el,eu){let ec=el.distSqr(eu);if(0===ec)return en.distSqr(el);let ed=((en.x-el.x)*(eu.x-el.x)+(en.y-el.y)*(eu.y-el.y))/ec;return en.distSqr(ed<0?el:ed>1?eu:eu.sub(el)._mult(ed)._add(el))}function Pp(en,el){let eu,ec,ed,ef=!1;for(let em=0;em<en.length;em++){eu=en[em];for(let en=0,em=eu.length-1;en<eu.length;em=en++)ec=eu[en],ed=eu[em],ec.y>el.y!=ed.y>el.y&&el.x<(ed.x-ec.x)*(el.y-ec.y)/(ed.y-ec.y)+ec.x&&(ef=!ef)}return ef}function zp(en,el){let eu=!1;for(let ec=0,ed=en.length-1;ec<en.length;ed=ec++){let ef=en[ec],em=en[ed];ef.y>el.y!=em.y>el.y&&el.x<(em.x-ef.x)*(el.y-ef.y)/(em.y-ef.y)+ef.x&&(eu=!eu)}return eu}function Ep(en,el,eu,ec,ed){for(let ef of en)if(el<=ef.x&&eu<=ef.y&&ec>=ef.x&&ed>=ef.y)return!0;let ef=[new eB(el,eu),new eB(el,ed),new eB(ec,ed),new eB(ec,eu)];if(en.length>2){for(let el of ef)if(zp(en,el))return!0}for(let el=0;el<en.length-1;el++)if(function(en,el,eu){let ec=eu[0],ed=eu[2];if(en.x<ec.x&&el.x<ec.x||en.x>ed.x&&el.x>ed.x||en.y<ec.y&&el.y<ec.y||en.y>ed.y&&el.y>ed.y)return!1;let ef=G(en,el,eu[0]);return ef!==G(en,el,eu[1])||ef!==G(en,el,eu[2])||ef!==G(en,el,eu[3])}(en[el],en[el+1],ef))return!0;return!1}function Dp(en,el,eu,ec,ed,ef){let em=el.y-en.y,e_=en.x-el.x;if(ef=ef||0){let en=em*em+e_*e_;if(0===en)return!0;let el=Math.sqrt(en);em/=el,e_/=el}return!((eu.x-en.x)*em+(eu.y-en.y)*e_-ef<0||(ec.x-en.x)*em+(ec.y-en.y)*e_-ef<0||(ed.x-en.x)*em+(ed.y-en.y)*e_-ef<0)}function Cp(en,el,eu,ec,ed,ef,em){return!(Dp(en,el,ec,ed,ef,em)||Dp(el,eu,ec,ed,ef,em)||Dp(eu,en,ec,ed,ef,em)||Dp(ec,ed,en,el,eu,em)||Dp(ed,ef,en,el,eu,em)||Dp(ef,ec,en,el,eu,em))}function Rp(en,el,eu){let ec=el.paint.get(en).value;return"constant"===ec.kind?ec.value:eu.programConfigurations.get(el.id).getMaxValue(en)}function Lp(en){return Math.sqrt(en[0]*en[0]+en[1]*en[1])}function Vp(en,el,eu,ec,ed){if(!el[0]&&!el[1])return en;let ef=eB.convert(el)._mult(ed);"viewport"===eu&&ef._rotate(-ec);let em=[];for(let el=0;el<en.length;el++)em.push(en[el].sub(ef));return em}function Op(en,el,eu,ec){let ed=eB.convert(en)._mult(ec);return"viewport"===el&&ed._rotate(-eu),ed}Ks(bp,"CircleBucket",{omit:["layers"]});let ad=new Da({"circle-sort-key":new Ea(tc.layout_circle["circle-sort-key"]),visibility:new za(tc.layout_circle.visibility)});var af={paint:new Da({"circle-radius":new Ea(tc.paint_circle["circle-radius"]),"circle-color":new Ea(tc.paint_circle["circle-color"]),"circle-blur":new Ea(tc.paint_circle["circle-blur"]),"circle-opacity":new Ea(tc.paint_circle["circle-opacity"]),"circle-translate":new za(tc.paint_circle["circle-translate"]),"circle-translate-anchor":new za(tc.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new za(tc.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new za(tc.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Ea(tc.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Ea(tc.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Ea(tc.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new za(tc.paint_circle["circle-emissive-strength"])}),layout:ad};let am=en.m.create(),Np=en=>{let el=[];return"map"===en.paint.get("circle-pitch-alignment")&&el.push("PITCH_WITH_MAP"),"map"===en.paint.get("circle-pitch-scale")&&el.push("SCALE_WITH_MAP"),el};function $p(el,eu,ec,ed,ef,em,e_,ew,eT){if(em&&el.queryGeometry.isAboveHorizon)return!1;em&&(eT*=el.pixelToTileUnitsFactor);let eM=el.tileID.canonical,eE=ec.projection.upVectorScale(eM,ec.center.lat,ec.worldSize).metersToTile;for(let eA of eu)for(let eu of eA){var eS;let eA=eu.add(ew),eI=ef&&ec.elevation?ec.elevation.exaggeration()*ef.getElevationAt(eA.x,eA.y,!0):0,eC=ec.projection.projectTilePoint(eA.x,eA.y,eM);if(eI>0){let en=ec.projection.upVector(eM,eA.x,eA.y);eC.x+=en[0]*eE*eI,eC.y+=en[1]*eE*eI,eC.z+=en[2]*eE*eI}let eP=em?eA:function(el,eu,ec,ed){let ef=en.e.transformMat4([],[el,eu,ec,1],ed);return new eB(ef[0]/ef[3],ef[1]/ef[3])}(eC.x,eC.y,eC.z,ed),ez=em?el.tilespaceRays.map(el=>(function(el,eu){let ec=en.v.create();return a_[2]=eu,el.intersectsPlane(a_,aw,ec),new eB(ec[0],ec[1])})(el,eI)):el.queryGeometry.screenGeometry,eD=en.e.transformMat4([],[eC.x,eC.y,eC.z,1],ed);if(!e_&&em?eT*=eD[3]/ec.cameraToCenterDistance:e_&&!em&&(eT*=ec.cameraToCenterDistance/eD[3]),em){let en=ep((eu.y/8192+eM.y)/(1<<eM.z));eT/=ec.projection.pixelsPerMeter(en,1)/(1/Wh(en))}if(eS=eT,zp(ez,eP)||kp(eP,ez,eS))return!0}return!1}let a_=en.v.fromValues(0,0,0),aw=en.v.fromValues(0,0,1);let Xp=class Xp extends bp{};function Kp(en,{width:el,height:eu},ec,ed){if(ed){if(ed instanceof Uint8ClampedArray)ed=new Uint8Array(ed.buffer);else if(ed.length!==el*eu*ec)throw RangeError("mismatched image size")}else ed=new Uint8Array(el*eu*ec);return en.width=el,en.height=eu,en.data=ed,en}function Wp(en,el,eu){let{width:ec,height:ed}=el;ec===en.width&&ed===en.height||(Hp(en,el,{x:0,y:0},{x:0,y:0},{width:Math.min(en.width,ec),height:Math.min(en.height,ed)},eu),en.width=ec,en.height=ed,en.data=el.data)}function Hp(en,el,eu,ec,ed,ef,em){if(0===ed.width||0===ed.height)return el;if(ed.width>en.width||ed.height>en.height||eu.x>en.width-ed.width||eu.y>en.height-ed.height)throw RangeError("out of range source coordinates for image copy");if(ed.width>el.width||ed.height>el.height||ec.x>el.width-ed.width||ec.y>el.height-ed.height)throw RangeError("out of range destination coordinates for image copy");let e_=en.data,ew=el.data,eT=4===ef&&em;for(let em=0;em<ed.height;em++){let eM=((eu.y+em)*en.width+eu.x)*ef,eE=((ec.y+em)*el.width+ec.x)*ef;if(eT)for(let en=0;en<ed.width;en++){let el=eM+en*ef+3,eu=eE+en*ef;ew[eu+0]=255,ew[eu+1]=255,ew[eu+2]=255,ew[eu+3]=e_[el]}else for(let en=0;en<ed.width*ef;en++)ew[eE+en]=e_[eM+en]}return el}Ks(Xp,"HeatmapBucket",{omit:["layers"]});let Jp=class Jp{constructor(en,el){Kp(this,en,1,el)}resize(en){Wp(this,new Jp(en),1)}clone(){return new Jp({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(en,el,eu,ec,ed){Hp(en,el,eu,ec,ed,1)}};let Qp=class Qp{constructor(en,el){Kp(this,en,4,el)}resize(en){Wp(this,new Qp(en),4)}replace(en,el){el?this.data.set(en):this.data=en instanceof Uint8ClampedArray?new Uint8Array(en.buffer):en}clone(){return new Qp({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(en,el,eu,ec,ed,ef){Hp(en,el,eu,ec,ed,4,ef)}};let tf=class tf{constructor(en,el){this.width=en.width,this.height=en.height,this.data=el instanceof Uint8Array?new Float32Array(el.buffer):el}};Ks(Jp,"AlphaImage"),Ks(Qp,"RGBAImage");let aT=new Da({visibility:new za(tc.layout_heatmap.visibility)});var aM={paint:new Da({"heatmap-radius":new Ea(tc.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Ea(tc.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new za(tc.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Ba(tc.paint_heatmap["heatmap-color"]),"heatmap-opacity":new za(tc.paint_heatmap["heatmap-opacity"])}),layout:aT};function nf(en){let el={},eu=en.resolution||256,ec=en.clips?en.clips.length:1,ed=en.image||new Qp({width:eu,height:ec}),s=(eu,ec,ef)=>{el[en.evaluationKey]=ef;let em=en.expression.evaluate(el);em&&(ed.data[eu+ec+0]=Math.floor(255*em.r/em.a),ed.data[eu+ec+1]=Math.floor(255*em.g/em.a),ed.data[eu+ec+2]=Math.floor(255*em.b/em.a),ed.data[eu+ec+3]=Math.floor(255*em.a))};if(en.clips)for(let el=0,ed=0;el<ec;++el,ed+=4*eu)for(let ec=0,ef=0;ec<eu;ec++,ef+=4){let em=ec/(eu-1),{start:e_,end:ew}=en.clips[el];s(ed,ef,e_*(1-em)+ew*em)}else for(let en=0,el=0;en<eu;en++,el+=4)s(0,el,en/(eu-1));return ed}let aE=new Da({visibility:new za(tc.layout_hillshade.visibility)});var aS={paint:new Da({"hillshade-illumination-direction":new za(tc.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new za(tc.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new za(tc.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new za(tc.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new za(tc.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new za(tc.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new za(tc.paint_hillshade["hillshade-emissive-strength"])}),layout:aE};let aA=Ua([{name:"a_pos",components:2,type:"Int16"}],4),{members:aI}=aA;var aC={exports:{}};function cf(en,el,eu){eu=eu||2;var ec,ed,ef,em,e_,ew,eT,eM=el&&el.length,eE=eM?el[0]*eu:en.length,eS=hf(en,0,eE,eu,!0),eA=[];if(!eS||eS.next===eS.prev)return eA;if(eM&&(eS=function(en,el,eu,ec){var ed,ef,em,e_=[];for(ed=0,ef=el.length;ed<ef;ed++)(em=hf(en,el[ed]*ec,ed<ef-1?el[ed+1]*ec:en.length,ec,!1))===em.next&&(em.steiner=!0),e_.push(function(en){var el=en,eu=en;do(el.x<eu.x||el.x===eu.x&&el.y<eu.y)&&(eu=el),el=el.next;while(el!==en);return eu}(em));for(e_.sort(xf),ed=0;ed<e_.length;ed++)eu=function(en,el){var eu=function(en,el){var eu,ec,ed,ef=el,em=en.x,e_=en.y,ew=-1/0;do{if(e_<=ef.y&&e_>=ef.next.y&&ef.next.y!==ef.y){var eT=ef.x+(e_-ef.y)*(ef.next.x-ef.x)/(ef.next.y-ef.y);if(eT<=em&&eT>ew&&(ew=eT,ed=ef.x<ef.next.x?ef:ef.next,eT===em))return ed}ef=ef.next}while(ef!==el);if(!ed)return null;var eM,eE=ed,eS=ed.x,eA=ed.y,eI=1/0;ef=ed;do em>=ef.x&&ef.x>=eS&&em!==ef.x&&Mf(e_<eA?em:ew,e_,eS,eA,e_<eA?ew:em,e_,ef.x,ef.y)&&(eM=Math.abs(e_-ef.y)/(em-ef.x),zf(ef,en)&&(eM<eI||eM===eI&&(ef.x>ed.x||ef.x===ed.x&&(eu=ed,ec=ef,0>Sf(eu.prev,eu,ec.prev)&&0>Sf(ec.next,eu,eu.next))))&&(ed=ef,eI=eM)),ef=ef.next;while(ef!==eE);return ed}(en,el);if(!eu)return el;var ec=Ef(eu,en);return pf(ec,ec.next),pf(eu,eu.next)}(e_[ed],eu);return eu}(en,el,eS,eu)),en.length>80*eu){ec=ef=en[0],ed=em=en[1];for(var eI=eu;eI<eE;eI+=eu)(e_=en[eI])<ec&&(ec=e_),(ew=en[eI+1])<ed&&(ed=ew),e_>ef&&(ef=e_),ew>em&&(em=ew);eT=0!==(eT=Math.max(ef-ec,em-ed))?32767/eT:0}return function ff(en,el,eu,ec,ed,ef,em){if(en){!em&&ef&&function(en,el,eu,ec){var ed=en;do 0===ed.z&&(ed.z=_f(ed.x,ed.y,el,eu,ec)),ed.prevZ=ed.prev,ed.nextZ=ed.next,ed=ed.next;while(ed!==en);ed.prevZ.nextZ=null,ed.prevZ=null,function(en){var el,eu,ec,ed,ef,em,e_,ew,eT=1;do{for(eu=en,en=null,ef=null,em=0;eu;){for(em++,ec=eu,e_=0,el=0;el<eT&&(e_++,ec=ec.nextZ);el++);for(ew=eT;e_>0||ew>0&&ec;)0!==e_&&(0===ew||!ec||eu.z<=ec.z)?(ed=eu,eu=eu.nextZ,e_--):(ed=ec,ec=ec.nextZ,ew--),ef?ef.nextZ=ed:en=ed,ed.prevZ=ef,ef=ed;eu=ec}ef.nextZ=null,eT*=2}while(em>1)}(ed)}(en,ec,ed,ef);for(var e_,ew,eT=en;en.prev!==en.next;)if(e_=en.prev,ew=en.next,ef?function(en,el,eu,ec){var ed=en.prev,ef=en.next;if(Sf(ed,en,ef)>=0)return!1;for(var em=ed.x,e_=en.x,ew=ef.x,eT=ed.y,eM=en.y,eE=ef.y,eS=em<e_?em<ew?em:ew:e_<ew?e_:ew,eA=eT<eM?eT<eE?eT:eE:eM<eE?eM:eE,eI=em>e_?em>ew?em:ew:e_>ew?e_:ew,eC=eT>eM?eT>eE?eT:eE:eM>eE?eM:eE,eP=_f(eS,eA,el,eu,ec),ez=_f(eI,eC,el,eu,ec),eD=en.prevZ,eL=en.nextZ;eD&&eD.z>=eP&&eL&&eL.z<=ez;){if(eD.x>=eS&&eD.x<=eI&&eD.y>=eA&&eD.y<=eC&&eD!==ed&&eD!==ef&&Mf(em,eT,e_,eM,ew,eE,eD.x,eD.y)&&Sf(eD.prev,eD,eD.next)>=0||(eD=eD.prevZ,eL.x>=eS&&eL.x<=eI&&eL.y>=eA&&eL.y<=eC&&eL!==ed&&eL!==ef&&Mf(em,eT,e_,eM,ew,eE,eL.x,eL.y)&&Sf(eL.prev,eL,eL.next)>=0))return!1;eL=eL.nextZ}for(;eD&&eD.z>=eP;){if(eD.x>=eS&&eD.x<=eI&&eD.y>=eA&&eD.y<=eC&&eD!==ed&&eD!==ef&&Mf(em,eT,e_,eM,ew,eE,eD.x,eD.y)&&Sf(eD.prev,eD,eD.next)>=0)return!1;eD=eD.prevZ}for(;eL&&eL.z<=ez;){if(eL.x>=eS&&eL.x<=eI&&eL.y>=eA&&eL.y<=eC&&eL!==ed&&eL!==ef&&Mf(em,eT,e_,eM,ew,eE,eL.x,eL.y)&&Sf(eL.prev,eL,eL.next)>=0)return!1;eL=eL.nextZ}return!0}(en,ec,ed,ef):function(en){var el=en.prev,eu=en.next;if(Sf(el,en,eu)>=0)return!1;for(var ec=el.x,ed=en.x,ef=eu.x,em=el.y,e_=en.y,ew=eu.y,eT=ec<ed?ec<ef?ec:ef:ed<ef?ed:ef,eM=em<e_?em<ew?em:ew:e_<ew?e_:ew,eE=ec>ed?ec>ef?ec:ef:ed>ef?ed:ef,eS=em>e_?em>ew?em:ew:e_>ew?e_:ew,eA=eu.next;eA!==el;){if(eA.x>=eT&&eA.x<=eE&&eA.y>=eM&&eA.y<=eS&&Mf(ec,em,ed,e_,ef,ew,eA.x,eA.y)&&Sf(eA.prev,eA,eA.next)>=0)return!1;eA=eA.next}return!0}(en))el.push(e_.i/eu|0),el.push(en.i/eu|0),el.push(ew.i/eu|0),Df(en),en=ew.next,eT=ew.next;else if((en=ew)===eT){em?1===em?ff(en=function(en,el,eu){var ec=en;do{var ed=ec.prev,ef=ec.next.next;!If(ed,ef)&&kf(ed,ec,ec.next,ef)&&zf(ed,ef)&&zf(ef,ed)&&(el.push(ed.i/eu|0),el.push(ec.i/eu|0),el.push(ef.i/eu|0),Df(ec),Df(ec.next),ec=en=ef),ec=ec.next}while(ec!==en);return pf(ec)}(pf(en),el,eu),el,eu,ec,ed,ef,2):2===em&&function(en,el,eu,ec,ed,ef){var em=en;do{for(var e_,ew,eT=em.next.next;eT!==em.prev;){if(em.i!==eT.i&&(e_=em,ew=eT,e_.next.i!==ew.i&&e_.prev.i!==ew.i&&!function(en,el){var eu=en;do{if(eu.i!==en.i&&eu.next.i!==en.i&&eu.i!==el.i&&eu.next.i!==el.i&&kf(eu,eu.next,en,el))return!0;eu=eu.next}while(eu!==en);return!1}(e_,ew)&&(zf(e_,ew)&&zf(ew,e_)&&function(en,el){var eu=en,ec=!1,ed=(en.x+el.x)/2,ef=(en.y+el.y)/2;do eu.y>ef!=eu.next.y>ef&&eu.next.y!==eu.y&&ed<(eu.next.x-eu.x)*(ef-eu.y)/(eu.next.y-eu.y)+eu.x&&(ec=!ec),eu=eu.next;while(eu!==en);return ec}(e_,ew)&&(Sf(e_.prev,e_,ew.prev)||Sf(e_,ew.prev,ew))||If(e_,ew)&&Sf(e_.prev,e_,e_.next)>0&&Sf(ew.prev,ew,ew.next)>0))){var eM=Ef(em,eT);return em=pf(em,em.next),eM=pf(eM,eM.next),ff(em,el,eu,ec,ed,ef,0),void ff(eM,el,eu,ec,ed,ef,0)}eT=eT.next}em=em.next}while(em!==en)}(en,el,eu,ec,ed,ef):ff(pf(en),el,eu,ec,ed,ef,1);break}}}(eS,eA,eu,ec,ed,eT,0),eA}function hf(en,el,eu,ec,ed){var ef,em;if(ed===Rf(en,el,eu,ec)>0)for(ef=el;ef<eu;ef+=ec)em=Bf(ef,en[ef],en[ef+1],em);else for(ef=eu-ec;ef>=el;ef-=ec)em=Bf(ef,en[ef],en[ef+1],em);return em&&If(em,em.next)&&(Df(em),em=em.next),em}function pf(en,el){if(!en)return en;el||(el=en);var eu,ec=en;do if(eu=!1,ec.steiner||!If(ec,ec.next)&&0!==Sf(ec.prev,ec,ec.next))ec=ec.next;else{if(Df(ec),(ec=el=ec.prev)===ec.next)break;eu=!0}while(eu||ec!==el);return el}function xf(en,el){return en.x-el.x}function _f(en,el,eu,ec,ed){return(en=1431655765&((en=858993459&((en=252645135&((en=16711935&((en=(en-eu)*ed|0)|en<<8))|en<<4))|en<<2))|en<<1))|(el=1431655765&((el=858993459&((el=252645135&((el=16711935&((el=(el-ec)*ed|0)|el<<8))|el<<4))|el<<2))|el<<1))<<1}function Mf(en,el,eu,ec,ed,ef,em,e_){return(ed-em)*(el-e_)>=(en-em)*(ef-e_)&&(en-em)*(ec-e_)>=(eu-em)*(el-e_)&&(eu-em)*(ef-e_)>=(ed-em)*(ec-e_)}function Sf(en,el,eu){return(el.y-en.y)*(eu.x-el.x)-(el.x-en.x)*(eu.y-el.y)}function If(en,el){return en.x===el.x&&en.y===el.y}function kf(en,el,eu,ec){var ed=Pf(Sf(en,el,eu)),ef=Pf(Sf(en,el,ec)),em=Pf(Sf(eu,ec,en)),e_=Pf(Sf(eu,ec,el));return ed!==ef&&em!==e_||!(0!==ed||!Tf(en,eu,el))||!(0!==ef||!Tf(en,ec,el))||!(0!==em||!Tf(eu,en,ec))||!(0!==e_||!Tf(eu,el,ec))}function Tf(en,el,eu){return el.x<=Math.max(en.x,eu.x)&&el.x>=Math.min(en.x,eu.x)&&el.y<=Math.max(en.y,eu.y)&&el.y>=Math.min(en.y,eu.y)}function Pf(en){return en>0?1:en<0?-1:0}function zf(en,el){return 0>Sf(en.prev,en,en.next)?Sf(en,el,en.next)>=0&&Sf(en,en.prev,el)>=0:0>Sf(en,el,en.prev)||0>Sf(en,en.next,el)}function Ef(en,el){var eu=new Cf(en.i,en.x,en.y),ec=new Cf(el.i,el.x,el.y),ed=en.next,ef=el.prev;return en.next=el,el.prev=en,eu.next=ed,ed.prev=eu,ec.next=eu,eu.prev=ec,ef.next=ec,ec.prev=ef,ec}function Bf(en,el,eu,ec){var ed=new Cf(en,el,eu);return ec?(ed.next=ec.next,ed.prev=ec,ec.next.prev=ed,ec.next=ed):(ed.prev=ed,ed.next=ed),ed}function Df(en){en.next.prev=en.prev,en.prev.next=en.next,en.prevZ&&(en.prevZ.nextZ=en.nextZ),en.nextZ&&(en.nextZ.prevZ=en.prevZ)}function Cf(en,el,eu){this.i=en,this.x=el,this.y=eu,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Rf(en,el,eu,ec){for(var ed=0,ef=el,em=eu-ec;ef<eu;ef+=ec)ed+=(en[em]-en[ef])*(en[ef+1]+en[em+1]),em=ef;return ed}aC.exports=cf,aC.exports.default=cf,cf.deviation=function(en,el,eu,ec){var ed=el&&el.length,ef=Math.abs(Rf(en,0,ed?el[0]*eu:en.length,eu));if(ed)for(var em=0,e_=el.length;em<e_;em++)ef-=Math.abs(Rf(en,el[em]*eu,em<e_-1?el[em+1]*eu:en.length,eu));var ew=0;for(em=0;em<ec.length;em+=3){var eT=ec[em]*eu,eM=ec[em+1]*eu,eE=ec[em+2]*eu;ew+=Math.abs((en[eT]-en[eE])*(en[eM+1]-en[eT+1])-(en[eT]-en[eM])*(en[eE+1]-en[eT+1]))}return 0===ef&&0===ew?0:Math.abs((ew-ef)/ef)},cf.flatten=function(en){for(var el=en[0][0].length,eu={vertices:[],holes:[],dimensions:el},ec=0,ed=0;ed<en.length;ed++){for(var ef=0;ef<en[ed].length;ef++)for(var em=0;em<el;em++)eu.vertices.push(en[ed][ef][em]);ed>0&&eu.holes.push(ec+=en[ed-1].length)}return eu};var aP=p(aC.exports);function Vf(en,el){let eu,ec;let ed=en.length;if(ed<=1)return[en];let ef=[];for(let el=0;el<ed;el++){let ed=function(en){let el=0;for(let eu,ec,ed=0,ef=en.length,em=ef-1;ed<ef;em=ed++)eu=en[ed],el+=((ec=en[em]).x-eu.x)*(eu.y+ec.y);return el}(en[el]);0!==ed&&(en[el].area=Math.abs(ed),void 0===ec&&(ec=ed<0),ec===ed<0?(eu&&ef.push(eu),eu=[en[el]]):eu.push(en[el]))}if(eu&&ef.push(eu),el>1)for(let en=0;en<ef.length;en++)ef[en].length<=el||(tF(ef[en],el,1,ef[en].length-1,Of),ef[en]=ef[en].slice(0,el));return ef}function Of(en,el){return el.area-en.area}function Ff(en,el,eu){let ec=eu.patternDependencies,ed=!1;for(let eu of el){let el=eu.paint.get(`${en}-pattern`);el.isConstant()||(ed=!0);let ef=el.constantOr(null);ef&&(ed=!0,ec[ef]=!0)}return ed}function jf(en,el,eu,ec,ed){let ef=ed.patternDependencies;for(let em of el){let el=em.paint.get(`${en}-pattern`).value;if("constant"!==el.kind){let en=el.evaluate({zoom:ec},eu,{},ed.availableImages);ef[en=en&&en.name?en.name:en]=!0,eu.patterns[em.id]=en}}return eu}let Uf=class Uf{constructor(en){this.zoom=en.zoom,this.overscaling=en.overscaling,this.layers=en.layers,this.layerIds=this.layers.map(en=>en.fqid),this.index=en.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new $a,this.indexArray=new ao,this.indexArray2=new eo,this.programConfigurations=new fl(en.layers,en.zoom),this.segments=new Do,this.segments2=new Do,this.stateDependentLayerIds=this.layers.filter(en=>en.isStateDependent()).map(en=>en.id),this.projection=en.projection}populate(en,el,eu,ec){this.hasPattern=Ff("fill",this.layers,el);let ed=this.layers[0].layout.get("fill-sort-key"),ef=[];for(let{feature:em,id:e_,index:ew,sourceLayerIndex:eT}of en){let en=this.layers[0]._featureFilter.needGeometry,eM=gp(em,en);if(!this.layers[0]._featureFilter.filter(new _a(this.zoom),eM,eu))continue;let eE=ed?ed.evaluate(eM,{},eu,el.availableImages):void 0,eS={id:e_,properties:em.properties,type:em.type,sourceLayerIndex:eT,index:ew,geometry:en?eM.geometry:yp(em,eu,ec),patterns:{},sortKey:eE};ef.push(eS)}for(let ec of(ed&&ef.sort((en,el)=>en.sortKey-el.sortKey),ef)){let{geometry:ed,index:ef,sourceLayerIndex:em}=ec;if(this.hasPattern){let en=jf("fill",this.layers,ec,this.zoom,el);this.patternFeatures.push(en)}else this.addFeature(ec,ed,ef,eu,{},el.availableImages,el.brightness);el.featureIndex.insert(en[ef].feature,ed,ef,em,this.index)}}update(en,el,eu,ec,ed){let ef=0!==Object.keys(en).length;ef&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(en,el,ef?this.stateDependentLayers:this.layers,eu,ec,ed)}addFeatures(en,el,eu,ec,ed,ef){for(let en of this.patternFeatures)this.addFeature(en,en.geometry,en.index,el,eu,ec,ef)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(en){this.uploaded||(this.layoutVertexBuffer=en.createVertexBuffer(this.layoutVertexArray,aI),this.indexBuffer=en.createIndexBuffer(this.indexArray),this.indexBuffer2=en.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(en),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(en,el,eu,ec,ed,ef=[],em){for(let en of Vf(el,500)){let el=0;for(let eu of en)el+=eu.length;let eu=this.segments.prepareSegment(el,this.layoutVertexArray,this.indexArray),ec=eu.vertexLength,ed=[],ef=[];for(let el of en){if(0===el.length)continue;el!==en[0]&&ef.push(ed.length/2);let eu=this.segments2.prepareSegment(el.length,this.layoutVertexArray,this.indexArray2),ec=eu.vertexLength;this.layoutVertexArray.emplaceBack(el[0].x,el[0].y),this.indexArray2.emplaceBack(ec+el.length-1,ec),ed.push(el[0].x),ed.push(el[0].y);for(let en=1;en<el.length;en++)this.layoutVertexArray.emplaceBack(el[en].x,el[en].y),this.indexArray2.emplaceBack(ec+en-1,ec+en),ed.push(el[en].x),ed.push(el[en].y);eu.vertexLength+=el.length,eu.primitiveLength+=el.length}let em=aP(ed,ef);for(let en=0;en<em.length;en+=3)this.indexArray.emplaceBack(ec+em[en],ec+em[en+1],ec+em[en+2]);eu.vertexLength+=el,eu.primitiveLength+=em.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,en,eu,ed,ef,ec,em)}};Ks(Uf,"FillBucket",{omit:["layers","patternFeatures"]});let az=new Da({"fill-sort-key":new Ea(tc.layout_fill["fill-sort-key"]),visibility:new za(tc.layout_fill.visibility)});var aD={paint:new Da({"fill-antialias":new za(tc.paint_fill["fill-antialias"]),"fill-opacity":new Ea(tc.paint_fill["fill-opacity"]),"fill-color":new Ea(tc.paint_fill["fill-color"]),"fill-outline-color":new Ea(tc.paint_fill["fill-outline-color"]),"fill-translate":new za(tc.paint_fill["fill-translate"]),"fill-translate-anchor":new za(tc.paint_fill["fill-translate-anchor"]),"fill-pattern":new Ea(tc.paint_fill["fill-pattern"]),"fill-emissive-strength":new za(tc.paint_fill["fill-emissive-strength"])}),layout:az};let aL=Ua([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),ak=Ua([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),aR=Ua([{name:"a_centroid_pos",components:2,type:"Uint16"}]),aO=Ua([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),aB=Ua([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:aF}=aL;var aN={};function Qf(en,el,eu,ec,ed){this.properties={},this.extent=eu,this.type=0,this._pbf=en,this._geometry=-1,this._keys=ec,this._values=ed,en.readFields(td,this,el)}function td(en,el,eu){1==en?el.id=eu.readVarint():2==en?function(en,el){for(var eu=en.readVarint()+en.pos;en.pos<eu;){var ec=el._keys[en.readVarint()],ed=el._values[en.readVarint()];el.properties[ec]=ed}}(eu,el):3==en?el.type=eu.readVarint():4==en&&(el._geometry=eu.pos)}function id(en,el){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=en,this._keys=[],this._values=[],this._features=[],en.readFields(sd,this,el),this.length=this._features.length}function sd(en,el,eu){15===en?el.version=eu.readVarint():1===en?el.name=eu.readString():5===en?el.extent=eu.readVarint():2===en?el._features.push(eu.pos):3===en?el._keys.push(eu.readString()):4===en&&el._values.push(function(en){for(var el=null,eu=en.readVarint()+en.pos;en.pos<eu;){var ec=en.readVarint()>>3;el=1===ec?en.readString():2===ec?en.readFloat():3===ec?en.readDouble():4===ec?en.readVarint64():5===ec?en.readVarint():6===ec?en.readSVarint():7===ec?en.readBoolean():null}return el}(eu))}function od(en,el,eu){if(3===en){var ec=new id(eu,eu.readVarint()+eu.pos);ec.length&&(el[ec.name]=ec)}}Qf.types=["Unknown","Point","LineString","Polygon"],Qf.prototype.loadGeometry=function(){var en=this._pbf;en.pos=this._geometry;for(var el,eu=en.readVarint()+en.pos,ec=1,ed=0,ef=0,em=0,e_=[];en.pos<eu;){if(ed<=0){var ew=en.readVarint();ec=7&ew,ed=ew>>3}if(ed--,1===ec||2===ec)ef+=en.readSVarint(),em+=en.readSVarint(),1===ec&&(el&&e_.push(el),el=[]),el.push(new g(ef,em));else{if(7!==ec)throw Error("unknown command "+ec);el&&el.push(el[0].clone())}}return el&&e_.push(el),e_},Qf.prototype.bbox=function(){var en=this._pbf;en.pos=this._geometry;for(var el=en.readVarint()+en.pos,eu=1,ec=0,ed=0,ef=0,em=1/0,e_=-1/0,ew=1/0,eT=-1/0;en.pos<el;){if(ec<=0){var eM=en.readVarint();eu=7&eM,ec=eM>>3}if(ec--,1===eu||2===eu)(ed+=en.readSVarint())<em&&(em=ed),ed>e_&&(e_=ed),(ef+=en.readSVarint())<ew&&(ew=ef),ef>eT&&(eT=ef);else if(7!==eu)throw Error("unknown command "+eu)}return[em,ew,e_,eT]},Qf.prototype.toGeoJSON=function(en,el,eu){var ec,ed,ef=this.extent*Math.pow(2,eu),em=this.extent*en,e_=this.extent*el,ew=this.loadGeometry(),eT=Qf.types[this.type];function c(en){for(var el=0;el<en.length;el++){var eu=en[el];en[el]=[360*(eu.x+em)/ef-180,360/Math.PI*Math.atan(Math.exp((180-360*(eu.y+e_)/ef)*Math.PI/180))-90]}}switch(this.type){case 1:var eM=[];for(ec=0;ec<ew.length;ec++)eM[ec]=ew[ec][0];c(ew=eM);break;case 2:for(ec=0;ec<ew.length;ec++)c(ew[ec]);break;case 3:for(ew=function(en){var el=en.length;if(el<=1)return[en];for(var eu,ec,ed=[],ef=0;ef<el;ef++){var em=function(en){for(var el,eu,ec=0,ed=0,ef=en.length,em=ef-1;ed<ef;em=ed++)ec+=((eu=en[em]).x-(el=en[ed]).x)*(el.y+eu.y);return ec}(en[ef]);0!==em&&(void 0===ec&&(ec=em<0),ec===em<0?(eu&&ed.push(eu),eu=[en[ef]]):eu.push(en[ef]))}return eu&&ed.push(eu),ed}(ew),ec=0;ec<ew.length;ec++)for(ed=0;ed<ew[ec].length;ed++)c(ew[ec][ed])}1===ew.length?ew=ew[0]:eT="Multi"+eT;var eE={type:"Feature",geometry:{type:eT,coordinates:ew},properties:this.properties};return"id"in this&&(eE.id=this.id),eE},id.prototype.feature=function(en){if(en<0||en>=this._features.length)throw Error("feature index out of bounds");this._pbf.pos=this._features[en];var el=this._pbf.readVarint()+this._pbf.pos;return new Qf(this._pbf,el,this.extent,this._keys,this._values)};var aU=aN.VectorTile=function(en,el){this.layers=en.readFields(od,{},el)},aV=aN.VectorTileFeature=Qf;function cd(en,el,eu,ec){let ed=[],ef=0===ec?(en,el,eu,ec,ed,ef)=>{en.push(new eB(ef,eu+(ef-el)/(ec-el)*(ed-eu)))}:(en,el,eu,ec,ed,ef)=>{en.push(new eB(el+(ef-eu)/(ed-eu)*(ec-el),ef))};for(let em of en){let en=[];for(let ed of em){if(ed.length<=2)continue;let em=[];for(let en=0;en<ed.length-1;en++){let e_=ed[en].x,ew=ed[en].y,eT=ed[en+1].x,eM=ed[en+1].y,eE=0===ec?e_:ew,eS=0===ec?eT:eM;eE<el?eS>el&&ef(em,e_,ew,eT,eM,el):eE>eu?eS<eu&&ef(em,e_,ew,eT,eM,eu):em.push(ed[en]),eS<el&&eE>=el&&ef(em,e_,ew,eT,eM,el),eS>eu&&eE<=eu&&ef(em,e_,ew,eT,eM,eu)}let e_=ed[ed.length-1],ew=0===ec?e_.x:e_.y;ew>=el&&ew<=eu&&em.push(e_),em.length&&(e_=em[em.length-1],em[0].x===e_.x&&em[0].y===e_.y||em.push(em[0]),en.push(em))}en.length&&ed.push(en)}return ed}aN.VectorTileLayer=id;let hd=class hd{constructor(en){this._stringToNumber={},this._numberToString=[];for(let el=0;el<en.length;el++){let eu=en[el];this._stringToNumber[eu]=el,this._numberToString[el]=eu}}encode(en){return this._stringToNumber[en]}decode(en){return this._numberToString[en]}};var aj={/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */read:function(en,el,eu,ec,ed){var ef,em,e_=8*ed-ec-1,ew=(1<<e_)-1,eT=ew>>1,eM=-7,eE=eu?ed-1:0,eS=eu?-1:1,eA=en[el+eE];for(eE+=eS,ef=eA&(1<<-eM)-1,eA>>=-eM,eM+=e_;eM>0;ef=256*ef+en[el+eE],eE+=eS,eM-=8);for(em=ef&(1<<-eM)-1,ef>>=-eM,eM+=ec;eM>0;em=256*em+en[el+eE],eE+=eS,eM-=8);if(0===ef)ef=1-eT;else{if(ef===ew)return em?NaN:1/0*(eA?-1:1);em+=Math.pow(2,ec),ef-=eT}return(eA?-1:1)*em*Math.pow(2,ef-ec)},write:function(en,el,eu,ec,ed,ef){var em,e_,ew,eT=8*ef-ed-1,eM=(1<<eT)-1,eE=eM>>1,eS=23===ed?5960464477539062e-23:0,eA=ec?0:ef-1,eI=ec?1:-1,eC=el<0||0===el&&1/el<0?1:0;for(isNaN(el=Math.abs(el))||el===1/0?(e_=isNaN(el)?1:0,em=eM):(em=Math.floor(Math.log(el)/Math.LN2),el*(ew=Math.pow(2,-em))<1&&(em--,ew*=2),(el+=em+eE>=1?eS/ew:eS*Math.pow(2,1-eE))*ew>=2&&(em++,ew/=2),em+eE>=eM?(e_=0,em=eM):em+eE>=1?(e_=(el*ew-1)*Math.pow(2,ed),em+=eE):(e_=el*Math.pow(2,eE-1)*Math.pow(2,ed),em=0));ed>=8;en[eu+eA]=255&e_,eA+=eI,e_/=256,ed-=8);for(em=em<<ed|e_,eT+=ed;eT>0;en[eu+eA]=255&em,eA+=eI,em/=256,eT-=8);en[eu+eA-eI]|=128*eC}};function md(en){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(en)?en:new Uint8Array(en||0),this.pos=0,this.type=0,this.length=this.buf.length}md.Varint=0,md.Fixed64=1,md.Bytes=2,md.Fixed32=5;var aG="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function vd(en){return en.type===md.Bytes?en.readVarint()+en.pos:en.pos+1}function _d(en,el,eu){var ec=el<=16383?1:el<=2097151?2:el<=268435455?3:Math.floor(Math.log(el)/(7*Math.LN2));eu.realloc(ec);for(var ed=eu.pos-1;ed>=en;ed--)eu.buf[ed+ec]=eu.buf[ed]}function wd(en,el){for(var eu=0;eu<en.length;eu++)el.writeVarint(en[eu])}function Md(en,el){for(var eu=0;eu<en.length;eu++)el.writeSVarint(en[eu])}function Ad(en,el){for(var eu=0;eu<en.length;eu++)el.writeFloat(en[eu])}function Sd(en,el){for(var eu=0;eu<en.length;eu++)el.writeDouble(en[eu])}function Id(en,el){for(var eu=0;eu<en.length;eu++)el.writeBoolean(en[eu])}function kd(en,el){for(var eu=0;eu<en.length;eu++)el.writeFixed32(en[eu])}function Td(en,el){for(var eu=0;eu<en.length;eu++)el.writeSFixed32(en[eu])}function Pd(en,el){for(var eu=0;eu<en.length;eu++)el.writeFixed64(en[eu])}function zd(en,el){for(var eu=0;eu<en.length;eu++)el.writeSFixed64(en[eu])}function Ed(en,el){return(en[el]|en[el+1]<<8|en[el+2]<<16)+16777216*en[el+3]}function Bd(en,el,eu){en[eu]=el,en[eu+1]=el>>>8,en[eu+2]=el>>>16,en[eu+3]=el>>>24}function Dd(en,el){return(en[el]|en[el+1]<<8|en[el+2]<<16)+(en[el+3]<<24)}md.prototype={destroy:function(){this.buf=null},readFields:function(en,el,eu){for(eu=eu||this.length;this.pos<eu;){var ec=this.readVarint(),ed=ec>>3,ef=this.pos;this.type=7&ec,en(ed,el,this),this.pos===ef&&this.skip(ec)}return el},readMessage:function(en,el){return this.readFields(en,el,this.readVarint()+this.pos)},readFixed32:function(){var en=Ed(this.buf,this.pos);return this.pos+=4,en},readSFixed32:function(){var en=Dd(this.buf,this.pos);return this.pos+=4,en},readFixed64:function(){var en=Ed(this.buf,this.pos)+4294967296*Ed(this.buf,this.pos+4);return this.pos+=8,en},readSFixed64:function(){var en=Ed(this.buf,this.pos)+4294967296*Dd(this.buf,this.pos+4);return this.pos+=8,en},readFloat:function(){var en=aj.read(this.buf,this.pos,!0,23,4);return this.pos+=4,en},readDouble:function(){var en=aj.read(this.buf,this.pos,!0,52,8);return this.pos+=8,en},readVarint:function(en){var el,eu,ec=this.buf;return el=127&(eu=ec[this.pos++]),eu<128?el:(el|=(127&(eu=ec[this.pos++]))<<7,eu<128?el:(el|=(127&(eu=ec[this.pos++]))<<14,eu<128?el:(el|=(127&(eu=ec[this.pos++]))<<21,eu<128?el:function(en,el,eu){var ec,ed,ef,em=eu.buf;if(ed=(112&(ef=em[eu.pos++]))>>4,ef<128||(ed|=(127&(ef=em[eu.pos++]))<<3,ef<128)||(ed|=(127&(ef=em[eu.pos++]))<<10,ef<128)||(ed|=(127&(ef=em[eu.pos++]))<<17,ef<128)||(ed|=(127&(ef=em[eu.pos++]))<<24,ef<128)||(ed|=(1&(ef=em[eu.pos++]))<<31,ef<128))return ec=ed,el?4294967296*ec+(en>>>0):4294967296*(ec>>>0)+(en>>>0);throw Error("Expected varint not more than 10 bytes")}(el|=(15&(eu=ec[this.pos]))<<28,en,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var en=this.readVarint();return en%2==1?-((en+1)/2):en/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var en,el=this.readVarint()+this.pos,eu=this.pos;return this.pos=el,el-eu>=12&&aG?(en=this.buf,aG.decode(en.subarray(eu,el))):function(en,el,eu){for(var ec="",ed=el;ed<eu;){var ef,em,e_,ew=en[ed],eT=null,eM=ew>239?4:ew>223?3:ew>191?2:1;if(ed+eM>eu)break;1===eM?ew<128&&(eT=ew):2===eM?128==(192&(ef=en[ed+1]))&&(eT=(31&ew)<<6|63&ef)<=127&&(eT=null):3===eM?(em=en[ed+2],128==(192&(ef=en[ed+1]))&&128==(192&em)&&((eT=(15&ew)<<12|(63&ef)<<6|63&em)<=2047||eT>=55296&&eT<=57343)&&(eT=null)):4===eM&&(em=en[ed+2],e_=en[ed+3],128==(192&(ef=en[ed+1]))&&128==(192&em)&&128==(192&e_)&&((eT=(15&ew)<<18|(63&ef)<<12|(63&em)<<6|63&e_)<=65535||eT>=1114112)&&(eT=null)),null===eT?(eT=65533,eM=1):eT>65535&&(eT-=65536,ec+=String.fromCharCode(eT>>>10&1023|55296),eT=56320|1023&eT),ec+=String.fromCharCode(eT),ed+=eM}return ec}(this.buf,eu,el)},readBytes:function(){var en=this.readVarint()+this.pos,el=this.buf.subarray(this.pos,en);return this.pos=en,el},readPackedVarint:function(en,el){if(this.type!==md.Bytes)return en.push(this.readVarint(el));var eu=vd(this);for(en=en||[];this.pos<eu;)en.push(this.readVarint(el));return en},readPackedSVarint:function(en){if(this.type!==md.Bytes)return en.push(this.readSVarint());var el=vd(this);for(en=en||[];this.pos<el;)en.push(this.readSVarint());return en},readPackedBoolean:function(en){if(this.type!==md.Bytes)return en.push(this.readBoolean());var el=vd(this);for(en=en||[];this.pos<el;)en.push(this.readBoolean());return en},readPackedFloat:function(en){if(this.type!==md.Bytes)return en.push(this.readFloat());var el=vd(this);for(en=en||[];this.pos<el;)en.push(this.readFloat());return en},readPackedDouble:function(en){if(this.type!==md.Bytes)return en.push(this.readDouble());var el=vd(this);for(en=en||[];this.pos<el;)en.push(this.readDouble());return en},readPackedFixed32:function(en){if(this.type!==md.Bytes)return en.push(this.readFixed32());var el=vd(this);for(en=en||[];this.pos<el;)en.push(this.readFixed32());return en},readPackedSFixed32:function(en){if(this.type!==md.Bytes)return en.push(this.readSFixed32());var el=vd(this);for(en=en||[];this.pos<el;)en.push(this.readSFixed32());return en},readPackedFixed64:function(en){if(this.type!==md.Bytes)return en.push(this.readFixed64());var el=vd(this);for(en=en||[];this.pos<el;)en.push(this.readFixed64());return en},readPackedSFixed64:function(en){if(this.type!==md.Bytes)return en.push(this.readSFixed64());var el=vd(this);for(en=en||[];this.pos<el;)en.push(this.readSFixed64());return en},skip:function(en){var el=7&en;if(el===md.Varint)for(;this.buf[this.pos++]>127;);else if(el===md.Bytes)this.pos=this.readVarint()+this.pos;else if(el===md.Fixed32)this.pos+=4;else{if(el!==md.Fixed64)throw Error("Unimplemented type: "+el);this.pos+=8}},writeTag:function(en,el){this.writeVarint(en<<3|el)},realloc:function(en){for(var el=this.length||16;el<this.pos+en;)el*=2;if(el!==this.length){var eu=new Uint8Array(el);eu.set(this.buf),this.buf=eu,this.length=el}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(en){this.realloc(4),Bd(this.buf,en,this.pos),this.pos+=4},writeSFixed32:function(en){this.realloc(4),Bd(this.buf,en,this.pos),this.pos+=4},writeFixed64:function(en){this.realloc(8),Bd(this.buf,-1&en,this.pos),Bd(this.buf,Math.floor(23283064365386963e-26*en),this.pos+4),this.pos+=8},writeSFixed64:function(en){this.realloc(8),Bd(this.buf,-1&en,this.pos),Bd(this.buf,Math.floor(23283064365386963e-26*en),this.pos+4),this.pos+=8},writeVarint:function(en){(en=+en||0)>268435455||en<0?function(en,el){var eu,ec,ed,ef,em;if(en>=0?(eu=en%4294967296|0,ec=en/4294967296|0):(ec=~(-en/4294967296),4294967295^(eu=~(-en%4294967296))?eu=eu+1|0:(eu=0,ec=ec+1|0)),en>=18446744073709552e3||en<-18446744073709552e3)throw Error("Given varint doesn't fit into 10 bytes");el.realloc(10),ed=eu,el.buf[el.pos++]=127&ed|128,ed>>>=7,el.buf[el.pos++]=127&ed|128,ed>>>=7,el.buf[el.pos++]=127&ed|128,ed>>>=7,el.buf[el.pos++]=127&ed|128,el.buf[el.pos]=127&(ed>>>=7),em=(7&(ef=ec))<<4,el.buf[el.pos++]|=em|((ef>>>=3)?128:0),ef&&(el.buf[el.pos++]=127&ef|((ef>>>=7)?128:0),ef&&(el.buf[el.pos++]=127&ef|((ef>>>=7)?128:0),ef&&(el.buf[el.pos++]=127&ef|((ef>>>=7)?128:0),ef&&(el.buf[el.pos++]=127&ef|((ef>>>=7)?128:0),ef&&(el.buf[el.pos++]=127&ef)))))}(en,this):(this.realloc(4),this.buf[this.pos++]=127&en|(en>127?128:0),en<=127||(this.buf[this.pos++]=127&(en>>>=7)|(en>127?128:0),en<=127||(this.buf[this.pos++]=127&(en>>>=7)|(en>127?128:0),en<=127||(this.buf[this.pos++]=en>>>7&127))))},writeSVarint:function(en){this.writeVarint(en<0?-(2*en)-1:2*en)},writeBoolean:function(en){this.writeVarint(!!en)},writeString:function(en){en=String(en),this.realloc(4*en.length),this.pos++;var el=this.pos;this.pos=function(en,el,eu){for(var ec,ed,ef=0;ef<el.length;ef++){if((ec=el.charCodeAt(ef))>55295&&ec<57344){if(!ed){ec>56319||ef+1===el.length?(en[eu++]=239,en[eu++]=191,en[eu++]=189):ed=ec;continue}if(ec<56320){en[eu++]=239,en[eu++]=191,en[eu++]=189,ed=ec;continue}ec=ed-55296<<10|ec-56320|65536,ed=null}else ed&&(en[eu++]=239,en[eu++]=191,en[eu++]=189,ed=null);ec<128?en[eu++]=ec:(ec<2048?en[eu++]=ec>>6|192:(ec<65536?en[eu++]=ec>>12|224:(en[eu++]=ec>>18|240,en[eu++]=ec>>12&63|128),en[eu++]=ec>>6&63|128),en[eu++]=63&ec|128)}return eu}(this.buf,en,this.pos);var eu=this.pos-el;eu>=128&&_d(el,eu,this),this.pos=el-1,this.writeVarint(eu),this.pos+=eu},writeFloat:function(en){this.realloc(4),aj.write(this.buf,en,this.pos,!0,23,4),this.pos+=4},writeDouble:function(en){this.realloc(8),aj.write(this.buf,en,this.pos,!0,52,8),this.pos+=8},writeBytes:function(en){var el=en.length;this.writeVarint(el),this.realloc(el);for(var eu=0;eu<el;eu++)this.buf[this.pos++]=en[eu]},writeRawMessage:function(en,el){this.pos++;var eu=this.pos;en(el,this);var ec=this.pos-eu;ec>=128&&_d(eu,ec,this),this.pos=eu-1,this.writeVarint(ec),this.pos+=ec},writeMessage:function(en,el,eu){this.writeTag(en,md.Bytes),this.writeRawMessage(el,eu)},writePackedVarint:function(en,el){el.length&&this.writeMessage(en,wd,el)},writePackedSVarint:function(en,el){el.length&&this.writeMessage(en,Md,el)},writePackedBoolean:function(en,el){el.length&&this.writeMessage(en,Id,el)},writePackedFloat:function(en,el){el.length&&this.writeMessage(en,Ad,el)},writePackedDouble:function(en,el){el.length&&this.writeMessage(en,Sd,el)},writePackedFixed32:function(en,el){el.length&&this.writeMessage(en,kd,el)},writePackedSFixed32:function(en,el){el.length&&this.writeMessage(en,Td,el)},writePackedFixed64:function(en,el){el.length&&this.writeMessage(en,Pd,el)},writePackedSFixed64:function(en,el){el.length&&this.writeMessage(en,zd,el)},writeBytesField:function(en,el){this.writeTag(en,md.Bytes),this.writeBytes(el)},writeFixed32Field:function(en,el){this.writeTag(en,md.Fixed32),this.writeFixed32(el)},writeSFixed32Field:function(en,el){this.writeTag(en,md.Fixed32),this.writeSFixed32(el)},writeFixed64Field:function(en,el){this.writeTag(en,md.Fixed64),this.writeFixed64(el)},writeSFixed64Field:function(en,el){this.writeTag(en,md.Fixed64),this.writeSFixed64(el)},writeVarintField:function(en,el){this.writeTag(en,md.Varint),this.writeVarint(el)},writeSVarintField:function(en,el){this.writeTag(en,md.Varint),this.writeSVarint(el)},writeStringField:function(en,el){this.writeTag(en,md.Bytes),this.writeString(el)},writeFloatField:function(en,el){this.writeTag(en,md.Fixed32),this.writeFloat(el)},writeDoubleField:function(en,el){this.writeTag(en,md.Fixed64),this.writeDouble(el)},writeBooleanField:function(en,el){this.writeVarintField(en,!!el)}};var aq=p(md);let aZ=["tile","layer","source","sourceLayer","state"];let Ld=class Ld{constructor(en,el,eu,ec,ed){this.type="Feature",this._vectorTileFeature=en,this._z=el,this._x=eu,this._y=ec,this.properties=en.properties,this.id=ed}get geometry(){return void 0===this._geometry&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(en){this._geometry=en}toJSON(){let en={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(let el of(void 0!==this.id&&(en.id=this.id),aZ))void 0!==this[el]&&(en[el]=this[el]);return en}};let Vd=class Vd{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(en,el,eu){let ec=String(el);if(this.stateChanges[en]=this.stateChanges[en]||{},this.stateChanges[en][ec]=this.stateChanges[en][ec]||{},B(this.stateChanges[en][ec],eu),null===this.deletedStates[en])for(let el in this.deletedStates[en]={},this.state[en])el!==ec&&(this.deletedStates[en][el]=null);else if(this.deletedStates[en]&&null===this.deletedStates[en][ec])for(let el in this.deletedStates[en][ec]={},this.state[en][ec])eu[el]||(this.deletedStates[en][ec][el]=null);else for(let el in eu)this.deletedStates[en]&&this.deletedStates[en][ec]&&null===this.deletedStates[en][ec][el]&&delete this.deletedStates[en][ec][el]}removeFeatureState(en,el,eu){if(null===this.deletedStates[en])return;let ec=String(el);if(this.deletedStates[en]=this.deletedStates[en]||{},eu&&void 0!==el)null!==this.deletedStates[en][ec]&&(this.deletedStates[en][ec]=this.deletedStates[en][ec]||{},this.deletedStates[en][ec][eu]=null);else if(void 0!==el){if(this.stateChanges[en]&&this.stateChanges[en][ec])for(eu in this.deletedStates[en][ec]={},this.stateChanges[en][ec])this.deletedStates[en][ec][eu]=null;else this.deletedStates[en][ec]=null}else this.deletedStates[en]=null}getState(en,el){let eu=String(el),ec=B({},(this.state[en]||{})[eu],(this.stateChanges[en]||{})[eu]);if(null===this.deletedStates[en])return{};if(this.deletedStates[en]){let eu=this.deletedStates[en][el];if(null===eu)return{};for(let en in eu)delete ec[en]}return ec}initializeTileState(en,el){en.setFeatureState(this.state,el)}coalesceChanges(en,el){let eu={};for(let en in this.stateChanges){this.state[en]=this.state[en]||{};let el={};for(let eu in this.stateChanges[en])this.state[en][eu]||(this.state[en][eu]={}),B(this.state[en][eu],this.stateChanges[en][eu]),el[eu]=this.state[en][eu];eu[en]=el}for(let en in this.deletedStates){this.state[en]=this.state[en]||{};let el={};if(null===this.deletedStates[en])for(let eu in this.state[en])el[eu]={},this.state[en][eu]={};else for(let eu in this.deletedStates[en]){if(null===this.deletedStates[en][eu])this.state[en][eu]={};else if(this.state[en][eu])for(let el of Object.keys(this.deletedStates[en][eu]))delete this.state[en][eu][el];el[eu]=this.state[en][eu]}eu[en]=eu[en]||{},B(eu[en],el)}if(this.stateChanges={},this.deletedStates={},0!==Object.keys(eu).length)for(let ec in en)en[ec].setFeatureState(eu,el)}};let Od=class Od{constructor(en){this.size=en,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(en,el){let eu=this.toIdx(en,el);return{min:this.minimums[eu],max:this.maximums[eu]}}isLeaf(en,el){return this.leaves[this.toIdx(en,el)]}toIdx(en,el){return el*this.size+en}};function Fd(en,el,eu,ec){let ed=0,ef=Number.MAX_VALUE;for(let em=0;em<3;em++)if(1e-15>Math.abs(ec[em])){if(eu[em]<en[em]||eu[em]>el[em])return null}else{let e_=1/ec[em],ew=(en[em]-eu[em])*e_,eT=(el[em]-eu[em])*e_;if(ew>eT){let en=ew;ew=eT,eT=en}if(ew>ed&&(ed=ew),eT<ef&&(ef=eT),ed>ef)return null}return ed}function jd(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM){let eE=ec-en,eS=ed-el,eA=ef-eu,eI=em-en,eC=e_-el,eP=ew-eu,ez=eM[1]*eP-eM[2]*eC,eD=eM[2]*eI-eM[0]*eP,eL=eM[0]*eC-eM[1]*eI,ek=eE*ez+eS*eD+eA*eL;if(1e-15>Math.abs(ek))return null;let eR=1/ek,eO=eT[0]-en,eB=eT[1]-el,eF=eT[2]-eu,eN=(eO*ez+eB*eD+eF*eL)*eR;if(eN<0||eN>1)return null;let eU=eB*eA-eF*eS,eV=eF*eE-eO*eA,ej=eO*eS-eB*eE,eG=(eM[0]*eU+eM[1]*eV+eM[2]*ej)*eR;return eG<0||eN+eG>1?null:(eI*eU+eC*eV+eP*ej)*eR}function Nd(en,el,eu,ec,ed,ef,em,e_,ew){let eT=1<<eu,eM=ef-ec,eE=em-ed;e_[0]=(en+0)/eT*eM+ec,e_[1]=(el+0)/eT*eE+ed,ew[0]=(en+1)/eT*eM+ec,ew[1]=(el+1)/eT*eE+ed}let $d=class $d{constructor(en){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=en,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;let el=function(en){let el=Math.ceil(Math.log2(en.dim/8)),eu=[],ec=Math.ceil(Math.pow(2,el)),ed=1/ec,s=(en,el,eu,ec,ed)=>{let ef=ec?1:0;ed[0]=en*eu,ed[1]=el*eu,ed[2]=(en+1)*eu-ef,ed[3]=(el+1)*eu-ef},ef=new Od(ec),em=[];for(let el=0;el<ec*ec;el++){s(el%ec,Math.floor(el/ec),ed,!1,em);let eu=Gd(em[0],em[1],en),e_=Gd(em[2],em[1],en),ew=Gd(em[2],em[3],en),eT=Gd(em[0],em[3],en);ef.minimums.push(Math.min(eu,e_,ew,eT)),ef.maximums.push(Math.max(eu,e_,ew,eT)),ef.leaves.push(1)}for(eu.push(ef),ec/=2;ec>=1;ec/=2){let en=eu[eu.length-1];ef=new Od(ec);for(let el=0;el<ec*ec;el++){s(el%ec,Math.floor(el/ec),2,!0,em);let eu=en.getElevation(em[0],em[1]),ed=en.getElevation(em[2],em[1]),e_=en.getElevation(em[2],em[3]),ew=en.getElevation(em[0],em[3]),eT=en.isLeaf(em[0],em[1]),eM=en.isLeaf(em[2],em[1]),eE=en.isLeaf(em[2],em[3]),eS=en.isLeaf(em[0],em[3]),eA=Math.min(eu.min,ed.min,e_.min,ew.min),eI=Math.max(eu.max,ed.max,e_.max,ew.max),eC=eT&&eM&&eE&&eS;ef.maximums.push(eI),ef.minimums.push(eA),ef.leaves.push(eI-eA<=5&&eC?1:0)}eu.push(ef)}return eu}(this.dem),eu=el.length-1,ec=el[eu];this._addNode(ec.minimums[0],ec.maximums[0],ec.leaves[0]),this._construct(el,0,0,eu,0)}raycastRoot(en,el,eu,ec,ed,ef,em=1){return Fd([en,el,-100],[eu,ec,this.maximums[0]*em],ed,ef)}raycast(el,eu,ec,ed,ef,em,e_=1){if(!this.nodeCount)return null;let ew=this.raycastRoot(el,eu,ec,ed,ef,em,e_);if(null==ew)return null;let eT=[],eM=[],eE=[],eS=[],eA=[{idx:0,t:ew,nodex:0,nodey:0,depth:0}];for(;eA.length>0;){let{idx:ew,t:eP,nodex:ez,nodey:eD,depth:eL}=eA.pop();if(this.leaves[ew]){Nd(ez,eD,eL,el,eu,ec,ed,eE,eS);let ew=1<<eL,eT=(ez+0)/ew,eM=(ez+1)/ew,eA=(eD+0)/ew,ek=(eD+1)/ew,eR=Gd(eT,eA,this.dem)*e_,eO=Gd(eM,eA,this.dem)*e_,eB=Gd(eM,ek,this.dem)*e_,eF=Gd(eT,ek,this.dem)*e_,eN=jd(eE[0],eE[1],eR,eS[0],eE[1],eO,eS[0],eS[1],eB,ef,em),eU=jd(eS[0],eS[1],eB,eE[0],eS[1],eF,eE[0],eE[1],eR,ef,em),eV=Math.min(null!==eN?eN:Number.MAX_VALUE,null!==eU?eU:Number.MAX_VALUE);if(eV!==Number.MAX_VALUE)return eV;{var eI,eC;let el=en.v.scaleAndAdd([],ef,em,eP);if(qd(eR,eO,eF,eB,(el[0]-(eI=eE[0]))/(eS[0]-eI),(el[1]-(eC=eE[1]))/(eS[1]-eC))>=el[2])return eP}continue}let ek=0;for(let en=0;en<this._siblingOffset.length;en++){Nd((ez<<1)+this._siblingOffset[en][0],(eD<<1)+this._siblingOffset[en][1],eL+1,el,eu,ec,ed,eE,eS),eE[2]=-100,eS[2]=this.maximums[this.childOffsets[ew]+en]*e_;let eA=Fd(eE,eS,ef,em);if(null!=eA){eT[en]=eA;let el=!1;for(let eu=0;eu<ek&&!el;eu++)eA>=eT[eM[eu]]&&(eM.splice(eu,0,en),el=!0);el||(eM[ek]=en),ek++}}for(let en=0;en<ek;en++){let el=eM[en];eA.push({idx:this.childOffsets[ew]+el,t:eT[el],nodex:(ez<<1)+this._siblingOffset[el][0],nodey:(eD<<1)+this._siblingOffset[el][1],depth:eL+1})}}return null}_addNode(en,el,eu){return this.minimums.push(en),this.maximums.push(el),this.leaves.push(eu),this.childOffsets.push(0),this.nodeCount++}_construct(en,el,eu,ec,ed){if(1===en[ec].isLeaf(el,eu))return;this.childOffsets[ed]||(this.childOffsets[ed]=this.nodeCount);let ef=ec-1,em=en[ef],e_=0,ew=0;for(let en=0;en<this._siblingOffset.length;en++){let ec=2*el+this._siblingOffset[en][0],ed=2*eu+this._siblingOffset[en][1],ef=em.getElevation(ec,ed),eT=em.isLeaf(ec,ed),eM=this._addNode(ef.min,ef.max,eT);eT&&(e_|=1<<en),ew||(ew=eM)}for(let ec=0;ec<this._siblingOffset.length;ec++)e_&1<<ec||this._construct(en,2*el+this._siblingOffset[ec][0],2*eu+this._siblingOffset[ec][1],ef,ew+ec)}};function qd(en,el,eu,ec,ed,ef){return Mn(Mn(en,eu,ef),Mn(el,ec,ef),ed)}function Gd(en,el,eu){let ec=eu.dim,ed=k(en*ec-.5,0,ec-1),ef=k(el*ec-.5,0,ec-1),em=Math.floor(ed),e_=Math.floor(ef),ew=Math.min(em+1,ec-1),eT=Math.min(e_+1,ec-1);return qd(eu.get(em,e_),eu.get(ew,e_),eu.get(em,eT),eu.get(ew,eT),ed-em,ef-e_)}let a$={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function Zd(en,el,eu){return(256*en*256+256*el+eu)/10-1e4}function Xd(en,el,eu){return 256*en+el+eu/256-32768}let Kd=class Kd{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(en,el,eu,ec=!1){if(this.uid=en,el.height!==el.width)throw RangeError("DEM tiles must be square");if(eu&&"mapbox"!==eu&&"terrarium"!==eu)return q(`"${eu}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=el.height;let ed=this.dim=el.height-2,ef=new Uint32Array(el.data.buffer);if(this.pixels=new Uint8Array(el.data.buffer),this.floatView=new Float32Array(el.data.buffer),this.borderReady=ec,this._modifiedForSources={},!ec){for(let en=0;en<ed;en++)ef[this._idx(-1,en)]=ef[this._idx(0,en)],ef[this._idx(ed,en)]=ef[this._idx(ed-1,en)],ef[this._idx(en,-1)]=ef[this._idx(en,0)],ef[this._idx(en,ed)]=ef[this._idx(en,ed-1)];ef[this._idx(-1,-1)]=ef[this._idx(0,0)],ef[this._idx(ed,-1)]=ef[this._idx(ed-1,0)],ef[this._idx(-1,ed)]=ef[this._idx(0,ed-1)],ef[this._idx(ed,ed)]=ef[this._idx(ed-1,ed-1)]}let em="terrarium"===eu?Xd:Zd;for(let en=0;en<ef.length;++en){let el=4*en;this.floatView[en]=em(this.pixels[el],this.pixels[el+1],this.pixels[el+2])}this._timestamp=ta.now()}_buildQuadTree(){this._tree=new $d(this)}get(en,el,eu=!1){eu&&(en=k(en,-1,this.dim),el=k(el,-1,this.dim));let ec=this._idx(en,el);return this.floatView[ec]}set(en,el,eu){let ec=this._idx(en,el),ed=this.floatView[ec];return this.floatView[ec]=eu,eu-ed}static getUnpackVector(en){return a$[en]}_idx(en,el){if(en<-1||en>=this.dim+1||el<-1||el>=this.dim+1)throw RangeError("out of range source coordinates for DEM data");return(el+1)*this.stride+(en+1)}static pack(en,el){let eu=[0,0,0,0],ec=Kd.getUnpackVector(el),ed=Math.floor((en+ec[3])/ec[2]);return eu[2]=ed%256,ed=Math.floor(ed/256),eu[1]=ed%256,ed=Math.floor(ed/256),eu[0]=ed,eu}getPixels(){return new tf({width:this.stride,height:this.stride},this.pixels)}backfillBorder(en,el,eu){if(this.dim!==en.dim)throw Error("dem dimension mismatch");let ec=el*this.dim,ed=el*this.dim+this.dim,ef=eu*this.dim,em=eu*this.dim+this.dim;switch(el){case -1:ec=ed-1;break;case 1:ed=ec+1}switch(eu){case -1:ef=em-1;break;case 1:em=ef+1}let e_=-el*this.dim,ew=-eu*this.dim;for(let el=ef;el<em;el++)for(let eu=ec;eu<ed;eu++){let ec=4*this._idx(eu,el),ed=4*this._idx(eu+e_,el+ew);this.pixels[ec+0]=en.pixels[ed+0],this.pixels[ec+1]=en.pixels[ed+1],this.pixels[ec+2]=en.pixels[ed+2],this.pixels[ec+3]=en.pixels[ed+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}};Ks(Kd,"DEMData"),Ks($d,"DemMinMaxQuadTree",{omit:["dem"]});let Wd=class Wd{constructor(en,el,eu){this._demTile=en,this._dem=this._demTile.dem,this._scale=el,this._offset=eu}static create(en,el,eu){let ec=eu||en.findDEMTileFor(el);if(!ec||!ec.dem)return;let ed=ec.dem,ef=ec.tileID,em=1<<el.canonical.z-ef.canonical.z;return new Wd(ec,ed.dim/8192/em,[(el.canonical.x/em-ef.canonical.x)*ed.dim,(el.canonical.y/em-ef.canonical.y)*ed.dim])}tileCoordToPixel(en,el){let eu=el*this._scale+this._offset[1],ec=Math.floor(en*this._scale+this._offset[0]),ed=Math.floor(eu);return new eB(ec,ed)}getElevationAt(en,el,eu,ec){let ed=en*this._scale+this._offset[0],ef=el*this._scale+this._offset[1],em=Math.floor(ed),e_=Math.floor(ef),ew=this._dem;return ec=!!ec,eu?Mn(Mn(ew.get(em,e_,ec),ew.get(em,e_+1,ec),ef-e_),Mn(ew.get(em+1,e_,ec),ew.get(em+1,e_+1,ec),ef-e_),ed-em):ew.get(em,e_,ec)}getElevationAtPixel(en,el,eu){return this._dem.get(en,el,!!eu)}getMeterToDEM(en){return(1<<this._demTile.tileID.canonical.z)*(1/Wh(en))*this._dem.stride}};let Hd=class Hd{constructor(en,el){this.tileID=en,this.x=en.canonical.x,this.y=en.canonical.y,this.z=en.canonical.z,this.grid=new ii(8192,16,0),this.featureIndexArray=new Po,this.promoteId=el}insert(en,el,eu,ec,ed,ef=0){let em=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(eu,ec,ed,ef);let e_=this.grid;for(let en=0;en<el.length;en++){let eu=el[en],ec=[1/0,1/0,-1/0,-1/0];for(let en=0;en<eu.length;en++){let el=eu[en];ec[0]=Math.min(ec[0],el.x),ec[1]=Math.min(ec[1],el.y),ec[2]=Math.max(ec[2],el.x),ec[3]=Math.max(ec[3],el.y)}ec[0]<8192&&ec[1]<8192&&ec[2]>=0&&ec[3]>=0&&e_.insert(em,ec[0],ec[1],ec[2],ec[3])}}loadVTLayers(){if(!this.vtLayers)for(let en in this.vtLayers=new aU(new aq(this.rawTileData)).layers,this.sourceLayerCoder=new hd(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={},this.vtLayers)this.vtFeatures[en]=[];return this.vtLayers}query(en,el,eu,ec){let ed;this.loadVTLayers();let ef=en.params||{},em=ls(ef.filter),e_=en.tileResult,ew=en.transform,eT=e_.bufferedTilespaceBounds,eM=this.grid.query(eT.min.x,eT.min.y,eT.max.x,eT.max.y,(en,el,eu,ec)=>Ep(e_.bufferedTilespaceGeometry,en,el,eu,ec));eM.sort(Qd);let eE=null;ew.elevation&&eM.length>0&&(eE=Wd.create(ew.elevation,this.tileID));let eS={};for(let ew=0;ew<eM.length;ew++){let eT=eM[ew];if(eT===ed)continue;ed=eT;let eA=this.featureIndexArray.get(eT),eI=null;this.loadMatchingFeature(eS,eA,em,ef.layers,ef.availableImages,el,eu,ec,(el,eu,ec,ed=0)=>(eI||(eI=yp(el,this.tileID.canonical,en.tileTransform)),eu.queryIntersectsFeature(e_,el,ec,eI,this.z,en.transform,en.pixelPosMatrix,eE,ed)))}return eS}loadMatchingFeature(en,el,eu,ec,ed,ef,em,e_,ew){let{featureIndex:eT,bucketIndex:eM,sourceLayerIndex:eE,layoutVertexArrayOffset:eS}=el,eA=this.bucketLayerIDs[eM];if(ec&&!function(en,el){for(let eu=0;eu<en.length;eu++)if(el.indexOf(en[eu])>=0)return!0;return!1}(ec,eA))return;let eI=this.sourceLayerCoder.decode(eE),eC=this.vtLayers[eI].feature(eT);if(eu.needGeometry){let en=gp(eC,!0);if(!eu.filter(new _a(this.tileID.overscaledZ),en,this.tileID.canonical))return}else if(!eu.filter(new _a(this.tileID.overscaledZ),eC))return;let eP=this.getId(eC,eI);for(let el=0;el<eA.length;el++){let eu=eA[el];if(ec&&0>ec.indexOf(eu))continue;let eM=ef[eu];if(!eM)continue;let eE={};void 0!==eP&&e_&&(eE=e_.getState(eM.sourceLayer||"_geojsonTileLayer",eP));let eI=B({},em[eu]);eI.paint=Jd(eI.paint,eM.paint,eC,eE,ed),eI.layout=Jd(eI.layout,eM.layout,eC,eE,ed);let ez=!ew||ew(eC,eM,eE,eS);if(!ez)continue;let eD=new Ld(eC,this.z,this.x,this.y,eP);eD.layer=eI;let eL=en[eu];void 0===eL&&(eL=en[eu]=[]),eL.push({featureIndex:eT,feature:eD,intersectionZ:ez})}}lookupSymbolFeatures(en,el,eu,ec,ed,ef,em,e_){let ew={};this.loadVTLayers();let eT=ls(ed);for(let ed of en)this.loadMatchingFeature(ew,{bucketIndex:eu,sourceLayerIndex:ec,featureIndex:ed,layoutVertexArrayOffset:0},eT,ef,em,e_,el);return ew}loadFeature(en){let{featureIndex:el,sourceLayerIndex:eu}=en;this.loadVTLayers();let ec=this.sourceLayerCoder.decode(eu),ed=this.vtFeatures[ec];if(ed[el])return ed[el];let ef=this.vtLayers[ec].feature(el);return ed[el]=ef,ef}hasLayer(en){for(let el of this.bucketLayerIDs)for(let eu of el)if(en===eu)return!0;return!1}getId(en,el){let eu=en.id;if(this.promoteId){let ec="string"==typeof this.promoteId?this.promoteId:this.promoteId[el];null!=ec&&(eu=en.properties[ec]),"boolean"==typeof eu&&(eu=Number(eu))}return eu}};function Jd(en,el,eu,ec,ed){return j(en,(en,ef)=>{let em=el instanceof Pa?el.get(ef):null;return em&&em.evaluate?em.evaluate(eu,ec,ed):em})}function Qd(en,el){return el-en}Ks(Hd,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});let aW=Ua([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),aH=Ua([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),aX=Ua([{name:"a_projected_pos",components:4,type:"Float32"}],4);Ua([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);let aK=Ua([{name:"a_z_offset",components:1,type:"Float32"}],4),aJ=Ua([{name:"a_texb",components:2,type:"Uint16"}]),aY=Ua([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),aQ=Ua([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_z_offset",components:1,type:"Float32"}]);Ua([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);let a0=Ua([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),a1=Ua([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);function hm(en,el){let{expression:eu}=el;if("constant"===eu.kind)return{kind:"constant",layoutSize:eu.evaluate(new _a(en+1))};if("source"===eu.kind)return{kind:"source"};{let{zoomStops:el,interpolationType:ec}=eu,ed=0;for(;ed<el.length&&el[ed]<=en;)ed++;let ef=ed=Math.max(0,ed-1);for(;ef<el.length&&el[ef]<en+1;)ef++;ef=Math.min(el.length-1,ef);let em=el[ed],e_=el[ef];return"composite"===eu.kind?{kind:"composite",minZoom:em,maxZoom:e_,interpolationType:ec}:{kind:"camera",minZoom:em,maxZoom:e_,minSize:eu.evaluate(new _a(em)),maxSize:eu.evaluate(new _a(e_)),interpolationType:ec}}}function pm(en,{uSize:el,uSizeT:eu},{lowerSize:ec,upperSize:ed}){return"source"===en.kind?ec/128:"composite"===en.kind?Mn(ec/128,ed/128,eu):el}function fm(en,el){let eu=0,ec=0;if("constant"===en.kind)ec=en.layoutSize;else if("source"!==en.kind){let{interpolationType:ed,minZoom:ef,maxZoom:em}=en,e_=ed?k(qn.interpolationFactor(ed,el,ef,em),0,1):0;"camera"===en.kind?ec=Mn(en.minSize,en.maxSize,e_):eu=e_}return{uSizeT:eu,uSize:ec}}Ua([{name:"triangle",components:3,type:"Uint16"}]),Ua([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),Ua([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"}]),Ua([{type:"Float32",name:"offsetX"}]),Ua([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var a2=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:128,evaluateSizeForFeature:pm,evaluateSizeForZoom:fm,getSizeData:hm});let a3={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","\xa2":"","\xa3":"","\xa5":"","\xa6":"","\xac":"","\xaf":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};function bm(en,el,eu){el.glyphs=[],1===en&&eu.readMessage(_m,el)}function _m(en,el,eu){if(3===en){let{id:en,bitmap:ec,width:ed,height:ef,left:em,top:e_,advance:ew}=eu.readMessage(wm,{});el.glyphs.push({id:en,bitmap:new Jp({width:ed+6,height:ef+6},ec),metrics:{width:ed,height:ef,left:em,top:e_,advance:ew}})}else 4===en?el.ascender=eu.readSVarint():5===en&&(el.descender=eu.readSVarint())}function wm(en,el,eu){1===en?el.id=eu.readVarint():2===en?el.bitmap=eu.readBytes():3===en?el.width=eu.readVarint():4===en?el.height=eu.readVarint():5===en?el.left=eu.readSVarint():6===en?el.top=eu.readSVarint():7===en&&(el.advance=eu.readVarint())}let a4={horizontal:1,vertical:2,horizontalOnly:3};let Im=class Im{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(en,el){let eu=new Im;return eu.scale=en||1,eu.fontStack=el,eu}static forImage(en){let el=new Im;return el.imageName=en,el}};let km=class km{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(en,el){let eu=new km;for(let ec=0;ec<en.sections.length;ec++){let ed=en.sections[ec];ed.image?eu.addImageSection(ed):eu.addTextSection(ed,el)}return eu}length(){return this.text.length}getSection(en){return this.sections[this.sectionIndex[en]]}getSections(){return this.sections}getSectionIndex(en){return this.sectionIndex[en]}getCodePoint(en){return this.text.codePointAt(en)}verticalizePunctuation(en){this.text=function(en,el){let eu="";for(let ec=0;ec<en.length;ec++){let ed=en.charCodeAt(ec+1)||null,ef=en.charCodeAt(ec-1)||null;eu+=!el&&(ed&&sa(ed)&&!a3[en[ec+1]]||ef&&sa(ef)&&!a3[en[ec-1]])||!a3[en[ec]]?en[ec]:a3[en[ec]]}return eu}(this.text,en)}trim(){let en=0;for(let el=0;el<this.text.length&&a5[this.text.charCodeAt(el)];el++)en++;let el=this.text.length;for(let eu=this.text.length-1;eu>=0&&eu>=en&&a5[this.text.charCodeAt(eu)];eu--)el--;this.text=this.text.substring(en,el),this.sectionIndex=this.sectionIndex.slice(en,el)}substring(en,el){let eu=new km;return eu.text=this.text.substring(en,el),eu.sectionIndex=this.sectionIndex.slice(en,el),eu.sections=this.sections,eu}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((en,el)=>Math.max(en,this.sections[el].scale),0)}addTextSection(en,el){this.text+=en.text,this.sections.push(Im.forText(en.scale,en.fontStack||el));let eu=this.sections.length-1;for(let el=0;el<en.text.length;++el)this.sectionIndex.push(eu)}addImageSection(en){let el=en.image?en.image.namePrimary:"";if(0===el.length)return void q("Can't add FormattedSection with an empty image.");let eu=this.getNextImageSectionCharCode();eu?(this.text+=String.fromCodePoint(eu),this.sections.push(Im.forImage(el)),this.sectionIndex.push(this.sections.length-1)):q("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}};function Tm(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI){let eC=km.fromFeature(en,ed);eE===a4.vertical&&eC.verticalizePunctuation(eS);let eP=[],ez=function(en,el,eu,ec,ed,ef){if(!en)return[];let em=[],e_=function(en,el,eu,ec,ed,ef){let em=0;for(let eu=0;eu<en.length();eu++){let e_=en.getSection(eu);em+=Em(en.getCodePoint(eu),e_,ec,ed,el,ef)}return em/Math.max(1,Math.ceil(em/eu))}(en,el,eu,ec,ed,ef),ew=en.text.indexOf("")>=0,eT=0;for(let eu=0;eu<en.length();eu++){let eM=en.getSection(eu),eE=en.getCodePoint(eu);if(a5[eE]||(eT+=Em(eE,eM,ec,ed,el,ef)),eu<en.length()-1){let el=!(eE<11904||!(iu["Bopomofo Extended"](eE)||iu.Bopomofo(eE)||iu["CJK Compatibility Forms"](eE)||iu["CJK Compatibility Ideographs"](eE)||iu["CJK Compatibility"](eE)||iu["CJK Radicals Supplement"](eE)||iu["CJK Strokes"](eE)||iu["CJK Symbols and Punctuation"](eE)||iu["CJK Unified Ideographs Extension A"](eE)||iu["CJK Unified Ideographs"](eE)||iu["Enclosed CJK Letters and Months"](eE)||iu["Halfwidth and Fullwidth Forms"](eE)||iu.Hiragana(eE)||iu["Ideographic Description Characters"](eE)||iu["Kangxi Radicals"](eE)||iu["Katakana Phonetic Extensions"](eE)||iu.Katakana(eE)||iu["Vertical Forms"](eE)||iu["Yi Radicals"](eE)||iu["Yi Syllables"](eE)));(a6[eE]||el||eM.imageName)&&em.push(Cm(eu+1,eT,e_,em,function(en,el,eu){let ec=0;return 10===en&&(ec-=1e4),eu&&(ec+=150),40!==en&&65288!==en||(ec+=50),41!==el&&65289!==el||(ec+=50),ec}(eE,en.getCodePoint(eu+1),el&&ew),!1))}}return function Rm(en){return en?Rm(en.priorBreak).concat(en.index):[]}(Cm(en.length(),eT,e_,em,0,!0))}(eC,eT,ef,el,ec,eA),{processBidirectionalText:eD,processStyledBidirectionalText:eL}=iM;if(eD&&1===eC.sections.length){let en=eD(eC.toString(),ez);for(let el of en){let en=new km;en.text=el,en.sections=eC.sections;for(let eu=0;eu<el.length;eu++)en.sectionIndex.push(0);eP.push(en)}}else if(eL){let en=eL(eC.text,eC.sectionIndex,ez);for(let el of en){let en=new km;en.text=el[0],en.sectionIndex=el[1],en.sections=eC.sections,eP.push(en)}}else eP=function(en,el){let eu=[],ec=en.text,ed=0;for(let ec of el)eu.push(en.substring(ed,ec)),ed=ec;return ed<ec.length&&eu.push(en.substring(ed,ec.length)),eu}(eC,ez);let ek=[],eR={positionedLines:ek,text:eC.toString(),top:eM[1],bottom:eM[1],left:eM[0],right:eM[0],writingMode:eE,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE){let eS=0,eA=0,eI=0,eC="right"===e_?1:"left"===e_?0:.5,eP=!1;for(let en of ed){let eu=en.getSections();for(let en of eu){if(en.imageName)continue;let eu=el[en.fontStack];if(eu&&!(eP=void 0!==eu.ascender&&void 0!==eu.descender))break}if(!eP)break}let ez=0;for(let em of ed){em.trim();let ed=em.getMaxScale(),e_=(ed-1)*24,eD={positionedGlyphs:[],lineOffset:0};en.positionedLines[ez]=eD;let eL=eD.positionedGlyphs,ek=0;if(!em.length()){eA+=ef,++ez;continue}let eR=0,eO=0;for(let ef=0;ef<em.length();ef++){let e_=em.getSection(ef),eI=em.getSectionIndex(ef),eC=em.getCodePoint(ef),ez=e_.scale,eD=null,eB=null,eF=null,eN=24,eU=0,eV=!(ew===a4.horizontal||!eM&&!ia(eC)||eM&&(a5[eC]||iu.Arabic(eC)||iu["Arabic Supplement"](eC)||iu["Arabic Extended-A"](eC)||iu["Arabic Presentation Forms-A"](eC)||iu["Arabic Presentation Forms-B"](eC)));if(e_.imageName){let el=ec[e_.imageName];if(!el)continue;eF=e_.imageName,en.iconsInText=en.iconsInText||!0,eB=el.paddedRect;let eu=el.displaySize;ez=24*ez/eE,eD={width:eu[0],height:eu[1],left:0,top:-3,advance:eV?eu[1]:eu[0],localGlyph:!1},eU=eP?-eD.height*ez:-17+24*ed-eu[1]*ez,eN=eD.advance;let ef=(eV?eu[0]:eu[1])*ez-24*ed;ef>0&&ef>ek&&(ek=ef)}else{let en=eu[e_.fontStack];if(!en)continue;en[eC]&&(eB=en[eC]);let ec=el[e_.fontStack];if(!ec)continue;let ef=ec.glyphs[eC];if(!ef)continue;if(eD=ef.metrics,eN=8203!==eC?24:0,eP){let en=void 0!==ec.ascender?Math.abs(ec.ascender):0,el=void 0!==ec.descender?Math.abs(ec.descender):0,eu=(en+el)*ez;eR<eu&&(eR=eu,eO=(en-el)/2*ez),eU=-en*ez}else eU=-17+(ed-ez)*24}eV?(en.verticalizable=!0,eL.push({glyph:eC,imageName:eF,x:eS,y:eA+eU,vertical:eV,scale:ez,localGlyph:eD.localGlyph,fontStack:e_.fontStack,sectionIndex:eI,metrics:eD,rect:eB}),eS+=eN*ez+eT):(eL.push({glyph:eC,imageName:eF,x:eS,y:eA+eU,vertical:eV,scale:ez,localGlyph:eD.localGlyph,fontStack:e_.fontStack,sectionIndex:eI,metrics:eD,rect:eB}),eS+=eD.advance*ez+eT)}0!==eL.length&&(eI=Math.max(eS-eT,eI),eP?Vm(eL,eC,ek,eO,ef*ed/2):Vm(eL,eC,ek,0,ef/2)),eS=0;let eB=ef*ed+ek;eD.lineOffset=Math.max(ek,e_),eA+=eB,++ez}let eD=eA,{horizontalAlign:eL,verticalAlign:ek}=Lm(em);(function(en,el,eu,ec,ed,ef){let em=(el-eu)*ed,e_=-ef*ec;for(let el of en)for(let en of el.positionedGlyphs)en.x+=em,en.y+=e_})(en.positionedLines,eC,eL,ek,eI,eD),en.top+=-ek*eD,en.bottom=en.top+eD,en.left+=-eL*eI,en.right=en.left+eI,en.hasBaseline=eP}(eR,el,eu,ec,eP,em,e_,ew,eE,eT,eS,eI),!function(en){for(let el of en)if(0!==el.positionedGlyphs.length)return!1;return!0}(ek)&&eR}let a5={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},a6={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Em(en,el,eu,ec,ed,ef){if(el.imageName){let en=ec[el.imageName];return en?en.displaySize[0]*el.scale*24/ef+ed:0}{let ec=eu[el.fontStack],ef=ec&&ec.glyphs[en];return ef?ef.metrics.advance*el.scale+ed:0}}function Bm(en,el,eu,ec){let ed=Math.pow(en-el,2);return ec?en<el?ed/2:2*ed:ed+Math.abs(eu)*eu}function Cm(en,el,eu,ec,ed,ef){let em=null,e_=Bm(el,eu,ed,ef);for(let en of ec){let ec=Bm(el-en.x,eu,ed,ef)+en.badness;ec<=e_&&(em=en,e_=ec)}return{index:en,x:el,priorBreak:em,badness:e_}}function Lm(en){let el=.5,eu=.5;switch(en){case"right":case"top-right":case"bottom-right":el=1;break;case"left":case"top-left":case"bottom-left":el=0}switch(en){case"bottom":case"bottom-right":case"bottom-left":eu=1;break;case"top":case"top-right":case"top-left":eu=0}return{horizontalAlign:el,verticalAlign:eu}}function Vm(en,el,eu,ec,ed){if(!(el||eu||ec||ed))return;let ef=en.length-1,em=en[ef],e_=(em.x+em.metrics.advance*em.scale)*el;for(let el=0;el<=ef;el++)en[el].x-=e_,en[el].y+=eu+ec+ed}function Fm(en,el,eu,ec,ed,ef){let em,e_,ew,eT,eM;let eE=en.imagePrimary;if(eE.content){let en=eE.content,el=eE.pixelRatio||1;em=[en[0]/el,en[1]/el,eE.displaySize[0]-en[2]/el,eE.displaySize[1]-en[3]/el]}let eS=el.left*ef,eA=el.right*ef;"width"===eu||"both"===eu?(eM=ed[0]+eS-ec[3],ew=ed[0]+eA+ec[1]):ew=(eM=ed[0]+(eS+eA-eE.displaySize[0])/2)+eE.displaySize[0];let eI=el.top*ef,eC=el.bottom*ef;return"height"===eu||"both"===eu?(e_=ed[1]+eI-ec[0],eT=ed[1]+eC+ec[2]):eT=(e_=ed[1]+(eI+eC-eE.displaySize[1])/2)+eE.displaySize[1],{imagePrimary:eE,imageSecondary:void 0,top:e_,right:ew,bottom:eT,left:eM,collisionPadding:em}}let jm=class jm extends eB{constructor(en,el,eu,ec,ed){super(en,el),this.angle=ec,this.z=eu,void 0!==ed&&(this.segment=ed)}clone(){return new jm(this.x,this.y,this.z,this.angle,this.segment)}};function Um(en,el,eu,ec,ed){if(void 0===el.segment)return!0;let ef=el,em=el.segment+1,e_=0;for(;e_>-eu/2;){if(--em<0)return!1;e_-=en[em].dist(ef),ef=en[em]}e_+=en[em].dist(en[em+1]),em++;let ew=[],eT=0;for(;e_<eu/2;){let el=en[em],eu=en[em+1];if(!eu)return!1;let ef=en[em-1].angleTo(el)-el.angleTo(eu);for(ef=Math.abs((ef+3*Math.PI)%(2*Math.PI)-Math.PI),ew.push({distance:e_,angleDelta:ef}),eT+=ef;e_-ew[0].distance>ec;)eT-=ew.shift().angleDelta;if(eT>ed)return!1;em++,e_+=el.dist(eu)}return!0}function Nm(en){let el=0;for(let eu=0;eu<en.length-1;eu++)el+=en[eu].dist(en[eu+1]);return el}function qm(en,el){return Math.max(en?en.right-en.left:0,el?el.right-el.left:0)}function Xm(en,el,eu,ec,ed){let ef=[];for(let em=0;em<en.length;em++){let e_;let ew=en[em];for(let en=0;en<ew.length-1;en++){let em=ew[en],eT=ew[en+1];em.x<el&&eT.x<el||(em.x<el?em=new eB(el,em.y+(el-em.x)/(eT.x-em.x)*(eT.y-em.y))._round():eT.x<el&&(eT=new eB(el,em.y+(el-em.x)/(eT.x-em.x)*(eT.y-em.y))._round()),em.y<eu&&eT.y<eu||(em.y<eu?em=new eB(em.x+(eu-em.y)/(eT.y-em.y)*(eT.x-em.x),eu)._round():eT.y<eu&&(eT=new eB(em.x+(eu-em.y)/(eT.y-em.y)*(eT.x-em.x),eu)._round()),em.x>=ec&&eT.x>=ec||(em.x>=ec?em=new eB(ec,em.y+(ec-em.x)/(eT.x-em.x)*(eT.y-em.y))._round():eT.x>=ec&&(eT=new eB(ec,em.y+(ec-em.x)/(eT.x-em.x)*(eT.y-em.y))._round()),em.y>=ed&&eT.y>=ed||(em.y>=ed?em=new eB(em.x+(ed-em.y)/(eT.y-em.y)*(eT.x-em.x),ed)._round():eT.y>=ed&&(eT=new eB(em.x+(ed-em.y)/(eT.y-em.y)*(eT.x-em.x),ed)._round()),e_&&em.equals(e_[e_.length-1])||(e_=[em],ef.push(e_)),e_.push(eT)))))}}return ef}function Km(en){let el=0,eu=0;for(let ec of en)el+=ec.w*ec.h,eu=Math.max(eu,ec.w);en.sort((en,el)=>el.h-en.h);let ec=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(el/.95)),eu),h:1/0}],ed=0,ef=0;for(let el of en)for(let en=ec.length-1;en>=0;en--){let eu=ec[en];if(!(el.w>eu.w||el.h>eu.h)){if(el.x=eu.x,el.y=eu.y,ef=Math.max(ef,el.y+el.h),ed=Math.max(ed,el.x+el.w),el.w===eu.w&&el.h===eu.h){let el=ec.pop();en<ec.length&&(ec[en]=el)}else el.h===eu.h?(eu.x+=el.w,eu.w-=el.w):(el.w===eu.w||ec.push({x:eu.x+el.w,y:eu.y,w:eu.w-el.w,h:el.h}),eu.y+=el.h,eu.h-=el.h);break}}return{w:ed,h:ef,fill:el/(ed*ef)||0}}Ks(jm,"Anchor");let Hm=class Hm{constructor(en,{pixelRatio:el,version:eu,stretchX:ec,stretchY:ed,content:ef}){this.paddedRect=en,this.pixelRatio=el,this.stretchX=ec,this.stretchY=ed,this.content=ef,this.version=eu}get tl(){return[this.paddedRect.x+1,this.paddedRect.y+1]}get br(){return[this.paddedRect.x+this.paddedRect.w-1,this.paddedRect.y+this.paddedRect.h-1]}get displaySize(){return[(this.paddedRect.w-2)/this.pixelRatio,(this.paddedRect.h-2)/this.pixelRatio]}};let Jm=class Jm{constructor(en,el){let eu={},ec={};this.haveRenderCallbacks=[];let ed=[];this.addImages(en,eu,ed),this.addImages(el,ec,ed);let{w:ef,h:em}=Km(ed),e_=new Qp({width:ef||1,height:em||1});for(let el in en){let ec=en[el],ed=eu[el].paddedRect;Qp.copy(ec.data,e_,{x:0,y:0},{x:ed.x+1,y:ed.y+1},ec.data,ec.sdf)}for(let en in el){let eu=el[en],ed=ec[en].paddedRect,ef=ed.x+1,em=ed.y+1,ew=eu.data.width,eT=eu.data.height;Qp.copy(eu.data,e_,{x:0,y:0},{x:ef,y:em},eu.data),Qp.copy(eu.data,e_,{x:0,y:eT-1},{x:ef,y:em-1},{width:ew,height:1}),Qp.copy(eu.data,e_,{x:0,y:0},{x:ef,y:em+eT},{width:ew,height:1}),Qp.copy(eu.data,e_,{x:ew-1,y:0},{x:ef-1,y:em},{width:1,height:eT}),Qp.copy(eu.data,e_,{x:0,y:0},{x:ef+ew,y:em},{width:1,height:eT})}this.image=e_,this.iconPositions=eu,this.patternPositions=ec}addImages(en,el,eu){for(let ec in en){let ed=en[ec],ef={x:0,y:0,w:ed.data.width+2,h:ed.data.height+2};eu.push(ef),el[ec]=new Hm(ef,ed),ed.hasRenderCallback&&this.haveRenderCallbacks.push(ec)}}patchUpdatedImages(en,el,eu){for(let ec in this.haveRenderCallbacks=this.haveRenderCallbacks.filter(el=>en.hasImage(el,eu)),en.dispatchRenderCallbacks(this.haveRenderCallbacks,eu),en.getUpdatedImages(eu))this.patchUpdatedImage(this.iconPositions[ec],en.getImage(ec,eu),el),this.patchUpdatedImage(this.patternPositions[ec],en.getImage(ec,eu),el)}patchUpdatedImage(en,el,eu){if(!en||!el||en.version===el.version)return;en.version=el.version;let[ec,ed]=en.tl,ef=!!Object.keys(this.patternPositions).length;eu.update(el.data,{useMipmap:ef},{x:ec,y:ed})}};function ty(en,el,eu,ec,ed,ef,em,e_,ew){for(let eT=el;eT<el+ec;eT++)ey(en,eu*ef+eT,ef,ed,em,e_,ew);for(let eT=eu;eT<eu+ed;eT++)ey(en,eT*ef+el,1,ec,em,e_,ew)}function ey(en,el,eu,ec,ed,ef,em){ef[0]=0,em[0]=-1e20,em[1]=1e20,ed[0]=en[el];for(let e_=1,ew=0,eT=0;e_<ec;e_++){ed[e_]=en[el+e_*eu];let ec=e_*e_;do{let en=ef[ew];eT=(ed[e_]-ed[en]+ec-en*en)/(e_-en)/2}while(eT<=em[ew]&&--ew>-1);ef[++ew]=e_,em[ew]=eT,em[ew+1]=1e20}for(let e_=0,ew=0;e_<ec;e_++){for(;em[ew+1]<e_;)ew++;let ec=ef[ew],eT=e_-ec;en[el+e_*eu]=ed[ec]+eT*eT}}Ks(Hm,"ImagePosition"),Ks(Jm,"ImageAtlas");let a8={none:0,ideographs:1,all:2};let iy=class iy{constructor(en,el,eu){this.requestManager=en,this.localGlyphMode=el,this.localFontFamily=eu,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(en,el){this.urls[el]=en}getGlyphs(en,el,eu){let ec=[],ed=this.urls[el]||eC.GLYPHS_URL;for(let el in en)for(let eu of en[el])ec.push({stack:el,id:eu});z(ec,({stack:en,id:el},eu)=>{let ec=this.entries[en];ec||(ec=this.entries[en]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let ef=ec.glyphs[el];if(void 0!==ef)return void eu(null,{stack:en,id:el,glyph:ef});if(ef=this._tinySDF(ec,en,el))return ec.glyphs[el]=ef,void eu(null,{stack:en,id:el,glyph:ef});let em=Math.floor(el/256);if(256*em>65535)return void eu(Error("glyphs > 65535 not supported"));if(ec.ranges[em])return void eu(null,{stack:en,id:el,glyph:ef});let e_=ec.requests[em];e_||(e_=ec.requests[em]=[],iy.loadGlyphRange(en,em,ed,this.requestManager,(en,el)=>{if(el){for(let en in ec.ascender=el.ascender,ec.descender=el.descender,el.glyphs)this._doesCharSupportLocalGlyph(+en)||(ec.glyphs[+en]=el.glyphs[+en]);ec.ranges[em]=!0}for(let eu of e_)eu(en,el);delete ec.requests[em]})),e_.push((ec,ed)=>{ec?eu(ec):ed&&eu(null,{stack:en,id:el,glyph:ed.glyphs[el]||null})})},(en,el)=>{if(en)eu(en);else if(el){let en={};for(let{stack:eu,id:ec,glyph:ed}of el)void 0===en[eu]&&(en[eu]={}),void 0===en[eu].glyphs&&(en[eu].glyphs={}),en[eu].glyphs[ec]=ed&&{id:ed.id,bitmap:ed.bitmap.clone(),metrics:ed.metrics},en[eu].ascender=this.entries[eu].ascender,en[eu].descender=this.entries[eu].descender;eu(null,en)}})}_doesCharSupportLocalGlyph(en){return this.localGlyphMode!==a8.none&&(this.localGlyphMode===a8.all?!!this.localFontFamily:!!this.localFontFamily&&(iu["CJK Unified Ideographs"](en)||iu["Hangul Syllables"](en)||iu.Hiragana(en)||iu.Katakana(en)||iu["CJK Symbols and Punctuation"](en)||iu["CJK Unified Ideographs Extension A"](en)||iu["CJK Unified Ideographs Extension B"](en)))}_tinySDF(en,el,eu){let ec=this.localFontFamily;if(!ec||!this._doesCharSupportLocalGlyph(eu))return;let ed=en.tinySDF;if(!ed){let eu="400";/bold/i.test(el)?eu="900":/medium/i.test(el)?eu="500":/light/i.test(el)&&(eu="200"),(ed=en.tinySDF=new iy.TinySDF({fontFamily:ec,fontWeight:eu,fontSize:48,buffer:6,radius:16})).fontWeight=eu}if(this.localGlyphs[ed.fontWeight][eu])return this.localGlyphs[ed.fontWeight][eu];let ef=String.fromCodePoint(eu),{data:em,width:e_,height:ew,glyphWidth:eT,glyphHeight:eM,glyphLeft:eE,glyphTop:eS,glyphAdvance:eA}=ed.draw(ef);return this.localGlyphs[ed.fontWeight][eu]={id:eu,bitmap:new Jp({width:e_,height:ew},em),metrics:{width:eT/2,height:eM/2,left:eE/2,top:eS/2-27,advance:eA/2,localGlyph:!0}}}};function ay(en,el,eu,ec){let ed=[],ef=en.imagePrimary,em=ef.pixelRatio,e_=ef.paddedRect.w-2,ew=ef.paddedRect.h-2,eT=en.right-en.left,eM=en.bottom-en.top,eE=ef.stretchX||[[0,e_]],eS=ef.stretchY||[[0,ew]],f=(en,el)=>en+el[1]-el[0],eA=eE.reduce(f,0),eI=eS.reduce(f,0),eC=e_-eA,eP=ew-eI,ez=0,eD=eA,eL=0,ek=eI,eR=0,eO=eC,eF=0,eN=eP;if(ef.content&&ec){let en=ef.content;ez=oy(eE,0,en[0]),eL=oy(eS,0,en[1]),eD=oy(eE,en[0],en[2]),ek=oy(eS,en[1],en[3]),eR=en[0]-ez,eF=en[1]-eL,eO=en[2]-en[0]-eD,eN=en[3]-en[1]-ek}let k=(ec,ed,e_,ew)=>{var eE,eS,eC,eP,eU,eV,ej,eG,eq,eZ,e$,eW;let eH=(ec.stretch-ez)/eD*eT+en.left,eX=(eC=ec.fixed-eR,eC-eO*ec.stretch/eA),eK=(ed.stretch-eL)/ek*eM+en.top,eJ=(eV=ed.fixed-eF,eV-eN*ed.stretch/eI),eY=(e_.stretch-ez)/eD*eT+en.left,eQ=(eq=e_.fixed-eR,eq-eO*e_.stretch/eA),e0=(ew.stretch-eL)/ek*eM+en.top,e1=(eW=ew.fixed-eF,eW-eN*ew.stretch/eI),e2=new eB(eH,eK),e3=new eB(eY,eK),e4=new eB(eY,e0),e5=new eB(eH,e0),e6=new eB(eX/em,eJ/em),e8=new eB(eQ/em,e1/em),e7=el*Math.PI/180;if(e7){let en=Math.sin(e7),el=Math.cos(e7),eu=[el,-en,en,el];e2._matMult(eu),e3._matMult(eu),e5._matMult(eu),e4._matMult(eu)}let e9=ec.stretch+ec.fixed,ti=e_.stretch+e_.fixed,ta=ed.stretch+ed.fixed,tc=ew.stretch+ew.fixed,tm=en.imageSecondary;return{tl:e2,tr:e3,bl:e5,br:e4,texPrimary:{x:ef.paddedRect.x+1+e9,y:ef.paddedRect.y+1+ta,w:ti-e9,h:tc-ta},texSecondary:tm?{x:tm.paddedRect.x+1+e9,y:tm.paddedRect.y+1+ta,w:ti-e9,h:tc-ta}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:e6,pixelOffsetBR:e8,minFontScaleX:eO/em/eT,minFontScaleY:eN/em/eM,isSDF:eu}};if(ec&&(ef.stretchX||ef.stretchY)){let en=ly(eE,eC,eA),el=ly(eS,eP,eI);for(let eu=0;eu<en.length-1;eu++){let ec=en[eu],ef=en[eu+1];for(let en=0;en<el.length-1;en++)ed.push(k(ec,el[en],ef,el[en+1]))}}else ed.push(k({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:e_+1},{fixed:0,stretch:ew+1}));return ed}function oy(en,el,eu){let ec=0;for(let ed of en)ec+=Math.max(el,Math.min(eu,ed[1]))-Math.max(el,Math.min(eu,ed[0]));return ec}function ly(en,el,eu){let ec=[{fixed:-1,stretch:0}];for(let[el,eu]of en){let en=ec[ec.length-1];ec.push({fixed:el-en.stretch,stretch:en.stretch}),ec.push({fixed:el-en.stretch,stretch:en.stretch+(eu-el)})}return ec.push({fixed:el+1,stretch:eu}),ec}function fy(en,el){return el.max-en.max}iy.loadGlyphRange=function(en,el,eu,ec,ed){let ef=256*el,em=ef+255,e_=ec.transformRequest(ec.normalizeGlyphsURL(eu).replace("{fontstack}",en).replace("{range}",`${ef}-${em}`),eX.Glyphs);dt(e_,(en,el)=>{if(en)ed(en);else if(el){let en={},eu=new aq(el).readFields(bm,{});for(let el of eu.glyphs)en[el.id]=el;ed(null,{glyphs:en,ascender:eu.ascender,descender:eu.descender})}})},iy.TinySDF=class{constructor({fontSize:en=24,buffer:el=3,radius:eu=8,cutoff:ec=.25,fontFamily:ed="sans-serif",fontWeight:ef="normal",fontStyle:em="normal"}={}){this.buffer=el,this.cutoff=ec,this.radius=eu;let e_=this.size=en+4*el,ew=this._createCanvas(e_),eT=this.ctx=ew.getContext("2d",{willReadFrequently:!0});eT.font=`${em} ${ef} ${en}px ${ed}`,eT.textBaseline="alphabetic",eT.textAlign="left",eT.fillStyle="black",this.gridOuter=new Float64Array(e_*e_),this.gridInner=new Float64Array(e_*e_),this.f=new Float64Array(e_),this.z=new Float64Array(e_+1),this.v=new Uint16Array(e_)}_createCanvas(en){let el=document.createElement("canvas");return el.width=el.height=en,el}draw(en){let{width:el,actualBoundingBoxAscent:eu,actualBoundingBoxDescent:ec,actualBoundingBoxLeft:ed,actualBoundingBoxRight:ef}=this.ctx.measureText(en),em=Math.ceil(eu),e_=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(ef-ed))),ew=Math.min(this.size-this.buffer,em+Math.ceil(ec)),eT=e_+2*this.buffer,eM=ew+2*this.buffer,eE=Math.max(eT*eM,0),eS=new Uint8ClampedArray(eE),eA={data:eS,width:eT,height:eM,glyphWidth:e_,glyphHeight:ew,glyphTop:em,glyphLeft:0,glyphAdvance:el};if(0===e_||0===ew)return eA;let{ctx:eI,buffer:eC,gridInner:eP,gridOuter:ez}=this;eI.clearRect(eC,eC,e_,ew),eI.fillText(en,eC,eC+em);let eD=eI.getImageData(eC,eC,e_,ew);ez.fill(1e20,0,eE),eP.fill(0,0,eE);for(let en=0;en<ew;en++)for(let el=0;el<e_;el++){let eu=eD.data[4*(en*e_+el)+3]/255;if(0===eu)continue;let ec=(en+eC)*eT+el+eC;if(1===eu)ez[ec]=0,eP[ec]=1e20;else{let en=.5-eu;ez[ec]=en>0?en*en:0,eP[ec]=en<0?en*en:0}}ty(ez,0,0,eT,eM,eT,this.f,this.v,this.z),ty(eP,eC,eC,e_,ew,eT,this.f,this.v,this.z);for(let en=0;en<eE;en++){let el=Math.sqrt(ez[en])-Math.sqrt(eP[en]);eS[en]=Math.round(255-255*(el/this.radius+this.cutoff))}return eA}};let dy=class dy{constructor(en,el,eu,ec){this.p=new eB(en,el),this.h=eu,this.d=function(en,el){let eu=!1,ec=1/0;for(let ed=0;ed<el.length;ed++){let ef=el[ed];for(let el=0,ed=ef.length,em=ed-1;el<ed;em=el++){let ed=ef[el],e_=ef[em];ed.y>en.y!=e_.y>en.y&&en.x<(e_.x-ed.x)*(en.y-ed.y)/(e_.y-ed.y)+ed.x&&(eu=!eu),ec=Math.min(ec,Tp(en,ed,e_))}}return(eu?1:-1)*Math.sqrt(ec)}(this.p,ec),this.max=this.d+this.h*Math.SQRT2}};let a7=Number.POSITIVE_INFINITY,a9=Math.sqrt(2);function xy(en,[el,eu]){let ec=0,ed=0;if(eu===a7){el<0&&(el=0);let eu=el/a9;switch(en){case"top-right":case"top-left":ed=eu-7;break;case"bottom-right":case"bottom-left":ed=-eu+7;break;case"bottom":ed=-el+7;break;case"top":ed=el-7}switch(en){case"top-right":case"bottom-right":ec=-eu;break;case"top-left":case"bottom-left":ec=eu;break;case"left":ec=el;break;case"right":ec=-el}}else{switch(el=Math.abs(el),eu=Math.abs(eu),en){case"top-right":case"top-left":case"top":ed=eu-7;break;case"bottom-right":case"bottom-left":case"bottom":ed=-eu+7}switch(en){case"top-right":case"bottom-right":case"right":ec=-el;break;case"top-left":case"bottom-left":case"left":ec=el}}return[ec,ed]}function by(en){switch(en){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Ay(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC,eP,ez){let eD=function(en,el,eu,ec,ed,ef,em,e_){let ew=[];if(0===el.positionedLines.length)return ew;let eT=ec.layout.get("text-rotate").evaluate(ef,{})*Math.PI/180,eM=function(en){let el=en[0],eu=en[1],ec=el*eu;return ec>0?[el,-eu]:ec<0?[-el,eu]:0===el?[eu,el]:[eu,-el]}(eu),eE=Math.abs(el.top-el.bottom);for(let en of el.positionedLines)eE-=en.lineOffset;let eS=el.positionedLines.length,eA=eE/eS,eI=el.top-eu[1];for(let en=0;en<eS;++en){let ec=el.positionedLines[en];for(let ef of(eI=function(en,el,eu,ec){let ed=el+en.positionedLines[ec].lineOffset;return 0===ec?eu+ed/2:eu+(ed+(el+en.positionedLines[ec-1].lineOffset))/2}(el,eA,eI,en),ec.positionedGlyphs)){let en,ec,eE,eS;if(!ef.rect)continue;let eA=ef.rect||{},eC=4,eP=!0,ez=1,eD=0;if(ef.imageName){let en=em[ef.imageName];if(!en)continue;if(en.sdf){q("SDF images are not supported in formatted text and will be ignored.");continue}eP=!1,eC=1/(ez=en.pixelRatio)}let eL=(ed||e_)&&ef.vertical,ek=ef.metrics.advance*ef.scale/2,eR=ef.metrics,eO=ef.rect;if(null===eO)continue;e_&&el.verticalizable&&(eD=ef.imageName?ek-ef.metrics.width*ef.scale/2:0);let eF=ed?[ef.x+ek,ef.y]:[0,0],eN=[0,0],eU=[0,0],eV=!1;ed||(eL?(eU=[ef.x+ek+eM[0],ef.y+eM[1]-eD],eV=!0):eN=[ef.x+ek+eu[0],ef.y+eu[1]-eD]);let ej=eO.w*ef.scale/(ez*(ef.localGlyph?2:1)),eG=eO.h*ef.scale/(ez*(ef.localGlyph?2:1));if(eL){let el=ef.y-eI,eu=new eB(-ek,ek-el),ed=-Math.PI/2,em=new eB(...eU);(en=new eB(-ek+eN[0],eN[1]))._rotateAround(ed,eu)._add(em),en.x+=-el+ek,en.y-=(eR.left-eC)*ef.scale;let e_=ef.imageName?eR.advance*ef.scale:24*ef.scale,ew=String.fromCodePoint(ef.glyph);""===ew||""===ew||""===ew||""===ew||""===ew||""===ew||""===ew||""===ew||""===ew||""===ew||""===ew||""===ew||""===ew||""===ew||""===ew||""===ew||""===ew?en.x+=(1-eC)*ef.scale:""===ew||""===ew||""===ew||""===ew||""===ew||""===ew||""===ew||""===ew||""===ew||""===ew?en.x+=e_-eR.height*ef.scale+(-eC-1)*ef.scale:en.x+=ef.imageName||eR.width+2*eC===eO.w&&eR.height+2*eC===eO.h?(e_-eG)/2:(e_-(eR.height+2*eC)*ef.scale)/2,ec=new eB(en.x,en.y-ej),eE=new eB(en.x+eG,en.y),eS=new eB(en.x+eG,en.y-ej)}else{let el=(eR.left-eC)*ef.scale-ek+eN[0],eu=(-eR.top-eC)*ef.scale+eN[1],ed=el+ej,em=eu+eG;en=new eB(el,eu),ec=new eB(ed,eu),eE=new eB(el,em),eS=new eB(ed,em)}if(eT){let el;el=ed?new eB(0,0):eV?new eB(eM[0],eM[1]):new eB(eu[0],eu[1]),en._rotateAround(eT,el),ec._rotateAround(eT,el),eE._rotateAround(eT,el),eS._rotateAround(eT,el)}let eq=new eB(0,0),eZ=new eB(0,0);ew.push({tl:en,tr:ec,bl:eE,br:eS,texPrimary:eA,texSecondary:void 0,writingMode:el.writingMode,glyphOffset:eF,sectionIndex:ef.sectionIndex,isSDF:eP,pixelOffsetTL:eq,pixelOffsetBR:eZ,minFontScaleX:0,minFontScaleY:0})}}return ew}(0,ec,ew,ef,em,e_,ed,en.allowVerticalPlacement),eL=en.textSizeData,ek=null;for(let ec of("source"===eL.kind?(ek=[128*ef.layout.get("text-size").evaluate(e_,{},eP)])[0]>32640&&q(`${en.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`):"composite"===eL.kind&&((ek=[128*eI.compositeTextSizes[0].evaluate(e_,{},eP),128*eI.compositeTextSizes[1].evaluate(e_,{},eP)])[0]>32640||ek[1]>32640)&&q(`${en.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`),en.addSymbols(en.text,eD,ek,ew,em,e_,eM,el,eu,eT.lineStartIndex,eT.lineLength,eA,eC,eP,ez,!1),eE))eS[ec]=en.text.placedSymbolArray.length-1;return 4*eD.length}function Sy(en){for(let el in en)return en[el];return null}function Iy(en,el,eu,ec,ed,ef,em,e_,ew,eT){let eM=em.top,eE=em.bottom,eS=em.left,eA=em.right,eI=em.collisionPadding;if(eI&&(eS-=eI[0],eM-=eI[1],eA+=eI[2],eE+=eI[3]),ew){let en=new eB(eS,eM),el=new eB(eA,eM),eu=new eB(eS,eE),ec=new eB(eA,eE),ed=ew*eF,ef=new eB(0,0);eT&&(ef=new eB(eT[0],eT[1])),en._rotateAround(ed,ef),el._rotateAround(ed,ef),eu._rotateAround(ed,ef),ec._rotateAround(ed,ef),eS=Math.min(en.x,el.x,eu.x,ec.x),eA=Math.max(en.x,el.x,eu.x,ec.x),eM=Math.min(en.y,el.y,eu.y,ec.y),eE=Math.max(en.y,el.y,eu.y,ec.y)}return en.emplaceBack(el.x,el.y,el.z,eu.x,eu.y,eS,eM,eA,eE,e_,ec,ed,ef),en.length-1}function ky(en){en.collisionPadding&&(en.top-=en.collisionPadding[1],en.bottom+=en.collisionPadding[3]);let el=en.bottom-en.top;return el>0?Math.max(10,el):null}function Py(en,el){let eu=en.fovAboveCenter,ec=en.elevation?en.elevation.getMinElevationBelowMSL()*el:0,ed=(en._camera.position[2]*en.worldSize-ec)/Math.cos(en._pitch),ef=Math.sin(eu)*ed/Math.sin(Math.max(Math.PI/2-en._pitch-eu,.01)),em=Math.sin(en._pitch)*ef+ed;return Math.min(1.01*em,ed*(1/en._horizonShift))}function zy(en,el){if(!el.isReprojectedInTileSpace)return{scale:1<<en.z,x:en.x,y:en.y,x2:en.x+1,y2:en.y+1,projection:el};let eu=Math.pow(2,-en.z),ec=en.x*eu,ed=(en.x+1)*eu,ef=en.y*eu,em=(en.y+1)*eu,e_=tp(ec),ew=tp(ed),eT=ep(ef),eM=ep(em),eE=el.project(e_,eT),eS=el.project(ew,eT),eA=el.project(ew,eM),eI=el.project(e_,eM),eC=Math.min(eE.x,eS.x,eA.x,eI.x),eP=Math.min(eE.y,eS.y,eA.y,eI.y),ez=Math.max(eE.x,eS.x,eA.x,eI.x),eD=Math.max(eE.y,eS.y,eA.y,eI.y),eL=eu/16;function b(en,eu,ec,ed,ef,em){let e_=(ec+ef)/2,ew=(ed+em)/2,eT=el.project(tp(e_),ep(ew)),eM=Math.max(0,eC-eT.x,eP-eT.y,eT.x-ez,eT.y-eD);eC=Math.min(eC,eT.x),ez=Math.max(ez,eT.x),eP=Math.min(eP,eT.y),eD=Math.max(eD,eT.y),eM>eL&&(b(en,eT,ec,ed,e_,ew),b(eT,eu,e_,ew,ef,em))}b(eE,eS,ec,ef,ed,ef),b(eS,eA,ed,ef,ed,em),b(eA,eI,ed,em,ec,em),b(eI,eE,ec,em,ec,ef),eC-=eL,eP-=eL,ez+=eL,eD+=eL;let ek=1/Math.max(ez-eC,eD-eP);return{scale:ek,x:eC*ek,y:eP*ek,x2:ez*ek,y2:eD*ek,projection:el}}function Ey(en,{x:el,y:eu},ec=0){return new eB(((el-ec)*en.scale-en.x)*8192,(eu*en.scale-en.y)*8192)}let nt=en.m.identity(new Float32Array(16));let Dy=class Dy{constructor(en){this.spec=en,this.name=en.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(en,el){return{x:0,y:0,z:0}}unproject(en,el){return new r9(0,0)}projectTilePoint(en,el,eu){return{x:en,y:el,z:0}}locationPoint(en,el,eu=!0){return en._coordinatePoint(en.locationCoordinate(el),eu)}pixelsPerMeter(en,el){return 1/Wh(en)*el}pixelSpaceConversion(en,el,eu){return 1}farthestPixelDistance(en){return Py(en,en.pixelsPerMeter)}pointCoordinate(en,el,eu,ec){let ed=en.horizonLineFromTop(!1),ef=new eB(el,Math.max(ed,eu));return en.rayIntersectionCoordinate(en.pointRayIntersection(ef,ec))}pointCoordinate3D(en,el,eu){let ec=new eB(el,eu);if(en.elevation)return en.elevation.pointCoordinate(ec);{let el=this.pointCoordinate(en,ec.x,ec.y,0);return[el.x,el.y,el.z]}}isPointAboveHorizon(en,el){if(en.elevation)return!this.pointCoordinate3D(en,el.x,el.y);let eu=en.horizonLineFromTop();return el.y<eu}createInversionMatrix(en,el){return nt}createTileMatrix(el,eu,ec){let ed,ef,em;let e_=ec.canonical,ew=en.m.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){let eT=zy(e_,this);ed=1,ef=eT.x+ec.wrap*eT.scale,em=eT.y,en.m.scale(ew,ew,[ed/eT.scale,ed/eT.scale,el.pixelsPerMeter/eu])}else ed=eu/el.zoomScale(e_.z),ef=(e_.x+Math.pow(2,e_.z)*ec.wrap)*ed,em=e_.y*ed;return en.m.translate(ew,ew,[ef,em,0]),en.m.scale(ew,ew,[ed/8192,ed/8192,1]),ew}upVector(en,el,eu){return[0,0,1]}upVectorScale(en,el,eu){return{metersToTile:1}}};let Cy=class Cy extends Dy{constructor(en){super(en),this.range=[4,7],this.center=en.center||[-96,37.5];let[el,eu]=this.parallels=en.parallels||[29.5,45.5],ec=Math.sin(el*eF);this.n=(ec+Math.sin(eu*eF))/2,this.c=1+ec*(2*this.n-ec),this.r0=Math.sqrt(this.c)/this.n}project(en,el){let{n:eu,c:ec,r0:ed}=this,ef=(en-this.center[0])*eF,em=el*eF,e_=Math.sqrt(ec-2*eu*Math.sin(em))/eu;return{x:e_*Math.sin(ef*eu),y:e_*Math.cos(ef*eu)-ed,z:0}}unproject(en,el){let{n:eu,c:ec,r0:ed}=this,ef=ed+el,em=Math.atan2(en,Math.abs(ef))*Math.sign(ef);ef*eu<0&&(em-=Math.PI*Math.sign(en)*Math.sign(ef));let e_=this.center[0]*eF*eu;em=P(em,-Math.PI-e_,Math.PI-e_);let ew=k(em/eu*eN+this.center[0],-180,180),eT=Math.asin(k((ec-(en*en+ef*ef)*eu*eu)/(2*eu),-1,1)),eM=k(eT*eN,-ai,ai);return new r9(ew,eM)}};let nr=Math.sqrt(3)/2;let jy=class jy extends Dy{project(en,el){el=el/180*Math.PI,en=en/180*Math.PI;let eu=Math.asin(nr*Math.sin(el)),ec=eu*eu,ed=ec*ec*ec;return{x:.5*(en*Math.cos(eu)/(nr*(1.340264+-.24331799999999998*ec+ed*(.0062510000000000005+.034164*ec)))/Math.PI+.5),y:1-.5*(eu*(1.340264+-.081106*ec+ed*(893e-6+.003796*ec))/Math.PI+1),z:0}}unproject(en,el){en=(2*en-.5)*Math.PI;let eu=el=(2*(1-el)-1)*Math.PI,ec=eu*eu,ed=ec*ec*ec;for(let en,ef,em=0;em<12&&(ef=eu*(1.340264+-.081106*ec+ed*(893e-6+.003796*ec))-el,ed=(ec=(eu=k(eu-(en=ef/(1.340264+-.24331799999999998*ec+ed*(.0062510000000000005+.034164*ec))),-Math.PI/3,Math.PI/3))*eu)*ec*ec,!(1e-12>Math.abs(en)));++em);let ef=nr*en*(1.340264+-.24331799999999998*ec+ed*(.0062510000000000005+.034164*ec))/Math.cos(eu),em=Math.asin(Math.sin(eu)/nr),e_=k(180*ef/Math.PI,-180,180),ew=k(180*em/Math.PI,-ai,ai);return new r9(e_,ew)}};let Uy=class Uy extends Dy{constructor(en){super(en),this.wrap=!0,this.supportsWorldCopies=!0}project(en,el){return{x:.5+en/360,y:.5-el/360,z:0}}unproject(en,el){let eu=k(360*(.5-el),-ai,ai);return new r9(360*(en-.5),eu)}};let na=Math.PI/2;function $y(en){return Math.tan((na+en)/2)}let qy=class qy extends Dy{constructor(en){super(en),this.center=en.center||[0,30];let[el,eu]=this.parallels=en.parallels||[30,30],ec=el*eF,ed=eu*eF;this.southernCenter=ec+ed<0,this.southernCenter&&(ec=-ec,ed=-ed);let ef=Math.cos(ec),em=$y(ec);this.n=ec===ed?Math.sin(ec):Math.log(ef/Math.cos(ed))/Math.log($y(ed)/em),this.f=ef*Math.pow($y(ec),this.n)/this.n}project(en,el){el*=eF,this.southernCenter&&(el=-el),en=(en-this.center[0])*eF;let{n:eu,f:ec}=this;ec>0?el<-na+1e-6&&(el=-na+1e-6):el>na-1e-6&&(el=na-1e-6);let ed=ec/Math.pow($y(el),eu),ef=ed*Math.sin(eu*en),em=ec-ed*Math.cos(eu*en);return ef=.5*(ef/Math.PI+.5),em=.5*(em/Math.PI+.5),{x:ef,y:this.southernCenter?em:1-em,z:0}}unproject(en,el){en=(2*en-.5)*Math.PI,this.southernCenter&&(el=1-el),el=(2*(1-el)-.5)*Math.PI;let{n:eu,f:ec}=this,ed=ec-el,ef=Math.sign(ed),em=Math.sign(eu)*Math.sqrt(en*en+ed*ed),e_=Math.atan2(en,Math.abs(ed))*ef;ed*eu<0&&(e_-=Math.PI*Math.sign(en)*ef);let ew=k(e_/eu*eN+this.center[0],-180,180),eT=k((2*Math.atan(Math.pow(ec/em,1/eu))-na)*eN,-ai,ai);return new r9(ew,this.southernCenter?-eT:eT)}};let Gy=class Gy extends Dy{constructor(en){super(en),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(en,el){return{x:Hh(en),y:Jh(el),z:0}}unproject(en,el){let eu=tp(en),ec=ep(el);return new r9(eu,ec)}};let nn=ai*eF;let Zy=class Zy extends Dy{project(en,el){let eu=(el*=eF)*el,ec=eu*eu;return{x:.5*((en*=eF)*(.8707-.131979*eu+ec*(ec*(.003971*eu-.001529*ec)-.013791))/Math.PI+.5),y:1-.5*(el*(1.007226+eu*(.015085+ec*(.028874*eu-.044475-.005916*ec)))/Math.PI+1),z:0}}unproject(en,el){en=(2*en-.5)*Math.PI;let eu=el=(2*(1-el)-1)*Math.PI,ec=25,ed=0,ef=eu*eu;do{ef=eu*eu;let en=ef*ef;ed=(eu*(1.007226+ef*(.015085+en*(.028874*ef-.044475-.005916*en)))-el)/(1.007226+ef*(.045255+en*(.259866*ef-.311325-.005916*11*en))),eu=k(eu-ed,-nn,nn)}while(Math.abs(ed)>1e-6&&--ec>0);ef=eu*eu;let em=k(en/(.8707+ef*(ef*(ef*ef*ef*(.003971-.001529*ef)-.013791)-.131979))*eN,-180,180),e_=eu*eN;return new r9(em,e_)}};let nl=ai*eF;let Ky=class Ky extends Dy{project(en,el){el*=eF,en*=eF;let eu=Math.cos(el),ec=2/Math.PI,ed=Math.acos(eu*Math.cos(en/2)),ef=Math.sin(ed)/ed,em=.5*(en*ec+2*eu*Math.sin(en/2)/ef)||0,e_=.5*(el+Math.sin(el)/ef)||0;return{x:.5*(em/Math.PI+.5),y:1-.5*(e_/Math.PI+1),z:0}}unproject(en,el){let eu=en=(2*en-.5)*Math.PI,ec=el=(2*(1-el)-1)*Math.PI,ed=25,ef=0,em=0;do{let ed=Math.cos(ec),e_=Math.sin(ec),ew=2*e_*ed,eT=e_*e_,eM=ed*ed,eE=Math.cos(eu/2),eS=Math.sin(eu/2),eA=2*eE*eS,eI=eS*eS,eC=1-eM*eE*eE,eP=eC?1/eC:0,ez=eC?Math.acos(ed*eE)*Math.sqrt(1/eC):0,eD=.5*(2*ez*ed*eS+2*eu/Math.PI)-en,eL=.5*(ez*e_+ec)-el,ek=.5*eP*(eM*eI+ez*ed*eE*eT)+1/Math.PI,eR=eP*(eA*ew/4-ez*e_*eS),eO=.125*eP*(ew*eS-ez*e_*eM*eA),eB=.5*eP*(eT*eE+ez*eI*ed)+.5,eF=eR*eO-eB*ek;ef=(eL*eR-eD*eB)/eF,em=(eD*eO-eL*ek)/eF,eu=k(eu-ef,-Math.PI,Math.PI),ec=k(ec-em,-nl,nl)}while((Math.abs(ef)>1e-6||Math.abs(em)>1e-6)&&--ed>0);return new r9(eu*eN,ec*eN)}};let Wy=class Wy extends Dy{constructor(en){super(en),this.center=en.center||[0,0],this.parallels=en.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(this.parallels[0]*eF)),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(en,el){let{scale:eu,cosPhi:ec}=this;return{x:en*eF*ec*eu+.5,y:-Math.sin(el*eF)/ec*eu+.5,z:0}}unproject(en,el){let{scale:eu,cosPhi:ec}=this,ed=-(el-.5)/eu,ef=k((en-.5)/eu*eN/ec,-180,180),em=Math.asin(k(ed*ec,-1,1)),e_=k(em*eN,-ai,ai);return new r9(ef,e_)}};let Hy=class Hy extends Gy{constructor(en){super(en),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(el,eu,ec){let ed=zh(el,eu,ec),ef=Dh(_h(ec));return en.v.transformMat4(ed,ed,ef),{x:ed[0],y:ed[1],z:ed[2]}}locationPoint(el,eu){let ec=Ph(eu.lat,eu.lng),ed=en.v.normalize([],ec),ef=el.elevation?el.elevation.getAtPointOrZero(el.locationCoordinate(eu),el._centerAltitude):el._centerAltitude,em=1/Wh(0)*8192*ef;en.v.scaleAndAdd(ec,ec,ed,em);let e_=en.m.identity(new Float64Array(16));return en.m.multiply(e_,el.pixelMatrix,el.globeMatrix),en.v.transformMat4(ec,ec,e_),new eB(ec[0],ec[1])}pixelsPerMeter(en,el){return 1/Wh(0)*el}pixelSpaceConversion(en,el,eu){let ec=1/Wh(en)*el,ed=Mn(1/Wh(45)*el,ec,eu);return this.pixelsPerMeter(en,el)/ed}createTileMatrix(el,eu,ec){let ed=Ch(_h(ec.canonical));return en.m.multiply(new Float64Array(16),el.globeMatrix,ed)}createInversionMatrix(el,eu){let{center:ec}=el,ed=Dh(_h(eu));return en.m.rotateY(ed,ed,ec.lng*eF),en.m.rotateX(ed,ed,ec.lat*eF),en.m.scale(ed,ed,[el._pixelsPerMercatorPixel,el._pixelsPerMercatorPixel,1]),Float32Array.from(ed)}pointCoordinate(en,el,eu,ec){return xh(en,el,eu,!0)||new lp(0,0)}pointCoordinate3D(en,el,eu){let ec=this.pointCoordinate(en,el,eu,0);return[ec.x,ec.y,ec.z]}isPointAboveHorizon(en,el){return!xh(en,el.x,el.y,!1)}farthestPixelDistance(el){let eu=function(el,eu){let ec;let ed=el.cameraToCenterDistance,ef=el._centerAltitude*eu,em=el._camera,e_=el._camera.forward(),ew=en.v.add([],en.v.scale([],e_,-ed),[0,0,ef]),eT=el.worldSize/(2*Math.PI),eM=[0,0,-eT],eE=el.width/el.height,eS=Math.tan(el.fovAboveCenter),eA=en.v.scale([],em.up(),eS),eI=en.v.scale([],em.right(),eS*eE),eC=en.v.normalize([],en.v.add([],en.v.add([],e_,eA),eI)),eP=[];if(new th(ew,eC).closestPointOnSphere(eM,eT,eP)){let eu=en.v.add([],eP,eM),ed=en.v.sub([],eu,ew);ec=Math.cos(el.fovAboveCenter)*en.v.length(ed)}else{let el=en.v.sub([],ew,eM),eu=en.v.sub([],eM,ew);en.v.normalize(eu,eu);let ed=en.v.length(el)-eT;ec=Math.sqrt(ed*(ed+2*eT));let ef=Math.acos(ec/(eT+ed))-Math.acos(en.v.dot(e_,eu));ec*=Math.cos(ef)}return 1.01*ec}(el,this.pixelsPerMeter(el.center.lat,el.worldSize)),ec=Oh(el.zoom);if(ec>0){let en=Py(el,1/Wh(el.center.lat)*el.worldSize),ed=el.worldSize/(2*Math.PI),ef=Math.max(el.width,el.height)/el.worldSize*Math.PI;return Mn(eu,en+ed*(1-Math.cos(ef)),Math.pow(ec,10))}return eu}upVector(en,el,eu){return zh(el,eu,en,1)}upVectorScale(en){return{metersToTile:gh(Eh(_h(en)))}}};function Jy(en){let el=en.parallels,eu=!!el&&.01>Math.abs(el[0]+el[1]);switch(en.name){case"mercator":return new Gy(en);case"equirectangular":return new Uy(en);case"naturalEarth":return new Zy(en);case"equalEarth":return new jy(en);case"winkelTripel":return new Ky(en);case"albers":return eu?new Wy(en):new Cy(en);case"lambertConformalConic":return eu?new Wy(en):new qy(en);case"globe":return new Hy(en)}throw Error(`Invalid projection name: ${en.name}`)}let nc=new Da({"symbol-placement":new za(tc.layout_symbol["symbol-placement"]),"symbol-spacing":new za(tc.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new za(tc.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Ea(tc.layout_symbol["symbol-sort-key"]),"symbol-z-order":new za(tc.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new za(tc.layout_symbol["symbol-z-elevate"]),"icon-allow-overlap":new za(tc.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new za(tc.layout_symbol["icon-ignore-placement"]),"icon-optional":new za(tc.layout_symbol["icon-optional"]),"icon-rotation-alignment":new za(tc.layout_symbol["icon-rotation-alignment"]),"icon-size":new Ea(tc.layout_symbol["icon-size"]),"icon-text-fit":new Ea(tc.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Ea(tc.layout_symbol["icon-text-fit-padding"]),"icon-image":new Ea(tc.layout_symbol["icon-image"]),"icon-rotate":new Ea(tc.layout_symbol["icon-rotate"]),"icon-padding":new za(tc.layout_symbol["icon-padding"]),"icon-keep-upright":new za(tc.layout_symbol["icon-keep-upright"]),"icon-offset":new Ea(tc.layout_symbol["icon-offset"]),"icon-anchor":new Ea(tc.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new za(tc.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new za(tc.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new za(tc.layout_symbol["text-rotation-alignment"]),"text-field":new Ea(tc.layout_symbol["text-field"]),"text-font":new Ea(tc.layout_symbol["text-font"]),"text-size":new Ea(tc.layout_symbol["text-size"]),"text-max-width":new Ea(tc.layout_symbol["text-max-width"]),"text-line-height":new Ea(tc.layout_symbol["text-line-height"]),"text-letter-spacing":new Ea(tc.layout_symbol["text-letter-spacing"]),"text-justify":new Ea(tc.layout_symbol["text-justify"]),"text-radial-offset":new Ea(tc.layout_symbol["text-radial-offset"]),"text-variable-anchor":new za(tc.layout_symbol["text-variable-anchor"]),"text-anchor":new Ea(tc.layout_symbol["text-anchor"]),"text-max-angle":new za(tc.layout_symbol["text-max-angle"]),"text-writing-mode":new za(tc.layout_symbol["text-writing-mode"]),"text-rotate":new Ea(tc.layout_symbol["text-rotate"]),"text-padding":new za(tc.layout_symbol["text-padding"]),"text-keep-upright":new za(tc.layout_symbol["text-keep-upright"]),"text-transform":new Ea(tc.layout_symbol["text-transform"]),"text-offset":new Ea(tc.layout_symbol["text-offset"]),"text-allow-overlap":new za(tc.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new za(tc.layout_symbol["text-ignore-placement"]),"text-optional":new za(tc.layout_symbol["text-optional"]),visibility:new za(tc.layout_symbol.visibility)});var nd={paint:new Da({"icon-opacity":new Ea(tc.paint_symbol["icon-opacity"]),"icon-emissive-strength":new Ea(tc.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new Ea(tc.paint_symbol["text-emissive-strength"]),"icon-color":new Ea(tc.paint_symbol["icon-color"]),"icon-halo-color":new Ea(tc.paint_symbol["icon-halo-color"]),"icon-halo-width":new Ea(tc.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Ea(tc.paint_symbol["icon-halo-blur"]),"icon-translate":new za(tc.paint_symbol["icon-translate"]),"icon-translate-anchor":new za(tc.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new Ea(tc.paint_symbol["icon-image-cross-fade"]),"text-opacity":new Ea(tc.paint_symbol["text-opacity"]),"text-color":new Ea(tc.paint_symbol["text-color"],{runtimeType:tT,getOverride:en=>en.textColor,hasOverride:en=>!!en.textColor}),"text-halo-color":new Ea(tc.paint_symbol["text-halo-color"]),"text-halo-width":new Ea(tc.paint_symbol["text-halo-width"]),"text-halo-blur":new Ea(tc.paint_symbol["text-halo-blur"]),"text-translate":new za(tc.paint_symbol["text-translate"]),"text-translate-anchor":new za(tc.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new za(tc.paint_symbol["icon-color-saturation"])}),layout:nc};let eg=class eg{constructor(en){this.type=en.property.overrides?en.property.overrides.runtimeType:t_,this.defaultValue=en}evaluate(en){if(en.formattedSection){let el=this.defaultValue.property.overrides;if(el&&el.hasOverride(en.formattedSection))return el.getOverride(en.formattedSection)}return en.feature&&en.featureState?this.defaultValue.evaluate(en.feature,en.featureState):this.defaultValue.property.specification.default}eachChild(en){this.defaultValue.isConstant()||en(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}};Ks(eg,"FormatSectionOverride",{omit:["defaultValue"]});let rg=class rg extends Va{constructor(en,el,eu){super(en,nd,el,eu)}recalculate(en,el){super.recalculate(en,el),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));let eu=this.layout.get("text-writing-mode");if(eu){let en=[];for(let el of eu)0>en.indexOf(el)&&en.push(el);this.layout._values["text-writing-mode"]=en}else this.layout._values["text-writing-mode"]="point"===this.layout.get("symbol-placement")?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getValueAndResolveTokens(en,el,eu,ec){var ed;let ef=this.layout.get(en).evaluate(el,{},eu,ec),em=this._unevaluatedLayout._values[en];return em.isDataDriven()||Zi(em.value)||!ef?ef:(ed=el.properties,ef.replace(/{([^{}]+)}/g,(en,el)=>el in ed?String(ed[el]):""))}createBucket(en){return new n_(en)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(let en of nd.paint.overridableProperties){if(!rg.hasPaintOverride(this.layout,en))continue;let el=this.paint.get(en),eu=new eg(el),ec=new Yi(eu,el.property.specification,this.scope,this.options),ed=null;ed="constant"===el.value.kind||"source"===el.value.kind?new Ki("source",ec):new Wi("composite",ec,el.value.zoomStops,el.value._interpolationType),this.paint._values[en]=new Ta(el.property,ed,el.parameters)}}_handleOverridablePaintPropertyUpdate(en,el,eu){return!(!this.layout||el.isDataDriven()||eu.isDataDriven())&&rg.hasPaintOverride(this.layout,en)}static hasPaintOverride(en,el){let eu=en.get("text-field"),ec=nd.paint.properties[el],ed=!1,s=en=>{for(let el of en)if(ec.overrides&&ec.overrides.hasOverride(el))return void(ed=!0)};if("constant"===eu.value.kind&&eu.value.value instanceof Oe)s(eu.value.value.sections);else if("source"===eu.value.kind){let t=en=>{ed||(en instanceof qe&&Ne(en.value)===tA?s(en.value.sections):en instanceof We?s(en.sections):en.eachChild(t))},en=eu.value;en._styleExpression&&t(en._styleExpression.expression)}return ed}getProgramIds(){let en=0!==this.paint.get("icon-opacity").constantOr(1),el=0!==this.paint.get("text-opacity").constantOr(1),eu=[];return en&&eu.push("symbolIcon"),el&&eu.push("symbolSDF"),eu}getDefaultProgramParams(en,el){return{config:new pl(this,el),overrideFog:!1}}};let np=aV.types,nm=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function sg(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS){let eA=e_?Math.min(32640,Math.round(e_[0])):0,eI=e_?Math.min(32640,Math.round(e_[1])):0;en.emplaceBack(el,eu,Math.round(32*ec),Math.round(32*ed),ef,em,(eA<<1)+(ew?1:0),eI,16*eT,16*eM,256*eE,256*eS)}function ag(en,el,eu){en.emplaceBack(el,eu)}function og(en,el,eu,ec,ed,ef,em){en.emplaceBack(el,eu,ec,ed,ef,em)}function lg(en,el,eu,ec,ed){en.emplaceBack(el,eu,ec,ed),en.emplaceBack(el,eu,ec,ed),en.emplaceBack(el,eu,ec,ed),en.emplaceBack(el,eu,ec,ed)}let cg=class cg{constructor(en){this.layoutVertexArray=new Ja,this.indexArray=new ao,this.programConfigurations=en,this.segments=new Do,this.dynamicLayoutVertexArray=new Xa,this.opacityVertexArray=new to,this.placedSymbolArray=new Mo,this.iconTransitioningVertexArray=new eo,this.globeExtVertexArray=new Qa,this.zOffsetVertexArray=new uo}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length&&0===this.iconTransitioningVertexArray.length}upload(en,el,eu,ec,ed){this.isEmpty()||(eu&&(this.layoutVertexBuffer=en.createVertexBuffer(this.layoutVertexArray,aW.members),this.indexBuffer=en.createIndexBuffer(this.indexArray,el),this.dynamicLayoutVertexBuffer=en.createVertexBuffer(this.dynamicLayoutVertexArray,aX.members,!0),this.opacityVertexBuffer=en.createVertexBuffer(this.opacityVertexArray,nm,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=en.createVertexBuffer(this.iconTransitioningVertexArray,aJ.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=en.createVertexBuffer(this.globeExtVertexArray,aH.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||ed)&&(this.zOffsetVertexBuffer=en.createVertexBuffer(this.zOffsetVertexArray,aK.members,!0)),this.opacityVertexBuffer.itemSize=1),(eu||ec)&&this.programConfigurations.upload(en))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}};Ks(cg,"SymbolBuffers");let hg=class hg{constructor(en,el,eu){this.layoutVertexArray=new en,this.layoutAttributes=el,this.indexArray=new eu,this.segments=new Do,this.collisionVertexArray=new so,this.collisionVertexArrayExt=new Xa}upload(en){this.layoutVertexBuffer=en.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=en.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=en.createVertexBuffer(this.collisionVertexArray,aY.members,!0),this.collisionVertexBufferExt=en.createVertexBuffer(this.collisionVertexArrayExt,aQ.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}};Ks(hg,"CollisionBuffers");let pg=class pg{constructor(el){this.collisionBoxArray=el.collisionBoxArray,this.zoom=el.zoom,this.overscaling=el.overscaling,this.layers=el.layers,this.layerIds=this.layers.map(en=>en.fqid),this.index=el.index,this.pixelRatio=el.pixelRatio,this.sourceLayerIndex=el.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=en.m.identity([]),this.placementViewportMatrix=en.m.identity([]);let eu=this.layers[0]._unevaluatedLayout._values;this.textSizeData=hm(this.zoom,eu["text-size"]),this.iconSizeData=hm(this.zoom,eu["icon-size"]);let ec=this.layers[0].layout,ed=ec.get("symbol-sort-key"),ef=ec.get("symbol-z-order");this.canOverlap=ec.get("text-allow-overlap")||ec.get("icon-allow-overlap")||ec.get("text-ignore-placement")||ec.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==ef&&void 0!==ed.constantOr(1),this.sortFeaturesByY=("viewport-y"===ef||"auto"===ef&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=ec.get("text-writing-mode").map(en=>a4[en]),this.stateDependentLayerIds=this.layers.filter(en=>en.isStateDependent()).map(en=>en.id),this.sourceID=el.sourceID,this.projection=el.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=ec.get("symbol-z-elevate")}createArrays(){this.text=new cg(new fl(this.layers,this.zoom,en=>/^text/.test(en))),this.icon=new cg(new fl(this.layers,this.zoom,en=>/^icon/.test(en))),this.glyphOffsetArray=new Io,this.lineVertexArray=new ko,this.symbolInstances=new So}calculateGlyphDependencies(en,el,eu,ec,ed){for(let eu=0;eu<en.length;eu++){let ef=en.codePointAt(eu);if(void 0===ef)break;if(el[ef]=!0,ec&&ed&&ef<=65535){let ec=a3[en.charAt(eu)];ec&&(el[ec.charCodeAt(0)]=!0)}}}populate(el,eu,ec,ed){let ef=this.layers[0],em=ef.layout,e_="globe"===this.projection.name,ew=em.get("text-font"),eT=em.get("text-field"),eM=em.get("icon-image"),eE=("constant"!==eT.value.kind||eT.value.value instanceof Oe&&!eT.value.value.isEmpty()||eT.value.value.toString().length>0)&&("constant"!==ew.value.kind||ew.value.value.length>0),eS="constant"!==eM.value.kind||!!eM.value.value||Object.keys(eM.parameters).length>0,eA=em.get("symbol-sort-key");if(this.features=[],!eE&&!eS)return;let eI=eu.iconDependencies,eC=eu.glyphDependencies,eP=eu.availableImages,ez=new _a(this.zoom);for(let{feature:eu,id:eT,index:eM,sourceLayerIndex:eD}of el){let el,eL;let ek=ef._featureFilter.needGeometry,eR=gp(eu,ek);if(!ef._featureFilter.filter(ez,eR,ec))continue;if(ek||(eR.geometry=yp(eu,ec,ed)),e_&&1!==eu.type&&ec.z<=5){let el=eR.geometry,i=(el,eu)=>{let ed=zh(el.x,el.y,ec,1),ef=zh(eu.x,eu.y,ec,1);return .98078528056>en.v.dot(ed,ef)};for(let en=0;en<el.length;en++)el[en]=function(en,el){let eu=en[0],ec=[eu];for(let ed=1;ed<en.length;ed++){let ef=en[ed];(function hp(en,el,eu,ec){if(ec(el,eu)){let ed=el.add(eu)._mult(.5);hp(en,el,ed,ec),hp(en,ed,eu,ec)}else en.push(eu)})(ec,eu,ef,el),eu=ef}return ec}(el[en],i)}if(eE){let en=ef.getValueAndResolveTokens("text-field",eR,ec,eP),eu=Oe.factory(en);(function(en){for(let el of en.sections)if(function(en){for(let el of en)if(aa(el.charCodeAt(0)))return!0;return!1}(el.text))return!0;return!1})(eu)&&(this.hasRTLText=!0),(!this.hasRTLText||"unavailable"===xa()||this.hasRTLText&&iM.isParsed())&&(el=function(en,el,eu){return en.sections.forEach(en=>{en.text=function(en,el,eu){let ec=el.layout.get("text-transform").evaluate(eu,{});return"uppercase"===ec?en=en.toLocaleUpperCase():"lowercase"===ec&&(en=en.toLocaleLowerCase()),iM.applyArabicShaping&&(en=iM.applyArabicShaping(en)),en}(en.text,el,eu)}),en}(eu,ef,eR))}if(eS){let en=ef.getValueAndResolveTokens("icon-image",eR,ec,eP);eL=en instanceof Fe?en:Fe.fromString(en)}if(!el&&!eL)continue;let eO=this.sortFeaturesByKey?eA.evaluate(eR,{},ec):void 0;if(this.features.push({id:eT,text:el,icon:eL,index:eM,sourceLayerIndex:eD,geometry:eR.geometry,properties:eu.properties,type:np[eu.type],sortKey:eO}),eL&&(eI[eL.namePrimary]=!0,eL.nameSecondary&&(eI[eL.nameSecondary]=!0)),el){let en=ew.evaluate(eR,{},ec).join(","),eu="map"===em.get("text-rotation-alignment")&&"point"!==em.get("symbol-placement");for(let ec of(this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(a4.vertical)>=0,el.sections))if(ec.image)eI[ec.image.namePrimary]=!0;else{let ed=ea(el.toString()),ef=ec.fontStack||en,em=eC[ef]=eC[ef]||{};this.calculateGlyphDependencies(ec.text,em,eu,this.allowVerticalPlacement,ed)}}}"line"===em.get("symbol-placement")&&(this.features=function(en){let el={},eu={},ec=[],ed=0;function s(el){ec.push(en[el]),ed++}function a(en,el,ed){let ef=eu[en];return delete eu[en],eu[el]=ef,ec[ef].geometry[0].pop(),ec[ef].geometry[0]=ec[ef].geometry[0].concat(ed[0]),ef}function o(en,eu,ed){let ef=el[eu];return delete el[eu],el[en]=ef,ec[ef].geometry[0].shift(),ec[ef].geometry[0]=ed[0].concat(ec[ef].geometry[0]),ef}function l(en,el,eu){let ec=eu?el[0][el[0].length-1]:el[0][0];return`${en}:${ec.x}:${ec.y}`}for(let ef=0;ef<en.length;ef++){let em=en[ef],e_=em.geometry,ew=em.text?em.text.toString():null;if(!ew){s(ef);continue}let eT=l(ew,e_),eM=l(ew,e_,!0);if(eT in eu&&eM in el&&eu[eT]!==el[eM]){let en=o(eT,eM,e_),ed=a(eT,eM,ec[en].geometry);delete el[eT],delete eu[eM],eu[l(ew,ec[ed].geometry,!0)]=ed,ec[en].geometry=null}else eT in eu?a(eT,eM,e_):eM in el?o(eT,eM,e_):(s(ef),el[eT]=ed-1,eu[eM]=ed-1)}return ec.filter(en=>en.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((en,el)=>en.sortKey-el.sortKey)}update(en,el,eu,ec,ed){let ef=0!==Object.keys(en).length;if(ef&&!this.stateDependentLayers.length)return;let em=ef?this.stateDependentLayers:this.layers;this.text.programConfigurations.updatePaintArrays(en,el,em,eu,ec,ed),this.icon.programConfigurations.updatePaintArrays(en,el,em,eu,ec,ed)}updateZOffset(){let t=(el,eu,ec)=>{(en+=eu)>el.length&&el.resize(en);for(let ed=-eu;ed<0;ed++)el.emplace(ed+en,ec)},e=(en,eu,ec)=>{(el+=eu)>en.length&&en.resize(el);for(let ed=-eu;ed<0;ed++)en.emplace(ed+el,ec)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let en=0,el=0;for(let en=0;en<this.symbolInstances.length;en++){let el=this.symbolInstances.get(en),{numHorizontalGlyphVertices:eu,numVerticalGlyphVertices:ec,numIconVertices:ed}=el,ef=el.zOffset,em=ed>0;if((eu>0||ec>0)&&(t(this.text.zOffsetVertexArray,eu,ef),t(this.text.zOffsetVertexArray,ec,ef)),em){let{placedIconSymbolIndex:en,verticalPlacedIconSymbolIndex:eu}=el;en>=0&&e(this.icon.zOffsetVertexArray,ed,ef),eu>=0&&e(this.icon.zOffsetVertexArray,el.numVerticalIconVertices,ef)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(en){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(en),this.iconCollisionBox.upload(en)),this.text.upload(en,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(en,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=Jy(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(en,el){let eu=this.lineVertexArray.length;if(void 0!==en.segment)for(let{x:en,y:eu}of el)this.lineVertexArray.emplaceBack(en,eu);return{lineStartIndex:eu,lineLength:this.lineVertexArray.length-eu}}addSymbols(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC){let eP=en.indexArray,ez=en.layoutVertexArray,eD=en.globeExtVertexArray,eL=en.segments.prepareSegment(4*el.length,ez,eP,this.canOverlap?ef.sortKey:void 0),ek=this.glyphOffsetArray.length,eR=eL.vertexLength,eO=this.allowVerticalPlacement&&em===a4.vertical?Math.PI/2:0,eB=ef.text&&ef.text.sections;for(let ec=0;ec<el.length;ec++){let{tl:ed,tr:em,bl:eT,br:eM,texPrimary:eE,texSecondary:ek,pixelOffsetTL:eR,pixelOffsetBR:eF,minFontScaleX:eN,minFontScaleY:eU,glyphOffset:eV,isSDF:ej,sectionIndex:eG}=el[ec],eq=eL.vertexLength,eZ=eV[1];if(sg(ez,ew.x,ew.y,ed.x,eZ+ed.y,eE.x,eE.y,eu,ej,eR.x,eR.y,eN,eU),sg(ez,ew.x,ew.y,em.x,eZ+em.y,eE.x+eE.w,eE.y,eu,ej,eF.x,eR.y,eN,eU),sg(ez,ew.x,ew.y,eT.x,eZ+eT.y,eE.x,eE.y+eE.h,eu,ej,eR.x,eF.y,eN,eU),sg(ez,ew.x,ew.y,eM.x,eZ+eM.y,eE.x+eE.w,eE.y+eE.h,eu,ej,eF.x,eF.y,eN,eU),e_){let{x:el,y:eu,z:ec}=e_.anchor,[ed,ef,em]=e_.up;og(eD,el,eu,ec,ed,ef,em),og(eD,el,eu,ec,ed,ef,em),og(eD,el,eu,ec,ed,ef,em),og(eD,el,eu,ec,ed,ef,em),lg(en.dynamicLayoutVertexArray,el,eu,ec,eO)}else lg(en.dynamicLayoutVertexArray,ew.x,ew.y,ew.z,eO);if(eC){let el=ek||eE;ag(en.iconTransitioningVertexArray,el.x,el.y),ag(en.iconTransitioningVertexArray,el.x+el.w,el.y),ag(en.iconTransitioningVertexArray,el.x,el.y+el.h),ag(en.iconTransitioningVertexArray,el.x+el.w,el.y+el.h)}eP.emplaceBack(eq,eq+1,eq+2),eP.emplaceBack(eq+1,eq+2,eq+3),eL.vertexLength+=4,eL.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(eV[0]),ec!==el.length-1&&eG===el[ec+1].sectionIndex||en.programConfigurations.populatePaintArrays(ez.length,ef,ef.index,{},eS,eA,eI,eB&&eB[eG])}let eF=e_?e_.anchor:ew;en.placedSymbolArray.emplaceBack(eF.x,eF.y,eF.z,ew.x,ew.y,ek,this.glyphOffsetArray.length-ek,eR,eT,eM,ew.segment,eu?eu[0]:0,eu?eu[1]:0,ec[0],ec[1],em,0,!1,0,eE,0)}_commitLayoutVertex(en,el,eu,ec,ed,ef,em){en.emplaceBack(el,eu,ec,ed,ef,Math.round(em.x),Math.round(em.y))}_addCollisionDebugVertices(en,el,eu,ec,ed,ef,em){let e_=eu.segments.prepareSegment(4,eu.layoutVertexArray,eu.indexArray),ew=e_.vertexLength,eT=em.tileAnchorX,eM=em.tileAnchorY;for(let en=0;en<4;en++)eu.collisionVertexArray.emplaceBack(0,0,0,0);this._commitDebugCollisionVertexUpdate(eu.collisionVertexArrayExt,el,en.padding,em.zOffset),this._commitLayoutVertex(eu.layoutVertexArray,ec,ed,ef,eT,eM,new eB(en.x1,en.y1)),this._commitLayoutVertex(eu.layoutVertexArray,ec,ed,ef,eT,eM,new eB(en.x2,en.y1)),this._commitLayoutVertex(eu.layoutVertexArray,ec,ed,ef,eT,eM,new eB(en.x2,en.y2)),this._commitLayoutVertex(eu.layoutVertexArray,ec,ed,ef,eT,eM,new eB(en.x1,en.y2)),e_.vertexLength+=4;let eE=eu.indexArray;eE.emplaceBack(ew,ew+1),eE.emplaceBack(ew+1,ew+2),eE.emplaceBack(ew+2,ew+3),eE.emplaceBack(ew+3,ew),e_.primitiveLength+=4}_addTextDebugCollisionBoxes(en,el,eu,ec,ed,ef){for(let em=ec;em<ed;em++){let ec=eu.get(em),ed=this.getSymbolInstanceTextSize(en,ef,el,em);this._addCollisionDebugVertices(ec,ed,this.textCollisionBox,ec.projectedAnchorX,ec.projectedAnchorY,ec.projectedAnchorZ,ef)}}_addIconDebugCollisionBoxes(en,el,eu,ec,ed,ef){for(let em=ec;em<ed;em++){let ec=eu.get(em),ed=this.getSymbolInstanceIconSize(en,el,ef.placedIconSymbolIndex);this._addCollisionDebugVertices(ec,ed,this.iconCollisionBox,ec.projectedAnchorX,ec.projectedAnchorY,ec.projectedAnchorZ,ef)}}generateCollisionDebugBuffers(en,el){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new hg(no,a0.members,eo),this.iconCollisionBox=new hg(no,a0.members,eo);let eu=fm(this.iconSizeData,en),ec=fm(this.textSizeData,en);for(let ed=0;ed<this.symbolInstances.length;ed++){let ef=this.symbolInstances.get(ed);this._addTextDebugCollisionBoxes(ec,en,el,ef.textBoxStartIndex,ef.textBoxEndIndex,ef),this._addTextDebugCollisionBoxes(ec,en,el,ef.verticalTextBoxStartIndex,ef.verticalTextBoxEndIndex,ef),this._addIconDebugCollisionBoxes(eu,en,el,ef.iconBoxStartIndex,ef.iconBoxEndIndex,ef),this._addIconDebugCollisionBoxes(eu,en,el,ef.verticalIconBoxStartIndex,ef.verticalIconBoxEndIndex,ef)}}getSymbolInstanceTextSize(en,el,eu,ec){let ed=this.text.placedSymbolArray.get(el.rightJustifiedTextSymbolIndex>=0?el.rightJustifiedTextSymbolIndex:el.centerJustifiedTextSymbolIndex>=0?el.centerJustifiedTextSymbolIndex:el.leftJustifiedTextSymbolIndex>=0?el.leftJustifiedTextSymbolIndex:el.verticalPlacedTextSymbolIndex>=0?el.verticalPlacedTextSymbolIndex:ec),ef=pm(this.textSizeData,en,ed)/24;return this.tilePixelRatio*ef}getSymbolInstanceIconSize(en,el,eu){let ec=this.icon.placedSymbolArray.get(eu),ed=pm(this.iconSizeData,en,ec);return this.tilePixelRatio*ed}_commitDebugCollisionVertexUpdate(en,el,eu,ec){en.emplaceBack(el,-eu,-eu,ec),en.emplaceBack(el,eu,-eu,ec),en.emplaceBack(el,eu,eu,ec),en.emplaceBack(el,-eu,eu,ec)}_updateTextDebugCollisionBoxes(en,el,eu,ec,ed,ef){for(let em=ec;em<ed;em++){let ec=eu.get(em),ed=this.getSymbolInstanceTextSize(en,ef,el,em);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,ed,ec.padding,ef.zOffset)}}_updateIconDebugCollisionBoxes(en,el,eu,ec,ed,ef){for(let em=ec;em<ed;em++){let ec=eu.get(em),ed=this.getSymbolInstanceIconSize(en,el,ef.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,ed,ec.padding,ef.zOffset)}}updateCollisionDebugBuffers(en,el){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();let eu=fm(this.iconSizeData,en),ec=fm(this.textSizeData,en);for(let ed=0;ed<this.symbolInstances.length;ed++){let ef=this.symbolInstances.get(ed);this._updateTextDebugCollisionBoxes(ec,en,el,ef.textBoxStartIndex,ef.textBoxEndIndex,ef),this._updateTextDebugCollisionBoxes(ec,en,el,ef.verticalTextBoxStartIndex,ef.verticalTextBoxEndIndex,ef),this._updateIconDebugCollisionBoxes(eu,en,el,ef.iconBoxStartIndex,ef.iconBoxEndIndex,ef),this._updateIconDebugCollisionBoxes(eu,en,el,ef.verticalIconBoxStartIndex,ef.verticalIconBoxEndIndex,ef)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(en,el,eu,ec,ed,ef,em,e_,ew){let eT={};if(el<eu){let{x1:eu,y1:ec,x2:ed,y2:ef,padding:em,projectedAnchorX:e_,projectedAnchorY:ew,projectedAnchorZ:eM,tileAnchorX:eE,tileAnchorY:eS,featureIndex:eA}=en.get(el);eT.textBox={x1:eu,y1:ec,x2:ed,y2:ef,padding:em,projectedAnchorX:e_,projectedAnchorY:ew,projectedAnchorZ:eM,tileAnchorX:eE,tileAnchorY:eS},eT.textFeatureIndex=eA}if(ec<ed){let{x1:el,y1:eu,x2:ed,y2:ef,padding:em,projectedAnchorX:e_,projectedAnchorY:ew,projectedAnchorZ:eM,tileAnchorX:eE,tileAnchorY:eS,featureIndex:eA}=en.get(ec);eT.verticalTextBox={x1:el,y1:eu,x2:ed,y2:ef,padding:em,projectedAnchorX:e_,projectedAnchorY:ew,projectedAnchorZ:eM,tileAnchorX:eE,tileAnchorY:eS},eT.verticalTextFeatureIndex=eA}if(ef<em){let{x1:el,y1:eu,x2:ec,y2:ed,padding:em,projectedAnchorX:e_,projectedAnchorY:ew,projectedAnchorZ:eM,tileAnchorX:eE,tileAnchorY:eS,featureIndex:eA}=en.get(ef);eT.iconBox={x1:el,y1:eu,x2:ec,y2:ed,padding:em,projectedAnchorX:e_,projectedAnchorY:ew,projectedAnchorZ:eM,tileAnchorX:eE,tileAnchorY:eS},eT.iconFeatureIndex=eA}if(e_<ew){let{x1:el,y1:eu,x2:ec,y2:ed,padding:ef,projectedAnchorX:em,projectedAnchorY:ew,projectedAnchorZ:eM,tileAnchorX:eE,tileAnchorY:eS,featureIndex:eA}=en.get(e_);eT.verticalIconBox={x1:el,y1:eu,x2:ec,y2:ed,padding:ef,projectedAnchorX:em,projectedAnchorY:ew,projectedAnchorZ:eM,tileAnchorX:eE,tileAnchorY:eS},eT.verticalIconFeatureIndex=eA}return eT}deserializeCollisionBoxes(en){this.collisionArrays=[];for(let el=0;el<this.symbolInstances.length;el++){let eu=this.symbolInstances.get(el);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(en,eu.textBoxStartIndex,eu.textBoxEndIndex,eu.verticalTextBoxStartIndex,eu.verticalTextBoxEndIndex,eu.iconBoxStartIndex,eu.iconBoxEndIndex,eu.verticalIconBoxStartIndex,eu.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(en,el){let eu=en.placedSymbolArray.get(el),ec=eu.vertexStartIndex+4*eu.numGlyphs;for(let el=eu.vertexStartIndex;el<ec;el+=4)en.indexArray.emplaceBack(el,el+1,el+2),en.indexArray.emplaceBack(el+1,el+2,el+3)}getSortedSymbolIndexes(en){if(this.sortedAngle===en&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;let el=Math.sin(en),eu=Math.cos(en),ec=[],ed=[],ef=[];for(let en=0;en<this.symbolInstances.length;++en){ef.push(en);let em=this.symbolInstances.get(en);ec.push(0|Math.round(el*em.tileAnchorX+eu*em.tileAnchorY)),ed.push(em.featureIndex)}return ef.sort((en,el)=>ec[en]-ec[el]||ed[el]-ed[en]),ef}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let en=0;en<this.symbolInstances.length;++en)this.symbolInstanceIndexesSortedZOffset.push(en)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((en,el)=>this.symbolInstances.get(el).zOffset-this.symbolInstances.get(en).zOffset)}addToSortKeyRanges(en,el){let eu=this.sortKeyRanges[this.sortKeyRanges.length-1];eu&&eu.sortKey===el?eu.symbolInstanceEnd=en+1:this.sortKeyRanges.push({sortKey:el,symbolInstanceStart:en,symbolInstanceEnd:en+1})}sortFeatures(en){if(this.sortFeaturesByY&&this.sortedAngle!==en&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){for(let el of(this.symbolInstanceIndexes=this.getSortedSymbolIndexes(en),this.sortedAngle=en,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[],this.symbolInstanceIndexes)){let en=this.symbolInstances.get(el);this.featureSortOrder.push(en.featureIndex);let{rightJustifiedTextSymbolIndex:eu,centerJustifiedTextSymbolIndex:ec,leftJustifiedTextSymbolIndex:ed,verticalPlacedTextSymbolIndex:ef,placedIconSymbolIndex:em,verticalPlacedIconSymbolIndex:e_}=en;eu>=0&&this.addIndicesForPlacedSymbol(this.text,eu),ec>=0&&ec!==eu&&this.addIndicesForPlacedSymbol(this.text,ec),ed>=0&&ed!==ec&&ed!==eu&&this.addIndicesForPlacedSymbol(this.text,ed),ef>=0&&this.addIndicesForPlacedSymbol(this.text,ef),em>=0&&this.addIndicesForPlacedSymbol(this.icon,em),e_>=0&&this.addIndicesForPlacedSymbol(this.icon,e_)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}};Ks(pg,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),pg.MAX_GLYPHS=65535,pg.addDynamicAttributes=lg;var n_=pg;let ng=Ua([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:ny}=ng,nb=Ua([{name:"a_packed",components:4,type:"Float32"}]),{members:nw}=nb,nT=aV.types,nM=Math.cos(Math.PI/180*37.5);let bg=class bg{constructor(en){this.zoom=en.zoom,this.overscaling=en.overscaling,this.layers=en.layers,this.layerIds=this.layers.map(en=>en.fqid),this.index=en.index,this.projection=en.projection,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(en=>{this.gradients[en.id]={}}),this.layoutVertexArray=new Za,this.layoutVertexArray2=new Xa,this.indexArray=new ao,this.programConfigurations=new fl(en.layers,en.zoom),this.segments=new Do,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(en=>en.isStateDependent()).map(en=>en.id)}populate(en,el,eu,ec){this.hasPattern=Ff("line",this.layers,el);let ed=this.layers[0].layout.get("line-sort-key"),ef=[];for(let{feature:el,id:em,index:e_,sourceLayerIndex:ew}of en){let en=this.layers[0]._featureFilter.needGeometry,eT=gp(el,en);if(!this.layers[0]._featureFilter.filter(new _a(this.zoom),eT,eu))continue;let eM=ed?ed.evaluate(eT,{},eu):void 0,eE={id:em,properties:el.properties,type:el.type,sourceLayerIndex:ew,index:e_,geometry:en?eT.geometry:yp(el,eu,ec),patterns:{},sortKey:eM};ef.push(eE)}ed&&ef.sort((en,el)=>en.sortKey-el.sortKey);let{lineAtlas:em,featureIndex:e_}=el,ew=this.addConstantDashes(em);for(let ec of ef){let{geometry:ed,index:ef,sourceLayerIndex:eT}=ec;if(ew&&this.addFeatureDashes(ec,em),this.hasPattern){let en=jf("line",this.layers,ec,this.zoom,el);this.patternFeatures.push(en)}else this.addFeature(ec,ed,ef,eu,em.positions,el.availableImages,el.brightness);e_.insert(en[ef].feature,ed,ef,eT,this.index)}}addConstantDashes(en){let el=!1;for(let eu of this.layers){let ec=eu.paint.get("line-dasharray").value,ed=eu.layout.get("line-cap").value;if("constant"!==ec.kind||"constant"!==ed.kind)el=!0;else{let el=ed.value,eu=ec.value;if(!eu)continue;en.addDash(eu,el)}}return el}addFeatureDashes(en,el){let eu=this.zoom;for(let ec of this.layers){let ed,ef;let em=ec.paint.get("line-dasharray").value,e_=ec.layout.get("line-cap").value;if("constant"!==em.kind||"constant"!==e_.kind){if("constant"===em.kind){if(!(ed=em.value))continue}else ed=em.evaluate({zoom:eu},en);ef="constant"===e_.kind?e_.value:e_.evaluate({zoom:eu},en),el.addDash(ed,ef),en.patterns[ec.id]=el.getKey(ed,ef)}}}update(en,el,eu,ec,ed){let ef=0!==Object.keys(en).length;ef&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(en,el,ef?this.stateDependentLayers:this.layers,eu,ec,ed)}addFeatures(en,el,eu,ec,ed,ef){for(let en of this.patternFeatures)this.addFeature(en,en.geometry,en.index,el,eu,ec,ef)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(en){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=en.createVertexBuffer(this.layoutVertexArray2,nw)),this.layoutVertexBuffer=en.createVertexBuffer(this.layoutVertexArray,ny),this.indexBuffer=en.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(en),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(en){if(en.properties&&en.properties.hasOwnProperty("mapbox_clip_start")&&en.properties.hasOwnProperty("mapbox_clip_end"))return{start:+en.properties.mapbox_clip_start,end:+en.properties.mapbox_clip_end}}addFeature(en,el,eu,ec,ed,ef,em){let e_=this.layers[0].layout,ew=e_.get("line-join").evaluate(en,{}),eT=e_.get("line-cap").evaluate(en,{}),eM=e_.get("line-miter-limit"),eE=e_.get("line-round-limit");for(let eu of(this.lineClips=this.lineFeatureClips(en),el))this.addLine(eu,en,ew,eT,eM,eE);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,en,eu,ed,ef,ec,em)}addLine(en,el,eu,ec,ed,ef){let em,e_,ew,eT,eM;if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let el=0;el<en.length-1;el++)this.totalDistance+=en[el].dist(en[el+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}let eE="Polygon"===nT[el.type],eS=en.length;for(;eS>=2&&en[eS-1].equals(en[eS-2]);)eS--;let eA=0;for(;eA<eS-1&&en[eA].equals(en[eA+1]);)eA++;if(eS<(eE?3:2))return;"bevel"===eu&&(ed=1.05);let eI=this.overscaling<=16?122880/(512*this.overscaling):0,eC=this.segments.prepareSegment(10*eS,this.layoutVertexArray,this.indexArray);this.e1=this.e2=-1,eE&&(em=en[eS-2],eM=en[eA].sub(em)._unit()._perp());for(let el=eA;el<eS;el++){if((ew=el===eS-1?eE?en[eA+1]:void 0:en[el+1])&&en[el].equals(ew))continue;eM&&(eT=eM),em&&(e_=em),em=en[el],eM=ew?ew.sub(em)._unit()._perp():eT;let eP=(eT=eT||eM).add(eM);0===eP.x&&0===eP.y||eP._unit();let ez=eT.x*eM.x+eT.y*eM.y,eD=eP.x*eM.x+eP.y*eM.y,eL=0!==eD?1/eD:1/0,ek=2*Math.sqrt(2-2*eD),eR=eD<nM&&e_&&ew,eO=eT.x*eM.y-eT.y*eM.x>0;if(eR&&el>eA){let en=em.dist(e_);if(en>2*eI){let el=em.sub(em.sub(e_)._mult(eI/en)._round());this.updateDistance(e_,el),this.addCurrentVertex(el,eT,0,0,eC),e_=el}}let eB=e_&&ew,eF=eB?eu:eE?"butt":ec;if(eB&&"round"===eF&&(eL<ef?eF="miter":eL<=2&&(eF="fakeround")),"miter"===eF&&eL>ed&&(eF="bevel"),"bevel"===eF&&(eL>2&&(eF="flipbevel"),eL<ed&&(eF="miter")),e_&&this.updateDistance(e_,em),"miter"===eF)eP._mult(eL),this.addCurrentVertex(em,eP,0,0,eC);else if("flipbevel"===eF){if(eL>100)eP=eM.mult(-1);else{let en=eL*eT.add(eM).mag()/eT.sub(eM).mag();eP._perp()._mult(en*(eO?-1:1))}this.addCurrentVertex(em,eP,0,0,eC),this.addCurrentVertex(em,eP.mult(-1),0,0,eC)}else if("bevel"===eF||"fakeround"===eF){let en=-Math.sqrt(eL*eL-1),el=eO?en:0,eu=eO?0:en;if(e_&&this.addCurrentVertex(em,eT,el,eu,eC),"fakeround"===eF){let en=Math.round(180*ek/Math.PI/20);for(let el=1;el<en;el++){let eu=el/en;if(.5!==eu){let en=eu-.5;eu+=eu*en*(eu-1)*((1.0904+ez*(ez*(3.55645-1.43519*ez)-3.2452))*en*en+(.848013+ez*(.215638*ez-1.06021)))}let ec=eM.sub(eT)._mult(eu)._add(eT)._unit()._mult(eO?-1:1);this.addHalfVertex(em,ec.x,ec.y,!1,eO,0,eC)}}ew&&this.addCurrentVertex(em,eM,-el,-eu,eC)}else if("butt"===eF)this.addCurrentVertex(em,eP,0,0,eC);else if("square"===eF){let en=e_?1:-1;e_||this.addCurrentVertex(em,eP,en,en,eC),this.addCurrentVertex(em,eP,0,0,eC),e_&&this.addCurrentVertex(em,eP,en,en,eC)}else"round"===eF&&(e_&&(this.addCurrentVertex(em,eT,0,0,eC),this.addCurrentVertex(em,eT,1,1,eC,!0)),ew&&(this.addCurrentVertex(em,eM,-1,-1,eC,!0),this.addCurrentVertex(em,eM,0,0,eC)));if(eR&&el<eS-1){let en=em.dist(ew);if(en>2*eI){let el=em.add(ew.sub(em)._mult(eI/en)._round());this.updateDistance(em,el),this.addCurrentVertex(el,eM,0,0,eC),em=el}}}}addCurrentVertex(en,el,eu,ec,ed,ef=!1){let em=el.y*ec-el.x,e_=-el.y-el.x*ec;this.addHalfVertex(en,el.x+el.y*eu,el.y-el.x*eu,ef,!1,eu,ed),this.addHalfVertex(en,em,e_,ef,!0,-ec,ed)}addHalfVertex({x:en,y:el},eu,ec,ed,ef,em,e_){this.layoutVertexArray.emplaceBack((en<<1)+(ed?1:0),(el<<1)+(ef?1:0),Math.round(63*eu)+128,Math.round(63*ec)+128,1+(0===em?0:em<0?-1:1),0,this.lineSoFar),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineClips.start,this.lineClips.end);let ew=e_.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,ew),e_.primitiveLength++),ef?this.e2=ew:this.e1=ew}updateScaledDistance(){if(this.lineClips){let en=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=en*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(en,el){this.distance+=en.dist(el),this.updateScaledDistance()}};Ks(bg,"LineBucket",{omit:["layers","patternFeatures"]});let _g=class _g{constructor(en,el,eu,ec){this.context=en,this.format=eu,this.texture=en.gl.createTexture(),this.update(el,ec)}update(en,el,eu){let{width:ec,height:ed}=en,{context:ef}=this,{gl:em}=ef;if(em.bindTexture(em.TEXTURE_2D,this.texture),ef.pixelStoreUnpackFlipY.set(!1),ef.pixelStoreUnpack.set(1),ef.pixelStoreUnpackPremultiplyAlpha.set(this.format===em.RGBA&&(!el||!1!==el.premultiply)),eu||this.size&&this.size[0]===ec&&this.size[1]===ed){let{x:el,y:ef}=eu||{x:0,y:0};if(en instanceof HTMLImageElement||en instanceof HTMLCanvasElement||en instanceof HTMLVideoElement||en instanceof ImageData||ImageBitmap&&en instanceof ImageBitmap)em.texSubImage2D(em.TEXTURE_2D,0,el,ef,em.RGBA,em.UNSIGNED_BYTE,en);else{let eu=this.format,e_=em.UNSIGNED_BYTE;this.format===em.R32F&&(eu=em.RED,e_=em.FLOAT),em.texSubImage2D(em.TEXTURE_2D,0,el,ef,ec,ed,eu,e_,en.data)}}else if(this.size=[ec,ed],en instanceof HTMLImageElement||en instanceof HTMLCanvasElement||en instanceof HTMLVideoElement||en instanceof ImageData||ImageBitmap&&en instanceof ImageBitmap){let el=this.format;this.format===em.R8&&(el=em.RED),em.texImage2D(em.TEXTURE_2D,0,this.format,el,em.UNSIGNED_BYTE,en)}else{let el=this.format,eu=this.format,ef=em.UNSIGNED_BYTE;this.format===em.DEPTH_COMPONENT&&(el=em.DEPTH_COMPONENT16,ef=em.UNSIGNED_SHORT),this.format===em.R8&&(eu=em.RED),this.format===em.R32F&&(ef=em.FLOAT,eu=em.RED),em.texImage2D(em.TEXTURE_2D,0,el,ec,ed,0,eu,ef,en.data)}this.useMipmap=!!(el&&el.useMipmap),this.useMipmap&&em.generateMipmap(em.TEXTURE_2D)}bind(en,el,eu=!1){let{context:ec}=this,{gl:ed}=ec;ed.bindTexture(ed.TEXTURE_2D,this.texture),en!==this.minFilter&&(ed.texParameteri(ed.TEXTURE_2D,ed.TEXTURE_MAG_FILTER,en),ed.texParameteri(ed.TEXTURE_2D,ed.TEXTURE_MIN_FILTER,this.useMipmap&&!eu?en===ed.NEAREST?ed.NEAREST_MIPMAP_NEAREST:ed.LINEAR_MIPMAP_LINEAR:en),this.minFilter=en),el!==this.wrapS&&(ed.texParameteri(ed.TEXTURE_2D,ed.TEXTURE_WRAP_S,el),ed.texParameteri(ed.TEXTURE_2D,ed.TEXTURE_WRAP_T,el),this.wrapS=el)}bindExtraParam(en,el,eu,ec){let{context:ed}=this,{gl:ef}=ed;ef.bindTexture(ef.TEXTURE_2D,this.texture),el!==this.magFilter&&(ef.texParameteri(ef.TEXTURE_2D,ef.TEXTURE_MAG_FILTER,el),this.magFilter=el),en!==this.minFilter&&(ef.texParameteri(ef.TEXTURE_2D,ef.TEXTURE_MIN_FILTER,this.useMipmap?en===ef.NEAREST?ef.NEAREST_MIPMAP_NEAREST:ef.LINEAR_MIPMAP_LINEAR:en),this.minFilter=en),eu!==this.wrapS&&(ef.texParameteri(ef.TEXTURE_2D,ef.TEXTURE_WRAP_S,eu),this.wrapS=eu),ec!==this.wrapT&&(ef.texParameteri(ef.TEXTURE_2D,ef.TEXTURE_WRAP_T,ec),this.wrapT=ec)}destroy(){let{gl:en}=this.context;en.deleteTexture(this.texture),this.texture=null}};let wg=class wg{constructor(en,el){this.context=en,this.texture=el}bind(en,el){let{context:eu}=this,{gl:ec}=eu;ec.bindTexture(ec.TEXTURE_2D,this.texture),en!==this.minFilter&&(ec.texParameteri(ec.TEXTURE_2D,ec.TEXTURE_MAG_FILTER,en),ec.texParameteri(ec.TEXTURE_2D,ec.TEXTURE_MIN_FILTER,en),this.minFilter=en),el!==this.wrapS&&(ec.texParameteri(ec.TEXTURE_2D,ec.TEXTURE_WRAP_S,el),ec.texParameteri(ec.TEXTURE_2D,ec.TEXTURE_WRAP_T,el),this.wrapS=el)}};let nE=new Uint16Array(8184);for(let en=0;en<2046;en++){let el=en+2,eu=0,ec=0,ed=0,ef=0,em=0,e_=0;for(1&el?ed=ef=em=32:eu=ec=e_=32;(el>>=1)>1;){let en=eu+ed>>1,ew=ec+ef>>1;1&el?(ed=eu,ef=ec,eu=em,ec=e_):(eu=ed,ec=ef,ed=em,ef=e_),em=en,e_=ew}let ew=4*en;nE[ew+0]=eu,nE[ew+1]=ec,nE[ew+2]=ed,nE[ew+3]=ef}let nS=new Uint16Array(2178),nA=new Uint8Array(1089),nI=new Uint16Array(1089);function Pg(en){return 0===en?-.03125:32===en?.03125:0}var nC=Ua([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);let nP={type:2,extent:8192,loadGeometry:()=>[[new eB(0,0),new eB(8193,0),new eB(8193,8193),new eB(0,8193),new eB(0,0)]]};let Bg=class Bg{constructor(en,el,eu,ec,ed){this.tileID=en,this.uid=C(),this.uses=0,this.tileSize=el,this.tileZoom=eu,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=ed,ec&&ec.style&&(this._lastUpdatedBrightness=ec.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",ec&&ec.transform&&(this.projection=ec.transform.projection)}registerFadeDuration(en){let el=en+this.timeAdded;el<ta.now()||this.fadeEndTime&&el<this.fadeEndTime||(this.fadeEndTime=el)}wasRequested(){return"errored"===this.state||"loaded"===this.state||"reloading"===this.state}get tileTransform(){return this._tileTransform||(this._tileTransform=zy(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(en,el,eu){if(this.unloadVectorData(),this.state="loaded",en){for(let ec in en.featureIndex&&(this.latestFeatureIndex=en.featureIndex,en.rawTileData?(this.latestRawTileData=en.rawTileData,this.latestFeatureIndex.rawTileData=en.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=en.collisionBoxArray,this.buckets=function(en,el){let eu={};if(!el)return eu;for(let ec of en){let en=ec.layerIds.map(en=>el.getLayer(en)).filter(Boolean);if(0!==en.length)for(let el of(ec.layers=en,ec.stateDependentLayerIds&&(ec.stateDependentLayers=ec.stateDependentLayerIds.map(el=>en.filter(en=>en.id===el)[0])),en))eu[el.fqid]=ec}return eu}(en.buckets,el.style),this.hasSymbolBuckets=!1,this.buckets){let en=this.buckets[ec];if(en instanceof n_){if(this.hasSymbolBuckets=!0,!eu)break;en.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(let en in this.buckets){let el=this.buckets[en];if(el instanceof n_&&el.hasRTLText){this.hasRTLText=!0,iM.isLoading()||iM.isLoaded()||"deferred"!==xa()||va();break}}for(let en in this.queryPadding=0,this.buckets){let eu=this.buckets[en],ec=el.style.getOwnLayer(en);if(!ec)continue;let ed=ec.queryRadius(eu);this.queryPadding=Math.max(this.queryPadding,ed)}en.imageAtlas&&(this.imageAtlas=en.imageAtlas),en.glyphAtlasImage&&(this.glyphAtlasImage=en.glyphAtlasImage),en.lineAtlas&&(this.lineAtlas=en.lineAtlas),this._lastUpdatedBrightness=en.brightness}else this.collisionBoxArray=new _o}unloadVectorData(){if(this.hasData()){for(let en in this.buckets)this.buckets[en].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(en){return this.buckets[en.fqid]}upload(en){for(let el in this.buckets){let eu=this.buckets[el];eu.uploadPending()&&eu.upload(en)}let el=en.gl,eu=this.imageAtlas;if(eu&&!eu.uploaded){let ec=!!Object.keys(eu.patternPositions).length;this.imageAtlasTexture=new _g(en,eu.image,el.RGBA,{useMipmap:ec}),this.imageAtlas.uploaded=!0}this.glyphAtlasImage&&(this.glyphAtlasTexture=new _g(en,this.glyphAtlasImage,el.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new _g(en,this.lineAtlas.image,el.R8),this.lineAtlas.uploaded=!0)}prepare(en,el,eu){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(en,this.imageAtlasTexture,eu),!el||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;let ec=el.style.getBrightness();(this._lastUpdatedBrightness||ec)&&(this._lastUpdatedBrightness&&ec&&.001>Math.abs(this._lastUpdatedBrightness-ec)||(this._lastUpdatedBrightness=ec,this.updateBuckets(void 0,el)))}queryRenderedFeatures(en,el,eu,ec,ed,ef,em,e_){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({tileResult:ec,pixelPosMatrix:em,transform:ef,params:ed,tileTransform:this.tileTransform},en,el,eu):{}}querySourceFeatures(en,el){let eu=this.latestFeatureIndex;if(!eu||!eu.rawTileData)return;let ec=eu.loadVTLayers(),ed=el?el.sourceLayer:"",ef=ec._geojsonTileLayer||ec[ed];if(!ef)return;let em=ls(el&&el.filter),{z:e_,x:ew,y:eT}=this.tileID.canonical,eM={z:e_,x:ew,y:eT};for(let el=0;el<ef.length;el++){let ec=ef.feature(el);if(em.needGeometry){let en=gp(ec,!0);if(!em.filter(new _a(this.tileID.overscaledZ),en,this.tileID.canonical))continue}else if(!em.filter(new _a(this.tileID.overscaledZ),ec))continue;let eE=eu.getId(ec,ed),eS=new Ld(ec,e_,ew,eT,eE);eS.tile=eM,en.push(eS)}}hasData(){return"loaded"===this.state||"reloading"===this.state||"expired"===this.state}bucketsLoaded(){for(let en in this.buckets)if(this.buckets[en].uploadPending())return!1;return!0}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(en){let el=this.expirationTime;if(en.cacheControl){let el=K(en.cacheControl);el["max-age"]&&(this.expirationTime=Date.now()+1e3*el["max-age"])}else en.expires&&(this.expirationTime=new Date(en.expires).getTime());if(this.expirationTime){let en=Date.now(),eu=!1;if(this.expirationTime>en)eu=!1;else if(el){if(this.expirationTime<el)eu=!0;else{let ec=this.expirationTime-el;ec?this.expirationTime=en+Math.max(ec,3e4):eu=!0}}else eu=!0;eu?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),2147483647)}setFeatureState(en,el){this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData&&0!==Object.keys(en).length&&el&&this.updateBuckets(en,el)}updateBuckets(en,el){if(!this.latestFeatureIndex)return;let eu=this.latestFeatureIndex.loadVTLayers(),ec=el.style.listImages(),ed=el.style.getBrightness();for(let ef in this.buckets){if(!el.style.hasLayer(ef))continue;let em=this.buckets[ef],e_=em.layers[0].sourceLayer||"_geojsonTileLayer",ew=eu[e_],eT={};if(en&&(eT=en[e_],!ew||!eT||0===Object.keys(eT).length))continue;if(em.update(eT,ew,ec,this.imageAtlas&&this.imageAtlas.patternPositions||{},ed),em instanceof bg||em instanceof Uf){let en=el.style.getOwnSourceCache(em.layers[0].source);el._terrain&&el._terrain.enabled&&en&&em.programConfigurations.needsUpload&&el._terrain._clearRenderCacheForTile(en.id,this.tileID)}let eM=el&&el.style&&el.style.getOwnLayer(ef);eM&&(this.queryPadding=Math.max(this.queryPadding,eM.queryRadius(em)))}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<ta.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(en){this.symbolFadeHoldUntil=ta.now()+en}setTexture(en,el){let eu=el.context,ec=eu.gl;this.texture=this.texture||el.getTileTexture(en.width),this.texture&&this.texture instanceof _g?this.texture.update(en,{useMipmap:!0}):(this.texture=new _g(eu,en,ec.RGBA,{useMipmap:!0}),this.texture.bind(ec.LINEAR,ec.CLAMP_TO_EDGE))}setDependencies(en,el){let eu={};for(let en of el)eu[en]=!0;this.dependencies[en]=eu}hasDependency(en,el){for(let eu of en){let en=this.dependencies[eu];if(en){for(let eu of el)if(en[eu])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(en,el){if(!el||"mercator"===el.name||this._tileDebugBuffer)return;let eu=yp(nP,this.tileID.canonical,this.tileTransform)[0],ec=new $a,ed=new fo;for(let en=0;en<eu.length;en++){let{x:el,y:ef}=eu[en];ec.emplaceBack(el,ef),ed.emplaceBack(en)}ed.emplaceBack(0),this._tileDebugIndexBuffer=en.createIndexBuffer(ed),this._tileDebugBuffer=en.createVertexBuffer(ec,rK.members),this._tileDebugSegments=Do.simpleSegment(0,0,ec.length,ed.length)}_makeTileBoundsBuffers(en,el){let eu,ec;if(this._tileBoundsBuffer||!el||"mercator"===el.name)return;let ed=yp(nP,this.tileID.canonical,this.tileTransform)[0];if(this.isRaster){let en=function(en,el){let eu=zy(en,el),ec=Math.pow(2,en.z);for(let ed=0;ed<33;ed++)for(let ef=0;ef<33;ef++){let em=tp((en.x+(ef+Pg(ef))/32)/ec),e_=ep((en.y+(ed+Pg(ed))/32)/ec),ew=el.project(em,e_),eT=33*ed+ef;nS[2*eT+0]=Math.round((ew.x*eu.scale-eu.x)*8192),nS[2*eT+1]=Math.round((ew.y*eu.scale-eu.y)*8192)}nA.fill(0),nI.fill(0);for(let en=2045;en>=0;en--){let el=4*en,eu=nE[el+0],ec=nE[el+1],ed=nE[el+2],ef=nE[el+3],em=eu+ed>>1,e_=ec+ef>>1,ew=em+e_-ec,eT=e_+eu-em,eM=33*ec+eu,eE=33*ef+ed,eS=33*e_+em,eA=Math.hypot((nS[2*eM+0]+nS[2*eE+0])/2-nS[2*eS+0],(nS[2*eM+1]+nS[2*eE+1])/2-nS[2*eS+1])>=16;nA[eS]=nA[eS]||(eA?1:0),en<1022&&(nA[eS]=nA[eS]||nA[(ec+eT>>1)*33+(eu+ew>>1)]||nA[(ef+eT>>1)*33+(ed+ew>>1)])}let ed=new Ga,ef=new ao,em=0;function o(en,el){let eu=33*el+en;return 0===nI[eu]&&(ed.emplaceBack(nS[2*eu+0],nS[2*eu+1],8192*en/32,8192*el/32),nI[eu]=++em),nI[eu]-1}function l(en,el,eu,ec,ed,em){let e_=en+eu>>1,ew=el+ec>>1;if(Math.abs(en-ed)+Math.abs(el-em)>1&&nA[33*ew+e_])l(ed,em,en,el,e_,ew),l(eu,ec,ed,em,e_,ew);else{let e_=o(en,el),ew=o(eu,ec),eT=o(ed,em);ef.emplaceBack(e_,ew,eT)}}return l(0,0,32,32,32,0),l(32,32,0,0,0,32),{vertices:ed,indices:ef}}(this.tileID.canonical,el);eu=en.vertices,ec=en.indices}else{for(let{x:en,y:el}of(eu=new Ga,ec=new ao,ed))eu.emplaceBack(en,el,0,0);let en=aP(eu.int16,void 0,4);for(let el=0;el<en.length;el+=3)ec.emplaceBack(en[el],en[el+1],en[el+2])}this._tileBoundsBuffer=en.createVertexBuffer(eu,nC.members),this._tileBoundsIndexBuffer=en.createIndexBuffer(ec),this._tileBoundsSegments=Do.simpleSegment(0,0,eu.length,ec.length)}_makeGlobeTileDebugBuffers(el,eu){let ec;let ed=eu.projection;if(!ed||"globe"!==ed.name||eu.freezeTileCoverage)return;let ef=this.tileID.canonical,em=Dh(Mh(ef,eu)),e_=Oh(eu.zoom);e_>0&&(ec=en.m.invert(new Float64Array(16),eu.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(el,ef,eu,em,ec,e_),this._makeGlobeTileDebugTextBuffer(el,ef,eu,em,ec,e_)}_globePoint(el,eu,ec,ed,ef,em,e_){let ew=zh(el,eu,ec);if(em){let ef=1<<ec.z,eT=Hh(ed.center.lng),eM=Jh(ed.center.lat),eE=(ec.x+.5)/ef-eT,eS=0;eE>.5?eS=-1:eE<-.5&&(eS=1);let eA=(el/8192+ec.x)/ef+eS,eI=(eu/8192+ec.y)/ef;eA=(eA-eT)*ed._pixelsPerMercatorPixel+eT,eI=(eI-eM)*ed._pixelsPerMercatorPixel+eM;let eC=[eA*ed.worldSize,eI*ed.worldSize,0];en.v.transformMat4(eC,eC,em),ew=wh(ew,eC,e_)}return en.v.transformMat4(ew,ew,ef)}_makeGlobeTileDebugBorderBuffer(en,el,eu,ec,ed,ef){let em=new $a,e_=new fo,ew=new qa,u=(en,eT,eM,eE,eS)=>{let eA=(eM-en)/(eS-1),eI=(eE-eT)/(eS-1),eC=em.length;for(let eM=0;eM<eS;eM++){let eE=en+eM*eA,eS=eT+eM*eI;em.emplaceBack(eE,eS);let eP=this._globePoint(eE,eS,el,eu,ec,ed,ef);ew.emplaceBack(eP[0],eP[1],eP[2]),e_.emplaceBack(eC+eM)}};u(0,0,8192,0,16),u(8192,0,8192,8192,16),u(8192,8192,0,8192,16),u(0,8192,0,0,16),this._tileDebugIndexBuffer=en.createIndexBuffer(e_),this._tileDebugBuffer=en.createVertexBuffer(em,rK.members),this._globeTileDebugBorderBuffer=en.createVertexBuffer(ew,rX.members),this._tileDebugSegments=Do.simpleSegment(0,0,em.length,e_.length)}_makeGlobeTileDebugTextBuffer(en,el,eu,ec,ed,ef){let em=new $a,e_=new ao,ew=new qa;e_.reserve(32),em.reserve(25),ew.reserve(25);let h=(en,el)=>25*en+el;for(let en=0;en<25;en++){let e_=2048*en;for(let en=0;en<25;en++){let eT=2048*en;em.emplaceBack(eT,e_);let eM=this._globePoint(eT,e_,el,eu,ec,ed,ef);ew.emplaceBack(eM[0],eM[1],eM[2])}}for(let en=0;en<4;en++)for(let el=0;el<4;el++){let eu=h(en,el),ec=h(en,el+1),ed=h(en+1,el),ef=h(en+1,el+1);e_.emplaceBack(eu,ec,ed),e_.emplaceBack(ed,ec,ef)}this._tileDebugTextIndexBuffer=en.createIndexBuffer(e_),this._tileDebugTextBuffer=en.createVertexBuffer(em,rK.members),this._globeTileDebugTextBuffer=en.createVertexBuffer(ew,rX.members),this._tileDebugTextSegments=Do.simpleSegment(0,0,25,32)}destroy(en=!1){for(let en in this.buckets)this.buckets[en].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!en&&this.texture&&this.texture instanceof _g&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.latestFeatureIndex=null,this.state="unloaded"}};let Dg=class Dg{constructor(en,el){this.max=en,this.onRemove=el,this.reset()}reset(){for(let en in this.data)for(let el of this.data[en])el.timeout&&clearTimeout(el.timeout),this.onRemove(el.value);return this.data={},this.order=[],this}add(en,el,eu){let ec=en.wrapped().key;void 0===this.data[ec]&&(this.data[ec]=[]);let ed={value:el,timeout:void 0};if(void 0!==eu&&(ed.timeout=setTimeout(()=>{this.remove(en,ed)},eu)),this.data[ec].push(ed),this.order.push(ec),this.order.length>this.max){let en=this._getAndRemoveByKey(this.order[0]);en&&this.onRemove(en)}return this}has(en){return en.wrapped().key in this.data}getAndRemove(en){return this.has(en)?this._getAndRemoveByKey(en.wrapped().key):null}_getAndRemoveByKey(en){let el=this.data[en].shift();return el.timeout&&clearTimeout(el.timeout),0===this.data[en].length&&delete this.data[en],this.order.splice(this.order.indexOf(en),1),el.value}getByKey(en){let el=this.data[en];return el?el[0].value:null}get(en){return this.has(en)?this.data[en.wrapped().key][0].value:null}remove(en,el){if(!this.has(en))return this;let eu=en.wrapped().key,ec=void 0===el?0:this.data[eu].indexOf(el),ed=this.data[eu][ec];return this.data[eu].splice(ec,1),ed.timeout&&clearTimeout(ed.timeout),0===this.data[eu].length&&delete this.data[eu],this.onRemove(ed.value),this.order.splice(this.order.indexOf(eu),1),this}setMaxSize(en){for(this.max=en;this.order.length>this.max;){let en=this._getAndRemoveByKey(this.order[0]);en&&this.onRemove(en)}return this}filter(en){let el=[];for(let eu in this.data)for(let ec of this.data[eu])en(ec.value)||el.push(ec);for(let en of el)this.remove(en.value.tileID,en)}};let Cg=class Cg{constructor(en,el,eu,ec){this.id=Cg.uniqueIdxCounter,Cg.uniqueIdxCounter++,this.context=en;let ed=en.gl;this.buffer=ed.createBuffer(),this.dynamicDraw=!!eu,this.context.unbindVAO(),en.bindElementBuffer.set(this.buffer),ed.bufferData(ed.ELEMENT_ARRAY_BUFFER,el.arrayBuffer,this.dynamicDraw?ed.DYNAMIC_DRAW:ed.STATIC_DRAW),this.dynamicDraw||ec||el.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(en){this.id=Cg.uniqueIdxCounter,Cg.uniqueIdxCounter++;let el=this.context.gl;this.context.unbindVAO(),this.bind(),el.bufferSubData(el.ELEMENT_ARRAY_BUFFER,0,en.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}};Cg.uniqueIdxCounter=0;let Rg=class Rg{constructor(en,el,eu){this.func=en,this.mask=el,this.range=eu}};Rg.ReadOnly=!1,Rg.ReadWrite=!0,Rg.disabled=new Rg(519,Rg.ReadOnly,[0,1]);let Vg=class Vg{constructor(en,el,eu,ec,ed,ef){this.test=en,this.ref=el,this.mask=eu,this.fail=ec,this.depthFail=ed,this.pass=ef}};Vg.disabled=new Vg({func:519,mask:0},0,0,7680,7680,7680);let Og=class Og{constructor(en,el,eu,ec){this.blendFunction=en,this.blendColor=el,this.mask=eu,this.blendEquation=ec}};Og.Replace=[1,0,1,0],Og.disabled=new Og(Og.Replace,Ce.transparent,[!1,!1,!1,!1]),Og.unblended=new Og(Og.Replace,Ce.transparent,[!0,!0,!0,!0]),Og.alphaBlended=new Og([1,771,1,771],Ce.transparent,[!0,!0,!0,!0]),Og.multiply=new Og([774,0,774,0],Ce.transparent,[!0,!0,!0,!0]);let Ug=class Ug{constructor(en,el,eu){this.enable=en,this.mode=el,this.frontFace=eu}};Ug.disabled=new Ug(!1,1029,2305),Ug.backCCW=new Ug(!0,1029,2305),Ug.backCW=new Ug(!0,1029,2304),Ug.frontCW=new Ug(!0,1028,2304),Ug.frontCCW=new Ug(!0,1028,2305);let Ng=class Ng extends ee{constructor(en,el,eu){super(),this.id=en,this._onlySymbols=eu,el.on("data",en=>{"source"===en.dataType&&"metadata"===en.sourceDataType&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===en.dataType&&"content"===en.sourceDataType&&(this.reload(),this.transform&&this.update(this.transform))}),el.on("error",()=>{this._sourceErrored=!0}),this._source=el,this._tiles={},this._cache=new Dg(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=el.minTileCacheSize,this._maxTileCacheSize=el.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Vd,this._isRaster="raster"===this._source.type||"raster-dem"===this._source.type||"custom"===this._source.type&&"raster"===this._source._dataType}onAdd(en){this.map=en,this._minTileCacheSize=void 0===this._minTileCacheSize&&en?en._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=void 0===this._maxTileCacheSize&&en?en._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(let en in this._tiles){let el=this._tiles[en];if("errored"!==el.state&&("loaded"!==el.state||!el.bucketsLoaded()))return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;let en=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,en&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(en,el){return en.isSymbolTile=this._onlySymbols,en.isExtraShadowCaster=this._shadowCasterTiles[en.tileID.key],this._source.loadTile(en,el)}_unloadTile(en){if(this._source.unloadTile)return this._source.unloadTile(en,()=>{})}_abortTile(en){if(this._source.abortTile)return this._source.abortTile(en,()=>{})}serialize(){return this._source.serialize()}prepare(en){for(let el in this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null),this._tiles){let eu=this._tiles[el];eu.upload(en),eu.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return E(this._tiles).map(en=>en.tileID).sort($g).map(en=>en.key)}getRenderableIds(en,el){let eu=[];for(let ec in this._tiles)this._isIdRenderable(+ec,en,el)&&eu.push(this._tiles[ec]);return en?eu.sort((en,el)=>{let eu=en.tileID,ec=el.tileID,ed=new eB(eu.canonical.x,eu.canonical.y)._rotate(this.transform.angle),ef=new eB(ec.canonical.x,ec.canonical.y)._rotate(this.transform.angle);return eu.overscaledZ-ec.overscaledZ||ef.y-ed.y||ef.x-ed.x}).map(en=>en.tileID.key):eu.map(en=>en.tileID).sort($g).map(en=>en.key)}hasRenderableParent(en){let el=this.findLoadedParent(en,0);return!!el&&this._isIdRenderable(el.tileID.key)}_isIdRenderable(en,el,eu){return this._tiles[en]&&this._tiles[en].hasData()&&!this._coveredTiles[en]&&(el||!this._tiles[en].holdingForFade())&&(eu||!this._shadowCasterTiles[en])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else for(let en in this._cache.reset(),this._tiles)"errored"!==this._tiles[en].state&&this._reloadTile(+en,"reloading")}_reloadTile(en,el){let eu=this._tiles[en];eu&&("loading"!==eu.state&&(eu.state=el),this._loadTile(eu,this._tileLoaded.bind(this,eu,en,el)))}_tileLoaded(en,el,eu,ec){if(ec){if(en.state="errored",404!==ec.status)this._source.fire(new te(ec,{tile:en}));else{if(!(en.tileID.key in this._loadedParentTiles))return void this._source.fire(new Qt("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id}));if("raster-dem"===this._source.type&&this.usedForTerrain&&this.map.painter.terrain){let en=this.map.painter.terrain;this.update(this.transform,en.getScaledDemTileSize(),!0),en.resetTileLookupCache(this.id)}else this.update(this.transform)}}else en.timeAdded=ta.now(),"expired"===eu&&(en.refreshedUponExpiration=!0),this._setTileReloadTimer(el,en),"raster-dem"===this._source.type&&en.dem&&this._backfillDEM(en),this._state.initializeTileState(en,this.map?this.map.painter:null),this._source.fire(new Qt("data",{dataType:"source",tile:en,coord:en.tileID,sourceCacheId:this.id}))}_backfillDEM(en){let el=this.getRenderableIds();for(let eu=0;eu<el.length;eu++){let ec=el[eu];if(en.neighboringTiles&&en.neighboringTiles[ec]){let el=this.getTileByID(ec);r(en,el),r(el,en)}}function r(en,el){if(!en.dem||en.dem.borderReady)return;en.needsHillshadePrepare=!0,en.needsDEMTextureUpload=!0;let eu=el.tileID.canonical.x-en.tileID.canonical.x,ec=el.tileID.canonical.y-en.tileID.canonical.y,ed=Math.pow(2,en.tileID.canonical.z),ef=el.tileID.key;0===eu&&0===ec||Math.abs(ec)>1||(Math.abs(eu)>1&&(1===Math.abs(eu+ed)?eu+=ed:1===Math.abs(eu-ed)&&(eu-=ed)),el.dem&&en.dem&&(en.dem.backfillBorder(el.dem,eu,ec),en.neighboringTiles&&en.neighboringTiles[ef]&&(en.neighboringTiles[ef].backfilled=!0)))}}getTile(en){return this.getTileByID(en.key)}getTileByID(en){return this._tiles[en]}_retainLoadedChildren(en,el,eu,ec){for(let ed in this._tiles){let ef=this._tiles[ed];if(ec[ed]||!ef.hasData()||ef.tileID.overscaledZ<=el||ef.tileID.overscaledZ>eu)continue;let em=ef.tileID;for(;ef&&ef.tileID.overscaledZ>el+1;){let en=ef.tileID.scaledTo(ef.tileID.overscaledZ-1);(ef=this._tiles[en.key])&&ef.hasData()&&(em=en)}let e_=em;for(;e_.overscaledZ>el;)if(en[(e_=e_.scaledTo(e_.overscaledZ-1)).key]){ec[em.key]=em;break}}}findLoadedParent(en,el){if(en.key in this._loadedParentTiles){let eu=this._loadedParentTiles[en.key];return eu&&eu.tileID.overscaledZ>=el?eu:null}for(let eu=en.overscaledZ-1;eu>=el;eu--){let el=en.scaledTo(eu),ec=this._getLoadedTile(el);if(ec)return ec}}_getLoadedTile(en){let el=this._tiles[en.key];return el&&el.hasData()?el:this._cache.getByKey(this._source.reparseOverscaled?en.wrapped().key:en.canonical.key)}updateCacheSize(en,el){el=el||this._source.tileSize;let eu=Math.ceil(en.width/el)+1,ec=Math.ceil(en.height/el)+1,ed=Math.floor(eu*ec*5),ef="number"==typeof this._minTileCacheSize?Math.max(this._minTileCacheSize,ed):ed,em="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,ef):ef;this._cache.setMaxSize(em)}handleWrapJump(en){let el=Math.round((en-(void 0===this._prevLng?en:this._prevLng))/360);if(this._prevLng=en,el){let en={};for(let eu in this._tiles){let ec=this._tiles[eu];ec.tileID=ec.tileID.unwrapTo(ec.tileID.wrap+el),en[ec.tileID.key]=ec}for(let el in this._tiles=en,this._timers)clearTimeout(this._timers[el]),delete this._timers[el];for(let en in this._tiles)this._setTileReloadTimer(+en,this._tiles[en])}}update(en,el,eu,ec){let ed;if(this.transform=en,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!eu)return;if(this.updateCacheSize(en,el),"globe"!==this.transform.projection.name&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?ed=en.getVisibleUnwrappedCoordinates(this._source.tileID).map(en=>new Hc(en.canonical.z,en.wrap,en.canonical.z,en.canonical.x,en.canonical.y)):(ed=en.coveringTiles({tileSize:el||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!eu,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile&&(ed=ed.filter(en=>this._source.hasTile(en)))):ed=[],ed.length>0&&this.castsShadows&&ec&&"globe"!==this.transform.projection.name&&!this.usedForTerrain&&!qg(this._source.type)){let ef=en.coveringZoomLevel({tileSize:el||this._source.tileSize,roundZoom:this._source.roundZoom&&!eu}),em=Math.min(ef,this._source.maxzoom),e_=en.extendTileCoverForShadows(ed,ec,em);for(let en of e_)this._shadowCasterTiles[en.key]=!0,ed.push(en)}let ef=this._updateRetainedTiles(ed);if(qg(this._source.type)&&0!==ed.length){let en={},el={},eu=Object.keys(ef);for(let ec of eu){let eu=ef[ec],ed=this._tiles[ec];if(!ed||ed.fadeEndTime&&ed.fadeEndTime<=ta.now())continue;let em=this.findLoadedParent(eu,Math.max(eu.overscaledZ-Ng.maxOverzooming,this._source.minzoom));em&&(this._addTile(em.tileID),en[em.tileID.key]=em.tileID),el[ec]=eu}let ec=ed[ed.length-1].overscaledZ;for(let en in this._tiles){let eu=this._tiles[en];if(ef[en]||!eu.hasData())continue;let ed=eu.tileID;for(;ed.overscaledZ>ec;){ed=ed.scaledTo(ed.overscaledZ-1);let ec=this._tiles[ed.key];if(ec&&ec.hasData()&&el[ed.key]){ef[en]=eu.tileID;break}}}for(let el in en)ef[el]||(this._coveredTiles[el]=!0,ef[el]=en[el])}for(let en in ef)this._tiles[en].clearFadeHold();let em=function(en,el){let eu=[];for(let ec in en)ec in el||eu.push(ec);return eu}(this._tiles,ef);for(let en of em){let el=this._tiles[en];el.hasSymbolBuckets&&!el.holdingForFade()?el.setHoldDuration(this.map._fadeDuration):el.hasSymbolBuckets&&!el.symbolFadeFinished()||this._removeTile(+en)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(let en in this._tiles)this._tiles[en].holdingForFade()&&this._removeTile(+en)}_updateRetainedTiles(en){let el={};if(0===en.length)return el;let eu={},ec=en.reduce((en,el)=>Math.min(en,el.overscaledZ),1/0),ed=en[0].overscaledZ,ef=Math.max(ed-Ng.maxOverzooming,this._source.minzoom),em=Math.max(ed+Ng.maxUnderzooming,this._source.minzoom),e_={};for(let eu of en){let en=this._addTile(eu);el[eu.key]=eu,en.hasData()||ec<this._source.maxzoom&&(e_[eu.key]=eu)}for(let ed of(this._retainLoadedChildren(e_,ec,em,el),en)){let en=this._tiles[ed.key];if(en.hasData())continue;if(ed.canonical.z>=this._source.maxzoom){let en=ed.children(this._source.maxzoom)[0],eu=this.getTile(en);if(eu&&eu.hasData()){el[en.key]=en;continue}}else{let en=ed.children(this._source.maxzoom);if(el[en[0].key]&&el[en[1].key]&&el[en[2].key]&&el[en[3].key])continue}let ec=en.wasRequested();for(let em=ed.overscaledZ-1;em>=ef;--em){let ef=ed.scaledTo(em);if(eu[ef.key]||(eu[ef.key]=!0,(en=this.getTile(ef))||!ec||(en=this._addTile(ef)),en&&(el[ef.key]=ef,ec=en.wasRequested(),en.hasData())))break}}return el}_updateLoadedParentTileCache(){for(let en in this._loadedParentTiles={},this._tiles){let el=[],eu,ec=this._tiles[en].tileID;for(;ec.overscaledZ>0;){if(ec.key in this._loadedParentTiles){eu=this._loadedParentTiles[ec.key];break}el.push(ec.key);let en=ec.scaledTo(ec.overscaledZ-1);if(eu=this._getLoadedTile(en))break;ec=en}for(let en of el)this._loadedParentTiles[en]=eu}}_addTile(en){let el=this._tiles[en.key];if(el)return!0!==el.isExtraShadowCaster||this._shadowCasterTiles[en.key]||this._reloadTile(en.key,"reloading"),el;(el=this._cache.getAndRemove(en))&&(this._setTileReloadTimer(en.key,el),el.tileID=en,this._state.initializeTileState(el,this.map?this.map.painter:null),this._cacheTimers[en.key]&&(clearTimeout(this._cacheTimers[en.key]),delete this._cacheTimers[en.key],this._setTileReloadTimer(en.key,el)));let eu=!!el;if(!eu){let eu=this.map?this.map.painter:null;el=new Bg(en,this._source.tileSize*en.overscaleFactor(),this.transform.tileZoom,eu,this._isRaster),this._loadTile(el,this._tileLoaded.bind(this,el,en.key,el.state))}return el?(el.uses++,this._tiles[en.key]=el,eu||this._source.fire(new Qt("dataloading",{tile:el,coord:el.tileID,dataType:"source"})),el):null}_setTileReloadTimer(en,el){en in this._timers&&(clearTimeout(this._timers[en]),delete this._timers[en]);let eu=el.getExpiryTimeout();eu&&(this._timers[en]=setTimeout(()=>{this._reloadTile(en,"expired"),delete this._timers[en]},eu))}_removeTile(en){let el=this._tiles[en];el&&(el.uses--,delete this._tiles[en],this._timers[en]&&(clearTimeout(this._timers[en]),delete this._timers[en]),el.uses>0||(el.hasData()&&"reloading"!==el.state?this._cache.add(el.tileID,el,el.getExpiryTimeout()):(el.aborted=!0,this._abortTile(el),this._unloadTile(el))))}clearTiles(){for(let en in this._shouldReloadOnResume=!1,this._paused=!1,this._tiles)this._removeTile(+en);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(en,el,eu){let ec=[],ed=this.transform;if(!ed)return ec;let ef="globe"===ed.projection.name,em=Hh(ed.center.lng);for(let e_ in this._tiles){let ew;let eT=this._tiles[e_];if(eu&&eT.clearQueryDebugViz(),!eT.holdingForFade()){if(ef){let en=eT.tileID.canonical;if(0===en.z){let el=[Math.abs(k(em,...Gg(en,-1))-em),Math.abs(k(em,...Gg(en,1))-em)];ew=[0,2*el.indexOf(Math.min(...el))-1]}else{let el=[Math.abs(k(em,...Gg(en,-1))-em),Math.abs(k(em,...Gg(en,0))-em),Math.abs(k(em,...Gg(en,1))-em)];ew=[el.indexOf(Math.min(...el))-1]}}else ew=[0];for(let eu of ew){let ef=en.containsTile(eT,ed,el,eu);ef&&ec.push(ef)}}}return ec}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(en){return this._getRenderableCoordinates(en)}_getRenderableCoordinates(en,el){let eu=this.getRenderableIds(en,el).map(en=>this._tiles[en].tileID),ec="globe"===this.transform.projection.name;for(let en of eu)en.projMatrix=this.transform.calculateProjMatrix(en.toUnwrapped()),en.expandedProjMatrix=ec?this.transform.calculateProjMatrix(en.toUnwrapped(),!1,!0):en.projMatrix;return eu}sortCoordinatesByDistance(en){let el=en.slice(),eu=this.transform._camera.position,ec=this.transform._camera.forward(),ed={};for(let en of el){let el=1/(1<<en.canonical.z);ed[en.key]=((en.canonical.x+.5)*el+en.wrap-eu[0])*ec[0]+((en.canonical.y+.5)*el-eu[1])*ec[1]-eu[2]*ec[2]}return el.sort((en,el)=>ed[en.key]-ed[el.key]),el}hasTransition(){if(this._source.hasTransition())return!0;if(qg(this._source.type))for(let en in this._tiles){let el=this._tiles[en];if(void 0!==el.fadeEndTime&&el.fadeEndTime>=ta.now())return!0}return!1}setFeatureState(en,el,eu){this._state.updateState(en=en||"_geojsonTileLayer",el,eu)}removeFeatureState(en,el,eu){this._state.removeFeatureState(en=en||"_geojsonTileLayer",el,eu)}getFeatureState(en,el){return this._state.getState(en=en||"_geojsonTileLayer",el)}setDependencies(en,el,eu){let ec=this._tiles[en];ec&&ec.setDependencies(el,eu)}reloadTilesForDependencies(en,el){for(let eu in this._tiles)this._tiles[eu].hasDependency(en,el)&&this._reloadTile(+eu,"reloading");this._cache.filter(eu=>!eu.hasDependency(en,el))}_preloadTiles(en,el){if(!this._sourceLoaded){let r=()=>{this._sourceLoaded&&(this._source.off("data",r),this._preloadTiles(en,el))};return void this._source.on("data",r)}let eu=new Map,ec=Array.isArray(en)?en:[en],ed=this.map.painter.terrain,ef=this.usedForTerrain&&ed?ed.getScaledDemTileSize():this._source.tileSize;for(let en of ec){let el=en.coveringTiles({tileSize:ef,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(let en of el)eu.set(en.key,en);this.usedForTerrain&&en.updateElevation(!1)}z(Array.from(eu.values()),(en,el)=>{let eu=new Bg(en,this._source.tileSize*en.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(eu,en=>{"raster-dem"===this._source.type&&eu.dem&&this._backfillDEM(eu),el(en,eu)})},el)}};function $g(en,el){let eu=Math.abs(2*en.wrap)-+(en.wrap<0),ec=Math.abs(2*el.wrap)-+(el.wrap<0);return en.overscaledZ-el.overscaledZ||ec-eu||el.canonical.y-en.canonical.y||el.canonical.x-en.canonical.x}function qg(en){return"raster"===en||"image"===en||"video"===en||"custom"===en}function Gg(en,el){let eu=1<<en.z;return[en.x/eu+el,(en.x+1)/eu+el]}Ng.maxOverzooming=10,Ng.maxUnderzooming=3;let nz=Ua([{name:"a_pos_3f",components:3,type:"Float32"}]),nD=Ua([{name:"a_color_3f",components:3,type:"Float32"}]),nL=Ua([{name:"a_color_4f",components:4,type:"Float32"}]),nk=Ua([{name:"a_uv_2f",components:2,type:"Float32"}]),nR=Ua([{name:"a_normal_3f",components:3,type:"Float32"}]),nO=Ua([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),nB=Ua([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);function Qg(el,eu){let ec=ex(el.projection,el.zoom,el.width,el.height),ed=function(el,eu,ec,ed,ef){let em=new r9(ec.lng-180*nF,ec.lat),e_=new r9(ec.lng+180*nF,ec.lat),ew=el.project(em.lng,em.lat),eT=el.project(e_.lng,e_.lat),eM=-Math.atan2(eT.y-ew.y,eT.x-ew.x),eE=lp.fromLngLat(ec);eE.y=k(eE.y,-1+nF,1-nF);let eS=eE.toLngLat(),eA=el.project(eS.lng,eS.lat),eI=lp.fromLngLat(eS);eI.x+=nF;let eC=eI.toLngLat(),eP=el.project(eC.lng,eC.lat),ez=ix(eP.x-eA.x,eP.y-eA.y,eM),eD=lp.fromLngLat(eS);eD.y+=nF;let eL=eD.toLngLat(),ek=el.project(eL.lng,eL.lat),eR=ix(ek.x-eA.x,ek.y-eA.y,eM),eO=Math.abs(ez.x)/Math.abs(eR.y),eB=en.m.identity([]);en.m.rotateZ(eB,eB,-eM*(1-(ef?0:ed)));let eF=en.m.identity([]);return en.m.scale(eF,eF,[1,1-(1-eO)*ed,1]),eF[4]=-eR.x/eR.y*ed,en.m.rotateZ(eF,eF,eM),en.m.multiply(eF,eB,eF),eF}(el.projection,0,el.center,ec,eu),ef=tx(el);return en.m.scale(ed,ed,[ef,ef,1]),ed}function tx(en){let el=en.projection,eu=ex(en.projection,en.zoom,en.width,en.height),ec=nx(el,en.center),ed=nx(el,r9.convert(el.center));return Math.pow(2,ec*eu+(1-eu)*ed)}function ex(en,el,eu,ec,ed=1/0){let ef=en.range;if(!ef)return 0;let em=Math.min(ed,Math.max(eu,ec)),e_=Math.log(em/1024)/Math.LN2;return T(ef[0]+e_,ef[1]+e_,el)}let nF=1/4e4;function nx(en,el){let eu=k(el.lat,-ai,ai),ec=new r9(el.lng-180*nF,eu),ed=new r9(el.lng+180*nF,eu),ef=en.project(ec.lng,eu),em=en.project(ed.lng,eu),e_=lp.fromLngLat(ec),ew=lp.fromLngLat(ed),eT=em.x-ef.x,eM=em.y-ef.y,eE=ew.x-e_.x,eS=ew.y-e_.y,eA=Math.sqrt((eE*eE+eS*eS)/(eT*eT+eM*eM));return Math.log(eA)/Math.LN2}function ix(en,el,eu){let ec=Math.cos(eu),ed=Math.sin(eu);return{x:en*ec-el*ed,y:en*ed+el*ec}}function sx(en,el,eu){return el*(8192/(en.tileSize*Math.pow(2,eu-en.tileID.overscaledZ)))}function ax(el,eu,ec){en.m.identity(el),en.m.rotateZ(el,el,eu[2]*eF),en.m.rotateX(el,el,eu[0]*eF),en.m.rotateY(el,el,eu[1]*eF),en.m.scale(el,el,ec),en.m.multiply(el,el,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function ox(el,eu,ec,ed,ef,em,e_,ew){let eT=[ec[0]-eu[0],ec[1]-eu[1],0],eM=[ed[0]-eu[0],ed[1]-eu[1],0];if(1e-12>en.v.length(eT)||1e-12>en.v.length(eM))return en.q.identity(el);let eE=en.v.cross([],eT,eM);return en.v.normalize(eE,eE),en.v.subtract(eM,ed,eu),eT[2]=(em-ef)*ew,eM[2]=(e_-ef)*ew,en.v.cross(eT,eT,eM),en.v.normalize(eT,eT),en.q.rotationTo(el,eE,eT)}function lx(el,eu,ec=!1){let ed=Oh(eu.zoom),ef=function(el,eu,ec){let ed=eu.worldSize,ef=[el[12],el[13],el[14]],em=ep(ef[1]/ed),e_=tp(ef[0]/ed),ew=en.m.identity([]),eT=1/Wh(em)*ed,eM=1/Wh(0)*ed*sp(em,eu.zoom),eE=1/Rh(ed),eS=eM*eE;if(ec){let en=ex(eu.projection,eu.zoom,eu.width,eu.height,1024);eS=eE*eu.projection.pixelSpaceConversion(eu.center.lat,ed,en)}let eA=Ph(em,e_);en.v.add(eA,eA,en.v.scale([],en.v.normalize([],eA),eT*eS*ef[2]));let eI=function(el){let eu=[el[0],el[1],el[2]],ec=[0,1,0],ed=en.v.cross([],ec,eu);return en.v.cross(ec,eu,ed),0===en.v.squaredLength(ec)&&(ec=[0,1,0],en.v.cross(ed,eu,ec)),en.v.normalize(ed,ed),en.v.normalize(ec,ec),en.v.normalize(eu,eu),[ed[0],ed[1],ed[2],0,ec[0],ec[1],ec[2],0,eu[0],eu[1],eu[2],0,el[0],el[1],el[2],1]}(eA);en.m.scale(ew,ew,[eS,eS,eS*eT]),en.m.translate(ew,ew,[-ef[0],-ef[1],-ef[2]]);let eC=en.m.multiply([],eu.globeMatrix,eI);return en.m.multiply(eC,eC,ew),en.m.multiply(eC,eC,el),eC}(el,eu,ec);if(ed>0){let ec=function(el,eu){let ec=eu.worldSize,ed=1/Wh(0)*ec*sp(eu.center.lat,eu.zoom)/Rh(ec),ef=1/Wh(eu.center.lat)*ec,em=en.m.identity([]);return en.m.rotateY(em,em,eu.center.lng*eF),en.m.rotateX(em,em,eu.center.lat*eF),en.m.translate(em,em,[0,0,rQ]),en.m.scale(em,em,[ed,ed,ed*ef]),en.m.translate(em,em,[eu.point.x-.5*ec,eu.point.y-.5*ec,0]),en.m.multiply(em,em,el),en.m.multiply(em,eu.globeMatrix,em)}(el,eu);return function(el,eu,ec){let i=(el,eu,ec)=>{let ed=en.v.length(el),ef=en.v.length(eu),em=wh(el,eu,ec);return en.v.scale(em,em,1/en.v.length(em)*Mn(ed,ef,ec))},ed=i([el[0],el[1],el[2]],[eu[0],eu[1],eu[2]],ec),ef=i([el[4],el[5],el[6]],[eu[4],eu[5],eu[6]],ec),em=i([el[8],el[9],el[10]],[eu[8],eu[9],eu[10]],ec),e_=wh([el[12],el[13],el[14]],[eu[12],eu[13],eu[14]],ec);return[ed[0],ed[1],ed[2],0,ef[0],ef[1],ef[2],0,em[0],em[1],em[2],0,e_[0],e_[1],e_[2],1]}(ef,ec,ed)}return ef}let nN={CoordinateSpaceTile:1,CoordinateSpaceYUp:2,HasMapboxMeshFeatures:4};function hx(en,el,eu=!1){en.uploaded||(en.gfxTexture=new _g(el,en.image,eu?el.gl.R8:el.gl.RGBA,{useMipmap:en.sampler.minFilter>=el.gl.NEAREST_MIPMAP_NEAREST}),en.uploaded=!0,en.image=null)}function fx(en,el,eu){if(en.meshes)for(let ec of en.meshes)!function(en,el,eu){en.indexBuffer=el.createIndexBuffer(en.indexArray,!1,!0),en.vertexBuffer=el.createVertexBuffer(en.vertexArray,nz.members,!1,!0),en.normalArray&&(en.normalBuffer=el.createVertexBuffer(en.normalArray,nR.members,!1,!0)),en.texcoordArray&&(en.texcoordBuffer=el.createVertexBuffer(en.texcoordArray,nk.members,!1,!0)),en.colorArray&&(en.colorBuffer=el.createVertexBuffer(en.colorArray,(12===en.colorArray.bytesPerElement?nD:nL).members,!1,!0)),en.featureArray&&(en.pbrBuffer=el.createVertexBuffer(en.featureArray,nB.members,!0)),en.segments=Do.simpleSegment(0,0,en.vertexArray.length,en.indexArray.length);let ec=en.material;ec.pbrMetallicRoughness.baseColorTexture&&hx(ec.pbrMetallicRoughness.baseColorTexture,el),ec.pbrMetallicRoughness.metallicRoughnessTexture&&hx(ec.pbrMetallicRoughness.metallicRoughnessTexture,el),ec.normalTexture&&hx(ec.normalTexture,el),ec.occlusionTexture&&hx(ec.occlusionTexture,el,eu),ec.emissionTexture&&hx(ec.emissionTexture,el)}(ec,el,eu);if(en.children)for(let ec of en.children)fx(ec,el,eu)}function dx(en){if(en.meshes)for(let el of en.meshes)el.indexArray.destroy(),el.vertexArray.destroy(),el.colorArray&&el.colorArray.destroy(),el.normalArray&&el.normalArray.destroy(),el.texcoordArray&&el.texcoordArray.destroy(),el.featureArray&&el.featureArray.destroy();if(en.children)for(let el of en.children)dx(el)}function mx(en){var el;if(en.meshes)for(let eu of en.meshes)eu.vertexBuffer&&(eu.vertexBuffer.destroy(),eu.indexBuffer.destroy(),eu.normalBuffer&&eu.normalBuffer.destroy(),eu.texcoordBuffer&&eu.texcoordBuffer.destroy(),eu.colorBuffer&&eu.colorBuffer.destroy(),eu.pbrBuffer&&eu.pbrBuffer.destroy(),eu.segments.destroy(),eu.material&&((el=eu.material).pbrMetallicRoughness.baseColorTexture&&el.pbrMetallicRoughness.baseColorTexture.gfxTexture&&el.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),el.pbrMetallicRoughness.metallicRoughnessTexture&&el.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&el.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),el.normalTexture&&el.normalTexture.gfxTexture&&el.normalTexture.gfxTexture.destroy(),el.emissionTexture&&el.emissionTexture.gfxTexture&&el.emissionTexture.gfxTexture.destroy(),el.occlusionTexture&&el.occlusionTexture.gfxTexture&&el.occlusionTexture.gfxTexture.destroy()));if(en.children)for(let el of en.children)mx(el)}let yx=class yx{constructor(en,el){this.feature=en,this.instancedDataOffset=el,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}};let gx=class gx{constructor(){this.instancedDataArray=new go,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}};let xx=class xx{constructor(en){this.zoom=en.zoom,this.canonical=en.canonical,this.layers=en.layers,this.layerIds=this.layers.map(en=>en.fqid),this.projection=en.projection,this.index=en.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(en=>en.isStateDependent()).map(en=>en.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0}}populate(en,el,eu,ec){this.tileToMeter=op(eu);let ed=this.layers[0]._featureFilter.needGeometry;for(let{feature:ef,id:em,index:e_,sourceLayerIndex:ew}of(this.lookup=new Uint8Array(this.lookupDim*this.lookupDim),en)){let en=gp(ef,ed);if(!this.layers[0]._featureFilter.filter(new _a(this.zoom),en,eu))continue;let eT={id:em,sourceLayerIndex:ew,index:e_,geometry:ed?en.geometry:yp(ef,eu,ec),properties:ef.properties,type:ef.type,patterns:{}},eM=this.addFeature(eT,eT.geometry,en);eM&&el.featureIndex.insert(ef,eT.geometry,e_,ew,this.index,this.instancesPerModel[eM].instancedDataArray.length)}this.lookup=null}update(en,el,eu,ec){for(let el in this.instancesPerModel){let eu=this.instancesPerModel[el];for(let el in en)eu.idToFeaturesIndex.hasOwnProperty(el)&&this.evaluate(eu.features[eu.idToFeaturesIndex[el]],en[el],eu,!0)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let el=!1;for(let eu in this.instancesPerModel){let ec=this.instancesPerModel[eu];for(let eu of ec.features){let ed=this.layers[0],ef=eu.feature,em=this.canonical,e_=ed.paint.get("model-rotation").evaluate(ef,{},em),ew=ed.paint.get("model-scale").evaluate(ef,{},em),eT=ed.paint.get("model-translation").evaluate(ef,{},em);en.v.exactEquals(eu.rotation,e_)&&en.v.exactEquals(eu.scale,ew)&&en.v.exactEquals(eu.translation,eT)||(this.evaluate(eu,eu.featureStates,ec,!0),el=!0)}}return el}isEmpty(){for(let en in this.instancesPerModel)if(0!==this.instancesPerModel[en].instancedDataArray.length)return!1;return!0}uploadPending(){return!this.uploaded}upload(en){if(!this.uploaded)for(let el in this.instancesPerModel){let eu=this.instancesPerModel[el];eu.instancedDataArray.length<0||0===eu.instancedDataArray.length||(eu.instancedDataBuffer?eu.instancedDataBuffer.updateData(eu.instancedDataArray):eu.instancedDataBuffer=en.createVertexBuffer(eu.instancedDataArray,nO.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(let en in this.instancesPerModel){let el=this.instancesPerModel[en];0!==el.instancedDataArray.length&&el.instancedDataBuffer&&el.instancedDataBuffer.destroy()}}addFeature(en,el,eu){let ec=this.layers[0],ed=ec.layout.get("model-id").evaluate(eu,{},this.canonical);if(!ed)return q(`modelId is not evaluated for layer ${ec.id} and it is not going to get rendered.`),ed;this.instancesPerModel[ed]||(this.instancesPerModel[ed]=new gx);let ef=this.instancesPerModel[ed],em=ef.instancedDataArray,e_=new yx(eu,em.length);for(let en of el)for(let el of en){if(el.x<0||el.x>=8192||el.y<0||el.y>=8192)continue;let en=(this.lookupDim-1)/8192,eu=this.lookupDim*(el.y*en|0)+el.x*en|0;if(this.lookup){if(0!==this.lookup[eu])continue;this.lookup[eu]=1}this.instanceCount++;let ec=em.length;em.resize(ec+1),ef.instancesEvaluatedElevation.push(0),em.float32[16*ec]=el.x,em.float32[16*ec+1]=el.y}return e_.instancedDataCount=ef.instancedDataArray.length-e_.instancedDataOffset,e_.instancedDataCount>0&&(en.id&&(ef.idToFeaturesIndex[en.id]=ef.features.length),ef.features.push(e_),this.evaluate(e_,{},ef,!1)),ed}evaluate(en,el,eu,ec){let ed=this.layers[0],ef=en.feature,em=this.canonical,e_=en.rotation=ed.paint.get("model-rotation").evaluate(ef,el,em),ew=en.scale=ed.paint.get("model-scale").evaluate(ef,el,em),eT=en.translation=ed.paint.get("model-translation").evaluate(ef,el,em),eM=ed.paint.get("model-color").evaluate(ef,el,em);eM.a=ed.paint.get("model-color-mix-intensity").evaluate(ef,el,em);let eE=[];this.maxVerticalOffset<eT[2]&&(this.maxVerticalOffset=eT[2]),this.maxScale=Math.max(Math.max(this.maxScale,ew[0]),Math.max(ew[1],ew[2])),ax(eE,e_,ew);let eS=Math.round(100*eM.a)+eM.b/1.05;for(let el=0;el<en.instancedDataCount;++el){let ed=en.instancedDataOffset+el,ef=16*ed,e_=eu.instancedDataArray.float32,ew=0;ec&&(ew=e_[ef+6]-eu.instancesEvaluatedElevation[ed]);let eA=0|e_[ef+1];e_[ef]=(0|e_[ef])+eM.r/1.05,e_[ef+1]=eA+eM.g/1.05,e_[ef+2]=eS,e_[ef+3]=1/(em.z>10?this.tileToMeter:op(em,eA)),e_[ef+4]=eT[0],e_[ef+5]=eT[1],e_[ef+6]=eT[2]+ew,e_[ef+7]=eE[0],e_[ef+8]=eE[1],e_[ef+9]=eE[2],e_[ef+10]=eE[4],e_[ef+11]=eE[5],e_[ef+12]=eE[6],e_[ef+13]=eE[8],e_[ef+14]=eE[9],e_[ef+15]=eE[10],eu.instancesEvaluatedElevation[ed]=eT[2]}}};Ks(xx,"ModelBucket",{omit:["layers"]}),Ks(gx,"PerModelAttributes"),Ks(yx,"ModelFeature");let nU=new Da({visibility:new za(tc.layout_model.visibility),"model-id":new Ea(tc.layout_model["model-id"])});var nV={paint:new Da({"model-opacity":new za(tc.paint_model["model-opacity"]),"model-rotation":new Ea(tc.paint_model["model-rotation"]),"model-scale":new Ea(tc.paint_model["model-scale"]),"model-translation":new Ea(tc.paint_model["model-translation"]),"model-color":new Ea(tc.paint_model["model-color"]),"model-color-mix-intensity":new Ea(tc.paint_model["model-color-mix-intensity"]),"model-type":new za(tc.paint_model["model-type"]),"model-cast-shadows":new za(tc.paint_model["model-cast-shadows"]),"model-receive-shadows":new za(tc.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new za(tc.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new Ea(tc.paint_model["model-emissive-strength"]),"model-roughness":new Ea(tc.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new Ea(tc.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new za(tc.paint_model["model-cutoff-fade-range"])}),layout:nU};let nj=new Float32Array(262144),nG=new Uint8Array(262144),nq=["","wall","door","roof","window","lamp","logo"];let Sx=class Sx{constructor(en){this.node=en,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.feature={type:"Point",id:en.id,geometry:[],properties:{height:function Mx(en){let el=0;if(en.meshes)for(let eu of en.meshes)el=Math.max(el,eu.aabb.max[2]);if(en.children)for(let eu of en.children)el=Math.max(el,Mx(eu));return el}(en)}}}};let Ix=class Ix{constructor(en,el,eu,ec){this.nodes=en,this.id=el,this.modelTraits|=nN.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,eu&&(this.modelTraits|=nN.HasMapboxMeshFeatures),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=ec,this.dirty=!0,this.needsUpload=!1}update(){console.log("Update 3D model bucket")}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(en){if(!this.needsUpload)return;let el=this.getNodesInfo();for(let eu of el){let el=eu.node;this.uploaded?this.updatePbrBuffer(el):fx(el,en,!0)}for(let en of el)dx(en.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(en){let el=!1;if(!en.meshes)return el;for(let eu of en.meshes)eu.pbrBuffer&&(eu.pbrBuffer.updateData(eu.featureArray),el=!0);return el}needsReEvaluation(en,el,eu){let ec=en.transform.projectionOptions,ed=en.style.getBrightness(),ef=this.brightness!==ed;return!!(!this.uploaded||this.dirty||ec.name!==this.projection.name||kx(eu.paint.get("model-color").value,ef)||kx(eu.paint.get("model-color-mix-intensity").value,ef)||kx(eu.paint.get("model-roughness").value,ef)||kx(eu.paint.get("model-emissive-strength").value,ef)||kx(eu.paint.get("model-height-based-emissive-strength-multiplier").value,ef))&&(this.projection=ec,this.brightness=ed,!0)}evaluateScale(en,el){if(en.transform.zoom===this.zoom)return;this.zoom=en.transform.zoom;let eu=this.getNodesInfo(),ec=this.id.canonical;for(let en of eu){let eu=en.feature;en.evaluatedScale=el.paint.get("model-scale").evaluate(eu,{},ec)}}evaluate(en){let el=this.getNodesInfo();for(let eu of el){if(!eu.node.meshes)continue;let el=eu.feature,ec=eu.node.meshes&&eu.node.meshes[0].featureData,ed=eu.evaluatedColor[2],ef=eu.evaluatedRMEA[2],em=this.id.canonical;if(eu.hasTranslucentParts=!1,ec){for(let ec=0;ec<nq.length;ec++){let ed=nq[ec];ed.length&&(el.properties.part=ed);let ef=en.paint.get("model-color").evaluate(el,{},em),e_=en.paint.get("model-color-mix-intensity").evaluate(el,{},em);eu.evaluatedColor[ec]=[ef.r,ef.g,ef.b,e_],eu.evaluatedRMEA[ec][0]=en.paint.get("model-roughness").evaluate(el,{},em),eu.evaluatedRMEA[ec][2]=en.paint.get("model-emissive-strength").evaluate(el,{},em),eu.evaluatedRMEA[ec][3]=ef.a,eu.emissionHeightBasedParams[ec]=en.paint.get("model-height-based-emissive-strength-multiplier").evaluate(el,{},em),!eu.hasTranslucentParts&&ef.a<1&&(eu.hasTranslucentParts=!0)}delete el.properties.part,function(en,el){let eu=en.node,ec=0;for(let ed of eu.meshes){if(eu.lights&&eu.lightMeshIndex===ec||!ed.featureData)continue;ed.featureArray=new xo,ed.featureArray.reserve(ed.featureData.length);let ef=el;for(let el of ed.featureData){let ec;let em=65535&el,e_=(15&em)<8?15&em:0,ew=el>>16&65535,eT=en.evaluatedRMEA[e_],eM=en.evaluatedColor[e_],eE=en.emissionHeightBasedParams[e_];if(ef&&2===e_&&eu.lights&&(ec=new xo).resize(10*eu.lights.length),function(en,el,eu,ec,ed,ef,em,e_){let ew,eT,eM,eE,eS=(61440&el|(61440&el)>>4)>>8,eA=(3840&el|(3840&el)>>4)>>4,eI=240&el|(240&el)>>4;eu[3]>0&&(eS=Mn(eS,255*eu[0],eu[3]),eA=Mn(eA,255*eu[1],eu[3]),eI=Mn(eI,255*eu[2],eu[3]));let eC=eS<<8|eA,eP=eI<<8|Math.floor(255*ec[3]),ez=function(en){let el=k(en,0,2);return Math.min(Math.round(.5*el*255),255)}(ec[2])<<8|15*ec[0]<<4|15*ec[1],eD=k(ed[0],0,1),eL=k(ed[1],0,1),ek=k(ed[2],0,1),eR=k(ed[3],0,1);if(eD!==eL&&em!==ef&&eL!==eD){let en=em-ef;eT=1/(en*(eL-eD)),eM=-(ef+en*eD)/(en*(eL-eD));let el=k(ed[4],-1,1);eE=Math.pow(10,el),ew=255*ek<<8|255*eR}else ew=65535,eT=0,eM=1,eE=1;if(en.emplaceBack(eC,eP,ez,ew,eT,eM,eE),e_){let en=e_.length;e_.clear();for(let el=0;el<en;el++)e_.emplaceBack(eC,eP,ez,ew,eT,eM,eE)}}(ed.featureArray,ew,eM,eT,eE,ed.aabb.min[2],ed.aabb.max[2],ec),ec&&ef){ef=!1;let en=eu.meshes[eu.lightMeshIndex];en.featureArray=ec,en.featureArray._trim()}}ed.featureArray._trim(),ec++}}(eu,ed!==eu.evaluatedColor[2]||ef!==eu.evaluatedRMEA[2])}else eu.evaluatedRMEA[0][2]=en.paint.get("model-emissive-strength").evaluate(el,{},em);eu.evaluatedScale=en.paint.get("model-scale").evaluate(el,{},em),this.updatePbrBuffer(eu.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(en,el,eu,ec){let ed=en.findDEMTileFor(eu);if(ed&&(ed.tileID.canonical!==this.terrainTile||el!==this.terrainExaggeration)){if(ed.dem&&ed.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=ed.tileID.overscaledZ;let el=Wd.create(en,eu,ed);if(!el)return;for(let ed of(this.modelTraits&nN.HasMapboxMeshFeatures&&this.updateDEM(en,el,eu,ec),this.getNodesInfo())){let en=ed.node;if(!en.footprint||!en.footprint.vertices||!en.footprint.vertices.length)continue;let eu=en.footprint.vertices,ec=el.getElevationAt(eu[0].x,eu[0].y,!0,!0);for(let en=1;en<eu.length;en++)ec=Math.min(ec,el.getElevationAt(eu[en].x,eu[en].y,!0,!0));en.elevation=ec}}this.terrainTile=ed.tileID.canonical,this.terrainExaggeration=el}}updateDEM(en,el,eu,ec){let ed=el._dem._modifiedForSources[ec];if(void 0===ed&&(el._dem._modifiedForSources[ec]=[],ed=el._dem._modifiedForSources[ec]),ed.includes(eu.canonical))return;let ef=el._dem.dim;ed.push(eu.canonical);let em=!1;for(let en of this.getNodesInfo()){let eu=en.node;if(!eu.footprint||!eu.footprint.grid)continue;let ec=eu.footprint.grid,ed=el.tileCoordToPixel(ec.min.x,ec.min.y),e_=el.tileCoordToPixel(ec.max.x,ec.max.y),ew=Math.min(Math.min(ef-e_.y,ed.x),Math.min(ed.y,ef-e_.x));if(ew<0)continue;let eT=k(ew,2,5),eM=Math.max(0,ed.x-eT),eE=Math.max(0,ed.y-eT),eS=Math.min(e_.x+eT,ef-1),eA=Math.min(e_.y+eT,ef-1);for(let en=eE;en<=eA;++en)for(let el=eM;el<=eS;++el)nG[en*ef+el]=255;let eI=0,eC=0;for(let en=0;en<ec.cellsY;++en)for(let eu=0;eu<ec.cellsX;++eu){if(!ec.cells[en*ec.cellsX+eu])continue;let ed=el.tileCoordToPixel(ec.min.x+eu/ec.xScale,ec.min.y+en/ec.yScale),em=el.tileCoordToPixel(ec.min.x+(eu+1)/ec.xScale,ec.min.y+(en+1)/ec.yScale);for(let en=ed.y;en<=Math.min(em.y+1,ef-1);++en)for(let eu=ed.x;eu<=Math.min(em.x+1,ef-1);++eu)255===nG[en*ef+eu]&&(nG[en*ef+eu]=0,eI+=el.getElevationAtPixel(eu,en),eC++)}let eP=eI/eC;eM=Math.max(1,ed.x-eT),eE=Math.max(1,ed.y-eT),eS=Math.min(e_.x+eT,ef-2),eA=Math.min(e_.y+eT,ef-2),em=!0;for(let en=eE;en<=eA;++en)for(let eu=eM;eu<=eS;++eu)0===nG[en*ef+eu]&&(nj[en*ef+eu]=el._dem.set(eu,en,eP));for(let en=1;en<eT;++en){eM=Math.max(1,ed.x-en),eE=Math.max(1,ed.y-en),eS=Math.min(e_.x+en,ef-2),eA=Math.min(e_.y+en,ef-2);for(let eu=eE;eu<=eA;++eu)for(let ec=eM;ec<=eS;++ec){let ed=eu*ef+ec;if(255===nG[ed]){let em=0,e_=0,ew=-1,eM=-1;for(let el=-1;el<=1;++el)for(let ed=-1;ed<=1;++ed){let eT=(eu+el)*ef+ec+ed;if(nG[eT]>=en)continue;let eE=nj[eT],eS=Math.abs(eE);eS>e_&&(em=eE,e_=eS,ew=ed,eM=el)}if(e_>.1){let ef=1-(en+.5*Math.abs(ew*eM))/eT,e_=el._dem.get(ec,eu)+em*ef,eE=el._dem.get(ec+ew,eu+eM),eS=el._dem.get(ec-ew,eu-eM,!0);(e_-eE)*(e_-eS)>0&&(e_=(eE+eS)/2),nj[ed]=el._dem.set(ec,eu,e_),nG[ed]=en}}}}}em&&(el._demTile.needsDEMTextureUpload=!0,el._dem._timestamp=ta.now())}getNodesInfo(){if(!this.nodesInfo){for(let en of(this.nodesInfo=[],this.nodes))this.nodesInfo.push(new Sx(en));this.freeNodes()}return this.nodesInfo}freeNodes(){if(this.nodes){for(let en of this.nodes)mx(en);this.nodes.splice(0,this.nodes.length)}}destroy(){this.freeNodes();let en=this.getNodesInfo();for(let el of en)dx(el.node),mx(el.node)}isEmpty(){return!this.nodes.length}updateReplacement(en,el){if(el.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=el.updateTime;let eu=el.getReplacementRegionsForTile(en.toUnwrapped()),ec=this.getNodesInfo();for(let en=0;en<this.nodesInfo.length;en++){let el=ec[en].node;ec[en].hiddenByReplacement=!!el.footprint&&!eu.find(en=>en.footprint===el.footprint)}}getHeightAtTileCoord(en,el){let eu=this.getNodesInfo(),ec=[];for(let ed=0;ed<this.nodesInfo.length;ed++){let ef=eu[ed],em=ef.node.meshes[0];if(en<em.aabb.min[0]||el<em.aabb.min[1]||en>em.aabb.max[0]||el>em.aabb.max[1])continue;let e_=(en-em.aabb.min[0])/(em.aabb.max[0]-em.aabb.min[0])*64|0,ew=64*Math.min(63,(el-em.aabb.min[1])/(em.aabb.max[1]-em.aabb.min[1])*64|0)+Math.min(63,e_);if(!(em.heightmap[ew]<0&&ef.node.footprint)){if(ef.hiddenByReplacement)return;return{height:em.heightmap[ew],maxHeight:ef.feature.properties.height,hidden:!1,verticalScale:ef.evaluatedScale[2]}}if(ef.node.footprint.grid.query(new eB(en,el),new eB(en,el),ec),ec.length>0)return{height:void 0,maxHeight:ef.feature.properties.height,hidden:ef.hiddenByReplacement,verticalScale:ef.evaluatedScale[2]}}}};function kx(en,el){return!en.isLightConstant&&el}function zx(en,el){return en.x-el.x||en.y-el.y}function Ex(en,el){return 0===zx(en.min,el.min)&&0===zx(en.max,el.max)}function Bx(en,el){return!(en.min.x>el.max.x||en.max.x<el.min.x||en.min.y>el.max.y||en.max.y<el.min.y)}function Dx(en,el,eu){let ec=1/(1<<eu.canonical.z),ed=(1220703125e-13*el.x+eu.canonical.x)*ec+eu.wrap,ef=(1220703125e-13*el.y+eu.canonical.y)*ec;return{min:new eB((1220703125e-13*en.x+eu.canonical.x)*ec+eu.wrap,(1220703125e-13*en.y+eu.canonical.y)*ec),max:new eB(ed,ef)}}function Rx(en,el,eu,ec,ed,ef,em){let e_=en.indices,ew=en.vertices,eT=[];for(let eM=ec;eM<ec+ed;eM+=3){let ec=el[eu[eM+0]+ef],ed=el[eu[eM+1]+ef],eE=el[eu[eM+2]+ef],eS=Math.min(ec.x,ed.x,eE.x),eA=Math.max(ec.x,ed.x,eE.x),eI=Math.min(ec.y,ed.y,eE.y),eC=Math.max(ec.y,ed.y,eE.y);eT.length=0,en.grid.query(new eB(eS,eI),new eB(eA,eC),eT);for(let en=0;en<eT.length;en++){let el=eT[en];if(Cp(ew[e_[3*el+0]],ew[e_[3*el+1]],ew[e_[3*el+2]],ec,ed,eE,em))return!0}}return!1}Ks(Ix,"Tiled3dModelBucket",{omit:["layers"]}),Ks(Sx,"Tiled3dModelFeature");let nZ=aV.types,n$=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius"],nW=["fill-extrusion-flood-light-ground-radius"],nH=new eB(0,1);function qx(en,el,eu,ec,ed,ef,em,e_){en.emplaceBack((el<<1)+em,(eu<<1)+ef,(Math.floor(8192*ec)<<1)+ed,Math.round(e_))}function Gx(en,el,eu,ec,ed,ef){en.emplaceBack(el.x,el.y,(eu.x<<1)+ec,(eu.y<<1)+ed,ef)}function Yx(en,el,eu){en.emplaceBack(el.x,el.y,el.z,16384*eu[0],16384*eu[1],16384*eu[2])}let Zx=class Zx{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}};let Xx=class Xx{constructor(){this.centroidXY=new eB(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new eB(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new eB(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new eB(this.max.x-this.min.x,this.max.y-this.min.y)}};let Kx=class Kx{constructor(){this.acc=new eB(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(en,el){en.min.x===Number.MAX_VALUE&&(en.min.x=en.max.x=el.x,en.min.y=en.max.y=el.y)}appendEdge(en,el,eu){this.accCount++,this.acc._add(el);let ec=!!this.borders;el.x<en.min.x?(en.min.x=el.x,ec=!0):el.x>en.max.x&&(en.max.x=el.x,ec=!0),el.y<en.min.y?(en.min.y=el.y,ec=!0):el.y>en.max.y&&(en.max.y=el.y,ec=!0),((0===el.x||8192===el.x)&&el.x===eu.x)!=((0===el.y||8192===el.y)&&el.y===eu.y)&&this.processBorderOverlap(el,eu),ec&&this.checkBorderIntersection(el,eu)}checkBorderIntersection(en,el){el.x<0!=en.x<0&&this.addBorderIntersection(0,Mn(el.y,en.y,(0-el.x)/(en.x-el.x))),el.x>8192!=en.x>8192&&this.addBorderIntersection(1,Mn(el.y,en.y,(8192-el.x)/(en.x-el.x))),el.y<0!=en.y<0&&this.addBorderIntersection(2,Mn(el.x,en.x,(0-el.y)/(en.y-el.y))),el.y>8192!=en.y>8192&&this.addBorderIntersection(3,Mn(el.x,en.x,(8192-el.y)/(en.y-el.y)))}addBorderIntersection(en,el){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);let eu=this.borders[en];el<eu[0]&&(eu[0]=el),el>eu[1]&&(eu[1]=el)}processBorderOverlap(en,el){if(en.x===el.x){if(en.y===el.y)return;let eu=0===en.x?0:1;this.addBorderIntersection(eu,el.y),this.addBorderIntersection(eu,en.y)}else{let eu=0===en.y?2:3;this.addBorderIntersection(eu,el.x),this.addBorderIntersection(eu,en.x)}}centroid(){return 0===this.accCount?new eB(0,0):new eB(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((en,el)=>en+ +(el[0]!==Number.MAX_VALUE),0):0}};function Wx(en,el){let eu=en.add(el)._unit(),ec=k(en.x*eu.x+en.y*eu.y,-1,1);return Math.min(4,Math.max(-4,Math.tan(Math.acos(ec))))/4*32767*(en.x*el.y-en.y*el.x<0?-1:1)}let nX=[en=>en.x<0,en=>en.x>8192,en=>en.y<0,en=>en.y>8192];let Qx=class Qx{constructor(en){this.vertexArray=new Ya,this.indexArray=new ao,this.programConfigurations=new fl(en.layers,en.zoom,en=>nW.includes(en)),this._segments=new Do,this.hiddenByLandmarkVertexArray=new vo,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new Do}getDefaultSegment(){return this.regionSegments[4]}hasData(){return 0!==this.vertexArray.length}addData(en,el,eu,ec=!1){let ed=en.length;if(ed>2){let ef,em=Math.max(0,this._segments.get().length-1),e_=this._segments._prepareSegment(4*ed,this.vertexArray.length,2*this._segmentToGroundQuads[em].length);em!==this._segments.get().length-1&&(em++,this._segmentToGroundQuads[em]=[],this._segmentToRegionTriCounts[em]=[0,0,0,0,0]);{let el=en[0],eu=en[1];ef=Wx(el.sub(en[ed-1])._perp()._unit(),eu.sub(el)._perp()._unit())}for(let ew=0;ew<ed;ew++){let eT=ew===ed-1?0:ew+1,eM=en[ew],eE=en[eT],eS=en[eT===ed-1?0:eT+1],eA=eE.sub(eM)._perp()._unit(),eI=Wx(eA,eS.sub(eE)._perp()._unit()),eC=ef;if(iv(eM,eE,el)||ec&&sv(eM,el)&&sv(eE,el)){ef=eI;continue}let eP=e_.vertexLength;Gx(this.vertexArray,eM,eE,1,1,eC),Gx(this.vertexArray,eM,eE,1,0,eC),Gx(this.vertexArray,eM,eE,0,1,eI),Gx(this.vertexArray,eM,eE,0,0,eI),e_.vertexLength+=4;let ez=function(en,el,eu,ec){let ed=[4];if(0===ec)return ed;eu._mult(ec);let ef=en.sub(eu),em=el.sub(eu),e_=[en,el,ef,em];for(let en=0;en<4;en++)for(let el of e_)if(nX[en](el)){ed.push(en);break}return ed}(eM,eE,eA,eu);for(let en of ez)this._segmentToGroundQuads[em].push({id:eP,region:en}),this._segmentToRegionTriCounts[em][en]+=2,e_.primitiveLength+=2;ef=eI}}}prepareBorderSegments(){if(!this.hasData())return;let en=this._segments.get(),el=en.length;for(let en=0;en<el;en++)this._segmentToGroundQuads[en].sort((en,el)=>en.region-el.region);for(let eu=0;eu<el;eu++){let el=this._segmentToGroundQuads[eu],ec=en[eu],ed=this._segmentToRegionTriCounts[eu];ed.reduce((en,el)=>en+el,0);let ef=0;for(let en=0;en<=4;en++){let el=ed[en];if(0!==el){let eu=this.regionSegments[en];eu||(eu=this.regionSegments[en]=new Do);let ed={vertexOffset:ec.vertexOffset,primitiveOffset:ec.primitiveOffset+ef,vertexLength:ec.vertexLength,primitiveLength:el};eu.get().push(ed)}ef+=el}for(let en=0;en<el.length;en++){let eu=el[en].id;this.indexArray.emplaceBack(eu,eu+1,eu+3),this.indexArray.emplaceBack(eu,eu+3,eu+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(en,el,eu,ec,ed,ef){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,en,el,eu,ec,ed,ef)}upload(en){this.hasData()&&(this.vertexBuffer=en.createVertexBuffer(this.vertexArray,ak.members),this.indexBuffer=en.createIndexBuffer(this.indexArray))}uploadPaintProperties(en){this.hasData()&&this.programConfigurations.upload(en)}update(en,el,eu,ec,ed,ef){this.hasData()&&this.programConfigurations.updatePaintArrays(en,el,eu,ec,ed,ef)}updateHiddenByLandmark(en){if(!this.hasData())return;let el=en.groundVertexCount+en.groundVertexArrayOffset;if(0===en.groundVertexCount)return;let eu=2147483648&en.flags?1:0;for(let ec=en.groundVertexArrayOffset;ec<el;++ec)this.hiddenByLandmarkVertexArray.emplace(ec,eu);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(en){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=en.createVertexBuffer(this.hiddenByLandmarkVertexArray,aO.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let en=0;en<=4;en++){let el=this.regionSegments[en];el&&el.destroy()}}}};let tv=class tv{constructor(en){this.zoom=en.zoom,this.canonical=en.canonical,this.overscaling=en.overscaling,this.layers=en.layers,this.layerIds=this.layers.map(en=>en.fqid),this.index=en.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=en.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new ao,this.footprintVertices=new $a,this.footprintSegments=[],this.layoutVertexArray=new Ga,this.centroidVertexArray=new zo,this.indexArray=new ao,this.programConfigurations=new fl(en.layers,en.zoom,en=>n$.includes(en)),this.segments=new Do,this.stateDependentLayerIds=this.layers.filter(en=>en.isStateDependent()).map(en=>en.id),this.groundEffect=new Qx(en),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[]}populate(en,el,eu,ec){for(let{feature:ed,id:ef,index:em,sourceLayerIndex:e_}of(this.features=[],this.hasPattern=Ff("fill-extrusion",this.layers,el),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.tileToMeter=op(eu),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,en)){let en=this.layers[0]._featureFilter.needGeometry,ew=gp(ed,en);if(!this.layers[0]._featureFilter.filter(new _a(this.zoom),ew,eu))continue;let eT={id:ef,sourceLayerIndex:e_,index:em,geometry:en?ew.geometry:yp(ed,eu,ec),properties:ed.properties,type:ed.type,patterns:{}},eM=this.layoutVertexArray.length;this.hasPattern?this.features.push(jf("fill-extrusion",this.layers,eT,this.zoom,el)):this.addFeature(eT,eT.geometry,em,eu,{},el.availableImages,ec,el.brightness),el.featureIndex.insert(ed,eT.geometry,em,e_,this.index,eM)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(en,el,eu,ec,ed,ef){for(let en of this.features){let{geometry:em}=en;this.addFeature(en,em,en.index,el,eu,ec,ed,ef)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles()}update(en,el,eu,ec,ed){let ef=0!==Object.keys(en).length;if(ef&&!this.stateDependentLayers.length)return;let em=ef?this.stateDependentLayers:this.layers;this.programConfigurations.updatePaintArrays(en,el,em,eu,ec,ed),this.groundEffect.update(en,el,em,eu,ec,ed)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(en){this.uploaded||(this.layoutVertexBuffer=en.createVertexBuffer(this.layoutVertexArray,aF),this.indexBuffer=en.createIndexBuffer(this.indexArray),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=en.createVertexBuffer(this.layoutVertexExtArray,aB.members,!0)),this.groundEffect.upload(en)),this.groundEffect.uploadPaintProperties(en),this.programConfigurations.upload(en),this.uploaded=!0}uploadCentroid(en){this.groundEffect.uploadHiddenByLandmark(en),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=en.createVertexBuffer(this.centroidVertexArray,aR.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(en,el,eu,ec,ed,ef,em,e_){var ew;let eT;let eM=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(en,{})/this.tileToMeter,eE=[new eB(0,0),new eB(8192,8192)],eS=em.projection,eA="globe"===eS.name,eI="Polygon"===nZ[en.type],eC=new Kx;eC.centroidDataIndex=this.centroidData.length;let eP=new Xx,ez=0>=this.layers[0].paint.get("fill-extrusion-base").evaluate(en,{},ec),eD=this.layers[0].paint.get("fill-extrusion-height").evaluate(en,{},ec);eP.height=eD,eP.vertexArrayOffset=this.layoutVertexArray.length,eP.groundVertexArrayOffset=this.groundEffect.vertexArray.length,eA&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Ha);let eL=Vf(el,500);for(let en=eL.length-1;en>=0;en--){let el=eL[en];(0===el.length||(ew=el[0]).every(en=>en.x<=0)||ew.every(en=>en.x>=8192)||ew.every(en=>en.y<=0)||ew.every(en=>en.y>=8192))&&eL.splice(en,1)}if(eA)eT=uv(eL,eE,ec);else for(let en of(eT=[],eL))eT.push({polygon:en,bounds:eE});let ek=eI?this.edgeRadius:0,eR=ek>0&&this.zoom<17,M=(en,el)=>{if(0===en.length)return!1;let eu=en[en.length-1];return el.x===eu.x&&el.y===eu.y};for(let{polygon:en,bounds:el}of eT){let eu=0,ed=0;for(let el of en)eI&&!el[0].equals(el[el.length-1])&&el.push(el[0]),ed+=eI?el.length-1:el.length;let ef=this.segments.prepareSegment((eI?5:4)*ed,this.layoutVertexArray,this.indexArray);eP.footprintSegIdx<0&&(eP.footprintSegIdx=this.footprintSegments.length),eP.polygonSegIdx<0&&(eP.polygonSegIdx=this.polygonSegments.length);let em={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},e_=new Zx;if(e_.vertexOffset=this.footprintVertices.length,e_.indexOffset=3*this.footprintIndices.length,e_.ringIndices=[],eI){let ed=[],em=[];eu=ef.vertexLength;for(let eu=0;eu<en.length;eu++){let ew,eT;let eE=en[eu];eE.length&&0!==eu&&em.push(ed.length/2);let eI=[];ew=eE[1].sub(eE[0])._perp()._unit(),e_.ringIndices.push(eE.length-1);for(let en=1;en<eE.length;en++){let el=eE[en],eu=eE[en===eE.length-1?1:en+1],em=el.clone();if(ek){eT=eu.sub(el)._perp()._unit();let en=ew.add(eT)._unit(),ec=ek*Math.min(4,1/(ew.x*en.x+ew.y*en.y));em.x+=ec*en.x,em.y+=ec*en.y,em.x=Math.round(em.x),em.y=Math.round(em.y),ew=eT}!ez||0!==ek&&!eR||M(eI,em)||eI.push(em),qx(this.layoutVertexArray,em.x,em.y,0,0,1,1,0),ef.vertexLength++,this.footprintVertices.emplaceBack(el.x,el.y),ed.push(el.x,el.y),eA&&Yx(this.layoutVertexExtArray,eS.projectTilePoint(em.x,em.y,ec),eS.upVector(ec,em.x,em.y))}ez&&(0===ek||eR)&&(0!==eI.length&&M(eI,eI[0])&&eI.pop(),this.groundEffect.addData(eI,el,eM))}let ew=aP(ed,em);for(let en=0;en<ew.length;en+=3)this.footprintIndices.emplaceBack(e_.vertexOffset+ew[en+0],e_.vertexOffset+ew[en+1],e_.vertexOffset+ew[en+2]),this.indexArray.emplaceBack(eu+ew[en],eu+ew[en+2],eu+ew[en+1]),ef.primitiveLength++;e_.indexCount+=ew.length,e_.vertexCount+=this.footprintVertices.length-e_.vertexOffset}for(let ed=0;ed<en.length;ed++){let em,e_,ew;let eT=en[ed];eC.startRing(eP,eT[0]);let eE=eT.length>4&&av(eT[eT.length-2],eT[0],eT[1]),eD=ek?function(en,el,eu,ec){let ed=el.sub(en)._perp()._unit(),ef=eu.sub(el)._perp()._unit();return nv(en,el,eu,ev(ed,ef),ec)}(eT[eT.length-2],eT[0],eT[1],ek):0,eL=[];e_=eT[1].sub(eT[0])._perp()._unit();let eR=!0;for(let en=1,ed=0;en<eT.length;en++){let eM=eT[en-1],eI=eT[en],eO=eT[en===eT.length-1?1:en+1];if(eC.appendEdge(eP,eI,eM),iv(eI,eM,el)){ek&&(e_=eO.sub(eI)._perp()._unit(),eR=!eR);continue}let eB=eI.sub(eM)._perp(),eF=eB.x/(Math.abs(eB.x)+Math.abs(eB.y)),eN=eB.y>0?1:0,eU=eM.dist(eI);if(ed+eU>32768&&(ed=0),ek){ew=eO.sub(eI)._perp()._unit();let en=nv(eM,eI,eO,ev(e_,ew),ek);isNaN(en)&&(en=0);let el=eI.sub(eM)._unit();eM=eM.add(el.mult(eD))._round(),eI=eI.add(el.mult(-en))._round(),eD=en,e_=ew,ez&&this.zoom>=17&&(M(eL,eM)||eL.push(eM),M(eL,eI)||eL.push(eI))}let eV=ef.vertexLength,ej=eT.length>4&&av(eM,eI,eO),eG=ov(ed,eE,eR);if(qx(this.layoutVertexArray,eM.x,eM.y,eF,eN,0,0,eG),qx(this.layoutVertexArray,eM.x,eM.y,eF,eN,0,1,eG),ed+=eU,eG=ov(ed,ej,!eR),eE=ej,qx(this.layoutVertexArray,eI.x,eI.y,eF,eN,0,0,eG),qx(this.layoutVertexArray,eI.x,eI.y,eF,eN,0,1,eG),ef.vertexLength+=4,this.indexArray.emplaceBack(eV+0,eV+1,eV+2),this.indexArray.emplaceBack(eV+1,eV+3,eV+2),ef.primitiveLength+=2,ek){let ec=eu+(1===en?eT.length-2:en-2),ed=1===en?eu:ec+1;if(this.indexArray.emplaceBack(eV+1,ec,eV+3),this.indexArray.emplaceBack(ec,ed,eV+3),ef.primitiveLength+=2,void 0===em&&(em=eV),!iv(eO,eT[en],el)){let el=en===eT.length-1?em:ef.vertexLength;this.indexArray.emplaceBack(eV+2,eV+3,el),this.indexArray.emplaceBack(eV+3,el+1,el),this.indexArray.emplaceBack(eV+3,ed,el+1),ef.primitiveLength+=3}eR=!eR}if(eA){let en=this.layoutVertexExtArray,el=eS.projectTilePoint(eM.x,eM.y,ec),eu=eS.projectTilePoint(eI.x,eI.y,ec),ed=eS.upVector(ec,eM.x,eM.y),ef=eS.upVector(ec,eI.x,eI.y);Yx(en,el,ed),Yx(en,el,ed),Yx(en,eu,ef),Yx(en,eu,ef)}}eI&&(eu+=eT.length-1),ez&&ek&&this.zoom>=17&&(0!==eL.length&&M(eL,eL[0])&&eL.pop(),this.groundEffect.addData(eL,el,eM,ek>0))}this.footprintSegments.push(e_),em.triangleCount=this.indexArray.length-em.triangleArrayOffset,this.polygonSegments.push(em),++eP.footprintSegLen,++eP.polygonSegLen}if(eP.vertexCount=this.layoutVertexArray.length-eP.vertexArrayOffset,eP.groundVertexCount=this.groundEffect.vertexArray.length-eP.groundVertexArrayOffset,0!==eP.vertexCount){if(eP.centroidXY=eC.borders?nH:this.encodeCentroid(eC,eP),this.centroidData.push(eP),eC.borders){this.featuresOnBorder.push(eC);let en=this.featuresOnBorder.length-1;for(let el=0;el<eC.borders.length;el++)eC.borders[el][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[el].push(en)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,en,eu,ed,ef,ec,e_),this.groundEffect.addPaintPropertiesData(en,eu,ed,ef,ec,e_),this.maxHeight=Math.max(this.maxHeight,eD)}}sortBorders(){for(let en=0;en<this.borderFeatureIndices.length;en++)this.borderFeatureIndices[en].sort((el,eu)=>this.featuresOnBorder[el].borders[en][0]-this.featuresOnBorder[eu].borders[en][0])}splitToSubtiles(){let en=[];for(let el=0;el<this.centroidData.length;el++){let eu=this.centroidData[el],ec=+(eu.min.y+eu.max.y>8192),ed=2*ec+(+(eu.min.x+eu.max.x>8192)^ec);for(let ec=0;ec<eu.polygonSegLen;ec++){let ef=eu.polygonSegIdx+ec;en.push({centroidIdx:el,subtile:ed,polygonSegmentIdx:ef,triangleSegmentIdx:this.polygonSegments[ef].triangleSegIdx})}}let el=new ao;en.sort((en,el)=>en.triangleSegmentIdx===el.triangleSegmentIdx?en.subtile-el.subtile:en.triangleSegmentIdx-el.triangleSegmentIdx);let eu=0,ec=0,ed=0;for(let el of en){if(el.triangleSegmentIdx!==eu)break;ed++}let ef=en.length;for(;ec!==en.length;){eu=en[ec].triangleSegmentIdx;let em=0,e_=ec,ew=ec;for(let el=e_;el<ed&&en[el].subtile===em;el++)ew++;for(;e_!==ed;){let ec=en[e_];em=ec.subtile;let ef=this.centroidData[ec.centroidIdx].min.clone(),eT=this.centroidData[ec.centroidIdx].max.clone(),eM={vertexOffset:this.segments.segments[eu].vertexOffset,primitiveOffset:el.length,vertexLength:this.segments.segments[eu].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let eu=e_;eu<ew;eu++){let ec=en[eu],ed=this.polygonSegments[ec.polygonSegmentIdx],em=this.centroidData[ec.centroidIdx].min,e_=this.centroidData[ec.centroidIdx].max,ew=this.indexArray.uint16;for(let en=ed.triangleArrayOffset;en<ed.triangleArrayOffset+ed.triangleCount;en++)el.emplaceBack(ew[3*en],ew[3*en+1],ew[3*en+2]);eM.primitiveLength+=ed.triangleCount,ef.x=Math.min(ef.x,em.x),ef.y=Math.min(ef.y,em.y),eT.x=Math.max(eT.x,e_.x),eT.y=Math.max(eT.y,e_.y)}eM.primitiveLength>0&&this.triangleSubSegments.push({segment:eM,min:ef,max:eT}),e_=ew;for(let el=e_;el<ed&&en[el].subtile===en[e_].subtile;el++)ew++}ec=ed;for(let el=ec;el<ef&&en[el].triangleSegmentIdx===en[ec].triangleSegmentIdx;el++)ed++}el._trim(),this.indexArray=el}getVisibleSegments(en,el,eu){let ec,ed=0,ef=0,em=1<<en.canonical.z;if(el){let eu=el.getMinMaxForTile(en);eu&&(ed=eu.min,ef=eu.max)}ef+=this.maxHeight;let e_=en.toUnwrapped(),ew=[e_.canonical.x/em+e_.wrap,e_.canonical.y/em],eT=[(e_.canonical.x+1)/em+e_.wrap,(e_.canonical.y+1)/em],eM=new Do,h=(en,el,eu)=>[en[0]*(1-eu[0])+el[0]*eu[0],en[1]*(1-eu[1])+el[1]*eu[1]],eE=[],eS=[];for(let en of this.triangleSubSegments){eE[0]=en.min.x/8192,eE[1]=en.min.y/8192,eS[0]=en.max.x/8192,eS[1]=en.max.y/8192;let el=h(ew,eT,eE),em=h(ew,eT,eS);if(0===new oh([el[0],el[1],ed],[em[0],em[1],ef]).intersectsPrecise(eu)){ec&&(eM.segments.push(ec),ec=void 0);continue}let e_=en.segment;ec&&ec.vertexOffset!==e_.vertexOffset&&(eM.segments.push(ec),ec=void 0),ec?(ec.vertexLength+=e_.vertexLength,ec.primitiveLength+=e_.primitiveLength):ec={vertexOffset:e_.vertexOffset,primitiveLength:e_.primitiveLength,vertexLength:e_.vertexLength,primitiveOffset:e_.primitiveOffset,sortKey:void 0,vaos:{}}}return ec&&eM.segments.push(ec),eM}encodeCentroid(en,el){let eu=en.centroid(),ec=el.span(),ed=Math.min(7,Math.round(ec.x*this.tileToMeter/10)),ef=Math.min(7,Math.round(ec.y*this.tileToMeter/10));return new eB(k(eu.x,1,8191)<<3|ed,k(eu.y,1,8191)<<3|ef)}encodeBorderCentroid(en){if(!en.borders)return new eB(0,0);let el=en.borders,eu=Number.MAX_VALUE;if(el[0][0]!==eu||el[1][0]!==eu){let en=el[0][0]!==eu?0:1;return new eB(6|(el[0][0]!==eu?0:65528),((el[en][0]+el[en][1])/2|0)<<3|6)}{let en=el[2][0]!==eu?2:3;return new eB(((el[en][0]+el[en][1])/2|0)<<3|6,6|(el[2][0]!==eu?0:65528))}}showCentroid(en){let el=this.centroidData[en.centroidDataIndex];el.flags&=2147483648,el.centroidXY.x=0,el.centroidXY.y=0,this.writeCentroidToBuffer(el)}writeCentroidToBuffer(en){this.groundEffect.updateHiddenByLandmark(en);let el=en.vertexArrayOffset,eu=en.vertexCount+en.vertexArrayOffset,ec=2147483648&en.flags?nH:en.centroidXY,ed=this.centroidVertexArray.geta_centroid_pos0(el);if(this.centroidVertexArray.geta_centroid_pos1(el)!==ec.y||ed!==ec.x){for(let en=el;en<eu;++en)this.centroidVertexArray.emplace(en,ec.x,ec.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){for(let en of(this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length),this.centroidData))this.writeCentroidToBuffer(en)}updateReplacement(en,el){if(el.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=el.updateTime;let eu=el.getReplacementRegionsForTile(en.toUnwrapped());if(function(en,el){if(en.length!==el.length)return!1;for(let eu=0;eu<en.length;eu++)if(en[eu].sourceId!==el[eu].sourceId||!Ex(en[eu],el[eu]))return!1;return!0}(this.activeReplacements,eu))return;if(this.activeReplacements=eu,0===this.centroidVertexArray.length)this.createCentroidsBuffer();else for(let en of this.centroidData)en.flags&=2147483647;let ec=[];for(let el of this.activeReplacements){let eu=Math.pow(2,el.footprintTileId.canonical.z-en.canonical.z);for(let ed of this.centroidData)if(!(2147483648&ed.flags||el.min.x>ed.max.x||ed.min.x>el.max.x||el.min.y>ed.max.y||ed.min.y>el.max.y))for(let ef=0;ef<ed.footprintSegLen;ef++){let em=this.footprintSegments[ed.footprintSegIdx+ef];if(ec.length=0,function(en,el,eu,ec,ed,ef){let em=Math.pow(2,ec.z-ed.z);for(let e_=0;e_<eu;e_++){let eu=en.int16[2*(e_+el)+0],ew=en.int16[2*(e_+el)+1];eu=(eu+8192*ed.x)*em-8192*ec.x,ew=(ew+8192*ed.y)*em-8192*ec.y,ef.push(new eB(eu,ew))}}(this.footprintVertices,em.vertexOffset,em.vertexCount,el.footprintTileId.canonical,en.canonical,ec),Rx(el.footprint,ec,this.footprintIndices.uint16,em.indexOffset,em.indexCount,-em.vertexOffset,-eu)){ed.flags|=2147483648;break}}}for(let en of this.centroidData)this.writeCentroidToBuffer(en);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(en,el,eu){let ec=!1;for(let ed=0;ed<eu.footprintSegLen;ed++){let ef=this.footprintSegments[eu.footprintSegIdx+ed],em=0;for(let eu of ef.ringIndices){for(let ed=em,e_=eu+em-1;ed<eu+em;e_=ed++){let eu=this.footprintVertices.int16[2*(ed+ef.vertexOffset)+0],em=this.footprintVertices.int16[2*(ed+ef.vertexOffset)+1],ew=this.footprintVertices.int16[2*(e_+ef.vertexOffset)+1];em>el!=ew>el&&en<(this.footprintVertices.int16[2*(e_+ef.vertexOffset)+0]-eu)*(el-em)/(ew-em)+eu&&(ec=!ec)}em=eu}}return ec}getHeightAtTileCoord(en,el){let eu=Number.NEGATIVE_INFINITY,ec=!0,ed=4*(en+8192)*8192+(el+8192);if(this.partLookup.hasOwnProperty(ed)){let en=this.partLookup[ed];return en?{height:en.height,hidden:!!(2147483648&en.flags)}:void 0}for(let ef of this.centroidData)en>ef.max.x||ef.min.x>en||el>ef.max.y||ef.min.y>el||this.footprintContainsPoint(en,el,ef)&&ef&&ef.height>eu&&(eu=ef.height,this.partLookup[ed]=ef,ec=!!(2147483648&ef.flags));if(eu!==Number.NEGATIVE_INFINITY)return{height:eu,hidden:ec};this.partLookup[ed]=void 0}};function ev(en,el){let eu=en.add(el)._unit();return en.x*eu.x+en.y*eu.y}function nv(en,el,eu,ec,ed){let ef=Math.sqrt(1-ec*ec);return Math.min(en.dist(el)/3,el.dist(eu)/3,ed*ef/ec)}function iv(en,el,eu){return en.x<eu[0].x&&el.x<eu[0].x||en.x>eu[1].x&&el.x>eu[1].x||en.y<eu[0].y&&el.y<eu[0].y||en.y>eu[1].y&&el.y>eu[1].y}function sv(en,el){return en.x<el[0].x||en.x>el[1].x||en.y<el[0].y||en.y>el[1].y}function av(en,el,eu){if(en.x<0||en.x>=8192||el.x<0||el.x>=8192||eu.x<0||eu.x>=8192)return!1;let ec=eu.sub(el),ed=ec.perp(),ef=en.sub(el);return(ec.x*ef.x+ec.y*ef.y)/Math.sqrt((ec.x*ec.x+ec.y*ec.y)*(ef.x*ef.x+ef.y*ef.y))>-.866&&ed.x*ef.x+ed.y*ef.y<0}function ov(en,el,eu){let ec=el?2|en:-3&en;return eu?1|ec:-2&ec}function lv(){let en=Math.PI/32,el=Math.tan(en);return r8*Math.sqrt(1+2*el*el)-r8}function uv(en,el,eu){let ec=1<<eu.z,ed=tp(eu.x/ec),ef=tp((eu.x+1)/ec),em=ep(eu.y/ec),e_=ep((eu.y+1)/ec);return function(en,el,eu,ec,ed=0,ef){let em=[];if(!en.length||!eu||!ec)return em;let o=(en,el)=>{for(let eu of en)em.push({polygon:eu,bounds:el})},e_=Math.ceil(Math.log2(eu)),ew=Math.ceil(Math.log2(ec)),eT=e_-ew,eM=[];for(let en=0;en<Math.abs(eT);en++)eM.push(eT>0?0:1);for(let en=0;en<Math.min(e_,ew);en++)eM.push(0),eM.push(1);let eE=en;if(eE=cd(eE,el[0].y-ed,el[1].y+ed,1),!(eE=cd(eE,el[0].x-ed,el[1].x+ed,0)).length)return em;let eS=[];for(eM.length?eS.push({polygons:eE,bounds:el,depth:0}):o(eE,el);eS.length;){let en=eS.pop(),el=en.depth,eu=eM[el],ec=en.bounds[0],em=en.bounds[1],e_=0===eu?ec.x:ec.y,ew=0===eu?em.x:em.y,eT=ef?ef(eu,e_,ew):.5*(e_+ew),eE=cd(en.polygons,e_-ed,eT+ed,eu),eA=cd(en.polygons,eT-ed,ew+ed,eu);if(eE.length){let en=[ec,new eB(0===eu?eT:em.x,1===eu?eT:em.y)];eM.length>el+1?eS.push({polygons:eE,bounds:en,depth:el+1}):o(eE,en)}if(eA.length){let en=[new eB(0===eu?eT:ec.x,1===eu?eT:ec.y),em];eM.length>el+1?eS.push({polygons:eA,bounds:en,depth:el+1}):o(eA,en)}}return em}(en,el,Math.ceil((ef-ed)/11.25),Math.ceil((em-e_)/11.25),1,(en,el,ed)=>{if(0===en)return .5*(el+ed);{let en=ep((eu.y+el/8192)/ec);return(Jh(.5*(ep((eu.y+ed/8192)/ec)+en))*ec-eu.y)*8192}})}Ks(tv,"FillExtrusionBucket",{omit:["layers","features"]}),Ks(Xx,"PartData"),Ks(Zx,"FootprintSegment"),Ks(Kx,"BorderCentroidData"),Ks(Qx,"GroundEffect");let nK=new Da({visibility:new za(tc["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new za(tc["layout_fill-extrusion"]["fill-extrusion-edge-radius"])});var nJ={paint:new Da({"fill-extrusion-opacity":new za(tc["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Ea(tc["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new za(tc["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new za(tc["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Ea(tc["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new Ea(tc["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Ea(tc["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new za(tc["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new za(tc["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new za(tc["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new za(tc["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new za(tc["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new za(tc["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new za(tc["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new za(tc["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new Ea(tc["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new Ea(tc["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new za(tc["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new za(tc["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new za(tc["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new za(tc["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new za(tc["paint_fill-extrusion"]["fill-extrusion-emissive-strength"])}),layout:nK};let fv=class fv extends eB{constructor(en,el,eu){super(en,el),this.z=eu}};function dv(en,el){return en.x*el.x+en.y*el.y}function mv(en,el){if(1===en.length){let eu,ec=0,ed=el[ec++];for(;!eu||ed.equals(eu);)if(!(eu=el[ec++]))return 1/0;for(;ec<el.length;ec++){let ef=el[ec],em=en[0],e_=eu.sub(ed),ew=ef.sub(ed),eT=em.sub(ed),eM=dv(e_,e_),eE=dv(e_,ew),eS=dv(ew,ew),eA=dv(eT,e_),eI=dv(eT,ew),eC=eM*eS-eE*eE,eP=(eS*eA-eE*eI)/eC,ez=(eM*eI-eE*eA)/eC,eD=ed.z*(1-eP-ez)+eu.z*eP+ef.z*ez;if(isFinite(eD))return eD}return 1/0}{let en=1/0;for(let eu of el)en=Math.min(en,eu.z);return en}}function yv(en,el,eu,ec,ed,ef,em,e_){let ew=em*ed.getElevationAt(en,el,!0,!0),eT=0!==ef[0],eM=eT?0===ef[1]?em*(ef[0]/7-450):em*function(en,el,eu){var ec,ed;let ef=Math.floor(el[0]/8),em=Math.floor(el[1]/8),e_=10*(el[0]-8*ef),ew=10*(el[1]-8*em),eT=en.getElevationAt(ef,em,!0,!0),eM=en.getMeterToDEM(eu),eE=Math.floor(.5*(e_*eM-1)),eS=Math.floor(.5*(ew*eM-1)),eA=en.tileCoordToPixel(ef,em),eI=2*eE+1,eC=2*eS+1,eP=(ec=eA.x-eE,ed=eA.y-eS,[en.getElevationAtPixel(ec,ed,!0),en.getElevationAtPixel(ec+eC,ed,!0),en.getElevationAtPixel(ec,ed+eC,!0),en.getElevationAtPixel(ec+eI,ed+eC,!0)]),ez=Math.abs(eP[0]-eP[1]),eD=Math.abs(eP[2]-eP[3]),eL=Math.abs(eP[0]-eP[2])+Math.abs(eP[1]-eP[3]),ek=Math.min(.25,.5*eM*(ez+eD)/eI),eR=Math.min(.25,.5*eM*eL/eC);return eT+Math.max(ek*e_,eR*ew)}(ed,ef,e_):ew;return{base:ew+(0===eu)?-1:eu,top:eT?Math.max(eM+ec,ew+eu+2):ew+ec}}let nY=new Da({"line-cap":new Ea(tc.layout_line["line-cap"]),"line-join":new Ea(tc.layout_line["line-join"]),"line-miter-limit":new za(tc.layout_line["line-miter-limit"]),"line-round-limit":new za(tc.layout_line["line-round-limit"]),"line-sort-key":new Ea(tc.layout_line["line-sort-key"]),visibility:new za(tc.layout_line.visibility)});var nQ={paint:new Da({"line-opacity":new Ea(tc.paint_line["line-opacity"]),"line-color":new Ea(tc.paint_line["line-color"]),"line-translate":new za(tc.paint_line["line-translate"]),"line-translate-anchor":new za(tc.paint_line["line-translate-anchor"]),"line-width":new Ea(tc.paint_line["line-width"]),"line-gap-width":new Ea(tc.paint_line["line-gap-width"]),"line-offset":new Ea(tc.paint_line["line-offset"]),"line-blur":new Ea(tc.paint_line["line-blur"]),"line-dasharray":new Ea(tc.paint_line["line-dasharray"]),"line-pattern":new Ea(tc.paint_line["line-pattern"]),"line-gradient":new Ba(tc.paint_line["line-gradient"]),"line-trim-offset":new za(tc.paint_line["line-trim-offset"]),"line-emissive-strength":new za(tc.paint_line["line-emissive-strength"]),"line-border-width":new Ea(tc.paint_line["line-border-width"]),"line-border-color":new Ea(tc.paint_line["line-border-color"])}),layout:nY};function vv(en,el){return 1/sx(en,1,el.tileZoom)}function bv(en,el,eu,ec){return en.translatePosMatrix(ec||el.tileID.projMatrix,el,eu.paint.get("line-translate"),eu.paint.get("line-translate-anchor"))}let _v=en=>{let el=[];wv(en)&&el.push("RENDER_LINE_DASH"),en.paint.get("line-gradient")&&el.push("RENDER_LINE_GRADIENT");let eu=en.paint.get("line-trim-offset");return 0===eu[0]&&0===eu[1]||el.push("RENDER_LINE_TRIM_OFFSET"),0!==en.paint.get("line-border-width").constantOr(1)&&el.push("RENDER_LINE_BORDER"),el};function wv(en){let el=en.paint.get("line-dasharray").value;return el.value||"constant"!==el.kind}let n0=new class extends Ea{possiblyEvaluate(en,el){return el=new _a(Math.floor(el.zoom),{now:el.now,fadeDuration:el.fadeDuration,transition:el.transition}),super.possiblyEvaluate(en,el)}evaluate(en,el,eu,ec){return el=B({},el,{zoom:Math.floor(el.zoom)}),super.evaluate(en,el,eu,ec)}}(nQ.paint.properties["line-width"].specification);n0.useIntegerZoom=!0;let n1=new Da({visibility:new za(tc.layout_background.visibility)});var n2={paint:new Da({"background-color":new za(tc.paint_background["background-color"]),"background-pattern":new za(tc.paint_background["background-pattern"]),"background-opacity":new za(tc.paint_background["background-opacity"]),"background-emissive-strength":new za(tc.paint_background["background-emissive-strength"])}),layout:n1};let n3=new Da({visibility:new za(tc.layout_raster.visibility)});var n4={paint:new Da({"raster-opacity":new za(tc.paint_raster["raster-opacity"]),"raster-color":new Ba(tc.paint_raster["raster-color"]),"raster-color-mix":new za(tc.paint_raster["raster-color-mix"]),"raster-color-range":new za(tc.paint_raster["raster-color-range"]),"raster-hue-rotate":new za(tc.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new za(tc.paint_raster["raster-brightness-min"]),"raster-brightness-max":new za(tc.paint_raster["raster-brightness-max"]),"raster-saturation":new za(tc.paint_raster["raster-saturation"]),"raster-contrast":new za(tc.paint_raster["raster-contrast"]),"raster-resampling":new za(tc.paint_raster["raster-resampling"]),"raster-fade-duration":new za(tc.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new za(tc.paint_raster["raster-emissive-strength"]),"raster-array-band":new za(tc.paint_raster["raster-array-band"]),"raster-elevation":new za(tc.paint_raster["raster-elevation"])}),layout:n3};function Pv(el,eu,ec,ed,ef,em,e_,ew){let eT=[el,eu,1,ec,ed,1,ef,em,1],eM=[e_,ew,1],eE=en.bx.adjoint([],eT),[eS,eA,eI]=en.v.transformMat3(eM,eM,eE);return en.bx.multiply(eT,eT,[eS,0,0,0,eA,0,0,0,eI])}function zv(el,eu,ec,ed,ef,em,e_,ew){let eT=function(el,eu,ec,ed,ef,em,e_,ew){let eT=Pv(0,0,1,0,1,1,0,1),eM=Pv(el,eu,ec,ed,ef,em,e_,ew),eE=en.bx.adjoint([],eT);return en.bx.multiply(eM,eM,eE)}(el,eu,ec,ed,ef,em,e_,ew);return[eT[2]/eT[8]/8192,eT[5]/eT[8]/8192]}function Ev(en){return[en[0],Math.min(Math.max(en[1],-ai),ai)]}let Bv=class Bv extends ee{constructor(en,el,eu,ec){super(),this.id=en,this.dispatcher=eu,this.coordinates=el.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(ec),this.options=el,this._dirty=!1}load(en,el){if(this._loaded=el||!1,this.fire(new Qt("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return en&&(this.coordinates=en),this._loaded=!0,void this._finishLoading();this._imageRequest=vt(this.map._requestManager.transformRequest(this.url,eX.Image),(el,eu)=>{this._imageRequest=null,this._loaded=!0,el?this.fire(new te(el)):eu&&(this.image=eu instanceof HTMLImageElement?ta.getImageData(eu):eu,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,en&&(this.coordinates=en),this._finishLoading())})}loaded(){return this._loaded}updateImage(en){return en.url&&(this._imageRequest&&en.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=en.url,this.load(en.coordinates,this._loaded)),this}setTexture(en){if(!(en.handle instanceof WebGLTexture))throw Error("The provided handle is not a WebGLTexture instance");return this.texture=new wg(this.map.painter.context,en.handle),this.width=en.dimensions[0],this.height=en.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new Qt("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(en){this.map=en,this.load()}onRemove(){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof wg||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(en){if(this.coordinates=en,this._boundsArray=void 0,this._unsupportedCoords=!1,!en.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let el=en[0][1],eu=en[0][1];for(let ec of en)ec[1]>eu&&(eu=ec[1]),ec[1]<el&&(el=ec[1]);let ec=(eu+el)/2;if(ec>ai?this.onNorthPole=!0:ec<-ai&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){let el=en.map(lp.fromLngLat);this.tileID=function(en){let el=1/0,eu=1/0,ec=-1/0,ed=-1/0;for(let ef of en)el=Math.min(el,ef.x),eu=Math.min(eu,ef.y),ec=Math.max(ec,ef.x),ed=Math.max(ed,ef.y);let ef=Math.max(ec-el,ed-eu),em=Math.max(0,Math.floor(-Math.log(ef)/Math.LN2)),e_=Math.pow(2,em),ew=Math.floor((el+ec)/2*e_);return ew>1&&(ew-=1),new Kc(em,ew,Math.floor((eu+ed)/2*e_))}(el),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new Qt("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(el){var eu;for(let en in this.tiles){let el=this.tiles[en];"loaded"!==el.state&&(el.state="loaded",el.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;let ec=zy(new Kc(0,0,0),this.map.transform.projection),ed=[ec.projection.project(this.coordinates[0][0],this.coordinates[0][1]),ec.projection.project(this.coordinates[1][0],this.coordinates[1][1]),ec.projection.project(this.coordinates[2][0],this.coordinates[2][1]),ec.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(en){let el=en[1].x-en[0].x,eu=en[1].y-en[0].y,ec=en[2].x-en[1].x,ed=en[2].y-en[1].y,ef=en[3].x-en[2].x,em=en[3].y-en[2].y,e_=en[0].x-en[3].x,ew=en[0].y-en[3].y,eT=el*ed-ec*eu,eM=ec*em-ef*ed,eE=ef*ew-e_*em,eS=e_*eu-el*ew;return eT>0&&eM>0&&eE>0&&eS>0||eT<0&&eM<0&&eE<0&&eS<0}(ed))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);let ef=zy(this.tileID,this.map.transform.projection),[em,e_,ew,eT]=this.coordinates.map(en=>{let el=ef.projection.project(en[0],en[1]);return Ey(ef,el)._round()});this.perspectiveTransform=zv(em.x,em.y,e_.x,e_.y,ew.x,ew.y,eT.x,eT.y);let eM=this._boundsArray=new Ga;eM.emplaceBack(em.x,em.y,0,0),eM.emplaceBack(e_.x,e_.y,8192,0),eM.emplaceBack(eT.x,eT.y,0,8192),eM.emplaceBack(ew.x,ew.y,8192,8192),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=el.createVertexBuffer(eM,nC.members),this.boundsSegments=Do.simpleSegment(0,0,4,2);let eE=[],eS=[Ev((eu=this.coordinates)[0]),Ev(eu[1]),Ev(eu[2]),Ev(eu[3])],[eA,eI,eC,eP]=function(en){let el=en[0][0],eu=el,ec=en[0][1],ed=ec;for(let ef=1;ef<en.length;ef++)en[ef][0]<el?el=en[ef][0]:en[ef][0]>eu&&(eu=en[ef][0]),en[ef][1]<ec?ec=en[ef][1]:en[ef][1]>ed&&(ed=en[ef][1]);return[el,ec,eu-el,ed-ec]}(eS);{let eu=new Ga,[ef,em,e_,ew]=function(en){let el=en[0].x,eu=el,ec=en[0].y,ed=ec;for(let ef=1;ef<en.length;ef++)en[ef].x<el?el=en[ef].x:en[ef].x>eu&&(eu=en[ef].x),en[ef].y<ec?ec=en[ef].y:en[ef].y>ed&&(ed=en[ef].y);return[el,ec,eu-el,ed-ec]}(ed),u=en=>[(en.x-ef)/e_,(en.y-em)/ew],[eT,eM,eS,ez]=ed.map(u),eD=function(el,eu,ec,ed,ef,em,e_,ew){let eT=Pv(0,0,1,0,1,1,0,1),eM=Pv(el,eu,ec,ed,ef,em,e_,ew),eE=en.bx.adjoint([],eM);return en.bx.multiply(eT,eT,eE)}(eT[0],eT[1],eM[0],eM[1],eS[0],eS[1],ez[0],ez[1]);this.elevatedGlobePerspectiveTransform=zv(eT[0],eT[1],eM[0],eM[1],eS[0],eS[1],ez[0],ez[1]);let b=(el,ec)=>{eE.push(el.lng);let ed=Math.round((el.lng-eA)/eC*8192),ef=Math.round((el.lat-eI)/eP*8192),em=u(ec),e_=en.v.transformMat3([],[em[0],em[1],1],eD),ew=Math.round(e_[0]/e_[2]*8192),eT=Math.round(e_[1]/e_[2]*8192);eu.emplaceBack(ed,ef,ew,eT)},eL=ed[3].x-ed[0].x,ek=ed[3].y-ed[0].y,eR=ed[2].x-ed[1].x,eO=ed[2].y-ed[1].y;for(let en=0;en<65;en++){let el=en/64,eu=[ed[0].x+el*eL,ed[0].y+el*ek],ef=[ed[1].x+el*eR,ed[1].y+el*eO],em=ef[0]-eu[0],e_=ef[1]-eu[1];for(let en=0;en<65;en++){let el=en/64,ed={x:eu[0]+em*el,y:eu[1]+e_*el,z:0};b(ec.projection.unproject(ed.x,ed.y),ed)}}this.elevatedGlobeVertexBuffer=el.createVertexBuffer(eu,nC.members)}{this.maxLongitudeTriangleSize=0;let en=[],eu=new ao,n=(el,ec,ed)=>{eu.emplaceBack(el,ec,ed);let ef=eE[el],em=eE[ec],e_=eE[ed],ew=Math.min(Math.min(ef,em),e_),eT=Math.max(Math.max(ef,em),e_)-ew;eT>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=eT),en.push(ew+eT/2)};for(let en=0;en<64;en++)for(let el=0;el<64;el++){let eu=65*en+el,ec=eu+1,ed=eu+65,ef=ed+1;n(eu,ed,ec),n(ec,ed,ef)}[en,eu]=function(en,el){let eu=Array.from({length:en.length},(en,el)=>el);eu.sort((el,eu)=>en[el]-en[eu]);let ec=[],ed=new ao;for(let ef=0;ef<eu.length;ef++){let em=eu[ef];ec.push(en[em]);let e_=3*em,ew=e_+1;ed.emplaceBack(el.uint16[e_],el.uint16[ew],el.uint16[ew+1])}return[ec,ed]}(en,eu),this.elevatedGlobeTrianglesCenterLongitudes=en,this.elevatedGlobeIndexBuffer=el.createIndexBuffer(eu)}this.elevatedGlobeSegments=Do.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,eC/8192,0,eP/8192,0,0,eI,eA,0])}prepare(){let en=0!==Object.keys(this.tiles).length;if(this.tileID&&!en)return;let el=this.map.painter.context,eu=el.gl;!this._dirty||this.texture instanceof wg||(this.texture?this.texture.update(this.image):(this.texture=new _g(el,this.image,eu.RGBA),this.texture.bind(eu.LINEAR,eu.CLAMP_TO_EDGE)),this._dirty=!1),en&&this._prepareData(el)}loadTile(en,el){this.tileID&&this.tileID.equals(en.tileID.canonical)?(this.tiles[String(en.tileID.wrap)]=en,en.buckets={}):en.state="errored",el(null)}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(en){var el,eu;let ec=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!ec)return null;let ed=this.elevatedGlobeTrianglesCenterLongitudes,ef=(el=en+180)+360*Math.round(((eu=ed[0])-el)/360),em=new Do,s=(en,el)=>{em.segments.push({vertexOffset:0,primitiveOffset:en,vertexLength:ec.segments[0].vertexLength,primitiveLength:el,sortKey:void 0,vaos:{}})},e_=.51*this.maxLongitudeTriangleSize;if(Math.abs(ed[0]-ef)<=e_){let en=tt(ed,0,ed.length,ef+e_);return en===ed.length||s(en,Q(ed,en+1,ed.length,ef+360-e_)-en),em}ef<ed[0]&&(ef+=360);let ew=Q(ed,0,ed.length,ef-e_);if(ew===ed.length)return s(0,ed.length),em;s(0,ew-0);let eT=tt(ed,ew+1,ed.length,ef+e_);return eT!==ed.length&&s(eT,ed.length-eT),em}};let Dv=class Dv extends Va{constructor(en,el){super(en,{},el),this.implementation=en,en.slot&&(this.slot=en.slot)}is3D(){return"3d"===this.implementation.renderingMode}hasOffscreenPass(){return void 0!==this.implementation.prerender}isLayerDraped(en){return void 0!==this.implementation.renderToTile}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(en){this.implementation.onAdd&&this.implementation.onAdd(en,en.painter.context.gl)}onRemove(en){this.implementation.onRemove&&this.implementation.onRemove(en,en.painter.context.gl)}};let n5=new Da({visibility:new za(tc.layout_sky.visibility)});var n6={paint:new Da({"sky-type":new za(tc.paint_sky["sky-type"]),"sky-atmosphere-sun":new za(tc.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new za(tc.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new za(tc.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new za(tc.paint_sky["sky-gradient-radius"]),"sky-gradient":new Ba(tc.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new za(tc.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new za(tc.paint_sky["sky-atmosphere-color"]),"sky-opacity":new za(tc.paint_sky["sky-opacity"])}),layout:n5};function Lv(el,eu,ec){let ed=[0,0,1],ef=en.q.identity([]);return en.q.rotateY(ef,ef,ec?-(el*eF)+Math.PI:el*eF),en.q.rotateX(ef,ef,-(eu*eF)),en.v.transformQuat(ed,ed,ef),en.v.normalize(ed,ed)}var n8={paint:new Da({})};let n7={circle:class extends Va{constructor(en,el,eu){super(en,af,el,eu)}createBucket(en){return new bp(en)}queryRadius(en){return Rp("circle-radius",this,en)+Rp("circle-stroke-width",this,en)+Lp(this.paint.get("circle-translate"))}queryIntersectsFeature(en,el,eu,ec,ed,ef,em,e_){let ew=Op(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),ef.angle,en.pixelToTileUnitsFactor),eT=this.paint.get("circle-radius").evaluate(el,eu)+this.paint.get("circle-stroke-width").evaluate(el,eu);return $p(en,ec,ef,em,e_,"map"===this.paint.get("circle-pitch-alignment"),"map"===this.paint.get("circle-pitch-scale"),ew,eT)}getProgramIds(){return["circle"]}getDefaultProgramParams(en,el){let eu=Np(this);return{config:new pl(this,el),defines:eu,overrideFog:!1}}},heatmap:class extends Va{createBucket(en){return new Xp(en)}constructor(en,el,eu){super(en,aM,el,eu),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(en){"heatmap-color"===en&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=nf({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(en){return Rp("heatmap-radius",this,en)}queryIntersectsFeature(en,el,eu,ec,ed,ef,em,e_){let ew=this.paint.get("heatmap-radius").evaluate(el,eu);return $p(en,ec,ef,em,e_,!0,!0,new eB(0,0),ew)}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(en,el){return"heatmap"===en?{config:new pl(this,el),overrideFog:!1}:{}}},hillshade:class extends Va{constructor(en,el,eu){super(en,aS,el,eu)}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(en,el){return{overrideFog:!1}}},fill:class extends Va{constructor(en,el,eu){super(en,aD,el,eu)}getProgramIds(){let en=this.paint.get("fill-pattern"),el=en&&en.constantOr(1),eu=[el?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&eu.push(el&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),eu}getDefaultProgramParams(en,el){return{config:new pl(this,el),overrideFog:!1}}recalculate(en,el){super.recalculate(en,el);let eu=this.paint._values["fill-outline-color"];"constant"===eu.value.kind&&void 0===eu.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(en){return new Uf(en)}queryRadius(){return Lp(this.paint.get("fill-translate"))}queryIntersectsFeature(en,el,eu,ec,ed,ef){return!en.queryGeometry.isAboveHorizon&&Mp(Vp(en.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),ef.angle,en.pixelToTileUnitsFactor),ec)}isTileClipped(){return!0}},"fill-extrusion":class extends Va{constructor(en,el,eu){super(en,nJ,el,eu),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(en){return new tv(en)}queryRadius(){return Lp(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}hasShadowPass(){return!0}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(el,eu,ec,ed,ef,em,e_,ew,eT){var eM,eE,eS,eA;let eI=Op(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),em.angle,el.pixelToTileUnitsFactor),eC=this.paint.get("fill-extrusion-height").evaluate(eu,ec),eP=this.paint.get("fill-extrusion-base").evaluate(eu,ec),ez=[0,0],eD=ew&&em.elevation,eL=em.elevation?em.elevation.exaggeration():1,ek=el.tile.getBucket(this);if(eD&&ek instanceof tv){let en=ek.centroidVertexArray,el=eT+1;el<en.length&&(ez[0]=en.geta_centroid_pos0(el),ez[1]=en.geta_centroid_pos1(el))}if(0===ez[0]&&1===ez[1])return!1;"globe"===em.projection.name&&(ed=uv([ed],[new eB(0,0),new eB(8192,8192)],el.tileID.canonical).map(en=>en.polygon).flat());let[eR,eO]=(eM=ed,eE=eD?ew:null,eS=em.center.lat,eA=el.tileID.canonical,"globe"===em.projection.name?function(el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE){let eS=[],eA=[],eI=el.projection.upVectorScale(eE,el.center.lat,el.worldSize).metersToTile,eC=[0,0,0,1],eP=[0,0,0,1],g=(en,el,eu,ec)=>{en[0]=el,en[1]=eu,en[2]=ec,en[3]=1},ez=lv();for(let eD of(ec>0&&(ec+=ez),ed+=ez,eu)){let eu=[],ez=[];for(let eS of eD){let eA=eS.x+ef.x,eD=eS.y+ef.y,eL=el.projection.projectTilePoint(eA,eD,eE),ek=el.projection.upVector(eE,eS.x,eS.y),eR=ec,eO=ed;if(e_){let en=yv(eA,eD,ec,ed,e_,ew,eT,eM);eR+=en.base,eO+=en.top}0!==ec?g(eC,eL.x+ek[0]*eI*eR,eL.y+ek[1]*eI*eR,eL.z+ek[2]*eI*eR):g(eC,eL.x,eL.y,eL.z),g(eP,eL.x+ek[0]*eI*eO,eL.y+ek[1]*eI*eO,eL.z+ek[2]*eI*eO),en.v.transformMat4(eC,eC,em),en.v.transformMat4(eP,eP,em),eu.push(new fv(eC[0],eC[1],eC[2])),ez.push(new fv(eP[0],eP[1],eP[2]))}eS.push(eu),eA.push(ez)}return[eS,eA]}(em,eM,eP,eC,eI,e_,eE,ez,eL,eS,eA):eE?function(el,eu,ec,ed,ef,em,e_,ew,eT){let eM=[],eE=[],eS=[0,0,0,1];for(let eA of el){let el=[],eI=[];for(let eM of eA){let eE=eM.x+ed.x,eA=eM.y+ed.y,eC=yv(eE,eA,eu,ec,em,e_,ew,eT);eS[0]=eE,eS[1]=eA,eS[2]=eC.base,eS[3]=1,en.e.transformMat4(eS,eS,ef),eS[3]=Math.max(eS[3],1e-5);let eP=new fv(eS[0]/eS[3],eS[1]/eS[3],eS[2]/eS[3]);eS[0]=eE,eS[1]=eA,eS[2]=eC.top,eS[3]=1,en.e.transformMat4(eS,eS,ef),eS[3]=Math.max(eS[3],1e-5);let ez=new fv(eS[0]/eS[3],eS[1]/eS[3],eS[2]/eS[3]);el.push(eP),eI.push(ez)}eM.push(el),eE.push(eI)}return[eM,eE]}(eM,eP,eC,eI,e_,eE,ez,eL,eS):function(en,el,eu,ec,ed){let ef=[],em=[],e_=ed[8]*el,ew=ed[9]*el,eT=ed[10]*el,eM=ed[11]*el,eE=ed[8]*eu,eS=ed[9]*eu,eA=ed[10]*eu,eI=ed[11]*eu;for(let el of en){let en=[],eu=[];for(let ef of el){let el=ef.x+ec.x,em=ef.y+ec.y,eC=ed[0]*el+ed[4]*em+ed[12],eP=ed[1]*el+ed[5]*em+ed[13],ez=ed[2]*el+ed[6]*em+ed[14],eD=ed[3]*el+ed[7]*em+ed[15],eL=eC+e_,ek=eP+ew,eR=ez+eT,eO=Math.max(eD+eM,1e-5),eB=eC+eE,eF=eP+eS,eN=ez+eA,eU=Math.max(eD+eI,1e-5);en.push(new fv(eL/eO,ek/eO,eR/eO)),eu.push(new fv(eB/eU,eF/eU,eN/eU))}ef.push(en),em.push(eu)}return[ef,em]}(eM,eP,eC,eI,e_)),eF=el.queryGeometry;return function(en,el,eu){let ec=1/0;Mp(eu,el)&&(ec=mv(eu,el[0]));for(let ed=0;ed<el.length;ed++){let ef=el[ed],em=en[ed];for(let en=0;en<ef.length-1;en++){let el=ef[en],ed=[el,ef[en+1],em[en+1],em[en],el];_p(eu,ed)&&(ec=Math.min(ec,mv(eu,ed)))}}return ec!==1/0&&ec}(eR,eO,eF.isPointQuery()?eF.screenBounds:eF.screenGeometry)}},line:class extends Va{constructor(en,el,eu){super(en,nQ,el,eu),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(en){if("line-gradient"===en){let en=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=en._styleExpression&&en._styleExpression.expression instanceof _n,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(en,el){super.recalculate(en,el),this.paint._values["line-floorwidth"]=n0.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,en)}createBucket(en){return new bg(en)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(en,el){let eu=_v(this);return{config:new pl(this,el),defines:eu,overrideFog:!1}}queryRadius(en){var el,eu;let ec=(el=Rp("line-width",this,en),(eu=Rp("line-gap-width",this,en))>0?eu+2*el:el),ed=Rp("line-offset",this,en);return ec/2+Math.abs(ed)+Lp(this.paint.get("line-translate"))}queryIntersectsFeature(en,el,eu,ec,ed,ef){var em,e_;if(en.queryGeometry.isAboveHorizon)return!1;let ew=Vp(en.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),ef.angle,en.pixelToTileUnitsFactor),eT=en.pixelToTileUnitsFactor/2*(em=this.paint.get("line-width").evaluate(el,eu),(e_=this.paint.get("line-gap-width").evaluate(el,eu))>0?e_+2*em:em),eM=this.paint.get("line-offset").evaluate(el,eu);return eM&&(ec=function(en,el){let eu=[],ec=new eB(0,0);for(let ed=0;ed<en.length;ed++){let ef=en[ed],em=[];for(let en=0;en<ef.length;en++){let eu=ef[en],ed=ef[en+1],e_=0===en?ec:eu.sub(ef[en-1])._unit()._perp(),ew=en===ef.length-1?ec:ed.sub(eu)._unit()._perp(),eT=e_._add(ew)._unit();eT._mult(1/(eT.x*ew.x+eT.y*ew.y)),em.push(eT._mult(el)._add(eu))}eu.push(em)}return eu}(ec,eM*en.pixelToTileUnitsFactor)),function(en,el,eu){for(let ec=0;ec<el.length;ec++){let ed=el[ec];if(en.length>=3){for(let el=0;el<ed.length;el++)if(zp(en,ed[el]))return!0}if(function(en,el,eu){if(en.length>1){if(Sp(en,el))return!0;for(let ec=0;ec<el.length;ec++)if(kp(el[ec],en,eu))return!0}for(let ec=0;ec<en.length;ec++)if(kp(en[ec],el,eu))return!0;return!1}(en,ed,eu))return!0}return!1}(ew,ec,eT)}isTileClipped(){return!0}},symbol:rg,background:class extends Va{constructor(en,el,eu){super(en,n2,el,eu)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(en,el){return{overrideFog:!1}}},raster:class extends Va{constructor(en,el,eu){super(en,n4,el,eu),this._updateColorRamp()}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}isLayerDraped(en){return!(en&&en._source instanceof Bv)||!en._source.onNorthPole&&!en._source.onSouthPole&&0===this.paint.get("raster-elevation")}_handleSpecialPaintPropertyUpdate(en){"raster-color"!==en&&"raster-color-range"!==en||this._updateColorRamp()}_updateColorRamp(){if(!this.hasColorMap())return;let en=this._transitionablePaint._values["raster-color"].value.expression,[el,eu]=this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0});this.colorRamp=nf({expression:en,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:el,end:eu}],resolution:256}),this.colorRampTexture=null}},sky:class extends Va{constructor(en,el,eu){super(en,n6,el,eu),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(en){"sky-gradient"===en?this._updateColorRamp():"sky-atmosphere-sun"!==en&&"sky-atmosphere-halo-color"!==en&&"sky-atmosphere-color"!==en&&"sky-atmosphere-sun-intensity"!==en||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=nf({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(en){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){let el=en.style.light.properties.get("position");return this._lightPosition.azimuthal!==el.azimuthal||this._lightPosition.polar!==el.polar}return!1}getCenter(en,el){if("atmosphere"===this.paint.get("sky-type")){let eu=this.paint.get("sky-atmosphere-sun"),ec=!eu,ed=en.style.light,ef=ed.properties.get("position");return ec&&"viewport"===ed.properties.get("anchor")&&q("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),ec?Lv(ef.azimuthal,90-ef.polar,el):Lv(eu[0],90-eu[1],el)}let eu=this.paint.get("sky-gradient-center");return Lv(eu[0],90-eu[1],el)}isSky(){return!0}markSkyboxValid(en){this._skyboxInvalidated=!1,this._lightPosition=en.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){let en=this.paint.get("sky-type");return"atmosphere"===en?["skyboxCapture","skybox"]:"gradient"===en?["skyboxGradient"]:null}},slot:class extends Va{constructor(en,el,eu){super(en,n8,el)}},model:class extends Va{constructor(en,el,eu){super(en,nV,el,eu)}createBucket(en){return new xx(en)}getProgramIds(){return["model"]}is3D(){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(){return 0}queryIntersectsFeature(){return!1}_handleOverridablePaintPropertyUpdate(en,el,eu){return!(!this.layout||el.isDataDriven()||eu.isDataDriven()||"model-color"!==en&&"model-color-mix-intensity"!==en&&"model-rotation"!==en&&"model-scale"!==en&&"model-translation"!==en&&"model-emissive-strength"!==en)}_isPropertyZoomDependent(en){let el=this._transitionablePaint._values[en];return null!=el&&null!=el.value&&null!=el.value.expression&&el.value.expression instanceof Wi}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}}};let Fv=class Fv{constructor(en){this._callback=en,this._triggered=!1,"undefined"!=typeof MessageChannel&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}};let jv=class jv{constructor(){this.tasks={},this.taskQueue=[],O(["process"],this),this.invoker=new Fv(this.process),this.nextId=0}add(en,el){let eu=this.nextId++,ec=function({type:en,isSymbolTile:el,zoom:eu}){return eu=eu||0,"message"===en?0:"maybePrepare"!==en||el?"parseTile"!==en||el?"parseTile"===en&&el?300-eu:"maybePrepare"===en&&el?400-eu:500:200-eu:100-eu}(el);return 0===ec?(X(),en(),null):(this.tasks[eu]={fn:en,metadata:el,priority:ec,id:eu},this.taskQueue.push(eu),this.invoker.trigger(),{cancel:()=>{delete this.tasks[eu]}})}process(){X();{if(this.taskQueue=this.taskQueue.filter(en=>!!this.tasks[en]),!this.taskQueue.length)return;let en=this.pick();if(null===en)return;let el=this.tasks[en];if(delete this.tasks[en],this.taskQueue.length&&this.invoker.trigger(),!el)return;el.fn()}}pick(){let en=null,el=1/0;for(let eu=0;eu<this.taskQueue.length;eu++){let ec=this.tasks[this.taskQueue[eu]];ec.priority<el&&(el=ec.priority,en=eu)}if(null===en)return null;let eu=this.taskQueue[en];return this.taskQueue.splice(en,1),eu}remove(){this.invoker.remove()}};let Uv=class Uv{constructor(en,el,eu){this.target=en,this.parent=el,this.mapId=eu,this.callbacks={},this.cancelCallbacks={},O(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new jv}send(en,el,eu,ec,ed=!1,ef){let em=Math.round(1e18*Math.random()).toString(36).substring(0,10);eu&&(eu.metadata=ef,this.callbacks[em]=eu);let e_=new Set;return this.target.postMessage({id:em,type:en,hasCallback:!!eu,targetMapId:ec,mustQueue:ed,sourceMapId:this.mapId,data:Js(el,e_)},e_),{cancel:()=>{eu&&delete this.callbacks[em],this.target.postMessage({id:em,type:"<cancel>",targetMapId:ec,sourceMapId:this.mapId})}}}receive(en){let el=en.data,eu=el.id;if(eu&&(!el.targetMapId||this.mapId===el.targetMapId)){if("<cancel>"===el.type){let en=this.cancelCallbacks[eu];delete this.cancelCallbacks[eu],en&&en.cancel()}else if(el.mustQueue||X()){let en=this.callbacks[eu],ec=this.scheduler.add(()=>this.processTask(eu,el),en&&en.metadata||{type:"message"});ec&&(this.cancelCallbacks[eu]=ec)}else this.processTask(eu,el)}}processTask(en,el){if(delete this.cancelCallbacks[en],"<response>"===el.type){let eu=this.callbacks[en];delete this.callbacks[en],eu&&(el.error?eu(Qs(el.error)):eu(null,Qs(el.data)))}else{let eu=new Set,ec=el.hasCallback?(el,ec)=>{this.target.postMessage({id:en,type:"<response>",sourceMapId:this.mapId,error:el?Js(el):null,data:Js(ec,eu)},eu)}:en=>{},ed=Qs(el.data);if(this.parent[el.type])this.parent[el.type](el.sourceMapId,ed,ec);else if(this.parent.getWorkerSource){let en=el.type.split(".");this.parent.getWorkerSource(el.sourceMapId,en[0],ed.source,ed.scope)[en[1]](ed,ec)}else ec(Error(`Could not find function ${el.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}};let Nv=class Nv{constructor(en,el){this.workerPool=en,this.actors=[],this.currentActor=0,this.id=C();let eu=this.workerPool.acquire(this.id);for(let en=0;en<eu.length;en++){let ec=new Nv.Actor(eu[en],el,this.id);ec.name=`Worker ${en}`,this.actors.push(ec)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(en,el,eu){z(this.actors,(eu,ec)=>{eu.send(en,el,ec)},eu=eu||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(en=>{en.remove()}),this.actors=[],this.workerPool.release(this.id)}};Nv.Actor=Uv;let $v=class $v{constructor(en,el){this.width=en,this.height=el,this.nextRow=0,this.image=new Jp({width:en,height:el}),this.positions={},this.uploaded=!1}getDash(en,el){let eu=this.getKey(en,el);return this.positions[eu]}trim(){let en=this.width,el=this.height=L(this.nextRow);this.image.resize({width:en,height:el})}getKey(en,el){return en.join(",")+el}getDashRanges(en,el,eu){let ec=[],ed=en.length%2==1?-en[en.length-1]*eu:0,ef=en[0]*eu,em=!0;ec.push({left:ed,right:ef,isDash:em,zeroLength:0===en[0]});let e_=en[0];for(let el=1;el<en.length;el++){em=!em;let ew=en[el];ed=e_*eu,e_+=ew,ef=e_*eu,ec.push({left:ed,right:ef,isDash:em,zeroLength:0===ew})}return ec}addRoundDash(en,el,eu){let ec=el/2;for(let el=-eu;el<=eu;el++){let ed=this.width*(this.nextRow+eu+el),ef=0,em=en[0];for(let e_=0;e_<this.width;e_++){let ew;e_/em.right>1&&(em=en[++ef]);let eT=Math.abs(e_-em.left),eM=Math.abs(e_-em.right),eE=Math.min(eT,eM),eS=el/eu*(ec+1);if(em.isDash){let en=ec-Math.abs(eS);ew=Math.sqrt(eE*eE+en*en)}else ew=ec-Math.sqrt(eE*eE+eS*eS);this.image.data[ed+e_]=Math.max(0,Math.min(255,ew+128))}}}addRegularDash(en,el){for(let el=en.length-1;el>=0;--el){let eu=en[el],ec=en[el+1];eu.zeroLength?en.splice(el,1):ec&&ec.isDash===eu.isDash&&(ec.left=eu.left,en.splice(el,1))}let eu=en[0],ec=en[en.length-1];eu.isDash===ec.isDash&&(eu.left=ec.left-this.width,ec.right=eu.right+this.width);let ed=this.width*this.nextRow,ef=0,em=en[0];for(let eu=0;eu<this.width;eu++){eu/em.right>1&&(em=en[++ef]);let ec=Math.abs(eu-em.left),e_=Math.abs(eu-em.right),ew=Math.min(ec,e_);this.image.data[ed+eu]=Math.max(0,Math.min(255,(em.isDash?ew:-ew)+el+128))}}addDash(en,el){let eu=this.getKey(en,el);if(this.positions[eu])return this.positions[eu];let ec="round"===el,ed=ec?7:0,ef=2*ed+1;if(this.nextRow+ef>this.height)return q("LineAtlas out of space"),null;0===en.length&&en.push(1);let em=0;for(let el=0;el<en.length;el++)en[el]<0&&(q("Negative value is found in line dasharray, replacing values with 0"),en[el]=0),em+=en[el];if(0!==em){let eu=this.width/em,ef=this.getDashRanges(en,this.width,eu);ec?this.addRoundDash(ef,eu,ed):this.addRegularDash(ef,"square"===el?.5*eu:0)}let e_=this.nextRow+ed;this.nextRow+=ef;let ew={tl:[e_,ed],br:[em,0]};return this.positions[eu]=ew,ew}};Ks($v,"LineAtlas");let Gv=class Gv{constructor(en){let el={},eu=[];for(let ec in en){let ed=en[ec],ef=el[ec]={};for(let en in ed.glyphs){let el=ed.glyphs[+en];if(!el||0===el.bitmap.width||0===el.bitmap.height)continue;let ec=el.metrics.localGlyph?2:1,em={x:0,y:0,w:el.bitmap.width+2*ec,h:el.bitmap.height+2*ec};eu.push(em),ef[en]=em}}let{w:ec,h:ed}=Km(eu),ef=new Jp({width:ec||1,height:ed||1});for(let eu in en){let ec=en[eu];for(let en in ec.glyphs){let ed=ec.glyphs[+en];if(!ed||0===ed.bitmap.width||0===ed.bitmap.height)continue;let em=el[eu][en],e_=ed.metrics.localGlyph?2:1;Jp.copy(ed.bitmap,ef,{x:0,y:0},{x:em.x+e_,y:em.y+e_},ed.bitmap)}}this.image=ef,this.positions=el}};Ks(Gv,"GlyphAtlas");let Yv=class Yv{constructor(en){this.tileID=new Hc(en.tileID.overscaledZ,en.tileID.wrap,en.tileID.canonical.z,en.tileID.canonical.x,en.tileID.canonical.y),this.tileZoom=en.tileZoom,this.uid=en.uid,this.zoom=en.zoom,this.canonical=en.tileID.canonical,this.pixelRatio=en.pixelRatio,this.tileSize=en.tileSize,this.source=en.source,this.scope=en.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=en.showCollisionBoxes,this.collectResourceTiming=!!en.collectResourceTiming,this.promoteId=en.promoteId,this.isSymbolTile=en.isSymbolTile,this.tileTransform=zy(en.tileID.canonical,en.projection),this.projection=en.projection,this.brightness=en.brightness,this.extraShadowCaster=!!en.extraShadowCaster}parse(en,el,eu,ec,ed){let ef,em,e_,ew;this.status="parsing",this.data=en,this.collisionBoxArray=new _o;let eT=new hd(Object.keys(en.layers).sort()),eM=new Hd(this.tileID,this.promoteId);eM.bucketLayerIDs=[];let eE={},eS=new $v(256,256),eA={featureIndex:eM,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:eS,availableImages:eu,brightness:this.brightness},eI=el.familiesBySource[this.source];for(let el in eI){let ec=en.layers[el];if(!ec)continue;let ed=!1,ef=!1,em=!1;for(let en of eI[el])"symbol"===en[0].type?ed=!0:ef=!0,en[0].is3D()&&"model"!==en[0].type&&(em=!0);if(this.extraShadowCaster&&!em||!0===this.isSymbolTile&&!ed||!1===this.isSymbolTile&&!ef)continue;1===ec.version&&q(`Vector tile source "${this.source}" layer "${el}" does not use vector tile spec v2 and therefore may have some rendering errors.`);let e_=eT.encode(el),ew=[];for(let en=0;en<ec.length;en++){let eu=ec.feature(en),ed=eM.getId(eu,el);ew.push({feature:eu,id:ed,index:en,sourceLayerIndex:e_})}for(let en of eI[el]){let el=en[0];(!this.extraShadowCaster||el.is3D()&&"model"!==el.type)&&(void 0!==this.isSymbolTile&&"symbol"===el.type!==this.isSymbolTile||el.minzoom&&this.zoom<Math.floor(el.minzoom)||el.maxzoom&&this.zoom>=el.maxzoom||"none"!==el.visibility&&(Zv(en,this.zoom,eA.brightness,eu),(eE[el.id]=el.createBucket({index:eM.bucketLayerIDs.length,layers:en,zoom:this.zoom,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:e_,sourceID:this.source,projection:this.projection.spec})).populate(ew,eA,this.tileID.canonical,this.tileTransform),eM.bucketLayerIDs.push(en.map(en=>en.id))))}}eS.trim();let eC={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},y=()=>{if(ef)return this.status="done",ed(ef);if(this.extraShadowCaster)this.status="done",ed(null,{buckets:E(eE).filter(en=>!en.isEmpty()),featureIndex:eM,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:eA.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(em&&e_&&ew){let en=new Gv(em),el=new Jm(e_,ew);for(let ec in eE){let ed=eE[ec];ed instanceof n_?(Zv(ed.layers,this.zoom,eA.brightness,eu),function(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM){en.createArrays(),en.tilePixelRatio=8192/(512*en.overscaling),en.compareText={},en.iconsNeedLinear=!1;let eE=en.layers[0].layout,eS=en.layers[0]._unevaluatedLayout._values,eA={};if("composite"===en.textSizeData.kind){let{minZoom:el,maxZoom:eu}=en.textSizeData;eA.compositeTextSizes=[eS["text-size"].possiblyEvaluate(new _a(el),e_),eS["text-size"].possiblyEvaluate(new _a(eu),e_)]}if("composite"===en.iconSizeData.kind){let{minZoom:el,maxZoom:eu}=en.iconSizeData;eA.compositeIconSizes=[eS["icon-size"].possiblyEvaluate(new _a(el),e_),eS["icon-size"].possiblyEvaluate(new _a(eu),e_)]}eA.layoutTextSize=eS["text-size"].possiblyEvaluate(new _a(ew+1),e_),eA.layoutIconSize=eS["icon-size"].possiblyEvaluate(new _a(ew+1),e_),eA.textMaxSize=eS["text-size"].possiblyEvaluate(new _a(18),e_);let eI="map"===eE.get("text-rotation-alignment")&&"point"!==eE.get("symbol-placement"),eC=eE.get("text-size"),eP=!1;for(let el of en.features)if(el.icon&&el.icon.nameSecondary){eP=!0;break}for(let ef of en.features){let ew=eE.get("text-font").evaluate(ef,{},e_).join(","),eS=eC.evaluate(ef,{},e_),ez=eA.layoutTextSize.evaluate(ef,{},e_),eD=(eA.layoutIconSize.evaluate(ef,{},e_),{horizontal:{},vertical:void 0}),eL=ef.text,ek,eR=[0,0];if(eL){let ec=eL.toString(),em=24*eE.get("text-letter-spacing").evaluate(ef,{},e_),eT=24*eE.get("text-line-height").evaluate(ef,{},e_),eM=!function(en){for(let eu of en){var el;if(el=eu.charCodeAt(0),iu.Arabic(el)||iu["Arabic Supplement"](el)||iu["Arabic Extended-A"](el)||iu["Arabic Presentation Forms-A"](el)||iu["Arabic Presentation Forms-B"](el))return!1}return!0}(ec)?0:em,eA=eE.get("text-anchor").evaluate(ef,{},e_),eC=eE.get("text-variable-anchor");if(!eC){let en=eE.get("text-radial-offset").evaluate(ef,{},e_);eR=en?xy(eA,[24*en,a7]):eE.get("text-offset").evaluate(ef,{},e_).map(en=>24*en)}let eP=eI?"center":eE.get("text-justify").evaluate(ef,{},e_),ek="point"===eE.get("symbol-placement"),eO=ek?24*eE.get("text-max-width").evaluate(ef,{},e_):1/0,M=ef=>{en.allowVerticalPlacement&&ea(ec)&&(eD.vertical=Tm(eL,el,eu,ed,ew,eO,eT,eA,ef,eM,eR,a4.vertical,!0,ez,eS))};if(!eI&&eC){let en="auto"===eP?eC.map(en=>by(en)):[eP],ec=!1;for(let ef=0;ef<en.length;ef++){let em=en[ef];if(!eD.horizontal[em]){if(ec)eD.horizontal[em]=eD.horizontal[0];else{let en=Tm(eL,el,eu,ed,ew,eO,eT,"center",em,eM,eR,a4.horizontal,!1,ez,eS);en&&(eD.horizontal[em]=en,ec=1===en.positionedLines.length)}}}M("left")}else{if("auto"===eP&&(eP=by(eA)),ek||eE.get("text-writing-mode").indexOf("horizontal")>=0||!ea(ec)){let en=Tm(eL,el,eu,ed,ew,eO,eT,eA,eP,eM,eR,a4.horizontal,!1,ez,eS);en&&(eD.horizontal[eP]=en)}M(ek?"left":eP)}}let eO=!1;if(ef.icon&&ef.icon.namePrimary){let el=ec[ef.icon.namePrimary];el&&(ek=function(en,el,eu,ec){let{horizontalAlign:ed,verticalAlign:ef}=Lm(ec),em=eu[0]-en.displaySize[0]*ed,e_=eu[1]-en.displaySize[1]*ef;return{imagePrimary:en,imageSecondary:el,top:e_,bottom:e_+en.displaySize[1],left:em,right:em+en.displaySize[0]}}(ed[ef.icon.namePrimary],ef.icon.nameSecondary?ed[ef.icon.nameSecondary]:void 0,eE.get("icon-offset").evaluate(ef,{},e_),eE.get("icon-anchor").evaluate(ef,{},e_)),eO=el.sdf,void 0===en.sdfIcons?en.sdfIcons=el.sdf:en.sdfIcons!==el.sdf&&q("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(el.pixelRatio!==en.pixelRatio||0!==eE.get("icon-rotate").constantOr(1))&&(en.iconsNeedLinear=!0))}let eN=Sy(eD.horizontal)||eD.vertical;en.iconsInText||(en.iconsInText=!!eN&&eN.iconsInText),(eN||ek)&&function(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI){var eC;let eP,ez=ef.textMaxSize.evaluate(el,{},eE);void 0===ez&&(ez=em);let eD=en.layers[0].layout,eL=eD.get("icon-offset").evaluate(el,{},eE),ek=Sy(eu.horizontal)||eu.vertical,eR="globe"===eS.name,eO=em/24,eN=en.tilePixelRatio*ez/24,eU=(eC=en.overscaling,en.zoom>18&&eC>2&&(eC>>=1),Math.max(8192/(512*eC),1)*eD.get("symbol-spacing")),eV=eD.get("text-padding")*en.tilePixelRatio,ej=eD.get("icon-padding")*en.tilePixelRatio,eG=eD.get("text-max-angle")*eF,eq="map"===eD.get("text-rotation-alignment")&&"point"!==eD.get("symbol-placement"),eZ="map"===eD.get("icon-rotation-alignment")&&"point"!==eD.get("symbol-placement"),e$=eD.get("symbol-placement"),eW=eU/2,eH=eD.get("icon-text-fit").evaluate(el,{},eE),eX=eD.get("icon-text-fit-padding").evaluate(el,{},eE),eK="none"!==eH;!1===en.hasAnyIconTextFit&&eK&&(en.hasAnyIconTextFit=!0),ec&&eK&&(en.allowVerticalPlacement&&eu.vertical&&(eP=Fm(ec,eu.vertical,eH,eX,eL,eO)),ek&&(ec=Fm(ec,ek,eH,eX,eL,eO)));let V=(em,e_,eC)=>{if(e_.x<0||e_.x>=8192||e_.y<0||e_.y>=8192)return;let ez=null;if(eR){let{x:en,y:el,z:eu}=eS.projectTilePoint(e_.x,e_.y,eC);ez={anchor:new jm(en,el,eu,0,void 0),up:eS.upVector(eC,e_.x,e_.y)}}!function(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC,eP,ez,eD,eL,ek,eR,eO,eB,eF,eN,eU){let eV=en.addToLineVertexArray(el,ec),ej,eG,eq,eZ,e$,eW,eH,eX=0,eK=0,eJ=0,eY=0,eQ=-1,e0=-1,e1={},e2=iO(""),e3=eu?eu.anchor:el,e4="none"!==ew.layout.get("icon-text-fit").evaluate(ek,{},eF),e5=0,e6=0;if(void 0===ew._unevaluatedLayout.getValue("text-radial-offset")?[e5,e6]=ew.layout.get("text-offset").evaluate(ek,{},eF).map(en=>24*en):(e5=24*ew.layout.get("text-radial-offset").evaluate(ek,{},eF),e6=a7),en.allowVerticalPlacement&&ed.vertical){let en=ed.vertical;if(eI)eW=ky(en),e_&&(eH=ky(e_));else{let eu=ew.layout.get("text-rotate").evaluate(ek,{},eF)+90;eq=Iy(eT,e3,el,eM,eE,eS,en,eA,eu,eC),e_&&(eZ=Iy(eT,e3,el,eM,eE,eS,e_,ez,eu))}}if(ef){let ec=ew.layout.get("icon-rotate").evaluate(ek,{},eF),ed=ay(ef,ec,eO,e4),em=e_?ay(e_,ec,eO,e4):void 0;eG=Iy(eT,e3,el,eM,eE,eS,ef,ez,ec),eX=4*ed.length;let eA=en.iconSizeData,eI=null;"source"===eA.kind?(eI=[128*ew.layout.get("icon-size").evaluate(ek,{},eF)])[0]>32640&&q(`${en.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`):"composite"===eA.kind&&((eI=[128*eR.compositeIconSizes[0].evaluate(ek,{},eF),128*eR.compositeIconSizes[1].evaluate(ek,{},eF)])[0]>32640||eI[1]>32640)&&q(`${en.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`),en.addSymbols(en.icon,ed,eI,eL,eD,ek,!1,eu,el,eV.lineStartIndex,eV.lineLength,-1,eB,eF,eN,eU),eQ=en.icon.placedSymbolArray.length-1,em&&(eK=4*em.length,en.addSymbols(en.icon,em,eI,eL,eD,ek,a4.vertical,eu,el,eV.lineStartIndex,eV.lineLength,-1,eB,eF,eN,eU),e0=en.icon.placedSymbolArray.length-1)}for(let ec in ed.horizontal){let ef=ed.horizontal[ec];ej||(e2=iO(ef.text),eI?e$=ky(ef):ej=Iy(eT,e3,el,eM,eE,eS,ef,eA,ew.layout.get("text-rotate").evaluate(ek,{},eF),eC));let e_=1===ef.positionedLines.length;if(eJ+=Ay(en,eu,el,ef,em,ew,eI,ek,eC,eV,ed.vertical?a4.horizontal:a4.horizontalOnly,e_?Object.keys(ed.horizontal):[ec],e1,eQ,eR,eB,eF,eN),e_)break}ed.vertical&&(eY+=Ay(en,eu,el,ed.vertical,em,ew,eI,ek,eC,eV,a4.vertical,["vertical"],e1,e0,eR,eB,eF,eN));let e8=-1,K=(en,el)=>en?Math.max(en,el):el;e8=K(e$,e8),e8=K(eW,e8),e8=K(eH,e8);let e7=e8>-1?1:0;en.glyphOffsetArray.length>=n_.MAX_GLYPHS&&q("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),void 0!==ek.sortKey&&en.addToSortKeyRanges(en.symbolInstances.length,ek.sortKey),en.symbolInstances.emplaceBack(el.x,el.y,e3.x,e3.y,e3.z,e1.right>=0?e1.right:-1,e1.center>=0?e1.center:-1,e1.left>=0?e1.left:-1,e1.vertical>=0?e1.vertical:-1,eQ,e0,e2,void 0!==ej?ej:en.collisionBoxArray.length,void 0!==ej?ej+1:en.collisionBoxArray.length,void 0!==eq?eq:en.collisionBoxArray.length,void 0!==eq?eq+1:en.collisionBoxArray.length,void 0!==eG?eG:en.collisionBoxArray.length,void 0!==eG?eG+1:en.collisionBoxArray.length,eZ||en.collisionBoxArray.length,eZ?eZ+1:en.collisionBoxArray.length,eM,eJ,eY,eX,eK,e7,0,e5,e6,e8,0,e4?1:0)}(en,e_,ez,em,eu,ec,ed,eP,en.layers[0],en.collisionBoxArray,el.index,el.sourceLayerIndex,en.index,eV,eq,ew,0,ej,eZ,eL,el,ef,eT,eM,eE,eA,eI)};if("line"===e$)for(let ed of Xm(el.geometry,0,0,8192,8192)){let el=function(en,el,eu,ec,ed,ef,em,e_,ew){let eT=ec?.6*ef*em:0,eM=qm(ec,ed),eE=eM*em,eS=0===en[0].x||en[0].x===ew||0===en[0].y||en[0].y===ew;return el-eE<el/4&&(el=eE+el/4),function Zm(en,el,eu,ec,ed,ef,em,e_,ew){let eT=ef/2,eM=Nm(en),eE=0,eS=el-eu,eA=[];for(let el=0;el<en.length-1;el++){let em=en[el],e_=en[el+1],eI=em.dist(e_),eC=e_.angleTo(em);for(;eS+eu<eE+eI;){eS+=eu;let eP=(eS-eE)/eI,ez=Mn(em.x,e_.x,eP),eD=Mn(em.y,e_.y,eP);if(ez>=0&&ez<ew&&eD>=0&&eD<ew&&eS-eT>=0&&eS+eT<=eM){let eu=new jm(ez,eD,0,eC,el);ec&&!Um(en,eu,ef,ec,ed)||eA.push(eu)}}eE+=eI}return e_||eA.length||em||(eA=Zm(en,eE/2,eu,ec,ed,ef,em,!0,ew)),eA}(en,eS?el/2*e_%el:(eM/2+2*ef)*em*e_%el,el,eT,eu,eE,eS,!1,ew)}(ed,eU,eG,eu.vertical||ek,ec,24,eN,en.overscaling,8192);for(let eu of el)ek&&function(en,el,eu,ec){let ed=en.compareText;if(el in ed){let en=ed[el];for(let el=en.length-1;el>=0;el--)if(ec.dist(en[el])<eu)return!0}else ed[el]=[];return ed[el].push(ec),!1}(en,ek.text,eW,eu)||V(ed,eu,eE)}else if("line-center"===e$){for(let en of el.geometry)if(en.length>1){let el=function(en,el,eu,ec,ed,ef){let em=eu?14.399999999999999*ef:0,e_=qm(eu,ec)*ef,ew=0,eT=Nm(en)/2;for(let eu=0;eu<en.length-1;eu++){let ec=en[eu],ed=en[eu+1],ef=ec.dist(ed);if(ew+ef>eT){let eM=(eT-ew)/ef,eE=Mn(ec.x,ed.x,eM),eS=Mn(ec.y,ed.y,eM),eA=new jm(eE,eS,0,ed.angleTo(ec),eu);return!em||Um(en,eA,e_,em,el)?eA:void 0}ew+=ef}}(en,eG,eu.vertical||ek,ec,0,eN);el&&V(en,el,eE)}}else if("Polygon"===el.type)for(let en of Vf(el.geometry,0)){let el=function(en,el=1,eu=!1){let ec=1/0,ed=1/0,ef=-1/0,em=-1/0,e_=en[0];for(let en=0;en<e_.length;en++){let el=e_[en];(!en||el.x<ec)&&(ec=el.x),(!en||el.y<ed)&&(ed=el.y),(!en||el.x>ef)&&(ef=el.x),(!en||el.y>em)&&(em=el.y)}let ew=Math.min(ef-ec,em-ed),eT=ew/2,eM=new tj([],fy);if(0===ew)return new eB(ec,ed);for(let el=ec;el<ef;el+=ew)for(let eu=ed;eu<em;eu+=ew)eM.push(new dy(el+eT,eu+eT,eT,en));let eE=function(en){let el=0,eu=0,ec=0,ed=en[0];for(let en=0,ef=ed.length,em=ef-1;en<ef;em=en++){let ef=ed[en],e_=ed[em],ew=ef.x*e_.y-e_.x*ef.y;eu+=(ef.x+e_.x)*ew,ec+=(ef.y+e_.y)*ew,el+=3*ew}return new dy(eu/el,ec/el,0,en)}(en),eS=eM.length;for(;eM.length;){let ec=eM.pop();(ec.d>eE.d||!eE.d)&&(eE=ec,eu&&console.log("found best %d after %d probes",Math.round(1e4*ec.d)/1e4,eS)),ec.max-eE.d<=el||(eT=ec.h/2,eM.push(new dy(ec.p.x-eT,ec.p.y-eT,eT,en)),eM.push(new dy(ec.p.x+eT,ec.p.y-eT,eT,en)),eM.push(new dy(ec.p.x-eT,ec.p.y+eT,eT,en)),eM.push(new dy(ec.p.x+eT,ec.p.y+eT,eT,en)),eS+=4)}return eu&&(console.log(`num probes: ${eS}`),console.log(`best distance: ${eE.d}`)),eE.p}(en,16);V(en[0],new jm(el.x,el.y,0,0,void 0),eE)}else if("LineString"===el.type)for(let en of el.geometry)V(en,new jm(en[0].x,en[0].y,0,0,void 0),eE);else if("Point"===el.type)for(let en of el.geometry)for(let el of en)V([el],new jm(el.x,el.y,0,0,void 0),eE)}(en,ef,eD,ek,ec,eA,ez,0,eR,eO,em,e_,eT,eM,eP)}ef&&en.generateCollisionDebugBuffers(ew,en.collisionBoxArray)}(ed,em,en.positions,e_,el.iconPositions,this.showCollisionBoxes,eu,this.tileID.canonical,this.tileZoom,this.projection,this.brightness)):ed.hasPattern&&(ed instanceof bg||ed instanceof Uf||ed instanceof tv)&&(Zv(ed.layers,this.zoom,eA.brightness,eu),ed.addFeatures(eA,this.tileID.canonical,el.patternPositions,eu,this.tileTransform,this.brightness))}this.status="done",ed(null,{buckets:E(eE).filter(en=>!en.isEmpty()),featureIndex:eM,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:en.image,lineAtlas:eS,imageAtlas:el,brightness:eA.brightness})}};if(!this.extraShadowCaster){let en=j(eA.glyphDependencies,en=>Object.keys(en).map(Number));Object.keys(en).length?ec.send("getGlyphs",{uid:this.uid,stacks:en,scope:this.scope},(en,el)=>{ef||(ef=en,em=el,y())},void 0,!1,eC):em={};let el=Object.keys(eA.iconDependencies);el.length?ec.send("getImages",{icons:el,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(en,el)=>{ef||(ef=en,e_=el,y())},void 0,!1,eC):e_={};let eu=Object.keys(eA.patternDependencies);eu.length?ec.send("getImages",{icons:eu,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(en,el)=>{ef||(ef=en,ew=el,y())},void 0,!1,eC):ew={}}y()}};function Zv(en,el,eu,ec){let ed=new _a(el,{brightness:eu});for(let el of en)el.recalculate(ed,ec)}let Xv=class Xv{constructor(en){this.entries={},this.scheduler=en}request(en,el,eu,ec){let ed=this.entries[en]=this.entries[en]||{callbacks:[]};if(ed.result){let[en,eu]=ed.result;return this.scheduler?this.scheduler.add(()=>{ec(en,eu)},el):ec(en,eu),()=>{}}return ed.callbacks.push(ec),ed.cancel||(ed.cancel=eu((eu,ec)=>{for(let en of(ed.result=[eu,ec],ed.callbacks))this.scheduler?this.scheduler.add(()=>{en(eu,ec)},el):en(eu,ec);setTimeout(()=>delete this.entries[en],3e3)})),()=>{ed.result||(ed.callbacks=ed.callbacks.filter(en=>en!==ec),ed.callbacks.length||(ed.cancel(),delete this.entries[en]))}}};function Kv(en,el,eu){let ec=JSON.stringify(en.request);return en.data&&(this.deduped.entries[ec]={result:[null,en.data]}),this.deduped.request(ec,{type:"parseTile",isSymbolTile:en.isSymbolTile,zoom:en.tileZoom},el=>{let ec=dt(en.request,(en,ec,ed,ef)=>{en?el(en):ec&&el(null,{vectorTile:eu?void 0:new aU(new aq(ec)),rawData:ec,cacheControl:ed,expires:ef})});return()=>{ec.cancel(),el()}},el)}var n9={workerUrl:"",workerClass:null,workerParams:void 0};function Hv(){return null!=n9.workerClass?new n9.workerClass:new self.Worker(n9.workerUrl,n9.workerParams)}let oa="mapboxgl_preloaded_worker_pool";let Qv=class Qv{constructor(){this.active={}}acquire(en){if(!this.workers)for(this.workers=[];this.workers.length<Qv.workerCount;)this.workers.push(new Hv);return this.active[en]=!0,this.workers.slice()}release(en){delete this.active[en],this.workers&&0===this.numActive()&&(this.workers.forEach(en=>{en.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[oa]}numActive(){return Object.keys(this.active).length}};function eb(){return eS||(eS=new Qv),eS}Qv.workerCount=2;let oc,of,om,o_=null;function ab(){return X()&&self.worker&&self.worker.dracoUrl?self.worker.dracoUrl:of||eC.DRACO_URL}let ob={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},ow={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},oT={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function pb(en,el,eu){let ec=eu.json.bufferViews.length,ed=eu.buffers.length;el.bufferView=ec,eu.json.bufferViews[ec]={buffer:ed,byteLength:en.byteLength},eu.buffers[ed]=en}let oM="KHR_draco_mesh_compression",oE=new TextDecoder("utf8");function gb(en,el){return new URL(en,el).href}function vb(en,el){let eu=en.json.bufferViews[el];return new Uint8Array(en.buffers[eu.buffer],eu.byteOffset||0,eu.byteLength)}function _b(en,el=0,eu){let ec={json:null,images:[],buffers:[]};if(1179937895===new Uint32Array(en,el,1)[0]){let eu=new Uint32Array(en,el),ed=2,ef=(eu[ed++]>>2)-3,em=eu[ed++]>>2;if(ed++,ec.json=JSON.parse(oE.decode(eu.subarray(ed,ed+em))),(ed+=em)<ef){let ef=eu[ed++];ed++;let em=el+(ed<<2);ec.buffers[0]=en.slice(em,em+ef)}}else ec.json=JSON.parse(oE.decode(new Uint8Array(en,el)));let{buffers:ed,images:ef,meshes:em,extensionsUsed:e_}=ec.json,ew=Promise.resolve();if(ed){let en=[];for(let el=0;el<ed.length;el++){let ef=ed[el];ef.uri?en.push(function(en,el,eu,ec){return fetch(gb(en.uri,ec)).then(en=>en.arrayBuffer()).then(en=>{el.buffers[eu]=en})}(ef,ec,el,eu)):ec.buffers[el]||(ec.buffers[el]=null)}ew=Promise.all(en)}return ew.then(()=>{let en=[],el=e_&&e_.includes(oM);if(el&&en.push(function(){if(!om)return oc||(oc=function(en){let el,eu=null;function n(){el=new Uint8Array(eu.buffer)}function i(){throw Error("Unexpected Draco error.")}let ec={a:{a:i,d:function(en,eu,ec){return el.copyWithin(en,eu,eu+ec)},c:function(en){let ec=el.length,ed=Math.max(en>>>0,Math.ceil(1.2*ec)),ef=Math.ceil((ed-ec)/65536);try{return eu.grow(ef),n(),!0}catch(en){return!1}},b:i}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(en,ec):en.then(en=>en.arrayBuffer()).then(en=>WebAssembly.instantiate(en,ec))).then(en=>{let ec,ed,ef,em;let{Rb:e_,Qb:ew,P:eT,T:eM,X:eE,Ja:eS,La:eA,Qa:eI,Va:eC,Wa:eP,eb:ez,jb:eD,f:eL,e:ek,yb:eR,zb:eO,Ab:eB,Bb:eF,Db:eN,Gb:eU}=en.instance.exports;eu=ek;let eV=(ec=0,ed=0,ef=0,em=0,en=>{ef&&(e_(em),e_(ec),ed+=ef,ef=ec=0),ec||(ed+=128,ec=ew(ed));let eu=en.length+7&-8,eT=ec;eu>=ed&&(ef=eu,eT=em=ew(eu));for(let eu=0;eu<en.length;eu++)el[eT+eu]=en[eu];return eT});return n(),eL(),{memory:ek,_free:e_,_malloc:ew,Mesh:class{constructor(){this.ptr=eT()}destroy(){eM(this.ptr)}},Decoder:class{constructor(){this.ptr=eS()}destroy(){eD(this.ptr)}DecodeArrayToMesh(en,el,eu){let ec=eV(en),ed=eA(this.ptr,ec,el,eu.ptr);return!!eE(ed)}GetAttributeByUniqueId(en,el){return{ptr:eI(this.ptr,en.ptr,el)}}GetTrianglesUInt16Array(en,el,eu){eC(this.ptr,en.ptr,el,eu)}GetTrianglesUInt32Array(en,el,eu){eP(this.ptr,en.ptr,el,eu)}GetAttributeDataArrayForAllPoints(en,el,eu,ec,ed){ez(this.ptr,en.ptr,el.ptr,eu,ec,ed)}},DT_INT8:eR(),DT_UINT8:eO(),DT_INT16:eB(),DT_UINT16:eF(),DT_UINT32:eN(),DT_FLOAT32:eU()}})}(fetch(ab()))).then(en=>{om=en,oc=void 0})}()),ef)for(let el=0;el<ef.length;el++)en.push(function(en,el,eu,ec){if(en.uri){let ed=gb(en.uri,ec);return fetch(ed).then(en=>en.blob()).then(en=>createImageBitmap(en)).then(en=>{el.images[eu]=en})}if(void 0!==en.bufferView){let ec=vb(el,en.bufferView),ed=new Blob([ec],{type:en.mimeType});return createImageBitmap(ed).then(en=>{el.images[eu]=en})}}(ef[el],ec,el,eu));return(en.length?Promise.all(en):Promise.resolve()).then(()=>{if(el&&em)for(let{primitives:en}of em)for(let el of en)!function(en,el){let eu=en.extensions&&en.extensions[oM];if(!eu)return;let ec=new om.Decoder,ed=vb(el,eu.bufferView),ef=new om.Mesh;if(!ec.DecodeArrayToMesh(ed,ed.byteLength,ef))throw Error("Failed to decode Draco mesh");let em=el.json.accessors[en.indices],e_=ob[em.componentType],ew=em.count*e_.BYTES_PER_ELEMENT,eT=om._malloc(ew);for(let ed of(e_===Uint16Array?ec.GetTrianglesUInt16Array(ef,ew,eT):ec.GetTrianglesUInt32Array(ef,ew,eT),pb(om.memory.buffer.slice(eT,eT+ew),em,el),om._free(eT),Object.keys(eu.attributes))){let em=ec.GetAttributeByUniqueId(ef,eu.attributes[ed]),e_=el.json.accessors[en.attributes[ed]],ew=ow[e_.componentType],eT=e_.count*oT[e_.type]*ob[e_.componentType].BYTES_PER_ELEMENT,eM=om._malloc(eT);ec.GetAttributeDataArrayForAllPoints(ef,em,om[ew],eT,eM),pb(om.memory.buffer.slice(eM,eM+eT),e_,el),om._free(eM)}ec.destroy(),ef.destroy(),delete en.extensions[oM]}(el,ec);return ec})})}let wb=class wb{constructor(en,el,eu){if(this.triangleCount=el.length/3,this.min=new eB(0,0),this.max=new eB(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],0===this.triangleCount||0===en.length||0===eu)return;let ec=en.map(en=>en.x),ed=en.map(en=>en.y);this.min=new eB(Math.min(...ec),Math.min(...ed)),this.max=new eB(Math.max(...ec),Math.max(...ed));let ef=this.max.sub(this.min);ef.x=Math.max(ef.x,1),ef.y=Math.max(ef.y,1);let em=Math.max(ef.x,ef.y)/eu;this.cellsX=Math.max(1,Math.ceil(ef.x/em)),this.cellsY=Math.max(1,Math.ceil(ef.y/em)),this.xScale=1/em,this.yScale=1/em;let e_=[];for(let eu=0;eu<this.triangleCount;eu++){let ec=en[el[3*eu+0]].sub(this.min),ed=en[el[3*eu+1]].sub(this.min),ef=en[el[3*eu+2]].sub(this.min),ew=Mb(Math.floor(Math.min(ec.x,ed.x,ef.x)),this.xScale,this.cellsX),eT=Mb(Math.floor(Math.max(ec.x,ed.x,ef.x)),this.xScale,this.cellsX),eM=Mb(Math.floor(Math.min(ec.y,ed.y,ef.y)),this.yScale,this.cellsY),eE=Mb(Math.floor(Math.max(ec.y,ed.y,ef.y)),this.yScale,this.cellsY),eS=new eB(0,0),eA=new eB(0,0),eI=new eB(0,0),eC=new eB(0,0);for(let en=eM;en<=eE;++en){eS.y=eA.y=en*em,eI.y=eC.y=(en+1)*em;for(let el=ew;el<=eT;++el)eS.x=eI.x=el*em,eA.x=eC.x=(el+1)*em,(Cp(ec,ed,ef,eS,eA,eC)||Cp(ec,ed,ef,eS,eC,eI))&&e_.push({cellIdx:en*this.cellsX+el,triIdx:eu})}}if(0===e_.length)return;e_.sort((en,el)=>en.cellIdx-el.cellIdx||en.triIdx-el.triIdx);let ew=0;for(;ew<e_.length;){let en=e_[ew].cellIdx,el={start:this.payload.length,len:0};for(;ew<e_.length&&e_[ew].cellIdx===en;)++el.len,this.payload.push(e_[ew++].triIdx);this.cells[en]=el}}query(en,el,eu){if(0===this.triangleCount||0===this.cells.length||en.x>this.max.x||this.min.x>el.x||en.y>this.max.y||this.min.y>el.y)return;this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8)));for(let en=0;en<this.lookup.length;en++)this.lookup[en]=0;let ec=Mb(en.x-this.min.x,this.xScale,this.cellsX),ed=Mb(el.x-this.min.x,this.xScale,this.cellsX),ef=Mb(en.y-this.min.y,this.yScale,this.cellsY),em=Mb(el.y-this.min.y,this.yScale,this.cellsY);for(let en=ef;en<=em;en++)for(let el=ec;el<=ed;el++){let ec=this.cells[en*this.cellsX+el];if(ec)for(let en=0;en<ec.len;en++){let el=this.payload[ec.start+en],ed=Math.floor(el/8),ef=1<<el%8;if(!(this.lookup[ed]&ef)&&(this.lookup[ed]|=ef,eu.push(el),eu.length===this.triangleCount))return}}}};function Mb(en,el,eu){return Math.max(0,Math.min(eu-1,Math.floor(en*el)))}function Ab(en,el){let eu=en.json.bufferViews[el.bufferView];return new ob[el.componentType](en.buffers[eu.buffer],(el.byteOffset||0)+(eu.byteOffset||0),el.count*oT[el.type])}function zb(el){let eu=function(en,el){let eu=[],ec=WebGL2RenderingContext;if(en.json.textures)for(let ed of en.json.textures){let ef={magFilter:ec.LINEAR,minFilter:ec.NEAREST,wrapS:ec.REPEAT,wrapT:ec.REPEAT};void 0!==ed.sampler&&Object.assign(ef,en.json.samplers[ed.sampler]),eu.push({image:el[ed.source],sampler:ef,uploaded:!1})}return eu}(el,el.images),ec=function(en,el){let eu=[];for(let ec of en.json.meshes){let ed=[];for(let eu of ec.primitives)ed.push(function(en,el,eu){let ec=en.indices,ed=en.attributes,ef={};ef.indexArray=new ao;let em=el.json.accessors[ec],e_=em.count/3;ef.indexArray.reserve(e_);let ew=Ab(el,em);for(let en=0;en<e_;en++)ef.indexArray.emplaceBack(ew[3*en],ew[3*en+1],ew[3*en+2]);ef.indexArray._trim(),ef.vertexArray=new mo;let eT=el.json.accessors[ed.POSITION];ef.vertexArray.reserve(eT.count);let eM=Ab(el,eT);for(let en=0;en<eT.count;en++)ef.vertexArray.emplaceBack(eM[3*en],eM[3*en+1],eM[3*en+2]);if(ef.vertexArray._trim(),ef.aabb=new oh(eT.min,eT.max),ef.centroid=function(en,el){let eu=[0,0,0],ec=en.length;if(ec>0){for(let ed=0;ed<ec;ed++){let ec=3*en[ed];eu[0]+=el[ec],eu[1]+=el[ec+1],eu[2]+=el[ec+2]}eu[0]/=ec,eu[1]/=ec,eu[2]/=ec}return eu}(ew,eM),void 0!==ed.COLOR_0){let en=el.json.accessors[ed.COLOR_0],eu=oT[en.type];if(5126===en.componentType){ef.colorArray=3===eu?new mo:new Xa,ef.colorArray.reserve(en.count);let ec=Ab(el,en);if(3===eu)for(let el=0;el<en.count;el++)ef.colorArray.emplaceBack(ec[3*el],ec[3*el+1],ec[3*el+2]);else for(let el=0;el<en.count;el++)ef.colorArray.emplaceBack(ec[4*el],ec[4*el+1],ec[4*el+2],ec[4*el+3]);ef.colorArray._trim()}else if(5123===en.componentType&&4===eu){ef.colorArray=new Xa,ef.colorArray.resize(en.count);let eu=Ab(el,en),ec=1/65535,ed=ef.colorArray.float32;for(let en=0;en<4*eu.length;++en)ed[en]=eu[en]*ec}else q(`glTF color buffer parsing for accessor ${JSON.stringify(en)} is not supported`)}if(void 0!==ed.NORMAL){ef.normalArray=new mo;let en=el.json.accessors[ed.NORMAL];ef.normalArray.reserve(en.count);let eu=Ab(el,en);for(let el=0;el<en.count;el++)ef.normalArray.emplaceBack(eu[3*el],eu[3*el+1],eu[3*el+2]);ef.normalArray._trim()}if(void 0!==ed.TEXCOORD_0&&eu.length>0){ef.texcoordArray=new yo;let en=el.json.accessors[ed.TEXCOORD_0];ef.texcoordArray.reserve(en.count);let eu=Ab(el,en);for(let el=0;el<en.count;el++)ef.texcoordArray.emplaceBack(eu[2*el],eu[2*el+1]);ef.texcoordArray._trim()}let eE=en.material;return ef.material=function(en,el){let{emissiveFactor:eu=[0,0,0],alphaMode:ec="OPAQUE",alphaCutoff:ed=.5,normalTexture:ef,occlusionTexture:em,emissiveTexture:e_,doubleSided:ew}=en,{baseColorFactor:eT=[1,1,1,1],metallicFactor:eM=1,roughnessFactor:eE=1,baseColorTexture:eS,metallicRoughnessTexture:eA}=en.pbrMetallicRoughness||{};return{pbrMetallicRoughness:{baseColorFactor:new Ce(...eT),metallicFactor:eM,roughnessFactor:eE,baseColorTexture:eS?el[eS.index]:void 0,metallicRoughnessTexture:eA?el[eA.index]:void 0},doubleSided:ew,emissiveFactor:eu,alphaMode:ec,alphaCutoff:ed,normalTexture:ef?el[ef.index]:void 0,occlusionTexture:em?el[em.index]:void 0,emissionTexture:e_?el[e_.index]:void 0,defined:void 0===en.defined}}(void 0!==eE?el.json.materials[eE]:{defined:!1},eu),void 0!==ed._FEATURE_RGBA4444&&(ef.featureData=new Uint32Array(Ab(el,el.json.accessors[ed._FEATURE_RGBA4444]).buffer)),ef}(eu,en,el));eu.push(ed)}return eu}(el,eu),{scenes:ed,scene:ef,nodes:em}=el.json,e_=ed?ed[ef||0].nodes:em,ew=[];for(let eu of e_)ew.push(function Ib(el,eu,ec){let{matrix:ed,rotation:ef,translation:em,scale:e_,mesh:ew,extras:eT,children:eM}=el,eE={};if(eE.matrix=ed||en.m.fromRotationTranslationScale([],ef||[0,0,0,1],em||[0,0,0],e_||[1,1,1]),void 0!==ew){eE.meshes=ec[ew];let en=eE.anchor=[0,0];for(let el of eE.meshes){let{min:eu,max:ec}=el.aabb;en[0]+=eu[0]+ec[0],en[1]+=eu[1]+ec[1]}en[0]=Math.floor(en[0]/eE.meshes.length/2),en[1]=Math.floor(en[1]/eE.meshes.length/2)}if(eT&&(eT.id&&(eE.id=eT.id),eT.lights&&(eE.lights=function(en){if(!en.length)return[];let el=function(en){let el=atob(en),eu=new Uint8Array(el.length);for(let en=0;en<el.length;en++)eu[en]=el.codePointAt(en);return eu}(en),eu=[],ec=el.length/24,ed=new Uint16Array(el.buffer),ef=new Float32Array(el.buffer);for(let en=0;en<ec;en++){let el=ed[2*en*6]/30,ec=ed[2*en*6+1]/30,em=ed[2*en*6+10]/100,e_=ef[6*en+1],ew=ef[6*en+2],eT=ef[6*en+3],eM=ef[6*en+4],eE=eT-e_,eS=eM-ew,eA=Math.hypot(eE,eS);eu.push({pos:[e_+.5*eE,ew+.5*eS,ec],normal:[eS/eA,-eE/eA,0],width:eA,height:el,depth:em,points:[e_,ew,eT,eM]})}return eu}(eT.lights))),eM){let en=[];for(let el of eM)en.push(Ib(eu.json.nodes[el],eu,ec));eE.children=en}return eE}(em[eu],el,ec));return function(en,el,eu){let ec={},ed=new Set;for(let ef=0;ef<en.length;ef++){let en=eu[el[ef]];if(!en.extras)continue;let em=en.extras["mapbox:footprint:version"],e_=en.extras["mapbox:footprint:id"];(em||e_)&&ed.add(ef),"1.0.0"===em&&e_&&(ec[e_]=ef)}for(let ef=0;ef<en.length;ef++){if(ed.has(ef))continue;let em=en[ef],e_=eu[el[ef]];if(!e_.extras)continue;let ew=null;em.id in ec&&(ew=function(en){let el=[],eu=[],ec=0;for(let ed of en){ec=el.length;let en=ed.vertexArray.float32,ef=ed.indexArray.uint16;for(let eu=0;eu<ed.vertexArray.length;eu++)el.push(new eB(en[3*eu+0],en[3*eu+1]));for(let en=0;en<3*ed.indexArray.length;en++)eu.push(ef[en]+ec)}if(eu.length%3!=0)return null;for(let en=0;en<eu.length;en+=3){let ec=el[eu[en+0]],ed=el[eu[en+1]],ef=el[eu[en+2]];(ec.x-ed.x)*(ef.y-ed.y)-(ef.x-ed.x)*(ec.y-ed.y)>0&&([eu[en+1],eu[en+2]]=[eu[en+2],eu[en+1]])}return{vertices:el,indices:eu}}(en[ec[em.id]].meshes)),ew||(ew=function(en){if(!en.extras||!en.extras.ground)return null;let el=en.extras.ground;if(!el||!Array.isArray(el)||0===el.length)return null;let eu=el[0];if(!eu||!Array.isArray(eu)||0===eu.length)return null;let ec=[];for(let en of eu){if(!Array.isArray(en)||2!==en.length)continue;let el=en[0],eu=en[1];"number"==typeof el&&"number"==typeof eu&&ec.push(new eB(el,eu))}if(ec.length<3)return null;ec.length>1&&ec[ec.length-1].equals(ec[0])&&ec.pop();let ed=0;for(let en=0;en<ec.length;en++){let el=ec[en],eu=ec[(en+1)%ec.length],ef=ec[(en+2)%ec.length];ed+=(el.x-eu.x)*(ef.y-eu.y)-(ef.x-eu.x)*(el.y-eu.y)}ed>0&&ec.reverse();let ef=aP(ec.flatMap(en=>[en.x,en.y]),[]);return 0===ef.length?null:{vertices:ec,indices:ef}}(e_)),ew&&(em.footprint=function(en){if(0===en.vertices.length||0===en.indices.length)return null;let[el,eu]=[en.vertices[0].clone(),en.vertices[0].clone()];for(let ec=1;ec<en.vertices.length;++ec){let ed=en.vertices[ec];el.x=Math.min(el.x,ed.x),el.y=Math.min(el.y,ed.y),eu.x=Math.max(eu.x,ed.x),eu.y=Math.max(eu.y,ed.y)}let ec=Math.ceil(Math.max(eu.x-el.x,eu.y-el.y)/256),ed=Math.max(8,ec),ef=new wb(en.vertices,en.indices,ed);return{vertices:en.vertices,indices:en.indices,grid:ef,min:el,max:eu}}(ew))}if(ed.size>0){let el=Array.from(ed.values()).sort((en,el)=>en-el);for(let eu=el.length-1;eu>=0;eu--)en.splice(el[eu],1)}}(ew,e_,el.json.nodes),ew}Ks(wb,"TriangleGridIndex");let oS=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];let Cb=class Cb{static from(en){if(!(en instanceof ArrayBuffer))throw Error("Data must be an instance of ArrayBuffer.");let[el,eu]=new Uint8Array(en,0,2);if(219!==el)throw Error("Data does not appear to be in a KDBush format.");let ec=eu>>4;if(1!==ec)throw Error(`Got v${ec} data when expected v1.`);let ed=oS[15&eu];if(!ed)throw Error("Unrecognized array type.");let[ef]=new Uint16Array(en,2,1),[em]=new Uint32Array(en,4,1);return new Cb(em,ef,ed,en)}constructor(en,el=64,eu=Float64Array,ec){if(isNaN(en)||en<0)throw Error(`Unpexpected numItems value: ${en}.`);this.numItems=+en,this.nodeSize=Math.min(Math.max(+el,2),65535),this.ArrayType=eu,this.IndexArrayType=en<65536?Uint16Array:Uint32Array;let ed=oS.indexOf(this.ArrayType),ef=2*en*this.ArrayType.BYTES_PER_ELEMENT,em=en*this.IndexArrayType.BYTES_PER_ELEMENT,e_=(8-em%8)%8;if(ed<0)throw Error(`Unexpected typed array class: ${eu}.`);ec&&ec instanceof ArrayBuffer?(this.data=ec,this.ids=new this.IndexArrayType(this.data,8,en),this.coords=new this.ArrayType(this.data,8+em+e_,2*en),this._pos=2*en,this._finished=!0):(this.data=new ArrayBuffer(8+ef+em+e_),this.ids=new this.IndexArrayType(this.data,8,en),this.coords=new this.ArrayType(this.data,8+em+e_,2*en),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+ed]),new Uint16Array(this.data,2,1)[0]=el,new Uint32Array(this.data,4,1)[0]=en)}add(en,el){let eu=this._pos>>1;return this.ids[eu]=eu,this.coords[this._pos++]=en,this.coords[this._pos++]=el,eu}finish(){let en=this._pos>>1;if(en!==this.numItems)throw Error(`Added ${en} items when expected ${this.numItems}.`);return function Rb(en,el,eu,ec,ed,ef){if(ed-ec<=eu)return;let em=ec+ed>>1;(function Lb(en,el,eu,ec,ed,ef){for(;ed>ec;){if(ed-ec>600){let em=ed-ec+1,e_=eu-ec+1,ew=Math.log(em),eT=.5*Math.exp(2*ew/3),eM=.5*Math.sqrt(ew*eT*(em-eT)/em)*(e_-em/2<0?-1:1);Lb(en,el,eu,Math.max(ec,Math.floor(eu-e_*eT/em+eM)),Math.min(ed,Math.floor(eu+(em-e_)*eT/em+eM)),ef)}let em=el[2*eu+ef],e_=ec,ew=ed;for(Vb(en,el,ec,eu),el[2*ed+ef]>em&&Vb(en,el,ec,ed);e_<ew;){for(Vb(en,el,e_,ew),e_++,ew--;el[2*e_+ef]<em;)e_++;for(;el[2*ew+ef]>em;)ew--}el[2*ec+ef]===em?Vb(en,el,ec,ew):Vb(en,el,++ew,ed),ew<=eu&&(ec=ew+1),eu<=ew&&(ed=ew-1)}})(en,el,em,ec,ed,ef),Rb(en,el,eu,ec,em-1,1-ef),Rb(en,el,eu,em+1,ed,1-ef)}(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(en,el,eu,ec){if(!this._finished)throw Error("Data not yet indexed - call index.finish().");let{ids:ed,coords:ef,nodeSize:em}=this,e_=[0,ed.length-1,0],ew=[];for(;e_.length;){let eT=e_.pop()||0,eM=e_.pop()||0,eE=e_.pop()||0;if(eM-eE<=em){for(let em=eE;em<=eM;em++){let e_=ef[2*em],eT=ef[2*em+1];e_>=en&&e_<=eu&&eT>=el&&eT<=ec&&ew.push(ed[em])}continue}let eS=eE+eM>>1,eA=ef[2*eS],eI=ef[2*eS+1];eA>=en&&eA<=eu&&eI>=el&&eI<=ec&&ew.push(ed[eS]),(0===eT?en<=eA:el<=eI)&&(e_.push(eE),e_.push(eS-1),e_.push(1-eT)),(0===eT?eu>=eA:ec>=eI)&&(e_.push(eS+1),e_.push(eM),e_.push(1-eT))}return ew}within(en,el,eu){if(!this._finished)throw Error("Data not yet indexed - call index.finish().");let{ids:ec,coords:ed,nodeSize:ef}=this,em=[0,ec.length-1,0],e_=[],ew=eu*eu;for(;em.length;){let eT=em.pop()||0,eM=em.pop()||0,eE=em.pop()||0;if(eM-eE<=ef){for(let eu=eE;eu<=eM;eu++)Fb(ed[2*eu],ed[2*eu+1],en,el)<=ew&&e_.push(ec[eu]);continue}let eS=eE+eM>>1,eA=ed[2*eS],eI=ed[2*eS+1];Fb(eA,eI,en,el)<=ew&&e_.push(ec[eS]),(0===eT?en-eu<=eA:el-eu<=eI)&&(em.push(eE),em.push(eS-1),em.push(1-eT)),(0===eT?en+eu>=eA:el+eu>=eI)&&(em.push(eS+1),em.push(eM),em.push(1-eT))}return e_}};function Vb(en,el,eu,ec){Ob(en,eu,ec),Ob(el,2*eu,2*ec),Ob(el,2*eu+1,2*ec+1)}function Ob(en,el,eu){let ec=en[el];en[el]=en[eu],en[eu]=ec}function Fb(en,el,eu,ec){let ed=en-eu,ef=el-ec;return ed*ed+ef*ef}en.$=45,en.A=ai,en.B=function(el){let eu=en.m.identity(new Float64Array(16));en.m.multiply(eu,el.pixelMatrix,el.globeMatrix);let ec=[0,r1,0],ed=[0,rQ,0];return en.v.transformMat4(ec,ec,eu),en.v.transformMat4(ed,ed,eu),[ec[0]>0&&ec[0]<=el.width&&ec[1]>0&&ec[1]<=el.height&&!jh(el,new r9(el.center.lat,90)),ed[0]>0&&ed[0]<=el.width&&ed[1]>0&&ed[1]<=el.height&&!jh(el,new r9(el.center.lat,-90))]},en.C=Ce,en.D=vl,en.E=Hh,en.F=ah,en.G=6,en.H=Jh,en.I=Cg,en.J=8192,en.K=function(el,eu){let{scale:ec}=el.tileTransform,ed=8192*ec/(el.tileSize*Math.pow(2,eu.zoom-el.tileID.overscaledZ+el.tileID.canonical.z));return en.h.scale(new Float32Array(4),eu.inverseAdjustmentMatrix,[ed,ed])},en.L=r9,en.M=lp,en.N=ex,en.O=Hc,en.P=eB,en.Q=Qg,en.R=th,en.S=function(el){let eu=Qg(el,!0);return en.h.invert([],[eu[0],eu[1],eu[4],eu[5]])},en.T=eh,en.U=Wc,en.V=function(en){let{x:el,y:eu}=en.point,{lng:ec,lat:ed}=en._center;return Vh(el,eu,en.worldSize,ec,ed)},en.W=a4,en.X=q,en.Y=function(en){return en*eN},en.Z=5,en._=function(en){let el=Math.round((en+45+360)%360/90)%4;return eU[el]},en.a=Og,en.a$=Ko,en.a0=Wh,en.a1=function(en,el){return ft(B(en,{type:"json"}),el)},en.a2=eX,en.a3=vt,en.a4=ta,en.a5=Qp,en.a6=ee,en.a7=te,en.a8=Qt,en.a9=_g,en.aA=zp,en.aB=cp,en.aC=rQ,en.aD=Xv,en.aE=Ra,en.aF=Kv,en.aG=function(en){++eH>eW&&(en.getActor().send("enforceCacheSizeLimit",e$),eH=0)},en.aH=e2,en.aI=Kt,en.aJ=function(en){return en<=1?1:Math.pow(2,Math.floor(Math.log(en)/Math.LN2))},en.aK=Bv,en.aL=function(en,el){let eu=document.createElement("video");eu.muted=!0,eu.onloadstart=function(){el(null,eu)};for(let el=0;el<en.length;el++){let ec=document.createElement("source");(function(en){let el=document.createElement("a");return el.href=en,el.protocol===location.protocol&&el.host===location.host})(en[el])||(eu.crossOrigin="Anonymous"),ec.src=en[el],eu.appendChild(ec)}return{cancel:()=>{}}},en.aM=ne,en.aN=wg,en.aO=function(en){return fetch(en).then(en=>en.arrayBuffer()).then(el=>_b(el,0,en))},en.aP=zb,en.aQ=class{constructor(en,el,eu,ec){this.id=en,this.position=null!=el?new r9(el[0],el[1]):new r9(0,0),this.orientation=null!=eu?eu:[0,0,0],this.nodes=ec,this.uploaded=!1,this.aabb=new oh([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(el,eu){if(en.m.multiply(el.matrix,eu,el.matrix),el.meshes)for(let en of el.meshes){let eu=oh.applyTransform(en.aabb,el.matrix);this.aabb.encapsulate(eu)}if(el.children)for(let en of el.children)this._applyTransformations(en,el.matrix)}computeBoundsAndApplyParent(){let el=en.m.identity([]);for(let en of this.nodes)this._applyTransformations(en,el)}_positionModelOnTerrain(el,eu){let ec=el.elevation;if(!ec)return 0;let ed=oh.projectAabbCorners(this.aabb,this.matrix),ef=1/Wh(this.position.lat)*el.worldSize,em=function(el,eu){let ec=[0,0,1],ed=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(let ef of ed){let ed=el[ef.corners[0]],em=el[ef.corners[1]],e_=el[ef.corners[2]],ew=[em[0]-ed[0],em[1]-ed[1],eu*(em[2]-ed[2])],eT=en.v.cross(ew,ew,[e_[0]-ed[0],e_[1]-ed[1],eu*(e_[2]-ed[2])]);en.v.normalize(eT,eT),ef.dotProductWithUp=en.v.dot(eT,ec)}return ed.sort((en,el)=>en.dotProductWithUp-el.dotProductWithUp),ed[0].corners}(ed,ef),e_=ed[em[0]],ew=ed[em[1]],eT=ed[em[2]],eM=ed[em[3]],eE=ec.getAtPointOrZero(new lp(e_[0]/el.worldSize,e_[1]/el.worldSize),0),eS=ec.getAtPointOrZero(new lp(ew[0]/el.worldSize,ew[1]/el.worldSize),0),eA=ec.getAtPointOrZero(new lp(eT[0]/el.worldSize,eT[1]/el.worldSize),0),eI=ec.getAtPointOrZero(new lp(eM[0]/el.worldSize,eM[1]/el.worldSize),0),eC=(eE+eI)/2,eP=(eS+eA)/2;return eC>eP?eS<eA?ox(eu,ew,eM,e_,eS,eI,eE,ef):ox(eu,eT,e_,eM,eA,eE,eI,ef):eE<eI?ox(eu,e_,ew,eT,eE,eS,eA,ef):ox(eu,eM,eT,ew,eI,eA,eS,ef),Math.max(eC,eP)}computeModelMatrix(el,eu,ec,ed,ef,em,e_=!1){let ew=el.transform,eT=ew.zoom,eM=ew.project(this.position),eE=sp(this.position.lat,eT),eS=1/eE;en.m.identity(this.matrix),en.m.translate(this.matrix,this.matrix,[eM.x+ed[0]*eS,eM.y+ed[1]*eS,ed[2]]);let eA=1,eI=1,eC=ew.worldSize;if(e_){if("mercator"===ew.projection.name){let el=0;ew.elevation&&(el=ew.elevation.getAtPointOrZero(new lp(eM.x/eC,eM.y/eC),0));let eu=en.e.transformMat4([],[eM.x,eM.y,el,1],ew.projMatrix)[3]/ew.cameraToCenterDistance;eA=eu,eI=eu*sp(ew.center.lat,eT)}else if("globe"===ew.projection.name){let el=lx(this.matrix,ew),eu=en.m.multiply([],ew.projMatrix,el),ec=[0,0,0,1];en.e.transformMat4(ec,ec,eu);let ed=ec[3]/ew.cameraToCenterDistance,ef=Oh(eT),em=ew.projection.pixelsPerMeter(this.position.lat,eC)*sp(this.position.lat,eT),e_=ew.projection.pixelsPerMeter(ew.center.lat,eC)*sp(ew.center.lat,eT);eA=ed/Mn(em,ip(ew.center.lat),ef),eI=ed*eE/em,eA*=e_,eI*=e_}}else eA=eS;en.m.scale(this.matrix,this.matrix,[eA,eA,eI]);let eP=[...this.matrix],ez=this.orientation,eD=[];if(ax(eD,[ez[0]+eu[0],ez[1]+eu[1],ez[2]+eu[2]],ec),en.m.multiply(this.matrix,eP,eD),ef&&ew.elevation){let el=0,eu=[];if(em&&ew.elevation){el=this._positionModelOnTerrain(ew,eu);let ec=en.m.fromQuat([],eu),ed=en.m.multiply([],ec,eD);en.m.multiply(this.matrix,eP,ed)}else el=ew.elevation.getAtPointOrZero(new lp(eM.x/eC,eM.y/eC),0);0!==el&&(this.matrix[14]+=el)}}upload(en){if(!this.uploaded){for(let el of this.nodes)fx(el,en);for(let en of this.nodes)dx(en);this.uploaded=!0}}destroy(){for(let en of this.nodes)mx(en)}},en.aR=O,en.aS=["type","source","source-layer","minzoom","maxzoom","filter","layout"],en.aT=Xm,en.aU=_p,en.aV=24,en.aW=xy,en.aX=by,en.aY=Lm,en.aZ=Cb,en.a_=rl,en.aa=Km,en.ab=Hm,en.ac=Da,en.ad=za,en.ae=tc,en.af=class{constructor(en){this.specification=en}possiblyEvaluate(en,el){return Z(en.expression.evaluate(el))}interpolate(en,el,eu){return{x:Mn(en.x,el.x,eu),y:Mn(en.y,el.y,eu),z:Mn(en.z,el.z,eu),azimuthal:Mn(en.azimuthal,el.azimuthal,eu),polar:Mn(en.polar,el.polar,eu)}}},en.ag=Aa,en.ah=en=>Ns(Es(en)),en.ai=$s,en.aj=Fs,en.ak=B,en.al=_a,en.am=Wi,en.an=T,en.ao=Oh,en.ap=en=>Ns(Cs(en)),en.aq=An,en.ar=Pa,en.as=class{constructor(en){this.specification=en}possiblyEvaluate(en,el){return function([en,el]){let eu=Z([1,en,el]);return{x:eu.x,y:eu.y,z:eu.z}}(en.expression.evaluate(el))}interpolate(en,el,eu){return{x:Mn(en.x,el.x,eu),y:Mn(en.y,el.y,eu),z:Mn(en.z,el.z,eu)}}},en.at=function(en,el,eu=0,ec=!0){let ed=new eB(eu,eu),ef=en.sub(ed),em=el.add(ed),e_=[ef,new eB(em.x,ef.y),em,new eB(ef.x,em.y)];return ec&&e_.push(ef.clone()),e_},en.au=function(en,el){let eu=[];for(let ec=0;ec<en.length;ec++){let ed=P(ec-1,-1,en.length-1),ef=P(ec+1,-1,en.length-1),em=en[ec],e_=en[ef],ew=en[ed].sub(em).unit(),eT=e_.sub(em).unit(),eM=eT.angleWithSep(ew.x,ew.y),eE=ew.add(eT).unit().mult(-1*el/Math.sin(eM/2));eu.push(em.add(eE))}return eu},en.av=Ey,en.aw=Ep,en.ax=function(el,eu,ec=0){return en.v.fromValues(((eu.x-ec)*el.scale-el.x)*8192,(eu.y*el.scale-el.y)*8192,eu.z*Wh(ep(eu.y)))},en.ay=sx,en.az=function(en){let el=1/0,eu=1/0,ec=-1/0,ed=-1/0;for(let ef of en)el=Math.min(el,ef.x),eu=Math.min(eu,ef.y),ec=Math.max(ec,ef.x),ed=Math.max(ed,ef.y);return{min:new eB(el,eu),max:new eB(ec,ed)}},en.b=function(en,el){return en/Wh(el)},en.b$=0,en.b0=Ho,en.b1=tl,en.b2=Wo,en.b3=function(en,el,eu){let ec=Math.sqrt(en*en+el*el+eu*eu),ed=ec>0?Math.acos(eu/ec)*eN:0,ef=0!==en||0!==el?Math.atan2(-el,-en)*eN+90:0;return ef<0&&(ef+=360),[ec,ef,ed]},en.b4=Rg,en.b5=Ug,en.b6=Vg,en.b7=Jo,en.b8=class extends Xo{constructor(en){super(en),this.current=iF}set(en,el,eu){if(this.fetchUniformLocation(en,el)){for(let en=0;en<9;en++)if(eu[en]!==this.current[en]){this.current=eu,this.gl.uniformMatrix3fv(this.location,!1,eu);break}}}},en.b9=Qo,en.bA=function(el,eu){let ec=[0,0,0],ed=Dh(_h(eu.canonical));return en.v.transformMat4(ec,ec,ed),en.v.transformMat4(ec,ec,el),ec},en.bB=en=>({u_camera_to_center_distance:new Wo(en),u_extrude_scale:new sl(en),u_device_pixel_ratio:new Wo(en),u_matrix:new rl(en),u_inv_rot_matrix:new rl(en),u_merc_center:new Ho(en),u_tile_id:new Jo(en),u_zoom_transition:new Wo(en),u_up_dir:new Jo(en),u_emissive_strength:new Wo(en)}),en.bC=en=>({u_matrix:new rl(en),u_pixels_to_tile_units:new sl(en),u_device_pixel_ratio:new Wo(en),u_units_to_pixels:new Ho(en),u_dash_image:new Ko(en),u_gradient_image:new Ko(en),u_image_height:new Wo(en),u_texsize:new Ho(en),u_tile_units_to_pixels:new Wo(en),u_alpha_discard_threshold:new Wo(en),u_trim_offset:new Ho(en),u_emissive_strength:new Wo(en)}),en.bD=en=>({u_matrix:new rl(en),u_texsize:new Ho(en),u_pixels_to_tile_units:new sl(en),u_device_pixel_ratio:new Wo(en),u_image:new Ko(en),u_units_to_pixels:new Ho(en),u_tile_units_to_pixels:new Wo(en),u_alpha_discard_threshold:new Wo(en)}),en.bE=io,en.bF=a1,en.bG=a2,en.bH=Np,en.bI=(en,el,eu,ec,ed,ef)=>{let em;let e_=en.transform,ew="globe"===e_.projection.name;if("map"===ef.paint.get("circle-pitch-alignment")){if(ew){let en=Lh(e_.zoom,el.canonical)*e_._pixelsPerMercatorPixel;em=Float32Array.from([en,0,0,en])}else em=e_.calculatePixelsToTileUnitsMatrix(eu)}else em=new Float32Array([e_.pixelsToGLUnits[0],0,0,e_.pixelsToGLUnits[1]]);let eT={u_camera_to_center_distance:en.transform.getCameraToCenterDistance(e_.projection),u_matrix:en.translatePosMatrix(el.projMatrix,eu,ef.paint.get("circle-translate"),ef.paint.get("circle-translate-anchor")),u_device_pixel_ratio:ta.devicePixelRatio,u_extrude_scale:em,u_inv_rot_matrix:am,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:ef.paint.get("circle-emissive-strength")};if(ew){eT.u_inv_rot_matrix=ec,eT.u_merc_center=ed,eT.u_tile_id=[el.canonical.x,el.canonical.y,1<<el.canonical.z],eT.u_zoom_transition=Oh(e_.zoom);let en=8192*ed[0],eu=8192*ed[1];eT.u_up_dir=e_.projection.upVector(new Kc(0,0,0),en,eu)}return eT},en.bJ=_v,en.bK=(en,el,eu,ec,ed)=>{let ef=en.transform;return{u_matrix:bv(en,el,eu,ec),u_texsize:el.imageAtlasTexture?el.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:ef.calculatePixelsToTileUnitsMatrix(el),u_device_pixel_ratio:ed,u_image:0,u_tile_units_to_pixels:vv(el,ef),u_units_to_pixels:[1/ef.pixelsToGLUnits[0],1/ef.pixelsToGLUnits[1]],u_alpha_discard_threshold:0}},en.bL=(en,el,eu,ec,ed,ef,em)=>{let e_=en.transform,ew=e_.calculatePixelsToTileUnitsMatrix(el);return{u_matrix:bv(en,el,eu,ec),u_pixels_to_tile_units:ew,u_device_pixel_ratio:ef,u_units_to_pixels:[1/e_.pixelsToGLUnits[0],1/e_.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:ed,u_texsize:wv(eu)&&el.lineAtlasTexture?el.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:vv(el,en.transform),u_alpha_discard_threshold:0,u_trim_offset:em,u_emissive_strength:eu.paint.get("line-emissive-strength")}},en.bM=L,en.bN=nf,en.bO=lv,en.bP=rY,en.bQ=tv,en.bR=2147483648,en.bS=450,en.bT=7,en.bU=Mh,en.bV=Ch,en.bW=Ua,en.bX=mo,en.bY=co,en.bZ=1,en.b_=771,en.ba=A,en.bb=function(en,el,eu){let ec=Oh(eu.zoom),ed=en.style.map._antialias,ef=el.options.extStandardDerivativesForceOff||en.terrain&&en.terrain.exaggeration()>0;return 0===ec&&!ed&&!ef},en.bc=function(el){let eu=el.pixelsPerMeter,ec=eu/(1/Wh(el.center.lat)),ed=en.m.identity(new Float64Array(16));return en.m.translate(ed,ed,[el.point.x,el.point.y,0]),en.m.scale(ed,ed,[ec,ec,eu]),Float32Array.from(ed)},en.bd=se,en.be=Ih,en.bf=function(en){let el=ai-5;en=k(en,-el,el)/el*90;let eu=Math.pow(Math.abs(Math.sin(en*eF)),3);return Math.round(eu*(r0.length-1))},en.bg=function(el,eu,ec,ed){let ef=eu.getNorth(),em=eu.getSouth(),e_=eu.getWest(),ew=eu.getEast(),eT=1<<el.z,eM=ew-e_,eE=ef-em,eS=eM/64,eA=-eE/r0[ec],eI=[0,eS,0,eA,0,0,ef,e_,0];if(el.z>0){let el=180/ed;en.bx.multiply(eI,eI,[el/eM+1,0,0,0,el/eE+1,0,-.5*el/eS,.5*el/eA,1])}return eI[2]=eT,eI[5]=el.x,eI[8]=el.y,eI},en.bh=Dh,en.bi=_h,en.bj=function(el,eu,ec){let ed=en.m.identity(new Float64Array(16)),ef=(eu/(1<<el)-.5)*Math.PI*2;return en.m.rotateY(ed,ec.globeMatrix,ef),Float32Array.from(ed)},en.bk=class{isDataAvailableAtPoint(en){let el=this._source();if(this.isUsingMockSource()||!el||en.y<0||en.y>1)return!1;let eu=el.getSource().maxzoom,ec=1<<eu,ed=Math.floor(en.x),ef=Math.floor((en.x-ed)*ec),em=Math.floor(en.y*ec),e_=this.findDEMTileFor(new Hc(eu,ed,eu,ef,em));return!(!e_||!e_.dem)}getAtPointOrZero(en,el=0){return this.getAtPoint(en,el)||0}getAtPoint(en,el,eu=!0){if(this.isUsingMockSource())return null;null==el&&(el=null);let ec=this._source();if(!ec||en.y<0||en.y>1)return el;let ed=ec.getSource().maxzoom,ef=1<<ed,em=Math.floor(en.x),e_=en.x-em,ew=new Hc(ed,em,ed,Math.floor(e_*ef),Math.floor(en.y*ef)),eT=this.findDEMTileFor(ew);if(!eT||!eT.dem)return el;let eM=eT.dem,eE=1<<eT.tileID.canonical.z,eS=(e_*eE-eT.tileID.canonical.x)*eM.dim,eA=(en.y*eE-eT.tileID.canonical.y)*eM.dim,eI=Math.floor(eS),eC=Math.floor(eA);return(eu?this.exaggeration():1)*Mn(Mn(eM.get(eI,eC),eM.get(eI,eC+1),eA-eC),Mn(eM.get(eI+1,eC),eM.get(eI+1,eC+1),eA-eC),eS-eI)}getAtTileOffset(en,el,eu){let ec=1<<en.canonical.z;return this.getAtPointOrZero(new lp(en.wrap+(en.canonical.x+el/8192)/ec,(en.canonical.y+eu/8192)/ec))}getAtTileOffsetFunc(el,eu,ec,ed){return ef=>{let em=this.getAtTileOffset(el,ef.x,ef.y),e_=ed.upVector(el.canonical,ef.x,ef.y),ew=ed.upVectorScale(el.canonical,eu,ec).metersToTile;return en.v.scale(e_,e_,em*ew),e_}}getForTilePoints(en,el,eu,ec){if(this.isUsingMockSource())return!1;let ed=Wd.create(this,en,ec);return!!ed&&(el.forEach(en=>{en[2]=this.exaggeration()*ed.getElevationAt(en[0],en[1],eu)}),!0)}getMinMaxForTile(en){if(this.isUsingMockSource())return null;let el=this.findDEMTileFor(en);if(!el||!el.dem)return null;let eu=el.dem.tree,ec=el.tileID,ed=1<<en.canonical.z-ec.canonical.z,ef=en.canonical.x/ed-ec.canonical.x,em=en.canonical.y/ed-ec.canonical.y,e_=0;for(let el=0;el<en.canonical.z-ec.canonical.z&&!eu.leaves[e_];el++){ef*=2,em*=2;let en=2*Math.floor(em)+Math.floor(ef);e_=eu.childOffsets[e_]+en,ef%=1,em%=1}return{min:this.exaggeration()*eu.minimums[e_],max:this.exaggeration()*eu.maximums[e_]}}getMinElevationBelowMSL(){throw Error("Pure virtual method called.")}raycast(en,el,eu){throw Error("Pure virtual method called.")}pointCoordinate(en){throw Error("Pure virtual method called.")}_source(){throw Error("Pure virtual method called.")}isUsingMockSource(){throw Error("Pure virtual method called.")}exaggeration(){throw Error("Pure virtual method called.")}findDEMTileFor(en){throw Error("Pure virtual method called.")}get visibleDemTiles(){throw Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){let en=this.visibleDemTiles;if(0===en.length)return null;let el=!1,eu=Number.MAX_VALUE,ec=Number.MIN_VALUE;for(let ed of en){let en=this.getMinMaxForTile(ed.tileID);en&&(eu=Math.min(eu,en.min),ec=Math.max(ec,en.max),el=!0)}return el?{min:eu,max:ec}:null}},en.bl=rK,en.bm=Do,en.bn=gh,en.bo=$a,en.bp=ao,en.bq=Ng,en.br=Nv,en.bs=eb,en.bt=Bg,en.bu=tf,en.bv=function(en,el){return[Math.pow(en[0],2.2)*el,Math.pow(en[1],2.2)*el,Math.pow(en[2],2.2)*el]},en.bw=function(en){return[Math.pow(en[0],1/2.2),Math.pow(en[1],1/2.2),Math.pow(en[2],1/2.2)]},en.by=Lh,en.bz=256,en.c=k,en.c$=eI,en.c0=ho,en.c1=function(en,el,eu,ec,ed){return k((en-el)/(eu-el)*(ed-ec)+ec,ec,ed)},en.c2=bi,en.c3=oh,en.c4=sp,en.c5=lx,en.c6=[1,1,1],en.c7=Wd,en.c8=nN,en.c9=eo,en.cA=U,en.cB=en=>Ns(Ds(en)),en.cC=iT,en.cD=ft,en.cE=S,en.cF=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},en.cG=eV,en.cH=ap,en.cI=Ph,en.cJ=function([en,el,eu]){let ec=Math.hypot(en,el,eu),ed=Math.atan2(en,eu),ef=.5*Math.PI-Math.acos(-el/ec);return new r9(ed*eN,ef*eN)},en.cK=tp,en.cL=r8,en.cM=eC,en.cN=jh,en.cO=Fh,en.cP=function(el){let eu=[0,0,0],ec=en.m.identity(new Float64Array(16));return en.m.multiply(ec,el.pixelMatrix,el.globeMatrix),en.v.transformMat4(eu,eu,ec),new eB(eu[0],eu[1])},en.cQ=function(en){let el=en.navigator?en.navigator.userAgent:null;return!!function(en){if(null==eq){let el=en.navigator?en.navigator.userAgent:null;eq=!!en.safari||!(!el||!(/\b(iPad|iPhone|iPod)\b/.test(el)||el.match("Safari")&&!el.match("Chrome")))}return eq}(en)&&el&&(el.match("Version/15.4")||el.match("Version/15.5")||el.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},en.cR=C,en.cS=class{constructor(en,el,eu){this._transformRequestFn=en,this._customAccessToken=el,this._silenceAuthErrors=!!eu,this._createSkuToken()}_createSkuToken(){let en=function(){let en="";for(let el=0;el<10;el++)en+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1","01",en].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=en.token,this._skuTokenExpiresAt=en.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(en,el){return this._transformRequestFn&&this._transformRequestFn(en,el)||{url:en}}normalizeStyleURL(en,el){if(!_t(en))return en;let eu=kt(en);return eu.params.push(`sdk=js-${eI}`),eu.path=`/styles/v1${eu.path}`,this._makeAPIURL(eu,this._customAccessToken||el)}normalizeGlyphsURL(en,el){if(!_t(en))return en;let eu=kt(en);return eu.path=`/fonts/v1${eu.path}`,this._makeAPIURL(eu,this._customAccessToken||el)}normalizeModelURL(en,el){if(!_t(en))return en;let eu=kt(en);return eu.path=`/models/v1${eu.path}`,this._makeAPIURL(eu,this._customAccessToken||el)}normalizeSourceURL(en,el,eu,ec){if(!_t(en))return en;let ed=kt(en);return ed.path=`/v4/${ed.authority}.json`,ed.params.push("secure"),eu&&ed.params.push(`language=${eu}`),ec&&ed.params.push(`worldview=${ec}`),this._makeAPIURL(ed,this._customAccessToken||el)}normalizeSpriteURL(en,el,eu,ec){let ed=kt(en);return _t(en)?(ed.path=`/styles/v1${ed.path}/sprite${el}${eu}`,this._makeAPIURL(ed,this._customAccessToken||ec)):(ed.path+=`${el}${eu}`,Tt(ed))}normalizeTileURL(en,el,eu){if(this._isSkuTokenExpired()&&this._createSkuToken(),en&&!_t(en))return en;let ec=kt(en);ec.path=ec.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${el||eu&&"raster"!==ec.authority&&512===eu?"@2x":""}${eP.supported?".webp":"$1"}`),"raster"===ec.authority?ec.path=`/${eC.RASTER_URL_PREFIX}${ec.path}`:(ec.path=ec.path.replace(/^.+\/v4\//,"/"),ec.path=`/${eC.TILE_URL_VERSION}${ec.path}`);let ed=this._customAccessToken||function(en){for(let el of en){let en=el.match(/^access_token=(.*)$/);if(en)return en[1]}return null}(ec.params)||eC.ACCESS_TOKEN;return eC.REQUIRE_ACCESS_TOKEN&&ed&&this._skuToken&&ec.params.push(`sku=${this._skuToken}`),this._makeAPIURL(ec,ed)}canonicalizeTileURL(en,el){let eu=kt(en);if(!eu.path.match(/^(\/v4\/|\/raster\/v1\/)/)||!eu.path.match(/\.[\w]+$/))return en;let ec="mapbox://";eu.path.match(/^\/raster\/v1\//)?ec+=`raster/${eu.path.replace(`/${eC.RASTER_URL_PREFIX}/`,"")}`:ec+=`tiles/${eu.path.replace(`/${eC.TILE_URL_VERSION}/`,"")}`;let ed=eu.params;return el&&(ed=ed.filter(en=>!en.match(/^access_token=/))),ed.length&&(ec+=`?${ed.join("&")}`),ec}canonicalizeTileset(en,el){let eu=!!el&&_t(el),ec=[];for(let el of en.tiles||[])wt(el)?ec.push(this.canonicalizeTileURL(el,eu)):ec.push(el);return ec}_makeAPIURL(en,el){let eu="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",ec=kt(eC.API_URL);if(en.protocol=ec.protocol,en.authority=ec.authority,"http"===en.protocol){let el=en.params.indexOf("secure");el>=0&&en.params.splice(el,1)}if("/"!==ec.path&&(en.path=`${ec.path}${en.path}`),!eC.REQUIRE_ACCESS_TOKEN)return Tt(en);if(el=el||eC.ACCESS_TOKEN,!this._silenceAuthErrors){if(!el)throw Error(`An API access token is required to use Mapbox GL. ${eu}`);if("s"===el[0])throw Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${eu}`)}return en.params=en.params.filter(en=>-1===en.indexOf("access_token")),en.params.push(`access_token=${el||""}`),Tt(en)}},en.cT=function(en,el){el?e9.add(en):e9.delete(en)},en.cU=eP,en.cV=e6,en.cW=e7,en.cX=eY,en.cY=e4,en.cZ=function(en){e9.delete(en)},en.c_=z,en.ca=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[]}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(en){let el=Dx(new eB(0,0),new eB(8192,8192),en),eu=[];for(let ec of this._activeRegions){if(ec.hiddenByOverlap||!Bx(el,ec))continue;let ed=function(en,el,eu){let ec=1<<eu.canonical.z,ed=((el.x-eu.wrap)*ec-eu.canonical.x)*8192,ef=(el.y*ec-eu.canonical.y)*8192;return{min:new eB(((en.x-eu.wrap)*ec-eu.canonical.x)*8192,(en.y*ec-eu.canonical.y)*8192),max:new eB(ed,ef)}}(ec.min,ec.max,en);eu.push({min:ed.min,max:ed.max,sourceId:this._sourceIds[ec.priority],footprint:ec.footprint,footprintTileId:ec.tileId})}return eu}setSources(en){this._setSources(en.map(en=>({getSourceId:()=>en.cache.id,getFootprints:()=>{let el=[];for(let eu of en.cache.getVisibleCoordinates()){let ec=en.cache.getTile(eu).buckets[en.layer];if(ec)for(let en of ec.getNodesInfo()){let ec=en.node;ec.footprint&&el.push({footprint:ec.footprint,id:eu.toUnwrapped()})}}return el}})))}_addSource(en){let el=en.getFootprints();if(0!==el.length){for(let en of el){if(!en.footprint)continue;let el=Dx(en.footprint.min,en.footprint.max,en.id);this._activeRegions.push({min:el.min,max:el.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:en.id,footprint:en.footprint})}this._sourceIds.push(en.getSourceId())}}_computeReplacement(){this._activeRegions.sort((en,el)=>en.priority-el.priority||zx(en.min,el.min)||zx(en.max,el.max));let en=this._activeRegions.length!==this._prevRegions.length;if(!en){let el=0,eu=0;for(;!en&&el!==this._activeRegions.length;){let ec=this._activeRegions[el],ed=this._prevRegions[eu];en=ec.priority!==ed.priority||!Ex(ec,ed),++el,++eu}}if(en){++this._updateTime;let t=en=>{let el=this._activeRegions;if(en>=el.length)return en;let eu=el[en].priority;for(;en<el.length&&el[en].priority===eu;)++en;return en};if(this._sourceIds.length>1){let en=0,el=t(0);for(;en!==el;){let eu=en,ec=en;for(;eu!==el;){let en=this._activeRegions[eu];en.hiddenByOverlap=!1;for(let el=0;el<ec;el++){let eu=this._activeRegions[el];if(!eu.hiddenByOverlap&&Bx(en,eu)&&(en.hiddenByOverlap=function Lx(en,el,eu,ec){if(!en||!eu)return!1;let ed=en.vertices;if(!el.canonical.equals(ec.canonical)||el.wrap!==ec.wrap){if(eu.vertices.length<en.vertices.length)return Lx(eu,ec,en,el);let ef=el.canonical,em=ec.canonical,e_=Math.pow(2,em.z-ef.z);ed=en.vertices.map(en=>new eB(en.x*ef.x*8192*e_-8192*em.x,en.y*ef.y*8192*e_-8192*em.y))}return Rx(eu,ed,en.indices,0,en.indices.length,0,0)}(en.footprint,en.tileId,eu.footprint,eu.tileId),en.hiddenByOverlap))break}++eu}el=t(en=el)}}}}_setSources(en){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let el=en.length-1;el>=0;el--)this._addSource(en[el]);this._computeReplacement()}},en.cb=Ga,en.cc=nC,en.cd=fo,en.ce=class{constructor(en){this._createGrid(en),this._createPoles(en)}destroy(){for(let en of(this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy(),this._poleSegments))en.destroy();for(let en of this._gridSegments)en.withSkirts.destroy(),en.withoutSkirts.destroy()}_fillGridMeshWithLods(en,el){let eu=new $a,ec=new ao,ed=[],ef=en+1+2,em=el[0]+1,e_=el[0]+1+(1+el.length),l=(en,el,eu)=>{let ec=en===ef-1?en-2:0===en?en:en-1;return[ec+=eu?24575:0,el]};for(let en=0;en<ef;++en)eu.emplaceBack(...l(en,0,!0));for(let en=0;en<em;++en)for(let el=0;el<ef;++el)eu.emplaceBack(...l(el,en,0===el||el===ef-1));for(let en=0;en<el.length;++en){let ec=el[en];for(let en=0;en<ef;++en)eu.emplaceBack(...l(en,ec,!0))}for(let en=0;en<el.length;++en){let em=ec.length,ew=el[en]+1+2,eT=new ao;for(let eu=0;eu<ew-1;eu++){let ed=eu===ew-2,em=ed?ef*(e_-el.length+en-eu):ef;for(let en=0;en<ef-1;en++){let el=eu*ef+en;0===eu||ed||0===en||en===ef-2?(eT.emplaceBack(el+1,el,el+em),eT.emplaceBack(el+em,el+em+1,el+1)):(ec.emplaceBack(el+1,el,el+em),ec.emplaceBack(el+em,el+em+1,el+1))}}let eM=Do.simpleSegment(0,em,eu.length,ec.length-em);for(let en=0;en<eT.uint16.length;en+=3)ec.emplaceBack(eT.uint16[en],eT.uint16[en+1],eT.uint16[en+2]);let eE=Do.simpleSegment(0,em,eu.length,ec.length-em);ed.push({withoutSkirts:eM,withSkirts:eE})}return{vertices:eu,indices:ec,segments:ed}}_createGrid(en){let el=this._fillGridMeshWithLods(64,r0);this._gridSegments=el.segments,this._gridBuffer=en.createVertexBuffer(el.vertices,rK.members),this._gridIndexBuffer=en.createIndexBuffer(el.indices,!0)}_createPoles(en){let el=new ao;for(let en=0;en<=64;en++)el.emplaceBack(0,en+1,en+2);this._poleIndexBuffer=en.createIndexBuffer(el,!0);let eu=new co,ec=new co,ed=new co,ef=new co;this._poleSegments=[];for(let en=0,el=0;en<5;en++){let em=360/(1<<en);eu.emplaceBack(0,-rQ,0,.5,0),ec.emplaceBack(0,-rQ,0,.5,1),ed.emplaceBack(0,-rQ,0,.5,.5),ef.emplaceBack(0,-rQ,0,.5,.5);for(let en=0;en<=64;en++){let el=en/64,e_=0,ew=Mn(0,em,el),[eT,eM,eE]=Th(r5,r6,ew,rQ);eu.emplaceBack(eT,eM,eE,el,e_),ec.emplaceBack(eT,eM,eE,el,1-e_);let eS=ew*eF;el=.5+.5*Math.sin(eS),e_=.5+.5*Math.cos(eS),ed.emplaceBack(eT,eM,eE,el,e_),ef.emplaceBack(eT,eM,eE,el,1-e_)}this._poleSegments.push(Do.simpleSegment(el,0,66,64)),el+=66}this._poleNorthVertexBuffer=en.createVertexBuffer(eu,rH,!1),this._poleSouthVertexBuffer=en.createVertexBuffer(ec,rH,!1),this._texturedPoleNorthVertexBuffer=en.createVertexBuffer(ed,rH,!1),this._texturedPoleSouthVertexBuffer=en.createVertexBuffer(ef,rH,!1)}getGridBuffers(en,el){return[this._gridBuffer,this._gridIndexBuffer,el?this._gridSegments[en].withSkirts:this._gridSegments[en].withoutSkirts]}getPoleBuffers(en,el){return[el?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,el?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[en]]}},en.cf=function(en){return e9.has(en)},en.cg=op,en.ch=Z,en.ci=function(en){return en({pluginStatus:ib,pluginURL:iw}),iT.on("pluginStateChange",en),en},en.cj=iy,en.ck=a8,en.cl=eK,en.cm=ma,en.cn=_t,en.co=N,en.cp=function(en,el,eu){return"custom"===en.type?new Dv(en,el):new n7[en.type](en,el,eu)},en.cq=function(en){let el=en.indexOf("\x1f");return el>=0?en.slice(0,el):en},en.cr=en=>Ns(zs(en)),en.cs=en=>Ns(Ts(en)),en.ct=en=>Ns(Bs(en)),en.cu=function(en){return en.indexOf("\x1f")>=0},en.cv=function(en){let el=en.indexOf("\x1f");return el>=0?en.slice(el+1):""},en.cw=Xi,en.cx=function(en){let el=[],eu=en.id;return void 0===eu&&el.push({message:`layers.${eu}: missing required property "id"`}),void 0===en.render&&el.push({message:`layers.${eu}: missing required method "render"`}),en.renderingMode&&"2d"!==en.renderingMode&&"3d"!==en.renderingMode&&el.push({message:`layers.${eu}: property "renderingMode" must be either "2d" or "3d"`}),el},en.cy=en=>Ns(Ss(en)),en.cz=en=>Ns(bs(en)),en.d=function(en){return en*eF},en.d0=function(en,el){e$=en,eW=el},en.d1=function(en,el,eu=!1){if(ib===ic||ib===im||ib===i_)throw Error("setRTLTextPlugin cannot be called multiple times.");iw=ta.resolveURL(en),ib=ic,ig=el,ya(),eu||va()},en.d2=xa,en.d3=function(){eb().acquire(oa)},en.d4=function(){let en=eS;en&&(en.isPreloaded()&&1===en.numActive()?(en.release(oa),eS=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},en.d5=Qv,en.d6=function(en){let el=at();if(!el)return;let eu=el.delete(eZ);en&&eu.catch(en).then(()=>en())},en.d7=n9,en.d8=ab,en.d9=function(en){of=ta.resolveURL(en),o_||(o_=new Nv(eb(),new ee)),o_.broadcast("setDracoUrl",of)},en.da=E,en.db=Kd,en.dc=p,en.dd=aV,en.de=aN,en.df=g,en.dg=md,en.dh=class extends ee{constructor(en,el,eu,ec,ed,ef){super(),this.actor=en,this.layerIndex=el,this.availableImages=eu,this.loadVectorData=ed||Kv,this.loading={},this.loaded={},this.deduped=new Xv(en.scheduler),this.isSpriteLoaded=ec,this.scheduler=en.scheduler,this.brightness=ef}loadTile(en,el){let eu=en.uid,ec=en&&en.request,ed=ec&&ec.collectResourceTiming,ef=this.loading[eu]=new Yv(en);ef.abort=this.loadVectorData(en,(em,e_)=>{let ew=!this.loading[eu];if(delete this.loading[eu],ew||em||!e_)return ef.status="done",ew||(this.loaded[eu]=ef),el(em);let eT=e_.rawData,eM={};e_.expires&&(eM.expires=e_.expires),e_.cacheControl&&(eM.cacheControl=e_.cacheControl),ef.vectorTile=e_.vectorTile||new aU(new aq(eT));let h=()=>{ef.parse(ef.vectorTile,this.layerIndex,this.availableImages,this.actor,(en,eu)=>{if(en||!eu)return el(en);let ef={};if(ed){let en=$t(ec);en.length>0&&(ef.resourceTiming=JSON.parse(JSON.stringify(en)))}el(null,B({rawTileData:eT.slice(0)},eu,eM,ef))})};this.isSpriteLoaded?h():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(h,{type:"parseTile",isSymbolTile:en.isSymbolTile,zoom:en.tileZoom}):h()}),this.loaded=this.loaded||{},this.loaded[eu]=ef})}reloadTile(en,el){let eu=this.loaded,ec=en.uid,ed=this;if(eu&&eu[ec]){let ef=eu[ec];ef.showCollisionBoxes=en.showCollisionBoxes,ef.projection=en.projection,ef.brightness=en.brightness,ef.tileTransform=zy(en.tileID.canonical,en.projection),ef.extraShadowCaster=en.extraShadowCaster;let a=(en,eu)=>{let ec=ef.reloadCallback;ec&&(delete ef.reloadCallback,ef.parse(ef.vectorTile,ed.layerIndex,this.availableImages,ed.actor,ec)),el(en,eu)};"parsing"===ef.status?ef.reloadCallback=a:"done"===ef.status&&(ef.vectorTile?ef.parse(ef.vectorTile,this.layerIndex,this.availableImages,this.actor,a):a())}else el(null,void 0)}abortTile(en,el){let eu=en.uid,ec=this.loading[eu];ec&&(ec.abort&&ec.abort(),delete this.loading[eu]),el()}removeTile(en,el){let eu=this.loaded,ec=en.uid;eu&&eu[ec]&&delete eu[ec],el()}},en.di=$t,en.dj=dt,en.dk=Hd,en.dl=function(en){let el=0;if(1179937895!==new Uint32Array(en,0,1)[0]){let eu=new Uint32Array(en,0,7),[,,ec,ed,ef,em]=eu;el=eu.byteLength+ed+ef+em+ef,(ec!==en.byteLength||el>=en.byteLength)&&q("Invalid b3dm header information.")}return _b(en,el)},en.dm=function(el,eu){let ec=zb(el);for(let el of ec){for(let en of el.meshes)(function(en){en.heightmap=new Float32Array(4096),en.heightmap.fill(-1);let el=en.vertexArray.float32,eu=en.aabb.min[0]-1,ec=en.aabb.min[1]-1,ed=64/(en.aabb.max[0]-eu+2),ef=64/(en.aabb.max[1]-ec+2);for(let em=0;em<el.length;em+=3){let e_=el[em+2],ew=(el[em+0]-eu)*ed|0,eT=(el[em+1]-ec)*ef|0;e_>en.heightmap[64*eT+ew]&&(en.heightmap[64*eT+ew]=e_)}})(en);el.lights&&(el.lightMeshIndex=el.meshes.length,el.meshes.push(function(el,eu){let ec={};ec.indexArray=new ao,ec.indexArray.reserve(4*el.length),ec.vertexArray=new mo,ec.vertexArray.reserve(10*el.length),ec.colorArray=new Xa,ec.vertexArray.reserve(10*el.length);let ed=0;for(let ef of el){let el=Math.min(10,Math.max(4,1.3*ef.height))*eu,em=[-ef.normal[1],ef.normal[0],0],e_=Math.min(.29,.1*ef.width/ef.depth),ew=ef.width-2*ef.depth*eu*(e_+.01),eT=en.v.scaleAndAdd([],ef.pos,em,ew/2),eM=en.v.scaleAndAdd([],ef.pos,em,-ew/2),eE=[eT[0],eT[1],eT[2]+ef.height],eS=[eM[0],eM[1],eM[2]+ef.height],eA=en.v.scaleAndAdd([],ef.normal,em,e_);en.v.scale(eA,eA,el);let eI=en.v.scaleAndAdd([],ef.normal,em,-e_);en.v.scale(eI,eI,el),en.v.add(eA,eT,eA),en.v.add(eI,eM,eI),eT[2]+=.1,eM[2]+=.1,ec.vertexArray.emplaceBack(eA[0],eA[1],eA[2]),ec.vertexArray.emplaceBack(eI[0],eI[1],eI[2]),ec.vertexArray.emplaceBack(eT[0],eT[1],eT[2]),ec.vertexArray.emplaceBack(eM[0],eM[1],eM[2]),ec.vertexArray.emplaceBack(eE[0],eE[1],eE[2]),ec.vertexArray.emplaceBack(eS[0],eS[1],eS[2]),ec.vertexArray.emplaceBack(eT[0],eT[1],eT[2]),ec.vertexArray.emplaceBack(eM[0],eM[1],eM[2]),ec.vertexArray.emplaceBack(eA[0],eA[1],eA[2]),ec.vertexArray.emplaceBack(eI[0],eI[1],eI[2]);let eC=ew/el/2;ec.colorArray.emplaceBack(-eC-e_,-1,eC,.8),ec.colorArray.emplaceBack(eC+e_,-1,eC,.8),ec.colorArray.emplaceBack(-eC,0,eC,1.3),ec.colorArray.emplaceBack(eC,0,eC,1.3),ec.colorArray.emplaceBack(eC+e_,-.8,eC,.7),ec.colorArray.emplaceBack(eC+e_,-.8,eC,.7),ec.colorArray.emplaceBack(0,0,eC,1.3),ec.colorArray.emplaceBack(0,0,eC,1.3),ec.colorArray.emplaceBack(eC+e_,-1.2,eC,.8),ec.colorArray.emplaceBack(eC+e_,-1.2,eC,.8),ec.indexArray.emplaceBack(6+ed,4+ed,8+ed),ec.indexArray.emplaceBack(7+ed,9+ed,5+ed),ec.indexArray.emplaceBack(0+ed,1+ed,2+ed),ec.indexArray.emplaceBack(1+ed,3+ed,2+ed),ed+=10}let ef={defined:!0,emissiveFactor:[0,0,0]},em={};return em.baseColorFactor=Ce.white,ef.pbrMetallicRoughness=em,ec.material=ef,ec.aabb=new oh([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),ec}(el.lights,eu)))}return ec},en.dn=Ix,en.dp=Uv,en.dq=iM,en.dr=function(en){ot(),eu&&eu.then(el=>{el.keys().then(eu=>{for(let ec=0;ec<eu.length-en;ec++)el.delete(eu[ec])})})},en.f=function(el,eu){let{x:ec,y:ed}=el.point,ef=Vh(ec,ed,el.worldSize/el._pixelsPerMercatorPixel,0,0);return en.m.multiply(ef,ef,Ch(_h(eu)))},en.g=J,en.i=fm,en.j=pm,en.k=lg,en.l=ep,en.n=Mn,en.o=Jy,en.p=function(en,el){let eu={};for(let ec=0;ec<el.length;ec++){let ed=el[ec];ed in en&&(eu[ed]=en[ed])}return eu},en.r=tx,en.s=function(en,el,eu){en[4*el+0]=eu[0],en[4*el+1]=eu[1],en[4*el+2]=eu[2],en[4*el+3]=eu[3]},en.t=Kc,en.u=function(en,el,eu,ec,ed){let ef=5*el+2;en.float32[ef+0]=eu,en.float32[ef+1]=ec,en.float32[ef+2]=ed},en.w=P,en.x=Sh,en.y=function(en,el,eu,ec,ed,ef,em,e_,ew){if("globe"===ew.name)return Sh(en,el,new Kc(eu,ec,ed),!1);let eT=zy({z:eu,x:ec,y:ed},ew);return new oh([(ef+eT.x/eT.scale)*el,el*(eT.y/eT.scale),em],[(ef+eT.x2/eT.scale)*el,el*(eT.y2/eT.scale),e_])},en.z=function(en,el,eu){let ec=0;for(let ed=0;ed<2;++ed){let ef=eu?eu[ed]:0;en[ed]>ef&&(ec+=(en[ed]-ef)*(en[ed]-ef)),el[ed]<ef&&(ec+=(ef-el[ed])*(ef-el[ed]))}return ec}}),define(["./shared"],function(en){let o=class o{constructor(en){this.keyCache={},this._layers={},this._layerConfigs={},en&&this.replace(en)}replace(en,el){this._layerConfigs={},this._layers={},this.update(en,[],el)}update(el,eu,ec){for(let eu of(this._options=ec,el))this._layerConfigs[eu.id]=eu,(this._layers[eu.id]=en.cp(eu,this.scope,this._options)).compileFilter(),this.keyCache[eu.id]&&delete this.keyCache[eu.id];for(let en of eu)delete this.keyCache[en],delete this._layerConfigs[en],delete this._layers[en];this.familiesBySource={};let ed=function(el,eu){let ec={};for(let ed=0;ed<el.length;ed++){let ef=eu&&eu[el[ed].id]||function(el){let eu="";for(let ec of en.aS)eu+=`/${function t(en){if("number"==typeof en||"boolean"==typeof en||"string"==typeof en||null==en)return JSON.stringify(en);if(Array.isArray(en)){let el="[";for(let eu of en)el+=`${t(eu)},`;return`${el}]`}let el="{";for(let eu of Object.keys(en).sort())el+=`${eu}:${t(en[eu])},`;return`${el}}`}(el[ec])}`;return eu}(el[ed]);eu&&(eu[el[ed].id]=ef);let em=ec[ef];em||(em=ec[ef]=[]),em.push(el[ed])}let ed=[];for(let en in ec)ed.push(ec[en]);return ed}(en.da(this._layerConfigs),this.keyCache);for(let en of ed){let el=en.map(en=>this._layers[en.id]),eu=el[0];if("none"===eu.visibility)continue;let ec=eu.source||"",ed=this.familiesBySource[ec];ed||(ed=this.familiesBySource[ec]={});let ef=eu.sourceLayer||"_geojsonTileLayer",em=ed[ef];em||(em=ed[ef]=[]),em.push(el)}}};let i=class i{loadTile(el,eu){let{uid:ec,encoding:ed,rawImageData:ef,padding:em}=el,e_=ImageBitmap&&ef instanceof ImageBitmap?this.getImageData(ef,em):ef;eu(null,new en.db(ec,e_,ed,em<1))}getImageData(en,el){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(en.width,en.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=en.width,this.offscreenCanvas.height=en.height,this.offscreenCanvasContext.drawImage(en,0,0,en.width,en.height);let eu=this.offscreenCanvasContext.getImageData(-el,-el,en.width+2*el,en.height+2*el);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),eu}};function s(en,el){if(0!==en.length){n(en[0],el);for(var eu=1;eu<en.length;eu++)n(en[eu],!el)}}function n(en,el){for(var eu=0,ec=0,ed=0,ef=en.length,em=ef-1;ed<ef;em=ed++){var e_=(en[ed][0]-en[em][0])*(en[em][1]+en[ed][1]),ew=eu+e_;ec+=Math.abs(eu)>=Math.abs(e_)?eu-ew+e_:e_-ew+eu,eu=ew}eu+ec>=0!=!!el&&en.reverse()}var el,eu=en.dc(function e(en,el){var eu,ec=en&&en.type;if("FeatureCollection"===ec)for(eu=0;eu<en.features.length;eu++)e(en.features[eu],el);else if("GeometryCollection"===ec)for(eu=0;eu<en.geometries.length;eu++)e(en.geometries[eu],el);else if("Feature"===ec)e(en.geometry,el);else if("Polygon"===ec)s(en.coordinates,el);else if("MultiPolygon"===ec)for(eu=0;eu<en.coordinates.length;eu++)s(en.coordinates[eu],el);return en});let ec=en.dd.prototype.toGeoJSON;var ed={exports:{}},ef=en.df,em=en.de.VectorTileFeature;function f(en,el){this.options=el||{},this.features=en,this.length=en.length}function p(en,el){this.id="number"==typeof en.id?en.id:void 0,this.type=en.type,this.rawGeometry=1===en.type?[en.geometry]:en.geometry,this.properties=en.tags,this.extent=el||4096}f.prototype.feature=function(en){return new p(this.features[en],this.options.extent)},p.prototype.loadGeometry=function(){var en=this.rawGeometry;this.geometry=[];for(var el=0;el<en.length;el++){for(var eu=en[el],ec=[],ed=0;ed<eu.length;ed++)ec.push(new ef(eu[ed][0],eu[ed][1]));this.geometry.push(ec)}return this.geometry},p.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var en=this.geometry,el=1/0,eu=-1/0,ec=1/0,ed=-1/0,ef=0;ef<en.length;ef++)for(var em=en[ef],e_=0;e_<em.length;e_++){var ew=em[e_];el=Math.min(el,ew.x),eu=Math.max(eu,ew.x),ec=Math.min(ec,ew.y),ed=Math.max(ed,ew.y)}return[el,ec,eu,ed]},p.prototype.toGeoJSON=em.prototype.toGeoJSON;var e_=en.dg;function y(en){var el=new e_;return function(en,el){for(var eu in en.layers)el.writeMessage(3,v,en.layers[eu])}(en,el),el.finish()}function v(en,el){el.writeVarintField(15,en.version||1),el.writeStringField(1,en.name||""),el.writeVarintField(5,en.extent||4096);var eu,ec={keys:[],values:[],keycache:{},valuecache:{}};for(eu=0;eu<en.length;eu++)ec.feature=en.feature(eu),el.writeMessage(2,w,ec);var ed=ec.keys;for(eu=0;eu<ed.length;eu++)el.writeStringField(3,ed[eu]);var ef=ec.values;for(eu=0;eu<ef.length;eu++)el.writeMessage(4,I,ef[eu])}function w(en,el){var eu=en.feature;void 0!==eu.id&&el.writeVarintField(1,eu.id),el.writeMessage(2,x,en),el.writeVarintField(3,eu.type),el.writeMessage(4,b,eu)}function x(en,el){var eu=en.feature,ec=en.keys,ed=en.values,ef=en.keycache,em=en.valuecache;for(var e_ in eu.properties){var ew=eu.properties[e_],eT=ef[e_];if(null!==ew){void 0===eT&&(ec.push(e_),ef[e_]=eT=ec.length-1),el.writeVarint(eT);var eM=typeof ew;"string"!==eM&&"boolean"!==eM&&"number"!==eM&&(ew=JSON.stringify(ew));var eE=eM+":"+ew,eS=em[eE];void 0===eS&&(ed.push(ew),em[eE]=eS=ed.length-1),el.writeVarint(eS)}}}function b(en,el){for(var eu=en.loadGeometry(),ec=en.type,ed=0,ef=0,em=eu.length,e_=0;e_<em;e_++){var ew=eu[e_],eT=1;1===ec&&(eT=ew.length),el.writeVarint((eT<<3)+1);for(var eM=3===ec?ew.length-1:ew.length,eE=0;eE<eM;eE++){1===eE&&1!==ec&&el.writeVarint((eM-1<<3)+2);var eS=ew[eE].x-ed,eA=ew[eE].y-ef;el.writeVarint(eS<<1^eS>>31),el.writeVarint(eA<<1^eA>>31),ed+=eS,ef+=eA}3===ec&&el.writeVarint(15)}}function I(en,el){var eu=typeof en;"string"===eu?el.writeStringField(1,en):"boolean"===eu?el.writeBooleanField(7,en):"number"===eu&&(en%1!=0?el.writeDoubleField(3,en):en<0?el.writeSVarintField(6,en):el.writeVarintField(5,en))}ed.exports=y,ed.exports.fromVectorTileJs=y,ed.exports.fromGeojsonVt=function(en,el){el=el||{};var eu={};for(var ec in en)eu[ec]=new f(en[ec].features,el),eu[ec].name=ec,eu[ec].version=el.version,eu[ec].extent=el.extent;return y({layers:eu})},ed.exports.GeoJSONWrapper=f;var ew=en.dc(ed.exports);let eT={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:en=>en},eM=Math.fround||(el=new Float32Array(1),en=>(el[0]=+en,el[0]));let j=class j{constructor(en){this.options=Object.assign(Object.create(eT),en),this.trees=Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(en){let{log:el,minZoom:eu,maxZoom:ec}=this.options;el&&console.time("total time");let ed=`prepare ${en.length} points`;el&&console.time(ed),this.points=en;let ef=[];for(let el=0;el<en.length;el++){let eu=en[el];if(!eu.geometry)continue;let[ec,ed]=eu.geometry.coordinates,em=eM(z(ec)),e_=eM(D(ed));ef.push(em,e_,1/0,el,-1,1),this.options.reduce&&ef.push(0)}let em=this.trees[ec+1]=this._createTree(ef);el&&console.timeEnd(ed);for(let en=ec;en>=eu;en--){let eu=+Date.now();em=this.trees[en]=this._createTree(this._cluster(em,en)),el&&console.log("z%d: %d clusters in %dms",en,em.numItems,+Date.now()-eu)}return el&&console.timeEnd("total time"),this}getClusters(en,el){let eu=((en[0]+180)%360+360)%360-180,ec=Math.max(-90,Math.min(90,en[1])),ed=180===en[2]?180:((en[2]+180)%360+360)%360-180,ef=Math.max(-90,Math.min(90,en[3]));if(en[2]-en[0]>=360)eu=-180,ed=180;else if(eu>ed){let en=this.getClusters([eu,ec,180,ef],el),em=this.getClusters([-180,ec,ed,ef],el);return en.concat(em)}let em=this.trees[this._limitZoom(el)],e_=em.range(z(eu),D(ef),z(ed),D(ec)),ew=em.data,eT=[];for(let en of e_){let el=this.stride*en;eT.push(ew[el+5]>1?Z(ew,el,this.clusterProps):this.points[ew[el+3]])}return eT}getChildren(en){let el=this._getOriginId(en),eu=this._getOriginZoom(en),ec="No cluster with the specified id.",ed=this.trees[eu];if(!ed)throw Error(ec);let ef=ed.data;if(el*this.stride>=ef.length)throw Error(ec);let em=this.options.radius/(this.options.extent*Math.pow(2,eu-1)),e_=ed.within(ef[el*this.stride],ef[el*this.stride+1],em),ew=[];for(let el of e_){let eu=el*this.stride;ef[eu+4]===en&&ew.push(ef[eu+5]>1?Z(ef,eu,this.clusterProps):this.points[ef[eu+3]])}if(0===ew.length)throw Error(ec);return ew}getLeaves(en,el,eu){let ec=[];return this._appendLeaves(ec,en,el=el||10,eu=eu||0,0),ec}getTile(en,el,eu){let ec=this.trees[this._limitZoom(en)],ed=Math.pow(2,en),{extent:ef,radius:em}=this.options,e_=em/ef,ew=(eu-e_)/ed,eT=(eu+1+e_)/ed,eM={features:[]};return this._addTileFeatures(ec.range((el-e_)/ed,ew,(el+1+e_)/ed,eT),ec.data,el,eu,ed,eM),0===el&&this._addTileFeatures(ec.range(1-e_/ed,ew,1,eT),ec.data,ed,eu,ed,eM),el===ed-1&&this._addTileFeatures(ec.range(0,ew,e_/ed,eT),ec.data,-1,eu,ed,eM),eM.features.length?eM:null}getClusterExpansionZoom(en){let el=this._getOriginZoom(en)-1;for(;el<=this.options.maxZoom;){let eu=this.getChildren(en);if(el++,1!==eu.length)break;en=eu[0].properties.cluster_id}return el}_appendLeaves(en,el,eu,ec,ed){let ef=this.getChildren(el);for(let el of ef){let ef=el.properties;if(ef&&ef.cluster?ed+ef.point_count<=ec?ed+=ef.point_count:ed=this._appendLeaves(en,ef.cluster_id,eu,ec,ed):ed<ec?ed++:en.push(el),en.length===eu)break}return ed}_createTree(el){let eu=new en.aZ(el.length/this.stride|0,this.options.nodeSize,Float32Array);for(let en=0;en<el.length;en+=this.stride)eu.add(el[en],el[en+1]);return eu.finish(),eu.data=el,eu}_addTileFeatures(en,el,eu,ec,ed,ef){for(let em of en){let en,e_,ew,eT;let eM=em*this.stride,eE=el[eM+5]>1;if(eE)en=F(el,eM,this.clusterProps),e_=el[eM],ew=el[eM+1];else{let eu=this.points[el[eM+3]];en=eu.properties;let[ec,ed]=eu.geometry.coordinates;e_=z(ec),ew=D(ed)}let eS={type:1,geometry:[[Math.round(this.options.extent*(e_*ed-eu)),Math.round(this.options.extent*(ew*ed-ec))]],tags:en};void 0!==(eT=eE||this.options.generateId?el[eM+3]:this.points[el[eM+3]].id)&&(eS.id=eT),ef.features.push(eS)}}_limitZoom(en){return Math.max(this.options.minZoom,Math.min(Math.floor(+en),this.options.maxZoom+1))}_cluster(en,el){let{radius:eu,extent:ec,reduce:ed,minPoints:ef}=this.options,em=eu/(ec*Math.pow(2,el)),e_=en.data,ew=[],eT=this.stride;for(let eu=0;eu<e_.length;eu+=eT){if(e_[eu+2]<=el)continue;e_[eu+2]=el;let ec=e_[eu],eM=e_[eu+1],eE=en.within(e_[eu],e_[eu+1],em),eS=e_[eu+5],eA=eS;for(let en of eE){let eu=en*eT;e_[eu+2]>el&&(eA+=e_[eu+5])}if(eA>eS&&eA>=ef){let en,ef=ec*eS,em=eM*eS,eI=-1,eC=((eu/eT|0)<<5)+(el+1)+this.points.length;for(let ec of eE){let ew=ec*eT;if(e_[ew+2]<=el)continue;e_[ew+2]=el;let eM=e_[ew+5];ef+=e_[ew]*eM,em+=e_[ew+1]*eM,e_[ew+4]=eC,ed&&(en||(en=this._map(e_,eu,!0),eI=this.clusterProps.length,this.clusterProps.push(en)),ed(en,this._map(e_,ew)))}e_[eu+4]=eC,ew.push(ef/eA,em/eA,1/0,eC,-1,eA),ed&&ew.push(eI)}else{for(let en=0;en<eT;en++)ew.push(e_[eu+en]);if(eA>1)for(let en of eE){let eu=en*eT;if(!(e_[eu+2]<=el)){e_[eu+2]=el;for(let en=0;en<eT;en++)ew.push(e_[eu+en])}}}}return ew}_getOriginId(en){return en-this.points.length>>5}_getOriginZoom(en){return(en-this.points.length)%32}_map(en,el,eu){if(en[el+5]>1){let ec=this.clusterProps[en[el+6]];return eu?Object.assign({},ec):ec}let ec=this.points[en[el+3]].properties,ed=this.options.map(ec);return eu&&ed===ec?Object.assign({},ed):ed}};function Z(en,el,eu){return{type:"Feature",id:en[el+3],properties:F(en,el,eu),geometry:{type:"Point",coordinates:[360*(en[el]-.5),function(en){let el=(180-360*en)*Math.PI/180;return 360*Math.atan(Math.exp(el))/Math.PI-90}(en[el+1])]}}}function F(en,el,eu){let ec=en[el+5],ed=ec>=1e4?`${Math.round(ec/1e3)}k`:ec>=1e3?Math.round(ec/100)/10+"k":ec,ef=en[el+6],em=-1===ef?{}:Object.assign({},eu[ef]);return Object.assign(em,{cluster:!0,cluster_id:en[el+3],point_count:ec,point_count_abbreviated:ed})}function z(en){return en/360+.5}function D(en){let el=Math.sin(en*Math.PI/180),eu=.5-.25*Math.log((1+el)/(1-el))/Math.PI;return eu<0?0:eu>1?1:eu}var eE={exports:{}};eE.exports=function(){function r(en,el,eu,ec){var ed={id:void 0===en?null:en,type:el,geometry:eu,tags:ec,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(en){var el=en.geometry,eu=en.type;if("Point"===eu||"MultiPoint"===eu||"LineString"===eu)o(en,el);else if("Polygon"===eu||"MultiLineString"===eu)for(var ec=0;ec<el.length;ec++)o(en,el[ec]);else if("MultiPolygon"===eu)for(ec=0;ec<el.length;ec++)for(var ed=0;ed<el[ec].length;ed++)o(en,el[ec][ed])}(ed),ed}function o(en,el){for(var eu=0;eu<el.length;eu+=3)en.minX=Math.min(en.minX,el[eu]),en.minY=Math.min(en.minY,el[eu+1]),en.maxX=Math.max(en.maxX,el[eu]),en.maxY=Math.max(en.maxY,el[eu+1])}function i(en,el,eu,ec){if(el.geometry){var ed=el.geometry.coordinates,ef=el.geometry.type,em=Math.pow(eu.tolerance/((1<<eu.maxZoom)*eu.extent),2),e_=[],ew=el.id;if(eu.promoteId?ew=el.properties[eu.promoteId]:eu.generateId&&(ew=ec||0),"Point"===ef)s(ed,e_);else if("MultiPoint"===ef)for(var eT=0;eT<ed.length;eT++)s(ed[eT],e_);else if("LineString"===ef)n(ed,e_,em,!1);else if("MultiLineString"===ef){if(eu.lineMetrics){for(eT=0;eT<ed.length;eT++)n(ed[eT],e_=[],em,!1),en.push(r(ew,"LineString",e_,el.properties));return}a(ed,e_,em,!1)}else if("Polygon"===ef)a(ed,e_,em,!0);else{if("MultiPolygon"!==ef){if("GeometryCollection"===ef){for(eT=0;eT<el.geometry.geometries.length;eT++)i(en,{id:ew,geometry:el.geometry.geometries[eT],properties:el.properties},eu,ec);return}throw Error("Input data is not a valid GeoJSON object.")}for(eT=0;eT<ed.length;eT++){var eM=[];a(ed[eT],eM,em,!0),e_.push(eM)}}en.push(r(ew,ef,e_,el.properties))}}function s(en,el){var eu;el.push(en[0]/360+.5),el.push(h(en[1])),el.push(0)}function n(en,el,eu,ec){for(var ed,ef,em=0,e_=0;e_<en.length;e_++){var ew,eT=en[e_][0]/360+.5,eM=h(en[e_][1]);el.push(eT),el.push(eM),el.push(0),e_>0&&(em+=ec?(ed*eM-eT*ef)/2:Math.sqrt(Math.pow(eT-ed,2)+Math.pow(eM-ef,2))),ed=eT,ef=eM}var eE=el.length-3;el[2]=1,function e(en,el,eu,ec){for(var ed,ef=ec,em=eu-el>>1,e_=eu-el,ew=en[el],eT=en[el+1],eM=en[eu],eE=en[eu+1],eS=el+3;eS<eu;eS+=3){var eA=function(en,el,eu,ec,ed,ef){var em=ed-eu,e_=ef-ec;if(0!==em||0!==e_){var ew=((en-eu)*em+(el-ec)*e_)/(em*em+e_*e_);ew>1?(eu=ed,ec=ef):ew>0&&(eu+=em*ew,ec+=e_*ew)}return(em=en-eu)*em+(e_=el-ec)*e_}(en[eS],en[eS+1],ew,eT,eM,eE);if(eA>ef)ed=eS,ef=eA;else if(eA===ef){var eI=Math.abs(eS-em);eI<e_&&(ed=eS,e_=eI)}}ef>ec&&(ed-el>3&&e(en,el,ed,ec),en[ed+2]=ef,eu-ed>3&&e(en,ed,eu,ec))}(el,0,eE,eu),el[eE+2]=1,el.size=Math.abs(em),el.start=0,el.end=el.size}function a(en,el,eu,ec){for(var ed=0;ed<en.length;ed++){var ef=[];n(en[ed],ef,eu,ec),el.push(ef)}}function h(en){var el=Math.sin(en*Math.PI/180),eu=.5-.25*Math.log((1+el)/(1-el))/Math.PI;return eu<0?0:eu>1?1:eu}function u(en,el,eu,ec,ed,ef,em,e_){if(ec/=el,ef>=(eu/=el)&&em<ec)return en;if(em<eu||ef>=ec)return null;for(var ew=[],eT=0;eT<en.length;eT++){var eM=en[eT],eE=eM.geometry,eS=eM.type,eA=0===ed?eM.minX:eM.minY,eI=0===ed?eM.maxX:eM.maxY;if(eA>=eu&&eI<ec)ew.push(eM);else if(!(eI<eu||eA>=ec)){var eC=[];if("Point"===eS||"MultiPoint"===eS)(function(en,el,eu,ec,ed){for(var ef=0;ef<en.length;ef+=3){var em=en[ef+ed];em>=eu&&em<=ec&&(el.push(en[ef]),el.push(en[ef+1]),el.push(en[ef+2]))}})(eE,eC,eu,ec,ed);else if("LineString"===eS)d(eE,eC,eu,ec,ed,!1,e_.lineMetrics);else if("MultiLineString"===eS)p(eE,eC,eu,ec,ed,!1);else if("Polygon"===eS)p(eE,eC,eu,ec,ed,!0);else if("MultiPolygon"===eS)for(var eP=0;eP<eE.length;eP++){var ez=[];p(eE[eP],ez,eu,ec,ed,!0),ez.length&&eC.push(ez)}if(eC.length){if(e_.lineMetrics&&"LineString"===eS){for(eP=0;eP<eC.length;eP++)ew.push(r(eM.id,eS,eC[eP],eM.tags));continue}"LineString"!==eS&&"MultiLineString"!==eS||(1===eC.length?(eS="LineString",eC=eC[0]):eS="MultiLineString"),"Point"!==eS&&"MultiPoint"!==eS||(eS=3===eC.length?"Point":"MultiPoint"),ew.push(r(eM.id,eS,eC,eM.tags))}}}return ew.length?ew:null}function d(en,el,eu,ec,ed,ef,em){for(var e_,ew,eT=f(en),eM=0===ed?m:y,eE=en.start,eS=0;eS<en.length-3;eS+=3){var eA=en[eS],eI=en[eS+1],eC=en[eS+2],eP=en[eS+3],ez=en[eS+4],eD=0===ed?eA:eI,eL=0===ed?eP:ez,ek=!1;em&&(e_=Math.sqrt(Math.pow(eA-eP,2)+Math.pow(eI-ez,2))),eD<eu?eL>eu&&(ew=eM(eT,eA,eI,eP,ez,eu),em&&(eT.start=eE+e_*ew)):eD>ec?eL<ec&&(ew=eM(eT,eA,eI,eP,ez,ec),em&&(eT.start=eE+e_*ew)):g(eT,eA,eI,eC),eL<eu&&eD>=eu&&(ew=eM(eT,eA,eI,eP,ez,eu),ek=!0),eL>ec&&eD<=ec&&(ew=eM(eT,eA,eI,eP,ez,ec),ek=!0),!ef&&ek&&(em&&(eT.end=eE+e_*ew),el.push(eT),eT=f(en)),em&&(eE+=e_)}var eR=en.length-3;eA=en[eR],eI=en[eR+1],eC=en[eR+2],(eD=0===ed?eA:eI)>=eu&&eD<=ec&&g(eT,eA,eI,eC),eR=eT.length-3,ef&&eR>=3&&(eT[eR]!==eT[0]||eT[eR+1]!==eT[1])&&g(eT,eT[0],eT[1],eT[2]),eT.length&&el.push(eT)}function f(en){var el=[];return el.size=en.size,el.start=en.start,el.end=en.end,el}function p(en,el,eu,ec,ed,ef){for(var em=0;em<en.length;em++)d(en[em],el,eu,ec,ed,ef,!1)}function g(en,el,eu,ec){en.push(el),en.push(eu),en.push(ec)}function m(en,el,eu,ec,ed,ef){var em=(ef-el)/(ec-el);return en.push(ef),en.push(eu+(ed-eu)*em),en.push(1),em}function y(en,el,eu,ec,ed,ef){var em=(ef-eu)/(ed-eu);return en.push(el+(ec-el)*em),en.push(ef),en.push(1),em}function v(en,el){for(var eu=[],ec=0;ec<en.length;ec++){var ed,ef=en[ec],em=ef.type;if("Point"===em||"MultiPoint"===em||"LineString"===em)ed=w(ef.geometry,el);else if("MultiLineString"===em||"Polygon"===em){ed=[];for(var e_=0;e_<ef.geometry.length;e_++)ed.push(w(ef.geometry[e_],el))}else if("MultiPolygon"===em)for(ed=[],e_=0;e_<ef.geometry.length;e_++){for(var ew=[],eT=0;eT<ef.geometry[e_].length;eT++)ew.push(w(ef.geometry[e_][eT],el));ed.push(ew)}eu.push(r(ef.id,em,ed,ef.tags))}return eu}function w(en,el){var eu=[];eu.size=en.size,void 0!==en.start&&(eu.start=en.start,eu.end=en.end);for(var ec=0;ec<en.length;ec+=3)eu.push(en[ec]+el,en[ec+1],en[ec+2]);return eu}function x(en,el){if(en.transformed)return en;var eu,ec,ed,ef=1<<en.z,em=en.x,e_=en.y;for(eu=0;eu<en.features.length;eu++){var ew=en.features[eu],eT=ew.geometry,eM=ew.type;if(ew.geometry=[],1===eM)for(ec=0;ec<eT.length;ec+=2)ew.geometry.push(S(eT[ec],eT[ec+1],el,ef,em,e_));else for(ec=0;ec<eT.length;ec++){var eE=[];for(ed=0;ed<eT[ec].length;ed+=2)eE.push(S(eT[ec][ed],eT[ec][ed+1],el,ef,em,e_));ew.geometry.push(eE)}}return en.transformed=!0,en}function S(en,el,eu,ec,ed,ef){return[Math.round(eu*(en*ec-ed)),Math.round(eu*(el*ec-ef))]}function I(en,el,eu,ec,ed,ef){var em=ec*ec;if(ec>0&&el.size<(ed?em:ec))eu.numPoints+=el.length/3;else{for(var e_=[],ew=0;ew<el.length;ew+=3)(0===ec||el[ew+2]>em)&&(eu.numSimplified++,e_.push(el[ew]),e_.push(el[ew+1])),eu.numPoints++;ed&&function(en,el){for(var eu=0,ec=0,ed=en.length,ef=ed-2;ec<ed;ef=ec,ec+=2)eu+=(en[ec]-en[ef])*(en[ec+1]+en[ef+1]);if(eu>0===el)for(ec=0,ed=en.length;ec<ed/2;ec+=2){var em=en[ec],e_=en[ec+1];en[ec]=en[ed-2-ec],en[ec+1]=en[ed-1-ec],en[ed-2-ec]=em,en[ed-1-ec]=e_}}(e_,ef),en.push(e_)}}function k(en,el){var eu,ec,ed,ef,em,e_,ew=(el=this.options=function(en,el){for(var eu in el)en[eu]=el[eu];return en}(Object.create(this.options),el)).debug;if(ew&&console.time("preprocess data"),el.maxZoom<0||el.maxZoom>24)throw Error("maxZoom should be in the 0-24 range");if(el.promoteId&&el.generateId)throw Error("promoteId and generateId cannot be used together.");var eT=function(en,el){var eu=[];if("FeatureCollection"===en.type)for(var ec=0;ec<en.features.length;ec++)i(eu,en.features[ec],el,ec);else i(eu,"Feature"===en.type?en:{geometry:en},el);return eu}(en,el);this.tiles={},this.tileCoords=[],ew&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",el.indexMaxZoom,el.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),(eu=eT,ed=(ec=el).buffer/ec.extent,ef=eu,em=u(eu,1,-1-ed,ed,0,-1,2,ec),e_=u(eu,1,1-ed,2+ed,0,-1,2,ec),(em||e_)&&(ef=u(eu,1,-ed,1+ed,0,-1,2,ec)||[],em&&(ef=v(em,1).concat(ef)),e_&&(ef=ef.concat(v(e_,-1)))),eT=ef).length&&this.splitTile(eT,0,0,0),ew&&(eT.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function P(en,el,eu){return 32*((1<<en)*eu+el)+en}return k.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},k.prototype.splitTile=function(en,el,eu,ec,ed,ef,em){for(var e_=[en,el,eu,ec],ew=this.options,eT=ew.debug;e_.length;){ec=e_.pop(),eu=e_.pop(),el=e_.pop(),en=e_.pop();var eM=1<<el,eE=P(el,eu,ec),eS=this.tiles[eE];if(!eS&&(eT>1&&console.time("creation"),eS=this.tiles[eE]=function(en,el,eu,ec,ed){for(var ef=el===ed.maxZoom?0:ed.tolerance/((1<<el)*ed.extent),em={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:eu,y:ec,z:el,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},e_=0;e_<en.length;e_++){em.numFeatures++,function(en,el,eu,ec){var ed=el.geometry,ef=el.type,em=[];if("Point"===ef||"MultiPoint"===ef)for(var e_=0;e_<ed.length;e_+=3)em.push(ed[e_]),em.push(ed[e_+1]),en.numPoints++,en.numSimplified++;else if("LineString"===ef)I(em,ed,en,eu,!1,!1);else if("MultiLineString"===ef||"Polygon"===ef)for(e_=0;e_<ed.length;e_++)I(em,ed[e_],en,eu,"Polygon"===ef,0===e_);else if("MultiPolygon"===ef)for(var ew=0;ew<ed.length;ew++){var eT=ed[ew];for(e_=0;e_<eT.length;e_++)I(em,eT[e_],en,eu,!0,0===e_)}if(em.length){var eM=el.tags||null;if("LineString"===ef&&ec.lineMetrics){for(var eE in eM={},el.tags)eM[eE]=el.tags[eE];eM.mapbox_clip_start=ed.start/ed.size,eM.mapbox_clip_end=ed.end/ed.size}var eS={geometry:em,type:"Polygon"===ef||"MultiPolygon"===ef?3:"LineString"===ef||"MultiLineString"===ef?2:1,tags:eM};null!==el.id&&(eS.id=el.id),en.features.push(eS)}}(em,en[e_],ef,ed);var ew=en[e_].minX,eT=en[e_].minY,eM=en[e_].maxX,eE=en[e_].maxY;ew<em.minX&&(em.minX=ew),eT<em.minY&&(em.minY=eT),eM>em.maxX&&(em.maxX=eM),eE>em.maxY&&(em.maxY=eE)}return em}(en,el,eu,ec,ew),this.tileCoords.push({z:el,x:eu,y:ec}),eT)){eT>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",el,eu,ec,eS.numFeatures,eS.numPoints,eS.numSimplified),console.timeEnd("creation"));var eA="z"+el;this.stats[eA]=(this.stats[eA]||0)+1,this.total++}if(eS.source=en,ed){if(el===ew.maxZoom||el===ed)continue;var eI=1<<ed-el;if(eu!==Math.floor(ef/eI)||ec!==Math.floor(em/eI))continue}else if(el===ew.indexMaxZoom||eS.numPoints<=ew.indexMaxPoints)continue;if(eS.source=null,0!==en.length){eT>1&&console.time("clipping");var eC,eP,ez,eD,eL,ek,eR=.5*ew.buffer/ew.extent,eO=.5-eR,eB=.5+eR,eF=1+eR;eC=eP=ez=eD=null,eL=u(en,eM,eu-eR,eu+eB,0,eS.minX,eS.maxX,ew),ek=u(en,eM,eu+eO,eu+eF,0,eS.minX,eS.maxX,ew),en=null,eL&&(eC=u(eL,eM,ec-eR,ec+eB,1,eS.minY,eS.maxY,ew),eP=u(eL,eM,ec+eO,ec+eF,1,eS.minY,eS.maxY,ew),eL=null),ek&&(ez=u(ek,eM,ec-eR,ec+eB,1,eS.minY,eS.maxY,ew),eD=u(ek,eM,ec+eO,ec+eF,1,eS.minY,eS.maxY,ew),ek=null),eT>1&&console.timeEnd("clipping"),e_.push(eC||[],el+1,2*eu,2*ec),e_.push(eP||[],el+1,2*eu,2*ec+1),e_.push(ez||[],el+1,2*eu+1,2*ec),e_.push(eD||[],el+1,2*eu+1,2*ec+1)}}},k.prototype.getTile=function(en,el,eu){var ec=this.options,ed=ec.extent,ef=ec.debug;if(en<0||en>24)return null;var em=1<<en,e_=P(en,el=(el%em+em)%em,eu);if(this.tiles[e_])return x(this.tiles[e_],ed);ef>1&&console.log("drilling down to z%d-%d-%d",en,el,eu);for(var ew,eT=en,eM=el,eE=eu;!ew&&eT>0;)eT--,eM=Math.floor(eM/2),eE=Math.floor(eE/2),ew=this.tiles[P(eT,eM,eE)];return ew&&ew.source?(ef>1&&console.log("found parent tile z%d-%d-%d",eT,eM,eE),ef>1&&console.time("drilling down"),this.splitTile(ew.source,eT,eM,eE,en,el,eu),ef>1&&console.timeEnd("drilling down"),this.tiles[e_]?x(this.tiles[e_],ed):null):null},function(en,el){return new k(en,el)}}();var eS=en.dc(eE.exports);function Y(el,eu){let ed=el.tileID.canonical;if(!this._geoJSONIndex)return eu(null,null);let ef=this._geoJSONIndex.getTile(ed.z,ed.x,ed.y);if(!ef)return eu(null,null);let em=new class{constructor(el){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=en.J,this.length=el.length,this._features=el}feature(el){return new class{constructor(el){this._feature=el,this.extent=en.J,this.type=el.type,this.properties=el.tags,"id"in el&&!isNaN(el.id)&&(this.id=parseInt(el.id,10))}loadGeometry(){if(1===this._feature.type){let el=[];for(let eu of this._feature.geometry)el.push([new en.P(eu[0],eu[1])]);return el}{let el=[];for(let eu of this._feature.geometry){let ec=[];for(let el of eu)ec.push(new en.P(el[0],el[1]));el.push(ec)}return el}}toGeoJSON(en,el,eu){return ec.call(this,en,el,eu)}}(this._features[el])}}(ef.features),e_=ew(em);0===e_.byteOffset&&e_.byteLength===e_.buffer.byteLength||(e_=new Uint8Array(e_)),eu(null,{vectorTile:em,rawData:e_.buffer})}let G=class G extends en.dh{constructor(en,el,eu,ec,ed,ef){super(en,el,eu,ec,Y,ef),ed&&(this.loadGeoJSON=ed)}loadData(el,ec){let ed=el&&el.request,ef=ed&&ed.collectResourceTiming;this.loadGeoJSON(el,(em,e_)=>{if(em||!e_)return ec(em);if("object"!=typeof e_)return ec(Error(`Input data given to '${el.source}' is not a valid GeoJSON object.`));{eu(e_,!0);try{if(el.filter){let eu=en.cw(el.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===eu.result)throw Error(eu.value.map(en=>`${en.key}: ${en.message}`).join(", "));let ec=e_.features.filter(en=>eu.value.evaluate({zoom:0},en));e_={type:"FeatureCollection",features:ec}}this._geoJSONIndex=el.cluster?new j(function({superclusterOptions:el,clusterProperties:eu}){if(!eu||!el)return el;let ec={},ed={},ef={accumulated:null,zoom:0},em={properties:null},e_=Object.keys(eu);for(let el of e_){let[ef,em]=eu[el],e_=en.cw(em),ew=en.cw("string"==typeof ef?[ef,["accumulated"],["get",el]]:ef);ec[el]=e_.value,ed[el]=ew.value}return el.map=en=>{em.properties=en;let el={};for(let en of e_)el[en]=ec[en].evaluate(ef,em);return el},el.reduce=(en,el)=>{for(let eu of(em.properties=el,e_))ef.accumulated=en[eu],en[eu]=ed[eu].evaluate(ef,em)},el}(el)).load(e_.features):eS(e_,el.geojsonVtOptions)}catch(en){return ec(en)}this.loaded={};let em={};if(ef){let eu=en.di(ed);eu&&(em.resourceTiming={},em.resourceTiming[el.source]=JSON.parse(JSON.stringify(eu)))}ec(null,em)}})}reloadTile(en,el){let eu=this.loaded;return eu&&eu[en.uid]?super.reloadTile(en,el):this.loadTile(en,el)}loadGeoJSON(el,eu){if(el.request)en.a1(el.request,eu);else{if("string"!=typeof el.data)return eu(Error(`Input data given to '${el.source}' is not a valid GeoJSON object.`));try{return eu(null,JSON.parse(el.data))}catch(en){return eu(Error(`Input data given to '${el.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(en,el){try{el(null,this._geoJSONIndex.getClusterExpansionZoom(en.clusterId))}catch(en){el(en)}}getClusterChildren(en,el){try{el(null,this._geoJSONIndex.getChildren(en.clusterId))}catch(en){el(en)}}getClusterLeaves(en,el){try{el(null,this._geoJSONIndex.getLeaves(en.clusterId,en.limit,en.offset))}catch(en){el(en)}}};let W=class W{constructor(el,eu){this.tileID=new en.O(el.tileID.overscaledZ,el.tileID.wrap,el.tileID.canonical.z,el.tileID.canonical.x,el.tileID.canonical.y),this.tileZoom=el.tileZoom,this.uid=el.uid,this.zoom=el.zoom,this.canonical=el.tileID.canonical,this.pixelRatio=el.pixelRatio,this.tileSize=el.tileSize,this.source=el.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=el.projection,this.brightness=eu}parse(el,eu,ec,ed){this.status="parsing";let ef=new en.O(ec.tileID.overscaledZ,ec.tileID.wrap,ec.tileID.canonical.z,ec.tileID.canonical.x,ec.tileID.canonical.y),em={},e_=eu.familiesBySource[ec.source],ew=new en.dk(ef,ec.promoteId);return ew.bucketLayerIDs=[],en.dl(el).then(el=>{if(!el)return ed(Error("Could not parse tile"));let eu=en.dm(el,1/en.cg(ec.tileID.canonical)),eT=el.json.extensionsUsed&&el.json.extensionsUsed.includes("MAPBOX_mesh_features"),eM=new en.al(this.zoom,{brightness:this.brightness});for(let ec in e_)for(let ed of e_[ec]){let ec=ed[0],e_=el.json.extensionsUsed;ec.recalculate(eM,[]);let ew=new en.dn(eu,ef,e_&&e_.includes("MAPBOX_mesh_features"),this.brightness);eT||(ew.needsUpload=!0),em[ec.fqid]=ew,ew.evaluate(ec)}this.status="done",ed(null,{buckets:em,featureIndex:ew})}).catch(en=>ed(Error(en.message)))}};let X=class X{constructor(en,el,eu,ec,ed,ef){this.actor=en,this.layerIndex=el,this.brightness=ef,this.loading={},this.loaded={}}loadTile(el,eu){let ec=el.uid,ed=this.loading[ec]=new W(el,this.brightness);en.dj(el.request,(en,ef)=>{let em=!this.loading[ec];return delete this.loading[ec],em||en?(ed.status="done",em||(this.loaded[ec]=ed),eu(en)):ef&&0!==ef.byteLength?void ed.parse(ef,this.layerIndex,el,(en,el)=>{ed.status="done",this.loaded=this.loaded||{},this.loaded[ec]=ed,en||!el?eu(en):eu(null,el)}):(ed.status="done",this.loaded[ec]=ed,eu())})}reloadTile(en,el){let eu=this.loaded,ec=en.uid;if(eu&&eu[ec]){let ed=eu[ec];ed.projection=en.projection,ed.brightness=en.brightness,"parsing"===ed.status?ed.reloadCallback=(eu,ec)=>{ed.reloadCallback&&(delete ed.reloadCallback,this.loadTile(en,el)),el(eu,ec)}:"done"===ed.status&&this.loadTile(en,el)}}abortTile(en,el){let eu=en.uid;this.loading[eu]&&delete this.loading[eu],el()}removeTile(en,el){let eu=this.loaded,ec=en.uid;eu&&eu[ec]&&delete eu[ec],el()}};let q=class q{constructor(el){this.self=el,this.actor=new en.dp(el,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=en.o({name:"mercator"}),this.workerSourceTypes={vector:en.dh,geojson:G,"batched-model":X},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(en,el)=>{if(this.workerSourceTypes[en])throw Error(`Worker source with name "${en}" already registered.`);this.workerSourceTypes[en]=el},this.self.registerRTLTextPlugin=el=>{if(en.dq.isParsed())throw Error("RTL text plugin already registered.");en.dq.applyArabicShaping=el.applyArabicShaping,en.dq.processBidirectionalText=el.processBidirectionalText,en.dq.processStyledBidirectionalText=el.processStyledBidirectionalText}}clearCaches(en,el,eu){delete this.layerIndexes[en],delete this.availableImages[en],delete this.workerSources[en],delete this.demWorkerSources[en],eu()}checkIfReady(en,el,eu){eu()}setReferrer(en,el){this.referrer=el}spriteLoaded(el,{scope:eu,isLoaded:ec}){if(this.isSpriteLoaded[el]||(this.isSpriteLoaded[el]={}),this.isSpriteLoaded[el][eu]=ec,this.workerSources[el]&&this.workerSources[el][eu])for(let ed in this.workerSources[el][eu]){let ef=this.workerSources[el][eu][ed];for(let el in ef)ef[el]instanceof en.dh&&(ef[el].isSpriteLoaded=ec,ef[el].fire(new en.a8("isSpriteLoaded")))}}setImages(en,{scope:el,images:eu},ec){if(this.availableImages[en]||(this.availableImages[en]={}),this.availableImages[en][el]=eu,this.workerSources[en]&&this.workerSources[en][el]){for(let ec in this.workerSources[en][el]){let ed=this.workerSources[en][el][ec];for(let en in ed)ed[en].availableImages=eu}ec()}else ec()}setProjection(el,eu){this.projections[el]=en.o(eu)}setBrightness(en,el,eu){this.brightness=el,eu()}setLayers(en,el,eu){this.getLayerIndex(en,el.scope).replace(el.layers,el.options),eu()}updateLayers(en,el,eu){this.getLayerIndex(en,el.scope).update(el.layers,el.removedIds,el.options),eu()}loadTile(en,el,eu){el.projection=this.projections[en]||this.defaultProjection,this.getWorkerSource(en,el.type,el.source,el.scope).loadTile(el,eu)}loadDEMTile(en,el,eu){this.getDEMWorkerSource(en,el.source,el.scope).loadTile(el,eu)}reloadTile(en,el,eu){el.projection=this.projections[en]||this.defaultProjection,this.getWorkerSource(en,el.type,el.source,el.scope).reloadTile(el,eu)}abortTile(en,el,eu){this.getWorkerSource(en,el.type,el.source,el.scope).abortTile(el,eu)}removeTile(en,el,eu){this.getWorkerSource(en,el.type,el.source,el.scope).removeTile(el,eu)}removeSource(en,el,eu){if(!(this.workerSources[en]&&this.workerSources[en][el.scope]&&this.workerSources[en][el.scope][el.type]&&this.workerSources[en][el.scope][el.type][el.source]))return;let ec=this.workerSources[en][el.scope][el.type][el.source];delete this.workerSources[en][el.scope][el.type][el.source],void 0!==ec.removeSource?ec.removeSource(el,eu):eu()}loadWorkerSource(en,el,eu){try{this.self.importScripts(el.url),eu()}catch(en){eu(en.toString())}}syncRTLPluginState(el,eu,ec){try{en.dq.setState(eu);let el=en.dq.getPluginURL();if(en.dq.isLoaded()&&!en.dq.isParsed()&&null!=el){this.self.importScripts(el);let eu=en.dq.isParsed();ec(eu?void 0:Error(`RTL Text Plugin failed to import scripts from ${el}`),eu)}}catch(en){ec(en.toString())}}setDracoUrl(en,el){this.dracoUrl=el}getAvailableImages(en,el){this.availableImages[en]||(this.availableImages[en]={});let eu=this.availableImages[en][el];return eu||(eu=[]),eu}getLayerIndex(en,el){this.layerIndexes[en]||(this.layerIndexes[en]={});let eu=this.layerIndexes[en][el];return eu||((eu=this.layerIndexes[en][el]=new o).scope=el),eu}getWorkerSource(en,el,eu,ec){if(this.workerSources[en]||(this.workerSources[en]={}),this.workerSources[en][ec]||(this.workerSources[en][ec]={}),this.workerSources[en][ec][el]||(this.workerSources[en][ec][el]={}),this.isSpriteLoaded[en]||(this.isSpriteLoaded[en]={}),!this.workerSources[en][ec][el][eu]){let ed={send:(el,eu,ec,ed,ef,em)=>{this.actor.send(el,eu,ec,en,ef,em)},scheduler:this.actor.scheduler};this.workerSources[en][ec][el][eu]=new this.workerSourceTypes[el](ed,this.getLayerIndex(en,ec),this.getAvailableImages(en,ec),this.isSpriteLoaded[en][ec],void 0,this.brightness)}return this.workerSources[en][ec][el][eu]}getDEMWorkerSource(en,el,eu){return this.demWorkerSources[en]||(this.demWorkerSources[en]={}),this.demWorkerSources[en][eu]||(this.demWorkerSources[en][eu]={}),this.demWorkerSources[en][eu][el]||(this.demWorkerSources[en][eu][el]=new i),this.demWorkerSources[en][eu][el]}enforceCacheSizeLimit(el,eu){en.dr(eu)}getWorkerPerformanceMetrics(en,el,eu){eu(void 0,void 0)}};return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope&&(self.worker=new q(self)),q}),define(["./shared"],function(en){let el,eu;function t(en,el){if(Array.isArray(en)){if(!Array.isArray(el)||en.length!==el.length)return!1;for(let eu=0;eu<en.length;eu++)if(!t(en[eu],el[eu]))return!1;return!0}if("object"==typeof en&&null!==en&&null!==el){if("object"!=typeof el||Object.keys(en).length!==Object.keys(el).length)return!1;for(let eu in en)if(!t(en[eu],el[eu]))return!1;return!0}return en===el}function o(en){var el;return"undefined"!=typeof window&&"undefined"!=typeof document&&!!function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var en,el,eu=new Blob([""],{type:"text/javascript"}),ec=URL.createObjectURL(eu);try{el=new Worker(ec),en=!0}catch(el){en=!1}return el&&el.terminate(),URL.revokeObjectURL(ec),en}()&&!!function(){var en=document.createElement("canvas");en.width=en.height=1;var el=en.getContext("2d");if(!el)return!1;var eu=el.getImageData(0,0,1,1);return eu&&eu.width===en.width}()&&(void 0===ec[el=en&&en.failIfMajorPerformanceCaveat]&&(ec[el]=function(en){var el,eu,ec,ed=(el=document.createElement("canvas"),(eu=Object.create(o.webGLContextAttributes)).failIfMajorPerformanceCaveat=en,el.getContext("webgl2",eu));if(!ed)return!1;try{ec=ed.createShader(ed.VERTEX_SHADER)}catch(en){return!1}return!(!ec||ed.isContextLost())&&(ed.shaderSource(ec,"void main() {}"),ed.compileShader(ec),!0===ed.getShaderParameter(ec,ed.COMPILE_STATUS))}(el)),!!ec[el]&&!document.documentMode)}var ec={};function s(en,el,eu){let ec=document.createElement(en);return null!=el&&(ec.className=el),eu&&eu.appendChild(ec),ec}function n(en,el,eu){let ec=document.createElementNS("http://www.w3.org/2000/svg",en);for(let en of Object.keys(el))ec.setAttributeNS(null,en,String(el[en]));return eu&&eu.appendChild(ec),ec}o.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};let ed="undefined"!=typeof document?document.documentElement&&document.documentElement.style:null,ef=ed&&void 0!==ed.userSelect?"userSelect":"WebkitUserSelect";function h(){ed&&ef&&(el=ed[ef],ed[ef]="none")}function _(){ed&&ef&&(ed[ef]=el)}function d(en){en.preventDefault(),en.stopPropagation(),window.removeEventListener("click",d,!0)}function u(){window.addEventListener("click",d,!0),window.setTimeout(()=>{window.removeEventListener("click",d,!0)},0)}function p(en,el){let eu=en.getBoundingClientRect();return g(en,eu,el)}function m(en,el){let eu=en.getBoundingClientRect(),ec=[];for(let ed=0;ed<el.length;ed++)ec.push(g(en,eu,el[ed]));return ec}function f(en){return void 0!==window.InstallTrigger&&2===en.button&&en.ctrlKey&&window.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:en.button}function g(el,eu,ec){let ed=el.offsetWidth===eu.width?1:el.offsetWidth/eu.width;return new en.P((ec.clientX-eu.left)*ed,(ec.clientY-eu.top)*ed)}let v=class v{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages=new Set}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(en,el){this._updatedSourceCaches[en]=el,this.setDirty()}discardSourceCacheUpdate(en){delete this._updatedSourceCaches[en]}updateLayer(en){let el=en.scope;this._updatedLayers[el]=this._updatedLayers[el]||new Set,this._updatedLayers[el].add(en.id),this.setDirty()}removeLayer(en){let el=en.scope;this._removedLayers[el]=this._removedLayers[el]||{},this._updatedLayers[el]=this._updatedLayers[el]||new Set,this._removedLayers[el][en.id]=en,this._updatedLayers[el].delete(en.id),this._updatedPaintProps.delete(en.fqid),this.setDirty()}getRemovedLayer(en){return this._removedLayers[en.scope]?this._removedLayers[en.scope][en.id]:null}discardLayerRemoval(en){this._removedLayers[en.scope]&&delete this._removedLayers[en.scope][en.id]}getLayerUpdatesByScope(){let en={};for(let el in this._updatedLayers)en[el]=en[el]||{},en[el].updatedIds=Array.from(this._updatedLayers[el].values());for(let el in this._removedLayers)en[el]=en[el]||{},en[el].removedIds=Object.keys(this._removedLayers[el]);return en}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(en){this._updatedPaintProps.add(en.fqid),this.setDirty()}getUpdatedImages(){return Array.from(this._updatedImages.values())}updateImage(en){this._updatedImages.add(en),this.setDirty()}resetUpdatedImages(){this._updatedImages.clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages.clear()}};let em={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};let y=class y{constructor(en,el,eu,ec,ed,ef){this.length=el.length,this.attributes=eu,this.itemSize=el.bytesPerElement,this.dynamicDraw=ec,this.instanceCount=ef,this.context=en;let em=en.gl;this.buffer=em.createBuffer(),en.bindVertexBuffer.set(this.buffer),em.bufferData(em.ARRAY_BUFFER,el.arrayBuffer,this.dynamicDraw?em.DYNAMIC_DRAW:em.STATIC_DRAW),this.dynamicDraw||ed||el.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(en){let el=this.context.gl;this.bind(),el.bufferSubData(el.ARRAY_BUFFER,0,en.arrayBuffer)}enableAttributes(en,el){for(let eu=0;eu<this.attributes.length;eu++){let ec=el.attributes[this.attributes[eu].name];void 0!==ec&&en.enableVertexAttribArray(ec)}}setVertexAttribPointers(en,el,eu){for(let ec=0;ec<this.attributes.length;ec++){let ed=this.attributes[ec],ef=el.attributes[ed.name];void 0!==ef&&en.vertexAttribPointer(ef,ed.components,en[em[ed.type]],!1,this.itemSize,ed.offset+this.itemSize*(eu||0))}}setVertexAttribDivisor(en,el,eu){for(let ec=0;ec<this.attributes.length;ec++){let ed=el.attributes[this.attributes[ec].name];void 0!==ed&&this.instanceCount&&this.instanceCount>0&&en.vertexAttribDivisor(ed,eu)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}};let b=class b{constructor(en){this.gl=en.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(en){}getDefault(){return this.default}setDefault(){this.set(this.default)}};let w=class w extends b{getDefault(){return en.C.transparent}set(en){let el=this.current;(en.r!==el.r||en.g!==el.g||en.b!==el.b||en.a!==el.a||this.dirty)&&(this.gl.clearColor(en.r,en.g,en.b,en.a),this.current=en,this.dirty=!1)}};let T=class T extends b{getDefault(){return 1}set(en){(en!==this.current||this.dirty)&&(this.gl.clearDepth(en),this.current=en,this.dirty=!1)}};let E=class E extends b{getDefault(){return 0}set(en){(en!==this.current||this.dirty)&&(this.gl.clearStencil(en),this.current=en,this.dirty=!1)}};let C=class C extends b{getDefault(){return[!0,!0,!0,!0]}set(en){let el=this.current;(en[0]!==el[0]||en[1]!==el[1]||en[2]!==el[2]||en[3]!==el[3]||this.dirty)&&(this.gl.colorMask(en[0],en[1],en[2],en[3]),this.current=en,this.dirty=!1)}};let I=class I extends b{getDefault(){return!0}set(en){(en!==this.current||this.dirty)&&(this.gl.depthMask(en),this.current=en,this.dirty=!1)}};let S=class S extends b{getDefault(){return 255}set(en){(en!==this.current||this.dirty)&&(this.gl.stencilMask(en),this.current=en,this.dirty=!1)}};let M=class M extends b{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(en){let el=this.current;(en.func!==el.func||en.ref!==el.ref||en.mask!==el.mask||this.dirty)&&(this.gl.stencilFunc(en.func,en.ref,en.mask),this.current=en,this.dirty=!1)}};let L=class L extends b{getDefault(){let en=this.gl;return[en.KEEP,en.KEEP,en.KEEP]}set(en){let el=this.current;(en[0]!==el[0]||en[1]!==el[1]||en[2]!==el[2]||this.dirty)&&(this.gl.stencilOp(en[0],en[1],en[2]),this.current=en,this.dirty=!1)}};let P=class P extends b{getDefault(){return!1}set(en){if(en===this.current&&!this.dirty)return;let el=this.gl;en?el.enable(el.STENCIL_TEST):el.disable(el.STENCIL_TEST),this.current=en,this.dirty=!1}};let D=class D extends b{getDefault(){return[0,1]}set(en){let el=this.current;(en[0]!==el[0]||en[1]!==el[1]||this.dirty)&&(this.gl.depthRange(en[0],en[1]),this.current=en,this.dirty=!1)}};let A=class A extends b{getDefault(){return!1}set(en){if(en===this.current&&!this.dirty)return;let el=this.gl;en?el.enable(el.DEPTH_TEST):el.disable(el.DEPTH_TEST),this.current=en,this.dirty=!1}};let R=class R extends b{getDefault(){return this.gl.LESS}set(en){(en!==this.current||this.dirty)&&(this.gl.depthFunc(en),this.current=en,this.dirty=!1)}};let z=class z extends b{getDefault(){return!1}set(en){if(en===this.current&&!this.dirty)return;let el=this.gl;en?el.enable(el.BLEND):el.disable(el.BLEND),this.current=en,this.dirty=!1}};let O=class O extends b{getDefault(){let en=this.gl;return[en.ONE,en.ZERO,en.ONE,en.ZERO]}set(en){let el=this.current;(en[0]!==el[0]||en[1]!==el[1]||en[2]!==el[2]||en[3]!==el[3]||this.dirty)&&(this.gl.blendFuncSeparate(en[0],en[1],en[2],en[3]),this.current=en,this.dirty=!1)}};let F=class F extends b{getDefault(){return en.C.transparent}set(en){let el=this.current;(en.r!==el.r||en.g!==el.g||en.b!==el.b||en.a!==el.a||this.dirty)&&(this.gl.blendColor(en.r,en.g,en.b,en.a),this.current=en,this.dirty=!1)}};let B=class B extends b{getDefault(){return this.gl.FUNC_ADD}set(en){(en!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(en,en),this.current=en,this.dirty=!1)}};let k=class k extends b{getDefault(){return!1}set(en){if(en===this.current&&!this.dirty)return;let el=this.gl;en?el.enable(el.CULL_FACE):el.disable(el.CULL_FACE),this.current=en,this.dirty=!1}};let N=class N extends b{getDefault(){return this.gl.BACK}set(en){(en!==this.current||this.dirty)&&(this.gl.cullFace(en),this.current=en,this.dirty=!1)}};let U=class U extends b{getDefault(){return this.gl.CCW}set(en){(en!==this.current||this.dirty)&&(this.gl.frontFace(en),this.current=en,this.dirty=!1)}};let e_=class extends b{getDefault(){return null}set(en){(en!==this.current||this.dirty)&&(this.gl.useProgram(en),this.current=en,this.dirty=!1)}};let j=class j extends b{getDefault(){return this.gl.TEXTURE0}set(en){(en!==this.current||this.dirty)&&(this.gl.activeTexture(en),this.current=en,this.dirty=!1)}};let V=class V extends b{getDefault(){let en=this.gl;return[0,0,en.drawingBufferWidth,en.drawingBufferHeight]}set(en){let el=this.current;(en[0]!==el[0]||en[1]!==el[1]||en[2]!==el[2]||en[3]!==el[3]||this.dirty)&&(this.gl.viewport(en[0],en[1],en[2],en[3]),this.current=en,this.dirty=!1)}};let Z=class Z extends b{getDefault(){return null}set(en){if(en===this.current&&!this.dirty)return;let el=this.gl;el.bindFramebuffer(el.FRAMEBUFFER,en),this.current=en,this.dirty=!1}};let W=class W extends b{getDefault(){return null}set(en){if(en===this.current&&!this.dirty)return;let el=this.gl;el.bindRenderbuffer(el.RENDERBUFFER,en),this.current=en,this.dirty=!1}};let H=class H extends b{getDefault(){return null}set(en){if(en===this.current&&!this.dirty)return;let el=this.gl;el.bindTexture(el.TEXTURE_2D,en),this.current=en,this.dirty=!1}};let q=class q extends b{getDefault(){return null}set(en){if(en===this.current&&!this.dirty)return;let el=this.gl;el.bindBuffer(el.ARRAY_BUFFER,en),this.current=en,this.dirty=!1}};let $=class $ extends b{getDefault(){return null}set(en){let el=this.gl;el.bindBuffer(el.ELEMENT_ARRAY_BUFFER,en),this.current=en,this.dirty=!1}};let X=class X extends b{getDefault(){return null}set(en){this.gl&&(en!==this.current||this.dirty)&&(this.gl.bindVertexArray(en),this.current=en,this.dirty=!1)}};let J=class J extends b{getDefault(){return 4}set(en){if(en===this.current&&!this.dirty)return;let el=this.gl;el.pixelStorei(el.UNPACK_ALIGNMENT,en),this.current=en,this.dirty=!1}};let Y=class Y extends b{getDefault(){return!1}set(en){if(en===this.current&&!this.dirty)return;let el=this.gl;el.pixelStorei(el.UNPACK_PREMULTIPLY_ALPHA_WEBGL,en),this.current=en,this.dirty=!1}};let K=class K extends b{getDefault(){return!1}set(en){if(en===this.current&&!this.dirty)return;let el=this.gl;el.pixelStorei(el.UNPACK_FLIP_Y_WEBGL,en),this.current=en,this.dirty=!1}};let Q=class Q extends b{constructor(en,el){super(en),this.context=en,this.parent=el}getDefault(){return null}};let ee=class ee extends Q{setDirty(){this.dirty=!0}set(en){if(en===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let el=this.gl;el.framebufferTexture2D(el.FRAMEBUFFER,el.COLOR_ATTACHMENT0,el.TEXTURE_2D,en,0),this.current=en,this.dirty=!1}};let te=class te extends Q{attachment(){return this.gl.DEPTH_ATTACHMENT}set(en){if(en===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let el=this.gl;el.framebufferRenderbuffer(el.FRAMEBUFFER,this.attachment(),el.RENDERBUFFER,en),this.current=en,this.dirty=!1}};let ie=class ie extends Q{attachment(){return this.gl.DEPTH_ATTACHMENT}set(en){if(en===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let el=this.gl;el.framebufferTexture2D(el.FRAMEBUFFER,this.attachment(),el.TEXTURE_2D,en,0),this.current=en,this.dirty=!1}};let oe=class oe extends te{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}};let re=class re{constructor(en,el,eu,ec,ed){this.context=en,this.width=el,this.height=eu;let ef=this.framebuffer=en.gl.createFramebuffer();ec&&(this.colorAttachment=new ee(en,ef)),ed&&(this.depthAttachmentType=ed,this.depthAttachment="renderbuffer"===ed?new te(en,ef):new ie(en,ef))}destroy(){let en=this.context.gl;if(this.colorAttachment){let el=this.colorAttachment.get();el&&en.deleteTexture(el)}if(this.depthAttachment&&this.depthAttachmentType){if("renderbuffer"===this.depthAttachmentType){let el=this.depthAttachment.get();el&&en.deleteRenderbuffer(el)}else{let el=this.depthAttachment.get();el&&en.deleteTexture(el)}}en.deleteFramebuffer(this.framebuffer)}};let se=class se{constructor(en,el){this.gl=en,this.clearColor=new w(this),this.clearDepth=new T(this),this.clearStencil=new E(this),this.colorMask=new C(this),this.depthMask=new I(this),this.stencilMask=new S(this),this.stencilFunc=new M(this),this.stencilOp=new L(this),this.stencilTest=new P(this),this.depthRange=new D(this),this.depthTest=new A(this),this.depthFunc=new R(this),this.blend=new z(this),this.blendFunc=new O(this),this.blendColor=new F(this),this.blendEquation=new B(this),this.cullFace=new k(this),this.cullFaceSide=new N(this),this.frontFace=new U(this),this.program=new e_(this),this.activeTexture=new j(this),this.viewport=new V(this),this.bindFramebuffer=new Z(this),this.bindRenderbuffer=new W(this),this.bindTexture=new H(this),this.bindVertexBuffer=new q(this),this.bindElementBuffer=new $(this),this.bindVertexArrayOES=new X(this),this.pixelStoreUnpack=new J(this),this.pixelStoreUnpackPremultiplyAlpha=new Y(this),this.pixelStoreUnpackFlipY=new K(this),this.options=el?{...el}:{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=en.getExtension("EXT_texture_filter_anisotropic")||en.getExtension("MOZ_EXT_texture_filter_anisotropic")||en.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=en.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=en.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=en.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=en.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=en.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=en.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=en.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=en.getParameter(en.MAX_TEXTURE_SIZE)}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(el,eu,ec){return new en.I(this,el,eu,ec)}createVertexBuffer(en,el,eu,ec,ed){return new y(this,en,el,eu,ec,ed)}createRenderbuffer(en,el,eu){let ec=this.gl,ed=ec.createRenderbuffer();return this.bindRenderbuffer.set(ed),ec.renderbufferStorage(ec.RENDERBUFFER,en,el,eu),this.bindRenderbuffer.set(null),ed}createFramebuffer(en,el,eu,ec){return new re(this,en,el,eu,ec)}clear({color:en,depth:el,stencil:eu,colorMask:ec}){let ed=this.gl,ef=0;en&&(ef|=ed.COLOR_BUFFER_BIT,this.clearColor.set(en),this.colorMask.set(ec||[!0,!0,!0,!0])),void 0!==el&&(ef|=ed.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(el),this.depthMask.set(!0)),void 0!==eu&&(ef|=ed.STENCIL_BUFFER_BIT,this.clearStencil.set(eu),this.stencilMask.set(255)),ed.clear(ef)}setCullFace(en){!1===en.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(en.mode),this.frontFace.set(en.frontFace))}setDepthMode(en){en.func!==this.gl.ALWAYS||en.mask?(this.depthTest.set(!0),this.depthFunc.set(en.func),this.depthMask.set(en.mask),this.depthRange.set(en.range)):this.depthTest.set(!1)}setStencilMode(en){en.test.func!==this.gl.ALWAYS||en.mask?(this.stencilTest.set(!0),this.stencilMask.set(en.mask),this.stencilOp.set([en.fail,en.depthFail,en.pass]),this.stencilFunc.set({func:en.test.func,ref:en.ref,mask:en.test.mask})):this.stencilTest.set(!1)}setColorMode(el){t(el.blendFunction,en.a.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(el.blendFunction),this.blendColor.set(el.blendColor),el.blendEquation?this.blendEquation.set(el.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(el.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}};let ne=class ne{constructor(en=0,el=0,eu=0,ec=0){if(isNaN(en)||en<0||isNaN(el)||el<0||isNaN(eu)||eu<0||isNaN(ec)||ec<0)throw Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=en,this.bottom=el,this.left=eu,this.right=ec}interpolate(el,eu,ec){return null!=eu.top&&null!=el.top&&(this.top=en.n(el.top,eu.top,ec)),null!=eu.bottom&&null!=el.bottom&&(this.bottom=en.n(el.bottom,eu.bottom,ec)),null!=eu.left&&null!=el.left&&(this.left=en.n(el.left,eu.left,ec)),null!=eu.right&&null!=el.right&&(this.right=en.n(el.right,eu.right,ec)),this}getCenter(el,eu){let ec=en.c((this.left+el-this.right)/2,0,el),ed=en.c((this.top+eu-this.bottom)/2,0,eu);return new en.P(ec,ed)}equals(en){return this.top===en.top&&this.bottom===en.bottom&&this.left===en.left&&this.right===en.right}clone(){return new ne(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}};function ae(el,eu){let ec=en.g(el,3);en.m.fromQuat(el,eu),en.s(el,3,ec)}function le(el,eu){let ec=en.q.identity([]);return en.q.rotateZ(ec,ec,-eu),en.q.rotateX(ec,ec,-el),ec}function ce(el,eu){let ec=[el[0],el[1],0],ed=[eu[0],eu[1],0];if(en.v.length(ec)>=1e-15){let el=en.v.normalize([],ec);en.v.scale(ed,el,en.v.dot(ed,el)),eu[0]=ed[0],eu[1]=ed[1]}let ef=en.v.cross([],eu,el);if(1e-15>en.v.len(ef))return null;let em=Math.atan2(-ef[1],ef[0]);return le(Math.atan2(Math.sqrt(el[0]*el[0]+el[1]*el[1]),-el[2]),em)}let he=class he{constructor(en,el){this.position=en,this.orientation=el}get position(){return this._position}set position(el){if(el){let eu=el instanceof en.M?el:new en.M(el[0],el[1],el[2]);this._renderWorldCopies&&(eu.x=en.w(eu.x,0,1)),this._position=eu}else this._position=null}lookAtPoint(el,eu){if(this.orientation=null,!this.position)return;let ec=this.position,ed=this._elevation?this._elevation.getAtPointOrZero(en.M.fromLngLat(el)):0,ef=en.M.fromLngLat(el,ed),em=[ef.x-ec.x,ef.y-ec.y,ef.z-ec.z];eu||(eu=[0,0,1]),eu[2]=Math.abs(eu[2]),this.orientation=ce(em,eu)}setPitchBearing(el,eu){this.orientation=le(en.d(el),en.d(-eu))}};let _e=class _e{constructor(el,eu){this._transform=en.m.identity([]),this.orientation=eu,this.position=el}get mercatorPosition(){let el=this.position;return new en.M(el[0],el[1],el[2])}get position(){let el=en.g(this._transform,3);return[el[0],el[1],el[2]]}set position(el){el&&en.s(this._transform,3,[el[0],el[1],el[2],1])}get orientation(){return this._orientation}set orientation(el){this._orientation=el||en.q.identity([]),el&&ae(this._transform,this._orientation)}getPitchBearing(){let en=this.forward(),el=this.right();return{bearing:Math.atan2(-el[1],el[0]),pitch:Math.atan2(Math.sqrt(en[0]*en[0]+en[1]*en[1]),-en[2])}}setPitchBearing(en,el){this._orientation=le(en,el),ae(this._transform,this._orientation)}forward(){let el=en.g(this._transform,2);return[-el[0],-el[1],-el[2]]}up(){let el=en.g(this._transform,1);return[-el[0],-el[1],-el[2]]}right(){let el=en.g(this._transform,0);return[el[0],el[1],el[2]]}getCameraToWorld(el,eu){let ec=new Float64Array(16);return en.m.invert(ec,this.getWorldToCamera(el,eu)),ec}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(el,eu,ec){let ed=this.position;en.v.scale(ed,ed,-el);let ef=new Float64Array(16);return en.m.fromScaling(ef,[ec,ec,ec]),en.m.translate(ef,ef,ed),ef[10]*=eu,ef}getWorldToCamera(el,eu){let ec=new Float64Array(16),ed=new Float64Array(4),ef=this.position;return en.q.conjugate(ed,this._orientation),en.v.scale(ef,ef,-el),en.m.fromQuat(ec,ed),en.m.translate(ec,ec,ef),ec[1]*=-1,ec[5]*=-1,ec[9]*=-1,ec[13]*=-1,ec[8]*=eu,ec[9]*=eu,ec[10]*=eu,ec[11]*=eu,ec}getCameraToClipPerspective(el,eu,ec,ed){let ef=new Float64Array(16);return en.m.perspective(ef,el,eu,ec,ed),ef}getCameraToClipOrthographic(el,eu,ec,ed,ef,em){let e_=new Float64Array(16);return en.m.ortho(e_,el,eu,ec,ed,ef,em),e_}getDistanceToElevation(el,eu=!1){let ec=0===el?0:en.b(el,eu?en.l(this.position[1]):this.position[1]),ed=this.forward();return(ec-this.position[2])/ed[2]}clone(){return new _e([...this.position],[...this.orientation])}};let ew={unknown:0,flipRequired:1,flipNotRequired:2},eT=Math.tan(85*Math.PI/180);function pe(el,eu,ec,ed,ef,em,e_){let ew=en.m.create();if(ec){if("globe"===em.name){let el=en.f(ef,eu);en.m.multiply(ew,ew,el)}else{let el=en.h.invert([],e_);ew[0]=el[0],ew[1]=el[1],ew[4]=el[2],ew[5]=el[3],ed||en.m.rotateZ(ew,ew,ef.angle)}}else en.m.multiply(ew,ef.labelPlaneMatrix,el);return ew}function me(en,el,eu,ec,ed,ef,em){let e_=pe(en,el,eu,ec,ed,ef,em);return"globe"===ef.name&&eu||(e_[2]=e_[6]=e_[10]=e_[14]=0),e_}function fe(el,eu,ec,ed,ef,em,e_){if(ec){if("globe"===em.name){let ew=pe(el,eu,ec,ed,ef,em,e_);return en.m.invert(ew,ew),en.m.multiply(ew,el,ew),ew}{let eu=en.m.clone(el),ec=en.m.identity([]);return ec[0]=e_[0],ec[1]=e_[1],ec[4]=e_[2],ec[5]=e_[3],en.m.multiply(eu,eu,ec),ed||en.m.rotateZ(eu,eu,-ef.angle),eu}}return ef.glCoordMatrix}function ge(el,eu,ec,ed){let ef=[el,eu,ec,1];ec?en.e.transformMat4(ef,ef,ed):Me(ef,ef,ed);let em=ef[3];return ef[0]/=em,ef[1]/=em,ef[2]/=em,ef}function ve(en,el){return Math.min(.5+en/el*.5,1.5)}function be(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC){let{lineStartIndex:eP,glyphStartIndex:ez,segment:eD}=e_,eL=ez+e_.numGlyphs,ek=eP+e_.lineLength,eR=el.getoffsetX(ez),eO=el.getoffsetX(eL-1),eB=Ie(en*eR,eu,ec,ed,ef,em,eD,eP,ek,ew,eT,eM,eE,eS,!0,eA,eI,eC);if(!eB)return null;let eF=Ie(en*eO,eu,ec,ed,ef,em,eD,eP,ek,ew,eT,eM,eE,eS,!0,eA,eI,eC);return eF?{first:eB,last:eF}:null}function we(el,eu,ec,ed){return el===en.W.horizontal&&Math.abs(ed)>Math.abs(ec)?{useVertical:!0}:el===en.W.vertical?ed>0?{needsFlipping:!0}:null:eu!==ew.unknown&&(0===ec||Math.abs(ed/ec)>eT)?eu===ew.flipRequired?{needsFlipping:!0}:null:ec<0?{needsFlipping:!0}:null}function Te(el,eu,ec,ed,ef,em,e_,eT,eM,eE,eS,eA,eI,eC,eP,ez,eD,eL,ek){let eR=eu/24,eO=el.lineOffsetX*eR,eB=el.lineOffsetY*eR,{lineStartIndex:eF,glyphStartIndex:eN,numGlyphs:eU,segment:eV,writingMode:ej,flipState:eG}=el,eq=eF+el.lineLength,P=el=>{if(eS){let[eu,ec,ed]=el.up,ef=eE.length;en.u(eS,ef+0,eu,ec,ed),en.u(eS,ef+1,eu,ec,ed),en.u(eS,ef+2,eu,ec,ed),en.u(eS,ef+3,eu,ec,ed)}let[eu,ec,ed]=el.point;en.k(eE,eu,ec,ed,el.angle)};if(eU>1){let en=be(eR,eT,eO,eB,ec,eA,eI,el,eM,em,eC,ez,!1,eD,eL,ek);if(!en)return{notEnoughRoom:!0};if(ed&&!ec){let[eu,ec,ed]=en.first.point,[ef,em,eT]=en.last.point;[eu,ec]=ge(eu,ec,ed,e_),[ef,em]=ge(ef,em,eT,e_);let eM=we(ej,eG,(ef-eu)*eP,em-ec);if(el.flipState=eM&&eM.needsFlipping?ew.flipRequired:ew.flipNotRequired,eM)return eM}P(en.first);for(let en=eN+1;en<eN+eU-1;en++){let el=Ie(eR*eT.getoffsetX(en),eO,eB,ec,eA,eI,eV,eF,eq,eM,em,eC,ez,!1,!1,eD,eL,ek);if(!el)return eE.length-=4*(en-eN),{notEnoughRoom:!0};P(el)}P(en.last)}else{if(ed&&!ec){let eu=ge(eI.x,eI.y,0,ef),ec=eF+eV+1,ed=new en.P(eM.getx(ec),eM.gety(ec)),em=ge(ed.x,ed.y,0,ef),e_=em[3]>0?em:Ce(eI,ed,eu,1,ef,void 0,eD,eL.canonical),eT=we(ej,eG,(e_[0]-eu[0])*eP,e_[1]-eu[1]);if(el.flipState=eT&&eT.needsFlipping?ew.flipRequired:ew.flipNotRequired,eT)return eT}let eu=Ie(eR*eT.getoffsetX(eN),eO,eB,ec,eA,eI,eV,eF,eq,eM,em,eC,ez,!1,!1,eD,eL,ek);if(!eu)return{notEnoughRoom:!0};P(eu)}return{}}function Ee(en,el,eu,ec,ed){let{x:ef,y:em,z:e_}=ec.projectTilePoint(en.x,en.y,el);if(!ed)return ge(ef,em,e_,eu);let[ew,eT,eM]=ed(en);return ge(ef+ew,em+eT,e_+eM,eu)}function Ce(el,eu,ec,ed,ef,em,e_,ew){let eT=Ee(el.sub(eu)._unit()._add(el),ew,ef,e_,em);return en.v.sub(eT,ec,eT),en.v.normalize(eT,eT),en.v.scaleAndAdd(eT,ec,eT,ed)}function Ie(el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC,eP,ez,eD){let eL=ed?el-eu:el+eu,ek=eL>0?1:-1,eR=0;ed&&(ek*=-1,eR=Math.PI),ek<0&&(eR+=Math.PI);let eO=ew+e_+(ek>0?0:1)|0,eB=ef,eF=ef,eN=0,eU=0,eV=Math.abs(eL),ej=[],eG=[],eq=em,eZ=eq,A=()=>Ce(eZ,eq,eF,eV-eN+1,eE,eA,eP,ez.canonical);for(;eN+eU<=eV;){if((eO+=ek)<ew||eO>=eT)return null;if(eF=eB,eZ=eq,ej.push(eF),eI&&eG.push(eZ),eq=new en.P(eM.getx(eO),eM.gety(eO)),!(eB=eS[eO])){let en=Ee(eq,ez.canonical,eE,eP,eA);eB=en[3]>0?eS[eO]=en:A()}eN+=eU,eU=en.v.distance(eF,eB)}eC&&eA&&(eS[eO]&&(eB=A(),eU=en.v.distance(eF,eB)),eS[eO]=eB);let e$=(eV-eN)/eU,eW=eq.sub(eZ)._mult(e$)._add(eZ),eH=en.v.sub([],eB,eF),eX=en.v.scaleAndAdd([],eF,eH,e$),eK=[0,0,1],eJ=eH[0],eY=eH[1];if(eD&&(0!==(eK=eP.upVector(ez.canonical,eW.x,eW.y))[0]||0!==eK[1]||1!==eK[2])){let el=[eK[2],0,-eK[0]],eu=en.v.cross([],eK,el);en.v.normalize(el,el),en.v.normalize(eu,eu),eJ=en.v.dot(eH,el),eY=en.v.dot(eH,eu)}if(ec){let el=en.v.cross([],eK,eH);en.v.normalize(el,el),en.v.scaleAndAdd(eX,eX,el,ec*ek)}let eQ=eR+Math.atan2(eY,eJ);return ej.push(eX),eI&&eG.push(eW),{point:eX,angle:eQ,path:ej,tilePath:eG,up:eK}}function Se(en,el){let eu=el.length,ec=eu+4*en;el.resize(ec),el.float32.fill(-1/0,4*eu,4*ec)}function Me(en,el,eu){let ec=el[0],ed=el[1];return en[0]=eu[0]*ec+eu[4]*ed+eu[12],en[1]=eu[1]*ec+eu[5]*ed+eu[13],en[3]=eu[3]*ec+eu[7]*ed+eu[15],en}let Le=(en,el,eu)=>(1-eu)*en+eu*el,Pe=en=>en*en*en*en*en;let De=class De{constructor(el,eu,ec,ed,ef,em,e_){this.tileSize=512,this._renderWorldCopies=void 0===ef||ef,this._minZoom=el||0,this._maxZoom=eu||22,this._minPitch=null==ec?0:ec,this._maxPitch=null==ed?60:ed,this.setProjection(em),this.setMaxBounds(e_),this.width=0,this.height=0,this._center=new en.L(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new ne,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new _e,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1}clone(){let en=new De(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return en._elevation=this._elevation,en._centerAltitude=this._centerAltitude,en._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,en.tileSize=this.tileSize,en.mercatorFromTransition=this.mercatorFromTransition,en.width=this.width,en.height=this.height,en.cameraElevationReference=this.cameraElevationReference,en._center=this._center,en._setZoom(this.zoom),en._seaLevelZoom=this._seaLevelZoom,en.angle=this.angle,en._fov=this._fov,en._pitch=this._pitch,en._nearZ=this._nearZ,en._farZ=this._farZ,en._averageElevation=this._averageElevation,en._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,en._unmodified=this._unmodified,en._edgeInsets=this._edgeInsets.clone(),en._camera=this._camera.clone(),en._calcMatrices(),en.freezeTileCoverage=this.freezeTileCoverage,en.frustumCorners=this.frustumCorners,en}get isOrthographic(){return"globe"!==this.projection.name&&this._orthographicProjectionAtLowPitch&&this.pitch<15}get elevation(){return this._elevation}set elevation(en){this._elevation!==en&&(this._elevation=en,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return"globe"!==this.projection.name&&!this.isOrthographic}updateElevation(en,el=!1){let eu=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(null==this._seaLevelZoom||eu)&&this._updateCameraOnTerrain(),(en||eu)&&this._constrainCamera(el),this._calcMatrices()}getProjection(){return en.p(this.projection,["name","center","parallels"])}setProjection(el){this.projectionOptions=el||{name:"mercator"};let eu=this.projection?this.getProjection():void 0;this.projection=en.o(this.projectionOptions);let ec=!t(eu,this.getProjection());return ec&&this._calcMatrices(),this.mercatorFromTransition=!1,ec}setOrthographicProjectionAtLowPitch(en){return this._orthographicProjectionAtLowPitch!==en&&(this._orthographicProjectionAtLowPitch=en,this._calcMatrices(),!0)}setMercatorFromTransition(){let el=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=en.o({name:"mercator"});let eu=el!==this.projection.name;return eu&&this._calcMatrices(),eu}get minZoom(){return this._minZoom}set minZoom(en){this._minZoom!==en&&(this._minZoom=en,this.zoom=Math.max(this.zoom,en))}get maxZoom(){return this._maxZoom}set maxZoom(en){this._maxZoom!==en&&(this._maxZoom=en,this.zoom=Math.min(this.zoom,en))}get minPitch(){return this._minPitch}set minPitch(en){this._minPitch!==en&&(this._minPitch=en,this.pitch=Math.max(this.pitch,en))}get maxPitch(){return this._maxPitch}set maxPitch(en){this._maxPitch!==en&&(this._maxPitch=en,this.pitch=Math.min(this.pitch,en))}get renderWorldCopies(){return this._renderWorldCopies&&!0===this.projection.supportsWorldCopies}set renderWorldCopies(en){void 0===en?en=!0:null===en&&(en=!1),this._renderWorldCopies=en}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){let en=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(en))}get cameraWorldSize(){let en=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(en))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return en.b(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new en.P(this.width,this.height)}get bearing(){return en.w(this.rotation,-180,180)}set bearing(en){this.rotation=en}get rotation(){return-this.angle/Math.PI*180}set rotation(el){let eu=-el*Math.PI/180;this.angle!==eu&&(this._unmodified=!1,this.angle=eu,this._calcMatrices(),this.rotationMatrix=en.h.create(),en.h.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(el){let eu=en.c(el,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==eu&&(this._unmodified=!1,this._pitch=eu,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}get fovX(){return this._fov}get fovY(){let en=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/en)}set fov(el){el=Math.max(.01,Math.min(60,el)),this._fov!==el&&(this._unmodified=!1,this._fov=en.d(el),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(en){this._averageElevation=en,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(en){let el=Math.min(Math.max(en,this.minZoom),this.maxZoom);this._zoom!==el&&(this._unmodified=!1,this._setZoom(el),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(en){this._zoom=en,this.scale=this.zoomScale(en),this.tileZoom=Math.floor(en),this.zoomFraction=en-this.tileZoom}_updateCameraOnTerrain(){let en=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,el=this.elevation&&en===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||en===Number.NEGATIVE_INFINITY&&(!el||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);let eu=this._elevation;el||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&eu.exaggeration()&&this._centerAltitudeValidForExaggeration!==eu.exaggeration()?this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*eu.exaggeration():this._centerAltitude=en||0,this._centerAltitudeValidForExaggeration=eu.exaggeration(),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){void 0!==this._centerAltitudeValidForExaggeration&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;let el=this._elevation,eu=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],ec=this.horizonLineFromTop(),ed=0,ef=0;for(let em=0;em<eu.length;em++){let e_=new en.P(eu[em][0]*this.width,ec+eu[em][1]*(this.height-ec)),ew=el.pointCoordinate(e_);if(!ew)continue;let eT=1/Math.hypot(ew[0]-this._camera.position[0],ew[1]-this._camera.position[1]);ed+=ew[3]*eT,ef+=eT}return 0===ef?NaN:ed/ef}get center(){return this._center}set center(en){en.lat===this._center.lat&&en.lng===this._center.lng||(this._unmodified=!1,this._center=en,this._terrainEnabled()&&("ground"===this.cameraElevationReference?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(null==this._seaLevelZoom||!this._elevation)return;let en=this._seaLevelZoom,el=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),eu=this.pixelsPerMeter/this.worldSize*el,ec=this._mercatorZfromZoom(en),ed=this._mercatorZfromZoom(this._maxZoom),ef=Math.max(ec-eu,ed);this._setZoom(this._zoomFromMercatorZ(ef))}get padding(){return this._edgeInsets.toJSON()}set padding(en){this._edgeInsets.equals(en)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,en,1),this._calcMatrices())}computeZoomRelativeTo(el){let eu;let ec=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,el.toAltitude()));eu=el.z<this._camera.position[2]?[ec.x,ec.y,ec.z]:[el.x,el.y,el.z];let ed=en.v.length(en.v.sub([],this._camera.position,eu));return en.c(this._zoomFromMercatorZ(ed),this._minZoom,this._maxZoom)}setFreeCameraOptions(el){if(!this.height||!el.position&&!el.orientation)return;this._updateCameraState();let eu=!1;if(el.orientation&&!en.q.exactEquals(el.orientation,this._camera.orientation)&&(eu=this._setCameraOrientation(el.orientation)),el.position){let ec=[el.position.x,el.position.y,el.position.z];en.v.exactEquals(ec,this._camera.position)||(this._setCameraPosition(ec),eu=!0)}eu&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();let el=this._camera.position,eu=new he;return eu.position=new en.M(el[0],el[1],el[2]),eu.orientation=this._camera.orientation,eu._elevation=this.elevation,eu._renderWorldCopies=this.renderWorldCopies,eu}_setCameraOrientation(el){if(!en.q.length(el))return!1;en.q.normalize(el,el);let eu=en.v.transformQuat([],[0,0,-1],el),ec=en.v.transformQuat([],[0,-1,0],el);if(ec[2]<0)return!1;let ed=ce(eu,ec);return!!ed&&(this._camera.orientation=ed,!0)}_setCameraPosition(el){let eu=this.zoomScale(this.minZoom)*this.tileSize,ec=this.zoomScale(this.maxZoom)*this.tileSize,ed=this.cameraToCenterDistance;el[2]=en.c(el[2],ed/ec,ed/eu),this._camera.position=el}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(en){return this._edgeInsets.equals(en)}interpolatePadding(en,el,eu){this._unmodified=!1,this._edgeInsets.interpolate(en,el,eu),this._constrain(),this._calcMatrices()}coveringZoomLevel(en){let el=(en.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/en.tileSize));return Math.max(0,el)}getVisibleUnwrappedCoordinates(el){let eu=[new en.U(0,el)];if(this.renderWorldCopies){let ec=this.pointCoordinate(new en.P(0,0)),ed=this.pointCoordinate(new en.P(this.width,0)),ef=this.pointCoordinate(new en.P(this.width,this.height)),em=this.pointCoordinate(new en.P(0,this.height)),e_=Math.floor(Math.min(ec.x,ed.x,ef.x,em.x)),ew=Math.floor(Math.max(ec.x,ed.x,ef.x,em.x));for(let ec=e_-1;ec<=ew+1;ec++)0!==ec&&eu.push(new en.U(ec,el))}return eu}isLODDisabled(en){return(!en||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCoverForShadows(el,eu,ec){let ed=[];if(0===eu[0]&&0===eu[1])return ed;for(let ec of el){let el=ec.canonical,ef=ec.overscaledZ,em=ec.wrap,e_=1<<el.z,ew=el.x+1<e_,eT=el.x>0,eM=el.y+1<e_,eE=el.y>0,eS=ec.wrap-(eT?0:1),eA=ec.wrap+(ew?0:1),eI=eT?el.x-1:e_-1,eC=ew?el.x+1:0;eu[0]<0?(ed.push(new en.O(ef,eA,el.z,eC,el.y)),eu[1]<0&&eM&&(ed.push(new en.O(ef,em,el.z,el.x,el.y+1)),ed.push(new en.O(ef,eA,el.z,eC,el.y+1))),eu[1]>0&&eE&&(ed.push(new en.O(ef,em,el.z,el.x,el.y-1)),ed.push(new en.O(ef,eA,el.z,eC,el.y-1)))):eu[0]>0?(ed.push(new en.O(ef,eS,el.z,eI,el.y)),eu[1]<0&&eM&&(ed.push(new en.O(ef,em,el.z,el.x,el.y+1)),ed.push(new en.O(ef,eS,el.z,eI,el.y+1))),eu[1]>0&&eE&&(ed.push(new en.O(ef,em,el.z,el.x,el.y-1)),ed.push(new en.O(ef,eS,el.z,eI,el.y-1)))):eu[1]<0&&eM?ed.push(new en.O(ef,em,el.z,el.x,el.y+1)):eE&&ed.push(new en.O(ef,em,el.z,el.x,el.y-1))}if(ed.length>1){ed.sort((en,el)=>en.overscaledZ-el.overscaledZ||en.wrap-el.wrap||en.canonical.z-el.canonical.z||en.canonical.x-el.canonical.x||en.canonical.y-el.canonical.y);let en=0,el=0;for(;el<ed.length;)ed[el].equals(ed[en])?++el:ed[++en]=ed[el++];ed.length=en+1}let ef=[];for(let en of ed)ed.some(el=>en.isChildOf(el))||ef.push(en);return ef.filter(en=>!el.some(el=>!!(en.overscaledZ<ec&&el.isChildOf(en))||en.equals(el)||en.isChildOf(el)))}coveringTiles(el){let eu,ec=this.coveringZoomLevel(el),ed=ec,ef=this.elevation&&this.elevation.exaggeration(),em=ef&&!el.isTerrainDEM,e_="mercator"===this.projection.name;if(void 0!==el.minzoom&&ec<el.minzoom)return[];void 0!==el.maxzoom&&ec>el.maxzoom&&(ec=el.maxzoom);let ew=this.locationCoordinate(this.center),eT=this.center.lat,eM=1<<ec,eE=[eM*ew.x,eM*ew.y,0],eS="globe"===this.projection.name,eA=!eS,eI=en.F.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,ec,eA),eC=eS?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),eP=eM*en.b(1,this.center.lat),ez=this._camera.position[2]/en.b(1,this.center.lat),eD=[eM*eC.x,eM*eC.y,ez*(eA?1:eP)],eL=eS||ef,ek=this.cameraToCenterDistance/el.tileSize*(el.roundZoom?1:.502),eR=this.isLODDisabled(!0)?ec:0;if(this._elevation&&el.isTerrainDEM)eu=1e4*this._elevation.exaggeration();else if(this._elevation){let en=this._elevation.getMinMaxForVisibleTiles();eu=en?en.max:this._centerAltitude}else eu=this._centerAltitude;let eO=el.isTerrainDEM?-eu:this._elevation?this._elevation.getMinElevationBelowMSL():0,eB=this.projection.isReprojectedInTileSpace?en.r(this):1,E=el=>{let eu=1/4e4,ec=new en.M(el.x+eu,el.y,el.z),ed=new en.M(el.x,el.y+eu,el.z),ef=el.toLngLat(),em=ec.toLngLat(),e_=ed.toLngLat(),ew=this.locationCoordinate(ef),eT=this.locationCoordinate(em),eM=this.locationCoordinate(e_),eE=Math.hypot(eT.x-ew.x,eT.y-ew.y),eS=Math.hypot(eM.x-ew.x,eM.y-ew.y);return Math.sqrt(eE*eS)*eB/eu},C=el=>{let ec=eu;return{aabb:en.y(this,eM,0,0,0,el,eO,ec,this.projection),zoom:0,x:0,y:0,minZ:eO,maxZ:ec,wrap:el,fullyVisible:!1}},eF=[],eN=[],eU=ec,eV=el.reparseOverscaled?ed:ec,P=en=>en*en,ej=P((ez-this._centerAltitude)*eP),A=en=>{if(!this._elevation||!en.tileID||!e_)return;let el=this._elevation.getMinMaxForTile(en.tileID),eu=en.aabb;el?(eu.min[2]=el.min,eu.max[2]=el.max,eu.center[2]=(eu.min[2]+eu.max[2])/2):(en.shouldSplit=R(en),en.shouldSplit||(eu.min[2]=eu.max[2]=eu.center[2]=this._centerAltitude))},R=el=>{if(el.zoom<eR)return!0;if(el.zoom===eU)return!1;if(null!=el.shouldSplit)return el.shouldSplit;let eu=el.aabb.distanceX(eD),ec=el.aabb.distanceY(eD),ef=ej,e_=1;if(eS){ef=P(el.aabb.distanceZ(eD));let eu=Math.pow(2,el.zoom),ec=en.l((el.y+1)/eu),ed=en.l(el.y/eu),em=Math.min(Math.max(eT,ec),ed),ew=en.a0(em)/en.a0(eT);if(e_=em===eT?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,ew/this._mercatorScaleRatio),this.zoom<=en.Z&&el.zoom===eU-1&&ew>=.9)return!0}else if(em&&(ef=P(el.aabb.distanceZ(eD)*eP)),this.projection.isReprojectedInTileSpace&&ed<=5){let eu=Math.pow(2,el.zoom),ec=E(new en.M((el.x+.5)/eu,(el.y+.5)/eu));e_=ec>.85?1:ec}let ew=eu*eu+ec*ec+ef,eM=P((1<<eU-el.zoom)*ek*e_*((en,el)=>{if(el*P(.707)<en)return 1;let eu=Math.sqrt(el/en);return eu/(1.4144271570014144+(Math.pow(1.1,eu-1.4144271570014144+1)-1)/(1.1-1)-1)})(Math.max(ef,ej),ew));return ew<eM};if(this.renderWorldCopies)for(let en=1;en<=3;en++)eF.push(C(-en)),eF.push(C(en));for(eF.push(C(0));eF.length>0;){let eu=eF.pop(),ed=eu.x,ef=eu.y,ew=eu.fullyVisible,d=()=>"globe"===this.projection.name&&(0===eu.y||eu.y===(1<<eu.zoom)-1);if(!ew){let el=eL?eu.aabb.intersects(eI):eu.aabb.intersectsFlat(eI);if(0===el&&d()){let ec=new en.t(eu.zoom,ed,ef);el=en.x(this,eM,ec,!0).intersects(eI)}if(0===el)continue;ew=2===el}if(eu.zoom!==eU&&R(eu))for(let el=0;el<4;el++){let ec=(ed<<1)+el%2,eT=(ef<<1)+(el>>1),eE={aabb:e_?eu.aabb.quadrant(el):en.y(this,eM,eu.zoom+1,ec,eT,eu.wrap,eu.minZ,eu.maxZ,this.projection),zoom:eu.zoom+1,x:ec,y:eT,wrap:eu.wrap,fullyVisible:ew,tileID:void 0,shouldSplit:void 0,minZ:eu.minZ,maxZ:eu.maxZ};em&&!eS&&(eE.tileID=new en.O(eu.zoom+1===eU?eV:eu.zoom+1,eu.wrap,eu.zoom+1,ec,eT),A(eE)),eF.push(eE)}else{let em=eu.zoom===eU?eV:eu.zoom;if(el.minzoom&&el.minzoom>em)continue;if(!ew){let el=eL?eu.aabb.intersectsPrecise(eI):eu.aabb.intersectsPreciseFlat(eI);if(0===el&&d()){let ec=new en.t(eu.zoom,ed,ef);el=en.x(this,eM,ec,!0).intersectsPrecise(eI)}if(0===el)continue}let e_=eE[0]-(.5+ed+(eu.wrap<<eu.zoom))*(1<<ec-eu.zoom),eT=eE[1]-.5-ef,eS=eu.tileID?eu.tileID:new en.O(em,eu.wrap,eu.zoom,ed,ef);eN.push({tileID:eS,distanceSq:e_*e_+eT*eT})}}if(this.fogCullDistSq){let ec=this.fogCullDistSq,ed=this.horizonLineFromTop();eN=eN.filter(ef=>{let em=[0,0,0,1],e_=[en.J,en.J,0,1],ew=this.calculateFogTileMatrix(ef.tileID.toUnwrapped());en.e.transformMat4(em,em,ew),en.e.transformMat4(e_,e_,ew);let eT=en.e.min([],em,e_),eM=en.e.max([],em,e_),eE=en.z(eT,eM);if(0===eE)return!0;let eS=!1,eA=this._elevation;if(eA&&eE>ec&&0!==ed){let ec;let em=this.calculateProjMatrix(ef.tileID.toUnwrapped());el.isTerrainDEM||(ec=eA.getMinMaxForTile(ef.tileID)),ec||(ec={min:eO,max:eu});let e_=en._(this.rotation),ew=[e_[0]*en.J,e_[1]*en.J,ec.max];en.v.transformMat4(ew,ew,em),eS=(1-ew[1])*this.height*.5<ed}return eE<ec||eS})}return eN.sort((en,el)=>en.distanceSq-el.distanceSq).map(en=>en.tileID)}resize(en,el){this.width=en,this.height=el,this.pixelsToGLUnits=[2/en,-2/el],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(en){return Math.pow(2,en)}scaleZoom(en){return Math.log(en)/Math.LN2}project(el){let eu=en.c(el.lat,-en.A,en.A),ec=this.projection.project(el.lng,eu);return new en.P(ec.x*this.worldSize,ec.y*this.worldSize)}unproject(en){return this.projection.unproject(en.x/this.worldSize,en.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/en.b(1,this.center.lat)/this.worldSize}setLocationAtPoint(el,eu){let ec,ed;let ef=this.centerPoint;if("globe"===this.projection.name){let en=this.worldSize;ec=(eu.x-ef.x)/en,ed=(eu.y-ef.y)/en}else{let en=this.pointCoordinate(eu),el=this.pointCoordinate(ef);ec=en.x-el.x,ed=en.y-el.y}let em=this.locationCoordinate(el);this.setLocation(new en.M(em.x-ec,em.y-ed))}setLocation(en){this.center=this.coordinateLocation(en),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(en){return this.projection.locationPoint(this,en)}locationPoint3D(en){return this.projection.locationPoint(this,en,!0)}pointLocation(en){return this.coordinateLocation(this.pointCoordinate(en))}pointLocation3D(en){return this.coordinateLocation(this.pointCoordinate3D(en))}locationCoordinate(el,eu){let ec=eu?en.b(eu,el.lat):void 0,ed=this.projection.project(el.lng,el.lat);return new en.M(ed.x,ed.y,ec)}coordinateLocation(en){return this.projection.unproject(en.x,en.y)}pointRayIntersection(el,eu){let ec=null!=eu?eu:this._centerAltitude,ed=[el.x,el.y,0,1],ef=[el.x,el.y,1,1];en.e.transformMat4(ed,ed,this.pixelMatrixInverse),en.e.transformMat4(ef,ef,this.pixelMatrixInverse);let em=ef[3];en.e.scale(ed,ed,1/ed[3]),en.e.scale(ef,ef,1/em);let e_=ed[2],ew=ef[2];return{p0:ed,p1:ef,t:e_===ew?0:(ec-e_)/(ew-e_)}}screenPointToMercatorRay(el){let eu=[el.x,el.y,0,1],ec=[el.x,el.y,1,1];return en.e.transformMat4(eu,eu,this.pixelMatrixInverse),en.e.transformMat4(ec,ec,this.pixelMatrixInverse),en.e.scale(eu,eu,1/eu[3]),en.e.scale(ec,ec,1/ec[3]),eu[2]=en.b(eu[2],this._center.lat)*this.worldSize,ec[2]=en.b(ec[2],this._center.lat)*this.worldSize,en.e.scale(eu,eu,1/this.worldSize),en.e.scale(ec,ec,1/this.worldSize),new en.R([eu[0],eu[1],eu[2]],en.v.normalize([],en.v.sub([],ec,eu)))}rayIntersectionCoordinate(el){let{p0:eu,p1:ec,t:ed}=el,ef=en.b(eu[2],this._center.lat),em=en.b(ec[2],this._center.lat);return new en.M(en.n(eu[0],ec[0],ed)/this.worldSize,en.n(eu[1],ec[1],ed)/this.worldSize,en.n(ef,em,ed))}pointCoordinate(en,el=this._centerAltitude){return this.projection.pointCoordinate(this,en.x,en.y,el)}pointCoordinate3D(el){if(!this.elevation)return this.pointCoordinate(el);let eu=this.projection.pointCoordinate3D(this,el.x,el.y);if(eu)return new en.M(eu[0],eu[1],eu[2]);let ec=0,ed=this.horizonLineFromTop();if(el.y>ed)return this.pointCoordinate(el);let ef=.02*ed,em=el.clone();for(let el=0;el<10&&ed-ec>ef;el++){em.y=en.n(ec,ed,.66);let el=this.projection.pointCoordinate3D(this,em.x,em.y);el?(ed=em.y,eu=el):ec=em.y}return eu?new en.M(eu[0],eu[1],eu[2]):this.pointCoordinate(el)}isPointAboveHorizon(en){return this.projection.isPointAboveHorizon(this,en)}isPointOnSurface(el){if(el.y<0||el.y>this.height||el.x<0||el.x>this.width)return!1;if(this.elevation||this.zoom>=en.G)return!this.isPointAboveHorizon(el);let eu=this.pointCoordinate(el);return eu.y>=0&&eu.y<=1}_coordinatePoint(el,eu){let ec=eu&&this.elevation?this.elevation.getAtPointOrZero(el,this._centerAltitude):this._centerAltitude,ed=[el.x*this.worldSize,el.y*this.worldSize,ec+el.toAltitude(),1];return en.e.transformMat4(ed,ed,this.pixelMatrix),ed[3]>0?new en.P(ed[0]/ed[3],ed[1]/ed[3]):new en.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){let{top:el,left:eu}=this._edgeInsets,ec=this.height-this._edgeInsets.bottom,ed=this.width-this._edgeInsets.right,ef=this.pointLocation3D(new en.P(eu,el)),em=this.pointLocation3D(new en.P(ed,el)),e_=this.pointLocation3D(new en.P(ed,ec)),ew=this.pointLocation3D(new en.P(eu,ec)),eT=Math.min(ef.lng,em.lng,e_.lng,ew.lng),eM=Math.max(ef.lng,em.lng,e_.lng,ew.lng),eE=Math.min(ef.lat,em.lat,e_.lat,ew.lat),eS=Math.max(ef.lat,em.lat,e_.lat,ew.lat),eA=Math.pow(2,-this.zoom)/16*270,eI="globe"===this.projection.name?1:4,m=(el,eu,ec,ed,ef)=>{let em=(el+ec)/2,e_=(eu+ed)/2,ew=new en.P(em,e_),{lng:eC,lat:eP}=this.pointLocation3D(ew),ez=Math.max(0,eT-eC,eE-eP,eC-eM,eP-eS);eT=Math.min(eT,eC),eM=Math.max(eM,eC),eE=Math.min(eE,eP),eS=Math.max(eS,eP),(ef<eI||ez>eA)&&(m(el,eu,em,e_,ef+1),m(em,e_,ec,ed,ef+1))};if(m(eu,el,ed,el,1),m(ed,el,ed,ec,1),m(ed,ec,eu,ec,1),m(eu,ec,eu,el,1),"globe"===this.projection.name){let[el,eu]=en.B(this);el?(eS=90,eM=180,eT=-180):eu&&(eE=-90,eM=180,eT=-180)}return new en.D(new en.L(eT,eE),new en.L(eM,eS))}_getBoundsRectangular(el,eu){let{top:ec,left:ed}=this._edgeInsets,ef=this.height-this._edgeInsets.bottom,em=this.width-this._edgeInsets.right,e_=new en.P(ed,ec),ew=new en.P(em,ec),eT=new en.P(em,ef),eM=new en.P(ed,ef),eE=this.pointCoordinate(e_,el),eS=this.pointCoordinate(ew,el),eA=this.pointCoordinate(eT,eu),eI=this.pointCoordinate(eM,eu),m=(en,el)=>(el.y-en.y)/(el.x-en.x);return eE.y>1&&eS.y>=0?eE=new en.M((1-eI.y)/m(eI,eE)+eI.x,1):eE.y<0&&eS.y<=1&&(eE=new en.M(-eI.y/m(eI,eE)+eI.x,0)),eS.y>1&&eE.y>=0?eS=new en.M((1-eA.y)/m(eA,eS)+eA.x,1):eS.y<0&&eE.y<=1&&(eS=new en.M(-eA.y/m(eA,eS)+eA.x,0)),(new en.D).extend(this.coordinateLocation(eE)).extend(this.coordinateLocation(eS)).extend(this.coordinateLocation(eI)).extend(this.coordinateLocation(eA))}_getBoundsRectangularTerrain(){let en=this.elevation;if(!en.visibleDemTiles.length||en.isUsingMockSource())return this._getBoundsRectangular(0,0);let el=en.visibleDemTiles.reduce((en,el)=>{if(el.dem){let eu=el.dem.tree;en.min=Math.min(en.min,eu.minimums[0]),en.max=Math.max(en.max,eu.maximums[0])}return en},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(el.min*en.exaggeration(),el.max*en.exaggeration())}getBounds(){return"mercator"===this.projection.name||"equirectangular"===this.projection.name?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(en=!0){let el=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,eu=this.height/2-el*(1-this._horizonShift);return en?Math.max(0,eu):eu}getMaxBounds(){return this.maxBounds}setMaxBounds(el){this.maxBounds=el,this.minLat=-en.A,this.maxLat=en.A,this.minLng=-180,this.maxLng=180,el&&(this.minLat=el.getSouth(),this.maxLat=el.getNorth(),this.minLng=el.getWest(),this.maxLng=el.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=en.E(this.minLng)*this.tileSize,this.worldMaxX=en.E(this.maxLng)*this.tileSize,this.worldMinY=en.H(this.maxLat)*this.tileSize,this.worldMaxY=en.H(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(en,el){return this.projection.createTileMatrix(this,el,en)}calculateDistanceTileData(el){let eu=el.key,ec=this._distanceTileDataCache;if(ec[eu])return ec[eu];let ed=el.canonical,ef=1/this.height,em=this.cameraWorldSize,e_=em/this.zoomScale(ed.z),ew=(ed.x+Math.pow(2,ed.z)*el.wrap)*e_,eT=ed.y*e_,eM=this.point;eM.x*=em/this.worldSize,eM.y*=em/this.worldSize;let eE=this.angle,eS=Math.sin(-eE),eA=-Math.cos(-eE);return ec[eu]={bearing:[eS,eA],center:[(eM.x-ew)*ef,(eM.y-eT)*ef],scale:e_/en.J*ef},ec[eu]}calculateFogTileMatrix(el){let eu=el.key,ec=this._fogTileMatrixCache;if(ec[eu])return ec[eu];let ed=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,el);return en.m.multiply(ed,this.worldToFogMatrix,ed),ec[eu]=new Float32Array(ed),ec[eu]}calculateProjMatrix(el,eu=!1,ec=!1){let ed,ef;let em=el.key;if((ed=ec?this._expandedProjMatrixCache:eu?this._alignedProjMatrixCache:this._projMatrixCache)[em])return ed[em];let e_=this.calculatePosMatrix(el,this.worldSize);return ef=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:ec?this.expandedFarZProjMatrix:eu?this.alignedProjMatrix:this.projMatrix,en.m.multiply(e_,ef,e_),ed[em]=new Float32Array(e_),ed[em]}calculatePixelsToTileUnitsMatrix(el){let eu=el.tileID.key,ec=this._pixelsToTileUnitsCache;if(ec[eu])return ec[eu];let ed=en.K(el,this);return ec[eu]=ed,ec[eu]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if("globe"===this.projection.name){let el=1/this.worldSize,eu=en.m.fromScaling([],[el,el,el]);return en.m.multiply(eu,eu,this.globeMatrix),eu}}recenterOnTerrain(){if(!this._elevation||"globe"===this.projection.name)return;let el=this._elevation;this._updateCameraState();let eu=en.b(1,this._center.lat)*this.worldSize,ec=this._computeCameraPosition(eu),ed=this._camera.forward(),ef=en.b(1,this._center.lat);ec[2]/=ef,ed[2]/=ef,en.v.normalize(ed,ed);let em=el.raycast(ec,ed,el.exaggeration());if(em){let el=en.v.scaleAndAdd([],ec,ed,em),eu=new en.M(el[0],el[1],en.b(el[2],en.l(el[1]))),e_=(eu.z+en.v.length([eu.x-ec[0],eu.y-ec[1],eu.z-ec[2]*ef]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(e_),this._centerAltitude=eu.toAltitude(),this._center=this.coordinateLocation(eu),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(el=!1){if(!this._elevation)return;let eu=this._elevation,ec=en.b(1,this._center.lat)*this.worldSize,ed=this._computeCameraPosition(ec),ef=eu.getAtPointOrZero(new en.M(...ed)),em=this.pixelsPerMeter/this.worldSize*ef,e_=this._minimumHeightOverTerrain(),ew=ed[2]-em;if(ew<=e_){if(ew<0||el){let el=this.locationCoordinate(this._center,this._centerAltitude),eu=[ed[0],ed[1],el.z-ed[2]],ec=en.v.length(eu);eu[2]-=(e_-ew)/this._pixelsPerMercatorPixel;let ef=en.v.length(eu);if(0===ef)return;en.v.scale(eu,eu,ec/ef*this._pixelsPerMercatorPixel),this._camera.position=[ed[0],ed[1],el.z*this._pixelsPerMercatorPixel-eu[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;let el="globe"===this.projection.name||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||el){let eu=this.center;return eu.lat=en.c(eu.lat,this.minLat,this.maxLat),!this.maxBounds&&(this.renderWorldCopies||el)||(eu.lng=en.c(eu.lng,this.minLng,this.maxLng)),this.center=eu,void(this._constraining=!1)}let eu=this._unmodified,{x:ec,y:ed}=this.point,ef=0,em=ec,e_=ed,ew=this.width/2,eT=this.height/2,eM=this.worldMinY*this.scale,eE=this.worldMaxY*this.scale;if(ed-eT<eM&&(e_=eM+eT),ed+eT>eE&&(e_=eE-eT),eE-eM<this.height&&(ef=Math.max(ef,this.height/(eE-eM)),e_=(eE+eM)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){let en=this.worldMinX*this.scale,el=this.worldMaxX*this.scale,eu=this.worldSize/2-(en+el)/2;(em=(ec+eu+this.worldSize)%this.worldSize-eu)-ew<en&&(em=en+ew),em+ew>el&&(em=el-ew),el-en<this.width&&(ef=Math.max(ef,this.width/(el-en)),em=(el+en)/2)}em===ec&&e_===ed||(this.center=this.unproject(new en.P(em,e_))),ef&&(this.zoom+=this.scaleZoom(ef)),this._constrainCamera(),this._unmodified=eu,this._constraining=!1}_minZoomForBounds(){let en=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(en=Math.max(en,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),en}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){let el;if(!this.height)return;let eu=this.centerOffset,ec="globe"===this.projection.name,ed=this.pixelsPerMeter;"globe"===this.projection.name&&(this._mercatorScaleRatio=en.b(1,this.center.lat)/en.b(1,en.$));let ef=en.N(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,ef),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;let em="meters"===this.projection.zAxisUnit?ed:1,e_=this._camera.getWorldToCamera(this.worldSize,em),ew=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(ew[8]=-(2*eu.x)/this.width,ew[9]=2*eu.y/this.height,this.isOrthographic){let en=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),ec=en*this.aspect,ed=-ec,ef=-en;ec-=eu.x,ed-=eu.x,en+=eu.y,ef+=eu.y,((en,el,eu,ec)=>{for(let ed=0;ed<16;ed++)en[ed]=Le(el[ed],eu[ed],ec)})(el=this._camera.getCameraToClipOrthographic(ed,ec,ef,en,this._nearZ,this._farZ),el,ew,Pe(this.pitch>=15?1:this.pitch/15))}else el=ew;let eT=en.m.mul([],ew,e_),eM=en.m.mul([],el,e_);if(this.projection.isReprojectedInTileSpace){let el=this.locationCoordinate(this.center),eu=en.m.identity([]);en.m.translate(eu,eu,[el.x*this.worldSize,el.y*this.worldSize,0]),en.m.multiply(eu,eu,en.Q(this)),en.m.translate(eu,eu,[-el.x*this.worldSize,-el.y*this.worldSize,0]),en.m.multiply(eM,eM,eu),en.m.multiply(eT,eT,eu),this.inverseAdjustmentMatrix=en.S(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=en.m.scale([],eM,[this.worldSize,this.worldSize,this.worldSize/em,1]),this.projMatrix=eM,this.invProjMatrix=en.m.invert(new Float64Array(16),this.projMatrix),ec){let el=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);el[8]=-(2*eu.x)/this.width,el[9]=2*eu.y/this.height,this.expandedFarZProjMatrix=en.m.mul([],el,e_)}else this.expandedFarZProjMatrix=this.projMatrix;let eE=en.m.invert([],el);this.frustumCorners=en.T.fromInvProjectionMatrix(eE,this.horizonLineFromTop(),this.height),this.cameraFrustum=en.F.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!ec);let eS=new Float32Array(16);en.m.identity(eS),en.m.scale(eS,eS,[1,-1,1]),en.m.rotateX(eS,eS,this._pitch),en.m.rotateZ(eS,eS,this.angle);let eA=en.m.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=en.m.clone(eA);let eI=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;eA[8]=-(2*eu.x)/this.width,eA[9]=2*(eu.y+eI)/this.height,this.skyboxMatrix=en.m.multiply(eS,eA,eS);let eC=this.point,eP=eC.x,ez=eC.y,eD=this.width%2/2,eL=this.height%2/2,ek=Math.cos(this.angle),eR=Math.sin(this.angle),eO=eP-Math.round(eP)+ek*eD+eR*eL,eB=ez-Math.round(ez)+ek*eL+eR*eD,eF=new Float64Array(eM);if(en.m.translate(eF,eF,[eO>.5?eO-1:eO,eB>.5?eB-1:eB,0]),this.alignedProjMatrix=eF,eM=en.m.create(),en.m.scale(eM,eM,[this.width/2,-this.height/2,1]),en.m.translate(eM,eM,[1,-1,0]),this.labelPlaneMatrix=eM,eM=en.m.create(),en.m.scale(eM,eM,[1,-1,1]),en.m.translate(eM,eM,[-1,-1,0]),en.m.scale(eM,eM,[2/this.width,2/this.height,1]),this.glCoordMatrix=eM,this.pixelMatrix=en.m.multiply(new Float64Array(16),this.labelPlaneMatrix,eT),this._calcFogMatrices(),this._distanceTileDataCache={},!(eM=en.m.invert(new Float64Array(16),this.pixelMatrix)))throw Error("failed to invert matrix");if(this.pixelMatrixInverse=eM,"globe"===this.projection.name||this.mercatorFromTransition){this.globeMatrix=en.V(this);let el=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=en.v.transformMat4(el,el,e_),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=eM;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};let el=this.cameraWorldSizeForFog,eu=this.cameraPixelsPerMeter,ec=this._camera.position,ed=1/this.height/this._pixelsPerMercatorPixel,ef=[el,el,eu];en.v.scale(ef,ef,ed),en.v.scale(ec,ec,-1),en.v.multiply(ec,ec,ef);let em=en.m.create();en.m.translate(em,em,ec),en.m.scale(em,em,ef),this.mercatorFogMatrix=em,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(el,eu,ed)}_computeCameraPosition(en){let el=(en=en||this.pixelsPerMeter)/this.pixelsPerMeter,eu=this._camera.forward(),ec=this.point,ed=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*el-en/this.worldSize*this._centerAltitude;return[ec.x/this.worldSize-eu[0]*ed,ec.y/this.worldSize-eu[1]*ed,en/this.worldSize*this._centerAltitude-eu[2]*ed]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(el){let eu=this._maxCameraBoundsDistance()*Math.cos(this._pitch),ec=this._camera.position[2],ed=el[2],ef=1;this.projection.wrap&&(this.center=this.center.wrap()),ed>0&&(ef=Math.min((eu-ec)/ed,1)),this._camera.position=en.v.scaleAndAdd([],this._camera.position,el,ef),this._updateStateFromCamera()}_updateStateFromCamera(){let el=this._camera.position,eu=this._camera.forward(),{pitch:ec,bearing:ed}=this._camera.getPitchBearing(),ef=en.b(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,em=this._mercatorZfromZoom(this._maxZoom)*Math.cos(en.d(this._maxPitch)),e_=Math.max((el[2]-ef)/Math.cos(ec),em),ew=this._zoomFromMercatorZ(e_);en.v.scaleAndAdd(el,el,eu,e_),this._pitch=en.c(ec,en.d(this.minPitch),en.d(this.maxPitch)),this.angle=en.w(ed,-Math.PI,Math.PI),this._setZoom(en.c(ew,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new en.M(el[0],el[1],el[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(en){return Math.pow(2,en)*this.tileSize}_mercatorZfromZoom(en){return this.cameraToCenterDistance/this._worldSizeFromZoom(en)}_minimumHeightOverTerrain(){let en=Math.min((null!=this._seaLevelZoom?this._seaLevelZoom:this._zoom)+4,this._maxZoom);return this._mercatorZfromZoom(en)}_zoomFromMercatorZ(en){return this.scaleZoom(this.cameraToCenterDistance/(en*this.tileSize))}zoomFromMercatorZAdjusted(el){let eu=0,ec=en.G,ed=0,ef=1/0;for(;ec-eu>1e-6&&ec>eu;){let en=eu+.5*(ec-eu),em=this.tileSize*Math.pow(2,en),e_=this.getCameraToCenterDistance(this.projection,en,em),ew=this.scaleZoom(e_/(el*this.tileSize)),eT=Math.abs(en-ew);eT<ef&&(ef=eT,ed=en),en<ew?eu=en:ec=en}return ed}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(en.X("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(el,eu){let ec=Math.min(el.x,eu.x),ed=Math.max(el.x,eu.x),ef=Math.min(el.y,eu.y),em=Math.max(el.y,eu.y);if(ef<this.horizonLineFromTop(!1))return!0;if("mercator"!==this.projection.name)return!1;let e_=[new en.P(ec,ef),new en.P(ed,em),new en.P(ec,em),new en.P(ed,ef)],ew=this.renderWorldCopies?-3:0,eT=this.renderWorldCopies?4:1;for(let en of e_){let el=this.pointRayIntersection(en);if(el.t<0)return!0;let eu=this.rayIntersectionCoordinate(el);if(eu.x<ew||eu.y<0||eu.x>eT||eu.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+en.Y(this.fovAboveCenter)>88||this.anyCornerOffEdge(new en.P(0,0),new en.P(this.width,this.height))}zoomDeltaToMovement(el,eu){let ec=en.v.length(en.v.sub([],this._camera.position,el)),ed=this._zoomFromMercatorZ(ec)+eu;return ec-this._mercatorZfromZoom(ed)}getCameraPoint(){if("globe"===this.projection.name){let el=function([el,eu,ec],ed){let ef=[el,eu,ec,1];en.e.transformMat4(ef,ef,ed);let em=ef[3]=Math.max(ef[3],1e-6);return ef[0]/=em,ef[1]/=em,ef[2]/=em,ef}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new en.P(el[0],el[1])}{let el=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new en.P(0,el))}}getCameraToCenterDistance(el,eu=this.zoom,ec=this.worldSize){let ed=en.N(el,eu,this.width,this.height,1024),ef=el.pixelSpaceConversion(this.center.lat,ec,ed),em=.5/Math.tan(.5*this._fov)*this.height*ef;return this.isOrthographic&&(em=Le(1,em,Pe(this.pitch>=15?1:this.pitch/15))),em}getWorldToCameraMatrix(){let el=this._camera.getWorldToCamera(this.worldSize,"meters"===this.projection.zAxisUnit?this.pixelsPerMeter:1);return"globe"===this.projection.name&&en.m.multiply(el,el,this.globeMatrix),el}getFrustum(el){return en.F.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,el,"meters"===this.projection.zAxisUnit)}};let Re=class Re extends en.a6{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded={},this.requestors=[],this.patterns={},this.atlasImage={},this.atlasTexture={},this.dirty=!0}createScope(el){this.images[el]={},this.loaded[el]=!1,this.updatedImages[el]={},this.patterns[el]={},this.callbackDispatchedThisFrame[el]={},this.atlasImage[el]=new en.a5({width:1,height:1})}isLoaded(){for(let en in this.loaded)if(!this.loaded[en])return!1;return!0}setLoaded(en,el){if(this.loaded[el]!==en&&(this.loaded[el]=en,en)){for(let{ids:en,callback:eu}of this.requestors)this._notify(en,el,eu);this.requestors=[]}}hasImage(en,el){return!!this.getImage(en,el)}getImage(en,el){return this.images[el][en]}addImage(en,el,eu){this._validate(en,eu)&&(this.images[el][en]=eu)}_validate(el,eu){let ec=!0;return this._validateStretch(eu.stretchX,eu.data&&eu.data.width)||(this.fire(new en.a7(Error(`Image "${el}" has invalid "stretchX" value`))),ec=!1),this._validateStretch(eu.stretchY,eu.data&&eu.data.height)||(this.fire(new en.a7(Error(`Image "${el}" has invalid "stretchY" value`))),ec=!1),this._validateContent(eu.content,eu)||(this.fire(new en.a7(Error(`Image "${el}" has invalid "content" value`))),ec=!1),ec}_validateStretch(en,el){if(!en)return!0;let eu=0;for(let ec of en){if(ec[0]<eu||ec[1]<ec[0]||el<ec[1])return!1;eu=ec[1]}return!0}_validateContent(en,el){return!(en&&(4!==en.length||en[0]<0||el.data.width<en[0]||en[1]<0||el.data.height<en[1]||en[2]<0||el.data.width<en[2]||en[3]<0||el.data.height<en[3]||en[2]<en[0]||en[3]<en[1]))}updateImage(en,el,eu){eu.version=this.images[el][en].version+1,this.images[el][en]=eu,this.updatedImages[el][en]=!0}removeImage(en,el){let eu=this.images[el][en];delete this.images[el][en],delete this.patterns[el][en],eu.userImage&&eu.userImage.onRemove&&eu.userImage.onRemove()}listImages(en){return Object.keys(this.images[en])}getImages(en,el,eu){let ec=!0,ed=!!this.loaded[el];if(!ed)for(let eu of en)this.images[el][eu]||(ec=!1);ed||ec?this._notify(en,el,eu):this.requestors.push({ids:en,scope:el,callback:eu})}getUpdatedImages(en){return this.updatedImages[en]}_notify(el,eu,ec){let ed={};for(let ec of el){this.images[eu][ec]||this.fire(new en.a8("styleimagemissing",{id:ec}));let el=this.images[eu][ec];el?ed[ec]={data:el.data.clone(),pixelRatio:el.pixelRatio,sdf:el.sdf,version:el.version,stretchX:el.stretchX,stretchY:el.stretchY,content:el.content,hasRenderCallback:!!(el.userImage&&el.userImage.render)}:en.X(`Image "${ec}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}ec(null,ed)}getPixelSize(en){let{width:el,height:eu}=this.atlasImage[en];return{width:el,height:eu}}getPattern(el,eu){let ec=this.patterns[eu][el],ed=this.getImage(el,eu);if(!ed)return null;if(ec&&ec.position.version===ed.version)return ec.position;if(ec)ec.position.version=ed.version;else{let ec={w:ed.data.width+2,h:ed.data.height+2,x:0,y:0},ef=new en.ab(ec,ed);this.patterns[eu][el]={bin:ec,position:ef}}return this._updatePatternAtlas(eu),this.patterns[eu][el].position}bind(el,eu){let ec=el.gl,ed=this.atlasTexture[eu];ed?this.dirty&&(ed.update(this.atlasImage[eu]),this.dirty=!1):(ed=new en.a9(el,this.atlasImage[eu],ec.RGBA),this.atlasTexture[eu]=ed),ed.bind(ec.LINEAR,ec.CLAMP_TO_EDGE)}_updatePatternAtlas(el){let eu=[];for(let en in this.patterns[el])eu.push(this.patterns[el][en].bin);let{w:ec,h:ed}=en.aa(eu),ef=this.atlasImage[el];for(let eu in ef.resize({width:ec||1,height:ed||1}),this.patterns[el]){let{bin:ec}=this.patterns[el][eu],ed=ec.x+1,em=ec.y+1,e_=this.images[el][eu].data,ew=e_.width,eT=e_.height;en.a5.copy(e_,ef,{x:0,y:0},{x:ed,y:em},{width:ew,height:eT}),en.a5.copy(e_,ef,{x:0,y:eT-1},{x:ed,y:em-1},{width:ew,height:1}),en.a5.copy(e_,ef,{x:0,y:0},{x:ed,y:em+eT},{width:ew,height:1}),en.a5.copy(e_,ef,{x:ew-1,y:0},{x:ed-1,y:em},{width:1,height:eT}),en.a5.copy(e_,ef,{x:0,y:0},{x:ed+ew,y:em},{width:1,height:eT})}this.dirty=!0}beginFrame(){for(let en in this.images)this.callbackDispatchedThisFrame[en]={}}dispatchRenderCallbacks(en,el){for(let eu of en){if(this.callbackDispatchedThisFrame[el][eu])continue;this.callbackDispatchedThisFrame[el][eu]=!0;let en=this.images[el][eu];(function(en){let{userImage:el}=en;return!!(el&&el.render&&el.render())&&(en.data.replace(new Uint8Array(el.data.buffer)),!0)})(en)&&this.updateImage(eu,el,en)}}};let eM=new en.ac({anchor:new en.ad(en.ae.light.anchor),position:new en.af(en.ae.light.position),color:new en.ad(en.ae.light.color),intensity:new en.ad(en.ae.light.intensity)});let Oe=class Oe extends en.a6{constructor(el,eu="flat"){super(),this._transitionable=new en.ag(eM),this.setLight(el,eu),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(el,eu,ec={}){this._validate(en.ah,el,ec)||(this._transitionable.setTransitionOrValue(el),this.id=eu)}updateTransitions(en){this._transitioning=this._transitionable.transitioned(en,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(en){this.properties=this._transitioning.possiblyEvaluate(en)}_validate(el,eu,ec){return(!ec||!1!==ec.validate)&&en.ai(this,el.call(en.aj,en.ak({value:eu,style:{glyphs:!0,sprite:!0},styleSpec:en.ae})))}};let eE=new en.ac({source:new en.ad(en.ae.terrain.source),exaggeration:new en.ad(en.ae.terrain.exaggeration)}),eS=class extends en.a6{constructor(el,eu,ec,ed){super(),this.scope=ec,this._transitionable=new en.ag(eE,ec,ed),this._transitionable.setTransitionOrValue(el,ed),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=eu}get(){return this._transitionable.serialize()}set(en,el){this._transitionable.setTransitionOrValue(en,el)}updateTransitions(en){this._transitioning=this._transitionable.transitioned(en,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(en){this.properties=this._transitioning.possiblyEvaluate(en)}getExaggeration(el){return this._transitioning.possiblyEvaluate(new en.al(el)).get("exaggeration")}isZoomDependent(){let el=this._transitionable._values.exaggeration;return null!=el&&null!=el.value&&null!=el.value.expression&&el.value.expression instanceof en.am}};function Ge(el,eu,ec,ed){let ef=en.an(45,65,ec),[em,e_]=je(el,ed),ew=1-Math.min(1,Math.exp(-((eu-em)/(e_-em)*6)));return ew*=ew*ew,(ew=Math.min(1,1.00747*ew))*ef*el.alpha}function je(en,el){let eu=.5/Math.tan(.5*el);return[en.range[0]+eu,en.range[1]+eu]}function Ve(el,eu,ec,ed,ef){let em=en.v.transformMat4([],[eu,ec,ed],ef.mercatorFogMatrix);return Ge(el,en.v.length(em),ef.pitch,ef._fov)}function Ze(el,eu,ec,ed,ef,em,e_){let ew=Number.MAX_VALUE,eT=-Number.MAX_VALUE;for(let el of[[ec,ed,0],[ef,ed,0],[ef,em,0],[ec,em,0]]){let ec=en.v.transformMat4([],el,eu),ed=en.v.length(ec);ew=Math.min(ew,ed),eT=Math.max(eT,ed)}return[Ge(el,ew,e_.pitch,e_._fov),Ge(el,eT,e_.pitch,e_._fov)]}let eA=new en.ac({range:new en.ad(en.ae.fog.range),color:new en.ad(en.ae.fog.color),"high-color":new en.ad(en.ae.fog["high-color"]),"space-color":new en.ad(en.ae.fog["space-color"]),"horizon-blend":new en.ad(en.ae.fog["horizon-blend"]),"star-intensity":new en.ad(en.ae.fog["star-intensity"]),"vertical-range":new en.ad(en.ae.fog["vertical-range"])});let He=class He extends en.a6{constructor(el,eu){super(),this._transitionable=new en.ag(eA),this.set(el),this._transitioning=this._transitionable.untransitioned(),this._transform=eu}get state(){let el=this._transform,eu="globe"===el.projection.name,ec=en.ao(el.zoom),ed=this.properties.get("range");return{range:eu?[en.n(.5,ed[0],ec),en.n(3,ed[1],ec)]:ed,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(el,eu={}){if(this._validate(en.ap,el,eu))return;let ec=en.ak({},el);for(let el of Object.keys(en.ae.fog))void 0===ec[el]&&(ec[el]=en.ae.fog[el].default);this._transitionable.setTransitionOrValue(ec)}getOpacity(el){if(!this._transform.projection.supportsFog)return 0;let eu=this.properties&&this.properties.get("color")||1;return("globe"===this._transform.projection.name?1:en.an(45,65,el))*eu.a}getOpacityAtLatLng(el,eu){return this._transform.projection.supportsFog?function(el,eu,ec){let ed=en.M.fromLngLat(eu),ef=ec.elevation?ec.elevation.getAtPointOrZero(ed):0;return Ve(el,ed.x,ed.y,ef,ec)}(this.state,el,eu):0}getOpacityForTile(el){if(!this._transform.projection.supportsFog)return[1,1];let eu=this._transform.calculateFogTileMatrix(el.toUnwrapped());return Ze(this.state,eu,0,0,en.J,en.J,this._transform)}getOpacityForBounds(en,el,eu,ec,ed){return this._transform.projection.supportsFog?Ze(this.state,en,el,eu,ec,ed,this._transform):[1,1]}getFovAdjustedRange(en){return this._transform.projection.supportsFog?je(this.state,en):[0,1]}isVisibleOnFrustum(el){if(!this._transform.projection.supportsFog)return!1;for(let eu of[4,5,6,7]){let ec;let ed=el.points[eu];if(ed[2]>=0)ec=ed;else{let ef=el.points[eu-4];ec=en.aq(ef,ed,ef[2]/(ef[2]-ed[2]))}if(Ve(this.state,ec[0],ec[1],0,this._transform)>=.05)return!0}return!1}updateTransitions(en){this._transitioning=this._transitionable.transitioned(en,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(en){this.properties=this._transitioning.possiblyEvaluate(en)}_validate(el,eu,ec){return(!ec||!1!==ec.validate)&&en.ai(this,el.call(en.aj,en.ak({value:eu,style:{glyphs:!0,sprite:!0},styleSpec:en.ae})))}};let qe=class qe extends en.a6{constructor(el,eu,ec,ed){super(),this.scope=ec,this._options=el,this.properties=new en.ar(eu),this._transitionable=new en.ag(eu,ec,new Map(ed)),this._transitionable.setTransitionOrValue(el.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(en){this._transitionable.setTransitionOrValue(this._options.properties,new Map(en))}updateTransitions(en){this._transitioning=this._transitionable.transitioned(en,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(en){this.properties=this._transitioning.possiblyEvaluate(en)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(en,el){this._options=en,this._transitionable.setTransitionOrValue(en.properties,el)}shadowsEnabled(){return!!this.properties&&!0===this.properties.get("cast-shadows")}};let eI=new en.ac({color:new en.ad(en.ae.properties_light_ambient.color),intensity:new en.ad(en.ae.properties_light_ambient.intensity)}),eC=new en.ac({direction:new en.as(en.ae.properties_light_directional.direction),color:new en.ad(en.ae.properties_light_directional.color),intensity:new en.ad(en.ae.properties_light_directional.intensity),"cast-shadows":new en.ad(en.ae.properties_light_directional["cast-shadows"]),"shadow-intensity":new en.ad(en.ae.properties_light_directional["shadow-intensity"])});let Je=class Je{constructor(en,el,eu,ec){this.screenBounds=en,this.cameraPoint=el,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=eu,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,ec)}static createFromScreenPoints(el,eu){let ec,ed;if(el instanceof en.P||"number"==typeof el[0]){let ef=en.P.convert(el);ec=[ef],ed=eu.isPointAboveHorizon(ef)}else{let ef=en.P.convert(el[0]),em=en.P.convert(el[1]);ec=[ef,em],ed=en.at(ef,em).every(en=>eu.isPointAboveHorizon(en))}return new Je(ec,eu.getCameraPoint(),ed,eu)}isPointQuery(){return 1===this.screenBounds.length}bufferedScreenGeometry(el){return en.at(this.screenBounds[0],1===this.screenBounds.length?this.screenBounds[0]:this.screenBounds[1],el)}bufferedCameraGeometry(el){let eu=this.screenBounds[0],ec=1===this.screenBounds.length?this.screenBounds[0].add(new en.P(1,1)):this.screenBounds[1],ed=en.at(eu,ec,0,!1);return this.cameraPoint.y>ec.y&&(this.cameraPoint.x>eu.x&&this.cameraPoint.x<ec.x?ed.splice(3,0,this.cameraPoint):this.cameraPoint.x>=ec.x?ed[2]=this.cameraPoint:this.cameraPoint.x<=eu.x&&(ed[3]=this.cameraPoint)),en.au(ed,el)}bufferedCameraGeometryGlobe(el){let eu=this.screenBounds[0],ec=1===this.screenBounds.length?this.screenBounds[0].add(new en.P(1,1)):this.screenBounds[1],ed=en.at(eu,ec,el),ef=this.cameraPoint.clone();switch(3*((ef.y>eu.y)+(ef.y>ec.y))+((ef.x>eu.x)+(ef.x>ec.x))){case 0:ed[0]=ef,ed[4]=ef.clone();break;case 1:ed.splice(1,0,ef);break;case 2:ed[1]=ef;break;case 3:ed.splice(4,0,ef);break;case 5:ed.splice(2,0,ef);break;case 6:ed[3]=ef;break;case 7:ed.splice(3,0,ef);break;case 8:ed[2]=ef}return ed}containsTile(el,eu,ec,ed=0){var ef;let em=el.queryPadding/eu._pixelsPerMercatorPixel+1,e_=ec?this._bufferedCameraMercator(em,eu):this._bufferedScreenMercator(em,eu),ew=el.tileID.wrap+(e_.unwrapped?ed:0),eT=e_.polygon.map(eu=>en.av(el.tileTransform,eu,ew));if(!en.aw(eT,0,0,en.J,en.J))return;ew=el.tileID.wrap+(this.screenGeometryMercator.unwrapped?ed:0);let eM=this.screenGeometryMercator.polygon.map(eu=>en.ax(el.tileTransform,eu,ew)),eE=eM.map(el=>new en.P(el[0],el[1])),eS=eu.getFreeCameraOptions().position||new en.M(0,0,0),eA=en.ax(el.tileTransform,eS,ew),eI=eM.map(el=>{let eu=en.v.sub(el,el,eA);return en.v.normalize(eu,eu),new en.R(eA,eu)}),eC=en.ay(el,1,eu.zoom)*eu._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:eE,tilespaceRays:eI,bufferedTilespaceGeometry:eT,bufferedTilespaceBounds:((ef=en.az(eT)).min.x=en.c(ef.min.x,0,en.J),ef.min.y=en.c(ef.min.y,0,en.J),ef.max.x=en.c(ef.max.x,0,en.J),ef.max.y=en.c(ef.max.y,0,en.J),ef),tile:el,tileID:el.tileID,pixelToTileUnitsFactor:eC}}_bufferedScreenMercator(en,el){let eu=100*en|0;if(this._screenRaycastCache[eu])return this._screenRaycastCache[eu];{let ec;return ec="globe"===el.projection.name?this._projectAndResample(this.bufferedScreenGeometry(en),el):{polygon:this.bufferedScreenGeometry(en).map(en=>el.pointCoordinate3D(en)),unwrapped:!0},this._screenRaycastCache[eu]=ec,ec}}_bufferedCameraMercator(en,el){let eu=100*en|0;if(this._cameraRaycastCache[eu])return this._cameraRaycastCache[eu];{let ec;return ec="globe"===el.projection.name?this._projectAndResample(this.bufferedCameraGeometryGlobe(en),el):{polygon:this.bufferedCameraGeometry(en).map(en=>el.pointCoordinate3D(en)),unwrapped:!0},this._cameraRaycastCache[eu]=ec,ec}}_projectAndResample(el,eu){let ec=function(el,eu){let ec=en.m.multiply([],eu.pixelMatrix,eu.globeMatrix),ed=[0,-en.aC,0,1],ef=[0,en.aC,0,1],em=[0,0,0,1];en.e.transformMat4(ed,ed,ec),en.e.transformMat4(ef,ef,ec),en.e.transformMat4(em,em,ec);let e_=new en.P(ed[0]/ed[3],ed[1]/ed[3]),ew=new en.P(ef[0]/ef[3],ef[1]/ef[3]),eT=en.aA(el,e_)&&ed[3]<em[3],eM=en.aA(el,ew)&&ef[3]<em[3];if(!eT&&!eM)return null;let eE=function(en,el,eu){for(let ec=1;ec<en.length;ec++){let ed=Ke(el.pointCoordinate3D(en[ec-1]).x),ef=Ke(el.pointCoordinate3D(en[ec]).x);if(eu<0){if(ed<ef)return{idx:ec,t:-ed/(ef-1-ed)}}else if(ef<ed)return{idx:ec,t:(1-ed)/(ef+1-ed)}}return null}(el,eu,eT?-1:1);if(!eE)return null;let{idx:eS,t:eA}=eE,eI=eS>1?Ye(el.slice(0,eS),eu):[],eC=eS<el.length?Ye(el.slice(eS),eu):[];eI=eI.map(el=>new en.P(Ke(el.x),el.y)),eC=eC.map(el=>new en.P(Ke(el.x),el.y));let eP=[...eI];0===eP.length&&eP.push(eC[eC.length-1]);let ez=en.n(eP[eP.length-1].y,(0===eC.length?eI[0]:eC[0]).y,eA);return eP.push(...eT?[new en.P(0,ez),new en.P(0,0),new en.P(1,0),new en.P(1,ez)]:[new en.P(1,ez),new en.P(1,1),new en.P(0,1),new en.P(0,ez)]),0===eC.length?eP.push(eI[0]):eP.push(...eC),{polygon:eP.map(el=>new en.M(el.x,el.y)),unwrapped:!1}}(el,eu);if(ec)return ec;let ed=function(el,eu){let ec=!1,ed=-1/0,ef=0;for(let en=0;en<el.length-1;en++)el[en].x>ed&&(ed=el[en].x,ef=en);for(let en=0;en<el.length-1;en++){let eu=(ef+en)%(el.length-1),ed=el[eu],em=el[eu+1];Math.abs(ed.x-em.x)>.5&&(ed.x<em.x?(ed.x+=1,0===eu&&(el[el.length-1].x+=1)):(em.x+=1,eu+1===el.length-1&&(el[0].x+=1)),ec=!0)}let em=en.E(eu.center.lng);return ec&&em<Math.abs(em-1)&&el.forEach(en=>{en.x-=1}),{polygon:el,unwrapped:ec}}(Ye(el,eu).map(el=>new en.P(Ke(el.x),el.y)),eu);return{polygon:ed.polygon.map(el=>new en.M(el.x,el.y)),unwrapped:ed.unwrapped}}};function Ye(el,eu){return en.aB(el,en=>{let el=eu.pointCoordinate3D(en);en.x=el.x,en.y=el.y},1/256)}function Ke(en){return en<0?1+en%1:en%1}function et(el,eu,ec,ed,ef){let n=function(ec,ed){if(ec)return ef(ec);if(ed){el.url&&ed.tiles&&el.tiles&&delete el.tiles;let ec=en.p(en.ak(ed,el),["tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);ed.vector_layers&&(ec.vectorLayers=ed.vector_layers,ec.vectorLayerIds=ec.vectorLayers.map(en=>en.id)),ec.tiles=eu.canonicalizeTileset(ec,el.url),ef(null,ec)}};return el.url?en.a1(eu.transformRequest(eu.normalizeSourceURL(el.url,null,ec,ed),en.a2.Source),n):en.a4.frame(()=>n(null,el))}let tt=class tt{constructor(el,eu,ec){this.bounds=en.D.convert(this.validateBounds(el)),this.minzoom=eu||0,this.maxzoom=ec||24}validateBounds(en){return Array.isArray(en)&&4===en.length?[Math.max(-180,en[0]),Math.max(-90,en[1]),Math.min(180,en[2]),Math.min(90,en[3])]:[-180,-90,180,90]}contains(el){let eu=Math.pow(2,el.z),ec=Math.floor(en.E(this.bounds.getWest())*eu),ed=Math.floor(en.H(this.bounds.getNorth())*eu),ef=Math.ceil(en.E(this.bounds.getEast())*eu),em=Math.ceil(en.H(this.bounds.getSouth())*eu);return el.x>=ec&&el.x<ef&&el.y>=ed&&el.y<em}};let it=class it extends en.a6{constructor(el,eu,ec,ed){if(super(),this.id=el,this.dispatcher=ec,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,en.ak(this,en.p(eu,["url","scheme","tileSize","promoteId"])),this._options=en.ak({type:"vector"},eu),this._collectResourceTiming=!!eu.collectResourceTiming,512!==this.tileSize)throw Error("vector tile sources must have a tileSize of 512");this.setEventedParent(ed),this._tileWorkers={},this._deduped=new en.aD}load(el){this._loaded=!1,this.fire(new en.a8("dataloading",{dataType:"source"}));let eu=Array.isArray(this.map._language)?this.map._language.join():this.map._language,ec=this.map._worldview;this._tileJSONRequest=et(this._options,this.map._requestManager,eu,ec,(ed,ef)=>{this._tileJSONRequest=null,this._loaded=!0,ed?(eu&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${eu}`),ec&&2!==ec.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${ec}`),this.fire(new en.a7(ed))):ef&&(en.ak(this,ef),ef.bounds&&(this.tileBounds=new tt(ef.bounds,this.minzoom,this.maxzoom)),en.aH(ef.tiles,this.map._requestManager._customAccessToken),this.fire(new en.a8("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new en.a8("data",{dataType:"source",sourceDataType:"content"}))),el&&el(ed)})}loaded(){return this._loaded}hasTile(en){return!this.tileBounds||this.tileBounds.contains(en.canonical)}onAdd(en){this.map=en,this.load()}reload(){this.cancelTileJSONRequest();let el=en.aE(this.id,this.scope);this.load(()=>this.map.style.clearSource(el))}setTiles(en){return this._options.tiles=en,this.reload(),this}setUrl(en){return this.url=en,this._options.url=en,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return en.ak({},this._options)}loadTile(el,eu){let ec=this.map._requestManager.normalizeTileURL(el.tileID.canonical.url(this.tiles,this.scheme)),ed={request:this.map._requestManager.transformRequest(ec,en.a2.Tile),data:void 0,uid:el.uid,tileID:el.tileID,tileZoom:el.tileZoom,zoom:el.tileID.overscaledZ,tileSize:this.tileSize*el.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:en.a4.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:el.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:el.isExtraShadowCaster};if(ed.request.collectResourceTiming=this._collectResourceTiming,el.actor&&"expired"!==el.state)"loading"===el.state?el.reloadCallback=eu:el.request=el.actor.send("reloadTile",ed,s.bind(this));else if(el.actor=this._tileWorkers[ec]=this._tileWorkers[ec]||this.dispatcher.getActor(),this.dispatcher.ready)el.request=el.actor.send("loadTile",ed,s.bind(this),void 0,!0);else{let eu=en.aF.call({deduped:this._deduped},ed,(en,eu)=>{en||!eu?s.call(this,en):(ed.data={cacheControl:eu.cacheControl,expires:eu.expires,rawData:eu.rawData.slice(0)},el.actor&&el.actor.send("loadTile",ed,s.bind(this),void 0,!0))},!0);el.request={cancel:eu}}function s(ec,ed){return delete el.request,el.aborted?eu(null):ec&&404!==ec.status?eu(ec):(ed&&ed.resourceTiming&&(el.resourceTiming=ed.resourceTiming),this.map._refreshExpiredTiles&&ed&&el.setExpiryData(ed),el.loadVectorData(ed,this.map.painter),en.aG(this.dispatcher),eu(null),void(el.reloadCallback&&(this.loadTile(el,el.reloadCallback),el.reloadCallback=null)))}}abortTile(en){en.request&&(en.request.cancel(),delete en.request),en.actor&&en.actor.send("abortTile",{uid:en.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(en){en.actor&&en.actor.send("removeTile",{uid:en.uid,type:this.type,source:this.id,scope:this.scope}),en.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}};let ot=class ot extends en.a6{constructor(el,eu,ec,ed){super(),this.id=el,this.dispatcher=ec,this.setEventedParent(ed),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=en.ak({type:"raster"},eu),en.ak(this,en.p(eu,["url","scheme","tileSize"]))}load(el){this._loaded=!1,this.fire(new en.a8("dataloading",{dataType:"source"})),this._tileJSONRequest=et(this._options,this.map._requestManager,null,null,(eu,ec)=>{this._tileJSONRequest=null,this._loaded=!0,eu?this.fire(new en.a7(eu)):ec&&(en.ak(this,ec),ec.bounds&&(this.tileBounds=new tt(ec.bounds,this.minzoom,this.maxzoom)),en.aH(ec.tiles),this.fire(new en.a8("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new en.a8("data",{dataType:"source",sourceDataType:"content"}))),el&&el(eu)})}loaded(){return this._loaded}onAdd(en){this.map=en,this.load()}reload(){this.cancelTileJSONRequest();let el=en.aE(this.id,this.scope);this.load(()=>this.map.style.clearSource(el))}setTiles(en){return this._options.tiles=en,this.reload(),this}setUrl(en){return this.url=en,this._options.url=en,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return en.ak({},this._options)}hasTile(en){return!this.tileBounds||this.tileBounds.contains(en.canonical)}loadTile(el,eu){let ec=en.a4.devicePixelRatio>=2,ed=this.map._requestManager.normalizeTileURL(el.tileID.canonical.url(this.tiles,this.scheme),ec,this.tileSize);el.request=en.a3(this.map._requestManager.transformRequest(ed,en.a2.Tile),(ec,ed,ef,em)=>(delete el.request,el.aborted?(el.state="unloaded",eu(null)):ec?(el.state="errored",eu(ec)):ed?(this.map._refreshExpiredTiles&&el.setExpiryData({cacheControl:ef,expires:em}),el.setTexture(ed,this.map.painter),el.state="loaded",en.aG(this.dispatcher),void eu(null)):eu(null)))}abortTile(en,el){en.request&&(en.request.cancel(),delete en.request),el()}unloadTile(el,eu){el.texture&&el.texture instanceof en.a9?(el.destroy(!0),el.texture&&el.texture instanceof en.a9&&this.map.painter.saveTileTexture(el.texture)):el.destroy(),eu()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}};let eP={vector:it,raster:ot,"raster-dem":class extends ot{constructor(el,eu,ec,ed){super(el,eu,ec,ed),this.type="raster-dem",this.maxzoom=22,this._options=en.ak({type:"raster-dem"},eu),this.encoding=eu.encoding||"mapbox"}loadTile(el,eu){let ec=this.map._requestManager.normalizeTileURL(el.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function r(en,ec){en&&(el.state="errored",eu(en)),ec&&(el.dem=ec,el.dem.onDeserialize(),el.needsHillshadePrepare=!0,el.needsDEMTextureUpload=!0,el.state="loaded",eu(null))}el.request=en.a3(this.map._requestManager.transformRequest(ec,en.a2.Tile),(function(ec,ed,ef,em){if(delete el.request,el.aborted)el.state="unloaded",eu(null);else if(ec)el.state="errored",eu(ec);else if(ed){this.map._refreshExpiredTiles&&el.setExpiryData({cacheControl:ef,expires:em});let eu=ImageBitmap&&ed instanceof ImageBitmap&&en.aI(),ec=1-(ed.width-en.aJ(ed.width))/2;ec<1||el.neighboringTiles||(el.neighboringTiles=this._getNeighboringTiles(el.tileID));let e_=eu?ed:en.a4.getImageData(ed,ec),ew={uid:el.uid,coord:el.tileID,source:this.id,scope:this.scope,rawImageData:e_,encoding:this.encoding,padding:ec};el.actor&&"expired"!==el.state||(el.actor=this.dispatcher.getActor(),el.actor.send("loadDEMTile",ew,r.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(el){let eu=el.canonical,ec=Math.pow(2,eu.z),ed=(eu.x-1+ec)%ec,ef=0===eu.x?el.wrap-1:el.wrap,em=(eu.x+1+ec)%ec,e_=eu.x+1===ec?el.wrap+1:el.wrap,ew={};return ew[new en.O(el.overscaledZ,ef,eu.z,ed,eu.y).key]={backfilled:!1},ew[new en.O(el.overscaledZ,e_,eu.z,em,eu.y).key]={backfilled:!1},eu.y>0&&(ew[new en.O(el.overscaledZ,ef,eu.z,ed,eu.y-1).key]={backfilled:!1},ew[new en.O(el.overscaledZ,el.wrap,eu.z,eu.x,eu.y-1).key]={backfilled:!1},ew[new en.O(el.overscaledZ,e_,eu.z,em,eu.y-1).key]={backfilled:!1}),eu.y+1<ec&&(ew[new en.O(el.overscaledZ,ef,eu.z,ed,eu.y+1).key]={backfilled:!1},ew[new en.O(el.overscaledZ,el.wrap,eu.z,eu.x,eu.y+1).key]={backfilled:!1},ew[new en.O(el.overscaledZ,e_,eu.z,em,eu.y+1).key]={backfilled:!1}),ew}},geojson:class extends en.a6{constructor(el,eu,ec,ed){super(),this.id=el,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=ec.getActor(),this.setEventedParent(ed),this._data=eu.data,this._options=en.ak({},eu),this._collectResourceTiming=eu.collectResourceTiming,void 0!==eu.maxzoom&&(this.maxzoom=eu.maxzoom),eu.type&&(this.type=eu.type),eu.attribution&&(this.attribution=eu.attribution),this.promoteId=eu.promoteId;let ef=en.J/this.tileSize;this.workerOptions=en.ak({source:this.id,scope:this.scope,cluster:eu.cluster||!1,geojsonVtOptions:{buffer:(void 0!==eu.buffer?eu.buffer:128)*ef,tolerance:(void 0!==eu.tolerance?eu.tolerance:.375)*ef,extent:en.J,maxZoom:this.maxzoom,lineMetrics:eu.lineMetrics||!1,generateId:eu.generateId||!1},superclusterOptions:{maxZoom:void 0!==eu.clusterMaxZoom?eu.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,eu.clusterMinPoints||2),extent:en.J,radius:(void 0!==eu.clusterRadius?eu.clusterRadius:50)*ef,log:!1,generateId:eu.generateId||!1},clusterProperties:eu.clusterProperties,filter:eu.filter},eu.workerOptions)}onAdd(en){this.map=en,this.setData(this._data)}setData(en){return this._data=en,this._updateWorkerData(),this}getClusterExpansionZoom(en,el){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:en,source:this.id,scope:this.scope},el),this}getClusterChildren(en,el){return this.actor.send("geojson.getClusterChildren",{clusterId:en,source:this.id,scope:this.scope},el),this}getClusterLeaves(en,el,eu,ec){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:en,limit:el,offset:eu},ec),this}_updateWorkerData(){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new en.a8("dataloading",{dataType:"source"})),this._loaded=!1;let el=en.ak({},this.workerOptions);el.scope=this.scope;let eu=this._data;"string"==typeof eu?(el.request=this.map._requestManager.transformRequest(en.a4.resolveURL(eu),en.a2.Source),el.request.collectResourceTiming=this._collectResourceTiming):el.data=JSON.stringify(eu),this._pendingLoad=this.actor.send(`${this.type}.loadData`,el,(el,eu)=>{if(this._loaded=!0,this._pendingLoad=null,el)this.fire(new en.a7(el));else{let el={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&eu&&eu.resourceTiming&&eu.resourceTiming[this.id]&&(el.resourceTiming=eu.resourceTiming[this.id]),this.fire(new en.a8("data",el)),this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(),this._coalesce=!1)})}loaded(){return this._loaded}loadTile(el,eu){let ec=el.actor?"reloadTile":"loadTile";el.actor=this.actor;let ed={type:this.type,uid:el.uid,tileID:el.tileID,tileZoom:el.tileZoom,zoom:el.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,scope:this.scope,pixelRatio:en.a4.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0};el.request=this.actor.send(ec,ed,(en,ed)=>(delete el.request,el.destroy(),el.aborted?eu(null):en?eu(en):(el.loadVectorData(ed,this.map.painter,"reloadTile"===ec),eu(null))),void 0,"loadTile"===ec)}abortTile(en){en.request&&(en.request.cancel(),delete en.request),en.aborted=!0}unloadTile(en){this.actor.send("removeTile",{uid:en.uid,type:this.type,source:this.id,scope:this.scope}),en.destroy()}onRemove(){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return en.ak({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends en.aK{constructor(en,el,eu,ec){super(en,el,eu,ec),this.roundZoom=!0,this.type="video",this.options=el}load(){this._loaded=!1;let el=this.options;for(let eu of(this.urls=[],el.urls))this.urls.push(this.map._requestManager.transformRequest(eu,en.a2.Source).url);en.aL(this.urls,(el,eu)=>{this._loaded=!0,el?this.fire(new en.a7(el)):eu&&(this.video=eu,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(el){if(this.video){let eu=this.video.seekable;el<eu.start(0)||el>eu.end(0)?this.fire(new en.a7(new en.aM(`sources.${this.id}`,null,`Playback for this video can be set only between the ${eu.start(0)} and ${eu.end(0)}-second mark.`))):this.video.currentTime=el}}getVideo(){return this.video}onAdd(en){this.map||(this.map=en,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;let el=this.map.painter.context,eu=el.gl;this.texture?this.video.paused||(this.texture.bind(eu.LINEAR,eu.CLAMP_TO_EDGE),eu.texSubImage2D(eu.TEXTURE_2D,0,0,0,eu.RGBA,eu.UNSIGNED_BYTE,this.video)):(this.texture=new en.a9(el,this.video,eu.RGBA),this.texture.bind(eu.LINEAR,eu.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(el)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:en.aK,model:class extends en.a6{constructor(en,el,eu,ec){super(),this.id=en,this.type="model",this.models=[],this._loaded=!1,this._options=el}load(){let el=[];for(let eu in this._options.models){let ec=this._options.models[eu],ed=en.aO(this.map._requestManager.transformRequest(ec.uri,en.a2.Model).url).then(el=>{if(!el)return;let ed=en.aP(el),ef=new en.aQ(eu,ec.position,ec.orientation,ed);ef.computeBoundsAndApplyParent(),this.models.push(ef)}).catch(el=>{this.fire(new en.a7(Error(`Could not load model ${eu} from ${ec.uri}: ${el.message}`)))});el.push(ed)}return Promise.allSettled(el).then(()=>{this._loaded=!0,this.fire(new en.a8("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(el=>{this.fire(new en.a7(Error(`Could not load models: ${el.message}`)))})}onAdd(en){this.map=en,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(en,el){}serialize(){return{type:"model"}}},"batched-model":class extends en.a6{constructor(en,el,eu,ec){super(),this.type="batched-model",this.id=en,this.tileSize=512,this._options=el,this.tiles=this._options.tiles,this.maxzoom=el.maxzoom||19,this.minzoom=el.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=eu,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(ec)}onAdd(en){this.map=en,this.load()}load(el){this._loaded=!1,this.fire(new en.a8("dataloading",{dataType:"source"}));let eu=Array.isArray(this.map._language)?this.map._language.join():this.map._language,ec=this.map._worldview;this._tileJSONRequest=et(this._options,this.map._requestManager,eu,ec,(ed,ef)=>{this._tileJSONRequest=null,this._loaded=!0,ed?(eu&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${eu}`),ec&&2!==ec.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${ec}`),this.fire(new en.a7(ed))):ef&&(en.ak(this,ef),ef.bounds&&(this.tileBounds=new tt(ef.bounds,this.minzoom,this.maxzoom)),en.aH(ef.tiles,this.map._requestManager._customAccessToken),this.fire(new en.a8("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new en.a8("data",{dataType:"source",sourceDataType:"content"}))),el&&el(ed)})}hasTransition(){return!1}hasTile(en){return!this.tileBounds||this.tileBounds.contains(en.canonical)}loaded(){return this._loaded}loadTile(el,eu){let ec=this.map._requestManager.normalizeTileURL(el.tileID.canonical.url(this.tiles,this.scheme)),ed={request:this.map._requestManager.transformRequest(ec,en.a2.Tile),data:void 0,uid:el.uid,tileID:el.tileID,tileZoom:el.tileZoom,zoom:el.tileID.overscaledZ,tileSize:this.tileSize*el.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:el.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0};if(el.actor&&"expired"!==el.state){if("loading"===el.state)el.reloadCallback=eu;else{if(el.buckets){let en=Object.values(el.buckets);for(let el of en)el.dirty=!0;return void(el.state="loaded")}el.request=el.actor.send("reloadTile",ed,s.bind(this))}}else el.actor=this.dispatcher.getActor(),el.request=el.actor.send("loadTile",ed,s.bind(this),void 0,!0);function s(en,ec){return el.aborted?eu(null):en&&404!==en.status?eu(en):(ec&&(ec.resourceTiming&&(el.resourceTiming=ec.resourceTiming),this.map._refreshExpiredTiles&&el.setExpiryData(ec),el.buckets={...el.buckets,...ec.buckets}),el.state="loaded",void eu(null))}}serialize(){return en.ak({},this._options)}},canvas:class extends en.aK{constructor(el,eu,ec,ed){super(el,eu,ec,ed),eu.coordinates?Array.isArray(eu.coordinates)&&4===eu.coordinates.length&&!eu.coordinates.some(en=>!Array.isArray(en)||2!==en.length||en.some(en=>"number"!=typeof en))||this.fire(new en.a7(new en.aM(`sources.${el}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new en.a7(new en.aM(`sources.${el}`,null,'missing required property "coordinates"'))),eu.animate&&"boolean"!=typeof eu.animate&&this.fire(new en.a7(new en.aM(`sources.${el}`,null,'optional "animate" property must be a boolean value'))),eu.canvas?"string"==typeof eu.canvas||eu.canvas instanceof HTMLCanvasElement||this.fire(new en.a7(new en.aM(`sources.${el}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new en.a7(new en.aM(`sources.${el}`,null,'missing required property "canvas"'))),this.options=eu,this.animate=void 0===eu.animate||eu.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new en.a7(Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(en){this.map=en,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let el=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,el=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,el=!0),this._hasInvalidDimensions()||0===Object.keys(this.tiles).length)return;let eu=this.map.painter.context;this.texture?!el&&!this._playing||this.texture instanceof en.aN||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new en.a9(eu,this.canvas,eu.gl.RGBA,{premultiply:!0}),this._prepareData(eu)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(let en of[this.canvas.width,this.canvas.height])if(isNaN(en)||en<=0)return!0;return!1}},custom:class extends en.a6{constructor(el,eu,ec,ed){super(),this.id=el,this.type="custom",this._dataType="raster",this._dispatcher=ec,this._implementation=eu,this.setEventedParent(ed),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new en.a7(Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new en.a7(Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new tt(this._implementation.bounds,this.minzoom,this.maxzoom)),eu.update=this._update.bind(this),eu.clearTiles=this._clearTiles.bind(this),eu.coveringTiles=this._coveringTiles.bind(this),en.ak(this,en.p(eu,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return en.p(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new en.a8("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new en.a8("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(el){this._map=el,this._loaded=!1,this.fire(new en.a8("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(el),this.load()}onRemove(en){this._implementation.onRemove&&this._implementation.onRemove(en)}hasTile(en){if(this._implementation.hasTile){let{x:el,y:eu,z:ec}=en.canonical;return this._implementation.hasTile({x:el,y:eu,z:ec})}return!this.tileBounds||this.tileBounds.contains(en.canonical)}loadTile(en,el){let{x:eu,y:ec,z:ed}=en.tileID.canonical,ef=new AbortController;en.request=Promise.resolve(this._implementation.loadTile({x:eu,y:ec,z:ed},{signal:ef.signal})).then((function(eu){return delete en.request,en.aborted?(en.state="unloaded",el(null)):void 0===eu?(en.state="errored",el(null)):null===eu?(this.loadTileData(en,{width:this.tileSize,height:this.tileSize,data:null}),en.state="loaded",el(null)):eu instanceof ImageData||eu instanceof HTMLCanvasElement||eu instanceof ImageBitmap||eu instanceof HTMLImageElement?(this.loadTileData(en,eu),en.state="loaded",void el(null)):(en.state="errored",el(Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(eu=>{20!==eu.code&&(en.state="errored",el(eu))}),en.request.cancel=()=>ef.abort()}loadTileData(en,el){en.setTexture(el,this._map.painter)}unloadTile(el,eu){if(el.texture&&el.texture instanceof en.a9?(el.destroy(!0),el.texture&&el.texture instanceof en.a9&&this._map.painter.saveTileTexture(el.texture)):el.destroy(),this._implementation.unloadTile){let{x:en,y:eu,z:ec}=el.tileID.canonical;this._implementation.unloadTile({x:en,y:eu,z:ec})}eu()}abortTile(en,el){en.request&&en.request.cancel&&(en.request.cancel(),delete en.request),el()}hasTransition(){return!1}_coveringTiles(){return this._map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(en=>({x:en.canonical.x,y:en.canonical.y,z:en.canonical.z}))}_clearTiles(){let el=en.aE(this.id,this.scope);this._map.style.clearSource(el)}_update(){this.fire(new en.a8("data",{dataType:"source",sourceDataType:"content"}))}}},st=function(el,eu,ec,ed){let ef=new eP[eu.type](el,eu,ec,ed);if(ef.id!==el)throw Error(`Expected Source id to be ${el} instead of ${ef.id}`);return en.aR(["load","abort","unload","serialize","prepare"],ef),ef};function ct(en,el){let eu=en.tileID,ec=el.tileID;return eu.overscaledZ-ec.overscaledZ||eu.canonical.y-ec.canonical.y||eu.wrap-ec.wrap||eu.canonical.x-ec.canonical.x}let ht=class ht{constructor(en){this.style=en}processLayersChanged(){for(let en in this.layers=[],this.style._mergedLayers){let el=this.style._mergedLayers[en];if("fill-extrusion"===el.type)this.layers.push(el);else if("model"===el.type){let en=this.style.getLayerSource(el);en&&"batched-model"===en.type&&this.layers.push(el)}}}updateZOffset(en,el){this.currentBuildingBuckets=[];for(let en=0;en<this.layers.length;++en){let eu=this.layers[en],ec=this.style.getLayerSourceCache(eu),ed=1;"fill-extrusion"===eu.type&&(ed=eu.paint.get("fill-extrusion-opacity")>0?eu.paint.get("fill-extrusion-vertical-scale"):0);let ef=ec?ec.getTile(el):null;if(!ef&&ec&&el.canonical.z>ec.getSource().minzoom){let en=el.scaledTo(Math.min(ec.getSource().maxzoom,el.overscaledZ-1));for(;en.overscaledZ>=ec.getSource().minzoom&&!(ef=ec.getTile(en))&&0!==en.overscaledZ;)en=en.scaledTo(en.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:ef?ef.getBucket(eu):null,tileID:ef?ef.tileID:el,verticalScale:ed})}en.hasAnyZOffset=!1;let eu=!1;for(let ec=0;ec<en.symbolInstances.length;ec++){let ed=en.symbolInstances.get(ec),ef=ed.zOffset,em=this._getHeightAtTileOffset(el,ed.tileAnchorX,ed.tileAnchorY);ed.zOffset=-1!==em?em:ef,eu||ef===ed.zOffset||(eu=!0),en.hasAnyZOffset||0===ed.zOffset||(en.hasAnyZOffset=!0)}eu&&(en.zOffsetBuffersNeedUpload=!0,en.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(el,eu,ec,ed){let ef=eu,em=ec;if(el.canonical.z!==ed.canonical.z){let e_=ed.canonical,ew=1/(1<<el.canonical.z-e_.z);ef=(eu+el.canonical.x*en.J)*ew-e_.x*en.J|0,em=(ec+el.canonical.y*en.J)*ew-e_.y*en.J|0}return{tileX:ef,tileY:em}}_getHeightAtTileOffset(en,el,eu){let ec,ed;for(let ef=0;ef<this.layers.length;++ef){if("fill-extrusion"!==this.layers[ef].type)continue;let{bucket:em,tileID:e_,verticalScale:ew}=this.currentBuildingBuckets[ef];if(!em)continue;let{tileX:eT,tileY:eM}=this._mapCoordToOverlappingTile(en,el,eu,e_),eE=em.getHeightAtTileCoord(eT,eM);eE&&void 0!==eE.height&&(eE.hidden?ec=eE.height:ed=Math.max(eE.height*ew,ed||0))}if(void 0!==ed)return ed;for(let ed=0;ed<this.layers.length;++ed){if("model"!==this.layers[ed].type)continue;let{bucket:ef,tileID:em}=this.currentBuildingBuckets[ed];if(!ef)continue;let{tileX:e_,tileY:ew}=this._mapCoordToOverlappingTile(en,el,eu,em),eT=ef.getHeightAtTileCoord(e_,ew);if(eT&&!eT.hidden)return void 0===eT.height&&void 0!==ec?Math.min(eT.maxHeight,ec)*eT.verticalScale:(eT.height||0)*eT.verticalScale}return -1}};function dt(el){el=el.slice();let eu=Object.create(null);for(let en=0;en<el.length;en++)eu[el[en].id]=el[en];for(let ec=0;ec<el.length;ec++)"ref"in el[ec]&&(el[ec]=function(el,eu){let ec={};for(let en in el)"ref"!==en&&(ec[en]=el[en]);return en.aS.forEach(en=>{en in eu&&(ec[en]=eu[en])}),ec}(el[ec],eu[el[ec].ref]));return el}let ez={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",setImportUrl:"setImportUrl",setImportData:"setImportData",setImportConfig:"setImportConfig"};function pt(en,el,eu){eu.push({command:ez.addSource,args:[en,el[en]]})}function mt(en,el,eu){el.push({command:ez.removeSource,args:[en]}),eu[en]=!0}function vt(en,el,eu,ec,ed,ef){let em;for(em in el=el||{},en=en||{})en.hasOwnProperty(em)&&(t(en[em],el[em])||eu.push({command:ef,args:[ec,em,el[em],ed]}));for(em in el)el.hasOwnProperty(em)&&!en.hasOwnProperty(em)&&(t(en[em],el[em])||eu.push({command:ef,args:[ec,em,el[em],ed]}))}function xt(en){return en.id}function yt(en,el){return en[el.id]=el,en}let bt=class bt{constructor(en,el){this.reset(en,el)}reset(en,el){this.points=en||[],this._distances=[0];for(let en=1;en<this.points.length;en++)this._distances[en]=this._distances[en-1]+this.points[en].dist(this.points[en-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(el||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(el){if(1===this.points.length)return this.points[0];el=en.c(el,0,1);let eu=1,ec=this._distances[eu],ed=el*this.paddedLength+this.padding;for(;ec<ed&&eu<this._distances.length;)ec=this._distances[++eu];let ef=eu-1,em=this._distances[ef],e_=ec-em,ew=e_>0?(ed-em)/e_:0;return this.points[ef].mult(1-ew).add(this.points[eu].mult(ew))}};let wt=class wt{constructor(en,el,eu){let ec=this.boxCells=[],ed=this.circleCells=[];this.xCellCount=Math.ceil(en/eu),this.yCellCount=Math.ceil(el/eu);for(let en=0;en<this.xCellCount*this.yCellCount;en++)ec.push([]),ed.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=en,this.height=el,this.xScale=this.xCellCount/en,this.yScale=this.yCellCount/el,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(en,el,eu,ec,ed){this._forEachCell(el,eu,ec,ed,this._insertBoxCell,this.boxUid++),this.boxKeys.push(en),this.bboxes.push(el),this.bboxes.push(eu),this.bboxes.push(ec),this.bboxes.push(ed)}insertCircle(en,el,eu,ec){this._forEachCell(el-ec,eu-ec,el+ec,eu+ec,this._insertCircleCell,this.circleUid++),this.circleKeys.push(en),this.circles.push(el),this.circles.push(eu),this.circles.push(ec)}_insertBoxCell(en,el,eu,ec,ed,ef){this.boxCells[ed].push(ef)}_insertCircleCell(en,el,eu,ec,ed,ef){this.circleCells[ed].push(ef)}_query(en,el,eu,ec,ed,ef){if(eu<0||en>this.width||ec<0||el>this.height)return!ed&&[];let em=[];if(en<=0&&el<=0&&this.width<=eu&&this.height<=ec){if(ed)return!0;for(let en=0;en<this.boxKeys.length;en++)em.push({key:this.boxKeys[en],x1:this.bboxes[4*en],y1:this.bboxes[4*en+1],x2:this.bboxes[4*en+2],y2:this.bboxes[4*en+3]});for(let en=0;en<this.circleKeys.length;en++){let el=this.circles[3*en],eu=this.circles[3*en+1],ec=this.circles[3*en+2];em.push({key:this.circleKeys[en],x1:el-ec,y1:eu-ec,x2:el+ec,y2:eu+ec})}return ef?em.filter(ef):em}return this._forEachCell(en,el,eu,ec,this._queryCell,em,{hitTest:ed,seenUids:{box:{},circle:{}}},ef),ed?em.length>0:em}_queryCircle(en,el,eu,ec,ed){let ef=en-eu,em=en+eu,e_=el-eu,ew=el+eu;if(em<0||ef>this.width||ew<0||e_>this.height)return!ec&&[];let eT=[];return this._forEachCell(ef,e_,em,ew,this._queryCellCircle,eT,{hitTest:ec,circle:{x:en,y:el,radius:eu},seenUids:{box:{},circle:{}}},ed),ec?eT.length>0:eT}query(en,el,eu,ec,ed){return this._query(en,el,eu,ec,!1,ed)}hitTest(en,el,eu,ec,ed){return this._query(en,el,eu,ec,!0,ed)}hitTestCircle(en,el,eu,ec){return this._queryCircle(en,el,eu,!0,ec)}_queryCell(en,el,eu,ec,ed,ef,em,e_){let ew=em.seenUids,eT=this.boxCells[ed];if(null!==eT){let ed=this.bboxes;for(let eM of eT)if(!ew.box[eM]){ew.box[eM]=!0;let eT=4*eM;if(en<=ed[eT+2]&&el<=ed[eT+3]&&eu>=ed[eT+0]&&ec>=ed[eT+1]&&(!e_||e_(this.boxKeys[eM]))){if(em.hitTest)return ef.push(!0),!0;ef.push({key:this.boxKeys[eM],x1:ed[eT],y1:ed[eT+1],x2:ed[eT+2],y2:ed[eT+3]})}}}let eM=this.circleCells[ed];if(null!==eM){let ed=this.circles;for(let eT of eM)if(!ew.circle[eT]){ew.circle[eT]=!0;let eM=3*eT;if(this._circleAndRectCollide(ed[eM],ed[eM+1],ed[eM+2],en,el,eu,ec)&&(!e_||e_(this.circleKeys[eT]))){if(em.hitTest)return ef.push(!0),!0;{let en=ed[eM],el=ed[eM+1],eu=ed[eM+2];ef.push({key:this.circleKeys[eT],x1:en-eu,y1:el-eu,x2:en+eu,y2:el+eu})}}}}}_queryCellCircle(en,el,eu,ec,ed,ef,em,e_){let ew=em.circle,eT=em.seenUids,eM=this.boxCells[ed];if(null!==eM){let en=this.bboxes;for(let el of eM)if(!eT.box[el]){eT.box[el]=!0;let eu=4*el;if(this._circleAndRectCollide(ew.x,ew.y,ew.radius,en[eu+0],en[eu+1],en[eu+2],en[eu+3])&&(!e_||e_(this.boxKeys[el])))return ef.push(!0),!0}}let eE=this.circleCells[ed];if(null!==eE){let en=this.circles;for(let el of eE)if(!eT.circle[el]){eT.circle[el]=!0;let eu=3*el;if(this._circlesCollide(en[eu],en[eu+1],en[eu+2],ew.x,ew.y,ew.radius)&&(!e_||e_(this.circleKeys[el])))return ef.push(!0),!0}}}_forEachCell(en,el,eu,ec,ed,ef,em,e_){let ew=this._convertToXCellCoord(en),eT=this._convertToYCellCoord(el),eM=this._convertToXCellCoord(eu),eE=this._convertToYCellCoord(ec);for(let eS=ew;eS<=eM;eS++)for(let ew=eT;ew<=eE;ew++)if(ed.call(this,en,el,eu,ec,this.xCellCount*ew+eS,ef,em,e_))return}_convertToXCellCoord(en){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(en*this.xScale)))}_convertToYCellCoord(en){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(en*this.yScale)))}_circlesCollide(en,el,eu,ec,ed,ef){let em=ec-en,e_=ed-el,ew=eu+ef;return ew*ew>em*em+e_*e_}_circleAndRectCollide(en,el,eu,ec,ed,ef,em){let e_=(ef-ec)/2,ew=Math.abs(en-(ec+e_));if(ew>e_+eu)return!1;let eT=(em-ed)/2,eM=Math.abs(el-(ed+eT));if(eM>eT+eu)return!1;if(ew<=e_||eM<=eT)return!0;let eE=ew-e_,eS=eM-eT;return eE*eE+eS*eS<=eu*eu}};let Et=class Et{constructor(en,el,eu=new wt(en.width+200,en.height+200,25),ec=new wt(en.width+200,en.height+200,25)){this.transform=en,this.grid=eu,this.ignoredGrid=ec,this.pitchfactor=Math.cos(en._pitch)*en.cameraToCenterDistance,this.screenRightBoundary=en.width+100,this.screenBottomBoundary=en.height+100,this.gridRightBoundary=en.width+200,this.gridBottomBoundary=en.height+200,this.fogState=el}placeCollisionBox(en,el,eu,ec,ed,ef,em,e_){let ew=eu.projectedAnchorX,eT=eu.projectedAnchorY,eM=eu.projectedAnchorZ,eE=eu.elevation,eS=eu.tileID,eA=en.getProjection();if(eE&&eS){let[en,el,ec]=eA.upVector(eS.canonical,eu.tileAnchorX,eu.tileAnchorY),ed=eA.upVectorScale(eS.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;ew+=en*eE*ed,eT+=el*eE*ed,eM+=ec*eE*ed}let eI=this.projectAndGetPerspectiveRatio(em,ew,eT,eM,eu.tileID,"globe"===eA.name||!!eE||this.transform.pitch>0,eA),eC=ef*eI.perspectiveRatio,eP=(eu.x1*el+ec.x-eu.padding)*eC+eI.point.x,ez=(eu.y1*el+ec.y-eu.padding)*eC+eI.point.y,eD=(eu.x2*el+ec.x+eu.padding)*eC+eI.point.x,eL=(eu.y2*el+ec.y+eu.padding)*eC+eI.point.y,ek=eI.perspectiveRatio<=.55||eI.occluded;return!this.isInsideGrid(eP,ez,eD,eL)||!ed&&this.grid.hitTest(eP,ez,eD,eL,e_)||ek?{box:[],offscreen:!1,occluded:eI.occluded}:{box:[eP,ez,eD,eL],offscreen:this.isOffscreen(eP,ez,eD,eL),occluded:!1}}placeCollisionCircles(el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC){let eP=[],ez=this.transform.elevation,eD=el.getProjection(),eL=ez?ez.getAtTileOffsetFunc(eC,this.transform.center.lat,this.transform.worldSize,eD):null,ek=new en.P(ec.tileAnchorX,ec.tileAnchorY),{x:eR,y:eO,z:eB}=eD.projectTilePoint(ek.x,ek.y,eC.canonical);if(eL){let[en,el,eu]=eL(ek);eR+=en,eO+=el,eB+=eu}let eF="globe"===eD.name,eN=this.projectAndGetPerspectiveRatio(e_,eR,eO,eB,eC,eF||!!ez||this.transform.pitch>0,eD),{perspectiveRatio:eU}=eN,eV=(eE?em/eU:em*eU)/en.aV,ej=ge(eR,eO,eB,ew),eG=eN.signedDistanceFromCamera>0?be(eV,ef,ec.lineOffsetX*eV,ec.lineOffsetY*eV,!1,ej,ek,ec,ed,ew,{},ez&&!eE?eL:null,eE&&!!ez,eD,eC,eE):null,eq=!1,eZ=!1,e$=!0;if(eG&&!eN.occluded){let el=.5*eA*eU+eI,ec=new en.P(-100,-100),ed=new en.P(this.screenRightBoundary,this.screenBottomBoundary),ef=new bt,{first:em,last:e_}=eG,ew=em.path.length,eE=[];for(let en=ew-1;en>=1;en--)eE.push(em.path[en]);for(let en=1;en<e_.path.length;en++)eE.push(e_.path[en]);let eC=2.5*el;eT&&(eE=eE.map(([en,el,eu],ec)=>(eL&&!eF&&(eu=eL(ec<ew-1?em.tilePath[ew-1-ec]:e_.tilePath[ec-ew+2])[2]),ge(en,el,eu,eT)))).some(en=>en[3]<=0)&&(eE=[]);let ez=[];if(eE.length>0){let el=1/0,eu=-1/0,ef=1/0,em=-1/0;for(let en of eE)el=Math.min(el,en[0]),ef=Math.min(ef,en[1]),eu=Math.max(eu,en[0]),em=Math.max(em,en[1]);eu>=ec.x&&el<=ed.x&&em>=ec.y&&ef<=ed.y&&(ez=[eE.map(el=>new en.P(el[0],el[1]))],(el<ec.x||eu>ed.x||ef<ec.y||em>ed.y)&&(ez=en.aT(ez,ec.x,ec.y,ed.x,ed.y)))}for(let en of ez){ef.reset(en,.25*el);let ec=0;ec=ef.length<=.5*el?1:Math.ceil(ef.paddedLength/eC)+1;for(let en=0;en<ec;en++){let ed=en/Math.max(ec-1,1),em=ef.lerp(ed),e_=em.x+100,ew=em.y+100;eP.push(e_,ew,el,0);let eT=e_-el,eE=ew-el,eA=e_+el,eI=ew+el;if(e$=e$&&this.isOffscreen(eT,eE,eA,eI),eZ=eZ||this.isInsideGrid(eT,eE,eA,eI),!eu&&this.grid.hitTestCircle(e_,ew,el,eS)&&(eq=!0,!eM))return{circles:[],offscreen:!1,collisionDetected:eq,occluded:!1}}}}return{circles:(eM||!eq)&&eZ?eP:[],offscreen:e$,collisionDetected:eq,occluded:eN.occluded}}queryRenderedSymbols(el){if(0===el.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return{};let eu=[],ec=1/0,ed=1/0,ef=-1/0,em=-1/0;for(let e_ of el){let el=new en.P(e_.x+100,e_.y+100);ec=Math.min(ec,el.x),ed=Math.min(ed,el.y),ef=Math.max(ef,el.x),em=Math.max(em,el.y),eu.push(el)}let e_=this.grid.query(ec,ed,ef,em).concat(this.ignoredGrid.query(ec,ed,ef,em)),ew={},eT={};for(let el of e_){let ec=el.key;if(void 0===ew[ec.bucketInstanceId]&&(ew[ec.bucketInstanceId]={}),ew[ec.bucketInstanceId][ec.featureIndex])continue;let ed=[new en.P(el.x1,el.y1),new en.P(el.x2,el.y1),new en.P(el.x2,el.y2),new en.P(el.x1,el.y2)];en.aU(eu,ed)&&(ew[ec.bucketInstanceId][ec.featureIndex]=!0,void 0===eT[ec.bucketInstanceId]&&(eT[ec.bucketInstanceId]=[]),eT[ec.bucketInstanceId].push(ec.featureIndex))}return eT}insertCollisionBox(en,el,eu,ec,ed){(el?this.ignoredGrid:this.grid).insert({bucketInstanceId:eu,featureIndex:ec,collisionGroupID:ed},en[0],en[1],en[2],en[3])}insertCollisionCircles(en,el,eu,ec,ed){let ef=el?this.ignoredGrid:this.grid,em={bucketInstanceId:eu,featureIndex:ec,collisionGroupID:ed};for(let el=0;el<en.length;el+=4)ef.insertCircle(em,en[el],en[el+1],en[el+2])}projectAndGetPerspectiveRatio(el,eu,ec,ed,ef,em,e_){let ew=[eu,ec,ed,1],eT=!1;if(ed||this.transform.pitch>0){if(en.e.transformMat4(ew,ew,el),this.fogState&&ef&&"globe"!==e_.name){let el=function(el,eu,ec,ed,ef,em){let e_=em.calculateFogTileMatrix(ef),ew=[eu,ec,ed];return en.v.transformMat4(ew,ew,e_),Ge(el,en.v.length(ew),em.pitch,em._fov)}(this.fogState,eu,ec,ed,ef.toUnwrapped(),this.transform);eT=el>.9}}else Me(ew,ew,el);let eM=ew[3];return{point:new en.P((ew[0]/eM+1)/2*this.transform.width+100,(-ew[1]/eM+1)/2*this.transform.height+100),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(e_)/eM*.5,1.5),signedDistanceFromCamera:eM,occluded:em&&ew[2]>eM||eT}}isOffscreen(en,el,eu,ec){return eu<100||en>=this.screenRightBoundary||ec<100||el>this.screenBottomBoundary}isInsideGrid(en,el,eu,ec){return eu>=0&&en<this.gridRightBoundary&&ec>=0&&el<this.gridBottomBoundary}getViewportMatrix(){let el=en.m.identity([]);return en.m.translate(el,el,[-100,-100,0]),el}};function Ct(el,eu,ec){let ed=eu.createTileMatrix(el,el.worldSize,ec.toUnwrapped());return en.m.multiply(new Float32Array(16),el.projMatrix,ed)}function St(en,el,eu){return el.name===eu.projection.name?en.projMatrix:Ct(eu,el,en)}let Mt=class Mt{constructor(en,el,eu,ec){this.opacity=en?Math.max(0,Math.min(1,en.opacity+(en.placed?el:-el))):ec&&eu?1:0,this.placed=eu}isHidden(){return 0===this.opacity&&!this.placed}};let Lt=class Lt{constructor(en,el,eu,ec,ed,ef=!1){this.text=new Mt(en?en.text:null,el,eu,ed),this.icon=new Mt(en?en.icon:null,el,ec,ed),this.clipped=ef}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}};let Pt=class Pt{constructor(en,el,eu,ec=!1){this.text=en,this.icon=el,this.skipFade=eu,this.clipped=ec}};let Dt=class Dt{constructor(){this.invProjMatrix=en.m.create(),this.viewportMatrix=en.m.create(),this.circles=[]}};let At=class At{constructor(en,el,eu,ec,ed){this.bucketInstanceId=en,this.featureIndex=el,this.sourceLayerIndex=eu,this.bucketIndex=ec,this.tileID=ed}};let Rt=class Rt{constructor(en){this.crossSourceCollisions=en,this.maxGroupID=0,this.collisionGroups={}}get(en){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[en]){let el=++this.maxGroupID;this.collisionGroups[en]={ID:el,predicate:en=>en.collisionGroupID===el}}return this.collisionGroups[en]}};function zt(el,eu,ec,ed,ef){let{horizontalAlign:em,verticalAlign:e_}=en.aY(el),ew=en.aW(el,ed);return new en.P(-(em-.5)*eu+ew[0]*ef,-(e_-.5)*ec+ew[1]*ef)}function Ot(el,eu,ec,ed,ef){let em=new en.P(el,eu);return ec&&em._rotate(ed?ef:-ef),em}let Ft=class Ft{constructor(en,el,eu,ec,ed,ef){this.transform=en.clone(),this.projection=en.projection.name,this.collisionIndex=new Et(this.transform,ed),this.buildingIndex=ef,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=el,this.retainedQueryData={},this.collisionGroups=new Rt(eu),this.collisionCircleArrays={},this.prevPlacement=ec,ec&&(ec.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(el,eu,ec,ed){var ef,em,e_;let ew=ec.getBucket(eu),eT=ec.latestFeatureIndex;if(!ew||!eT||eu.fqid!==ew.layerIds[0])return;let eM=ew.layers[0].layout,eE=ec.collisionBoxArray,eS=Math.pow(2,this.transform.zoom-ec.tileID.overscaledZ),eA=ec.tileSize/en.J,eI=ec.tileID.toUnwrapped();this.transform.setProjection(ew.projection);let eC=(ef=ec.tileID,em=ew.getProjection(),e_=this.transform,em.name===this.projection?e_.calculateProjMatrix(ef.toUnwrapped()):Ct(e_,em,ef)),eP="map"===eM.get("text-pitch-alignment"),ez="map"===eM.get("text-rotation-alignment");eu.compileFilter();let eD=eu.dynamicFilter(),eL=eu.dynamicFilterNeedsFeature(),ek=this.transform.calculatePixelsToTileUnitsMatrix(ec),eR=me(eC,ec.tileID.canonical,eP,ez,this.transform,ew.getProjection(),ek),eO=null;if(eP){let el=fe(eC,ec.tileID.canonical,eP,ez,this.transform,ew.getProjection(),ek);eO=en.m.multiply([],this.transform.labelPlaneMatrix,el)}let eB=null;eD&&ec.latestFeatureIndex&&(eB={unwrappedTileID:eI,dynamicFilter:eD,dynamicFilterNeedsFeature:eL,featureIndex:ec.latestFeatureIndex}),this.retainedQueryData[ew.bucketInstanceId]=new At(ew.bucketInstanceId,eT,ew.sourceLayerIndex,ew.index,ec.tileID);let eF={bucket:ew,layout:eM,posMatrix:eC,textLabelPlaneMatrix:eR,labelToScreenMatrix:eO,clippingData:eB,scale:eS,textPixelRatio:eA,holdingForFade:ec.holdingForFade(),collisionBoxArray:eE,partiallyEvaluatedTextSize:en.i(ew.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:en.i(ew.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(ew.sourceID)};if(ed)for(let en of ew.sortKeyRanges){let{sortKey:eu,symbolInstanceStart:ec,symbolInstanceEnd:ed}=en;el.push({sortKey:eu,symbolInstanceStart:ec,symbolInstanceEnd:ed,parameters:eF})}else el.push({symbolInstanceStart:0,symbolInstanceEnd:ew.symbolInstances.length,parameters:eF})}attemptAnchorPlacement(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC,eP,ez){let{textOffset0:eD,textOffset1:eL,crossTileID:ek}=eE,eR=[eD,eL],eO=zt(en,eu,ec,eR,ed),eB=this.collisionIndex.placeCollisionBox(eA,ed,el,Ot(eO.x,eO.y,ef,em,this.transform.angle),eM,e_,ew,eT.predicate);if(eC){let en=eA.getSymbolInstanceIconSize(ez,this.transform.zoom,eE.placedIconSymbolIndex);if(0===this.collisionIndex.placeCollisionBox(eA,en,eC,Ot(eO.x,eO.y,ef,em,this.transform.angle),eM,e_,ew,eT.predicate).box.length)return}if(eB.box.length>0){let el;return this.prevPlacement&&this.prevPlacement.variableOffsets[ek]&&this.prevPlacement.placements[ek]&&this.prevPlacement.placements[ek].text&&(el=this.prevPlacement.variableOffsets[ek].anchor),this.variableOffsets[ek]={textOffset:eR,width:eu,height:ec,anchor:en,textScale:ed,prevAnchor:el},this.markUsedJustification(eA,en,eE,eI),eA.allowVerticalPlacement&&(this.markUsedOrientation(eA,eI,eE),this.placedOrientations[ek]=eI),{shift:eO,placedGlyphBoxes:eB}}}placeLayerBucketPart(el,eu,ec,ed){let{bucket:ef,layout:em,posMatrix:e_,textLabelPlaneMatrix:ew,labelToScreenMatrix:eT,clippingData:eM,textPixelRatio:eE,holdingForFade:eS,collisionBoxArray:eA,partiallyEvaluatedTextSize:eI,partiallyEvaluatedIconSize:eC,collisionGroup:eP}=el.parameters,ez=em.get("text-optional"),eD=em.get("icon-optional"),eL=em.get("text-allow-overlap"),ek=em.get("icon-allow-overlap"),eR="map"===em.get("text-rotation-alignment"),eO="map"===em.get("text-pitch-alignment"),eB="viewport-y"===em.get("symbol-z-order"),eF=em.get("symbol-z-elevate");this.transform.setProjection(ef.projection);let eN=eL&&(ek||!ef.hasIconData()||eD),eU=ek&&(eL||!ef.hasTextData()||ez);!ef.collisionArrays&&eA&&ef.deserializeCollisionBoxes(eA),ec&&ed&&ef.updateCollisionDebugBuffers(this.transform.zoom,eA);let S=(el,ed,eA)=>{let{crossTileID:eB,numVerticalGlyphVertices:eF}=el;if(eM){let ec={zoom:this.transform.zoom,pitch:this.transform.pitch},ed=null;if(eM.dynamicFilterNeedsFeature){let en=this.retainedQueryData[ef.bucketInstanceId];ed=eM.featureIndex.loadFeature({featureIndex:el.featureIndex,bucketIndex:en.bucketIndex,sourceLayerIndex:en.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,eM.dynamicFilter)(ec,ed,this.retainedQueryData[ef.bucketInstanceId].tileID.canonical,new en.P(el.tileAnchorX,el.tileAnchorY),this.transform.calculateDistanceTileData(eM.unwrappedTileID)))return this.placements[eB]=new Pt(!1,!1,!1,!0),void eu.add(eB)}if(eu.has(eB))return;if(eS)return void(this.placements[eB]=new Pt(!1,!1,!1));let eV=!1,ej=!1,eG=!0,eq=!1,eZ=!1,e$=null,eW={box:null,offscreen:null,occluded:null},eH={box:null,offscreen:null,occluded:null},eX=null,eK=null,eJ=null,eY=0,eQ=0,e0=0;eA.textFeatureIndex?eY=eA.textFeatureIndex:el.useRuntimeCollisionCircles&&(eY=el.featureIndex),eA.verticalTextFeatureIndex&&(eQ=eA.verticalTextFeatureIndex);let G=en=>{en.tileID=this.retainedQueryData[ef.bucketInstanceId].tileID;let eu=this.transform.elevation;en.elevation=el.zOffset+(eu?eu.getAtTileOffset(en.tileID,en.tileAnchorX,en.tileAnchorY):0)},e1=eA.textBox;if(e1){G(e1);let i=eu=>{let ec=en.W.horizontal;if(ef.allowVerticalPlacement&&!eu&&this.prevPlacement){let en=this.prevPlacement.placedOrientations[eB];en&&(this.placedOrientations[eB]=en,ec=en,this.markUsedOrientation(ef,ec,el))}return ec},o=(el,eu)=>{if(ef.allowVerticalPlacement&&eF>0&&eA.verticalTextBox){for(let ec of ef.writingModes)if(ec===en.W.vertical?eH=eW=eu():eW=el(),eW&&eW.box&&eW.box.length)break}else eW=el()};if(em.get("text-variable-anchor")){let eu=em.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[eB]){let en=this.prevPlacement.variableOffsets[eB];eu.indexOf(en.anchor)>0&&(eu=eu.filter(el=>el!==en.anchor)).unshift(en.anchor)}let c=(en,ec,em)=>{let ew=ef.getSymbolInstanceTextSize(eI,el,this.transform.zoom,ed),eT=(en.x2-en.x1)*ew+2*en.padding,eM=(en.y2-en.y1)*ew+2*en.padding,eS=el.hasIconTextFit&&!ek?ec:null;eS&&G(eS);let eA={box:[],offscreen:!1,occluded:!1},ez=eL?2*eu.length:eu.length;for(let ec=0;ec<ez;++ec){let ez=this.attemptAnchorPlacement(eu[ec%eu.length],en,eT,eM,ew,eR,eO,eE,e_,eP,ec>=eu.length,el,ed,ef,em,eS,eI,eC);if(ez&&(eA=ez.placedGlyphBoxes)&&eA.box&&eA.box.length){eV=!0,e$=ez.shift;break}}return eA};o(()=>c(e1,eA.iconBox,en.W.horizontal),()=>{let el=eA.verticalTextBox;return el&&G(el),ef.allowVerticalPlacement&&!(eW&&eW.box&&eW.box.length)&&eF>0&&el?c(el,eA.verticalIconBox,en.W.vertical):{box:null,offscreen:null,occluded:null}}),eW&&(eV=eW.box,eG=eW.offscreen,eq=eW.occluded);let ec=i(!(!eW||!eW.box));if(!eV&&this.prevPlacement){let en=this.prevPlacement.variableOffsets[eB];en&&(this.variableOffsets[eB]=en,this.markUsedJustification(ef,en.anchor,el,ec))}}else{let n=(eu,ec)=>{let em=ef.getSymbolInstanceTextSize(eI,el,this.transform.zoom,ed),ew=this.collisionIndex.placeCollisionBox(ef,em,eu,new en.P(0,0),eL,eE,e_,eP.predicate);return ew&&ew.box&&ew.box.length&&(this.markUsedOrientation(ef,ec,el),this.placedOrientations[eB]=ec),ew};o(()=>n(e1,en.W.horizontal),()=>{let el=eA.verticalTextBox;return ef.allowVerticalPlacement&&eF>0&&el?(G(el),n(el,en.W.vertical)):{box:null,offscreen:null,occluded:null}}),i(!!(eW&&eW.box&&eW.box.length))}}if(eV=(eX=eW)&&eX.box&&eX.box.length>0,eG=eX&&eX.offscreen,eq=eX&&eX.occluded,el.useRuntimeCollisionCircles){let eu=ef.text.placedSymbolArray.get(el.centerJustifiedTextSymbolIndex>=0?el.centerJustifiedTextSymbolIndex:el.verticalPlacedTextSymbolIndex),ed=en.j(ef.textSizeData,eI,eu),eM=em.get("text-padding");eK=this.collisionIndex.placeCollisionCircles(ef,eL,eu,ef.lineVertexArray,ef.glyphOffsetArray,ed,e_,ew,eT,ec,eO,eP.predicate,el.collisionCircleDiameter*ed/en.aV,eM,this.retainedQueryData[ef.bucketInstanceId].tileID),eV=eL||eK.circles.length>0&&!eK.collisionDetected,eG=eG&&eK.offscreen,eq=eK.occluded}if(eA.iconFeatureIndex&&(e0=eA.iconFeatureIndex),eA.iconBox){let i=eu=>{G(eu);let ec=el.hasIconTextFit&&e$?Ot(e$.x,e$.y,eR,eO,this.transform.angle):new en.P(0,0),ed=ef.getSymbolInstanceIconSize(eC,this.transform.zoom,el.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(ef,ed,eu,ec,ek,eE,e_,eP.predicate)};ej=eH&&eH.box&&eH.box.length&&eA.verticalIconBox?(eJ=i(eA.verticalIconBox)).box.length>0:(eJ=i(eA.iconBox)).box.length>0,eG=eG&&eJ.offscreen,eZ=eJ.occluded}let e2=ez||0===el.numHorizontalGlyphVertices&&0===eF,e3=eD||0===el.numIconVertices;if(e2||e3?e3?e2||(ej=ej&&eV):eV=ej&&eV:ej=eV=ej&&eV,eV&&eX&&eX.box&&this.collisionIndex.insertCollisionBox(eX.box,em.get("text-ignore-placement"),ef.bucketInstanceId,eH&&eH.box&&eQ?eQ:eY,eP.ID),ej&&eJ&&this.collisionIndex.insertCollisionBox(eJ.box,em.get("icon-ignore-placement"),ef.bucketInstanceId,e0,eP.ID),eK&&(eV&&this.collisionIndex.insertCollisionCircles(eK.circles,em.get("text-ignore-placement"),ef.bucketInstanceId,eY,eP.ID),ec)){let en=ef.bucketInstanceId,el=this.collisionCircleArrays[en];void 0===el&&(el=this.collisionCircleArrays[en]=new Dt);for(let en=0;en<eK.circles.length;en+=4)el.circles.push(eK.circles[en+0]),el.circles.push(eK.circles[en+1]),el.circles.push(eK.circles[en+2]),el.circles.push(eK.collisionDetected?1:0)}let e4="globe"!==ef.projection.name;eN=eN&&(e4||!eq),eU=eU&&(e4||!eZ),this.placements[eB]=new Pt(eV||eN,ej||eU,eG||ef.justReloaded),eu.add(eB)};if(eF&&this.buildingIndex&&(this.buildingIndex.updateZOffset(ef,this.retainedQueryData[ef.bucketInstanceId].tileID),ef.updateZOffset()),eB){let el=ef.getSortedSymbolIndexes(this.transform.angle);for(let en=el.length-1;en>=0;--en){let eu=el[en];S(ef.symbolInstances.get(eu),eu,ef.collisionArrays[eu])}ef.hasAnyZOffset&&en.X(`${ef.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(ef.hasAnyZOffset){let en=ef.getSortedIndexesByZOffset();for(let el=0;el<en.length;++el){let eu=en[el];S(ef.symbolInstances.get(eu),eu,ef.collisionArrays[eu])}}else for(let en=el.symbolInstanceStart;en<el.symbolInstanceEnd;en++)S(ef.symbolInstances.get(en),en,ef.collisionArrays[en]);if(ec&&ef.bucketInstanceId in this.collisionCircleArrays){let el=this.collisionCircleArrays[ef.bucketInstanceId];en.m.invert(el.invProjMatrix,e_),el.viewportMatrix=this.collisionIndex.getViewportMatrix()}ef.justReloaded=!1}markUsedJustification(el,eu,ec,ed){let{leftJustifiedTextSymbolIndex:ef,centerJustifiedTextSymbolIndex:em,rightJustifiedTextSymbolIndex:e_,verticalPlacedTextSymbolIndex:ew,crossTileID:eT}=ec,eM=en.aX(eu),eE=ed===en.W.vertical?ew:"left"===eM?ef:"center"===eM?em:"right"===eM?e_:-1;ef>=0&&(el.text.placedSymbolArray.get(ef).crossTileID=eE>=0&&ef!==eE?0:eT),em>=0&&(el.text.placedSymbolArray.get(em).crossTileID=eE>=0&&em!==eE?0:eT),e_>=0&&(el.text.placedSymbolArray.get(e_).crossTileID=eE>=0&&e_!==eE?0:eT),ew>=0&&(el.text.placedSymbolArray.get(ew).crossTileID=eE>=0&&ew!==eE?0:eT)}markUsedOrientation(el,eu,ec){let ed=eu===en.W.horizontal||eu===en.W.horizontalOnly?eu:0,ef=eu===en.W.vertical?eu:0,{leftJustifiedTextSymbolIndex:em,centerJustifiedTextSymbolIndex:e_,rightJustifiedTextSymbolIndex:ew,verticalPlacedTextSymbolIndex:eT}=ec,eM=el.text.placedSymbolArray;em>=0&&(eM.get(em).placedOrientation=ed),e_>=0&&(eM.get(e_).placedOrientation=ed),ew>=0&&(eM.get(ew).placedOrientation=ed),eT>=0&&(eM.get(eT).placedOrientation=ef)}commit(en){this.commitTime=en,this.zoomAtLastRecencyCheck=this.transform.zoom;let el=this.prevPlacement,eu=!1;this.prevZoomAdjustment=el?el.zoomAdjustment(this.transform.zoom):0;let ec=el?el.symbolFadeChange(en):1,ed=el?el.opacities:{},ef=el?el.variableOffsets:{},em=el?el.placedOrientations:{};for(let en in this.placements){let el=this.placements[en],ef=ed[en];ef?(this.opacities[en]=new Lt(ef,ec,el.text,el.icon,null,el.clipped),eu=eu||el.text!==ef.text.placed||el.icon!==ef.icon.placed):(this.opacities[en]=new Lt(null,ec,el.text,el.icon,el.skipFade,el.clipped),eu=eu||el.text||el.icon)}for(let en in ed){let el=ed[en];if(!this.opacities[en]){let ed=new Lt(el,ec,!1,!1);ed.isHidden()||(this.opacities[en]=ed,eu=eu||el.text.placed||el.icon.placed)}}for(let en in ef)this.variableOffsets[en]||!this.opacities[en]||this.opacities[en].isHidden()||(this.variableOffsets[en]=ef[en]);for(let en in em)this.placedOrientations[en]||!this.opacities[en]||this.opacities[en].isHidden()||(this.placedOrientations[en]=em[en]);eu?this.lastPlacementChangeTime=en:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=el?el.lastPlacementChangeTime:en)}updateLayerOpacities(en,el){let eu=new Set;for(let ec of el){let el=ec.getBucket(en);el&&ec.latestFeatureIndex&&en.fqid===el.layerIds[0]&&(this.updateBucketOpacities(el,eu,ec.collisionBoxArray),el.layers[0].layout.get("symbol-z-elevate")&&this.buildingIndex&&(this.buildingIndex.updateZOffset(el,ec.tileID),el.updateZOffset()))}}updateBucketOpacities(el,eu,ec){el.hasTextData()&&el.text.opacityVertexArray.clear(),el.hasIconData()&&el.icon.opacityVertexArray.clear(),el.hasIconCollisionBoxData()&&el.iconCollisionBox.collisionVertexArray.clear(),el.hasTextCollisionBoxData()&&el.textCollisionBox.collisionVertexArray.clear();let ed=el.layers[0].layout,ef=!!el.layers[0].dynamicFilter(),em=new Lt(null,0,!1,!1,!0),e_=ed.get("text-allow-overlap"),ew=ed.get("icon-allow-overlap"),eT=ed.get("text-variable-anchor"),eM="map"===ed.get("text-rotation-alignment"),eE="map"===ed.get("text-pitch-alignment"),eS=new Lt(null,0,e_&&(ew||!el.hasIconData()||ed.get("icon-optional")),ew&&(e_||!el.hasTextData()||ed.get("text-optional")),!0);!el.collisionArrays&&ec&&(el.hasIconCollisionBoxData()||el.hasTextCollisionBoxData())&&el.deserializeCollisionBoxes(ec);let u=(en,el,eu)=>{for(let ec=0;ec<el/4;ec++)en.opacityVertexArray.emplaceBack(eu)},eA=0;for(let ec=0;ec<el.symbolInstances.length;ec++){let ed=el.symbolInstances.get(ec),{numHorizontalGlyphVertices:e_,numVerticalGlyphVertices:ew,crossTileID:eI,numIconVertices:eC}=ed,eP=eu.has(eI),ez=this.opacities[eI];eP?ez=em:ez||(ez=eS,this.opacities[eI]=ez),eu.add(eI);let eL=e_>0||ew>0,ek=eC>0,eR=this.placedOrientations[eI],eO=eR===en.W.vertical,eB=eR===en.W.horizontal||eR===en.W.horizontalOnly;if(!eL&&!ek||ez.isHidden()||eA++,eL){let en=Wt(ez.text);u(el.text,e_,eO?eD:en),u(el.text,ew,eB?eD:en);let eu=ez.text.isHidden(),{leftJustifiedTextSymbolIndex:ec,centerJustifiedTextSymbolIndex:ef,rightJustifiedTextSymbolIndex:em,verticalPlacedTextSymbolIndex:eT}=ed,eM=el.text.placedSymbolArray,eE=eu||eO?1:0;ec>=0&&(eM.get(ec).hidden=eE),ef>=0&&(eM.get(ef).hidden=eE),em>=0&&(eM.get(em).hidden=eE),eT>=0&&(eM.get(eT).hidden=eu||eB?1:0);let eS=this.variableOffsets[eI];eS&&this.markUsedJustification(el,eS.anchor,ed,eR);let eA=this.placedOrientations[eI];eA&&(this.markUsedJustification(el,"left",ed,eA),this.markUsedOrientation(el,eA,ed))}if(ek){let en=Wt(ez.icon),{placedIconSymbolIndex:eu,verticalPlacedIconSymbolIndex:ec}=ed,ef=el.icon.placedSymbolArray,em=ez.icon.isHidden()?1:0;eu>=0&&(u(el.icon,eC,eO?eD:en),ef.get(eu).hidden=em),ec>=0&&(u(el.icon,ed.numVerticalIconVertices,eB?eD:en),ef.get(ec).hidden=em)}if(el.hasIconCollisionBoxData()||el.hasTextCollisionBoxData()){let eu=el.collisionArrays[ec];if(eu){let ec=new en.P(0,0),em=!0;if(eu.textBox||eu.verticalTextBox){if(eT){let en=this.variableOffsets[eI];en?(ec=zt(en.anchor,en.width,en.height,en.textOffset,en.textScale),eM&&ec._rotate(eE?this.transform.angle:-this.transform.angle)):em=!1}ef&&(em=!ez.clipped),eu.textBox&&Bt(el.textCollisionBox.collisionVertexArray,ez.text.placed,!em||eO,ec.x,ec.y),eu.verticalTextBox&&Bt(el.textCollisionBox.collisionVertexArray,ez.text.placed,!em||eB,ec.x,ec.y)}let e_=em&&!!(!eB&&eu.verticalIconBox);eu.iconBox&&Bt(el.iconCollisionBox.collisionVertexArray,ez.icon.placed,e_,ed.hasIconTextFit?ec.x:0,ed.hasIconTextFit?ec.y:0),eu.verticalIconBox&&Bt(el.iconCollisionBox.collisionVertexArray,ez.icon.placed,!e_,ed.hasIconTextFit?ec.x:0,ed.hasIconTextFit?ec.y:0)}}}if(el.fullyClipped=0===eA,el.sortFeatures(this.transform.angle),this.retainedQueryData[el.bucketInstanceId]&&(this.retainedQueryData[el.bucketInstanceId].featureSortOrder=el.featureSortOrder),el.hasTextData()&&el.text.opacityVertexBuffer&&el.text.opacityVertexBuffer.updateData(el.text.opacityVertexArray),el.hasIconData()&&el.icon.opacityVertexBuffer&&el.icon.opacityVertexBuffer.updateData(el.icon.opacityVertexArray),el.hasIconCollisionBoxData()&&el.iconCollisionBox.collisionVertexBuffer&&el.iconCollisionBox.collisionVertexBuffer.updateData(el.iconCollisionBox.collisionVertexArray),el.hasTextCollisionBoxData()&&el.textCollisionBox.collisionVertexBuffer&&el.textCollisionBox.collisionVertexBuffer.updateData(el.textCollisionBox.collisionVertexArray),el.bucketInstanceId in this.collisionCircleArrays){let en=this.collisionCircleArrays[el.bucketInstanceId];el.placementInvProjMatrix=en.invProjMatrix,el.placementViewportMatrix=en.viewportMatrix,el.collisionCircleArray=en.circles,delete this.collisionCircleArrays[el.bucketInstanceId]}}symbolFadeChange(en){return 0===this.fadeDuration?1:(en-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(en){return Math.max(0,(this.transform.zoom-en)/1.5)}hasTransitions(en){return this.stale||en-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(en,el){let eu=this.zoomAtLastRecencyCheck===el?1-this.zoomAdjustment(el):1;return this.zoomAtLastRecencyCheck=el,this.commitTime+this.fadeDuration*eu>en}setStale(){this.stale=!0}};function Bt(en,el,eu,ec,ed){en.emplaceBack(el?1:0,eu?1:0,ec||0,ed||0),en.emplaceBack(el?1:0,eu?1:0,ec||0,ed||0),en.emplaceBack(el?1:0,eu?1:0,ec||0,ed||0),en.emplaceBack(el?1:0,eu?1:0,ec||0,ed||0)}function Wt(en){if(0===en.opacity&&!en.placed)return 0;if(1===en.opacity&&en.placed)return 4294967295;let el=en.placed?1:0,eu=Math.floor(127*en.opacity);return 33554432*eu+16777216*el+131072*eu+65536*el+512*eu+256*el+2*eu+el}let eD=0;let qt=class qt{constructor(en){this._sortAcrossTiles="viewport-y"!==en.layout.get("symbol-z-order")&&void 0!==en.layout.get("symbol-sort-key").constantOr(1),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(en,el,eu,ec,ed){let ef=this._bucketParts;for(;this._currentTileIndex<en.length;)if(el.getBucketParts(ef,ec,en[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,ed())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,ef.sort((en,el)=>en.sortKey-el.sortKey));this._currentPartIndex<ef.length;){let en=ef[this._currentPartIndex];if(el.placeLayerBucketPart(en,this._seenCrossTileIDs,eu,0===en.symbolInstanceStart),this._currentPartIndex++,ed())return!0}return!1}};let $t=class $t{constructor(en,el,eu,ec,ed,ef,em,e_,ew){this.placement=new Ft(en,ed,ef,em,e_,ew),this._currentPlacementIndex=el.length-1,this._forceFullPlacement=eu,this._showCollisionBoxes=ec,this._done=!1}isDone(){return this._done}continuePlacement(el,eu,ec,ed){let ef=en.a4.now(),n=()=>{let el=en.a4.now()-ef;return!this._forceFullPlacement&&el>2};for(;this._currentPlacementIndex>=0;){let ef=eu[el[this._currentPlacementIndex]],em=this.placement.collisionIndex.transform.zoom;if("symbol"===ef.type&&(!ef.minzoom||ef.minzoom<=em)&&(!ef.maxzoom||ef.maxzoom>em)){let el=ef.layout.get("symbol-z-elevate"),eu=this._inProgressLayer=this._inProgressLayer||new qt(ef),em=en.aE(ef.source,ef.scope);if(eu.continuePlacement(el?ed[em]:ec[em],this.placement,this._showCollisionBoxes,ef,n))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(en){return this.placement.commit(en),this.placement}};let eL=512/en.J/2;let Jt=class Jt{constructor(el,eu,ec){this.tileID=el,this.bucketInstanceId=ec,this.index=new en.aZ(eu.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];let ed=el.canonical.x*en.J,ef=el.canonical.y*en.J;for(let en=0;en<eu.length;en++){let{key:el,crossTileID:ec,tileAnchorX:em,tileAnchorY:e_}=eu.get(en),ew=Math.floor((ed+em)*eL),eT=Math.floor((ef+e_)*eL);this.index.add(ew,eT),this.keys.push(el),this.crossTileIDs.push(ec)}this.index.finish()}findMatches(el,eu,ec){let ed=this.tileID.canonical.z<eu.canonical.z?1:Math.pow(2,this.tileID.canonical.z-eu.canonical.z),ef=eL/Math.pow(2,eu.canonical.z-this.tileID.canonical.z),em=eu.canonical.x*en.J,e_=eu.canonical.y*en.J;for(let en=0;en<el.length;en++){let eu=el.get(en);if(eu.crossTileID)continue;let{key:ew,tileAnchorX:eT,tileAnchorY:eM}=eu,eE=Math.floor((em+eT)*ef),eS=Math.floor((e_+eM)*ef),eA=this.index.range(eE-ed,eS-ed,eE+ed,eS+ed);for(let en of eA){let el=this.crossTileIDs[en];if(this.keys[en]===ew&&!ec.has(el)){ec.add(el),eu.crossTileID=el;break}}}}};let Yt=class Yt{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}};let Kt=class Kt{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(en){let el=Math.round((en-this.lng)/360);if(0!==el)for(let en in this.indexes){let eu=this.indexes[en],ec={};for(let en in eu){let ed=eu[en];ed.tileID=ed.tileID.unwrapTo(ed.tileID.wrap+el),ec[ed.tileID.key]=ed}this.indexes[en]=ec}this.lng=en}addBucket(en,el,eu){if(this.indexes[en.overscaledZ]&&this.indexes[en.overscaledZ][en.key]){if(this.indexes[en.overscaledZ][en.key].bucketInstanceId===el.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(en.overscaledZ,this.indexes[en.overscaledZ][en.key])}for(let en=0;en<el.symbolInstances.length;en++)el.symbolInstances.get(en).crossTileID=0;this.usedCrossTileIDs[en.overscaledZ]||(this.usedCrossTileIDs[en.overscaledZ]=new Set);let ec=this.usedCrossTileIDs[en.overscaledZ];for(let eu in this.indexes){let ed=this.indexes[eu];if(Number(eu)>en.overscaledZ)for(let eu in ed){let ef=ed[eu];ef.tileID.isChildOf(en)&&ef.findMatches(el.symbolInstances,en,ec)}else{let ef=ed[en.scaledTo(Number(eu)).key];ef&&ef.findMatches(el.symbolInstances,en,ec)}}for(let en=0;en<el.symbolInstances.length;en++){let ed=el.symbolInstances.get(en);ed.crossTileID||(ed.crossTileID=eu.generate(),ec.add(ed.crossTileID))}return void 0===this.indexes[en.overscaledZ]&&(this.indexes[en.overscaledZ]={}),this.indexes[en.overscaledZ][en.key]=new Jt(en,el.symbolInstances,el.bucketInstanceId),!0}removeBucketCrossTileIDs(en,el){for(let eu of el.crossTileIDs)this.usedCrossTileIDs[en].delete(eu)}removeStaleBuckets(en){let el=!1;for(let eu in this.indexes){let ec=this.indexes[eu];for(let ed in ec)en[ec[ed].bucketInstanceId]||(this.removeBucketCrossTileIDs(eu,ec[ed]),delete ec[ed],el=!0)}return el}};let Qt=class Qt{constructor(){this.layerIndexes={},this.crossTileIDs=new Yt,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(en,el,eu,ec){let ed=this.layerIndexes[en.fqid];void 0===ed&&(ed=this.layerIndexes[en.fqid]=new Kt);let ef=!1,em={};for(let e_ of("globe"!==ec.name&&ed.handleWrapJump(eu),el)){let el=e_.getBucket(en);el&&en.fqid===el.layerIds[0]&&(el.bucketInstanceId||(el.bucketInstanceId=++this.maxBucketInstanceId),ed.addBucket(e_.tileID,el,this.crossTileIDs)&&(ef=!0),em[el.bucketInstanceId]=!0)}return ed.removeStaleBuckets(em)&&(ef=!0),ef}pruneUnusedLayers(en){let el={};for(let eu in en.forEach(en=>{el[en]=!0}),this.layerIndexes)el[eu]||delete this.layerIndexes[eu]}};var ek="\n#define EPSILON 0.0000001\n#define PI 3.141592653589793\n#ifdef RENDER_CUTOFF\nfloat cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}\n#endif",eR="\nout vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\n#ifdef INDICATOR_CUTOUT\nuniform vec2 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;\n#endif\nvec4 applyCutout(vec4 color) {\n#ifdef INDICATOR_CUTOUT\nfloat holeMinOpacity=u_indicator_cutout_params.x;float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);\n#else\nreturn color;\n#endif\n}\n#ifdef DEBUG_WIREFRAME\n#define HANDLE_WIREFRAME_DEBUG \\\nglFragColor=vec4(0.7,0.0,0.0,0.7); \\\ngl_FragDepth=gl_FragCoord.z-0.0001;\n#else\n#define HANDLE_WIREFRAME_DEBUG\n#endif\n#ifdef RENDER_CUTOFF\nuniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;\n#endif\nvec4 textureLodCustom(sampler2D image,vec2 pos,vec2 lod_coord) {vec2 size=vec2(textureSize(image,0));vec2 dx=dFdx(lod_coord.xy*size);vec2 dy=dFdy(lod_coord.xy*size);float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}",eO="\n#define EXTENT 8192.0\n#define RAD_TO_DEG 180.0/PI\n#define DEG_TO_RAD PI/180.0\n#define GLOBE_RADIUS EXTENT/PI/2.0\nfloat wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {\n#ifndef PROJECTED_POS_ON_VIEWPORT\nfloat tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(\nunpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}\n#ifdef RENDER_CUTOFF\nuniform vec4 u_cutoff_params;out float v_cutoff_opacity;\n#endif\nconst vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)\n{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}",eB="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",eF="\n#define ELEVATION_SCALE 7.0\n#define ELEVATION_OFFSET 450.0\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(\nmix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}\n#else\nvec3 elevationVector(vec2 pos) { return vec3(0,0,1); }\n#endif\n#ifdef TERRAIN\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform sampler2D u_depth;uniform vec2 u_depth_size_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}float prevElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}\n#ifdef TERRAIN_VERTEX_MORPHING\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nfloat nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}\n#else\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nreturn currentElevation(apos);}\n#endif\nhighp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5));return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;vec4 depth=vec4(\nunpack_depth(texture(u_depth,uv-df.xz)),unpack_depth(texture(u_depth,uv+df.xz)),unpack_depth(texture(u_depth,uv-df.zy)),unpack_depth(texture(u_depth,uv+df.zy))\n);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}\n#else\nfloat elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }\n#endif",eN="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}\n#endif",eU="highp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}\n#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {\n#ifdef FOG_DITHERING\nvec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);\n#else\nreturn color;\n#endif\n}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}\n#endif",eV="#ifdef RASTER_ARRAY\nuniform sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);vec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return (texCoord.xxyy+vec2(1.5,0.5).xyxy)/texResolution.xxyy;}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;vec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texture(u_image0,c.yz),texture(u_image0,c.xz),texture(u_image0,c.yw),texture(u_image0,c.xw)\n);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;vec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texture(u_image1,c.yz),texture(u_image1,c.xz),texture(u_image1,c.yw),texture(u_image1,c.xw)\n);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texture(u_image0,texCoord);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texture(u_image1,texCoord);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}\n#endif",ej="#ifdef RENDER_SHADOWS\nuniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}\n#endif//RENDER_SHADOWS",eG="#ifdef RENDER_SHADOWS\n#ifdef DEPTH_TEXTURE\nuniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;\n#else\nuniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;\n#endif\nuniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture(u_shadowmap_1,uv).r;\n#else\nshadow_depth=unpack_depth(texture(u_shadowmap_1,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture(u_shadowmap_0,uv).r;\n#else\nshadow_depth=unpack_depth(texture(u_shadowmap_0,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;\n#ifdef NATIVE\nhighp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));\n#else\nhighp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(\nshadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)\n);\n#endif\nvec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return mix(lerpx.x,lerpx.y,f.y);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {\n#ifdef SHADOWS_SINGLE_CASCADE\nlight_view_pos0.xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);\n#else\nlight_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth));\n#endif\n}highp float calculate_shadow_bias(float NDotL) {\n#ifdef NORMAL_OFFSET\nreturn 0.5*u_shadow_bias.x;\n#else\nreturn 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));\n#endif\n}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}\n#endif";let eq=[];fi(ek,eq),fi(eO,eq),fi(eR,eq);let eZ={"_prelude_fog.vertex.glsl":eN,"_prelude_terrain.vertex.glsl":eF,"_prelude_shadow.vertex.glsl":ej,"_prelude_fog.fragment.glsl":eU,"_prelude_shadow.fragment.glsl":eG,"_prelude_lighting.glsl":"\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}\n#endif//LIGHTING_3D_MODE","_prelude_raster_array.glsl":eV},e$={};gi("",eF),gi(eU,eN),gi(eG,ej),gi(eV,"");let eW=gi(eR,eO);var eH={background:gi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec4 u_color;uniform float u_opacity;\n#ifdef LIGHTING_3D_MODE\nin vec4 v_color;\n#endif\nvoid main() {vec4 out_color;\n#ifdef LIGHTING_3D_MODE\nout_color=v_color;\n#else\nout_color=u_color;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_lighting.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef LIGHTING_3D_MODE\nv_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),backgroundPattern:gi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in vec2 v_pos;void main() {vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_tile_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),circle:gi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec3 v_data;in float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(\nantialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)\n);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_apply_premultiplied(out_color,v_fog_pos);\n#endif\nglFragColor=out_color*(v_visibility*opacity_t);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define NUM_VISIBILITY_RINGS 2\n#define INV_SQRT2 0.70710678\n#define ELEVATION_BIAS 0.0001\n#define NUM_SAMPLES_PER_RING 16\nuniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec3 v_data;out float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {\n#if defined(TERRAIN)\nreturn elevation(pos)+ELEVATION_BIAS;\n#else\nreturn 0.0;\n#endif\n}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);\n#ifdef PITCH_WITH_MAP\n#ifdef PROJECTION_GLOBE_VIEW\nreturn u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );\n#else\nreturn u_matrix*( world_center+vec4(sample_offset,0,0) );\n#endif\n#else\nreturn projected_center+vec4(sample_offset,0,0);\n#endif\n}float get_sample_step() {\n#ifdef PITCH_WITH_MAP\nreturn 2.0*PI/float(NUM_SAMPLES_PER_RING);\n#else\nreturn PI/float(NUM_SAMPLES_PER_RING);\n#endif\n}void main(void) {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);\n#else \nsurface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);\n#endif\nvec4 projected_center=u_matrix*world_center;float view_scale=0.0;\n#ifdef PITCH_WITH_MAP\n#ifdef SCALE_WITH_MAP\nview_scale=1.0;\n#else\nview_scale=projected_center.w/u_camera_to_center_distance;\n#endif\n#else\n#ifdef SCALE_WITH_MAP\nview_scale=u_camera_to_center_distance;\n#else\nview_scale=projected_center.w;\n#endif\n#endif\ngl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;\n#ifdef TERRAIN\nfloat step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;\n#ifdef PITCH_WITH_MAP\nfloat cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;\n#else\nocclusion_world_center=world_center;occlusion_projected_center=projected_center;\n#endif\nfor(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);\n#else\nvisibility=1.0;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nvisibility=1.0;\n#endif\nv_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);\n#ifdef FOG\nv_fog_pos=fog_position(world_center.xyz);\n#endif\n}'),clippingMask:gi("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:gi('#include "_prelude_fog.fragment.glsl"\nuniform highp float u_intensity;in vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);\n#ifdef FOG\nif (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#else\npos=vec3(tilePos+extrude,elevation(tilePos));\n#endif\ngl_Position=u_matrix*vec4(pos,1);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),heatmapTexture:gi("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(0.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}","in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:gi("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",'#include "_prelude_terrain.vertex.glsl"\nin vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in float a_size_scale;in vec2 a_padding;in float a_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(a_z_offset+elevation(a_anchor_pos)),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}'),collisionCircle:gi("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}","in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(\nmix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:gi("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",'#include "_prelude_terrain.vertex.glsl"\nin vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;\n#endif\nout vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);\n#else\ngl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);\n#endif\n}'),fill:gi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nvec4 out_color=color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutline:gi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin highp vec2 v_pos;uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutlinePattern:gi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;in highp vec2 v_pos;in highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;out highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillPattern:gi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;in vec2 v_pos;uniform float u_emissive_strength;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillExtrusion:gi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec4 v_color;in vec4 v_flat;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;\n#endif\nuniform lowp float u_opacity;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec2 v_ao;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nin vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nin highp vec3 v_normal;\n#endif\nuniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nin float v_flood_radius;in float v_has_floodlight;\n#endif\nuniform float u_emissive_strength;in float v_height;void main() {\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvec3 normal=normalize(v_normal);\n#endif\nfloat z;vec4 color=v_color;\n#ifdef ZERO_ROOF_RADIUS\nz=float(normal.z > 0.00001);\n#ifdef LIGHTING_3D_MODE\nnormal=mix(normal,vec3(0.0,0.0,1.0),z);\n#else\ncolor=mix(v_color,v_roof_color,z);\n#endif\n#endif\nfloat h=max(0.0,v_height);float ao_shade=1.0;\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;\n#ifdef ZERO_ROOF_RADIUS\nconcave*=(1.0-z);\n#endif\nfloat x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\ncolor.rgb*=mix(ao_shade,1.0,v_has_floodlight);\n#else\ncolor.rgb*=ao_shade;\n#endif\n#else\ncolor.rgb*=ao_shade;\n#endif\n#endif\n#ifdef LIGHTING_3D_MODE\nfloat flood_radiance=0.0;\n#ifdef FLOOD_LIGHT\nflood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;\n#endif\n#ifdef RENDER_SHADOWS\n#ifdef FLOOD_LIGHT\nfloat ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,v_depth);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);\n#else\nfloat shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);\n#endif\n#else\ncolor.rgb=apply_lighting(color.rgb,normal);\n#ifdef FLOOD_LIGHT\ncolor.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);\n#endif\n#endif\ncolor.rgb=mix(color.rgb,v_flat.rgb,u_emissive_strength);color*=u_opacity;\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));\n#endif\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\nuniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nout vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nout highp vec3 v_normal;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec2 v_ao;\n#endif\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nout float v_flood_radius;out float v_has_floodlight;\n#endif\nout float v_height;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define highp float flood_light_wall_radius\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize highp float flood_light_wall_radius\nbase*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nv_normal=normal;\n#endif\nbase=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);pos=vec3(pos_nx.xy,h);\n#else\nh=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat cutoff=1.0;vec3 scaled_pos=pos;\n#ifdef RENDER_CUTOFF\nvec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);cutoff=max(0.01,cutoff_opacity(u_cutoff_params,ground.z));if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff < 0.01 && centroid_pos.x !=0.0));gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\nfloat NdotL=0.0;float colorvalue=0.0;\n#ifndef LIGHTING_3D_MODE\ncolorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#endif\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\nfloat is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;\n#endif\nv_color=vec4(color.rgb,1.0);v_flat=vec4(linearProduct(color.rgb,vec3(calculate_NdotL(normal))),1.0);\n#else\nv_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nfloat roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),fillExtrusionDepth:gi("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_vertical_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\nout highp float v_depth;void main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\nbase*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nvec3 pos;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base);pos=vec3(pos_nx.xy,h);\n#else\npos=vec3(pos_nx.xy,t > 0.0 ? height : base);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}'),fillExtrusionPattern:gi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nin vec3 v_normal;\n#endif\nin vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;\n#else\nout_color=out_color*v_lighting;\n#endif\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\nout vec2 v_pos;out vec4 v_lighting;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nout vec3 v_normal;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=z;vec3 p;float c_ele;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);p=vec3(pos_nx.xy,h);\n#else\np=vec3(pos_nx.xy,z);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0\n? pos_nx.xy\n: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;\n#ifdef LIGHTING_3D_MODE\nNdotL=calculate_NdotL(normal);\n#else\nNdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);\n#endif\nif (normal.y !=0.0) {float r=0.84;\n#ifndef LIGHTING_3D_MODE\nr=mix(0.7,0.98,1.0-u_lightintensity);\n#endif\nNdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\nv_normal=normal;\n#else\nv_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;\n#endif \n#ifdef FOG\nv_fog_pos=fog_position(p);\n#endif\n}'),groundShadow:gi('#include "_prelude_shadow.fragment.glsl"\nprecision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;in float v_depth;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\nvoid main() {float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);\n#ifdef RENDER_CUTOFF\nshadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,v_depth));\n#endif\n#ifdef FOG\nshadow=mix(shadow,vec3(1.0),v_fog_opacity);\n#endif\n#ifdef INDICATOR_CUTOUT\nshadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0)).r);\n#endif\nglFragColor=vec4(shadow,1.0);}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);v_depth=gl_Position.w;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);\n#endif\n}'),fillExtrusionGroundEffect:gi("uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;\n#ifdef SDF_SUBPASS\nin highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}\n#ifdef FOG\nin highp float v_fog;\n#endif\n#endif\nvoid main() {\n#ifdef CLEAR_SUBPASS\nvec4 color=vec4(1.0);\n#ifdef CLEAR_FROM_TEXTURE\ncolor=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));\n#endif\nglFragColor=color;\n#else\n#ifdef SDF_SUBPASS\nhighp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;\n#ifdef FOG\nfog=v_fog;\n#endif\n#ifdef RENDER_CUTOFF\nfog*=v_cutoff_opacity;\n#endif\nglFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));\n#else\nvec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);\n#ifdef OVERDRAW_INSPECTOR\ncolor=vec4(1.0);\n#endif\nglFragColor=color;HANDLE_WIREFRAME_DEBUG;\n#endif\n#endif\n}",'#include "_prelude_fog.vertex.glsl"\nin highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;\n#ifdef SDF_SUBPASS\nout highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;\n#ifdef FOG\nout highp float v_fog;\n#endif\n#endif\nuniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp vec2 u_ao;\n#pragma mapbox: define highp float flood_light_ground_radius\nconst float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {\n#pragma mapbox: initialize highp float flood_light_ground_radius\nvec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(1.0,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;\n#ifdef SDF_SUBPASS\nv_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);\n#ifdef FOG\nv_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);\n#endif\n#endif\nfloat hidden_by_landmark=0.0;\n#ifdef HAS_CENTROID\nhidden_by_landmark=a_hidden_by_landmark;\n#endif\nfloat isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),hillshadePrepare:gi("precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(\n(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)\n)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(\nderiv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}","uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:gi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef LIGHTING_3D_MODE\nglFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);\n#endif\n#ifdef FOG\nglFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),line:gi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec4 v_uv;\n#ifdef RENDER_LINE_DASH\nuniform sampler2D u_dash_image;in vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform sampler2D u_gradient_image;\n#endif\nfloat luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nfloat linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef RENDER_LINE_DASH\nfloat sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;alpha*=linearstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);\n#endif\nhighp vec4 out_color;\n#ifdef RENDER_LINE_GRADIENT\nout_color=texture(u_gradient_image,v_uv.xy);\n#else\nout_color=color;\n#endif\nfloat trimmed=1.0;\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {if (line_progress <=trim_end && line_progress >=trim_start) {out_color=vec4(0,0,0,0);trimmed=0.0;}}\n#endif\nif (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}\n#ifdef RENDER_LINE_BORDER\nfloat edgeBlur=(border_width+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {    \nfloat Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color.rgb=mix(border_color.rgb*border_color.a*trimmed,out_color.rgb,smoothAlpha);}}\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#define EXTRUDE_SCALE 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nin highp vec4 a_packed;\n#endif\n#ifdef RENDER_LINE_DASH\nin float a_linesofar;\n#endif\nuniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec4 v_uv;\n#ifdef RENDER_LINE_DASH\nuniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform float u_image_height;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#else\nv_gamma_scale=1.0;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nfloat a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];\n#ifdef RENDER_LINE_GRADIENT\nhighp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec4(a_uv_x,a_split_index*texel_height-half_texel_height,a_clip_start,a_clip_end);\n#else\nv_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);\n#endif\n#endif\n#ifdef RENDER_LINE_DASH\nfloat scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/floorwidth,(-normal.y*height+dash.x+0.5)/u_texsize.y);\n#endif\nv_width2=vec2(outset,inset);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),linePattern:gi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in float v_linesofar;in float v_gamma_scale;in float v_width;\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;vec2 pattern_size=vec2(display_size.x/u_tile_units_to_pixels,display_size.y);float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float pattern_x=v_linesofar/pattern_size.x*aspect;float x=mod(pattern_x,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\ncolor=apply_lighting_ground(color);\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#define scale 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;in float a_linesofar;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_linesofar;out float v_gamma_scale;out float v_width;\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#else\nv_gamma_scale=1.0;\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),raster:gi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_raster_array.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;\n#ifndef RASTER_ARRAY\nuniform sampler2D u_image0;uniform sampler2D u_image1;\n#endif\n#ifdef RASTER_COLOR\nuniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;\n#endif\nvoid main() {vec4 color0,color1,color;vec2 value;\n#ifdef RASTER_COLOR\n#ifdef RASTER_ARRAY\n#ifdef RASTER_ARRAY_LINEAR\nvalue=mix(\nraTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#else\nvalue=mix(\nraTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#endif\nif (value.y > 0.0) value.x/=value.y;\n#else\ncolor=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);\n#endif\ncolor=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;\n#else\ncolor0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);\n#endif\ncolor.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(\ndot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef RENDER_CUTOFF\nglFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8;\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;in vec2 a_texture_pos;\n#endif\nout vec2 v_pos0;out vec2 v_pos1;out float v_depth;void main() {vec2 uv;\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);\n#endif\n#else\nfloat w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\ngl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;\n#ifdef RENDER_CUTOFF\nv_depth=gl_Position.z;\n#endif\n}'),symbolIcon:gi('#include "_prelude_lighting.glsl"\nuniform sampler2D u_texture;\n#ifdef ICON_TRANSITION\nuniform float u_icon_transition;\n#endif\nin float v_fade_opacity;in vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nin vec2 v_tex_b;\n#endif\nuniform mediump float u_icon_saturation;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float emissive_strength\nlowp float alpha=opacity*v_fade_opacity;vec4 out_color;\n#ifdef ICON_TRANSITION\nvec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b)*alpha;\n#else\nout_color=texture(u_texture,v_tex_a)*alpha;\n#endif\n#ifdef SATURATION\nvec3 luma=vec3(dot(out_color.rgb,vec3(0.2126,0.7152,0.0722)));out_color.rgb=mix(luma,out_color.rgb,u_icon_saturation);\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\n#ifdef ICON_TRANSITION\nin vec2 a_texb;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform vec3 u_up_vector;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nout vec2 v_tex_b;\n#endif\nout float v_fade_opacity;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float emissive_strength\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjected_point;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetProjected_point=u_matrix*vec4(a_globe_anchor+displacement,1);\n#else\noffsetProjected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);\n#endif\nvec2 a=projected_point.xy/projected_point.w;vec2 b=offsetProjected_point.xy/offsetProjected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nvec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nv_tex_a=a_tex/u_texsize;\n#ifdef ICON_TRANSITION\nv_tex_b=a_texb/u_texsize;\n#endif\nv_fade_opacity=out_fade_opacity;}'),symbolSDF:gi('#include "_prelude_lighting.glsl"\n#define SDF_PX 8.0\nuniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;in float v_draw_halo;in vec2 v_data0;in vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout float v_draw_halo;out vec2 v_data0;out vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);\n#else\noffsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);\n#endif\nvec2 a=projected_point.xy/projected_point.w;vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nvec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nfloat gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,out_fade_opacity);}'),symbolTextAndIcon:gi('#include "_prelude_lighting.glsl"\n#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_halo;in float v_draw_halo;in vec4 v_data0;in vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nfloat fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nreturn;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout float v_draw_halo;out vec4 v_data0;out vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offset_projected_point=u_matrix*vec4(a_pos+vec2(1,0),0,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offset_projected_point.xy/offset_projected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*font_scale);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nfloat out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nfloat gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,out_fade_opacity,is_sdf);}'),terrainRaster:gi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;in vec2 v_pos0;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nin vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;in float v_depth;\n#endif\nuniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;\n#ifdef LIGHTING_3D_MODE\nconst vec3 normal=vec3(0.0,0.0,1.0);\n#ifdef RENDER_SHADOWS\nfloat cutoffOpacity=1.0;\n#ifdef RENDER_CUTOFF\ncutoffOpacity=cutoff_opacity(u_cutoff_params,v_depth);\n#endif\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nvec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,v_depth,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;\n#else\nfloat lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));\n#endif\n#else\nfloat lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;\n#endif\n#endif\n#else\ncolor=image_color;\n#endif\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#else\ncolor=fog_dither(fog_apply_from_vert(color,v_fog_opacity));\n#endif\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;\n#endif\nvoid main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\nv_fog_pos=fog_position(decodedPos);\n#else\nv_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);v_depth=gl_Position.w;\n#endif\n}'),terrainDepth:gi("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}'),skybox:gi('#include "_prelude_fog.fragment.glsl"\nin lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(\ncos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;\n#ifdef FOG\nsky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);\n#endif\nsky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',eB),skyboxGradient:gi('#include "_prelude_fog.fragment.glsl"\nin highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));\n#ifdef FOG\ncolor.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;\n#endif\ncolor*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',eB),skyboxCapture:gi("\nin highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;\n#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)\n#define BETA_M                  vec3(21e-6,21e-6,21e-6)\n#define MIE_G                   0.76\n#define DENSITY_HEIGHT_SCALE_R  8000.0\n#define DENSITY_HEIGHT_SCALE_M  1200.0\n#define PLANET_RADIUS           6360e3\n#define ATMOSPHERE_RADIUS       6420e3\n#define SAMPLE_STEPS            10\n#define DENSITY_STEPS           4\nfloat ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}","in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:gi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;in vec2 v_pos0;\n#ifndef FOG\nuniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;\n#endif\nvoid main() {vec4 color;\n#ifdef CUSTOM_ANTIALIASING\nvec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);vec3 dir=normalize(ray_dir);vec3 closest_point=dot(u_globe_pos,dir)*dir;float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nraster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(raster.rgb*antialias,antialias);\n#else\nraster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;\n#else\ncolor=apply_lighting_ground(color);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;\n#endif\nout vec2 v_pos0;void main() {\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;vec2 uv=a_uv;\n#else\nfloat tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);\n#endif\nv_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;\n#ifdef GLOBE_POLES\nvec3 up_vector=globe_derived_up_vector;\n#else\nvec3 up_vector=elevationVector(tile_pos);\n#endif\nfloat height=elevation(tile_pos);globe_pos+=up_vector*height;\n#ifndef GLOBE_POLES\nglobe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;\n#endif\n#ifdef GLOBE_POLES\nvec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);\n#else\nvec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);\n#endif\ngl_Position=u_proj_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n}'),globeAtmosphere:gi('#include "_prelude_fog.fragment.glsl"\nuniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;\n#ifdef PROJECTION_GLOBE_VIEW\nglobe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {\n#ifdef ALPHA_PASS\nglFragColor=vec4(0,0,0,0);return;\n#else\n#ifdef NATIVE\nglFragColor=vec4(1,1,1,1);\n#else\nglFragColor=vec4(0,0,0,1);\n#endif\nreturn;\n#endif\n}\n#endif\nhighp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?\n0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;\n#ifdef PROJECTION_GLOBE_VIEW\nhighp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?\nPI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);\n#else\nhorizon_angle=horizon_angle_mercator;\n#endif\nhorizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;\n#ifdef ALPHA_PASS\nfloat a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);\n#else\nvec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;\n#ifndef NATIVE\nc=dither(c,gl_FragCoord.xy+u_temporal_offset);\n#endif\nglFragColor=vec4(c*t,t);\n#endif\n}',"in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(\nmix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}"),model:gi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;\n#ifdef RENDER_SHADOWS\nin vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;in float v_depth_shadows;\n#endif\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nuniform vec4 u_occlusionTextureTransform;\n#endif\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#ifdef HAS_ATTRIBUTE_a_pbr\nin lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;\n#endif\n#ifdef HAS_TEXTURE_u_baseColorTexture\nuniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;\n#endif\n#ifdef HAS_TEXTURE_u_metallicRoughnessTexture\nuniform sampler2D u_metallicRoughnessTexture;\n#endif\n#ifdef HAS_TEXTURE_u_occlusionTexture\nuniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;\n#endif\n#ifdef HAS_TEXTURE_u_normalTexture\nuniform sampler2D u_normalTexture;\n#endif\n#ifdef HAS_TEXTURE_u_emissionTexture\nuniform sampler2D u_emissionTexture;\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nin highp float v_depth;uniform sampler2D u_depthTexture;uniform vec2 u_inv_depth_size;bool isOccluded() {vec2 coord=gl_FragCoord.xy*u_inv_depth_size;highp float depth=unpack_depth(texture(u_depthTexture,coord));return v_depth > depth+0.0005;}\n#endif\n#define saturate(_x) clamp(_x,0.,1.)\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)\n{\n#ifdef LIGHTING_3D_MODE\nvec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));\n#endif\nreturn apply_lighting(albedo,transformed_normal,lighting_factor);\n#else\nvec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;\n#endif\n}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;\n#ifdef HAS_ATTRIBUTE_a_color_3f\nalbedo*=vec4(color_3f,1.0);\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#else\n#ifdef HAS_ATTRIBUTE_a_color_4f\nalbedo*=color_4f;\n#endif\n#endif\n#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)\nvec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}\n#ifdef UNPREMULT_TEXTURE_IN_SHADER\nif(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;\n#endif\nif(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}\n#endif\nreturn vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {\n#ifdef HAS_TEXTURE_u_normalTexture\nhighp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;\n#else\nreturn mat3(1.0);\n#endif\n}highp vec3 getNormal(){highp vec3 n;\n#ifdef HAS_ATTRIBUTE_a_normal_3f\nn=normalize(normal_3f);\n#else\nhighp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;\n#endif\n#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nvec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);\n#endif\nreturn n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;\n#ifdef HAS_ATTRIBUTE_a_pbr\nmat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;\n#endif\n#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) \nvec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;\n#endif\nconst float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)\n{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)\n{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)\n{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)\n{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)\n{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)\n{\n#ifdef LIGHTING_3D_MODE\nreturn mat.diffuseColor;\n#else\nreturn mat.diffuseColor/PI;\n#endif\n}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)\n{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)\n{vec3 env_light=vec3(0.65,0.65,0.65);\n#ifdef LIGHTING_3D_MODE\nfloat ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;\n#endif\nvec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)\n{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=NdotL;\n#endif\nvec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;\n#if !defined(LIGHTING_3D_MODE)\nconst vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);\n#endif\ncolor*=intensityFactor;return color;}void main() {\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nif (isOccluded()) {discard;}\n#endif\nvec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;\n#ifdef LIGHTING_3D_MODE\nlightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;\n#endif\nvec4 finalColor;\n#ifdef DIFFUSE_SHADED\nvec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);\n#ifdef HAS_TEXTURE_u_occlusionTexture\nfloat ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;\n#endif\nfinalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;\n#else\nMaterial mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;\n#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nvec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;\n#else\nvec2 uv=uv_2f;\n#endif\nao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;\n#endif\nvec4 emissive=u_emissiveFactor;\n#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nemissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);\n#endif\ncolor+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;\n#ifdef HAS_ATTRIBUTE_a_pbr\nfloat resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);color=mix(color,v_color_mix.rgb,min(1.0,resEmission));\n#ifdef HAS_ATTRIBUTE_a_color_4f\nfloat distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);\n#endif\n#endif\nvec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);\n#endif\n#ifdef FOG\nfinalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));\n#endif\n#ifdef RENDER_CUTOFF\nfinalColor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nfinalColor=applyCutout(finalColor);\n#endif\nglFragColor=finalColor;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr\n#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength\nuniform mat4 u_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_normal_matrix;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth_shadows;\n#endif\nout vec4 v_position_height;out lowp vec4 v_color_mix;\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nout highp float v_depth;\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\nout lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;\n#endif\nvec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute-custom highp vec4 pbr\n#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength\nhighp mat4 normal_matrix;\n#ifdef INSTANCED_ARRAYS\nnormal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\nnormal_matrix=u_normal_matrix;\n#endif\nvec3 local_pos;mat3 rs;\n#ifdef MODEL_POSITION_ON_GPU\nvec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=u_matrix*pos;pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;\n#else\nlocal_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);\n#endif\nv_position_height.w=a_pos_3f.z;\n#ifdef HAS_ATTRIBUTE_a_pbr\nvec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(local_pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nv_depth=gl_Position.z/gl_Position.w;\n#endif\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nfloat x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);\n#else\nnormal_3f=vec3(normal_matrix*vec4(normal_3f,0));\n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#ifdef HAS_ATTRIBUTE_a_color_4f\nv_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shadow_pos=local_pos;\n#ifdef NORMAL_OFFSET\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nvec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos+=offset*shadow_normal_offset_multiplier0();\n#else\nvec3 offset=shadow_normal_offset_model(normalize(normal_3f));shadow_pos+=offset*shadow_normal_offset_multiplier0();\n#endif\n#endif\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1);v_depth_shadows=gl_Position.w;\n#endif\n}'),modelDepth:gi("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;\n#ifdef MODEL_POSITION_ON_GPU\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_instance;\n#endif\nuniform highp mat4 u_node_matrix;\n#endif\nvoid main() {\n#ifdef MODEL_POSITION_ON_GPU\nhighp mat4 instance;\n#ifdef INSTANCED_ARRAYS\ninstance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\ninstance=u_instance;\n#endif\nvec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=u_matrix*pos;\n#else\ngl_Position=u_matrix*vec4(a_pos_3f,1);\n#endif\nv_depth=gl_Position.z/gl_Position.w;}"),stars:gi("in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)\n{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}","\nin vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}")};function fi(en,el){let eu=en.replace(/\s*\/\/[^\n]*\n/g,"\n").split("\n");for(let en of eu)if("#"===(en=en.trim())[0]&&en.includes("if")&&!en.includes("endif")){en=en.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();let eu=en.split(" ");for(let en of eu)el.includes(en)||el.push(en)}}function gi(en,el){let eu=/#include\s+"([^"]+)"/g,ec=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g,ed=el.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);ed&&(ed=ed.map(en=>{let el=en.split(" ");return el[el.length-1]}),ed=[...new Set(ed)]);let ef={},em=[],e_=[];if(en=en.replace(eu,(en,el)=>(e_.push(el),"")),(el=el.replace(eu,(en,el)=>(em.push(el),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let ew=[...eq];for(let eu of(fi(en,ew),fi(el,ew),[...em,...e_]))eZ[eu]||console.error(`Undefined include: ${eu}`),e$[eu]||(e$[eu]=[],fi(eZ[eu],e$[eu])),ew=[...ew,...e$[eu]];return{fragmentSource:en=en.replace(ec,(en,el,eu,ec,ed)=>(ef[ed]=!0,"define"===el?`
#ifndef HAS_UNIFORM_u_${ed}
in ${eu} ${ec} ${ed};
#else
uniform ${eu} ${ec} u_${ed};
#endif
`:"initialize"===el?`
#ifdef HAS_UNIFORM_u_${ed}
    ${eu} ${ec} ${ed} = u_${ed};
#endif
`:"define-attribute"===el?`
#ifdef HAS_ATTRIBUTE_a_${ed}
    in ${eu} ${ec} ${ed};
#endif
`:"initialize-attribute"===el?"":void 0)),vertexSource:el=el.replace(ec,(en,el,eu,ec,ed)=>{let em="float"===ec?"vec2":ec,e_=ed.match(/color/)?"color":em;return"define-attribute-vertex-shader-only"===el?`
#ifdef HAS_ATTRIBUTE_a_${ed}
in ${eu} ${ec} a_${ed};
#endif
`:ef[ed]?"define"===el?`
#ifndef HAS_UNIFORM_u_${ed}
uniform lowp float u_${ed}_t;
in ${eu} ${em} a_${ed};
out ${eu} ${ec} ${ed};
#else
uniform ${eu} ${ec} u_${ed};
#endif
`:"initialize"===el?"vec4"===e_?`
#ifndef HAS_UNIFORM_u_${ed}
    ${ed} = a_${ed};
#else
    ${eu} ${ec} ${ed} = u_${ed};
#endif
`:`
#ifndef HAS_UNIFORM_u_${ed}
    ${ed} = unpack_mix_${e_}(a_${ed}, u_${ed}_t);
#else
    ${eu} ${ec} ${ed} = u_${ed};
#endif
`:"define-attribute"===el?`
#ifdef HAS_ATTRIBUTE_a_${ed}
    in ${eu} ${ec} a_${ed};
    out ${eu} ${ec} ${ed};
#endif
`:"initialize-attribute"===el?`
#ifdef HAS_ATTRIBUTE_a_${ed}
    ${ed} = a_${ed};
#endif
`:void 0:"define"===el?`
#ifndef HAS_UNIFORM_u_${ed}
uniform lowp float u_${ed}_t;
in ${eu} ${em} a_${ed};
#else
uniform ${eu} ${ec} u_${ed};
#endif
`:"define-instanced"===el?"mat4"===e_?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${ed}0;
in vec4 a_${ed}1;
in vec4 a_${ed}2;
in vec4 a_${ed}3;
#else
uniform ${eu} ${ec} u_${ed};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${eu} ${em} a_${ed};
#else
uniform ${eu} ${ec} u_${ed};
#endif
`:"initialize-attribute-custom"===el?`
#ifdef HAS_ATTRIBUTE_a_${ed}
    ${eu} ${ec} ${ed} = a_${ed};
#endif
`:"vec4"===e_?`
#ifndef HAS_UNIFORM_u_${ed}
    ${eu} ${ec} ${ed} = a_${ed};
#else
    ${eu} ${ec} ${ed} = u_${ed};
#endif
`:`
#ifndef HAS_UNIFORM_u_${ed}
    ${eu} ${ec} ${ed} = unpack_mix_${e_}(a_${ed}, u_${ed}_t);
#else
    ${eu} ${ec} ${ed} = u_${ed};
#endif
`}),staticAttributes:ed,usedDefines:ew,vertexIncludes:em,fragmentIncludes:e_}}let vi=class vi{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(en,el,eu,ec,ed,ef,em,e_){this.context=en;let ew=this.boundPaintVertexBuffers.length!==ec.length;for(let en=0;!ew&&en<ec.length;en++)this.boundPaintVertexBuffers[en]!==ec[en]&&(ew=!0);let eT=this.boundDynamicVertexBuffers.length!==em.length;for(let en=0;!eT&&en<em.length;en++)this.boundDynamicVertexBuffers[en]!==em[en]&&(eT=!0);if(!this.vao||this.boundProgram!==el||this.boundLayoutVertexBuffer!==eu||ew||eT||this.boundIndexBuffer!==ed||this.boundVertexOffset!==ef)this.freshBind(el,eu,ec,ed,ef,em,e_);else{for(let eu of(en.bindVertexArrayOES.set(this.vao),em))eu&&(eu.bind(),e_&&eu.instanceCount&&eu.setVertexAttribDivisor(en.gl,el,e_));ed&&ed.dynamicDraw&&ed.bind()}}freshBind(en,el,eu,ec,ed,ef,em){let e_=en.numAttributes,ew=this.context,eT=ew.gl;for(let em of(this.vao&&this.destroy(),this.vao=ew.gl.createVertexArray(),ew.bindVertexArrayOES.set(this.vao),this.boundProgram=en,this.boundLayoutVertexBuffer=el,this.boundPaintVertexBuffers=eu,this.boundIndexBuffer=ec,this.boundVertexOffset=ed,this.boundDynamicVertexBuffers=ef,el.enableAttributes(eT,en),el.bind(),el.setVertexAttribPointers(eT,en,ed),eu))em.enableAttributes(eT,en),em.bind(),em.setVertexAttribPointers(eT,en,ed);for(let el of ef)el&&(el.enableAttributes(eT,en),el.bind(),el.setVertexAttribPointers(eT,en,ed),em&&el.instanceCount&&el.setVertexAttribDivisor(eT,en,em));ec&&ec.bind(),ew.currentNumAttributes=e_}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}};function bi(el,eu,ec){if(!eu.needsDEMTextureUpload)return;let ed=el.context,ef=ed.gl;ed.pixelStoreUnpackPremultiplyAlpha.set(!1),eu.demTexture=eu.demTexture||el.getTileTexture(ec.stride);let em=ec.getPixels();eu.demTexture?eu.demTexture.update(em,{premultiply:!1}):eu.demTexture=new en.a9(ed,em,ef.R32F,{premultiply:!1}),eu.needsDEMTextureUpload=!1}let Ti=el=>({u_matrix:new en.a_(el),u_image0:new en.a$(el),u_skirt_height:new en.b2(el),u_ground_shadow_factor:new en.b7(el)}),Ei=(en,el,eu)=>({u_matrix:en,u_image0:0,u_skirt_height:el,u_ground_shadow_factor:eu}),Ci=(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI)=>({u_proj_matrix:Float32Array.from(en),u_globe_matrix:el,u_normalize_matrix:Float32Array.from(ec),u_merc_matrix:eu,u_zoom_transition:ed,u_merc_center:ef,u_image0:0,u_frustum_tl:em,u_frustum_tr:e_,u_frustum_br:ew,u_frustum_bl:eT,u_globe_pos:eM,u_globe_radius:eE,u_viewport:eS,u_grid_matrix:eI?Float32Array.from(eI):new Float32Array(9),u_skirt_height:eA}),Ii=(el,eu)=>{if(eu>0&&el.terrain&&en.X("Cutoff is currently disabled on terrain"),eu<=0||el.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};let ec=el.transform,ed=Math.max(Math.abs(ec._zoom-(el.minCutoffZoom-1)),1),ef=ec.isLODDisabled(!1)?en.an(60,45,ec.pitch):en.an(30,15,ec.pitch),em=ec._farZ-ec._nearZ,e_=eu*ec.height,ew=((1-ef)*ec.cameraToCenterDistance+ef*(ec._farZ+e_))*ed;return{shouldRenderCutoff:ef<1,uniformValues:{u_cutoff_params:[ec._nearZ,ec._farZ,(ew-ec._nearZ)/em,(ew-e_-ec._nearZ)/em]}}};function Si(en,el){return null!=en&&null!=el&&!(!en.hasData()||!el.hasData())&&null!=en.demTexture&&null!=el.demTexture&&en.tileID.key!==el.tileID.key}let eX=new class{constructor(){this.operations={}}newMorphing(en,el,eu,ec,ed){if(en in this.operations){let el=this.operations[en];el.to.tileID.key!==eu.tileID.key&&(el.queued=eu)}else this.operations[en]={startTime:ec,phase:0,duration:ed,from:el,to:eu,queued:null}}getMorphValuesForProxy(en){if(!(en in this.operations))return null;let el=this.operations[en];return{from:el.from,to:el.to,phase:el.phase}}update(en){for(let el in this.operations){let eu=this.operations[el];for(eu.phase=(en-eu.startTime)/eu.duration;eu.phase>=1||!this._validOp(eu);)if(!this._nextOp(eu,en)){delete this.operations[el];break}}}_nextOp(en,el){return!!en.queued&&(en.from=en.to,en.to=en.queued,en.queued=null,en.phase=0,en.startTime=el,!0)}_validOp(en){return en.from.hasData()&&en.to.hasData()}},eK={0:null,1:"TERRAIN_VERTEX_MORPHING"};function Pi(en,el,eu){return 0===el?0:6*Math.pow(1.5,22-en)*Math.max(el,1)*(el<1&&514===eu?.25/el:1)}let Ai=en=>({u_matrix:en});function Ri(el,eu,ec,ed,ef){if(ef>0){let em=en.a4.now(),e_=(em-el.timeAdded)/ef,ew=eu?(em-eu.timeAdded)/ef:-1,eT=ec.getSource(),eM=ed.coveringZoomLevel({tileSize:eT.tileSize,roundZoom:eT.roundZoom}),eE=!eu||Math.abs(eu.tileID.overscaledZ-eM)>Math.abs(el.tileID.overscaledZ-eM),eS=eE&&el.refreshedUponExpiration?1:en.c(eE?e_:1-ew,0,1);return el.refreshedUponExpiration&&e_>=1&&(el.refreshedUponExpiration=!1),eu?{opacity:1,mix:1-eS}:{opacity:eS,mix:0}}return{opacity:1,mix:0}}let zi=class zi extends en.bq{constructor(el){let eu={type:"raster-dem",maxzoom:el.transform.maxZoom},ec=new en.br(en.bs(),null),ed=st("mock-dem",eu,ec,el.style);super("mock-dem",ed,!1),ed.setEventedParent(this),this._sourceLoaded=!0}_loadTile(en,el){en.state="loaded",el(null)}};let Oi=class Oi extends en.bq{constructor(el){let eu=st("proxy",{type:"geojson",maxzoom:el.transform.maxZoom},new en.br(en.bs(),null),el.style);super("proxy",eu,!1),eu.setEventedParent(this),this.map=this.getSource().map=el,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(el,eu,ec){if(el.freezeTileCoverage)return;this.transform=el;let ed=el.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((eu,ec)=>{if(eu[ec.key]="",!this._tiles[ec.key]){let eu=new en.bt(ec,this._source.tileSize*ec.overscaleFactor(),el.tileZoom);eu.state="loaded",this._tiles[ec.key]=eu}return eu},{});for(let en in this._tiles)en in ed||(this.freeFBO(en),this._tiles[en].unloadVectorData(),delete this._tiles[en])}freeFBO(en){let el=this.proxyCachedFBO[en];if(void 0!==el){let eu=Object.values(el);this.renderCachePool.push(...eu),delete this.proxyCachedFBO[en]}}deallocRenderCache(){this.renderCache.forEach(en=>en.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}};let Fi=class Fi extends en.O{constructor(en,el,eu){super(en.overscaledZ,en.wrap,en.canonical.z,en.canonical.x,en.canonical.y),this.proxyTileKey=el,this.projMatrix=eu}};let Bi=class Bi extends en.bk{constructor(el,eu){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},el.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),el.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),el.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=el,this.terrainTileForTile={},this.prevTerrainTileForTile={};let[ec,ed,ef]=function(el){let eu=new en.bo,ec=new en.bp;eu.reserve(17161),ec.reserve(33800);let ed=en.J/128,ef=en.J+ed/2,em=ef+ed;for(let el=-ed;el<em;el+=ed)for(let ec=-ed;ec<em;ec+=ed){let ed=ec<0||ec>ef||el<0||el>ef?24575:0,em=en.c(Math.round(ec),0,en.J),e_=en.c(Math.round(el),0,en.J);eu.emplaceBack(em+ed,e_)}let l=(en,el)=>{let eu=131*el+en;ec.emplaceBack(eu+1,eu,eu+131),ec.emplaceBack(eu+131,eu+131+1,eu+1)};for(let en=1;en<129;en++)for(let el=1;el<129;el++)l(el,en);return[0,129].forEach(en=>{for(let el=0;el<130;el++)l(el,en),l(en,el)}),[eu,ec,32768]}(),em=el.context;this.gridBuffer=em.createVertexBuffer(ec,en.bl.members),this.gridIndexBuffer=em.createIndexBuffer(ed),this.gridSegments=en.bm.simpleSegment(0,0,ec.length,ed.length),this.gridNoSkirtSegments=en.bm.simpleSegment(0,0,ec.length,ef),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new Oi(eu.map),this.orthoMatrix=en.m.create(),en.m.ortho(this.orthoMatrix,"globe"===this.painter.transform.projection.name?.015:0,en.J,0,en.J,0,1);let e_=em.gl;this._overlapStencilMode=new en.b6({func:e_.GEQUAL,mask:255},0,255,e_.KEEP,e_.KEEP,e_.REPLACE),this._previousZoom=el.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=eu,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new zi(eu.map),this._pendingGroundEffectLayers=[]}set style(en){en.on("data",this._onStyleDataEvent.bind(this)),this._style=en,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(el,eu,ec){if(el&&el.terrain){this._style!==el&&(this.style=el,this._evaluationZoom=void 0);let ed=el.terrain.properties,ef=0===el.terrain.drapeRenderMode,em=el.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=en.a4.now();let e_=el.terrain&&el.terrain.scope,ew=ed.get("source"),eT=ef?this._mockSourceCache:el.getSourceCache(ew,e_);if(!eT)return void en.X(`Couldn't find terrain source "${ew}".`);if(this.sourceCache=eT,this._exaggeration=em?this.calculateExaggeration(eu):ed.get("exaggeration"),!eu.projection.requiresDraping&&em&&0===this._exaggeration)return void this._disable();this.enabled=!0;let h=()=>{this.sourceCache.used&&en.X(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);let el=this.getScaledDemTileSize();this.sourceCache.update(eu,el,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,h(),this._initializing=!0),h(),eu.updateElevation(!0,ec),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(eu),this._emptyDEMTextureDirty=!0,this._previousZoom=eu.zoom}else this._disable()}calculateExaggeration(el){let eu=this._previousCameraAltitude,ec=el.getFreeCameraOptions().position.z/el.pixelsPerMeter*el.worldSize;this._previousCameraAltitude=ec;let ed=null!=eu?ec-eu:Number.MAX_VALUE;if(2>Math.abs(ed))return this._exaggeration;let ef=el.zoom,em=this._style.terrain;if(!this._previousUpdateTimestamp)return em.getExaggeration(ef);let e_=ef-this._previousZoom,ew=this._previousUpdateTimestamp,eT=ef;null!=this._evaluationZoom&&(Math.abs(ef-(eT=this._evaluationZoom))>.5&&(e_=.5*(ef-eT+e_)),e_*ed<0&&(eT+=e_)),this._evaluationZoom=eT;let eM=em.getExaggeration(eT),eE=eM===em.getExaggeration(Math.max(0,eT-.1));if(eE&&.01>Math.abs(eM-this._exaggeration))return eM;let eS=Math.min(.1,.00375*(this._updateTimestamp-ew));return(eE||eM<.1||1e-4>Math.abs(e_))&&(eS=Math.min(.2,4*eS)),en.n(this._exaggeration,eM,eS)}resetTileLookupCache(en){this._findCoveringTileCache[en]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(en){en.coord&&"source"===en.dataType?this._clearRenderCacheForTile(en.sourceCacheId,en.coord):"style"===en.dataType&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(let en in this._style._mergedSourceCaches)this._style._mergedSourceCaches[en].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach(en=>en.fb.destroy()),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this._exaggeration}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){let en=2*this.proxySourceCache.getSource().tileSize;return[en,en]}set useVertexMorphing(en){this._useVertexMorphing=en}updateTileBinding(el){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;let eu=this.proxySourceCache,ec=this.painter.transform;this._initializing&&(this._initializing=0===ec._centerAltitude&&-1===this.getAtPointOrZero(en.M.fromLngLat(ec.center),-1),this._emptyDEMTextureDirty=!this._initializing);let ed=this.proxyCoords=eu.getIds().map(en=>{let el=eu.getTileByID(en).tileID;return el.projMatrix=ec.calculateProjMatrix(el.toUnwrapped()),el});!function(el,eu){let ec=eu.transform.pointCoordinate(eu.transform.getCameraPoint()),ed=new en.P(ec.x,ec.y);el.sort((el,eu)=>{if(eu.overscaledZ-el.overscaledZ)return eu.overscaledZ-el.overscaledZ;let ec=new en.P(el.canonical.x+(1<<el.canonical.z)*el.wrap,el.canonical.y),ef=new en.P(eu.canonical.x+(1<<eu.canonical.z)*eu.wrap,eu.canonical.y),em=ed.mult(1<<el.canonical.z);return em.x-=.5,em.y-=.5,em.distSqr(ec)-em.distSqr(ef)})}(ed,this.painter);let ef=this.proxyToSource||{};this.proxyToSource={},ed.forEach(en=>{this.proxyToSource[en.key]={}}),this.terrainTileForTile={};let em=this._style._mergedSourceCaches;for(let en in em){let eu=em[en];if(!eu.used||(eu!==this.sourceCache&&this.resetTileLookupCache(eu.id),this._setupProxiedCoordsForOrtho(eu,el[en],ef),eu.usedForTerrain))continue;let ec=el[en];eu.getSource().reparseOverscaled&&this._assignTerrainTiles(ec)}this.proxiedCoords[eu.id]=ed.map(en=>new Fi(en,en.key,this.orthoMatrix)),this._assignTerrainTiles(ed),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(ef),this.renderingToTexture=!1;let e_={};for(let en of(this._visibleDemTiles=[],this.proxyCoords)){let el=this.terrainTileForTile[en.key];if(!el)continue;let eu=el.tileID.key;eu in e_||(this._visibleDemTiles.push(el),e_[eu]=eu)}}_assignTerrainTiles(en){this._initializing||en.forEach(en=>{if(this.terrainTileForTile[en.key])return;let el=this._findTileCoveringTileID(en,this.sourceCache);el&&(this.terrainTileForTile[en.key]=el)})}_prepareDEMTextures(){let en=this.painter.context,el=en.gl;for(let eu in this.terrainTileForTile){let ec=this.terrainTileForTile[eu],ed=ec.dem;ed&&(!ec.demTexture||ec.needsDEMTextureUpload)&&(en.activeTexture.set(el.TEXTURE1),bi(this.painter,ec,ed))}}_prepareDemTileUniforms(en,el,eu,ec){if(!el||null==el.demTexture)return!1;let ed=en.tileID.canonical,ef=Math.pow(2,el.tileID.canonical.z-ed.z),em=ec||"";return eu[`u_dem_tl${em}`]=[ed.x*ef%1,ed.y*ef%1],eu[`u_dem_scale${em}`]=ef,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}get emptyDepthBufferTexture(){let el=this.painter.context,eu=el.gl;if(!this._emptyDepthBufferTexture){let ec=new en.a5({width:1,height:1},Uint8Array.of(255,255,255,255));this._emptyDepthBufferTexture=new en.a9(el,ec,eu.RGBA,{premultiply:!1})}return this._emptyDepthBufferTexture}_getLoadedAreaMinimum(){let en=0,el=this._visibleDemTiles.reduce((el,eu)=>{if(!eu.dem)return el;let ec=eu.dem.tree.minimums[0];return ec>0&&en++,el+ec},0);return en?el/en:0}_updateEmptyDEMTexture(){let el=this.painter.context,eu=el.gl;el.activeTexture.set(eu.TEXTURE2);let ec=this._getLoadedAreaMinimum(),[ed,ef]=(()=>{let el=new en.bu({width:1,height:1},new Float32Array([ec]));return[eu.R32F,el]})();this._emptyDEMTextureDirty=!1;let em=this._emptyDEMTexture;return em?em.update(ef,{premultiply:!1}):em=this._emptyDEMTexture=new en.a9(el,ef,ed,{premultiply:!1}),em}setupElevationDraw(el,eu,ec){let ed=this.painter.context,ef=ed.gl,em={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_exaggeration:0};em.u_exaggeration=this.exaggeration();let e_=null,ew=null,eT=1;if(ec&&ec.morphing&&this._useVertexMorphing){let en=ec.morphing.srcDemTile,eu=ec.morphing.dstDemTile;eT=ec.morphing.phase,en&&eu&&(this._prepareDemTileUniforms(el,en,em,"_prev")&&(ew=en),this._prepareDemTileUniforms(el,eu,em)&&(e_=eu))}let h=en=>en&&en.demTexture&&this.painter.linearFloatFilteringSupported()?ef.LINEAR:ef.NEAREST,_=en=>{em.u_dem_size=1===en.size[0]?1:en.size[0]-2};if(ew&&e_)ed.activeTexture.set(ef.TEXTURE2),e_.demTexture.bind(h(e_),ef.CLAMP_TO_EDGE),ed.activeTexture.set(ef.TEXTURE4),ew.demTexture.bind(h(ew),ef.CLAMP_TO_EDGE),e_.demTexture&&_(e_.demTexture),em.u_dem_lerp=eT;else{e_=this.terrainTileForTile[el.tileID.key],ed.activeTexture.set(ef.TEXTURE2);let en=this._prepareDemTileUniforms(el,e_,em)?e_.demTexture:this.emptyDEMTexture;en.bind(h(e_),ef.CLAMP_TO_EDGE),_(en)}if(ed.activeTexture.set(ef.TEXTURE3),ec&&ec.useDepthForOcclusion?(this._depthTexture&&this._depthTexture.bind(ef.NEAREST,ef.CLAMP_TO_EDGE),this._depthFBO&&(em.u_depth_size_inv=[1/this._depthFBO.width,1/this._depthFBO.height])):(this.emptyDepthBufferTexture.bind(ef.NEAREST,ef.CLAMP_TO_EDGE),em.u_depth_size_inv=[1,1]),ec&&ec.useMeterToDem&&e_){let el=(1<<e_.tileID.canonical.z)*en.b(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;em.u_meter_to_dem=el}if(ec&&ec.labelPlaneMatrixInv&&(em.u_label_plane_matrix_inv=ec.labelPlaneMatrixInv),eu.setTerrainUniformValues(ed,em),"globe"===this.painter.transform.projection.name){let en=this.globeUniformValues(this.painter.transform,el.tileID.canonical,ec&&ec.useDenormalizedUpVectorScale);eu.setGlobeUniformValues(ed,en)}}globeUniformValues(el,eu,ec){let ed=el.projection;return{u_tile_tl_up:ed.upVector(eu,0,0),u_tile_tr_up:ed.upVector(eu,en.J,0),u_tile_br_up:ed.upVector(eu,en.J,en.J),u_tile_bl_up:ed.upVector(eu,0,en.J),u_tile_up_scale:ec?en.bn(1):ed.upVectorScale(eu,el.center.lat,el.worldSize).metersToTile}}renderToBackBuffer(el){let eu=this.painter,ec=this.painter.context;0!==el.length&&(ec.bindFramebuffer.set(null),ec.viewport.set([0,0,eu.width,eu.height]),eu.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(el,eu,ec,ed,ef){if("globe"===el.transform.projection.name)!function(el,eu,ec,ed,ef){let em,e_;let ew=el.context,eT=ew.gl,eM=el.transform,eE=en.bb(el,ew,eM),d=(en,eu)=>{if(e_===eu)return;let ec=[eK[eu],"PROJECTION_GLOBE_VIEW"];eE&&ec.push("CUSTOM_ANTIALIASING");let ed=el.isTileAffectedByFog(en);em=el.getOrCreateProgram("globeRaster",{defines:ec,overrideFog:ed}),e_=eu},eS=el.colorModeForRenderPass(),eA=new en.b4(eT.LEQUAL,en.b4.ReadWrite,el.depthRangeFor3D);eX.update(ef);let eI=en.bc(eM),eC=[en.E(eM.center.lng),en.H(eM.center.lat)],eP=el.globeSharedBuffers,ez=[eM.width*en.a4.devicePixelRatio,eM.height*en.a4.devicePixelRatio],eD=Float32Array.from(eM.globeMatrix),eL={useDenormalizedUpVectorScale:!0};{let eM=el.transform,eE=Pi(eM.zoom,eu.exaggeration(),eu.sourceCache._source.tileSize);e_=-1;let ek=eT.TRIANGLES;for(let e_ of ed){let ed=ec.getTile(e_),eR=en.b6.disabled,eO=eu.prevTerrainTileForTile[e_.key],eB=eu.terrainTileForTile[e_.key];Si(eO,eB)&&eX.newMorphing(e_.key,eO,eB,ef,250),ew.activeTexture.set(eT.TEXTURE0),ed.texture&&ed.texture.bind(eT.LINEAR,eT.CLAMP_TO_EDGE);let eF=eX.getMorphValuesForProxy(e_.key),eN=eF?1:0;eF&&en.bd(eL,{morphing:{srcDemTile:eF.from,dstDemTile:eF.to,phase:en.ba(eF.phase)}});let eU=en.be(e_.canonical),eV=en.bf(eU.getCenter().lat),ej=en.bg(e_.canonical,eU,eV,eM.worldSize/eM._pixelsPerMercatorPixel),eG=en.bh(en.bi(e_.canonical)),eq=Ci(eM.expandedFarZProjMatrix,eD,eI,eG,en.ao(eM.zoom),eC,eM.frustumCorners.TL,eM.frustumCorners.TR,eM.frustumCorners.BR,eM.frustumCorners.BL,eM.globeCenterInViewSpace,eM.globeRadius,ez,eE,ej);if(d(e_,eN),em&&(eu.setupElevationDraw(ed,em,eL),el.uploadCommonUniforms(ew,em,e_.toUnwrapped()),eP)){let[eu,ec,ed]=eP.getGridBuffers(eV,0!==eE);em.draw(el,ek,eA,eR,eS,en.b5.backCCW,eq,"globe_raster",eu,ec,ed)}}}if(eP&&(el.renderDefaultNorthPole||el.renderDefaultSouthPole)){let ef=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];for(let e_ of(eE&&ef.push("CUSTOM_ANTIALIASING"),em=el.getOrCreateProgram("globeRaster",{defines:ef}),ed)){let{x:ed,y:ef,z:eE}=e_.canonical,eI=0===ef,eD=ef===(1<<eE)-1,[ek,eR,eO,eB]=eP.getPoleBuffers(eE,!1);if(eB&&(eI||eD)){let ef=ec.getTile(e_);ew.activeTexture.set(eT.TEXTURE0),ef.texture&&ef.texture.bind(eT.LINEAR,eT.CLAMP_TO_EDGE);let eP=en.bj(eE,ed,eM),eF=en.bh(en.bi(e_.canonical)),C=(eu,ec)=>eu.draw(el,eT.TRIANGLES,eA,en.b6.disabled,eS,en.b5.disabled,Ci(eM.expandedFarZProjMatrix,eP,eP,eF,0,eC,eM.frustumCorners.TL,eM.frustumCorners.TR,eM.frustumCorners.BR,eM.frustumCorners.BL,eM.globeCenterInViewSpace,eM.globeRadius,ez,0),"globe_pole_raster",ec,eO,eB);eu.setupElevationDraw(ef,em,eL),el.uploadCommonUniforms(ew,em,e_.toUnwrapped()),eI&&el.renderDefaultNorthPole&&C(em,ek),eD&&el.renderDefaultSouthPole&&(eP=en.m.scale(en.m.create(),eP,[1,-1,1]),C(em,eR))}}}}(el,eu,ec,ed,ef);else{let em,e_;let ew=el.context,eT=ew.gl,eM=el.shadowRenderer,eE=Ii(el,el.longestCutoffRange),d=en=>{if(e_===en)return;let eu=[];eu.push(eK[en]),eE.shouldRenderCutoff&&eu.push("RENDER_CUTOFF"),em=el.getOrCreateProgram("terrainRaster",{defines:eu}),e_=en},eS=el.colorModeForRenderPass(),eA=new en.b4(eT.LEQUAL,en.b4.ReadWrite,el.depthRangeFor3D);eX.update(ef);let eI=el.transform,eC=Pi(eI.zoom,eu.exaggeration(),eu.sourceCache._source.tileSize),eP=[0,0,0];if(eM){let en=el.style.directionalLight,eu=el.style.ambientLight;en&&eu&&(eP=wr(en,eu))}{e_=-1;let ez=eT.TRIANGLES,[eD,eL]=[eu.gridIndexBuffer,eu.gridSegments];for(let e_ of ed){let ed;let ek=ec.getTile(e_),eR=en.b6.disabled,eO=eu.prevTerrainTileForTile[e_.key],eB=eu.terrainTileForTile[e_.key];Si(eO,eB)&&eX.newMorphing(e_.key,eO,eB,ef,250),ew.activeTexture.set(eT.TEXTURE0),ek.texture&&ek.texture.bind(eT.LINEAR,eT.CLAMP_TO_EDGE);let eF=eX.getMorphValuesForProxy(e_.key),eN=eF?1:0;eF&&(ed={morphing:{srcDemTile:eF.from,dstDemTile:eF.to,phase:en.ba(eF.phase)}});let eU=Ei(e_.projMatrix,!function(en,el){let eu=1<<en.z;return!el&&(0===en.x||en.x===eu-1)||0===en.y||en.y===eu-1}(e_.canonical,eI.renderWorldCopies)?eC:eC/10,eP);if(d(eN),!em)continue;eu.setupElevationDraw(ek,em,ed);let eV=e_.toUnwrapped();eM&&eM.setupShadows(eV,em),el.uploadCommonUniforms(ew,em,eV,null,eE),em.draw(el,ez,eA,eR,eS,en.b5.backCCW,eU,"terrain_raster",eu.gridBuffer,eD,eL)}}}}(eu,this,this.proxySourceCache,el,this._updateTimestamp),this.renderingToTexture=!0,eu.gpuTimingDeferredRenderEnd(),el.splice(0,el.length))}renderBatch(el){if(0===this._drapedRenderBatches.length)return el+1;this.renderingToTexture=!0;let eu=this.painter,ec=this.painter.context,ed=this.proxySourceCache,ef=this.proxiedCoords[ed.id],em=this._drapedRenderBatches.shift(),e_=eu.style.order,ew=[],eT=0;for(let eM of ef){let ef;let eE=ed.getTileByID(eM.proxyTileKey),eS=ed.proxyCachedFBO[eM.key]?ed.proxyCachedFBO[eM.key][el]:void 0,eA=void 0!==eS?ed.renderCache[eS]:this.pool[eT++],eI=void 0!==eS;if(eE.texture=eA.tex,eI&&!eA.dirty){ew.push(eE.tileID);continue}ec.bindFramebuffer.set(eA.fb.framebuffer),this.renderedToTile=!1,eA.dirty&&(ec.clear({color:en.C.transparent,stencil:0}),eA.dirty=!1);for(let en=em.start;en<=em.end;++en){let el=eu.style._mergedLayers[e_[en]];if(el.isHidden(eu.transform.zoom))continue;let ed=eu.style.getLayerSourceCache(el),em=ed?this.proxyToSource[eM.key][ed.id]:[eM];em&&(ec.viewport.set([0,0,eA.fb.width,eA.fb.height]),ef!==(ed?ed.id:null)&&(this._setupStencil(eA,em,el,ed),ef=ed?ed.id:null),eu.renderLayer(eu,ed,el,em))}if(0===this._drapedRenderBatches.length)for(let en of this._pendingGroundEffectLayers){let el=eu.style._mergedLayers[e_[en]];if(el.isHidden(eu.transform.zoom))continue;let ed=eu.style.getLayerSourceCache(el),em=ed?this.proxyToSource[eM.key][ed.id]:[eM];em&&(ec.viewport.set([0,0,eA.fb.width,eA.fb.height]),ef!==(ed?ed.id:null)&&(this._setupStencil(eA,em,el,ed),ef=ed?ed.id:null),eu.renderLayer(eu,ed,el,em))}this.renderedToTile?(eA.dirty=!0,ew.push(eE.tileID)):eI||--eT,5===eT&&(eT=0,this.renderToBackBuffer(ew))}return this.renderToBackBuffer(ew),this.renderingToTexture=!1,ec.bindFramebuffer.set(null),ec.viewport.set([0,0,eu.width,eu.height]),em.end+1}postRender(){}isLayerOrderingCorrect(en){let el=en.order.length,eu=-1,ec=el;for(let ed=0;ed<el;++ed)this._style.isLayerDraped(en._mergedLayers[en.order[ed]])?eu=Math.max(eu,ed):ec=Math.min(ec,ed);return ec>eu}getMinElevationBelowMSL(){let en=0;return this._visibleDemTiles.filter(en=>en.dem).forEach(el=>{en=Math.min(en,el.dem.tree.minimums[0])}),0===en?en:(en-30)*this._exaggeration}raycast(en,el,eu){if(!this._visibleDemTiles)return null;let ec=this._visibleDemTiles.filter(en=>en.dem).map(ec=>{let ed=ec.tileID,ef=1<<ed.overscaledZ,{x:em,y:e_}=ed.canonical,ew=em/ef,eT=(em+1)/ef,eM=e_/ef,eE=(e_+1)/ef;return{minx:ew,miny:eM,maxx:eT,maxy:eE,t:ec.dem.tree.raycastRoot(ew,eM,eT,eE,en,el,eu),tile:ec}});for(let ed of(ec.sort((en,el)=>(null!==en.t?en.t:Number.MAX_VALUE)-(null!==el.t?el.t:Number.MAX_VALUE)),ec)){if(null==ed.t)break;let ec=ed.tile.dem.tree.raycast(ed.minx,ed.miny,ed.maxx,ed.maxy,en,el,eu);if(null!=ec)return ec}return null}_createFBO(){let el=this.painter.context,eu=el.gl,ec=this.drapeBufferSize;el.activeTexture.set(eu.TEXTURE0);let ed=new en.a9(el,{width:ec[0],height:ec[1],data:null},eu.RGBA);ed.bind(eu.LINEAR,eu.CLAMP_TO_EDGE);let ef=el.createFramebuffer(ec[0],ec[1],!0,null);return ef.colorAttachment.set(ed.texture),ef.depthAttachment=new oe(el,ef.framebuffer),void 0===this._sharedDepthStencil?(this._sharedDepthStencil=el.createRenderbuffer(el.gl.DEPTH_STENCIL,ec[0],ec[1]),this._stencilRef=0,ef.depthAttachment.set(this._sharedDepthStencil),el.clear({stencil:0})):ef.depthAttachment.set(this._sharedDepthStencil),el.extTextureFilterAnisotropic&&eu.texParameterf(eu.TEXTURE_2D,el.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,el.extTextureFilterAnisotropicMax),{fb:ef,tex:ed,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(let en in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[en].hasTransition())return!0;return this._style.order.some(en=>{let el=this._style._mergedLayers[en],eu=el.isHidden(this.painter.transform.zoom);return"custom"===el.type?!eu&&el.shouldRedrape():!eu&&el.hasTransition()})}_clearLineLayersFromRenderCache(){let el=!1;for(let en of this._style.getSources())if(en instanceof it){el=!0;break}if(!el)return;let eu={};for(let el=0;el<this._style.order.length;++el){let ec=this._style._mergedLayers[this._style.order[el]],ed=this._style.getLayerSourceCache(ec);if(ed&&!eu[ed.id]&&!ec.isHidden(this.painter.transform.zoom)&&"line"===ec.type&&ec.widthExpression() instanceof en.am)for(let en of(eu[ed.id]=!0,this.proxyCoords)){let el=this.proxyToSource[en.key][ed.id];if(el)for(let en of el)this._clearRenderCacheForTile(ed.id,en)}}}_clearRasterLayersFromRenderCache(){let en=!1;for(let el in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[el]._source instanceof ot){en=!0;break}if(!en)return;let el={};for(let en=0;en<this._style.order.length;++en){let eu=this._style._mergedLayers[this._style.order[en]],ec=this._style.getLayerSourceCache(eu);if(!ec||el[ec.id]||eu.isHidden(this.painter.transform.zoom)||"raster"!==eu.type)continue;let ed=eu.paint.get("raster-fade-duration");for(let en of this.proxyCoords){let el=this.proxyToSource[en.key][ec.id];if(el)for(let en of el){let el=Ri(ec.getTile(en),ec.findLoadedParent(en,0),ec,this.painter.transform,ed);(1!==el.opacity||0!==el.mix)&&this._clearRenderCacheForTile(ec.id,en)}}}}_setupDrapedRenderBatches(){let el=this._style.order,eu=el.length;if(0===eu)return;let ec=[];this._pendingGroundEffectLayers=[];let ed,ef=0,em=this._style._mergedLayers[el[ef]];for(;!this._style.isLayerDraped(em)&&em.isHidden(this.painter.transform.zoom)&&++ef<eu;)em=this._style._mergedLayers[el[ef]];for(;ef<eu;++ef){let en=this._style._mergedLayers[el[ef]];en.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(en)?void 0===ed&&(ed=ef):("fill-extrusion"===en.type&&this._pendingGroundEffectLayers.push(ef),void 0!==ed&&(ec.push({start:ed,end:ef-1}),ed=void 0)))}if(void 0!==ed&&ec.push({start:ed,end:ef-1}),0!==ec.length){let el=ec[ec.length-1];this._pendingGroundEffectLayers.every(en=>en>el.end)||en.X("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=ec}_setupRenderCache(en){let el=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,el.renderCache.length>el.renderCachePool.length){let en=Object.values(el.proxyCachedFBO);el.proxyCachedFBO={};for(let eu=0;eu<en.length;++eu){let ec=Object.values(en[eu]);el.renderCachePool.push(...ec)}}return}this._clearRasterLayersFromRenderCache();let eu=this.proxyCoords,ec=this._tilesDirty;for(let ed=eu.length-1;ed>=0;ed--){let ef=eu[ed];if(el.getTileByID(ef.key),void 0!==el.proxyCachedFBO[ef.key]){let eu=en[ef.key],ed=this.proxyToSource[ef.key],em=0;for(let en in ed){let el=ed[en],ef=eu[en];if(!ef||ef.length!==el.length||el.some((el,eu)=>el!==ef[eu]||ec[en]&&ec[en].hasOwnProperty(el.key))){em=-1;break}++em}for(let en in el.proxyCachedFBO[ef.key])el.renderCache[el.proxyCachedFBO[ef.key][en]].dirty=em<0||em!==Object.values(eu).length}}let ed=[...this._drapedRenderBatches];for(let en of(ed.sort((en,el)=>el.end-el.start-(en.end-en.start)),ed))for(let ec of eu){if(el.proxyCachedFBO[ec.key])continue;let eu=el.renderCachePool.pop();void 0===eu&&el.renderCache.length<50&&(eu=el.renderCache.length,el.renderCache.push(this._createFBO())),void 0!==eu&&(el.proxyCachedFBO[ec.key]={},el.proxyCachedFBO[ec.key][en.start]=eu,el.renderCache[eu].dirty=!0)}this._tilesDirty={}}_setupStencil(en,el,eu,ec){let ed;if(!ec||!this._sourceTilesOverlap[ec.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));let ef=this.painter.context,em=ef.gl;if(el.length<=1)return void(this._overlapStencilType=!1);if(eu.isTileClipped())ed=el.length,this._overlapStencilMode.test={func:em.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(el[0].overscaledZ>el[el.length-1].overscaledZ))return void(this._overlapStencilType=!1);ed=1,this._overlapStencilMode.test={func:em.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+ed>255&&(ef.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=ed,this._overlapStencilMode.ref=this._stencilRef,eu.isTileClipped()&&this._renderTileClippingMasks(el,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return"Clip"===this._overlapStencilType||"Mask"===this._overlapStencilType}stencilModeForRTTOverlap(el){return this.renderingToTexture&&this._overlapStencilType?("Clip"===this._overlapStencilType&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[el.key]),this._overlapStencilMode):en.b6.disabled}_renderTileClippingMasks(el,eu){let ec=this.painter,ed=this.painter.context,ef=ed.gl;ec._tileClippingMaskIDs={},ed.setColorMode(en.a.disabled),ed.setDepthMode(en.b4.disabled);let em=ec.getOrCreateProgram("clippingMask");for(let ed of el){let el=ec._tileClippingMaskIDs[ed.key]=--eu;em.draw(ec,ef.TRIANGLES,en.b4.disabled,new en.b6({func:ef.ALWAYS,mask:0},el,255,ef.KEEP,ef.KEEP,ef.REPLACE),en.a.disabled,en.b5.disabled,Ai(ed.projMatrix),"$clipping",ec.tileExtentBuffer,ec.quadTriangleIndexBuffer,ec.tileExtentSegments)}}pointCoordinate(el){let eu=this.painter.transform;if(el.x<0||el.x>eu.width||el.y<0||el.y>eu.height)return null;let ec=[el.x,el.y,1,1];en.e.transformMat4(ec,ec,eu.pixelMatrixInverse),en.e.scale(ec,ec,1/ec[3]),ec[0]/=eu.worldSize,ec[1]/=eu.worldSize;let ed=eu._camera.position,ef=en.b(1,eu.center.lat),em=[ed[0],ed[1],ed[2]/ef,0],e_=en.v.subtract([],ec.slice(0,3),em);en.v.normalize(e_,e_);let ew=this.raycast(em,e_,this._exaggeration);return null!==ew&&ew?(en.v.scaleAndAdd(em,em,e_,ew),em[3]=em[2],em[2]*=ef,em):null}drawDepth(){let el=this.painter,eu=el.context,ec=this.proxySourceCache,ed=Math.ceil(el.width),ef=Math.ceil(el.height);if(this._depthFBO&&(this._depthFBO.width!==ed||this._depthFBO.height!==ef)&&(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),!this._depthFBO){let el=eu.gl,ec=eu.createFramebuffer(ed,ef,!0,"renderbuffer");eu.activeTexture.set(el.TEXTURE0);let em=new en.a9(eu,{width:ed,height:ef,data:null},el.RGBA);em.bind(el.NEAREST,el.CLAMP_TO_EDGE),ec.colorAttachment.set(em.texture);let e_=eu.createRenderbuffer(eu.gl.DEPTH_COMPONENT16,ed,ef);ec.depthAttachment.set(e_),this._depthFBO=ec,this._depthTexture=em}eu.bindFramebuffer.set(this._depthFBO.framebuffer),eu.viewport.set([0,0,ed,ef]),function(el,eu,ec,ed){if("globe"===el.transform.projection.name)return;let ef=el.context,em=ef.gl;ef.clear({depth:1});let e_=el.getOrCreateProgram("terrainDepth"),ew=new en.b4(em.LESS,en.b4.ReadWrite,el.depthRangeFor3D);for(let ef of ed){let ed=ec.getTile(ef),eT=Ei(ef.projMatrix,0,[0,0,0]);eu.setupElevationDraw(ed,e_),e_.draw(el,em.TRIANGLES,ew,en.b6.disabled,en.a.unblended,en.b5.backCCW,eT,"terrain_depth",eu.gridBuffer,eu.gridIndexBuffer,eu.gridNoSkirtSegments)}}(el,this,ec,this.proxyCoords)}_setupProxiedCoordsForOrtho(el,eu,ec){if(el.getSource() instanceof en.aK)return this._setupProxiedCoordsForImageSource(el,eu,ec);this._findCoveringTileCache[el.id]=this._findCoveringTileCache[el.id]||{};let ed=this.proxiedCoords[el.id]=[],ef=this.proxyCoords;for(let en=0;en<ef.length;en++){let eu=ef[en],em=this._findTileCoveringTileID(eu,el);if(em){let en=this._createProxiedId(eu,em,ec[eu.key]&&ec[eu.key][el.id]);ed.push(en),this.proxyToSource[eu.key][el.id]=[en]}}let em=!1,e_=new Set;for(let en=0;en<eu.length;en++){let ef=el.getTile(eu[en]);if(!ef||!ef.hasData())continue;let ew=this._findTileCoveringTileID(ef.tileID,this.proxySourceCache);if(ew&&ew.tileID.canonical.z!==ef.tileID.canonical.z){let en=this.proxyToSource[ew.tileID.key][el.id],eu=this._createProxiedId(ew.tileID,ef,ec[ew.tileID.key]&&ec[ew.tileID.key][el.id]);en?en.splice(en.length-1,0,eu):this.proxyToSource[ew.tileID.key][el.id]=[eu];let eT=this.proxyToSource[ew.tileID.key][el.id];e_.has(eT)||e_.add(eT),ed.push(eu),em=!0}}if(this._sourceTilesOverlap[el.id]=em,em&&this._debugParams.sortTilesHiZFirst)for(let en of e_)en.sort((en,el)=>el.overscaledZ-en.overscaledZ)}_setupProxiedCoordsForImageSource(el,eu,ec){if(!el.getSource().loaded())return;let ed=this.proxiedCoords[el.id]=[],ef=this.proxyCoords,em=el.getSource(),e_=em.tileID;if(!e_)return;let ew=new en.P(e_.x,e_.y)._div(1<<e_.z),eT=em.coordinates.map(en.M.fromLngLat).reduce((en,el)=>(en.min.x=Math.min(en.min.x,el.x-ew.x),en.min.y=Math.min(en.min.y,el.y-ew.y),en.max.x=Math.max(en.max.x,el.x-ew.x),en.max.y=Math.max(en.max.y,el.y-ew.y),en),{min:new en.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new en.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),h=(el,eu)=>{let ec=el.wrap+el.canonical.x/(1<<el.canonical.z),ed=el.canonical.y/(1<<el.canonical.z),ef=en.J/(1<<el.canonical.z),em=eu.wrap+eu.canonical.x/(1<<eu.canonical.z),e_=eu.canonical.y/(1<<eu.canonical.z);return ec+ef<em+eT.min.x||ec>em+eT.max.x||ed+ef<e_+eT.min.y||ed>e_+eT.max.y};for(let en=0;en<ef.length;en++){let em=ef[en];for(let en=0;en<eu.length;en++){let ef=el.getTile(eu[en]);if(!ef||!ef.hasData()||h(em,ef.tileID))continue;let e_=this._createProxiedId(em,ef,ec[em.key]&&ec[em.key][el.id]),ew=this.proxyToSource[em.key][el.id];ew?ew.push(e_):this.proxyToSource[em.key][el.id]=[e_],ed.push(e_)}}}_createProxiedId(el,eu,ec){let ed=this.orthoMatrix;if(ec){let en=ec.find(en=>en.key===eu.tileID.key);if(en)return en}if(eu.tileID.key!==el.key){let ec,ef,em;let e_=el.canonical.z-eu.tileID.canonical.z;ed=en.m.create();let ew=eu.tileID.wrap-el.wrap<<el.overscaledZ;e_>0?(ef=(ec=en.J>>e_)*((eu.tileID.canonical.x<<e_)-el.canonical.x+ew),em=ec*((eu.tileID.canonical.y<<e_)-el.canonical.y)):(ec=en.J<<-e_,ef=en.J*(eu.tileID.canonical.x-(el.canonical.x+ew<<-e_)),em=en.J*(eu.tileID.canonical.y-(el.canonical.y<<-e_))),en.m.ortho(ed,0,ec,0,ec,0,1),en.m.translate(ed,ed,[ef,em,0])}return new Fi(eu.tileID,el.key,ed)}_findTileCoveringTileID(el,eu){let ec=eu.getTile(el);if(ec&&ec.hasData())return ec;let ed=this._findCoveringTileCache[eu.id],ef=ed[el.key];if((ec=ef?eu.getTileByID(ef):null)&&ec.hasData()||null===ef)return ec;let em=ec?ec.tileID:el,e_=em.overscaledZ,ew=eu.getSource().minzoom,eT=[];if(!ef){let ed=eu.getSource().maxzoom;if(el.canonical.z>=ed){let ec=el.canonical.z-ed;eu.getSource().reparseOverscaled?(e_=Math.max(el.canonical.z+2,eu.transform.tileZoom),em=new en.O(e_,el.wrap,ed,el.canonical.x>>ec,el.canonical.y>>ec)):0!==ec&&(e_=ed,em=new en.O(e_,el.wrap,ed,el.canonical.x>>ec,el.canonical.y>>ec))}em.key!==el.key&&(eT.push(em.key),ec=eu.getTile(em))}let h=en=>{eT.forEach(el=>{ed[el]=en}),eT.length=0};for(e_-=1;e_>=ew&&(!ec||!ec.hasData());e_--){ec&&h(ec.tileID.key);let en=em.calculateScaledKey(e_);if((ec=eu.getTileByID(en))&&ec.hasData())break;let el=ed[en];if(null===el)break;void 0===el?eT.push(en):ec=eu.getTileByID(el)}return h(ec?ec.tileID.key:null),ec&&ec.hasData()?ec:null}findDEMTileFor(en){return this.enabled?this._findTileCoveringTileID(en,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(en,el){let eu=this._tilesDirty[en];eu||(eu=this._tilesDirty[en]={}),eu[el.key]=!0}};let eJ=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],eY=["stars","fillExtrusion","fillExtrusionGroundEffect","model","symbolSDF","symbolIcon","symbolTextAndIcon"];let Gi=class Gi{static cacheKey(en,el,eu,ec){let ed=`${el}${ec?ec.cacheKey:""}`;for(let el of eu)en.usedDefines.includes(el)&&(ed+=`/${el}`);return ed}constructor(el,eu,ec,ed,ef,em){let e_=el.gl;this.program=e_.createProgram(),this.configuration=ed,this.name=eu,this.fixedDefines=[...em];let ew=ed?ed.getBinderAttributes():[],eT=(ec.staticAttributes||[]).concat(ew),eM=ed?ed.defines():[];eM=eM.concat(em.map(en=>`#define ${en}`));let eE="#version 300 es\n",eS=eE+eM.concat("precision mediump float;",ek,eW.fragmentSource).join("\n");for(let en of ec.fragmentIncludes)eS+=`
${eZ[en]}`;eS+=`
${ec.fragmentSource}`;let eA=eE+eM.concat("precision highp float;",ek,eW.vertexSource).join("\n");for(let en of ec.vertexIncludes)eA+=`
${eZ[en]}`;eA+=`
${ec.vertexSource}`;let eI=e_.createShader(e_.FRAGMENT_SHADER);if(e_.isContextLost())return void(this.failedToCreate=!0);e_.shaderSource(eI,eS),e_.compileShader(eI),e_.attachShader(this.program,eI);let eC=e_.createShader(e_.VERTEX_SHADER);if(e_.isContextLost())this.failedToCreate=!0;else{e_.shaderSource(eC,eA),e_.compileShader(eC),e_.attachShader(this.program,eC),this.attributes={},this.numAttributes=eT.length;for(let en=0;en<this.numAttributes;en++)if(eT[en]){let el=eT[en].startsWith("a_")?eT[en]:`a_${eT[en]}`;e_.bindAttribLocation(this.program,en,el),this.attributes[el]=en}e_.linkProgram(this.program),e_.deleteShader(eC),e_.deleteShader(eI),this.fixedUniforms=ef(el),this.binderUniforms=ed?ed.getUniforms(el):[],em.includes("TERRAIN")&&(this.terrainUniforms={u_dem:new en.a$(el),u_dem_prev:new en.a$(el),u_dem_tl:new en.b0(el),u_dem_scale:new en.b2(el),u_dem_tl_prev:new en.b0(el),u_dem_scale_prev:new en.b2(el),u_dem_size:new en.b2(el),u_dem_lerp:new en.b2(el),u_exaggeration:new en.b2(el),u_depth:new en.a$(el),u_depth_size_inv:new en.b0(el),u_meter_to_dem:new en.b2(el),u_label_plane_matrix_inv:new en.a_(el)}),em.includes("GLOBE")&&(this.globeUniforms={u_tile_tl_up:new en.b7(el),u_tile_tr_up:new en.b7(el),u_tile_br_up:new en.b7(el),u_tile_bl_up:new en.b7(el),u_tile_up_scale:new en.b2(el)}),em.includes("FOG")&&(this.fogUniforms={u_fog_matrix:new en.a_(el),u_fog_range:new en.b0(el),u_fog_color:new en.b9(el),u_fog_horizon_blend:new en.b2(el),u_fog_vertical_limit:new en.b0(el),u_fog_temporal_offset:new en.b2(el),u_frustum_tl:new en.b7(el),u_frustum_tr:new en.b7(el),u_frustum_br:new en.b7(el),u_frustum_bl:new en.b7(el),u_globe_pos:new en.b7(el),u_globe_radius:new en.b2(el),u_globe_transition:new en.b2(el),u_is_globe:new en.a$(el),u_viewport:new en.b0(el)}),em.includes("RENDER_CUTOFF")&&(this.cutoffUniforms={u_cutoff_params:new en.b9(el)}),em.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms={u_lighting_ambient_color:new en.b7(el),u_lighting_directional_dir:new en.b7(el),u_lighting_directional_color:new en.b7(el),u_ground_radiance:new en.b7(el)}),em.includes("RENDER_SHADOWS")&&(this.shadowUniforms={u_light_matrix_0:new en.a_(el),u_light_matrix_1:new en.a_(el),u_fade_range:new en.b0(el),u_shadow_normal_offset:new en.b7(el),u_shadow_intensity:new en.b2(el),u_shadow_texel_size:new en.b2(el),u_shadow_map_resolution:new en.b2(el),u_shadow_direction:new en.b7(el),u_shadow_bias:new en.b7(el),u_shadowmap_0:new en.a$(el),u_shadowmap_1:new en.a$(el)})}}setTerrainUniformValues(en,el){if(!this.terrainUniforms)return;let eu=this.terrainUniforms;if(!this.failedToCreate)for(let ec in en.program.set(this.program),el)eu[ec]&&eu[ec].set(this.program,ec,el[ec])}setGlobeUniformValues(en,el){if(!this.globeUniforms)return;let eu=this.globeUniforms;if(!this.failedToCreate)for(let ec in en.program.set(this.program),el)eu[ec]&&eu[ec].set(this.program,ec,el[ec])}setFogUniformValues(en,el){if(!this.fogUniforms)return;let eu=this.fogUniforms;if(!this.failedToCreate)for(let ec in en.program.set(this.program),el)eu[ec].set(this.program,ec,el[ec])}setCutoffUniformValues(en,el){if(!this.cutoffUniforms)return;let eu=this.cutoffUniforms;if(!this.failedToCreate)for(let ec in en.program.set(this.program),el)eu[ec].set(this.program,ec,el[ec])}setLightsUniformValues(en,el){if(!this.lightsUniforms)return;let eu=this.lightsUniforms;if(!this.failedToCreate)for(let ec in en.program.set(this.program),el)eu[ec].set(this.program,ec,el[ec])}setShadowUniformValues(en,el){if(this.failedToCreate||!this.shadowUniforms)return;let eu=this.shadowUniforms;for(let ec in en.program.set(this.program),el)eu[ec].set(this.program,ec,el[ec])}_drawDebugWireframe(el,eu,ec,ed,ef,em,e_,ew,eT,eM){let eE=el.options.wireframe;if(!1===eE.terrain&&!1===eE.layers2D&&!1===eE.layers3D)return;let eS=el.context;if(!(!(!eE.terrain||"terrainRaster"!==this.name&&"globeRaster"!==this.name)||!(!eE.layers2D||el._terrain&&el._terrain.renderingToTexture||!eJ.includes(this.name))||!(!eE.layers3D||!eY.includes(this.name))))return;let eA=eS.gl,eI=el.wireframeDebugCache.getLinesFromTrianglesBuffer(el.frameCounter,ef,eS);if(!eI)return;let eC=[...this.fixedDefines];eC.push("DEBUG_WIREFRAME");let eP=el.getOrCreateProgram(this.name,{config:this.configuration,defines:eC});eS.program.set(eP.program);let g=(en,el,eu)=>{if(el[en]&&eu[en])for(let ec in el[en])eu[en][ec]&&eu[en][ec].set(eu.program,ec,el[en][ec].current)};eT&&eT.setUniforms(eP.program,eS,eP.binderUniforms,e_,{zoom:ew}),g("fixedUniforms",this,eP),g("terrainUniforms",this,eP),g("globeUniforms",this,eP),g("fogUniforms",this,eP),g("lightsUniforms",this,eP),g("shadowUniforms",this,eP),eI.bind(),eS.setColorMode(new en.a([eA.ONE,eA.ONE_MINUS_SRC_ALPHA,eA.ZERO,eA.ONE],en.C.transparent,[!0,!0,!0,!1])),eS.setDepthMode(new en.b4(eu.func===eA.LESS?eA.LEQUAL:eu.func,en.b4.ReadOnly,eu.range)),eS.setStencilMode(en.b6.disabled);let ez=3*em.primitiveLength*2,eD=3*em.primitiveOffset*4;eM&&eM>1?eA.drawElementsInstanced(eA.LINES,ez,eA.UNSIGNED_SHORT,eD,eM):eA.drawElements(eA.LINES,ez,eA.UNSIGNED_SHORT,eD),ef.bind(),eS.program.set(this.program),eS.setDepthMode(eu),eS.setStencilMode(ec),eS.setColorMode(ed)}draw(en,el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC){let eP=en.context,ez=eP.gl;if(this.failedToCreate)return;for(let en of(eP.program.set(this.program),eP.setDepthMode(eu),eP.setStencilMode(ec),eP.setColorMode(ed),eP.setCullFace(ef),Object.keys(this.fixedUniforms)))this.fixedUniforms[en].set(this.program,en,em[en]);eA&&eA.setUniforms(this.program,eP,this.binderUniforms,eE,{zoom:eS});let eD={[ez.LINES]:2,[ez.TRIANGLES]:3,[ez.LINE_STRIP]:1}[el],eL=eC&&eC>0?1:void 0;for(let ef of eM.get()){let em=ef.vaos||(ef.vaos={});(em[e_]||(em[e_]=new vi)).bind(eP,this,ew,eA?eA.getPaintVertexBuffers():[],eT,ef.vertexOffset,eI||[],eL),eC&&eC>1?ez.drawElementsInstanced(el,ef.primitiveLength*eD,ez.UNSIGNED_SHORT,ef.primitiveOffset*eD*2,eC):ez.drawElements(el,ef.primitiveLength*eD,ez.UNSIGNED_SHORT,ef.primitiveOffset*eD*2),el===ez.TRIANGLES&&this._drawDebugWireframe(en,eu,ec,ed,eT,ef,eE,eS,eA,eC)}}};function ji(el,eu){let ec=Math.pow(2,eu.tileID.overscaledZ),ed=eu.tileSize*Math.pow(2,el.transform.tileZoom)/ec,ef=ed*(eu.tileID.canonical.x+eu.tileID.wrap*ec),em=ed*eu.tileID.canonical.y;return{u_image:0,u_texsize:eu.imageAtlasTexture?eu.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/en.ay(eu,1,el.transform.tileZoom),u_pixel_coord_upper:[ef>>16,em>>16],u_pixel_coord_lower:[65535&ef,65535&em]}}let eQ=en.m.create(),Zi=(el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC,eP)=>{let ez=eu.style.light,eD=ez.properties.get("position"),eL=[eD.x,eD.y,eD.z],ek=en.bx.create();"viewport"===ez.properties.get("anchor")&&(en.bx.fromRotation(ek,-eu.transform.angle),en.v.transformMat3(eL,eL,ek));let eR=ez.properties.get("color"),eO=eu.transform,eB={u_matrix:el,u_lightpos:eL,u_lightintensity:ez.properties.get("intensity"),u_lightcolor:[eR.r,eR.g,eR.b],u_vertical_gradient:+ec,u_opacity:ed,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:eQ,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_ao:ef,u_edge_radius:em,u_flood_light_color:eS,u_vertical_scale:eA,u_flood_light_intensity:eI,u_ground_shadow_factor:eC,u_emissive_strength:eP};return"globe"===eO.projection.name&&(eB.u_tile_id=[e_.canonical.x,e_.canonical.y,1<<e_.canonical.z],eB.u_zoom_transition=eT,eB.u_inv_rot_matrix=eE,eB.u_merc_center=eM,eB.u_up_dir=eO.projection.upVector(new en.t(0,0,0),eM[0]*en.J,eM[1]*en.J),eB.u_height_lift=ew),eB},Wi=(en,el,eu)=>({u_matrix:en,u_edge_radius:el,u_vertical_scale:eu}),Hi=(el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI)=>{let eC=Zi(el,eu,ec,ed,ef,em,e_,eT,eM,eE,eS,eA,eI,1,[0,0,0],0),eP={u_height_factor:-Math.pow(2,e_.overscaledZ)/ew.tileSize/8};return en.ak(eC,ji(eu,ew),eP)},qi=(en,el)=>({u_matrix:en,u_emissive_strength:el}),$i=(el,eu,ec,ed)=>en.ak(qi(el,eu),ji(ec,ed)),Xi=(en,el,eu)=>({u_matrix:en,u_world:eu,u_emissive_strength:el}),Ji=(el,eu,ec,ed,ef)=>en.ak($i(el,eu,ec,ed),{u_world:ef}),Yi=(el,eu,ec,ed)=>{let ef=en.J/ec.tileSize;return{u_matrix:el,u_camera_to_center_distance:eu.getCameraToCenterDistance(ed),u_extrude_scale:[eu.pixelsToGLUnits[0]/ef,eu.pixelsToGLUnits[1]/ef]}},Ki=(en,el,eu=1)=>({u_matrix:en,u_color:el,u_overlay:0,u_overlay_scale:eu}),e0=en.m.create(),eo=(el,eu,ec,ed,ef,em,e_)=>{let ew=el.transform,eT="globe"===ew.projection.name,eM=eT?en.by(ew.zoom,eu.canonical)*ew._pixelsPerMercatorPixel:en.ay(ec,1,em),eE={u_matrix:eu.projMatrix,u_extrude_scale:eM,u_intensity:e_,u_inv_rot_matrix:e0,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(eT){eE.u_inv_rot_matrix=ed,eE.u_merc_center=ef,eE.u_tile_id=[eu.canonical.x,eu.canonical.y,1<<eu.canonical.z],eE.u_zoom_transition=en.ao(ew.zoom);let el=ef[0]*en.J,ec=ef[1]*en.J;eE.u_up_dir=ew.projection.upVector(new en.t(0,0,0),el,ec)}return eE},to=(el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC,eP,ez,eD,eL,ek,eR)=>{var eO,eB;return{u_matrix:el,u_normalize_matrix:eu,u_globe_matrix:ec,u_merc_matrix:ed,u_grid_matrix:ef,u_tl_parent:em,u_scale_parent:eM,u_fade_t:eE.mix,u_opacity:eE.opacity*eS.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:eS.paint.get("raster-brightness-min"),u_brightness_high:eS.paint.get("raster-brightness-max"),u_saturation_factor:(eB=eS.paint.get("raster-saturation"))>0?1-1/(1.001-eB):-eB,u_contrast_factor:(eO=eS.paint.get("raster-contrast"))>0?1/(1-eO):1+eO,u_spin_weights:function(en){en*=Math.PI/180;let el=Math.sin(en),eu=Math.cos(en);return[(2*eu+1)/3,(-Math.sqrt(3)*el-eu+1)/3,(Math.sqrt(3)*el-eu+1)/3]}(eS.paint.get("raster-hue-rotate")),u_perspective_transform:eA,u_raster_elevation:eI,u_zoom_transition:e_,u_merc_center:ew,u_cutoff_params:eT,u_colorization_mix:function([el,eu,ec,ed],[ef,em]){if(ef===em)return[0,0,0,0];let e_=(en.bz+3)/(en.bz+1)/(em-ef);return[el*e_,eu*e_,ec*e_,ed*e_]}(eP,eD),u_colorization_offset:function(el,[eu,ec]){return eu===ec?0:((el-eu)/(ec-eu)*(en.bz+3)-1)/(en.bz+1)}(ez,eD),u_color_ramp:eC,u_texture_offset:[ek/(eL+2*ek),eL/(eL+2*ek)],u_texture_res:[eL+2*ek,eL+2*ek],u_emissive_strength:eR}},e1=en.m.create(),no=(el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC,eP,ez,eD)=>{let eL=ef.transform,ek={u_is_size_zoom_constant:+("constant"===el||"source"===el),u_is_size_feature_constant:+("constant"===el||"camera"===el),u_size_t:eu?eu.uSizeT:0,u_size:eu?eu.uSize:0,u_camera_to_center_distance:eL.getCameraToCenterDistance(eP),u_rotate_symbol:+ec,u_aspect_ratio:eL.width/eL.height,u_fade_change:ef.options.fadeDuration?ef.symbolFadeChange:1,u_matrix:em,u_label_plane_matrix:e_,u_coord_matrix:ew,u_is_text:+eT,u_pitch_with_map:+ed,u_texsize:eM,u_texture:0,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:e1,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:e1,u_up_vector:[0,-1,0],u_icon_transition:eD||0,u_icon_saturation:ez};return"globe"===eP.name&&(ek.u_tile_id=[eE.canonical.x,eE.canonical.y,1<<eE.canonical.z],ek.u_zoom_transition=eS,ek.u_inv_rot_matrix=eI,ek.u_merc_center=eA,ek.u_camera_forward=eL._camera.forward(),ek.u_ecef_origin=en.bA(eL.globeMatrix,eE.toUnwrapped()),ek.u_tile_matrix=Float32Array.from(eL.globeMatrix),ek.u_up_vector=eC),ek},ao=(el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC,eP,ez)=>en.ak(no(el,eu,ec,ed,ef,em,e_,ew,eT,eM,eS,eA,eI,eC,eP,ez,1),{u_gamma_scale:ed?ef.transform.getCameraToCenterDistance(ez)*Math.cos(ef.terrain?0:ef.transform._pitch):1,u_device_pixel_ratio:en.a4.devicePixelRatio,u_is_halo:+eE,undefined:void 0}),lo=(el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC,eP)=>en.ak(ao(el,eu,ec,ed,ef,em,e_,ew,!0,eT,!0,eE,eS,eA,eI,eC,eP),{u_texsize_icon:eM,u_texture_icon:1}),co=(en,el,eu,ec)=>({u_matrix:en,u_emissive_strength:el,u_opacity:eu,u_color:ec}),ho=(el,eu,ec,ed,ef,em,e_)=>en.ak(function(el,eu,ec,ed){let ef=ec.imageManager.getPattern(el.toString(),eu),{width:em,height:e_}=ec.imageManager.getPixelSize(eu),ew=Math.pow(2,ed.tileID.overscaledZ),eT=ed.tileSize*Math.pow(2,ec.transform.tileZoom)/ew,eM=eT*(ed.tileID.canonical.x+ed.tileID.wrap*ew),eE=eT*ed.tileID.canonical.y;return{u_image:0,u_pattern_tl:ef.tl,u_pattern_br:ef.br,u_texsize:[em,e_],u_pattern_size:ef.displaySize,u_tile_units_to_pixels:1/en.ay(ed,1,ec.transform.tileZoom),u_pixel_coord_upper:[eM>>16,eE>>16],u_pixel_coord_lower:[65535&eM,65535&eE]}}(ef,em,ed,e_),{u_matrix:el,u_emissive_strength:eu,u_opacity:ec}),e2={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,ShadowMap0:10},uo=(el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA=[0,0,0])=>{let eI=ed.style.light,eC=eI.properties.get("position"),eP=[-eC.x,-eC.y,eC.z],ez=en.bx.create();"viewport"===eI.properties.get("anchor")&&(en.bx.fromRotation(ez,-ed.transform.angle),en.v.transformMat3(eP,eP,ez));let eD="MASK"===eM.alphaMode,eL=eI.properties.get("color"),ek=eS.paint.get("model-ambient-occlusion-intensity"),eR=eS.paint.get("model-color").constantOr(en.C.white),eO=eS.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:el,u_lighting_matrix:eu,u_normal_matrix:ec,u_lightpos:eP,u_lightintensity:eI.properties.get("intensity"),u_lightcolor:[eL.r,eL.g,eL.b],u_camera_pos:eA,u_opacity:ef,u_baseTextureIsAlpha:0,u_alphaMask:+eD,u_alphaCutoff:eM.alphaCutoff,u_baseColorFactor:[em.r,em.g,em.b,em.a],u_emissiveFactor:[e_[0],e_[1],e_[2],1],u_metallicFactor:ew,u_roughnessFactor:eT,u_baseColorTexture:e2.BaseColor,u_metallicRoughnessTexture:e2.MetallicRoughness,u_normalTexture:e2.Normal,u_occlusionTexture:e2.Occlusion,u_emissionTexture:e2.Emission,u_color_mix:[eR.r,eR.g,eR.b,eO],u_aoIntensity:ek,u_emissive_strength:eE}},e3=new Float32Array(16),mo=(en,el=e3,eu=e3)=>({u_matrix:en,u_instance:el,u_node_matrix:eu}),e4={fillExtrusion:el=>({u_matrix:new en.a_(el),u_lightpos:new en.b7(el),u_lightintensity:new en.b2(el),u_lightcolor:new en.b7(el),u_vertical_gradient:new en.b2(el),u_opacity:new en.b2(el),u_edge_radius:new en.b2(el),u_ao:new en.b0(el),u_tile_id:new en.b7(el),u_zoom_transition:new en.b2(el),u_inv_rot_matrix:new en.a_(el),u_merc_center:new en.b0(el),u_up_dir:new en.b7(el),u_height_lift:new en.b2(el),u_flood_light_color:new en.b7(el),u_vertical_scale:new en.b2(el),u_flood_light_intensity:new en.b2(el),u_ground_shadow_factor:new en.b7(el),u_emissive_strength:new en.b2(el)}),fillExtrusionDepth:el=>({u_matrix:new en.a_(el),u_edge_radius:new en.b2(el),u_vertical_scale:new en.b2(el)}),fillExtrusionPattern:el=>({u_matrix:new en.a_(el),u_lightpos:new en.b7(el),u_lightintensity:new en.b2(el),u_lightcolor:new en.b7(el),u_vertical_gradient:new en.b2(el),u_height_factor:new en.b2(el),u_edge_radius:new en.b2(el),u_ao:new en.b0(el),u_tile_id:new en.b7(el),u_zoom_transition:new en.b2(el),u_inv_rot_matrix:new en.a_(el),u_merc_center:new en.b0(el),u_up_dir:new en.b7(el),u_height_lift:new en.b2(el),u_image:new en.a$(el),u_texsize:new en.b0(el),u_pixel_coord_upper:new en.b0(el),u_pixel_coord_lower:new en.b0(el),u_tile_units_to_pixels:new en.b2(el),u_opacity:new en.b2(el)}),fillExtrusionGroundEffect:el=>({u_matrix:new en.a_(el),u_opacity:new en.b2(el),u_ao_pass:new en.b2(el),u_meter_to_tile:new en.b2(el),u_ao:new en.b0(el),u_flood_light_intensity:new en.b2(el),u_flood_light_color:new en.b7(el),u_attenuation:new en.b2(el),u_edge_radius:new en.b2(el),u_fb:new en.a$(el),u_fb_size:new en.b2(el)}),fill:el=>({u_matrix:new en.a_(el),u_emissive_strength:new en.b2(el)}),fillPattern:el=>({u_matrix:new en.a_(el),u_emissive_strength:new en.b2(el),u_image:new en.a$(el),u_texsize:new en.b0(el),u_pixel_coord_upper:new en.b0(el),u_pixel_coord_lower:new en.b0(el),u_tile_units_to_pixels:new en.b2(el)}),fillOutline:el=>({u_matrix:new en.a_(el),u_emissive_strength:new en.b2(el),u_world:new en.b0(el)}),fillOutlinePattern:el=>({u_matrix:new en.a_(el),u_emissive_strength:new en.b2(el),u_world:new en.b0(el),u_image:new en.a$(el),u_texsize:new en.b0(el),u_pixel_coord_upper:new en.b0(el),u_pixel_coord_lower:new en.b0(el),u_tile_units_to_pixels:new en.b2(el)}),circle:en.bB,collisionBox:el=>({u_matrix:new en.a_(el),u_camera_to_center_distance:new en.b2(el),u_extrude_scale:new en.b0(el)}),collisionCircle:el=>({u_matrix:new en.a_(el),u_inv_matrix:new en.a_(el),u_camera_to_center_distance:new en.b2(el),u_viewport_size:new en.b0(el)}),debug:el=>({u_color:new en.b1(el),u_matrix:new en.a_(el),u_overlay:new en.a$(el),u_overlay_scale:new en.b2(el)}),clippingMask:el=>({u_matrix:new en.a_(el)}),heatmap:el=>({u_extrude_scale:new en.b2(el),u_intensity:new en.b2(el),u_matrix:new en.a_(el),u_inv_rot_matrix:new en.a_(el),u_merc_center:new en.b0(el),u_tile_id:new en.b7(el),u_zoom_transition:new en.b2(el),u_up_dir:new en.b7(el)}),heatmapTexture:el=>({u_image:new en.a$(el),u_color_ramp:new en.a$(el),u_opacity:new en.b2(el)}),hillshade:el=>({u_matrix:new en.a_(el),u_image:new en.a$(el),u_latrange:new en.b0(el),u_light:new en.b0(el),u_shadow:new en.b1(el),u_highlight:new en.b1(el),u_emissive_strength:new en.b2(el),u_accent:new en.b1(el)}),hillshadePrepare:el=>({u_matrix:new en.a_(el),u_image:new en.a$(el),u_dimension:new en.b0(el),u_zoom:new en.b2(el)}),line:en.bC,linePattern:en.bD,raster:el=>({u_matrix:new en.a_(el),u_normalize_matrix:new en.a_(el),u_globe_matrix:new en.a_(el),u_merc_matrix:new en.a_(el),u_grid_matrix:new en.b8(el),u_tl_parent:new en.b0(el),u_scale_parent:new en.b2(el),u_fade_t:new en.b2(el),u_opacity:new en.b2(el),u_image0:new en.a$(el),u_image1:new en.a$(el),u_brightness_low:new en.b2(el),u_brightness_high:new en.b2(el),u_saturation_factor:new en.b2(el),u_contrast_factor:new en.b2(el),u_spin_weights:new en.b7(el),u_perspective_transform:new en.b0(el),u_raster_elevation:new en.b2(el),u_zoom_transition:new en.b2(el),u_merc_center:new en.b0(el),u_cutoff_params:new en.b9(el),u_colorization_mix:new en.b9(el),u_colorization_offset:new en.b2(el),u_color_ramp:new en.a$(el),u_texture_offset:new en.b0(el),u_texture_res:new en.b0(el),u_emissive_strength:new en.b2(el)}),symbolIcon:el=>({u_is_size_zoom_constant:new en.a$(el),u_is_size_feature_constant:new en.a$(el),u_size_t:new en.b2(el),u_size:new en.b2(el),u_camera_to_center_distance:new en.b2(el),u_rotate_symbol:new en.a$(el),u_aspect_ratio:new en.b2(el),u_fade_change:new en.b2(el),u_matrix:new en.a_(el),u_label_plane_matrix:new en.a_(el),u_coord_matrix:new en.a_(el),u_is_text:new en.a$(el),u_pitch_with_map:new en.a$(el),u_texsize:new en.b0(el),u_tile_id:new en.b7(el),u_zoom_transition:new en.b2(el),u_inv_rot_matrix:new en.a_(el),u_merc_center:new en.b0(el),u_camera_forward:new en.b7(el),u_tile_matrix:new en.a_(el),u_up_vector:new en.b7(el),u_ecef_origin:new en.b7(el),u_texture:new en.a$(el),u_icon_transition:new en.b2(el),u_icon_saturation:new en.b2(el)}),symbolSDF:el=>({u_is_size_zoom_constant:new en.a$(el),u_is_size_feature_constant:new en.a$(el),u_size_t:new en.b2(el),u_size:new en.b2(el),u_camera_to_center_distance:new en.b2(el),u_rotate_symbol:new en.a$(el),u_aspect_ratio:new en.b2(el),u_fade_change:new en.b2(el),u_matrix:new en.a_(el),u_label_plane_matrix:new en.a_(el),u_coord_matrix:new en.a_(el),u_is_text:new en.a$(el),u_pitch_with_map:new en.a$(el),u_texsize:new en.b0(el),u_texture:new en.a$(el),u_gamma_scale:new en.b2(el),u_device_pixel_ratio:new en.b2(el),u_tile_id:new en.b7(el),u_zoom_transition:new en.b2(el),u_inv_rot_matrix:new en.a_(el),u_merc_center:new en.b0(el),u_camera_forward:new en.b7(el),u_tile_matrix:new en.a_(el),u_up_vector:new en.b7(el),u_ecef_origin:new en.b7(el),u_is_halo:new en.a$(el)}),symbolTextAndIcon:el=>({u_is_size_zoom_constant:new en.a$(el),u_is_size_feature_constant:new en.a$(el),u_size_t:new en.b2(el),u_size:new en.b2(el),u_camera_to_center_distance:new en.b2(el),u_rotate_symbol:new en.a$(el),u_aspect_ratio:new en.b2(el),u_fade_change:new en.b2(el),u_matrix:new en.a_(el),u_label_plane_matrix:new en.a_(el),u_coord_matrix:new en.a_(el),u_is_text:new en.a$(el),u_pitch_with_map:new en.a$(el),u_texsize:new en.b0(el),u_texsize_icon:new en.b0(el),u_texture:new en.a$(el),u_texture_icon:new en.a$(el),u_gamma_scale:new en.b2(el),u_device_pixel_ratio:new en.b2(el),u_is_halo:new en.a$(el)}),background:el=>({u_matrix:new en.a_(el),u_emissive_strength:new en.b2(el),u_opacity:new en.b2(el),u_color:new en.b1(el)}),backgroundPattern:el=>({u_matrix:new en.a_(el),u_emissive_strength:new en.b2(el),u_opacity:new en.b2(el),u_image:new en.a$(el),u_pattern_tl:new en.b0(el),u_pattern_br:new en.b0(el),u_texsize:new en.b0(el),u_pattern_size:new en.b0(el),u_pixel_coord_upper:new en.b0(el),u_pixel_coord_lower:new en.b0(el),u_tile_units_to_pixels:new en.b2(el)}),terrainRaster:Ti,terrainDepth:Ti,skybox:el=>({u_matrix:new en.a_(el),u_sun_direction:new en.b7(el),u_cubemap:new en.a$(el),u_opacity:new en.b2(el),u_temporal_offset:new en.b2(el)}),skyboxGradient:el=>({u_matrix:new en.a_(el),u_color_ramp:new en.a$(el),u_center_direction:new en.b7(el),u_radius:new en.b2(el),u_opacity:new en.b2(el),u_temporal_offset:new en.b2(el)}),skyboxCapture:el=>({u_matrix_3f:new en.b8(el),u_sun_direction:new en.b7(el),u_sun_intensity:new en.b2(el),u_color_tint_r:new en.b9(el),u_color_tint_m:new en.b9(el),u_luminance:new en.b2(el)}),globeRaster:el=>({u_proj_matrix:new en.a_(el),u_globe_matrix:new en.a_(el),u_normalize_matrix:new en.a_(el),u_merc_matrix:new en.a_(el),u_zoom_transition:new en.b2(el),u_merc_center:new en.b0(el),u_image0:new en.a$(el),u_grid_matrix:new en.b8(el),u_skirt_height:new en.b2(el),u_frustum_tl:new en.b7(el),u_frustum_tr:new en.b7(el),u_frustum_br:new en.b7(el),u_frustum_bl:new en.b7(el),u_globe_pos:new en.b7(el),u_globe_radius:new en.b2(el),u_viewport:new en.b0(el)}),globeAtmosphere:el=>({u_frustum_tl:new en.b7(el),u_frustum_tr:new en.b7(el),u_frustum_br:new en.b7(el),u_frustum_bl:new en.b7(el),u_horizon:new en.b2(el),u_transition:new en.b2(el),u_fadeout_range:new en.b2(el),u_color:new en.b9(el),u_high_color:new en.b9(el),u_space_color:new en.b9(el),u_temporal_offset:new en.b2(el),u_horizon_angle:new en.b2(el)}),model:el=>({u_matrix:new en.a_(el),u_lighting_matrix:new en.a_(el),u_normal_matrix:new en.a_(el),u_lightpos:new en.b7(el),u_lightintensity:new en.b2(el),u_lightcolor:new en.b7(el),u_camera_pos:new en.b7(el),u_opacity:new en.b2(el),u_baseColorFactor:new en.b9(el),u_emissiveFactor:new en.b9(el),u_metallicFactor:new en.b2(el),u_roughnessFactor:new en.b2(el),u_baseTextureIsAlpha:new en.a$(el),u_alphaMask:new en.a$(el),u_alphaCutoff:new en.b2(el),u_baseColorTexture:new en.a$(el),u_metallicRoughnessTexture:new en.a$(el),u_normalTexture:new en.a$(el),u_occlusionTexture:new en.a$(el),u_emissionTexture:new en.a$(el),u_color_mix:new en.b9(el),u_aoIntensity:new en.b2(el),u_emissive_strength:new en.b2(el)}),modelDepth:el=>({u_matrix:new en.a_(el),u_instance:new en.a_(el),u_node_matrix:new en.a_(el)}),groundShadow:el=>({u_matrix:new en.a_(el),u_ground_shadow_factor:new en.b7(el)}),stars:el=>({u_matrix:new en.a_(el),u_up:new en.b7(el),u_right:new en.b7(el),u_intensity_multiplier:new en.b2(el)})};function vo(el,ec,ed,ef,em,e_,ew){let eT=el.context,eM=eT.gl,eE=el.transform,eS=el.getOrCreateProgram("collisionBox"),eA=[],eI=0,eC=0;for(let eu=0;eu<ef.length;eu++){let eT=ef[eu],eP=ec.getTile(eT),ez=eP.getBucket(ed);if(!ez)continue;let eD=function(en,el,eu){if(el.projection.name===eu.projection.name)return en.projMatrix;let ec=eu.clone();return ec.setProjection(el.projection),Ct(ec,el.getProjection(),en)}(eT,ez,eE),eL=eD;0===em[0]&&0===em[1]||(eL=el.translatePosMatrix(eD,eP,em,e_));let ek=ew?ez.textCollisionBox:ez.iconCollisionBox,eR=ez.collisionCircleArray;if(eR.length>0){let el=en.m.create(),eu=eL;en.m.mul(el,ez.placementInvProjMatrix,eE.glCoordMatrix),en.m.mul(el,el,ez.placementViewportMatrix),eA.push({circleArray:eR,circleOffset:eC,transform:eu,invTransform:el,projection:ez.getProjection()}),eI+=eR.length/4,eC=eI}ek&&(el.terrain&&el.terrain.setupElevationDraw(eP,eS),eS.draw(el,eM.LINES,en.b4.disabled,en.b6.disabled,el.colorModeForRenderPass(),en.b5.disabled,Yi(eL,eE,eP,ez.getProjection()),ed.id,ek.layoutVertexBuffer,ek.indexBuffer,ek.segments,null,eE.zoom,null,[ek.collisionVertexBuffer,ek.collisionVertexBufferExt]))}if(!ew||!eA.length)return;let eP=el.getOrCreateProgram("collisionCircle"),ez=new en.bE;ez.resize(4*eI),ez._trim();let eD=0;for(let en of eA)for(let el=0;el<en.circleArray.length/4;el++){let eu=4*el,ec=en.circleArray[eu+0],ed=en.circleArray[eu+1],ef=en.circleArray[eu+2],em=en.circleArray[eu+3];ez.emplace(eD++,ec,ed,ef,em,0),ez.emplace(eD++,ec,ed,ef,em,1),ez.emplace(eD++,ec,ed,ef,em,2),ez.emplace(eD++,ec,ed,ef,em,3)}(!eu||eu.length<2*eI)&&(eu=function(el){let eu=2*el,ec=new en.bp;ec.resize(eu),ec._trim();for(let en=0;en<eu;en++){let el=6*en;ec.uint16[el+0]=4*en+0,ec.uint16[el+1]=4*en+1,ec.uint16[el+2]=4*en+2,ec.uint16[el+3]=4*en+2,ec.uint16[el+4]=4*en+3,ec.uint16[el+5]=4*en+0}return ec}(eI));let eL=eT.createIndexBuffer(eu,!0),ek=eT.createVertexBuffer(ez,en.bF.members,!0);for(let eu of eA){let ec={u_matrix:eu.transform,u_inv_matrix:eu.invTransform,u_camera_to_center_distance:eE.getCameraToCenterDistance(eu.projection),u_viewport_size:[eE.width,eE.height]};eP.draw(el,eM.TRIANGLES,en.b4.disabled,en.b6.disabled,el.colorModeForRenderPass(),en.b5.disabled,ec,ed.id,ek,eL,en.bm.simpleSegment(0,2*eu.circleOffset,eu.circleArray.length,eu.circleArray.length/2),null,eE.zoom)}ek.destroy(),eL.destroy()}let e5=en.m.create();function To(el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA){let eI=el.context,eC=eI.gl,eP=el.transform,ez="map"===ew,eD="map"===eT,eL=ez&&"point"!==ec.layout.get("symbol-placement"),ek=ez&&!eD&&!eL,eR=void 0!==ec.layout.get("symbol-sort-key").constantOr(1),eO=!1,eB=el.depthModeForSublayer(0,en.b4.ReadOnly),eF=[en.E(eP.center.lng),en.H(eP.center.lat)],eN=ec.layout.get("text-variable-anchor"),eU="globe"===eP.projection.name,eV=[],ej=[0,-1,0],eG=ej;for(let ew of((eU||eP.mercatorFromTransition)&&!ez&&(eG=function(el){let eu=el._camera.getWorldToCamera(el.worldSize,1),ec=en.m.multiply([],eu,el.globeMatrix);en.m.invert(ec,ec);let ed=[0,0,0],ef=[0,1,0,0];return en.e.transformMat4(ef,ef,ec),ed[0]=ef[0],ed[1]=ef[1],ed[2]=ef[2],en.v.normalize(ed,ed),ed}(eP)),ed)){let ed;let eT=eu.getTile(ew),eS=eT.getBucket(ec);if(!eS||"mercator"===eS.projection.name&&eU)continue;let eA=ef?eS.text:eS.icon;if(!eA||eS.fullyClipped||!eA.segments.get().length)continue;let eI=eA.programConfigurations.get(ec.id),eB=ef||eS.sdfIcons,eq=ef?eS.textSizeData:eS.iconSizeData,eZ=eD||0!==eP.pitch,e$=en.i(eq,eP.zoom),eW,eH,eX,eK,eJ=[0,0],eY=null;if(ef)eH=eT.glyphAtlasTexture?eT.glyphAtlasTexture:null,eX=eC.LINEAR,eW=eT.glyphAtlasTexture?eT.glyphAtlasTexture.size:[0,0],eS.iconsInText&&(eJ=eT.imageAtlasTexture?eT.imageAtlasTexture.size:[0,0],eY=eT.imageAtlasTexture?eT.imageAtlasTexture:null,eK=eZ||el.options.rotating||el.options.zooming||"composite"===eq.kind||"camera"===eq.kind?eC.LINEAR:eC.NEAREST);else{let en=1!==ec.layout.get("icon-size").constantOr(0)||eS.iconsNeedLinear;eH=eT.imageAtlasTexture?eT.imageAtlasTexture:null,eX=eB||el.options.rotating||el.options.zooming||en||eZ?eC.LINEAR:eC.NEAREST,eW=eT.imageAtlasTexture?eT.imageAtlasTexture.size:[0,0]}let eQ="globe"===eS.projection.name,e0=eQ?eG:ej,e1=eQ?en.ao(eP.zoom):0,e2=St(ew,eS.getProjection(),eP),e3=eP.calculatePixelsToTileUnitsMatrix(eT),e4=pe(e2,eT.tileID.canonical,eD,ez,eP,eS.getProjection(),e3),e6=el.terrain&&eD&&eL?en.m.invert(en.m.create(),e4):e5,e8=fe(e2,eT.tileID.canonical,eD,ez,eP,eS.getProjection(),e3),e7=eN&&eS.hasTextData(),e9=eS.hasIconTextFit()&&e7&&eS.hasIconData();if(eL){let eu=eP.elevation,ec=eu?eu.getAtTileOffsetFunc(ew,eP.center.lat,eP.worldSize,eS.getProjection()):null,ed=me(e2,eT.tileID.canonical,eD,ez,eP,eS.getProjection(),e3);!function(el,eu,ec,ed,ef,em,e_,ew,eT,eM){let eE=ec.transform,eS=ed?el.textSizeData:el.iconSizeData,eA=en.i(eS,ec.transform.zoom),eI="globe"===eE.projection.name,eC=[256/ec.width*2+1,256/ec.height*2+1],eP=ed?el.text.dynamicLayoutVertexArray:el.icon.dynamicLayoutVertexArray;eP.clear();let ez=null;eI&&(ez=ed?el.text.globeExtVertexArray:el.icon.globeExtVertexArray);let eD=el.lineVertexArray,eL=ed?el.text.placedSymbolArray:el.icon.placedSymbolArray,ek=ec.transform.width/ec.transform.height,eR,eO=!1;for(let ed=0;ed<eL.length;ed++){let eI=eL.get(ed),{numGlyphs:eB,writingMode:eF}=eI;if(eF!==en.W.vertical||eO||eR===en.W.horizontal||(eO=!0),eR=eF,(eI.hidden||eF===en.W.vertical)&&!eO){Se(eB,eP);continue}eO=!1;let eN=new en.P(eI.tileAnchorX,eI.tileAnchorY),{x:eU,y:eV,z:ej}=eE.projection.projectTilePoint(eN.x,eN.y,eM.canonical);if(eT){let[en,el,eu]=eT(eN);eU+=en,eV+=el,ej+=eu}let eG=[eU,eV,ej,1];if(en.e.transformMat4(eG,eG,eu),!function(en,el){let eu=en[0]/en[3],ec=en[1]/en[3];return eu>=-el[0]&&eu<=el[0]&&ec>=-el[1]&&ec<=el[1]}(eG,eC)){Se(eB,eP);continue}let eq=eG[3],eZ=ve(ec.transform.getCameraToCenterDistance(eE.projection),eq),e$=en.j(eS,eA,eI),eW=e_?e$/eZ:e$*eZ,eH=ge(eU,eV,ej,ef);if(eH[3]<=0){Se(eB,eP);continue}let eX={},eK=e_?null:eT,eJ=Te(eI,eW,!1,ew,eu,ef,em,el.glyphOffsetArray,eD,eP,ez,eH,eN,eX,ek,eK,eE.projection,eM,e_);eO=eJ.useVertical,eK&&eJ.needsFlipping&&(eX={}),(eJ.notEnoughRoom||eO||eJ.needsFlipping&&Te(eI,eW,!0,ew,eu,ef,em,el.glyphOffsetArray,eD,eP,ez,eH,eN,eX,ek,eK,eE.projection,eM,e_).notEnoughRoom)&&Se(eB,eP)}ed?(el.text.dynamicLayoutVertexBuffer.updateData(eP),ez&&el.text.globeExtVertexBuffer&&el.text.globeExtVertexBuffer.updateData(ez)):(el.icon.dynamicLayoutVertexBuffer.updateData(eP),ez&&el.icon.globeExtVertexBuffer&&el.icon.globeExtVertexBuffer.updateData(ez))}(eS,e2,el,ef,ed,e8,eD,eM,ec,ew)}let ti=eL||ef&&eN||e9,ta=el.translatePosMatrix(e2,eT,em,e_),tc=ti?e5:e4,tm=el.translatePosMatrix(e8,eT,em,e_,!0),t_=eS.getProjection().createInversionMatrix(eP,ew.canonical),tg=ec.paint.get("icon-image-cross-fade").constantOr(0),tb=[];el.terrainRenderModeElevated()&&eD&&tb.push("PITCH_WITH_MAP_TERRAIN"),eQ&&(tb.push("PROJECTION_GLOBE_VIEW"),ti&&tb.push("PROJECTED_POS_ON_VIEWPORT")),tg>0&&tb.push("ICON_TRANSITION"),eA.zOffsetVertexBuffer&&tb.push("Z_OFFSET");let tw=eB&&0!==ec.paint.get(ef?"text-halo-width":"icon-halo-width").constantOr(1);eB?ed=eS.iconsInText?lo(eq.kind,e$,ek,eD,el,ta,tc,tm,eW,eJ,ew,e1,eF,t_,e0,eS.getProjection()):ao(eq.kind,e$,ek,eD,el,ta,tc,tm,ef,eW,!0,ew,e1,eF,t_,e0,eS.getProjection()):(eE<1&&tb.push("SATURATION"),ed=no(eq.kind,e$,ek,eD,el,ta,tc,tm,ef,eW,ew,e1,eF,t_,e0,eS.getProjection(),eE,tg));let tT={program:el.getOrCreateProgram(eS.iconsInText&&ef?"symbolTextAndIcon":eB?"symbolSDF":"symbolIcon",{config:eI,defines:tb}),buffers:eA,uniformValues:ed,atlasTexture:eH,atlasTextureIcon:eY,atlasInterpolation:eX,atlasInterpolationIcon:eK,isSDF:eB,hasHalo:tw,tile:eT,labelPlaneMatrixInv:e6};if(eR&&eS.canOverlap){eO=!0;let el=eA.segments.get();for(let eu of el)eV.push({segments:new en.bm([eu]),sortKey:eu.sortKey,state:tT})}else eV.push({segments:eA.segments,sortKey:0,state:tT})}for(let en of(eO&&eV.sort((en,el)=>en.sortKey-el.sortKey),eV)){let eu=en.state;if(el.terrain&&el.terrain.setupElevationDraw(eu.tile,eu.program,{useDepthForOcclusion:eP.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:eu.labelPlaneMatrixInv}),eI.activeTexture.set(eC.TEXTURE0),eu.atlasTexture&&eu.atlasTexture.bind(eu.atlasInterpolation,eC.CLAMP_TO_EDGE,!0),eu.atlasTextureIcon&&(eI.activeTexture.set(eC.TEXTURE1),eu.atlasTextureIcon&&eu.atlasTextureIcon.bind(eu.atlasInterpolationIcon,eC.CLAMP_TO_EDGE,!0)),el.uploadCommonLightUniforms(el.context,eu.program),eu.hasHalo){let ed=eu.uniformValues;ed.u_is_halo=1,Eo(eu.buffers,en.segments,ec,el,eu.program,eB,eS,eA,ed,2),ed.u_is_halo=0}else{if(eu.isSDF){let ed=eu.uniformValues;eu.hasHalo&&(ed.u_is_halo=1,Eo(eu.buffers,en.segments,ec,el,eu.program,eB,eS,eA,ed,1)),ed.u_is_halo=0}Eo(eu.buffers,en.segments,ec,el,eu.program,eB,eS,eA,eu.uniformValues,1)}}}function Eo(el,eu,ec,ed,ef,em,e_,ew,eT,eM){let eE=[el.dynamicLayoutVertexBuffer,el.opacityVertexBuffer,el.iconTransitioningVertexBuffer,el.globeExtVertexBuffer,el.zOffsetVertexBuffer];ef.draw(ed,ed.context.gl.TRIANGLES,em,e_,ew,en.b5.disabled,eT,ec.id,el.layoutVertexBuffer,el.indexBuffer,eu,ec.paint,ed.transform.zoom,el.programConfigurations.get(ec.id),eE,eM)}function Co(el,eu,ec,ed,ef,em,e_){let ew,eT,eM,eE,eS;let eA=el.context.gl,eI=ec.paint.get("fill-pattern"),eC=eI&&eI.constantOr(1);for(let eP of(e_?(eT=eC&&!ec.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",ew=eA.LINES):(eT=eC?"fillPattern":"fill",ew=eA.TRIANGLES),ed)){let ed=eu.getTile(eP);if(eC&&!ed.patternsLoaded())continue;let ez=ed.getBucket(ec);if(!ez)continue;el.prepareDrawTile();let eD=ez.programConfigurations.get(ec.id),eL=el.isTileAffectedByFog(eP),ek=el.getOrCreateProgram(eT,{config:eD,overrideFog:eL});eC&&(el.context.activeTexture.set(eA.TEXTURE0),ed.imageAtlasTexture&&ed.imageAtlasTexture.bind(eA.LINEAR,eA.CLAMP_TO_EDGE),eD.updatePaintBuffers());let eR=eI.constantOr(null);if(eR&&ed.imageAtlas){let en=ed.imageAtlas.patternPositions[eR.toString()];en&&eD.setConstantPatternPositions(en)}let eO=el.translatePosMatrix(eP.projMatrix,ed,ec.paint.get("fill-translate"),ec.paint.get("fill-translate-anchor")),eB=ec.paint.get("fill-emissive-strength");if(e_){eE=ez.indexBuffer2,eS=ez.segments2;let en=el.terrain&&el.terrain.renderingToTexture?el.terrain.drapeBufferSize:[eA.drawingBufferWidth,eA.drawingBufferHeight];eM="fillOutlinePattern"===eT&&eC?Ji(eO,eB,el,ed,en):Xi(eO,eB,en)}else eE=ez.indexBuffer,eS=ez.segments,eM=eC?$i(eO,eB,el,ed):qi(eO,eB);el.uploadCommonUniforms(el.context,ek,eP.toUnwrapped()),ek.draw(el,ew,ef,el.stencilModeForClipping(eP),em,en.b5.disabled,eM,ec.id,ez.layoutVertexBuffer,eE,eS,ec.paint,el.transform.zoom,eD,void 0)}}function Io(el,eu,ec,ed,ef,em,e_,ew){let eT;ec.resetLayerRenderingStats();let eM=el.context,eE=eM.gl,eS=el.transform,eA=ec.paint.get("fill-extrusion-pattern"),eI=eA.constantOr(1),eC=ec.paint.get("fill-extrusion-opacity"),eP=el.style.enable3dLights(),ez=ec.paint.get(eP&&!eI?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),eD=[ec.paint.get("fill-extrusion-ambient-occlusion-intensity"),ez],eL=ec.layout.get("fill-extrusion-edge-radius"),ek=eL>0&&!ec.paint.get("fill-extrusion-rounded-roof"),eR=ek?0:eL,eO="globe"===eS.projection.name?en.bO():0,eB="globe"===eS.projection.name,eF=eB?en.ao(eS.zoom):0,eN=[en.E(eS.center.lng),en.H(eS.center.lat)],eU=ec.paint.get("fill-extrusion-flood-light-color").toArray01().slice(0,3),eV=ec.paint.get("fill-extrusion-flood-light-intensity"),ej=ec.paint.get("fill-extrusion-vertical-scale"),eG=Ii(el,ec.paint.get("fill-extrusion-cutoff-fade-range")),eq=ec.paint.get("fill-extrusion-emissive-strength"),eZ=[];eB&&eZ.push("PROJECTION_GLOBE_VIEW"),eD[0]>0&&eZ.push("FAUX_AO"),ek&&eZ.push("ZERO_ROOF_RADIUS"),ew&&eZ.push("HAS_CENTROID"),eV>0&&eZ.push("FLOOD_LIGHT"),eG.shouldRenderCutoff&&eZ.push("RENDER_CUTOFF");let e$="shadow"===el.renderPass,eW=el.shadowRenderer;el.shadowRenderer&&(el.shadowRenderer.useNormalOffset=!0);let eH=[0,0,0];if(eW){let en=el.style.directionalLight,eu=el.style.ambientLight;en&&eu&&(eH=wr(en,eu)),eT=eZ.concat(["SHADOWS_SINGLE_CASCADE"])}let eX=e$&&eW?"fillExtrusionDepth":eI?"fillExtrusionPattern":"fillExtrusion",eK=ec.getLayerRenderingStats();for(let eP of ed){let ed;let ez=eu.getTile(eP),eL=ez.getBucket(ec);if(!eL||eL.projection.name!==eS.projection.name)continue;let ek=!1;eW&&(ek=0===eW.getMaxCascadeForTile(eP.toUnwrapped()));let eJ=el.isTileAffectedByFog(eP),eY=eL.programConfigurations.get(ec.id),eQ=el.getOrCreateProgram(eX,{config:eY,defines:ek?eT:eZ,overrideFog:eJ});if(el.terrain&&el.terrain.setupElevationDraw(ez,eQ,{useMeterToDem:!0}),!eL.centroidVertexBuffer){let en=eQ.attributes.a_centroid_pos;void 0!==en&&eE.vertexAttrib2f(en,0,0)}!e$&&eW&&eW.setupShadows(ez.tileID.toUnwrapped(),eQ,"vector-tile",ez.tileID.overscaledZ),eI&&(el.context.activeTexture.set(eE.TEXTURE0),ez.imageAtlasTexture&&ez.imageAtlasTexture.bind(eE.LINEAR,eE.CLAMP_TO_EDGE),eY.updatePaintBuffers());let e0=eA.constantOr(null);if(e0&&ez.imageAtlas){let en=ez.imageAtlas.patternPositions[e0.toString()];en&&eY.setConstantPatternPositions(en)}let e1=ec.paint.get("fill-extrusion-vertical-gradient");if(e$&&eW){if(function(el,eu,ec){let ed=ec.transform,ef=ec.shadowRenderer;if(!ef)return!0;let em=el.toUnwrapped(),e_=ed.tileSize*ef._cascades[ec.currentShadowCascade].scale,ew=eu.maxHeight;if(ed.elevation){let en=ed.elevation.getMinMaxForTile(el);en&&(ew+=en.max)}let eT=[...ef.shadowDirection];eT[2]=-eT[2];let eM=ef.computeSimplifiedTileShadowVolume(em,ew,e_,eT);if(!eM)return!1;let eE=[e6,e8,e7,eT,[eT[0],0,eT[2]],[0,eT[1],eT[2]]],eS="globe"===ed.projection.name,eA=ed.scaleZoom(e_),eI=en.F.fromInvProjectionMatrix(ed.invProjMatrix,ed.worldSize,eA,!eS),eC=ef.getCurrentCascadeFrustum();return 0===eI.intersectsPrecise(eM.vertices,eM.planes,eE)||0===eC.intersectsPrecise(eM.vertices,eM.planes,eE)}(ez.tileID,eL,el))continue;let eu=eW.calculateShadowPassMatrixFromTile(ez.tileID.toUnwrapped());ed=Wi(eu,eR,ej)}else{let en=el.translatePosMatrix(eP.expandedProjMatrix,ez,ec.paint.get("fill-extrusion-translate"),ec.paint.get("fill-extrusion-translate-anchor")),eu=eS.projection.createInversionMatrix(eS,eP.canonical);ed=eI?Hi(en,el,e1,eC,eD,eR,eP,ez,eO,eF,eN,eu,eU,ej):Zi(en,el,e1,eC,eD,eR,eP,eO,eF,eN,eu,eU,ej,eV,eH,eq)}el.uploadCommonUniforms(eM,eQ,eP.toUnwrapped(),null,eG);let e2=eL.segments;if("mercator"===eS.projection.name&&!e$&&!(e2=eL.getVisibleSegments(ez.tileID,el.terrain,el.transform.getFrustum(0))).get().length)continue;if(eK){if(e$)for(let en of e2.get())eK.numRenderedVerticesInShadowPass+=en.primitiveLength;else for(let en of e2.get())eK.numRenderedVerticesInTransparentPass+=en.primitiveLength}let e3=[];(el.terrain||ew)&&e3.push(eL.centroidVertexBuffer),eB&&e3.push(eL.layoutVertexExtBuffer),eQ.draw(el,eM.gl.TRIANGLES,ef,em,e_,en.b5.backCCW,ed,ec.id,eL.layoutVertexBuffer,eL.indexBuffer,e2,ec.paint,el.transform.zoom,eY,e3)}el.shadowRenderer&&(el.shadowRenderer.useNormalOffset=!1)}function So(el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS,eA,eI,eC,eP,ez,eD,eL){let ek=el.context,eR=ek.gl,eO=el.transform,eB=el.transform.zoom,eF=[],eN=Ii(el,ec.paint.get("fill-extrusion-cutoff-fade-range"));"clear"===eM?(eF.push("CLEAR_SUBPASS"),eL&&(eF.push("CLEAR_FROM_TEXTURE"),ek.activeTexture.set(eR.TEXTURE0),eL.bind(eR.LINEAR,eR.CLAMP_TO_EDGE))):"sdf"===eM&&eF.push("SDF_SUBPASS"),ez&&eF.push("HAS_CENTROID"),eN.shouldRenderCutoff&&eF.push("RENDER_CUTOFF");let eU=ec.layout.get("fill-extrusion-edge-radius"),S=(en,eu,ed,eM,eD)=>{var eR,eO;let eV=eu.programConfigurations.get(ec.id),ej=el.isTileAffectedByFog(en),eG=el.getOrCreateProgram("fillExtrusionGroundEffect",{config:eV,defines:eF,overrideFog:ej}),eq=(eR=[eS,eA*eD],eO=eB>=17?0:eU*eD,{u_matrix:eM,u_opacity:eE,u_ao_pass:eT?1:0,u_meter_to_tile:eD,u_ao:eR,u_flood_light_intensity:eI,u_flood_light_color:eC,u_attenuation:eP,u_edge_radius:eO,u_fb:0,u_fb_size:eL?eL.size[0]:0}),eZ=[];ez&&eZ.push(eu.hiddenByLandmarkVertexBuffer),el.uploadCommonUniforms(ek,eG,en.toUnwrapped(),null,eN),eG.draw(el,ek.gl.TRIANGLES,ef,em,e_,ew,eq,ec.id,eu.vertexBuffer,eu.indexBuffer,ed,ec.paint,eB,eV,eZ)};for(let ef of ed){let ed=eu.getTile(ef),em=ed.getBucket(ec);if(!em||em.projection.name!==eO.projection.name||!em.groundEffect||em.groundEffect&&!em.groundEffect.hasData())continue;let e_=em.groundEffect,ew=1/em.tileToMeter;{let en=el.translatePosMatrix(ef.projMatrix,ed,ec.paint.get("fill-extrusion-translate"),ec.paint.get("fill-extrusion-translate-anchor")),eu=e_.getDefaultSegment();S(ef,e_,eu,en,ew)}if(eD)for(let em=0;em<4;em++){let e_,eT;let eM=en.bP[em](ef),eE=eu.getTile(eM);if(!eE)continue;let eS=eE.getBucket(ec);if(!eS||eS.projection.name!==eO.projection.name||!eS.groundEffect||eS.groundEffect&&!eS.groundEffect.hasData())continue;let eA=eS.groundEffect;0===em?(e_=[-en.J,0,0],eT=1):1===em?(e_=[en.J,0,0],eT=0):2===em?(e_=[0,-en.J,0],eT=3):(e_=[0,en.J,0],eT=2);let eI=eA.regionSegments[eT];if(!eI)continue;let eC=new Float32Array(16);en.m.translate(eC,ef.projMatrix,e_),S(ef,eA,eI,el.translatePosMatrix(eC,ed,ec.paint.get("fill-extrusion-translate"),ec.paint.get("fill-extrusion-translate-anchor")),ew)}}}let e6=[1,0,0],e8=[0,1,0],e7=[0,0,1],e9=new en.C(1,0,0,1),ti=new en.C(0,1,0,1),ta=new en.C(0,0,1,1),tc=new en.C(1,0,1,1),tm=new en.C(0,1,1,1);function No(el,eu,ec,ed,ef,em){let e_=el.context,ew=el.transform,eT=e_.gl,eM="globe"===ew.projection.name,eE=en.m.clone(ec.projMatrix);if(eM&&en.ao(ew.zoom)>0){let el=en.bU(ec.canonical,ew),eu=en.bV(el);eE=en.m.multiply(new Float32Array(16),ew.globeMatrix,eu),en.m.multiply(eE,ew.projMatrix,eE)}let eS=en.m.create();eS[12]+=2*ef/(en.a4.devicePixelRatio*ew.width),eS[13]+=2*em/(en.a4.devicePixelRatio*ew.height),en.m.multiply(eE,eS,eE);let eA=el.getOrCreateProgram("debug",{defines:eM?["PROJECTION_GLOBE_VIEW"]:[]}),eI=eu.getTileByID(ec.key);el.terrain&&el.terrain.setupElevationDraw(eI,eA);let eC=en.b4.disabled,eP=en.b6.disabled,ez=el.colorModeForRenderPass(),eD="$debug";e_.activeTexture.set(eT.TEXTURE0),el.emptyTexture.bind(eT.LINEAR,eT.CLAMP_TO_EDGE),eM?eI._makeGlobeTileDebugBuffers(el.context,ew):eI._makeDebugTileBoundsBuffers(el.context,ew.projection);let eL=eI._tileDebugBuffer||el.debugBuffer,ek=eI._tileDebugIndexBuffer||el.debugIndexBuffer,eR=eI._tileDebugSegments||el.debugSegments;eA.draw(el,eT.LINE_STRIP,eC,eP,ez,en.b5.disabled,Ki(eE,ed),eD,eL,ek,eR,null,null,null,[eI._globeTileDebugBorderBuffer]);let eO=eI.latestRawTileData,eB=Math.floor((eO&&eO.byteLength||0)/1024),eF=eu.getTile(ec).tileSize,eN=512/Math.min(eF,512)*(ec.overscaledZ/ew.zoom)*.5,eU=ec.canonical.toString();ec.overscaledZ!==ec.canonical.z&&(eU+=` => ${ec.overscaledZ}`),function(en,el){en.initDebugOverlayCanvas();let eu=en.debugOverlayCanvas,ec=en.context.gl,ed=en.debugOverlayCanvas.getContext("2d");ed.clearRect(0,0,eu.width,eu.height),ed.shadowColor="white",ed.shadowBlur=2,ed.lineWidth=1.5,ed.strokeStyle="white",ed.textBaseline="top",ed.font="bold 36px Open Sans, sans-serif",ed.fillText(el,5,5),ed.strokeText(el,5,5),en.debugOverlayTexture.update(eu),en.debugOverlayTexture.bind(ec.LINEAR,ec.CLAMP_TO_EDGE)}(el,eU+=` ${eB}kb`);let eV=eI._tileDebugTextBuffer||el.debugBuffer,ej=eI._tileDebugTextIndexBuffer||el.quadTriangleIndexBuffer,eG=eI._tileDebugTextSegments||el.debugSegments;eA.draw(el,eT.TRIANGLES,eC,eP,en.a.alphaBlended,en.b5.disabled,Ki(eE,en.C.transparent,eN),eD,eV,ej,eG,null,null,null,[eI._globeTileDebugTextBuffer])}function Uo(en,el,eu,ec){jo(en,0,el+eu/2,en.transform.width,eu,ec)}function Go(en,el,eu,ec){jo(en,el-eu/2,0,eu,en.transform.height,ec)}function jo(el,eu,ec,ed,ef,em){let e_=el.context,ew=e_.gl;ew.enable(ew.SCISSOR_TEST),ew.scissor(eu*en.a4.devicePixelRatio,ec*en.a4.devicePixelRatio,ed*en.a4.devicePixelRatio,ef*en.a4.devicePixelRatio),e_.clear({color:em}),ew.disable(ew.SCISSOR_TEST)}let t_=en.bW([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:tg}=t_;function Wo(en,el,eu,ec){en.emplaceBack(el,eu,ec)}let Ho=class Ho{constructor(el){this.vertexArray=new en.bX,this.indices=new en.bp,Wo(this.vertexArray,-1,-1,1),Wo(this.vertexArray,1,-1,1),Wo(this.vertexArray,-1,1,1),Wo(this.vertexArray,1,1,1),Wo(this.vertexArray,-1,-1,-1),Wo(this.vertexArray,1,-1,-1),Wo(this.vertexArray,-1,1,-1),Wo(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=el.createVertexBuffer(this.vertexArray,tg),this.indexBuffer=el.createIndexBuffer(this.indices),this.segment=en.bm.simpleSegment(0,0,36,12)}};function qo(el,eu,ec,ed,ef,em){let e_=el.context.gl,ew=eu.paint.get("sky-atmosphere-color"),eT=eu.paint.get("sky-atmosphere-halo-color"),eM=eu.paint.get("sky-atmosphere-sun-intensity"),eE={u_matrix_3f:en.bx.fromMat4(en.bx.create(),ed),u_sun_direction:ef,u_sun_intensity:eM,u_color_tint_r:[ew.r,ew.g,ew.b,ew.a],u_color_tint_m:[eT.r,eT.g,eT.b,eT.a],u_luminance:5e-5};e_.framebufferTexture2D(e_.FRAMEBUFFER,e_.COLOR_ATTACHMENT0,e_.TEXTURE_CUBE_MAP_POSITIVE_X+em,eu.skyboxTexture,0),ec.draw(el,e_.TRIANGLES,en.b4.disabled,en.b6.disabled,en.a.unblended,en.b5.frontCW,eE,"skyboxCapture",eu.skyboxGeometry.vertexBuffer,eu.skyboxGeometry.indexBuffer,eu.skyboxGeometry.segment)}let tb=en.bW([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);let Xo=class Xo{constructor(el){let eu=new en.bY;eu.emplaceBack(-1,1,1,0,0),eu.emplaceBack(1,1,1,1,0),eu.emplaceBack(1,-1,1,1,1),eu.emplaceBack(-1,-1,1,0,1);let ec=new en.bp;ec.emplaceBack(0,1,2),ec.emplaceBack(2,3,0),this.vertexBuffer=el.createVertexBuffer(eu,tb.members),this.indexBuffer=el.createIndexBuffer(ec),this.segments=en.bm.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}};let tw=en.bW([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);let Yo=class Yo{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15}};let Ko=class Ko{constructor(el){this.colorModeAlphaBlendedWriteRGB=new en.a([en.bZ,en.b_,en.bZ,en.b_],en.C.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new en.a([en.bZ,en.b$,en.bZ,en.b$],en.C.transparent,[!1,!1,!1,!0]),this.params=new Yo,this.allocatedStarsCount=0,el.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1}),el.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01})}update(el){let eu=el.context;if(!this.atmosphereBuffer||this.allocatedStarsCount!==this.params.starsCount){this.atmosphereBuffer=new Xo(eu),this.allocatedStarsCount=this.params.starsCount;let el=function(el){let eu=en.c2(30),ec=[];for(let ed=0;ed<el;++ed){let el=2*Math.PI*eu(),ed=Math.acos(1-2*eu())-.5*Math.PI;ec.push(en.v.fromValues(Math.cos(ed)*Math.cos(el),Math.cos(ed)*Math.sin(el),Math.sin(ed)))}return ec}(this.allocatedStarsCount),ec=en.c2(300),ed=new en.c0,ef=new en.bp,em=0;for(let eu=0;eu<el.length;++eu){let e_=en.v.scale([],el[eu],200),ew=Math.max(0,1+1*(1*ec()-.5)),eT=Math.max(0,1+2*(1*ec()-.5));ed.emplaceBack(e_[0],e_[1],e_[2],-1,-1,ew,eT),ed.emplaceBack(e_[0],e_[1],e_[2],1,-1,ew,eT),ed.emplaceBack(e_[0],e_[1],e_[2],1,1,ew,eT),ed.emplaceBack(e_[0],e_[1],e_[2],-1,1,ew,eT),ef.emplaceBack(em+0,em+1,em+2),ef.emplaceBack(em+0,em+2,em+3),em+=4}this.starsVx=eu.createVertexBuffer(ed,tw.members),this.starsIdx=eu.createIndexBuffer(ef),this.starsSegments=en.bm.simpleSegment(0,0,ed.length,ef.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(el,eu){let ec=el.context,ed=ec.gl,ef=el.transform,em=new en.b4(ed.LEQUAL,en.b4.ReadOnly,[0,1]),e_=en.ao(ef.zoom),ew=eu.properties.get("color").toArray01(),eT=eu.properties.get("high-color").toArray01(),eM=eu.properties.get("space-color").toArray01PremultipliedAlpha(),eE=en.c1(eu.properties.get("horizon-blend"),0,1,5e-4,.25),eS=en.bb(el,ec,ef)&&5e-4===eE?ef.worldSize/(2*Math.PI*1.025)-1:ef.globeRadius,eA=el.frameCounter/1e3%1,eI=en.v.length(ef.globeCenterInViewSpace),eC=Math.sqrt(Math.pow(eI,2)-Math.pow(eS,2)),eP=Math.acos(eC/eI),v=eu=>{var eS,eI,eC;let ez="globe"===ef.projection.name?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];eu&&ez.push("ALPHA_PASS");let eD=el.getOrCreateProgram("globeAtmosphere",{defines:ez}),eL=(eS=ef.frustumCorners.TL,eI=ef.frustumCorners.TR,eC=ef.frustumCorners.BR,{u_frustum_tl:eS,u_frustum_tr:eI,u_frustum_br:eC,u_frustum_bl:ef.frustumCorners.BL,u_horizon:ef.frustumCorners.horizon,u_transition:e_,u_fadeout_range:eE,u_color:ew,u_high_color:eT,u_space_color:eM,u_temporal_offset:eA,u_horizon_angle:eP});el.uploadCommonUniforms(ec,eD);let ek=this.atmosphereBuffer;ek&&eD.draw(el,ed.TRIANGLES,em,en.b6.disabled,eu?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,en.b5.backCW,eL,eu?"atmosphere_glow_alpha":"atmosphere_glow",ek.vertexBuffer,ek.indexBuffer,ek.segments)};v(!1),v(!0)}drawStars(el,eu){let ec=en.c(eu.properties.get("star-intensity"),0,1);if(0===ec)return;let ed=el.context,ef=ed.gl,em=el.transform,e_=el.getOrCreateProgram("stars"),ew=en.q.identity([]);en.q.rotateX(ew,ew,-em._pitch),en.q.rotateZ(ew,ew,-em.angle),en.q.rotateX(ew,ew,en.d(em._center.lat)),en.q.rotateY(ew,ew,-en.d(em._center.lng));let eT=en.m.fromQuat(new Float32Array(16),ew),eM=en.m.multiply([],em.starsProjMatrix,eT),eE=en.bx.fromMat4([],eT),eS=en.bx.invert([],eE),eA=[0,1,0];en.v.transformMat3(eA,eA,eS),en.v.scale(eA,eA,this.params.sizeMultiplier);let eI=[1,0,0];en.v.transformMat3(eI,eI,eS),en.v.scale(eI,eI,this.params.sizeMultiplier);let eC={u_matrix:Float32Array.from(eM),u_up:eA,u_right:eI,u_intensity_multiplier:ec};el.uploadCommonUniforms(ed,e_),this.starsVx&&this.starsIdx&&e_.draw(el,ef.TRIANGLES,en.b4.disabled,en.b6.disabled,this.colorModeAlphaBlendedWriteRGB,en.b5.disabled,eC,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}};function Qo(el,eu){let ec=[...el],ed=eu.cameraWorldSizeForFog/eu.worldSize,ef=en.m.identity([]);return en.m.scale(ef,ef,[ed,ed,1]),en.m.multiply(ec,ef,ec),en.m.multiply(ec,eu.worldToFogMatrix,ec),ec}function er(en,el,eu,ec){let ed=eu.material,ef=ec.context,{baseColorTexture:em,metallicRoughnessTexture:e_}=ed.pbrMetallicRoughness,{normalTexture:ew,occlusionTexture:eT,emissionTexture:eM}=ed;function _(el,eu,ec){if(el&&(en.push(eu),ef.activeTexture.set(ef.gl.TEXTURE0+ec),el.gfxTexture)){let{minFilter:en,magFilter:eu,wrapS:ec,wrapT:ed}=el.sampler;el.gfxTexture.bindExtraParam(en,eu,ec,ed)}}_(em,"HAS_TEXTURE_u_baseColorTexture",e2.BaseColor),_(e_,"HAS_TEXTURE_u_metallicRoughnessTexture",e2.MetallicRoughness),_(ew,"HAS_TEXTURE_u_normalTexture",e2.Normal),_(eT,"HAS_TEXTURE_u_occlusionTexture",e2.Occlusion),_(eM,"HAS_TEXTURE_u_emissionTexture",e2.Emission),eu.texcoordBuffer&&(en.push("HAS_ATTRIBUTE_a_uv_2f"),el.push(eu.texcoordBuffer)),eu.colorBuffer&&(en.push(12===eu.colorBuffer.itemSize?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),el.push(eu.colorBuffer)),eu.normalBuffer&&(en.push("HAS_ATTRIBUTE_a_normal_3f"),el.push(eu.normalBuffer)),eu.pbrBuffer&&(en.push("HAS_ATTRIBUTE_a_pbr"),en.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),el.push(eu.pbrBuffer)),"OPAQUE"!==ed.alphaMode&&"MASK"!==ed.alphaMode||en.push("UNPREMULT_TEXTURE_IN_SHADER"),ed.defined||en.push("DIFFUSE_SHADED"),en.push("USE_STANDARD_DERIVATIVES")}function tr(el,eu,ec,ed,ef,em){let e_;let ew=ec.paint.get("model-opacity"),eT=eu.context,eM=new en.b4(eu.context.gl.LEQUAL,en.b4.ReadWrite,eu.depthRangeFor3D),eE=eu.transform,eS=el.mesh,eA=eS.material,eI=eA.pbrMetallicRoughness,eC=eu.style.fog;e_="pixels"===eu.transform.projection.zAxisUnit?[...el.nodeModelMatrix]:en.m.multiply([],ed.zScaleMatrix,el.nodeModelMatrix),en.m.multiply(e_,ed.negCameraPosMatrix,e_);let eP=en.m.invert([],e_);en.m.transpose(eP,eP);let ez=ec.paint.get("model-emissive-strength").constantOr(0),eD=uo(new Float32Array(el.worldViewProjection),new Float32Array(e_),new Float32Array(eP),eu,ew,eI.baseColorFactor,eA.emissiveFactor,eI.metallicFactor,eI.roughnessFactor,eA,ez,ec),eL={defines:[]},ek=[];er(eL.defines,ek,eS,eu);let eR=eu.shadowRenderer;eR&&(eR.useNormalOffset=!1);let eO=null;if(eC){let en=Qo(el.nodeModelMatrix,eu.transform);if(eO=new Float32Array(en),"globe"!==eE.projection.name){let el=eS.aabb.min,eu=eS.aabb.max,[ec,ed]=eC.getOpacityForBounds(en,el[0],el[1],eu[0],eu[1]);eL.overrideFog=ec>=.05||ed>=.05}}let eB=Ii(eu,ec.paint.get("model-cutoff-fade-range"));eB.shouldRenderCutoff&&eL.defines.push("RENDER_CUTOFF");let eF=eu.getOrCreateProgram("model",eL);eu.uploadCommonUniforms(eT,eF,null,eO,eB),"shadow"!==eu.renderPass&&eR&&eR.setupShadowsFromMatrix(el.nodeModelMatrix,eF),eF.draw(eu,eT.gl.TRIANGLES,eM,ef,em,eS.material.doubleSided?en.b5.disabled:en.b5.backCCW,eD,ec.id,eS.vertexBuffer,eS.indexBuffer,eS.segments,ec.paint,eu.transform.zoom,void 0,ek)}function or(el,eu,ec,ed){let ef=ec.shadowRenderer;if(!ef)return;let em=ef.getShadowPassDepthMode(),e_=ef.getShadowPassColorMode(),ew=ef.calculateShadowPassMatrixFromMatrix(eu),eT=mo(ew);ec.getOrCreateProgram("modelDepth",{defines:["DEPTH_TEXTURE"]}).draw(ec,ec.context.gl.TRIANGLES,em,en.b6.disabled,e_,en.b5.backCCW,eT,ed.id,el.vertexBuffer,el.indexBuffer,el.segments,ed.paint,ec.transform.zoom,void 0,void 0)}let tT={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new en.c3([0,0,0],[en.J,en.J,0])},tM=[1,-1,1];let hr=class hr{};let _r=class _r{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(el,eu,ec){{let en=this._storage.get(eu.id);if(en)return en.lastUsedFrameIdx=el,en.buf}let ed=ec.gl,ef=ed.getBufferParameter(ed.ELEMENT_ARRAY_BUFFER,ed.BUFFER_SIZE),em=new ArrayBuffer(ef),e_=new Int16Array(em);ed.getBufferSubData(ed.ELEMENT_ARRAY_BUFFER,0,new Int16Array(em));let ew=new en.c9;for(let en=0;en<ef/2;en+=3){let el=e_[en],eu=e_[en+1],ec=e_[en+2];ew.emplaceBack(el,eu),ew.emplaceBack(eu,ec),ew.emplaceBack(ec,el)}let eT=ec.bindVertexArrayOES.current,eM=new hr;return eM.buf=new en.I(ec,ew),eM.lastUsedFrameIdx=el,this._storage.set(eu.id,eM),ec.bindVertexArrayOES.set(eT),eM.buf}update(en){for(let[el,eu]of this._storage)en-eu.lastUsedFrameIdx>30&&(eu.buf.destroy(),this._storage.delete(el))}destroy(){for(let[en,el]of this._storage)el.buf.destroy(),this._storage.delete(en)}};let dr=class dr{registerParameter(en,el,eu,ec,ed){}registerButton(en,el,eu){}};let tE={symbol:function(el,eu,ec,ed,ef){if("translucent"!==el.renderPass)return;let em=en.b6.disabled,e_=el.colorModeForRenderPass();ec.layout.get("text-variable-anchor")&&function(el,eu,ec,ed,ef,em,e_){let ew=eu.transform,eT="map"===ef,eM="map"===em;for(let eu of el){let el=ed.getTile(eu),ef=el.getBucket(ec);if(!ef||!ef.text||!ef.text.segments.get().length)continue;let em=en.i(ef.textSizeData,ew.zoom),eE=St(eu,ef.getProjection(),ew),eS=ew.calculatePixelsToTileUnitsMatrix(el),eA=pe(eE,el.tileID.canonical,eM,eT,ew,ef.getProjection(),eS),eI=ef.hasIconTextFit()&&ef.hasIconData();if(em){let ec=Math.pow(2,ew.zoom-el.tileID.overscaledZ);(function(el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE){let eS=el.text.placedSymbolArray,eA=el.text.dynamicLayoutVertexArray,eI=el.icon.dynamicLayoutVertexArray,eC={},eP=el.getProjection(),ez=St(ew,eP,em),eD=em.elevation,eL=eP.upVectorScale(ew.canonical,em.center.lat,em.worldSize).metersToTile;eA.clear();for(let eI=0;eI<eS.length;eI++){let ek=eS.get(eI),{tileAnchorX:eR,tileAnchorY:eO,numGlyphs:eB}=ek,eF=ek.hidden||!ek.crossTileID||el.allowVerticalPlacement&&!ek.placedOrientation?null:ed[ek.crossTileID];if(eF){let ed=0,eS=0,eI=0;if(eD){let en=eD?eD.getAtTileOffset(ew,eR,eO):0,[el,eu,ec]=eP.upVector(ew.canonical,eR,eO);ed=en*el*eL,eS=en*eu*eL,eI=en*ec*eL}let[eN,eU,eV,ej]=ge(ek.projectedAnchorX+ed,ek.projectedAnchorY+eS,ek.projectedAnchorZ+eI,ec?ez:e_),eG=ve(em.getCameraToCenterDistance(eP),ej),eq=ef.evaluateSizeForFeature(el.textSizeData,eM,ek)*eG/en.aV;ec&&(eq*=el.tilePixelRatio/eT);let eZ=function({width:el,height:eu,anchor:ec,textOffset:ed,textScale:ef},em){let{horizontalAlign:e_,verticalAlign:ew}=en.aY(ec),eT=en.aW(ec,ed);return new en.P((-(e_-.5)*el/ef+eT[0])*em,(-(ew-.5)*eu/ef+eT[1])*em)}(eF,eq);ec?({x:eN,y:eU,z:eV}=eP.projectTilePoint(eR+eZ.x,eO+eZ.y,ew.canonical),[eN,eU,eV]=ge(eN+ed,eU+eS,eV+eI,e_)):(eu&&eZ._rotate(-em.angle),eN+=eZ.x,eU+=eZ.y,eV=0);let e$=el.allowVerticalPlacement&&ek.placedOrientation===en.W.vertical?Math.PI/2:0;for(let el=0;el<eB;el++)en.k(eA,eN,eU,eV,e$);eE&&ek.associatedIconIndex>=0&&(eC[ek.associatedIconIndex]={x:eN,y:eU,z:eV,angle:e$})}else Se(eB,eA)}if(eE){eI.clear();let eu=el.icon.placedSymbolArray;for(let el=0;el<eu.length;el++){let ec=eu.get(el),{numGlyphs:ed}=ec,ef=eC[el];if(ec.hidden||!ef)Se(ed,eI);else{let{x:el,y:eu,z:ec,angle:em}=ef;for(let ef=0;ef<ed;ef++)en.k(eI,el,eu,ec,em)}}el.icon.dynamicLayoutVertexBuffer.updateData(eI)}el.text.dynamicLayoutVertexBuffer.updateData(eA)})(ef,eT,eM,e_,en.bG,ew,eA,eu,ec,em,eI)}}}(ed,el,ec,eu,ec.layout.get("text-rotation-alignment"),ec.layout.get("text-pitch-alignment"),ef),0!==ec.paint.get("icon-opacity").constantOr(1)&&To(el,eu,ec,ed,!1,ec.paint.get("icon-translate"),ec.paint.get("icon-translate-anchor"),ec.layout.get("icon-rotation-alignment"),ec.layout.get("icon-pitch-alignment"),ec.layout.get("icon-keep-upright"),ec.paint.get("icon-color-saturation"),em,e_),0!==ec.paint.get("text-opacity").constantOr(1)&&To(el,eu,ec,ed,!0,ec.paint.get("text-translate"),ec.paint.get("text-translate-anchor"),ec.layout.get("text-rotation-alignment"),ec.layout.get("text-pitch-alignment"),ec.layout.get("text-keep-upright"),ec.paint.get("icon-color-saturation"),em,e_),eu.map.showCollisionBoxes&&(vo(el,eu,ec,ed,ec.paint.get("text-translate"),ec.paint.get("text-translate-anchor"),!0),vo(el,eu,ec,ed,ec.paint.get("icon-translate"),ec.paint.get("icon-translate-anchor"),!1))},circle:function(el,eu,ec,ed){if("translucent"!==el.renderPass)return;let ef=ec.paint.get("circle-opacity"),em=ec.paint.get("circle-stroke-width"),e_=ec.paint.get("circle-stroke-opacity"),ew=void 0!==ec.layout.get("circle-sort-key").constantOr(1),eT=ec.paint.get("circle-emissive-strength");if(0===ef.constantOr(1)&&(0===em.constantOr(1)||0===e_.constantOr(1)))return;let eM=el.context,eE=eM.gl,eS=el.transform,eA=el.depthModeForSublayer(0,en.b4.ReadOnly),eI=en.b6.disabled,eC=el.colorModeForDrapableLayerRenderPass(eT),eP="globe"===eS.projection.name,ez=[en.E(eS.center.lng),en.H(eS.center.lat)],eD=[];for(let ef=0;ef<ed.length;ef++){let em=ed[ef],e_=eu.getTile(em),eT=e_.getBucket(ec);if(!eT||eT.projection.name!==eS.projection.name)continue;let eM=eT.programConfigurations.get(ec.id),eE=en.bH(ec),eA=el.isTileAffectedByFog(em);eP&&eE.push("PROJECTION_GLOBE_VIEW");let eI=el.getOrCreateProgram("circle",{config:eM,defines:eE,overrideFog:eA}),eC=eT.layoutVertexBuffer,eL=eT.globeExtVertexBuffer,ek=eT.indexBuffer,eR=eS.projection.createInversionMatrix(eS,em.canonical),eO={programConfiguration:eM,program:eI,layoutVertexBuffer:eC,globeExtVertexBuffer:eL,indexBuffer:ek,uniformValues:en.bI(el,em,e_,eR,ez,ec),tile:e_};if(ew){let el=eT.segments.get();for(let eu of el)eD.push({segments:new en.bm([eu]),sortKey:eu.sortKey,state:eO})}else eD.push({segments:eT.segments,sortKey:0,state:eO})}ew&&eD.sort((en,el)=>en.sortKey-el.sortKey);let eL={useDepthForOcclusion:eS.depthOcclusionForSymbolsAndCircles};for(let eu of eD){let{programConfiguration:ed,program:ef,layoutVertexBuffer:em,globeExtVertexBuffer:e_,indexBuffer:ew,uniformValues:eT,tile:eP}=eu.state,ez=eu.segments;el.terrain&&el.terrain.setupElevationDraw(eP,ef,eL),el.uploadCommonUniforms(eM,ef,eP.tileID.toUnwrapped()),ef.draw(el,eE.TRIANGLES,eA,eI,eC,en.b5.disabled,eT,ec.id,em,ew,ez,ec.paint,eS.zoom,ed,[e_])}},heatmap:function(el,eu,ec,ed){if(0!==ec.paint.get("heatmap-opacity")){if("offscreen"===el.renderPass){let ef=el.context,em=ef.gl,e_=en.b6.disabled,ew=new en.a([em.ONE,em.ONE,em.ONE,em.ONE],en.C.transparent,[!0,!0,!0,!0]);(function(en,el,eu,ec){let ed=en.gl,ef=el.width*ec,em=el.height*ec;en.activeTexture.set(ed.TEXTURE1),en.viewport.set([0,0,ef,em]);let e_=eu.heatmapFbo;if(!e_||e_&&(e_.width!==ef||e_.height!==em)){e_&&e_.destroy();let el=ed.createTexture();ed.bindTexture(ed.TEXTURE_2D,el),ed.texParameteri(ed.TEXTURE_2D,ed.TEXTURE_WRAP_S,ed.CLAMP_TO_EDGE),ed.texParameteri(ed.TEXTURE_2D,ed.TEXTURE_WRAP_T,ed.CLAMP_TO_EDGE),ed.texParameteri(ed.TEXTURE_2D,ed.TEXTURE_MIN_FILTER,ed.LINEAR),ed.texParameteri(ed.TEXTURE_2D,ed.TEXTURE_MAG_FILTER,ed.LINEAR),e_=eu.heatmapFbo=en.createFramebuffer(ef,em,!0,null),function(en,el,eu,ec,ed,ef){let em=en.gl;em.texImage2D(em.TEXTURE_2D,0,en.extRenderToTextureHalfFloat?em.RGBA16F:em.RGBA,ed,ef,0,em.RGBA,en.extRenderToTextureHalfFloat?em.HALF_FLOAT:em.UNSIGNED_BYTE,null),ec.colorAttachment.set(eu)}(en,0,el,e_,ef,em)}else ed.bindTexture(ed.TEXTURE_2D,e_.colorAttachment.get()),en.bindFramebuffer.set(e_.framebuffer)})(ef,el,ec,"globe"===el.transform.projection.name?.5:.25),ef.clear({color:en.C.transparent});let eT=el.transform,eM="globe"===eT.projection.name,eE=eM?["PROJECTION_GLOBE_VIEW"]:[],eS=eM?en.b5.frontCCW:en.b5.disabled,eA=[en.E(eT.center.lng),en.H(eT.center.lat)];for(let eI=0;eI<ed.length;eI++){let eC=ed[eI];if(eu.hasRenderableParent(eC))continue;let eP=eu.getTile(eC),ez=eP.getBucket(ec);if(!ez||ez.projection.name!==eT.projection.name)continue;let eD=el.isTileAffectedByFog(eC),eL=ez.programConfigurations.get(ec.id),ek=el.getOrCreateProgram("heatmap",{config:eL,defines:eE,overrideFog:eD}),{zoom:eR}=el.transform;el.terrain&&el.terrain.setupElevationDraw(eP,ek),el.uploadCommonUniforms(ef,ek,eC.toUnwrapped());let eO=eT.projection.createInversionMatrix(eT,eC.canonical);ek.draw(el,em.TRIANGLES,en.b4.disabled,e_,ew,eS,eo(el,eC,eP,eO,eA,eR,ec.paint.get("heatmap-intensity")),ec.id,ez.layoutVertexBuffer,ez.indexBuffer,ez.segments,ec.paint,el.transform.zoom,eL,eM?[ez.globeExtVertexBuffer]:null)}ef.viewport.set([0,0,el.width,el.height])}else"translucent"===el.renderPass&&(el.context.setColorMode(el.colorModeForRenderPass()),function(el,eu){let ec=el.context,ed=ec.gl,ef=eu.heatmapFbo;if(!ef)return;ec.activeTexture.set(ed.TEXTURE0),ed.bindTexture(ed.TEXTURE_2D,ef.colorAttachment.get()),ec.activeTexture.set(ed.TEXTURE1);let em=eu.colorRampTexture;em||(em=eu.colorRampTexture=new en.a9(ec,eu.colorRamp,ed.RGBA)),em.bind(ed.LINEAR,ed.CLAMP_TO_EDGE),el.getOrCreateProgram("heatmapTexture").draw(el,ed.TRIANGLES,en.b4.disabled,en.b6.disabled,el.colorModeForRenderPass(),en.b5.disabled,{u_image:0,u_color_ramp:1,u_opacity:eu.paint.get("heatmap-opacity")},eu.id,el.viewportBuffer,el.quadTriangleIndexBuffer,el.viewportSegments,eu.paint,el.transform.zoom)}(el,ec))}},line:function(el,eu,ec,ed){if("translucent"!==el.renderPass)return;let ef=ec.paint.get("line-opacity"),em=ec.paint.get("line-width");if(0===ef.constantOr(1)||0===em.constantOr(1))return;let e_=ec.paint.get("line-emissive-strength"),ew=el.depthModeForSublayer(0,en.b4.ReadOnly),eT=el.colorModeForDrapableLayerRenderPass(e_),eM=el.terrain&&el.terrain.renderingToTexture?1:en.a4.devicePixelRatio,eE=ec.paint.get("line-dasharray"),eS=eE.constantOr(1),eA=ec.layout.get("line-cap"),eI=ec.paint.get("line-pattern"),eC=eI.constantOr(1),eP=ec.paint.get("line-pattern").constantOr(1),ez=1!==ec.paint.get("line-opacity").constantOr(1),eD=!eP&&ez,eL=ec.paint.get("line-gradient"),ek=eC?"linePattern":"line",eR=el.context,eO=eR.gl,eB=en.bJ(ec);for(let ef of(el.terrain&&el.terrain.clipOrMaskOverlapStencilType()&&(eD=!1),ed)){let ed=eu.getTile(ef);if(eC&&!ed.patternsLoaded())continue;let em=ed.getBucket(ec);if(!em)continue;el.prepareDrawTile();let e_=em.programConfigurations.get(ec.id),eP=el.isTileAffectedByFog(ef),ez=el.getOrCreateProgram(ek,{config:e_,defines:eB,overrideFog:eP}),eF=eI.constantOr(null);if(eF&&ed.imageAtlas){let en=ed.imageAtlas.patternPositions[eF.toString()];en&&e_.setConstantPatternPositions(en)}let eN=eE.constantOr(null),eU=eA.constantOr(null);if(!eC&&eN&&eU&&ed.lineAtlas){let en=ed.lineAtlas.getDash(eN,eU);en&&e_.setConstantPatternPositions(en)}let[eV,ej]=ec.paint.get("line-trim-offset");("round"===eU||"square"===eU)&&eV!==ej&&(0===eV&&(eV-=1),1===ej&&(ej+=1));let eG=el.terrain?ef.projMatrix:null,eq=eC?en.bK(el,ed,ec,eG,eM):en.bL(el,ed,ec,eG,em.lineClipsArray.length,eM,[eV,ej]);if(eL){let ed=em.gradients[ec.id],e_=ed.texture;if(ec.gradientVersion!==ed.version){let ew=256;if(ec.stepInterpolant){let ec=eu.getSource().maxzoom,ed=ef.canonical.z===ec?Math.ceil(1<<el.transform.maxZoom-ef.canonical.z):1;ew=en.c(en.bM(em.maxLineLength/en.J*1024*ed),256,eR.maxTextureSize)}ed.gradient=en.bN({expression:ec.gradientExpression(),evaluationKey:"lineProgress",resolution:ew,image:ed.gradient||void 0,clips:em.lineClipsArray}),ed.texture?ed.texture.update(ed.gradient):ed.texture=new en.a9(eR,ed.gradient,eO.RGBA),ed.version=ec.gradientVersion,e_=ed.texture}eR.activeTexture.set(eO.TEXTURE1),e_.bind(ec.stepInterpolant?eO.NEAREST:eO.LINEAR,eO.CLAMP_TO_EDGE)}eS&&(eR.activeTexture.set(eO.TEXTURE0),ed.lineAtlasTexture&&ed.lineAtlasTexture.bind(eO.LINEAR,eO.REPEAT),e_.updatePaintBuffers()),eC&&(eR.activeTexture.set(eO.TEXTURE0),ed.imageAtlasTexture&&ed.imageAtlasTexture.bind(eO.LINEAR,eO.CLAMP_TO_EDGE),e_.updatePaintBuffers()),el.uploadCommonUniforms(eR,ez,ef.toUnwrapped());let D=eu=>{ez.draw(el,eO.TRIANGLES,ew,eu,eT,en.b5.disabled,eq,ec.id,em.layoutVertexBuffer,em.indexBuffer,em.segments,ec.paint,el.transform.zoom,e_,[em.layoutVertexBuffer2])};if(eD){let eu=el.stencilModeForClipping(ef).ref;0===eu&&el.terrain&&eR.clear({stencil:0});let ec={func:eO.EQUAL,mask:255};eq.u_alpha_discard_threshold=.8,D(new en.b6(ec,eu,255,eO.KEEP,eO.KEEP,eO.INVERT)),eq.u_alpha_discard_threshold=0,D(new en.b6(ec,eu,255,eO.KEEP,eO.KEEP,eO.KEEP))}else D(el.stencilModeForClipping(ef))}eD&&(el.resetStencilClippingMasks(),el.terrain&&eR.clear({stencil:0}))},fill:function(el,eu,ec,ed){let ef=ec.paint.get("fill-color"),em=ec.paint.get("fill-opacity");if(0===em.constantOr(1))return;let e_=ec.paint.get("fill-emissive-strength"),ew=el.colorModeForDrapableLayerRenderPass(e_),eT=ec.paint.get("fill-pattern"),eM=el.opaquePassEnabledForLayer()&&!eT.constantOr(1)&&1===ef.constantOr(en.C.transparent).a&&1===em.constantOr(0)?"opaque":"translucent";if(el.renderPass===eM){let ef=el.depthModeForSublayer(1,"opaque"===el.renderPass?en.b4.ReadWrite:en.b4.ReadOnly);Co(el,eu,ec,ed,ef,ew,!1)}if("translucent"===el.renderPass&&ec.paint.get("fill-antialias")){let ef=el.depthModeForSublayer(ec.getPaintProperty("fill-outline-color")?2:0,en.b4.ReadOnly);Co(el,eu,ec,ed,ef,ew,!0)}},"fill-extrusion":function(el,eu,ec,ed){let ef=ec.paint.get("fill-extrusion-opacity"),em=el.context,e_=em.gl,ew=el.terrain,eT=ew&&ew.renderingToTexture;if(0===ef)return;let eM=el.conflationActive&&el.layerUsedInConflation(ec,eu.getSource());if(eM&&function(en,el,eu,ec){for(let ed of ec){let ec=el.getTile(ed).getBucket(eu);ec&&(ec.updateReplacement(ed,en.replacementSource),ec.uploadCentroid(en.context))}}(el,eu,ec,ed),ew||eM)for(let ef of ed){let ed=eu.getTile(ef).getBucket(ec);ed&&function(el,eu,ec,ed,ef,em,e_){0===ed.centroidVertexArray.length&&ed.createCentroidsBuffer();let ew=em?em.findDEMTileFor(ec):null;if(!(ew&&ew.dem||e_))return;let c=el=>new en.P(Math.ceil((el+en.bS)*en.bT),0),h=en=>{let el=eu.getSource().minzoom,o=en=>{let el=eu.getTileByID(en);if(el&&el.hasData())return el.getBucket(ef)};for(let eu of[0,-1,1]){if(en.overscaledZ+eu<el)continue;let ec=o(en.calculateScaledKey(en.overscaledZ+eu));if(ec)return ec}},eT=[0,0,0],d=(el,eu)=>(eT[0]=Math.min(el.min.y,eu.min.y),eT[1]=Math.max(el.max.y,eu.max.y),eT[2]=en.J-eu.min.x>el.max.x?eu.min.x-en.J:el.max.x,eT),u=(el,eu)=>(eT[0]=Math.min(el.min.x,eu.min.x),eT[1]=Math.max(el.max.x,eu.max.x),eT[2]=en.J-eu.min.y>el.max.y?eu.min.y-en.J:el.max.y,eT),eM=[(en,el)=>d(en,el),(en,el)=>d(el,en),(en,el)=>u(en,el),(en,el)=>u(el,en)],m=(el,eu,ed,ef,e_,eT,eM)=>{if(!em)return 0;let eE=[[eT?ed:el,eT?el:ed,0],[eT?ed:eu,eT?eu:ed,0]],eS=eM<0?en.J+eM:eM,eA=[eT?eS:(el+eu)/2,eT?(el+eu)/2:eS,0];return 0===ed&&eM<0||0!==ed&&eM>0?em.getForTilePoints(e_,[eA],!0,ef):eE.push(eA),em.getForTilePoints(ec,eE,!0,ew),Math.max(eE[0][2],eE[1][2],eA[2])/em.exaggeration()};for(let el=0;el<4;el++){let eu=ed.borderFeatureIndices[el];if(0===eu.length)continue;let ef=en.bP[el](ec),ew=h(ef);if(!(ew&&ew instanceof en.bQ)||ed.borderDoneWithNeighborZ[el]===ew.canonical.z)continue;0===ew.centroidVertexArray.length&&ew.createCentroidsBuffer();let eT=em?em.findDEMTileFor(ef):null;if(!(eT&&eT.dem||e_))continue;let eE=(el<2?1:5)-el,eS=ew.borderDoneWithNeighborZ[eE]!==ed.canonical.z,eA=ew.borderFeatureIndices[eE],eI=0;if(ed.canonical.z!==ew.canonical.z){for(let en of eu)ed.showCentroid(ed.featuresOnBorder[en]);if(eS)for(let en of eA)ew.showCentroid(ew.featuresOnBorder[en]);ed.borderDoneWithNeighborZ[el]=ew.canonical.z,ew.borderDoneWithNeighborZ[eE]=ed.canonical.z}for(let ec of eu){let eu;let em=ed.featuresOnBorder[ec],eS=ed.centroidData[em.centroidDataIndex],eC=em.borders[el];for(;eI<eA.length;){eu=ew.featuresOnBorder[eA[eI]];let en=eu.borders[eE];if(en[1]>eC[0]+3||en[0]>eC[0]-3)break;ew.showCentroid(eu),eI++}if(eu&&eI<eA.length){let ec=eI,eP=0;for(;!(eu.borders[eE][0]>eC[1]-3)&&(eP++,++eI!==eA.length);)eu=ew.featuresOnBorder[eA[eI]];if(eu=ew.featuresOnBorder[eA[ec]],eP>1){let en=eu.borders[eE];3>Math.abs(eC[0]-en[0])&&3>Math.abs(eC[1]-en[1])&&(eP=1,eI=ec+1)}else if(0===eP){ed.showCentroid(em);continue}let ez=ew.centroidData[eu.centroidDataIndex];e_&&1===eP&&((eS.flags|ez.flags)&en.bR?(eS.flags|=en.bR,ez.flags|=en.bR):(eS.flags&=~en.bR,ez.flags&=~en.bR));let eD=em.intersectsCount()>1||eu.intersectsCount()>1;if(eP>1)eI=ec,eS.centroidXY=ez.centroidXY=new en.P(0,0);else if(eT&&eT.dem&&!eD){let eu=eM[el](eS,ez),ec=el%2?en.J-1:0,ed=m(eu[0],Math.min(en.J-1,eu[1]),ec,eT,ef,el<2,eu[2]);eS.centroidXY=ez.centroidXY=c(ed)}else eD?eS.centroidXY=ez.centroidXY=new en.P(0,0):(eS.centroidXY=ed.encodeBorderCentroid(em),ez.centroidXY=ew.encodeBorderCentroid(eu));ed.writeCentroidToBuffer(eS),ew.writeCentroidToBuffer(ez)}else ed.showCentroid(em)}ed.borderDoneWithNeighborZ[el]=ew.canonical.z,ew.borderDoneWithNeighborZ[eE]=ed.canonical.z}(ed.needsCentroidUpdate||!ed.centroidVertexBuffer&&0!==ed.centroidVertexArray.length)&&ed.uploadCentroid(el)}(el.context,eu,ef,ed,ec,ew,eM)}if("shadow"===el.renderPass&&el.shadowRenderer){let em=el.shadowRenderer;if(ew&&ef<.65&&ec._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof en.am)return;let e_=em.getShadowPassDepthMode(),eT=em.getShadowPassColorMode();Io(el,eu,ec,ed,e_,en.b6.disabled,eT,eM)}else if("translucent"===el.renderPass){let eE=!ec.paint.get("fill-extrusion-pattern").constantOr(1),eS=ec.paint.get("fill-extrusion-color").constantOr(en.C.white);if(!eT&&0!==eS.a){let em=new en.b4(el.context.gl.LEQUAL,en.b4.ReadWrite,el.depthRangeFor3D);1===ef&&eE?Io(el,eu,ec,ed,em,en.b6.disabled,en.a.unblended,eM):(Io(el,eu,ec,ed,em,en.b6.disabled,en.a.disabled,eM),Io(el,eu,ec,ed,em,el.stencilModeFor3D(),el.colorModeForRenderPass(),eM),el.resetStencilClippingMasks())}if(el.style.enable3dLights()&&eE&&(!ew&&"globe"!==el.transform.projection.name||eT)){let ef=ec.paint.get("fill-extrusion-opacity"),eE=ec.paint.get("fill-extrusion-ambient-occlusion-intensity"),eS=ec.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),eA=ec.paint.get("fill-extrusion-flood-light-intensity"),eI=ec.paint.get("fill-extrusion-flood-light-color").toArray01().slice(0,3),eC=eE>0&&eS>0,eP=eA>0,g=(en,el,eu)=>(1-eu)*en+eu*el,v=em=>{let ew=el.depthModeForSublayer(1,en.b4.ReadOnly,e_.LEQUAL,!0),eT=ec.paint.get(em?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),eC=g(.1,3,eT),eP=el._showOverdrawInspector;if(!eP){let eT=new en.b6({func:e_.ALWAYS,mask:255},255,255,e_.KEEP,e_.KEEP,e_.REPLACE),eP=new en.a([e_.ONE,e_.ONE,e_.ONE,e_.ONE],en.C.transparent,[!1,!1,!1,!0],e_.MIN);So(el,eu,ec,ed,ew,eT,eP,en.b5.disabled,em,"sdf",ef,eE,eS,eA,eI,eC,eM,!1)}{let eT=eP?en.b6.disabled:new en.b6({func:e_.EQUAL,mask:255},255,255,e_.KEEP,e_.DECR,e_.DECR),ez=eP?el.colorModeForRenderPass():new en.a([e_.ONE_MINUS_DST_ALPHA,e_.DST_ALPHA,e_.ONE,e_.ONE],en.C.transparent,[!0,!0,!0,!0]);So(el,eu,ec,ed,ew,eT,ez,en.b5.disabled,em,"color",ef,eE,eS,eA,eI,eC,eM,!1)}};if(eT){let c=(em,ew,eT)=>{let eC=el.depthModeForSublayer(1,en.b4.ReadOnly,e_.LEQUAL,!1),eP=ec.paint.get(em?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),ez=g(.1,3,eP);{let eT=new en.a([e_.ONE,e_.ONE,e_.ONE,e_.ONE],en.C.transparent,[!1,!1,!1,!0]);So(el,eu,ec,ed,eC,en.b6.disabled,eT,en.b5.disabled,em,"clear",ef,eE,eS,eA,eI,ez,eM,ew)}{let eT=new en.b6({func:e_.ALWAYS,mask:255},255,255,e_.KEEP,e_.KEEP,e_.REPLACE),eP=new en.a([e_.ONE,e_.ONE,e_.ONE,e_.ONE],en.C.transparent,[!1,!1,!1,!0],e_.MIN);So(el,eu,ec,ed,eC,eT,eP,en.b5.disabled,em,"sdf",ef,eE,eS,eA,eI,ez,eM,ew)}{let eT=em?e_.ZERO:e_.ONE_MINUS_DST_ALPHA,eP=new en.b6({func:e_.EQUAL,mask:255},255,255,e_.KEEP,e_.DECR,e_.DECR),eD=new en.a([eT,e_.DST_ALPHA,e_.ONE_MINUS_DST_ALPHA,e_.ZERO],en.C.transparent,[!0,!0,!0,!0]);So(el,eu,ec,ed,eC,eP,eD,en.b5.disabled,em,"color",ef,eE,eS,eA,eI,ez,eM,ew)}{let eP=new en.a([e_.ONE,e_.ONE,e_.ONE,em?e_.ZERO:e_.ONE],en.C.transparent,[!1,!1,!1,!0],em?e_.FUNC_ADD:e_.MAX);So(el,eu,ec,ed,eC,en.b6.disabled,eP,en.b5.disabled,em,"clear",ef,eE,eS,eA,eI,ez,eM,ew,eT)}};if(eC||eP){let eu;if(el.prepareDrawTile(),ew){let el=ew.drapeBufferSize[0],ec=ew.drapeBufferSize[1];(eu=ew.framebufferCopyTexture)&&(!eu||eu.size[0]===el&&eu.size[1]===ec)||(eu&&eu.destroy(),eu=ew.framebufferCopyTexture=new en.a9(em,new en.a5({width:el,height:ec}),e_.RGBA)),eu.bind(e_.LINEAR,e_.CLAMP_TO_EDGE),e_.copyTexImage2D(e_.TEXTURE_2D,0,e_.RGBA,0,0,el,ec,0)}eC&&c(!0,!1,eu),eP&&c(!1,!0,eu)}}else eC&&v(!0),eP&&v(!1)}}},hillshade:function(el,eu,ec,ed){if("offscreen"!==el.renderPass&&"translucent"!==el.renderPass||el.style.disableElevatedTerrain)return;let ef=el.context,em=el.terrain&&el.terrain.renderingToTexture,[e_,ew]="translucent"!==el.renderPass||em?[{},ed]:el.stencilConfigForOverlap(ed);for(let ed of ew){let ef=eu.getTile(ed);if(ef.needsHillshadePrepare&&"offscreen"===el.renderPass)!function(el,eu,ec){let ed=el.context,ef=ed.gl;if(!eu.dem)return;let em=eu.dem;if(ed.activeTexture.set(ef.TEXTURE1),bi(el,eu,em),!eu.demTexture)return;eu.demTexture.bind(ef.NEAREST,ef.CLAMP_TO_EDGE);let e_=em.dim;ed.activeTexture.set(ef.TEXTURE0);let ew=eu.hillshadeFBO;if(!ew){let el=new en.a9(ed,{width:e_,height:e_,data:null},ef.RGBA);el.bind(ef.LINEAR,ef.CLAMP_TO_EDGE),(ew=eu.hillshadeFBO=ed.createFramebuffer(e_,e_,!0,"renderbuffer")).colorAttachment.set(el.texture)}ed.bindFramebuffer.set(ew.framebuffer),ed.viewport.set([0,0,e_,e_]);let{tileBoundsBuffer:eT,tileBoundsIndexBuffer:eM,tileBoundsSegments:eE}=el.getMercatorTileBoundsBuffers(),eS=[];el.linearFloatFilteringSupported()&&eS.push("TERRAIN_DEM_FLOAT_FORMAT"),el.getOrCreateProgram("hillshadePrepare",{defines:eS}).draw(el,ef.TRIANGLES,en.b4.disabled,en.b6.disabled,en.a.unblended,en.b5.disabled,((el,eu)=>{let ec=eu.stride,ed=en.m.create();return en.m.ortho(ed,0,en.J,-en.J,0,0,1),en.m.translate(ed,ed,[0,-en.J,0]),{u_matrix:ed,u_image:1,u_dimension:[ec,ec],u_zoom:el.overscaledZ}})(eu.tileID,em),ec.id,eT,eM,eE),eu.needsHillshadePrepare=!1}(el,ef,ec);else if("translucent"===el.renderPass){let eu=el.depthModeForSublayer(0,en.b4.ReadOnly),ew=ec.paint.get("hillshade-emissive-strength"),eT=el.colorModeForDrapableLayerRenderPass(ew),eM=em&&el.terrain?el.terrain.stencilModeForRTTOverlap(ed):e_[ed.overscaledZ];!function(el,eu,ec,ed,ef,em,e_){let ew=el.context,eT=ew.gl,eM=ec.hillshadeFBO;if(!eM)return;el.prepareDrawTile();let eE=el.isTileAffectedByFog(eu),eS=el.getOrCreateProgram("hillshade",{overrideFog:eE});ew.activeTexture.set(eT.TEXTURE0),eT.bindTexture(eT.TEXTURE_2D,eM.colorAttachment.get());let eA=((el,eu,ec,ed)=>{let ef=ec.paint.get("hillshade-shadow-color"),em=ec.paint.get("hillshade-highlight-color"),e_=ec.paint.get("hillshade-accent-color"),ew=ec.paint.get("hillshade-emissive-strength"),eT=en.d(ec.paint.get("hillshade-illumination-direction"));if("viewport"===ec.paint.get("hillshade-illumination-anchor"))eT-=el.transform.angle;else if(el.style&&el.style.enable3dLights()&&el.style.directionalLight){let eu=el.style.directionalLight.properties.get("direction"),ec=en.b3(eu.x,eu.y,eu.z);eT=en.d(ec[1])}let eM=!el.options.moving;return{u_matrix:ed||el.transform.calculateProjMatrix(eu.tileID.toUnwrapped(),eM),u_image:0,u_latrange:function(el,eu){let ec=Math.pow(2,eu.canonical.z),ed=eu.canonical.y;return[new en.M(0,ed/ec).toLngLat().lat,new en.M(0,(ed+1)/ec).toLngLat().lat]}(0,eu.tileID),u_light:[ec.paint.get("hillshade-exaggeration"),eT],u_shadow:ef,u_highlight:em,u_emissive_strength:ew,u_accent:e_}})(el,ec,ed,el.terrain?eu.projMatrix:null);el.uploadCommonUniforms(ew,eS,eu.toUnwrapped());let{tileBoundsBuffer:eI,tileBoundsIndexBuffer:eC,tileBoundsSegments:eP}=el.getTileBoundsBuffers(ec);eS.draw(el,eT.TRIANGLES,ef,em,e_,en.b5.disabled,eA,ed.id,eI,eC,eP)}(el,ed,ef,ec,eu,eM,eT)}}ef.viewport.set([0,0,el.width,el.height]),el.resetStencilClippingMasks()},raster:function(el,eu,ec,ed,ef,em){if("translucent"!==el.renderPass||0===ec.paint.get("raster-opacity"))return;let e_=el.context,ew=e_.gl,eT=eu.getSource(),eM=function(el,eu,ec){let ed=el.paint.get("raster-color"),ef=[],em=el.paint.get("raster-resampling"),e_=el.paint.get("raster-color-mix"),ew=el.paint.get("raster-color-range"),eT=[e_[0],e_[1],e_[2],0],eM=e_[3],eE="nearest"===em?ec.NEAREST:ec.LINEAR;if(ed&&ef.push("RASTER_COLOR"),ed){eu.activeTexture.set(ec.TEXTURE2);let ed=el.colorRampTexture;ed||(ed=el.colorRampTexture=new en.a9(eu,el.colorRamp,ec.RGBA)),ed.bind(ec.LINEAR,ec.CLAMP_TO_EDGE)}return{mix:eT,range:ew,offset:eM,defines:ef,resampling:eE}}(ec,e_,ew),eE=eM.defines,eS="globe"===el.transform.projection.name,eA=!1;if(eT instanceof en.aK&&!ed.length){if(!eS)return;if(eT.onNorthPole)eA=!0,eE.push("GLOBE_POLES");else{if(!eT.onSouthPole)return;eA=!0,eE.push("GLOBE_POLES")}}let eI=ec.paint.get("raster-emissive-strength"),eC=el.colorModeForDrapableLayerRenderPass(eI),eP=el.terrain&&el.terrain.renderingToTexture,ez=eT instanceof en.aK&&0!==ec.paint.get("raster-elevation"),eD=!el.options.moving,eL="nearest"===ec.paint.get("raster-resampling")?ew.NEAREST:ew.LINEAR;if(eA){var ek,eR,eO,eB,eF;let ed;let ef=eu.getSource();if(!(ef instanceof en.aK))return;let em=ef.texture;if(!em)return;let eT=el.globeSharedBuffers;if(!eT)return;let eE=new en.b4(ew.LEQUAL,en.b4.ReadWrite,el.depthRangeFor3D),eS=Float32Array.from(el.transform.expandedFarZProjMatrix),eA=en.bj(0,0,el.transform),eP=Float32Array.from(en.bh(en.bi(new en.t(0,0,0))));el.terrain&&el.terrain.prepareDrawTile(),e_.activeTexture.set(ew.TEXTURE0),em.bind(eL,ew.CLAMP_TO_EDGE),e_.activeTexture.set(ew.TEXTURE1),em.bind(eL,ew.CLAMP_TO_EDGE),em.useMipmap&&e_.extTextureFilterAnisotropic&&el.transform.pitch>20&&ew.texParameterf(ew.TEXTURE_2D,e_.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,e_.extTextureFilterAnisotropicMax);let[ez,eD,eN,eU]=eT.getPoleBuffers(0,!0);ef.onNorthPole?(ed=ez,el.renderDefaultNorthPole=!1):(eA=en.m.scale(en.m.create(),eA,[1,-1,1]),ed=eD,el.renderDefaultSouthPole=!1);let eV=(ek=eA,eR=ec.paint.get("raster-elevation"),eO=eM.mix,eB=eM.offset,eF=eM.range,to(eS,eP,ek,new Float32Array(16),new Float32Array(9),[0,0],0,[0,0],[0,0,0,0],1,{opacity:1,mix:0},ec,[0,0],eR,2,eO,eB,eF,1,0,eI)),ej=el.getOrCreateProgram("raster",{defines:eM.defines});return el.uploadCommonUniforms(e_,ej,null),void ej.draw(el,ew.TRIANGLES,eE,en.b6.disabled,eC,en.b5.disabled,eV,ec.id,ed,eN,eU)}if(!ed.length)return;let[eN,eU]=eT instanceof en.aK||eP?[{},ed]:el.stencilConfigForOverlap(ed),eV=eU[eU.length-1].overscaledZ,ej=ez&&eS;for(let ed of(ej&&eM.defines.push("PROJECTION_GLOBE_VIEW"),ez&&eM.defines.push("RENDER_CUTOFF"),eU)){let ef,eE,eA,ek,eR,eO,eB,eF,eU,eG;let eq=ed.toUnwrapped(),eZ=eu.getTile(ed);if(eP&&(!eZ||!eZ.hasData())||!eZ.texture)continue;eP?(ef=en.b4.disabled,eE=ed.projMatrix):ez?(ef=new en.b4(ew.LEQUAL,en.b4.ReadWrite,el.depthRangeFor3D),eE=eS?Float32Array.from(el.transform.expandedFarZProjMatrix):el.transform.calculateProjMatrix(eq,eD)):(ef=el.depthModeForSublayer(ed.overscaledZ-eV,1===ec.paint.get("raster-opacity")?en.b4.ReadWrite:en.b4.ReadOnly,ew.LESS),eE=el.transform.calculateProjMatrix(eq,eD));let e$=el.terrain&&eP?el.terrain.stencilModeForRTTOverlap(ed):eN[ed.overscaledZ],eW=em?0:ec.paint.get("raster-fade-duration");eZ.registerFadeDuration(eW);let eH=eu.findLoadedParent(ed,0),eX=Ri(eZ,eH,eu,el.transform,eW);el.terrain&&el.terrain.prepareDrawTile(),e_.activeTexture.set(ew.TEXTURE0),eZ.texture&&eZ.texture.bind(eL,ew.CLAMP_TO_EDGE),e_.activeTexture.set(ew.TEXTURE1),eH?(eH.texture&&eH.texture.bind(eL,ew.CLAMP_TO_EDGE),eA=Math.pow(2,eH.tileID.overscaledZ-eZ.tileID.overscaledZ),ek=[eZ.tileID.canonical.x*eA%1,eZ.tileID.canonical.y*eA%1]):eZ.texture&&eZ.texture.bind(eL,ew.CLAMP_TO_EDGE),eZ.texture&&eZ.texture.useMipmap&&e_.extTextureFilterAnisotropic&&el.transform.pitch>20&&ew.texParameterf(ew.TEXTURE_2D,e_.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,e_.extTextureFilterAnisotropicMax);let eK=el.transform,eJ=ez?function(en){let el=en._nearZ,eu=en.projection.farthestPixelDistance(en),ec=eu-el,ed=.2*en.height,ef=el+ed;return[el,eu,(ef-ed-el)/ec,(ef-el)/ec]}(eK):[0,0,0,0];ej&&eT instanceof en.aK&&eT.coordinates.length>3?(eO=Float32Array.from(en.bh(en.bi(new en.t(0,0,0)))),eB=Float32Array.from(eK.globeMatrix),eF=Float32Array.from(en.bc(eK)),eU=[en.E(eK.center.lng),en.H(eK.center.lat)],eR=eT.elevatedGlobePerspectiveTransform,eG=eT.elevatedGlobeGridMatrix||new Float32Array(9)):(eR=eT instanceof en.aK?eT.perspectiveTransform:[0,0],eO=new Float32Array(16),eB=new Float32Array(9),eF=new Float32Array(16),eU=[0,0],eG=new Float32Array(9));let eY=to(eE,eO,eB,eF,eG,ek||[0,0],en.ao(el.transform.zoom),eU,eJ,eA||1,eX,ec,eR,ez?ec.paint.get("raster-elevation"):0,2,eM.mix,eM.offset,eM.range,1,0,eI),eQ=el.isTileAffectedByFog(ed),e0=el.getOrCreateProgram("raster",{defines:eM.defines,overrideFog:eQ});if(el.uploadCommonUniforms(e_,e0,eq),eT instanceof en.aK){let eu=eT.elevatedGlobeVertexBuffer,ed=eT.elevatedGlobeIndexBuffer;if(eP||!eS)eT.boundsBuffer&&eT.boundsSegments&&e0.draw(el,ew.TRIANGLES,ef,en.b6.disabled,eC,en.b5.disabled,eY,ec.id,eT.boundsBuffer,el.quadTriangleIndexBuffer,eT.boundsSegments);else if(eu&&ed){let em=eK.zoom<=en.Z?eT.elevatedGlobeSegments:eT.getSegmentsForLongitude(eK.center.lng);em&&(e0.draw(el,ew.TRIANGLES,ef,en.b6.disabled,eC,en.b5.backCW,eY,ec.id,eu,ed,em),e0.draw(el,ew.TRIANGLES,ef,en.b6.disabled,eC,en.b5.frontCW,eY,ec.id,eu,ed,em))}}else{let{tileBoundsBuffer:eu,tileBoundsIndexBuffer:ed,tileBoundsSegments:em}=el.getTileBoundsBuffers(eZ);e0.draw(el,ew.TRIANGLES,ef,e$,eC,en.b5.disabled,eY,ec.id,eu,ed,em)}}el.resetStencilClippingMasks()},background:function(el,eu,ec,ed){let ef=ec.paint.get("background-color"),em=ec.paint.get("background-opacity"),e_=ec.paint.get("background-emissive-strength");if(0===em)return;let ew=el.context,eT=ew.gl,eM=el.transform,eE=eM.tileSize,eS=ec.paint.get("background-pattern");if(el.isPatternMissing(eS,ec.scope))return;let eA=!eS&&1===ef.a&&1===em&&el.opaquePassEnabledForLayer()?"opaque":"translucent";if(el.renderPass!==eA)return;let eI=en.b6.disabled,eC=el.depthModeForSublayer(0,"opaque"===eA?en.b4.ReadWrite:en.b4.ReadOnly),eP=el.colorModeForDrapableLayerRenderPass(e_),ez=eS?"backgroundPattern":"background",eD,eL=ed;for(let eA of(eL||(eL=Object.values(eD=el.getBackgroundTiles()).map(en=>en.tileID)),eS&&(ew.activeTexture.set(eT.TEXTURE0),el.imageManager.bind(el.context,ec.scope)),eL)){let eL=el.isTileAffectedByFog(eA),ek=el.getOrCreateProgram(ez,{overrideFog:eL}),eR=eA.toUnwrapped(),eO=ed?eA.projMatrix:el.transform.calculateProjMatrix(eR);el.prepareDrawTile();let eB=eu?eu.getTile(eA):eD?eD[eA.key]:new en.bt(eA,eE,eM.zoom,el),eF=eS?ho(eO,e_,em,el,eS,ec.scope,{tileID:eA,tileSize:eE}):co(eO,e_,em,ef);el.uploadCommonUniforms(ew,ek,eR);let{tileBoundsBuffer:eN,tileBoundsIndexBuffer:eU,tileBoundsSegments:eV}=el.getTileBoundsBuffers(eB);ek.draw(el,eT.TRIANGLES,eC,eI,eP,en.b5.disabled,eF,ec.id,eN,eU,eV)}},sky:function(el,eu,ec){let ed=el._atmosphere?en.ao(el.transform.zoom):1,ef=ec.paint.get("sky-opacity")*ed;if(0===ef)return;let em=el.context,e_=ec.paint.get("sky-type"),ew=new en.b4(em.gl.LEQUAL,en.b4.ReadOnly,[0,1]),eT=el.frameCounter/1e3%1;"atmosphere"===e_?"offscreen"===el.renderPass?ec.needsSkyboxCapture(el)&&(function(el,eu,ec,ed){let ef=el.context,em=ef.gl,e_=eu.skyboxFbo;if(!e_){e_=eu.skyboxFbo=ef.createFramebuffer(32,32,!0,null),eu.skyboxGeometry=new Ho(ef),eu.skyboxTexture=ef.gl.createTexture(),em.bindTexture(em.TEXTURE_CUBE_MAP,eu.skyboxTexture),em.texParameteri(em.TEXTURE_CUBE_MAP,em.TEXTURE_WRAP_S,em.CLAMP_TO_EDGE),em.texParameteri(em.TEXTURE_CUBE_MAP,em.TEXTURE_WRAP_T,em.CLAMP_TO_EDGE),em.texParameteri(em.TEXTURE_CUBE_MAP,em.TEXTURE_MIN_FILTER,em.LINEAR),em.texParameteri(em.TEXTURE_CUBE_MAP,em.TEXTURE_MAG_FILTER,em.LINEAR);for(let en=0;en<6;++en)em.texImage2D(em.TEXTURE_CUBE_MAP_POSITIVE_X+en,0,em.RGBA,32,32,0,em.RGBA,em.UNSIGNED_BYTE,null)}ef.bindFramebuffer.set(e_.framebuffer),ef.viewport.set([0,0,32,32]);let ew=eu.getCenter(el,!0),eT=el.getOrCreateProgram("skyboxCapture"),eM=new Float64Array(16);en.m.identity(eM),en.m.rotateY(eM,eM,-(.5*Math.PI)),qo(el,eu,eT,eM,ew,0),en.m.identity(eM),en.m.rotateY(eM,eM,.5*Math.PI),qo(el,eu,eT,eM,ew,1),en.m.identity(eM),en.m.rotateX(eM,eM,-(.5*Math.PI)),qo(el,eu,eT,eM,ew,2),en.m.identity(eM),en.m.rotateX(eM,eM,.5*Math.PI),qo(el,eu,eT,eM,ew,3),en.m.identity(eM),qo(el,eu,eT,eM,ew,4),en.m.identity(eM),en.m.rotateY(eM,eM,Math.PI),qo(el,eu,eT,eM,ew,5),ef.viewport.set([0,0,el.width,el.height])}(el,ec),ec.markSkyboxValid(el)):"sky"===el.renderPass&&function(el,eu,ec,ed,ef){let em=el.context,e_=em.gl,ew=el.transform,eT=el.getOrCreateProgram("skybox");em.activeTexture.set(e_.TEXTURE0),e_.bindTexture(e_.TEXTURE_CUBE_MAP,eu.skyboxTexture);let eM={u_matrix:ew.skyboxMatrix,u_sun_direction:eu.getCenter(el,!1),u_cubemap:0,u_opacity:ed,u_temporal_offset:ef};el.uploadCommonUniforms(em,eT),eT.draw(el,e_.TRIANGLES,ec,en.b6.disabled,el.colorModeForRenderPass(),en.b5.backCW,eM,"skybox",eu.skyboxGeometry.vertexBuffer,eu.skyboxGeometry.indexBuffer,eu.skyboxGeometry.segment)}(el,ec,ew,ef,eT):"gradient"===e_&&"sky"===el.renderPass&&function(el,eu,ec,ed,ef){var em,e_,ew;let eT=el.context,eM=eT.gl,eE=el.transform,eS=el.getOrCreateProgram("skyboxGradient");eu.skyboxGeometry||(eu.skyboxGeometry=new Ho(eT)),eT.activeTexture.set(eM.TEXTURE0);let eA=eu.colorRampTexture;eA||(eA=eu.colorRampTexture=new en.a9(eT,eu.colorRamp,eM.RGBA)),eA.bind(eM.LINEAR,eM.CLAMP_TO_EDGE);let eI=(em=eE.skyboxMatrix,e_=eu.getCenter(el,!1),ew=eu.paint.get("sky-gradient-radius"),{u_matrix:em,u_color_ramp:0,u_center_direction:e_,u_radius:en.d(ew),u_opacity:ed,u_temporal_offset:ef});el.uploadCommonUniforms(eT,eS),eS.draw(el,eM.TRIANGLES,ec,en.b6.disabled,el.colorModeForRenderPass(),en.b5.backCW,eI,"skyboxGradient",eu.skyboxGeometry.vertexBuffer,eu.skyboxGeometry.indexBuffer,eu.skyboxGeometry.segment)}(el,ec,ew,ef,eT)},debug:function(el,eu,ec,ed,ef){for(let em=0;em<ec.length;em++)if(ef){let ef=new en.C(.8*ed.r,.8*ed.g,.8*ed.b,1);No(el,eu,ec[em],ed,-1,-1),No(el,eu,ec[em],ed,-1,1),No(el,eu,ec[em],ed,1,1),No(el,eu,ec[em],ed,1,-1),No(el,eu,ec[em],ef,0,0)}else No(el,eu,ec[em],ed,0,0)},custom:function(el,eu,ec,ed){let ef=el.context,em=ec.implementation;if(!el.transform.projection.unsupportedLayers||!el.transform.projection.unsupportedLayers.includes("custom")||el.terrain&&(el.terrain.renderingToTexture||"offscreen"===el.renderPass)&&ec.isLayerDraped(eu)){if("offscreen"===el.renderPass){let eu=em.prerender;if(eu){if(el.setCustomLayerDefaults(),ef.setColorMode(el.colorModeForRenderPass()),"globe"===el.transform.projection.name){let ec=el.transform.pointMerc;eu.call(em,ef.gl,el.transform.customLayerMatrix(),el.transform.getProjection(),el.transform.globeToMercatorMatrix(),en.ao(el.transform.zoom),[ec.x,ec.y],el.transform.pixelsPerMeterRatio)}else eu.call(em,ef.gl,el.transform.customLayerMatrix());ef.setDirty(),el.setBaseState()}}else if("translucent"===el.renderPass){if(el.terrain&&el.terrain.renderingToTexture){let eu=em.renderToTile;if(eu){let ec=ed[0].canonical,e_=new en.M(ec.x+ed[0].wrap*(1<<ec.z),ec.y,ec.z);ef.setDepthMode(en.b4.disabled),ef.setStencilMode(en.b6.disabled),ef.setColorMode(el.colorModeForRenderPass()),el.setCustomLayerDefaults(),eu.call(em,ef.gl,e_),ef.setDirty(),el.setBaseState()}return}el.setCustomLayerDefaults(),ef.setColorMode(el.colorModeForRenderPass()),ef.setStencilMode(en.b6.disabled);let eu="3d"===em.renderingMode?new en.b4(el.context.gl.LEQUAL,en.b4.ReadWrite,el.depthRangeFor3D):el.depthModeForSublayer(0,en.b4.ReadOnly);if(ef.setDepthMode(eu),"globe"===el.transform.projection.name){let eu=el.transform.pointMerc;em.render(ef.gl,el.transform.customLayerMatrix(),el.transform.getProjection(),el.transform.globeToMercatorMatrix(),en.ao(el.transform.zoom),[eu.x,eu.y],el.transform.pixelsPerMeterRatio)}else em.render(ef.gl,el.transform.customLayerMatrix());ef.setDirty(),el.setBaseState(),ef.bindFramebuffer.set(null)}}else en.X("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(el,eu,ec,ed){if("opaque"===el.renderPass)return;let ef=ec.paint.get("model-opacity");if(0===ef)return;let em=ec.paint.get("model-cast-shadows");if("shadow"===el.renderPass&&(!em||el.terrain&&ef<.65&&ec._transitionablePaint._values["model-opacity"].value.expression instanceof en.am))return;let e_=el.shadowRenderer,ew=ec.paint.get("model-receive-shadows");e_&&(e_.useNormalOffset=!0,ew||(e_.enabled=!1));let c=()=>{e_&&(e_.useNormalOffset=!0,ew||(e_.enabled=!0))},eT=eu.getSource();if("light-beam"===el.renderPass&&"batched-model"!==eT.type)return;if("vector"===eT.type||"geojson"===eT.type)return function(el,eu,ec,ed){let ef=el.transform;if("mercator"!==ef.projection.name)return void en.X(`Drawing 3D models for ${ef.projection.name} projection is not yet implemented`);let em=ef.getFreeCameraOptions().position;if(!el.modelManager)return;let e_=el.modelManager,ew=el.shadowRenderer;if(!ec._unevaluatedLayout._values.hasOwnProperty("model-id"))return;let eT=ec._unevaluatedLayout._values["model-id"],eM={...ec.layout.get("model-id").parameters};for(let eE of ed){let ed=eu.getTile(eE).getBucket(ec);if(!ed||ed.projection.name!==ef.projection.name)continue;let eS=function(el,eu){let ec=1<<el.canonical.z,ed=eu.getFreeCameraOptions().position,ef=eu.elevation,em=el.canonical.x/ec,e_=(el.canonical.x+1)/ec,ew=el.canonical.y/ec,eT=(el.canonical.y+1)/ec,eM=eu._centerAltitude;if(ef){let en=ef.getMinMaxForTile(el);en&&en.max>eM&&(eM=en.max)}let eE=en.c(ed.x,em,e_)-ed.x,eS=en.c(ed.y,ew,eT)-ed.y,eA=en.b(eM,eu.center.lat)-ed.z;return eu._zoomFromMercatorZ(Math.sqrt(eE*eE+eS*eS+eA*eA))}(eE,ef);eM.zoom=eS;let eA=eT.possiblyEvaluate(eM);if(function(el,eu,ec){let ed=eu.updateZoomBasedPaintProperties(),ef=function(el,eu,ec){let ed,ef,em,e_=el.terrain?el.terrain.exaggeration():0;if(el.terrain&&e_>0){let eu=el.terrain,ef=eu.findDEMTileFor(ec);ef&&ef.dem?ed=en.c7.create(eu,ec,ef):e_=0}if(0===e_&&(eu.terrainElevationMin=0,eu.terrainElevationMax=0),e_===eu.validForExaggeration&&(0===e_||ed&&ed._demTile&&ed._demTile.tileID===eu.validForDEMTile.id&&ed._dem._timestamp===eu.validForDEMTile.timestamp))return!1;for(let en in eu.instancesPerModel){let el=eu.instancesPerModel[en];for(let en=0;en<el.instancedDataArray.length;++en){let ec=(ed?e_*ed.getElevationAt(0|el.instancedDataArray.float32[16*en],0|el.instancedDataArray.float32[16*en+1],!0,!0):0)+el.instancesEvaluatedElevation[en];el.instancedDataArray.float32[16*en+6]=ec,ef=ef?Math.min(eu.terrainElevationMin,ec):ec,em=em?Math.max(eu.terrainElevationMax,ec):ec}}return eu.terrainElevationMin=ef||0,eu.terrainElevationMax=em||0,eu.validForExaggeration=e_,eu.validForDEMTile=ed&&ed._demTile?{id:ed._demTile.tileID,timestamp:ed._dem._timestamp}:{id:void 0,timestamp:0},!0}(el,eu,ec);(ed||ef)&&(eu.uploaded=!1,eu.upload(el.context))}(el,ed,eE),tT.shadowUniformsInitialized=!1,tT.useSingleShadowCascade=!!ew&&0===ew.getMaxCascadeForTile(eE.toUnwrapped()),"shadow"===el.renderPass&&ew){if(1===el.currentShadowCascade&&ed.isInsideFirstShadowMapFrustum)continue;let eu=ef.calculatePosMatrix(eE.toUnwrapped(),ef.worldSize);if(tT.tileMatrix.set(eu),tT.shadowTileMatrix=Float32Array.from(ew.calculateShadowPassMatrixFromMatrix(eu)),tT.aabb.min.fill(0),tT.aabb.max[0]=tT.aabb.max[1]=en.J,tT.aabb.max[2]=0,function(el,eu,ec,ed){if(!ec.modelManager)return!0;let ef=ec.modelManager;if(!ec.shadowRenderer)return!0;let em=ec.shadowRenderer,e_=eu.aabb,ew=!0,eT=el.maxHeight;if(0===eT){let en=0;for(let eu in el.instancesPerModel){let el=ef.getModel(eu,ed);el?en=Math.max(en,Math.max(Math.max(el.aabb.max[0],el.aabb.max[1]),el.aabb.max[2])):ew=!1}eT=el.maxScale*en*1.41+el.maxVerticalOffset,ew&&(el.maxHeight=eT)}e_.max[2]=eT,e_.min[2]+=el.terrainElevationMin,e_.max[2]+=el.terrainElevationMax,en.v.transformMat4(e_.min,e_.min,eu.tileMatrix),en.v.transformMat4(e_.max,e_.max,eu.tileMatrix);let eM=e_.intersects(em.getCurrentCascadeFrustum());return 0===ec.currentShadowCascade&&(el.isInsideFirstShadowMapFrustum=2===eM),0===eM}(ed,tT,el,ec.scope))continue}let eI=1<<eE.canonical.z,eC=[((em.x-eE.wrap)*eI-eE.canonical.x)*en.J,(em.y*eI-eE.canonical.y)*en.J,em.z*eI*en.J];for(let eu in ed.instancesPerModel){let ef=ed.instancesPerModel[eu];ef.features.length>0&&(eu=eA.evaluate(ef.features[0].feature,{}));let em=e_.getModel(eu,ec.scope);if(em&&em.uploaded)for(let eu of em.nodes)(function ar(el,eu,ec,ed,ef,em,e_){let ew=el.context,eT="shadow"===el.renderPass,eM=el.shadowRenderer,eE=eT&&eM?eM.getShadowPassDepthMode():new en.b4(ew.gl.LEQUAL,en.b4.ReadWrite,el.depthRangeFor3D),eS=el.isTileAffectedByFog(em);if(ec.meshes)for(let eA of ec.meshes){let eI,eC,eP;let ez=["MODEL_POSITION_ON_GPU"],eD=[];ed.instancedDataArray.length>20&&ez.push("INSTANCED_ARRAYS");let eL=Ii(el,eu.paint.get("model-cutoff-fade-range"));if(eL.shouldRenderCutoff&&ez.push("RENDER_CUTOFF"),eT&&eM)eI=el.getOrCreateProgram("modelDepth",{defines:ez}),eC=mo(e_.shadowTileMatrix,e_.shadowTileMatrix,Float32Array.from(ec.matrix)),eP=eM.getShadowPassColorMode();else{er(ez,eD,eA,el),eI=el.getOrCreateProgram("model",{defines:ez,overrideFog:eS});let ed=eA.material,eT=ed.pbrMetallicRoughness,eE=eu.paint.get("model-opacity"),ek=eu.paint.get("model-emissive-strength").constantOr(0);eC=uo(em.expandedProjMatrix,Float32Array.from(ec.matrix),new Float32Array(16),el,eE,eT.baseColorFactor,ed.emissiveFactor,eT.metallicFactor,eT.roughnessFactor,ed,ek,eu,ef),eM&&(e_.shadowUniformsInitialized?eI.setShadowUniformValues(ew,eM.getShadowUniformValues()):(eM.setupShadows(em.toUnwrapped(),eI,"model-tile",em.overscaledZ),e_.shadowUniformsInitialized=!0)),eP=eL.shouldRenderCutoff||eE<1||"OPAQUE"!==ed.alphaMode?en.a.alphaBlended:en.a.unblended}el.uploadCommonUniforms(ew,eI,em.toUnwrapped(),null,eL);let ek=eA.material.doubleSided?en.b5.disabled:en.b5.backCCW;if(ed.instancedDataArray.length>20)eD.push(ed.instancedDataBuffer),eI.draw(el,ew.gl.TRIANGLES,eE,en.b6.disabled,eP,ek,eC,eu.id,eA.vertexBuffer,eA.indexBuffer,eA.segments,eu.paint,el.transform.zoom,void 0,eD,ed.instancedDataArray.length);else{let ec=eT?"u_instance":"u_normal_matrix";for(let ef=0;ef<ed.instancedDataArray.length;++ef)eC[ec]=new Float32Array(ed.instancedDataArray.arrayBuffer,64*ef,16),eI.draw(el,ew.gl.TRIANGLES,eE,en.b6.disabled,eP,ek,eC,eu.id,eA.vertexBuffer,eA.indexBuffer,eA.segments,eu.paint,el.transform.zoom,void 0,eD)}}if(ec.children)for(let en of ec.children)ar(el,eu,en,ed,ef,em,e_)})(el,ec,eu,ef,eC,eE,tT)}}}(el,eu,ec,ed),void c();if(!eT.loaded())return;if("batched-model"===eT.type)return function(el,eu,ec,ed){let ef=el.context,em=el.transform,e_=el.style.fog,ew=el.shadowRenderer;if("mercator"!==em.projection.name)return void en.X(`Drawing 3D landmark models for ${em.projection.name} projection is not yet implemented`);let eT=el.transform.getFreeCameraOptions().position,eM=en.v.scale([],[eT.x,eT.y,eT.z],el.transform.worldSize);en.v.negate(eM,eM);let eE=en.m.identity([]),eS=en.c4(em.center.lat,em.zoom),eA=en.m.fromScaling([],[1,1,1/eS]);en.m.translate(eE,eE,eM);let eI=ec.paint.get("model-opacity"),eC=new en.b4(ef.gl.LEQUAL,en.b4.ReadWrite,el.depthRangeFor3D),eP=new en.b4(ef.gl.LEQUAL,en.b4.ReadOnly,el.depthRangeFor3D),g=function(eT,eM){for(let eS of ed){let ed=eu.getTile(eS).getBucket(ec);if(!ed||!ed.uploaded)continue;let ez=!1;ew&&(ez=0===ew.getMaxCascadeForTile(eS.toUnwrapped()));let eD=em.calculatePosMatrix(eS.toUnwrapped(),em.worldSize),eL=ed.modelTraits;for(let eu of ed.getNodesInfo()){if(eu.hiddenByReplacement||!eu.node.meshes)continue;let ed=eu.node,ek="light-beam"===el.renderPass,eR=[...eD],eO=eu.evaluatedScale,eB=0;el.terrain&&ed.elevation&&(eB=ed.elevation*el.terrain.exaggeration()),en.m.translate(eR,eR,[(ed.anchor?ed.anchor[0]:0)*(eO[0]-1),(ed.anchor?ed.anchor[1]:0)*(eO[1]-1),eB]),eO!==en.c6&&en.m.scale(eR,eR,eO),en.m.multiply(eR,eR,ed.matrix);let eF=en.m.multiply([],eA,eR);en.m.multiply(eF,eE,eF);let eN=en.m.invert([],eF);en.m.transpose(eN,eN),en.m.scale(eN,eN,tM);let eU=en.m.multiply([],em.expandedFarZProjMatrix,eR),eV=eL&en.c8.HasMapboxMeshFeatures,ej=eV?0:eu.evaluatedRMEA[0][2];for(let eE=0;eE<ed.meshes.length;++eE){let eA=ed.meshes[eE],eD=eE===ed.lightMeshIndex;if(eD){if(!ek&&!el.terrain&&el.shadowRenderer){el.currentLayer<el.firstLightBeamLayer&&(el.firstLightBeamLayer=el.currentLayer);continue}}else if(ek)continue;let eL={defines:[]},eO=[];er(eL.defines,eO,eA,el),eV||eL.defines.push("DIFFUSE_SHADED"),ez&&eL.defines.push("SHADOWS_SINGLE_CASCADE");let eB="shadow"===el.renderPass;if(eB){or(eA,eR,el,ec);continue}let eG=null;if(e_){let en=Qo(eR,el.transform);if(eG=new Float32Array(en),"globe"!==em.projection.name){let el=eA.aabb.min,eu=eA.aabb.max,[ec,ed]=e_.getOpacityForBounds(en,el[0],el[1],eu[0],eu[1]);eL.overrideFog=ec>=.05||ed>=.05}}let eq=el.getOrCreateProgram("model",eL);!eB&&ew&&(ew.useNormalOffset=!!eA.normalBuffer,ew.setupShadowsFromMatrix(eR,eq,ew.useNormalOffset)),el.uploadCommonUniforms(ef,eq,eS.toUnwrapped(),eG);let eZ=eA.material,e$=eZ.pbrMetallicRoughness;e$.metallicFactor=.9,e$.roughnessFactor=.5;let eW=uo(new Float32Array(eU),new Float32Array(eF),new Float32Array(eN),el,eI,e$.baseColorFactor,eZ.emissiveFactor,e$.metallicFactor,e$.roughnessFactor,eZ,ej,ec);eq.draw(el,ef.gl.TRIANGLES,eM&&!eD?eC:eP,en.b6.disabled,eT?eD||eI<1||eu.hasTranslucentParts?en.a.alphaBlended:en.a.unblended:en.a.disabled,en.b5.backCCW,eW,ec.id,eA.vertexBuffer,eA.indexBuffer,eA.segments,ec.paint,el.transform.zoom,void 0,eO)}}}};(function(en,el,eu,ec){let ed=en.terrain?en.terrain.exaggeration():0,ef=en.transform.zoom;for(let em of ec){let ec=el.getTile(em).getBucket(eu);ec&&(en.conflationActive&&ec.updateReplacement(em,en.replacementSource),ec.evaluateScale(en,eu),en.terrain&&ed>0&&ec.elevationUpdate(en.terrain,ed,em,eu.source),ec.needsReEvaluation(en,ef,eu)&&ec.evaluate(eu))}})(el,eu,ec,ed),1===eI?g(!0,!0):(g(!1,!0),g(!0,!1))}(el,eu,ec,ed),void c();let eM=eT.getModels(),eE=[],eS=el.transform.getFreeCameraOptions().position,eA=en.v.scale([],[eS.x,eS.y,eS.z],el.transform.worldSize);en.v.negate(eA,eA);let eI=[],eC=[],eP=0;for(let eu of eM){let ed=ec.paint.get("model-rotation").constantOr(null),ef=ec.paint.get("model-scale").constantOr(null),em=ec.paint.get("model-translation").constantOr(null);eu.computeModelMatrix(el,ed,ef,em,!0,!0,!1);let e_=en.m.identity([]),ew=en.c4(eu.position.lat,el.transform.zoom),eT=en.m.fromScaling([],[1,1,1/ew]);for(let ec of(en.m.translate(e_,e_,eA),eE.push({zScaleMatrix:eT,negCameraPosMatrix:e_}),eu.nodes))!function ir(el,eu,ec,ed,ef,em,e_){let ew;ew="globe"===el.projection.name?en.c5(ec,el):[...ec],en.m.multiply(ew,ew,eu.matrix);let eT=en.m.multiply([],ed,ew);if(eu.meshes)for(let el of eu.meshes){if("BLEND"!==el.material.alphaMode){e_.push({mesh:el,depth:0,modelIndex:ef,worldViewProjection:eT,nodeModelMatrix:ew});continue}let eu=en.v.transformMat4([],el.centroid,eT);eu[2]>0&&em.push({mesh:el,depth:eu[2],modelIndex:ef,worldViewProjection:eT,nodeModelMatrix:ew})}if(eu.children)for(let en of eu.children)ir(el,en,ec,ed,ef,em,e_)}(el.transform,ec,eu.matrix,el.transform.expandedFarZProjMatrix,eP,eI,eC);eP++}if(eI.sort((en,el)=>el.depth-en.depth),"shadow"!==el.renderPass){if(1===ef)for(let eu of eC)tr(eu,el,ec,eE[eu.modelIndex],en.b6.disabled,el.colorModeForRenderPass());else{for(let eu of eC)tr(eu,el,ec,eE[eu.modelIndex],en.b6.disabled,en.a.disabled);for(let en of eC)tr(en,el,ec,eE[en.modelIndex],el.stencilModeFor3D(),el.colorModeForRenderPass());el.resetStencilClippingMasks()}for(let eu of eI)tr(eu,el,ec,eE[eu.modelIndex],en.b6.disabled,el.colorModeForRenderPass());c()}else{for(let en of eC)or(en.mesh,en.nodeModelMatrix,el,ec);for(let en of eI)or(en.mesh,en.nodeModelMatrix,el,ec);c()}}},tS={modelUpload:function(en,el,eu){let ec=el.getSource();if(!ec.loaded())return;if("vector"===ec.type||"geojson"===ec.type)return void(en.modelManager&&en.modelManager.upload(en,eu));if("batched-model"===ec.type)return;let ed=ec.getModels();for(let el of ed)el.upload(en.context)}};let mr=class mr{constructor(el,eu,ec,ed){this.context=new se(el,eu),this.transform=ec,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=ed,this._debugParams={showTerrainProxyTiles:!1},ed.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),this.setup(),this.numSublayers=en.bq.maxUnderzooming+en.bq.maxOverzooming+1,this.depthEpsilon=1/65536,this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new en.ca,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new xr(this),this._wireframeDebugCache=new _r,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0}updateTerrain(en,el){let eu=!!en&&!!en.terrain&&this.transform.projection.supportsTerrain;if(!(eu||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Bi(this,en));let ec=this._terrain;this.transform.elevation=eu?ec:null,ec.update(en,this.transform,el),this.transform.elevation&&!ec.enabled&&(this.transform.elevation=null)}_updateFog(en){let el=en.fog;if(!el||"globe"===this.transform.projection.name||1>el.getOpacity(this.transform.pitch)||.03>el.properties.get("horizon-blend"))return void(this.transform.fogCullDistSq=null);let[eu,ec]=el.getFovAdjustedRange(this.transform._fov);if(eu>ec)return void(this.transform.fogCullDistSq=null);let ed=eu+.78*(ec-eu);this.transform.fogCullDistSq=ed*ed}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled?this._terrain:null}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(el,eu){if(this.width=el*en.a4.devicePixelRatio,this.height=eu*en.a4.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(let en of this.style.order)this.style._mergedLayers[en].resize()}setup(){let el=this.context,eu=new en.bo;eu.emplaceBack(0,0),eu.emplaceBack(en.J,0),eu.emplaceBack(0,en.J),eu.emplaceBack(en.J,en.J),this.tileExtentBuffer=el.createVertexBuffer(eu,en.bl.members),this.tileExtentSegments=en.bm.simpleSegment(0,0,4,2);let ec=new en.bo;ec.emplaceBack(0,0),ec.emplaceBack(en.J,0),ec.emplaceBack(0,en.J),ec.emplaceBack(en.J,en.J),this.debugBuffer=el.createVertexBuffer(ec,en.bl.members),this.debugSegments=en.bm.simpleSegment(0,0,4,5);let ed=new en.bo;ed.emplaceBack(-1,-1),ed.emplaceBack(1,-1),ed.emplaceBack(-1,1),ed.emplaceBack(1,1),this.viewportBuffer=el.createVertexBuffer(ed,en.bl.members),this.viewportSegments=en.bm.simpleSegment(0,0,4,2);let ef=new en.cb;ef.emplaceBack(0,0,0,0),ef.emplaceBack(en.J,0,en.J,0),ef.emplaceBack(0,en.J,0,en.J),ef.emplaceBack(en.J,en.J,en.J,en.J),this.mercatorBoundsBuffer=el.createVertexBuffer(ef,en.cc.members),this.mercatorBoundsSegments=en.bm.simpleSegment(0,0,4,2);let em=new en.bp;em.emplaceBack(0,1,2),em.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=el.createIndexBuffer(em);let e_=new en.cd;for(let en of[0,1,3,2,0])e_.emplaceBack(en);this.debugIndexBuffer=el.createIndexBuffer(e_),this.emptyTexture=new en.a9(el,new en.a5({width:1,height:1},Uint8Array.of(0,0,0,0)),el.gl.RGBA),this.identityMat=en.m.create();let ew=this.context.gl;this.stencilClearMode=new en.b6({func:ew.ALWAYS,mask:0},0,255,ew.ZERO,ew.ZERO,ew.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(en){return en._makeTileBoundsBuffers(this.context,this.transform.projection),en._tileBoundsBuffer?{tileBoundsBuffer:en._tileBoundsBuffer,tileBoundsIndexBuffer:en._tileBoundsIndexBuffer,tileBoundsSegments:en._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){let el=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,el.TRIANGLES,en.b4.disabled,this.stencilClearMode,en.a.disabled,en.b5.disabled,Ai(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(el,eu,ec){if(!eu||this.currentStencilSource===eu.id||!el.isTileClipped()||!ec||0===ec.length)return;if(this._tileClippingMaskIDs&&!this.terrain){let en=!1;for(let el of ec)if(void 0===this._tileClippingMaskIDs[el.key]){en=!0;break}if(!en)return}this.currentStencilSource=eu.id;let ed=this.context,ef=ed.gl;this.nextStencilID+ec.length>256&&this.clearStencil(),ed.setColorMode(en.a.disabled),ed.setDepthMode(en.b4.disabled);let em=this.getOrCreateProgram("clippingMask");for(let el of(this._tileClippingMaskIDs={},ec)){let ec=eu.getTile(el),ed=this._tileClippingMaskIDs[el.key]=this.nextStencilID++,{tileBoundsBuffer:e_,tileBoundsIndexBuffer:ew,tileBoundsSegments:eT}=this.getTileBoundsBuffers(ec);em.draw(this,ef.TRIANGLES,en.b4.disabled,new en.b6({func:ef.ALWAYS,mask:0},ed,255,ef.KEEP,ef.KEEP,ef.REPLACE),en.a.disabled,en.b5.disabled,Ai(el.projMatrix),"$clipping",e_,ew,eT)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();let el=this.nextStencilID++,eu=this.context.gl;return new en.b6({func:eu.NOTEQUAL,mask:255},el,255,eu.KEEP,eu.KEEP,eu.REPLACE)}stencilModeForClipping(el){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(el);let eu=this.context.gl;return new en.b6({func:eu.EQUAL,mask:255},this._tileClippingMaskIDs[el.key],0,eu.KEEP,eu.KEEP,eu.REPLACE)}stencilConfigForOverlap(el){let eu=this.context.gl,ec=el.sort((en,el)=>el.overscaledZ-en.overscaledZ),ed=ec[ec.length-1].overscaledZ,ef=ec[0].overscaledZ-ed+1;if(ef>1){this.currentStencilSource=void 0,this.nextStencilID+ef>256&&this.clearStencil();let el={};for(let ec=0;ec<ef;ec++)el[ec+ed]=new en.b6({func:eu.GEQUAL,mask:255},ec+this.nextStencilID,255,eu.KEEP,eu.KEEP,eu.REPLACE);return this.nextStencilID+=ef,[el,ec]}return[{[ed]:en.b6.disabled},ec]}colorModeForRenderPass(){let el=this.context.gl;if(this._showOverdrawInspector){let eu=1/8;return new en.a([el.CONSTANT_COLOR,el.ONE,el.CONSTANT_COLOR,el.ONE],new en.C(eu,eu,eu,0),[!0,!0,!0,!0])}return"opaque"===this.renderPass?en.a.unblended:en.a.alphaBlended}colorModeForDrapableLayerRenderPass(el){let eu=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&"translucent"===this.renderPass?new en.a([eu.ONE,eu.ONE_MINUS_SRC_ALPHA,eu.CONSTANT_ALPHA,eu.ONE_MINUS_SRC_ALPHA],new en.C(0,0,0,void 0===el?0:el),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(el,eu,ec,ed=!1){if(!this.opaquePassEnabledForLayer()&&!ed)return en.b4.disabled;let ef=1-((1+this.currentLayer)*this.numSublayers+el)*this.depthEpsilon;return new en.b4(ec||this.context.gl.LEQUAL,eu,[ef,ef])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(el,eu){this._wireframeDebugCache.update(this.frameCounter),this.style=el,this.options=eu;let ec=this.style._mergedLayers,ed=this.style.order,ef=ed.map(en=>ec[en]),em=this.style._mergedSourceCaches;this.imageManager=el.imageManager,this.modelManager=el.modelManager,this.symbolFadeChange=el.placement.symbolFadeChange(en.a4.now()),this.imageManager.beginFrame();let e_=0,ew=!1;for(let en in em){let el=em[en];el.used&&(el.prepare(this.context),el.getSource().usedInConflation&&++e_)}let eT={},eM={},eE={},eS={},eA={};for(let en in em){let el=em[en];eT[en]=el.getVisibleCoordinates(),eM[en]=eT[en].slice().reverse(),eE[en]=el.getVisibleCoordinates(!0).reverse(),eS[en]=el.getShadowCasterCoordinates(),eA[en]=el.sortCoordinatesByDistance(eT[en])}let p=en=>{let el=this.style.getLayerSourceCache(en);return el&&el.used?el.getSource():null};if(e_){let en=[];for(let el of ef)this.layerUsedInConflation(el,p(el))&&en.push(el);if(en&&en.length>1){let el=[];for(let eu of en){let en=this.style.getLayerSourceCache(eu);en&&en.used&&en.getSource().usedInConflation&&el.push({layer:eu.fqid,cache:en})}this.replacementSource.setSources(el),ew=!0}}for(let en of(ew||this.replacementSource.clear(),this.conflationActive=ew,this.minCutoffZoom=0,this.longestCutoffRange=0,ef)){let el=en.cutoffRange();if(this.longestCutoffRange=Math.max(el,this.longestCutoffRange),el>0){let el=p(en);el&&(this.minCutoffZoom=Math.max(el.minzoom,this.minCutoffZoom)),en.minzoom&&(this.minCutoffZoom=Math.max(en.minzoom,this.minCutoffZoom))}}this.opaquePassCutoff=1/0;for(let en=0;en<ef.length;en++)if(ef[en].is3D()){this.opaquePassCutoff=en;break}let eI=this.style&&this.style.fog;eI?(this._fogVisible=0!==eI.getOpacity(this.transform.pitch),this._fogVisible&&"globe"!==this.transform.projection.name&&(this._fogVisible=eI.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(eE),this.opaquePassCutoff=0);let eC=this._shadowRenderer;if(eC)for(let en in eC.updateShadowParameters(this.transform,this.style.directionalLight),em)for(let el of eT[en]){let en={min:0,max:0};this.terrain&&(en=this.terrain.getMinMaxForTile(el)||en),eC.addShadowReceiver(el.toUnwrapped(),en.min,en.max)}for(let eu of("globe"!==this.transform.projection.name||this.globeSharedBuffers||(this.globeSharedBuffers=new en.ce(this.context)),ef)){if(eu.isHidden(this.transform.zoom))continue;let en=el.getLayerSourceCache(eu);this.uploadLayer(this,eu,en)}if(this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new Ko(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),!en.cf(this.context.gl))return;for(let en of(this.renderPass="offscreen",ef)){let eu=el.getLayerSourceCache(en);if(!en.hasOffscreenPass()||en.isHidden(this.transform.zoom))continue;let ec=eu?eM[eu.id]:void 0;("custom"===en.type||"raster"===en.type||en.isSky()||ec&&ec.length)&&this.renderLayer(this,eu,en,ec)}this.depthRangeFor3D=[0,1-(ef.length+2)*this.numSublayers*this.depthEpsilon];let eP=this.terrain;eP&&(this.style.hasSymbolLayers()||this.style.hasCircleLayers())&&!this.transform.isOrthographic&&eP.drawDepth(),this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,eS)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);let ez="globe"===this.transform.projection.name||this.transform.isHorizonVisible(),eD=(()=>{if(eu.showOverdrawInspector)return en.C.black;if(this.style.fog&&this.transform.projection.supportsFog&&!ez){let el=this.style.fog.properties.get("color").toArray01();return new en.C(...el)}if(this.style.fog&&this.transform.projection.supportsFog&&ez){let el=this.style.fog.properties.get("space-color").toArray01();return new en.C(...el)}return en.C.transparent})();if(this.context.clear({color:eD,depth:1}),this.clearStencil(),this._showOverdrawInspector=eu.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ez&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=ed.length-1;this.currentLayer>=0;this.currentLayer--){let en=ef[this.currentLayer],eu=el.getLayerSourceCache(en);if(en.isSky())continue;let ec=eu?(en.is3D()?eA:eM)[eu.id]:void 0;this._renderTileClippingMasks(en,eu,ec),this.renderLayer(this,eu,en,ec)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ez&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||en.ao(this.transform.zoom)>0)&&("globe"===this.transform.projection.name||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<ed.length;this.currentLayer++){let en=ef[this.currentLayer],eu=el.getLayerSourceCache(en);en.isSky()&&this.renderLayer(this,eu,en,eu?eM[eu.id]:void 0)}this.renderPass="translucent",this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let eL=0;for(eC&&(eL=eC.getShadowCastingLayerCount());this.currentLayer<ed.length;){let en;let eu=ef[this.currentLayer],ec=el.getLayerSourceCache(eu);if(eu.isSky()){++this.currentLayer;continue}if(eP&&this.style.isLayerDraped(eu)){if(eu.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=eP.renderBatch(this.currentLayer);continue}if(ec&&(en=("symbol"===eu.type?eE:eu.is3D()?eA:eM)[ec.id]),this._renderTileClippingMasks(eu,ec,ec?eT[ec.id]:void 0),this.renderLayer(this,ec,eu,en),!eP&&eC&&eL>0&&eu.hasShadowPass()&&0==--eL&&(eC.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){let en=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=en;this.currentLayer++){let en=ef[this.currentLayer];if(!en.hasLightBeamPass())continue;let eu=el.getLayerSourceCache(en);this.renderLayer(this,eu,en,eu?eM[eu.id]:void 0)}this.currentLayer=en,this.renderPass="translucent"}++this.currentLayer}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let eu=null;ef.forEach(en=>{let ec=el.getLayerSourceCache(en);ec&&!en.isHidden(this.transform.zoom)&&ec.getVisibleCoordinates().length&&(!eu||eu.getSource().maxzoom<ec.getSource().maxzoom)&&(eu=ec)}),eu&&this.options.showTileBoundaries&&tE.debug(this,eu,eu.getVisibleCoordinates(),en.C.red,!1)}this.terrain&&this._debugParams.showTerrainProxyTiles&&tE.debug(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new en.C(1,.8,.1,1),!0),this.options.showPadding&&function(en){var el,eu;let ec=en.transform.padding;Uo(en,en.transform.height-(ec.top||0),3,e9),Uo(en,ec.bottom||0,3,ti),Go(en,ec.left||0,3,ta),Go(en,en.transform.width-(ec.right||0),3,tc);let ed=en.transform.centerPoint;el=ed.x,eu=en.transform.height-ed.y,jo(en,el-1,eu-10,2,20,tm),jo(en,el-10,eu-1,20,2,tm)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),ew||(this.conflationActive=!1)}uploadLayer(en,el,eu){this.gpuTimingStart(el),(!en.transform.projection.unsupportedLayers||!en.transform.projection.unsupportedLayers.includes(el.type)||en.terrain&&"custom"===el.type)&&tS[`${el.type}Upload`]&&tS[`${el.type}Upload`](en,eu,el.scope),this.gpuTimingEnd()}renderLayer(en,el,eu,ec){eu.isHidden(this.transform.zoom)||("background"===eu.type||"sky"===eu.type||"custom"===eu.type||"model"===eu.type||"raster"===eu.type||ec&&ec.length)&&(this.id=eu.id,this.gpuTimingStart(eu),en.transform.projection.unsupportedLayers&&en.transform.projection.unsupportedLayers.includes(eu.type)&&(!en.terrain||"custom"!==eu.type)||tE[eu.type](en,el,eu,ec,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(en){if(!this.options.gpuTiming)return;let el=this.context.extTimerQuery,eu=this.context.gl,ec=this.gpuTimers[en.id];ec||(ec=this.gpuTimers[en.id]={calls:0,cpuTime:0,query:eu.createQuery()}),ec.calls++,eu.beginQuery(el.TIME_ELAPSED_EXT,ec.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){let en=this.context.extTimerQuery,el=this.context.gl,eu=el.createQuery();this.deferredRenderGpuTimeQueries.push(eu),el.beginQuery(en.TIME_ELAPSED_EXT,eu)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){let en=this.gpuTimers;return this.gpuTimers={},en}collectDeferredRenderGpuQueries(){let en=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],en}queryGpuTimers(en){let el={};for(let eu in en){let ec=en[eu],ed=this.context.extTimerQuery,ef=ed.getQueryParameter(ec.query,this.context.gl.QUERY_RESULT)/1e6;ed.deleteQueryEXT(ec.query),el[eu]=ef}return el}queryGpuTimeDeferredRender(en){if(!this.options.gpuTimingDeferredRender)return 0;let el=this.context.extTimerQuery,eu=this.context.gl,ec=0;for(let ed of en)ec+=el.getQueryParameter(ed,eu.QUERY_RESULT)/1e6,el.deleteQueryEXT(ed);return ec}translatePosMatrix(el,eu,ec,ed,ef){if(!ec[0]&&!ec[1])return el;let em=ef?"map"===ed?this.transform.angle:0:"viewport"===ed?-this.transform.angle:0;if(em){let en=Math.sin(em),el=Math.cos(em);ec=[ec[0]*el-ec[1]*en,ec[0]*en+ec[1]*el]}let e_=[ef?ec[0]:en.ay(eu,ec[0],this.transform.zoom),ef?ec[1]:en.ay(eu,ec[1],this.transform.zoom),0],ew=new Float32Array(16);return en.m.translate(ew,el,e_),ew}saveTileTexture(en){let el=en.size[0],eu=this._tileTextures[el];eu?eu.push(en):this._tileTextures[el]=[en]}getTileTexture(en){let el=this._tileTextures[en];return el&&el.length>0?el.pop():null}isPatternMissing(en,el){return null===en||void 0!==en&&!this.imageManager.getPattern(en.toString(),el)}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture}linearFloatFilteringSupported(){return null!=this.context.extTextureFloatLinear}currentGlobalDefines(en,el,eu){let ec=void 0===eu?this.terrain&&this.terrain.renderingToTexture:eu,ed=this.terrain&&0===this.terrain.exaggeration(),ef=[];return this.style&&this.style.enable3dLights()&&("globeRaster"===en||"terrainRaster"===en?(ef.push("LIGHTING_3D_MODE"),ef.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):ec||ef.push("LIGHTING_3D_MODE")),"shadow"===this.renderPass?this._shadowMapDebug||ef.push("DEPTH_TEXTURE"):this.shadowRenderer&&(this.shadowRenderer.useNormalOffset?ef.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"):ef.push("RENDER_SHADOWS","DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(ef.push("TERRAIN"),this.linearFloatFilteringSupported()&&ef.push("TERRAIN_DEM_FLOAT_FORMAT"),ed&&ef.push("ZERO_EXAGGERATION")),"globe"===this.transform.projection.name&&ef.push("GLOBE"),this._fogVisible&&!ec&&(void 0===el||el)&&ef.push("FOG","FOG_DITHERING"),ec&&ef.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&ef.push("OVERDRAW_INSPECTOR"),ef}getOrCreateProgram(en,el){this.cache=this.cache||{};let eu=el&&el.defines||[],ec=el&&el.config,ed=this.currentGlobalDefines(en,el&&el.overrideFog,el&&el.overrideRtt).concat(eu),ef=Gi.cacheKey(eH[en],en,ed,ec);return this.cache[ef]||(this.cache[ef]=new Gi(this.context,en,eH[en],ec,e4[en],ed)),this.cache[ef]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){let en=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(en.FUNC_ADD)}initDebugOverlayCanvas(){null==this.debugOverlayCanvas&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new en.a9(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(el,eu){if(this.style.enable3dLights()){let ec=this.style.directionalLight,ed=this.style.ambientLight;if(ec&&ed){let ef=((el,eu)=>{let ec=el.properties.get("direction"),ed=el.properties.get("color").toArray01(),ef=el.properties.get("intensity"),em=eu.properties.get("color").toArray01(),e_=eu.properties.get("intensity"),ew=[ec.x,ec.y,ec.z],eT=en.bv(em,e_),eM=en.bv(ed,ef);return{u_lighting_ambient_color:eT,u_lighting_directional_dir:ew,u_lighting_directional_color:eM,u_ground_radiance:function(el,eu,ec){let ed=function(el,eu,ec){var ed,ef,em;let e_=en.v.dot(eu,el),ew=en.v.dot(ec,[.2126,.7152,.0722]),eT=(ed=1-.3*Math.min(ew,1),(1-(ef=Math.min(e_+1,1)))*ed+1*ef);return((1-(em=Math.asin(en.c(eu[2],-1,1))/Math.PI+.5))*.92+1*em)*eT}(el,[0,0,1],eu),ef=[0,0,0];en.v.scale(ef,ec.slice(0,3),ed);let em=[0,0,0];en.v.scale(em,eu.slice(0,3),el[2]);let e_=[0,0,0];return en.v.add(e_,ef,em),en.bw(e_)}(ew,eM,eT)}})(ec,ed);eu.setLightsUniformValues(el,ef)}}}uploadCommonUniforms(el,eu,ec,ed,ef){if(this.uploadCommonLightUniforms(el,eu),this.terrain&&this.terrain.renderingToTexture)return;let em=this.style.fog;if(em){let ef=em.getOpacity(this.transform.pitch),e_=((el,eu,ec,ed,ef,em,e_,ew,eT,eM,eE,eS)=>{let eA=el.transform,eI=eu.properties.get("color").toArray01();eI[3]=ed;let eC=el.frameCounter/1e3%1,[eP,ez]=eu.properties.get("vertical-range");return{u_fog_matrix:ec?eA.calculateFogTileMatrix(ec):eS||el.identityMat,u_fog_range:eu.getFovAdjustedRange(eA._fov),u_fog_color:eI,u_fog_horizon_blend:eu.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(eP,ez),ez],u_fog_temporal_offset:eC,u_frustum_tl:ef,u_frustum_tr:em,u_frustum_br:e_,u_frustum_bl:ew,u_globe_pos:eT,u_globe_radius:eM,u_viewport:eE,u_globe_transition:en.ao(eA.zoom),u_is_globe:+("globe"===eA.projection.name)}})(this,em,ec,ef,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*en.a4.devicePixelRatio,this.transform.height*en.a4.devicePixelRatio],ed);eu.setFogUniformValues(el,e_)}ef&&eu.setCutoffUniformValues(el,ef.uniformValues)}setTileLoadedFlag(en){this.tileLoaded=en}saveCanvasCopy(){let en=this.canvasCopy();en&&(this.frameCopies.push(en),this.tileLoaded=!1)}canvasCopy(){let en=this.context.gl,el=en.createTexture();return en.bindTexture(en.TEXTURE_2D,el),en.copyTexImage2D(en.TEXTURE_2D,0,en.RGBA,0,0,en.drawingBufferWidth,en.drawingBufferHeight,0),el}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;let en=this.style&&this.style.fog;return!!en&&0!==en.getOpacity(this.transform.pitch)}getBackgroundTiles(){let el=this._backgroundTiles,eu=this._backgroundTiles={},ec=this.transform.coveringTiles({tileSize:512});for(let ed of ec)eu[ed.key]=el[ed.key]||new en.bt(ed,512,this.transform.tileZoom,this);return eu}clearBackgroundTiles(){this._backgroundTiles={}}layerUsedInConflation(en,el){return!(!en.is3D()||en.minzoom&&en.minzoom>this.transform.zoom||"building"!==en.sourceLayer&&(!el||"batched-model"!==el.type))}isTileAffectedByFog(en){if(!this.style||!this.style.fog)return!1;if("globe"===this.transform.projection.name)return!0;let el=this._cachedTileFogOpacities[en.key];return el||(this._cachedTileFogOpacities[en.key]=el=this.style.fog.getOpacityForTile(en)),el[0]>=.05||el[1]>=.05}};let tA={cascadeCount:2,shadowMapResolution:2048};let gr=class gr{constructor(en,el){this.aabb=en,this.lastCascade=el}};let vr=class vr{add(en,el){let eu=this.receivers[en.key];void 0!==eu?(eu.aabb.min[0]=Math.min(eu.aabb.min[0],el.min[0]),eu.aabb.min[1]=Math.min(eu.aabb.min[1],el.min[1]),eu.aabb.min[2]=Math.min(eu.aabb.min[2],el.min[2]),eu.aabb.max[0]=Math.max(eu.aabb.max[0],el.max[0]),eu.aabb.max[1]=Math.max(eu.aabb.max[1],el.max[1]),eu.aabb.max[2]=Math.max(eu.aabb.max[2],el.max[2])):this.receivers[en.key]=new gr(el,null)}clear(){this.receivers={}}get(en){return this.receivers[en.key]}computeRequiredCascades(el,eu,ec){let ed=en.c3.fromPoints(el.points),ef=0;for(let el in this.receivers){let em=this.receivers[el];if(!em||!ed.intersectsAabb(em.aabb))continue;em.aabb.min=ed.closestPoint(em.aabb.min),em.aabb.max=ed.closestPoint(em.aabb.max);let e_=em.aabb.getCorners();for(let el=0;el<ec.length;el++){let ed=!0;for(let ef of e_){let em=[ef[0]*eu,ef[1]*eu,ef[2]];if(en.v.transformMat4(em,em,ec[el].matrix),em[0]<-1||em[0]>1||em[1]<-1||em[1]>1){ed=!1;break}}if(em.lastCascade=el,ef=Math.max(ef,el),ed)break}}return ef+1}};let xr=class xr{constructor(el){this.painter=el,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new vr,this._depthMode=new en.b4(el.context.gl.LEQUAL,en.b4.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this.useNormalOffset=!1,el.tp.registerParameter(tA,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),el.tp.registerParameter(tA,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32})}destroy(){for(let en of this._cascades)en.texture.destroy(),en.framebuffer.destroy();this._cascades=[]}updateShadowParameters(el,eu){let ec=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!eu||!eu.properties)return;let ed=eu.properties.get("shadow-intensity");if(!eu.shadowsEnabled()||ed<=0||(this._shadowLayerCount=ec.style.order.reduce((en,eu)=>{let ed=ec.style._mergedLayers[eu];return en+(ed.hasShadowPass()&&!ed.isHidden(el.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this._enabled))return;let ef=ec.context,em=tA.shadowMapResolution,e_=tA.shadowMapResolution;if(0===this._cascades.length||tA.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let el=0;el<tA.cascadeCount;++el){let el=ec._shadowMapDebug,eu=ef.gl,ed=ef.createFramebuffer(em,e_,el,"texture"),ew=new en.a9(ef,{width:em,height:e_,data:null},eu.DEPTH_COMPONENT);if(ed.depthAttachment.set(ew.texture),el){let el=new en.a9(ef,{width:em,height:e_,data:null},eu.RGBA);ed.colorAttachment.set(el.texture)}this._cascades.push({framebuffer:ed,texture:ew,matrix:[],far:0,boundingSphereRadius:0,frustum:new en.F,scale:0})}}this.shadowDirection=br(eu);let ew=0;if(el.elevation){let en=el.elevation,eu=[1e4,-1e4];en.visibleDemTiles.filter(en=>en.dem).forEach(en=>{let el=en.dem.tree;eu[0]=Math.min(eu[0],el.minimums[0]),eu[1]=Math.max(eu[1],el.maximums[0])}),1e4!==eu[0]&&(ew=(eu[1]-eu[0])*en.exaggeration())}let eT=1.5*el.cameraToCenterDistance,eM=3*eT,eE=new Float64Array(16);for(let eu=0;eu<this._cascades.length;++eu){let ec=this._cascades[eu],ed=el.height/50,ef=1;1===tA.cascadeCount?ef=eM:0===eu?ef=eT:(ed=eT,ef=eM);let[em,e_]=function(el,eu,ec,ed,ef,em){let e_,ew;let eT=el.zoom,eM=el.scale,eE=el.worldSize,eS=1/eE,eA=el.aspect,eI=Math.sqrt(1+eA*eA)*Math.tan(.5*el.fovX),eC=eI*eI,eP=ed-ec,ez=ed+ec;eC>eP/ez?(e_=ed,ew=ed*eI):(e_=.5*ez*(1+eC),ew=.5*Math.sqrt(eP*eP+2*(ed*ed+ec*ec)*eC+ez*ez*eC*eC));let eD=el.projection.pixelsPerMeter(el.center.lat,eE),eL=el._camera.getCameraToWorldMercator(),ek=[0,0,-e_*eS];en.v.transformMat4(ek,ek,eL);let eR=ew*eS,eO=el._edgeInsets;if(!(0===eO.left&&0===eO.top&&0===eO.right&&0===eO.bottom||eO.left===eO.right&&eO.top===eO.bottom)){let eu=el._camera.getWorldToCamera(el.worldSize,"meters"===el.projection.zAxisUnit?eD:1),ef=el._camera.getCameraToClipPerspective(el._fov,el.width/el.height,ec,ed);ef[8]=-(2*el.centerOffset.x)/el.width,ef[9]=2*el.centerOffset.y/el.height;let em=new Float64Array(16);en.m.mul(em,ef,eu);let e_=new Float64Array(16);en.m.invert(e_,em);let ew=en.F.fromInvProjectionMatrix(e_,eE,eT,!0);for(let eu of ew.points){let ec=(eu[0]/=eM,eu[1]/=eM,eu[2]=en.b(eu[2],el._center.lat),eu);eR=Math.max(eR,en.v.len(en.v.subtract([],ek,ec)))}}eR*=ef/(ef-1);let eB=Math.acos(eu[2]),eF=Math.atan2(-eu[0],-eu[1]),eN=new _e;eN.position=ek,eN.setPitchBearing(eB,eF);let eU=eN.getWorldToCamera(eE,eD),eV=eR*eE,ej=Math.min(-(el._mercatorZfromZoom(17)*eE*2),-2*eV),eG=eN.getCameraToClipOrthographic(-eV,eV,-eV,eV,ej,(eV+em*eD)/eu[2]),eq=new Float64Array(16);en.m.multiply(eq,eG,eU);let eZ=en.v.fromValues(Math.floor(1e6*ek[0])/1e6*eE,Math.floor(1e6*ek[1])/1e6*eE,0),e$=.5*ef,eW=[0,0,0];en.v.transformMat4(eW,eZ,eq),en.v.scale(eW,eW,e$);let eH=[Math.floor(eW[0]),Math.floor(eW[1]),Math.floor(eW[2])],eX=[0,0,0];en.v.sub(eX,eW,eH),en.v.scale(eX,eX,-1/e$);let eK=new Float64Array(16);return en.m.identity(eK),en.m.translate(eK,eK,eX),en.m.multiply(eq,eK,eq),[eq,eV]}(el,this.shadowDirection,ed,ef,tA.shadowMapResolution,ew);ec.scale=el.scale,ec.matrix=em,ec.boundingSphereRadius=e_,en.m.invert(eE,ec.matrix),ec.frustum=en.F.fromInvProjectionMatrix(eE,1,0,!0),ec.far=ef}let eS=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[eS].far,this._cascades[eS].far],this._uniformValues.u_shadow_intensity=ed,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/tA.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=tA.shadowMapResolution,this._uniformValues.u_shadowmap_0=e2.ShadowMap0,this._uniformValues.u_shadowmap_1=e2.ShadowMap0+1,this._groundShadowTiles=ec.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});let eA=ec.transform.elevation;for(let en of this._groundShadowTiles){let el={min:0,max:0};if(eA){let eu=eA.getMinMaxForTile(en);eu&&(el=eu)}this.addShadowReceiver(en.toUnwrapped(),el.min,el.max)}}get enabled(){return this._enabled}set enabled(en){this._enabled=en}drawShadowPass(el,eu){if(!this._enabled)return;let ec=this.painter,ed=ec.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(ec.transform.getFrustum(0),ec.transform.worldSize,this._cascades),ed.viewport.set([0,0,tA.shadowMapResolution,tA.shadowMapResolution]);for(let ef=0;ef<this._numCascadesToRender;++ef)for(let em of(ec.currentShadowCascade=ef,ed.bindFramebuffer.set(this._cascades[ef].framebuffer.framebuffer),ed.clear({color:en.C.white,depth:1}),el.order)){let en=el._mergedLayers[em];if(!en.hasShadowPass()||en.isHidden(ec.transform.zoom))continue;let ed=el.getLayerSourceCache(en),ef=ed?eu[ed.id]:void 0;("model"===en.type||ef&&ef.length)&&ec.renderLayer(ec,ed,en,ef)}ec.currentShadowCascade=0}drawGroundShadows(){if(!this._enabled)return;let el=this.painter,eu=el.style,ec=el.context,ed=eu.directionalLight,ef=eu.ambientLight;if(!ed||!ef)return;let em=[],e_=Ii(el,el.longestCutoffRange);e_.shouldRenderCutoff&&em.push("RENDER_CUTOFF");let ew=wr(ed,ef),eT=new en.b4(ec.gl.LEQUAL,en.b4.ReadOnly,el.depthRangeFor3D);for(let eu of this._groundShadowTiles){let ed=eu.toUnwrapped(),ef=el.isTileAffectedByFog(eu),eM=el.getOrCreateProgram("groundShadow",{defines:em,overrideFog:ef});this.setupShadows(ed,eM),el.uploadCommonUniforms(ec,eM,ed,null,e_);let eE={u_matrix:el.transform.calculateProjMatrix(ed),u_ground_shadow_factor:ew};eM.draw(el,ec.gl.TRIANGLES,eT,en.b6.disabled,en.a.multiply,en.b5.disabled,eE,"ground_shadow",el.tileExtentBuffer,el.quadTriangleIndexBuffer,el.tileExtentSegments,{},el.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?en.a.unblended:en.a.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(el){let eu=this.painter.transform,ec=eu.calculatePosMatrix(el,eu.worldSize);return en.m.multiply(ec,this._cascades[this.painter.currentShadowCascade].matrix,ec),Float32Array.from(ec)}calculateShadowPassMatrixFromMatrix(el){return en.m.multiply(el,this._cascades[this.painter.currentShadowCascade].matrix,el),Float32Array.from(el)}setupShadows(el,eu,ec,ed=0){if(!this._enabled)return;let ef=this.painter.transform,em=this.painter.context,e_=em.gl,ew=this._uniformValues,eT=new Float64Array(16),eM=ef.calculatePosMatrix(el,ef.worldSize);for(let el=0;el<this._cascades.length;el++)en.m.multiply(eT,this._cascades[el].matrix,eM),ew[0===el?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(eT),em.activeTexture.set(e_.TEXTURE0+e2.ShadowMap0+el),this._cascades[el].texture.bind(e_.NEAREST,e_.CLAMP_TO_EDGE);if(this.useNormalOffset=!!ec,this.useNormalOffset){let eu=en.cg(el.canonical),em=2/ef.tileSize*en.J/tA.shadowMapResolution,e_=em*this._cascades[0].boundingSphereRadius,eT=em*this._cascades[this._cascades.length-1].boundingSphereRadius,eM=("vector-tile"===ec?1:3)/Math.pow(2,ed-el.canonical.z-(1-ef.zoom+Math.floor(ef.zoom)));ew.u_shadow_normal_offset=[eu,e_*eM,eT*eM],ew.u_shadow_bias=[6e-5,.0012,.012]}else ew.u_shadow_bias=[36e-5,.0012,.012];eu.setShadowUniformValues(em,ew)}setupShadowsFromMatrix(el,eu,ec=!1){if(!this._enabled)return;let ed=this.painter.context,ef=ed.gl,em=this._uniformValues,e_=new Float64Array(16);for(let eu=0;eu<tA.cascadeCount;eu++)en.m.multiply(e_,this._cascades[eu].matrix,el),em[0===eu?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(e_),ed.activeTexture.set(ef.TEXTURE0+e2.ShadowMap0+eu),this._cascades[eu].texture.bind(ef.NEAREST,ef.CLAMP_TO_EDGE);(this.useNormalOffset=ec,ec)?(em.u_shadow_normal_offset=[1,5,5],em.u_shadow_bias=[6e-5,.0012,.012]):em.u_shadow_bias=[36e-5,.0012,.012],eu.setShadowUniformValues(ed,em)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(el,eu,ec,ed){if(ed[2]>=0)return{};let ef=(function(el,eu,ec){let ed=ec/(1<<el.canonical.z);return new en.c3([el.canonical.x*ed+el.wrap*ec,el.canonical.y*ed+el.wrap*ec,0],[(el.canonical.x+1)*ed+el.wrap*ec,(el.canonical.y+1)*ed+el.wrap*ec,eu])})(el,eu,ec).getCorners(),em=-(eu/ed[2]);ed[0]<0?(en.v.add(ef[0],ef[0],[ed[0]*em,0,0]),en.v.add(ef[3],ef[3],[ed[0]*em,0,0])):ed[0]>0&&(en.v.add(ef[1],ef[1],[ed[0]*em,0,0]),en.v.add(ef[2],ef[2],[ed[0]*em,0,0])),ed[1]<0?(en.v.add(ef[0],ef[0],[0,ed[1]*em,0]),en.v.add(ef[1],ef[1],[0,ed[1]*em,0])):ed[1]>0&&(en.v.add(ef[2],ef[2],[0,ed[1]*em,0]),en.v.add(ef[3],ef[3],[0,ed[1]*em,0]));let e_={};return e_.vertices=ef,e_.planes=[yr(ef[1],ef[0],ef[4]),yr(ef[2],ef[1],ef[5]),yr(ef[3],ef[2],ef[6]),yr(ef[0],ef[3],ef[7])],e_}addShadowReceiver(el,eu,ec){this._receivers.add(el,en.c3.fromTileIdAndHeight(el,eu,ec))}getMaxCascadeForTile(en){let el=this._receivers.get(en);return el&&el.lastCascade?el.lastCascade:0}};function yr(el,eu,ec){let ed=en.v.sub([],ec,eu),ef=en.v.sub([],el,eu),em=en.v.cross([],ed,ef),e_=en.v.length(em);return 0===e_?[0,0,1,0]:(en.v.scale(em,em,1/e_),[em[0],em[1],em[2],-en.v.dot(em,eu)])}function br(el){let eu=el.properties.get("direction"),ec=en.b3(eu.x,eu.y,eu.z);ec[2]=en.c(ec[2],0,75);let ed=en.ch([ec[0],ec[1],ec[2]]);return en.v.fromValues(ed.x,ed.y,ed.z)}function wr(el,eu){let ec=el.properties.get("color"),ed=el.properties.get("intensity"),ef=el.properties.get("direction"),em=[ef.x,ef.y,ef.z],e_=eu.properties.get("color"),ew=eu.properties.get("intensity"),eT=Math.max(en.v.dot([0,0,1],em),0),eM=[0,0,0];en.v.scale(eM,e_.toArray01Linear().slice(0,3),ew);let eE=[0,0,0];return en.v.scale(eE,ec.toArray01Linear().slice(0,3),eT*ed),en.bw([eM[0]>0?eM[0]/(eM[0]+eE[0]):0,eM[1]>0?eM[1]/(eM[1]+eE[1]):0,eM[2]>0?eM[2]/(eM[2]+eE[2]):0])}let Er=class Er extends en.a6{constructor(en){super(),this.requestManager=en,this.models={"":{}},this.numModelsLoading={}}loadModel(el,eu){return en.aO(this.requestManager.transformRequest(eu,en.a2.Model).url).then(eu=>{if(!eu)return;let ec=en.aP(eu),ed=new en.aQ(el,void 0,void 0,ec);return ed.computeBoundsAndApplyParent(),ed}).catch(ec=>{this.fire(new en.a7(Error(`Could not load model ${el} from ${eu}: ${ec.message}`)))})}load(el,eu){this.models[eu]||(this.models[eu]={});let ec=Object.keys(el);this.numModelsLoading[eu]=(this.numModelsLoading[eu]||0)+ec.length;let ed=[];for(let en of ec)ed.push(this.loadModel(en,el[en]));Promise.allSettled(ed).then(el=>{for(let en=0;en<el.length;en++){let{status:ed,value:ef}=el[en];"fulfilled"===ed&&ef&&(this.models[eu][ec[en]]=ef)}this.numModelsLoading[eu]-=ec.length,this.fire(new en.a8("data",{dataType:"style"}))}).catch(el=>{this.fire(new en.a7(Error(`Could not load models: ${el.message}`)))})}isLoaded(){for(let en in this.numModelsLoading)if(this.numModelsLoading[en]>0)return!1;return!0}hasModel(en,el){return!!this.getModel(en,el)}getModel(en,el){return this.models[el]||(this.models[el]={}),this.models[el][en]}addModel(en,el,eu){this.models[eu]||(this.models[eu]={}),this.hasModel(en,eu)&&this.removeModel(en,eu),this.load({[en]:this.requestManager.normalizeModelURL(el)},eu)}addModels(en,el){let eu={};for(let el in en)eu[el]=this.requestManager.normalizeModelURL(en[el]);this.load(eu,el)}removeModel(en,el){this.models[el]||(this.models[el]={});let eu=this.models[el][en];delete this.models[el][en],eu.destroy()}listModels(en){return this.models[en]||(this.models[en]={}),Object.keys(this.models[en])}upload(en,el){for(let eu in this.models[el]||(this.models[el]={}),this.models[el])this.models[el][eu].upload(en.context)}};let Cr=(el,eu)=>en.ai(el,eu&&eu.filter(en=>"source.canvas"!==en.identifier)),tI=en.p(ez,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection","setCamera","addImport","removeImport","setImportUrl","setImportData","setImportConfig"]),tC=en.p(ez,["setCenter","setZoom","setBearing","setPitch"]),tP={version:8,layers:[],sources:{}},tz={duration:300,delay:0},tD=new Set(["fill","line","background","hillshade","raster"]);let Dr=class Dr extends en.a6{constructor(el,eu={}){super(),this.map=el,this.scope=eu.scope||"",this.fragments=[],this.importDepth=eu.importDepth||0,this.importsCache=eu.importsCache||new Map,this.resolvedImports=eu.resolvedImports||new Set,this.transition=en.ak({},tz),this._buildingIndex=new ht(this),this.crossTileSymbolIndex=new Qt,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=eu.styleChanges||new v,this.dispatcher=eu.dispatcher?eu.dispatcher:new en.br(en.bs(),this),eu.imageManager?this.imageManager=eu.imageManager:(this.imageManager=new Re,this.imageManager.setEventedParent(this)),this.imageManager.createScope(this.scope),this.glyphManager=eu.glyphManager?eu.glyphManager:new en.cj(el._requestManager,eu.localFontFamily?en.ck.all:eu.localIdeographFontFamily?en.ck.ideographs:en.ck.none,eu.localFontFamily||eu.localIdeographFontFamily),eu.modelManager?this.modelManager=eu.modelManager:(this.modelManager=new Er(el._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._order=[],this._markersNeedUpdate=!1,this.options=eu.configOptions?eu.configOptions:new Map,this._configDependentLayers=eu.configDependentLayers?eu.configDependentLayers:new Set,this._config=eu.config,this.dispatcher.broadcast("setReferrer",en.cl());let ec=this;this._rtlTextPluginCallback=Dr.registerForPluginStateChange(el=>{ec.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:el.pluginStatus,pluginURL:el.pluginURL},(el,eu)=>{if(en.cm(el),eu&&eu.every(en=>en))for(let en in ec._sourceCaches){let el=ec._sourceCaches[en],eu=el.getSource().type;"vector"!==eu&&"geojson"!==eu||el.reload()}})}),this.on("data",en=>{if("source"!==en.dataType||"metadata"!==en.sourceDataType)return;let el=this.getOwnSource(en.sourceId);if(el&&el.vectorLayerIds)for(let en in this._layers){let eu=this._layers[en];eu.source===el.id&&this._validateLayer(eu)}})}loadURL(el,eu={}){this.fire(new en.a8("dataloading",{dataType:"style"}));let ec="boolean"==typeof eu.validate?eu.validate:!en.cn(el);el=this.map._requestManager.normalizeStyleURL(el,eu.accessToken),this.resolvedImports.add(el);let ed=this.importsCache.get(el);if(ed)return this._load(ed,ec);let ef=this.map._requestManager.transformRequest(el,en.a2.Style);this._request=en.a1(ef,(eu,ed)=>{if(this._request=null,eu)this.fire(new en.a7(eu));else if(ed)return this.importsCache.set(el,ed),this._load(ed,ec)})}loadJSON(el,eu={}){this.fire(new en.a8("dataloading",{dataType:"style"})),this._request=en.a4.frame(()=>{this._request=null,this._load(el,!1!==eu.validate)})}loadEmpty(){this.fire(new en.a8("dataloading",{dataType:"style"})),this._load(tP,!1)}_loadImports(el,eu){if(this.importDepth>=4)return en.X("Style doesn't support nesting deeper than 5"),Promise.resolve();let ec=[];for(let en of el){let el=this._createFragmentStyle(en),ed=new Promise(en=>{el.once("style.import.load",en),el.once("error",en)}).then(()=>this.mergeAll());if(ec.push(ed),this.resolvedImports.has(en.url)){el.loadEmpty();continue}let ef=en.data||this.importsCache.get(en.url);ef?el.loadJSON(ef,{validate:eu}):en.url?el.loadURL(en.url,{validate:eu}):el.loadEmpty(),this.fragments.push({style:el,id:en.id,config:en.config})}return Promise.allSettled(ec)}_createFragmentStyle(el){let eu=this.scope?en.aE(el.id,this.scope):el.id,ec=new Dr(this.map,{scope:eu,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:el.config,configOptions:this.options,configDependentLayers:this._configDependentLayers});return ec.setEventedParent(this.map,{style:ec}),ec}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options});let el=this.isRootStyle();this._shouldPrecompile=el,this.fire(new en.a8(el?"style.load":"style.import.load"))}_load(el,eu){let ec=el.schema;if(this.isRootStyle()&&(el.fragment||ec&&!1!==el.fragment)){let ec=en.ak({},tP,{imports:[{id:"basemap",data:el,url:""}]});return void this._load(ec,eu)}if(this.setConfig(this._config,ec),eu&&Cr(this,en.aj(el)))return;for(let eu in this._loaded=!0,this.stylesheet=en.co(el),el.sources)this.addSource(eu,el.sources[eu],{validate:!1,isInitialLoad:!0});el.sprite?this._loadSprite(el.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.glyphManager.setURL(el.glyphs,this.scope);let ed=dt(this.stylesheet.layers);if(this._order=ed.map(en=>en.id),this.stylesheet.light&&en.X("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights){if(1===this.stylesheet.lights.length&&"flat"===this.stylesheet.lights[0].type){let en=this.stylesheet.lights[0];this.light=new Oe(en.properties,en.id)}else this.setLights(this.stylesheet.lights)}for(let el of(this.light||(this.light=new Oe(this.stylesheet.light)),this._layers={},this._serializedLayers={},ed)){let eu=en.cp(el,this.scope,this.options);eu.isConfigDependent&&this._configDependentLayers.add(eu.fqid),eu.setEventedParent(this,{layer:{id:eu.id}}),this._layers[eu.id]=eu,this._serializedLayers[eu.id]=eu.serialize();let ec=this.getOwnLayerSourceCache(eu),ed=!!this.directionalLight&&this.directionalLight.shadowsEnabled();ec&&eu.canCastShadows()&&ed&&(ec.castsShadows=!0)}this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);let ef=this.stylesheet.terrain;ef&&(void 0===this.disableElevatedTerrain&&(this.disableElevatedTerrain=en.a4.hasCanvasFingerprintNoise()),this.disableElevatedTerrain?en.X("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."):this.terrainSetForDrapingOnly()||this._createTerrain(ef,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new en.a8("data",{dataType:"style"})),el.imports?this._loadImports(el.imports,eu).then(()=>this._reloadImports()):this._reloadImports()}isRootStyle(){return 0===this.importDepth}mergeAll(){let el,eu,ec,ed,ef,em,e_,ew;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(en=>{if(en.stylesheet){if(null!=en.light&&(el=en.light),en.stylesheet.lights)for(let el of en.stylesheet.lights)"ambient"===el.type&&null!=en.ambientLight&&(eu=en.ambientLight),"directional"===el.type&&null!=en.directionalLight&&(ec=en.directionalLight);ed=this._prioritizeTerrain(ed,en.terrain,en.stylesheet.terrain),en.stylesheet.fog&&null!=en.fog&&(ef=en.fog),null!=en.stylesheet.camera&&(ew=en.stylesheet.camera),null!=en.stylesheet.projection&&(em=en.stylesheet.projection),null!=en.stylesheet.transition&&(e_=en.stylesheet.transition)}}),this.light=el,this.ambientLight=eu,this.directionalLight=ec,this.fog=ef,null===ed?delete this.terrain:this.terrain=ed,this.camera=ew||{"camera-projection":"perspective"},this.projection=em||{name:"mercator"},this.transition=en.ak({},tz,e_),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(en){let t=el=>{for(let en of el.fragments)t(en.style);en(el)};t(this)}_prioritizeTerrain(en,el,eu){let ec=en&&0===en.drapeRenderMode;return null===eu?el&&0===el.drapeRenderMode?el:ec?en:null:null!=el&&(!en||ec||el&&1===el.drapeRenderMode)?el:en}mergeTerrain(){let en;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(el=>{en=this._prioritizeTerrain(en,el.terrain,el.stylesheet.terrain)}),null===en?delete this.terrain:this.terrain=en}mergeProjection(){let en;this.forEachFragmentStyle(el=>{null!=el.stylesheet.projection&&(en=el.stylesheet.projection)}),this.projection=en||{name:"mercator"}}mergeSources(){let el={},eu={},ec={};this.forEachFragmentStyle(ed=>{for(let eu in ed._sourceCaches){let ec=en.aE(eu,ed.scope);el[ec]=ed._sourceCaches[eu]}for(let el in ed._otherSourceCaches){let ec=en.aE(el,ed.scope);eu[ec]=ed._otherSourceCaches[el]}for(let el in ed._symbolSourceCaches){let eu=en.aE(el,ed.scope);ec[eu]=ed._symbolSourceCaches[el]}}),this._mergedSourceCaches=el,this._mergedOtherSourceCaches=eu,this._mergedSymbolSourceCaches=ec}mergeLayers(){let el={},eu=[],ec={};this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(ec=>{for(let ed of ec._order){let ef=ec._layers[ed];if("slot"===ef.type){let eu=en.cq(ed);if(el[eu])continue;el[eu]=[]}ef.slot&&el[ef.slot]?el[ef.slot].push(ef):eu.push(ef)}}),this._mergedOrder=[];let r=(eu=[])=>{for(let ed of eu)if("slot"===ed.type){let eu=en.cq(ed.id);el[eu]&&r(el[eu])}else{let el=en.aE(ed.id,ed.scope);this._mergedOrder.push(el),ec[el]=ed,ed.is3D()&&(this._has3DLayers=!0),"circle"===ed.type&&(this._hasCircleLayers=!0),"symbol"===ed.type&&(this._hasSymbolLayers=!0)}};r(eu),this._mergedLayers=ec,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&0===this.terrain.drapeRenderMode}getCamera(){return this.stylesheet.camera}setCamera(el){return this.stylesheet.camera=en.ak({},this.stylesheet.camera,el),this.camera=this.stylesheet.camera,this}setProjection(en){en?this.stylesheet.projection=en:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?this.getTerrain()||this.stylesheet.terrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(el){this._spriteRequest=function(el,eu,ec){let ed,ef,em;let e_=en.a4.devicePixelRatio>1?"@2x":"",ew=en.a1(eu.transformRequest(eu.normalizeSpriteURL(el,e_,".json"),en.a2.SpriteJSON),(en,el)=>{ew=null,em||(em=en,ed=el,h())}),eT=en.a3(eu.transformRequest(eu.normalizeSpriteURL(el,e_,".png"),en.a2.SpriteImage),(en,el)=>{eT=null,em||(em=en,ef=el,h())});function h(){if(em)ec(em);else if(ed&&ef){let el=en.a4.getImageData(ef),eu={};for(let ec in ed){let{width:ef,height:em,x:e_,y:ew,sdf:eT,pixelRatio:eM,stretchX:eE,stretchY:eS,content:eA}=ed[ec],eI=new en.a5({width:ef,height:em});en.a5.copy(el,eI,{x:e_,y:ew},{x:0,y:0},{width:ef,height:em}),eu[ec]={data:eI,pixelRatio:eM,sdf:eT,stretchX:eE,stretchY:eS,content:eA}}ec(null,eu)}}return{cancel(){ew&&(ew.cancel(),ew=null),eT&&(eT.cancel(),eT=null)}}}(el,this.map._requestManager,(el,eu)=>{if(this._spriteRequest=null,el)this.fire(new en.a7(el));else if(eu)for(let en in eu)this.imageManager.addImage(en,this.scope,eu[en]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new en.a8("data",{dataType:"style"}))})}_validateLayer(el){let eu=this.getOwnSource(el.source);if(!eu)return;let ec=el.sourceLayer;ec&&("geojson"===eu.type||eu.vectorLayerIds&&-1===eu.vectorLayerIds.indexOf(ec))&&this.fire(new en.a7(Error(`Source layer "${ec}" does not exist on source "${eu.id}" as specified by style layer "${el.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(let en in this._sourceCaches)if(!this._sourceCaches[en].loaded())return!1;if(!this.imageManager.isLoaded()||!this.modelManager.isLoaded())return!1;for(let{style:en}of this.fragments)if(!en.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((en,el)=>{let eu=this.fragments[el];return eu&&eu.style&&(en.data=eu.style.serialize()),en})}_serializeSources(){let en={};for(let el in this._sourceCaches){let eu=this._sourceCaches[el].getSource();en[eu.id]||(en[eu.id]=eu.serialize())}return en}_serializeLayers(en){let el=[];for(let eu of en){let en=this._layers[eu];en&&"custom"!==en.type&&el.push(en.serialize())}return el}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition())return!0;for(let en in this._sourceCaches)if(this._sourceCaches[en].hasTransition())return!0;for(let en in this._layers)if(this._layers[en].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}isLayerDraped(en){return!!this.terrain&&("function"==typeof en.isLayerDraped?en.isLayerDraped(this.getLayerSourceCache(en)):tD.has(en.type))}_checkLoaded(){if(!this._loaded)throw Error("Style is not done loading")}_checkLayer(el){let eu=this.getOwnLayer(el);if(eu)return eu;this.fire(new en.a7(Error(`The layer '${el}' does not exist in the map's style.`)))}_checkSource(el){let eu=this.getOwnSource(el);if(eu)return eu;this.fire(new en.a7(Error(`The source '${el}' does not exist in the map's style.`)))}update(el){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(el),this.directionalLight&&this.directionalLight.recalculate(el);let eu=this.calculateLightsBrightness();el.brightness=eu||0,eu!==this._brightness&&(this._brightness=eu,this.dispatcher.broadcast("setBrightness",eu));let ec=this._changes.isDirty();if(this._changes.isDirty()){let en=this._changes.getLayerUpdatesByScope();for(let el in en){let{updatedIds:eu,removedIds:ec}=en[el];(eu||ec)&&this._updateWorkerLayers(el,eu,ec)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(el),this.light&&this.light.updateTransitions(el),this.ambientLight&&this.ambientLight.updateTransitions(el),this.directionalLight&&this.directionalLight.updateTransitions(el),this.fog&&this.fog.updateTransitions(el),this._changes.reset()}let ed={};for(let en in this._mergedSourceCaches){let el=this._mergedSourceCaches[en];ed[en]=el.used,el.used=!1}for(let en of this._mergedOrder){let eu=this._mergedLayers[en];if(eu.recalculate(el,this._availableImages),!eu.isHidden(el.zoom)){let en=this.getLayerSourceCache(eu);en&&(en.used=!0)}if(!this._precompileDone&&this._shouldPrecompile)for(let en=eu.minzoom||0;en<(eu.maxzoom||25.5);en++){let en=this.map.painter;if(en){let ec=eu.getProgramIds();if(!ec)continue;for(let ed of ec){let ec=eu.getDefaultProgramParams(ed,el.zoom);ec&&(en.style=this,this.fog&&(en._fogVisible=!0,ec.overrideFog=!0,en.getOrCreateProgram(ed,ec)),en._fogVisible=!1,ec.overrideFog=!1,en.getOrCreateProgram(ed,ec),(this.stylesheet.terrain||this.stylesheet.projection&&"globe"===this.stylesheet.projection.name)&&(ec.overrideRtt=!0,en.getOrCreateProgram(ed,ec)))}}}}for(let el in this._shouldPrecompile&&(this._precompileDone=!0),ed){let eu=this._mergedSourceCaches[el];ed[el]!==eu.used&&eu.getSource().fire(new en.a8("data",{sourceDataType:"visibility",dataType:"source",sourceId:eu.getSource().id}))}this.light&&this.light.recalculate(el),this.terrain&&this.terrain.recalculate(el),this.fog&&this.fog.recalculate(el),this.z=el.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),ec&&this.fire(new en.a8("data",{dataType:"style"}))}_updateTilesForChangedImages(){let en=this._changes.getUpdatedImages();if(en.length){for(let el in this._sourceCaches)this._sourceCaches[el].reloadTilesForDependencies(["icons","patterns"],en);this._changes.resetUpdatedImages()}}_updateWorkerLayers(en,el,eu){let ec=this.getFragmentStyle(en);ec&&this.dispatcher.broadcast("updateLayers",{layers:el?ec._serializeLayers(el):[],scope:en,removedIds:eu||[],options:ec.options})}setState(el){if(this._checkLoaded(),Cr(this,en.aj(el)))return!1;(el=en.co(el)).layers=dt(el.layers);let eu=(function(en,el){if(!en)return[{command:ez.setStyle,args:[el]}];let eu=[];try{if(!t(en.version,el.version))return[{command:ez.setStyle,args:[el]}];t(en.center,el.center)||eu.push({command:ez.setCenter,args:[el.center]}),t(en.zoom,el.zoom)||eu.push({command:ez.setZoom,args:[el.zoom]}),t(en.bearing,el.bearing)||eu.push({command:ez.setBearing,args:[el.bearing]}),t(en.pitch,el.pitch)||eu.push({command:ez.setPitch,args:[el.pitch]}),t(en.sprite,el.sprite)||eu.push({command:ez.setSprite,args:[el.sprite]}),t(en.glyphs,el.glyphs)||eu.push({command:ez.setGlyphs,args:[el.glyphs]}),t(en.imports,el.imports)||function(en=[],el=[],eu){let ec,ed,ef,em;el=el||[];let e_=(en=en||[]).map(xt),ew=el.map(xt),eT=en.reduce(yt,{}),eM=el.reduce(yt,{}),eE=e_.slice();for(ec=0,ed=0;ec<e_.length;ec++)ef=e_[ec],eM.hasOwnProperty(ef)?ed++:(eu.push({command:ez.removeImport,args:[ef]}),eE.splice(eE.indexOf(ef,ed),1));for(ec=0,ed=0;ec<ew.length;ec++)ef=ew[ew.length-1-ec],eE[eE.length-1-ec]!==ef&&(eT.hasOwnProperty(ef)?(eu.push({command:ez.removeImport,args:[ef]}),eE.splice(eE.lastIndexOf(ef,eE.length-ed),1)):ed++,em=eE[eE.length-ec],eu.push({command:ez.addImport,args:[eM[ef],em]}),eE.splice(eE.length-ec,0,ef));for(let en of el){let el=eT[en.id];if(!el||t(el,en))continue;t(el.config,en.config)||eu.push({command:ez.setImportConfig,args:[en.id,en.config]}),t(el.url,en.url)||eu.push({command:ez.setImportUrl,args:[en.id,en.url]});let ec=en.data;t(el&&el.data,ec)||eu.push({command:ez.setImportData,args:[en.id,ec]})}}(en.imports,el.imports,eu),t(en.transition,el.transition)||eu.push({command:ez.setTransition,args:[el.transition]}),t(en.light,el.light)||eu.push({command:ez.setLight,args:[el.light]}),t(en.fog,el.fog)||eu.push({command:ez.setFog,args:[el.fog]}),t(en.projection,el.projection)||eu.push({command:ez.setProjection,args:[el.projection]}),t(en.lights,el.lights)||eu.push({command:ez.setLights,args:[el.lights]}),t(en.camera,el.camera)||eu.push({command:ez.setCamera,args:[el.camera]});let ec={},ed=[];!function(en,el,eu,ec){let ed;for(ed in el=el||{},en=en||{})en.hasOwnProperty(ed)&&(el.hasOwnProperty(ed)||mt(ed,eu,ec));for(ed in el){var ef,em;if(!el.hasOwnProperty(ed))continue;let e_=el[ed];en.hasOwnProperty(ed)?t(en[ed],e_)||("geojson"===en[ed].type&&"geojson"===e_.type&&function(en,el,eu){let ec;for(ec in en[eu])if(en[eu].hasOwnProperty(ec)&&"data"!==ec&&!t(en[eu][ec],el[eu][ec]))return!1;for(ec in el[eu])if(el[eu].hasOwnProperty(ec)&&"data"!==ec&&!t(en[eu][ec],el[eu][ec]))return!1;return!0}(en,el,ed)?eu.push({command:ez.setGeoJSONSourceData,args:[ed,e_.data]}):(ef=ed,em=el,mt(ef,eu,ec),pt(ef,em,eu))):pt(ed,el,eu)}}(en.sources,el.sources,ed,ec);let ef=[];en.layers&&en.layers.forEach(en=>{en.source&&ec[en.source]?eu.push({command:ez.removeLayer,args:[en.id]}):ef.push(en)});let em=en.terrain;em&&ec[em.source]&&(eu.push({command:ez.setTerrain,args:[void 0]}),em=void 0),eu=eu.concat(ed),t(em,el.terrain)||eu.push({command:ez.setTerrain,args:[el.terrain]}),function(en,el,eu){let ec,ed,ef,em,e_,ew,eT;el=el||[];let eM=(en=en||[]).map(xt),eE=el.map(xt),eS=en.reduce(yt,{}),eA=el.reduce(yt,{}),eI=eM.slice(),eC=Object.create(null);for(ec=0,ed=0;ec<eM.length;ec++)ef=eM[ec],eA.hasOwnProperty(ef)?ed++:(eu.push({command:ez.removeLayer,args:[ef]}),eI.splice(eI.indexOf(ef,ed),1));for(ec=0,ed=0;ec<eE.length;ec++)ef=eE[eE.length-1-ec],eI[eI.length-1-ec]!==ef&&(eS.hasOwnProperty(ef)?(eu.push({command:ez.removeLayer,args:[ef]}),eI.splice(eI.lastIndexOf(ef,eI.length-ed),1)):ed++,ew=eI[eI.length-ec],eu.push({command:ez.addLayer,args:[eA[ef],ew]}),eI.splice(eI.length-ec,0,ef),eC[ef]=!0);for(ec=0;ec<eE.length;ec++)if(em=eS[ef=eE[ec]],e_=eA[ef],!eC[ef]&&!t(em,e_)){if(t(em.source,e_.source)&&t(em["source-layer"],e_["source-layer"])&&t(em.type,e_.type)){for(eT in vt(em.layout,e_.layout,eu,ef,null,ez.setLayoutProperty),vt(em.paint,e_.paint,eu,ef,null,ez.setPaintProperty),t(em.slot,e_.slot)||eu.push({command:ez.setSlot,args:[ef,e_.slot]}),t(em.filter,e_.filter)||eu.push({command:ez.setFilter,args:[ef,e_.filter]}),t(em.minzoom,e_.minzoom)&&t(em.maxzoom,e_.maxzoom)||eu.push({command:ez.setLayerZoomRange,args:[ef,e_.minzoom,e_.maxzoom]}),em)em.hasOwnProperty(eT)&&"layout"!==eT&&"paint"!==eT&&"filter"!==eT&&"metadata"!==eT&&"minzoom"!==eT&&"maxzoom"!==eT&&"slot"!==eT&&(0===eT.indexOf("paint.")?vt(em[eT],e_[eT],eu,ef,eT.slice(6),ez.setPaintProperty):t(em[eT],e_[eT])||eu.push({command:ez.setLayerProperty,args:[ef,eT,e_[eT]]}));for(eT in e_)e_.hasOwnProperty(eT)&&!em.hasOwnProperty(eT)&&"layout"!==eT&&"paint"!==eT&&"filter"!==eT&&"metadata"!==eT&&"minzoom"!==eT&&"maxzoom"!==eT&&"slot"!==eT&&(0===eT.indexOf("paint.")?vt(em[eT],e_[eT],eu,ef,eT.slice(6),ez.setPaintProperty):t(em[eT],e_[eT])||eu.push({command:ez.setLayerProperty,args:[ef,eT,e_[eT]]}))}else eu.push({command:ez.removeLayer,args:[ef]}),ew=eI[eI.lastIndexOf(ef)+1],eu.push({command:ez.addLayer,args:[e_,ew]})}}(ef,el.layers,eu)}catch(en){console.warn("Unable to compute style diff:",en),eu=[{command:ez.setStyle,args:[el]}]}return eu})(this.serialize(),el).filter(en=>!(en.command in tC));if(0===eu.length)return!1;let ec=eu.filter(en=>!(en.command in tI));if(ec.length>0)throw Error(`Unimplemented: ${ec.map(en=>en.command).join(", ")}.`);return eu.forEach(en=>{this[en.command].apply(this,en.args)}),this.stylesheet=el,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}addImage(el,eu){return this.getImage(el)?this.fire(new en.a7(Error("An image with this name already exists."))):(this.imageManager.addImage(el,this.scope,eu),this._afterImageUpdated(el),this)}updateImage(en,el){this.imageManager.updateImage(en,this.scope,el)}getImage(en){return this.imageManager.getImage(en,this.scope)}removeImage(el){return this.getImage(el)?(this.imageManager.removeImage(el,this.scope),this._afterImageUpdated(el),this):this.fire(new en.a7(Error("No image with this name exists.")))}_afterImageUpdated(el){this._availableImages=this.imageManager.listImages(this.scope),this._changes.updateImage(el),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.fire(new en.a8("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(el,eu,ec={}){return this._checkLoaded(),this._validate(en.cr,`models.${el}`,eu,null,ec)||(this.modelManager.addModel(el,eu,this.scope),this._changes.setDirty()),this}hasModel(en){return this.modelManager.hasModel(en,this.scope)}removeModel(el){return this.hasModel(el)?(this.modelManager.removeModel(el,this.scope),this):this.fire(new en.a7(Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(el,eu,ec={}){if(this._checkLoaded(),void 0!==this.getOwnSource(el))throw Error(`There is already a source with ID "${el}".`);if(!eu.type)throw Error(`The type property must be defined, but only the following properties were given: ${Object.keys(eu).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(eu.type)>=0&&this._validate(en.cs,`sources.${el}`,eu,null,ec))return;this.map&&this.map._collectResourceTiming&&(eu.collectResourceTiming=!0);let ed=st(el,eu,this.dispatcher,this);ed.scope=this.scope,ed.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(ed.id),source:ed.serialize(),sourceId:ed.id}));let s=el=>{let eu=(el?"symbol:":"other:")+ed.id,ec=en.aE(eu,this.scope),ef=this._sourceCaches[eu]=new en.bq(ec,ed,el);(el?this._symbolSourceCaches:this._otherSourceCaches)[ed.id]=ef,ef.onAdd(this.map)};s(!1),"vector"!==eu.type&&"geojson"!==eu.type||s(!0),ed.onAdd&&ed.onAdd(this.map),ec.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(el){this._checkLoaded();let eu=this.getOwnSource(el);if(!eu)throw Error("There is no source with this ID");for(let eu in this._layers)if(this._layers[eu].source===el)return this.fire(new en.a7(Error(`Source "${el}" cannot be removed while layer "${eu}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===el)return this.fire(new en.a7(Error(`Source "${el}" cannot be removed while terrain is using it.`)));let ec=this.getOwnSourceCaches(el);for(let el of ec){let eu=en.cq(el.id);delete this._sourceCaches[eu],this._changes.discardSourceCacheUpdate(el.id),el.fire(new en.a8("data",{sourceDataType:"metadata",dataType:"source",sourceId:el.getSource().id})),el.setEventedParent(null),el.clearTiles()}return delete this._otherSourceCaches[el],delete this._symbolSourceCaches[el],this.mergeSources(),eu.setEventedParent(null),eu.onRemove&&eu.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(en,el){this._checkLoaded(),this.getOwnSource(en).setData(el),this._changes.setDirty()}getOwnSource(en){let el=this.getOwnSourceCache(en);return el&&el.getSource()}getOwnSources(){let en=[];for(let el in this._otherSourceCaches){let eu=this.getOwnSourceCache(el);eu&&en.push(eu.getSource())}return en}areTilesLoaded(){let en=this._mergedSourceCaches;for(let el in en){let eu=en[el]._tiles;for(let en in eu){let el=eu[en];if("loaded"!==el.state&&"errored"!==el.state)return!1}}return!0}setLights(el){if(this._checkLoaded(),!el)return delete this.ambientLight,void delete this.directionalLight;let eu=this._getTransitionParameters();for(let ec of el){if(this._validate(en.ct,"lights",ec))return;switch(ec.type){case"ambient":if(this.ambientLight){let en=this.ambientLight;en.set(ec),en.updateTransitions(eu)}else this.ambientLight=new qe(ec,eI,this.scope,this.options);break;case"directional":if(this.directionalLight){let en=this.directionalLight;en.set(ec),en.updateTransitions(eu)}else this.directionalLight=new qe(ec,eC,this.scope,this.options)}}let ec=new en.al(this.z||0,eu);this.ambientLight&&this.ambientLight.recalculate(ec),this.directionalLight&&this.directionalLight.recalculate(ec),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){let el=this.directionalLight,eu=this.ambientLight;if(!el||!eu)return;let o=en=>.2126*(en[0]<=.03928?en[0]/12.92:Math.pow((en[0]+.055)/1.055,2.4))+.7152*(en[1]<=.03928?en[1]/12.92:Math.pow((en[1]+.055)/1.055,2.4))+.0722*(en[2]<=.03928?en[2]/12.92:Math.pow((en[2]+.055)/1.055,2.4)),ec=el.properties.get("color").toArray01(),ed=el.properties.get("intensity"),ef=el.properties.get("direction"),em=1-en.b3(ef.x,ef.y,ef.z)[2]/90,e_=o(ec)*ed*em,ew=eu.properties.get("color").toArray01(),eT=eu.properties.get("intensity");return(e_+o(ew)*eT)/2}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;let en=[];return this.directionalLight&&en.push(this.directionalLight.get()),this.ambientLight&&en.push(this.ambientLight.get()),en}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(el){if(!el)return this;if(en.cu(el)){let eu=en.cv(el),ec=this.fragments.find(({id:en})=>en===eu);if(!ec)throw Error(`Style import not found: ${el}`);let ed=en.cq(el);return ec.style.getFragmentStyle(ed)}{let en=this.fragments.find(({id:en})=>en===el);if(!en)throw Error(`Style import not found: ${el}`);return en.style}}getConfigProperty(el,eu){let ec=this.getFragmentStyle(el);if(!ec)return null;let ed=en.aE(eu,ec.scope),ef=ec.options.get(ed),em=ef?ef.value||ef.default:null;return em?em.serialize():null}setConfigProperty(el,eu,ec){let ed=en.cw(ec);if("success"!==ed.result)return void Cr(this,ed.value);let ef=ed.value.expression,em=this.getFragmentStyle(el);if(!em)return;let e_=en.aE(eu,em.scope),ew=em.options.get(e_);ew&&(this.options.set(e_,{...ew,value:ef}),this.updateConfigDependencies())}setConfig(el,eu){if(this._config=el,el||eu){if(eu)for(let ec in eu){let ed,ef;let em=en.cw(eu[ec].default);if("success"===em.result&&(ed=em.value.expression),el&&void 0!==el[ec]){let eu=en.cw(el[ec]);"success"===eu.result&&(ef=eu.value.expression)}let{minValue:e_,maxValue:ew,stepValue:eT,type:eM,values:eE}=eu[ec];if(ed){let el=en.aE(ec,this.scope);this.options.set(el,{default:ed,value:ef,minValue:e_,maxValue:ew,stepValue:eT,type:eM,values:eE})}else this.fire(new en.a7(Error(`No schema defined for config option "${ec}".`)))}else this.fire(new en.a7(Error("Attempting to set config for a style without schema.")))}}updateConfigDependencies(){for(let en of this._configDependentLayers){let el=this.getLayer(en);el&&(el.possiblyEvaluateVisibility(),this._updateLayer(el))}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this._changes.setDirty()}addLayer(el,eu,ec={}){let ed;this._checkLoaded();let ef=el.id;if(this._layers[ef])return void this.fire(new en.a7(Error(`Layer with id "${ef}" already exists on this map`)));if("custom"===el.type){if(Cr(this,en.cx(el)))return;ed=en.cp(el,this.scope,this.options)}else{if("object"==typeof el.source&&(this.addSource(ef,el.source),el=en.co(el),el=en.ak(el,{source:ef})),this._validate(en.cy,`layers.${ef}`,el,{arrayIndex:-1},ec))return;ed=en.cp(el,this.scope,this.options),this._validateLayer(ed),ed.setEventedParent(this,{layer:{id:ef}}),this._serializedLayers[ed.id]=ed.serialize()}ed.isConfigDependent&&this._configDependentLayers.add(ed.fqid);let em=this._order.length;if(eu){let el=this._order.indexOf(eu);if(-1===el)return void this.fire(new en.a7(Error(`Layer with id "${eu}" does not exist on this map.`)));ed.slot===this._layers[eu].slot?em=el:en.X(`Layer with id "${eu}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(em,0,ef),this._layerOrderChanged=!0,this._layers[ef]=ed;let e_=this.getOwnLayerSourceCache(ed),ew=!!this.directionalLight&&this.directionalLight.shadowsEnabled();e_&&ed.canCastShadows()&&ew&&(e_.castsShadows=!0);let eT=this._changes.getRemovedLayer(ed);if(eT&&ed.source&&e_&&"custom"!==ed.type){this._changes.discardLayerRemoval(ed);let el=en.aE(ed.source,ed.scope);eT.type!==ed.type?this._changes.updateSourceCache(el,"clear"):(this._changes.updateSourceCache(el,"reload"),e_.pause())}this._updateLayer(ed),ed.onAdd&&ed.onAdd(this.map),ed.scope=this.scope,this.mergeLayers()}moveLayer(el,eu){this._checkLoaded();let ec=this._checkLayer(el);if(!ec||el===eu)return;let ed=this._order.indexOf(el);this._order.splice(ed,1);let ef=this._order.length;if(eu){let el=this._order.indexOf(eu);if(-1===el)return void this.fire(new en.a7(Error(`Layer with id "${eu}" does not exist on this map.`)));ec.slot===this._layers[eu].slot?ef=el:en.X(`Layer with id "${eu}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(ef,0,el),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(en){this._checkLoaded();let el=this._checkLayer(en);if(!el)return;el.setEventedParent(null);let eu=this._order.indexOf(en);this._order.splice(eu,1),delete this._layers[en],delete this._serializedLayers[en],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(el.fqid),this._changes.removeLayer(el);let ec=this.getOwnLayerSourceCache(el);if(ec&&ec.castsShadows){let en=!1;for(let eu in this._layers)if(this._layers[eu].source===el.source&&this._layers[eu].canCastShadows()){en=!0;break}ec.castsShadows=en}el.onRemove&&el.onRemove(this.map),this.mergeLayers()}getOwnLayer(en){return this._layers[en]}hasLayer(en){return en in this._mergedLayers}hasLayerType(en){for(let el in this._layers)if(this._layers[el].type===en)return!0;return!1}setLayerZoomRange(en,el,eu){this._checkLoaded();let ec=this._checkLayer(en);ec&&(ec.minzoom===el&&ec.maxzoom===eu||(null!=el&&(ec.minzoom=el),null!=eu&&(ec.maxzoom=eu),this._updateLayer(ec)))}setSlot(en,el){this._checkLoaded();let eu=this._checkLayer(en);eu&&eu.slot!==el&&(eu.slot=el,this._updateLayer(eu))}setFilter(el,eu,ec={}){this._checkLoaded();let ed=this._checkLayer(el);if(ed&&!t(ed.filter,eu))return null==eu?(ed.filter=void 0,void this._updateLayer(ed)):void(this._validate(en.cz,`layers.${ed.id}.filter`,eu,{layerType:ed.type},ec)||(ed.filter=en.co(eu),this._updateLayer(ed)))}getFilter(el){let eu=this._checkLayer(el);if(eu)return en.co(eu.filter)}setLayoutProperty(en,el,eu,ec={}){this._checkLoaded();let ed=this._checkLayer(en);ed&&(t(ed.getLayoutProperty(el),eu)||(ed.setLayoutProperty(el,eu,ec),ed.isConfigDependent&&this._configDependentLayers.add(ed.fqid),this._updateLayer(ed)))}getLayoutProperty(en,el){let eu=this._checkLayer(en);if(eu)return eu.getLayoutProperty(el)}setPaintProperty(en,el,eu,ec={}){this._checkLoaded();let ed=this._checkLayer(en);if(!ed||t(ed.getPaintProperty(el),eu))return;let ef=ed.setPaintProperty(el,eu,ec);ed.isConfigDependent&&this._configDependentLayers.add(ed.fqid),ef&&this._updateLayer(ed),this._changes.updatePaintProperties(ed)}getPaintProperty(en,el){let eu=this._checkLayer(en);if(eu)return eu.getPaintProperty(el)}setFeatureState(el,eu){this._checkLoaded();let ec=el.source,ed=el.sourceLayer,ef=this._checkSource(ec);if(!ef)return;let em=ef.type;if("geojson"===em&&ed)return void this.fire(new en.a7(Error("GeoJSON sources cannot have a sourceLayer parameter.")));if("vector"===em&&!ed)return void this.fire(new en.a7(Error("The sourceLayer parameter must be provided for vector source types.")));void 0===el.id&&this.fire(new en.a7(Error("The feature id parameter must be provided.")));let e_=this.getOwnSourceCaches(ec);for(let en of e_)en.setFeatureState(ed,el.id,eu)}removeFeatureState(el,eu){this._checkLoaded();let ec=el.source,ed=this._checkSource(ec);if(!ed)return;let ef=ed.type,em="vector"===ef?el.sourceLayer:void 0;if("vector"===ef&&!em)return void this.fire(new en.a7(Error("The sourceLayer parameter must be provided for vector source types.")));if(eu&&"string"!=typeof el.id&&"number"!=typeof el.id)return void this.fire(new en.a7(Error("A feature id is required to remove its specific state property.")));let e_=this.getOwnSourceCaches(ec);for(let en of e_)en.removeFeatureState(em,el.id,eu)}getFeatureState(el){this._checkLoaded();let eu=el.source,ec=el.sourceLayer,ed=this._checkSource(eu);if(ed){if("vector"!==ed.type||ec)return void 0===el.id&&this.fire(new en.a7(Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(eu)[0].getFeatureState(ec,el.id);this.fire(new en.a7(Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(el){return this.stylesheet.transition=en.ak({},this.stylesheet.transition,el),this.transition=this.stylesheet.transition,this}getTransition(){return en.ak({},this.stylesheet.transition)}serialize(){this._checkLoaded();let el=this.getTerrain(),eu=el&&this.terrain&&this.terrain.scope===this.scope?el:this.stylesheet.terrain;return en.cA({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:eu,fog:this.stylesheet.fog,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},en=>void 0!==en)}_updateLayer(el){this._changes.updateLayer(el);let eu=this.getLayerSourceCache(el),ec=en.aE(el.source,el.scope),ed=this._changes.getUpdatedSourceCaches();el.source&&!ed[ec]&&eu&&"raster"!==eu.getSource().type&&(this._changes.updateSourceCache(ec,"reload"),eu.pause()),el.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(en){let t=en=>"fill-extrusion"===this._mergedLayers[en].type,el=this.order,eu={},ec=[];for(let ed=el.length-1;ed>=0;ed--){let ef=el[ed];if(t(ef))for(let el of(eu[ef]=ed,en)){let en=el[ef];if(en)for(let el of en)ec.push(el)}}ec.sort((en,el)=>el.intersectionZ-en.intersectionZ);let ed=[];for(let ef=el.length-1;ef>=0;ef--){let em=el[ef];if(t(em))for(let en=ec.length-1;en>=0;en--){let el=ec[en].feature;if(eu[el.layer.id]<ef)break;ed.push(el),ec.pop()}else for(let el of en){let en=el[em];if(en)for(let el of en)ed.push(el.feature)}}return ed}queryRenderedFeatures(el,eu,ec){eu&&eu.filter&&this._validate(en.cz,"queryRenderedFeatures.filter",eu.filter,null,eu),eu.scope=this.scope,eu.availableImages=this._availableImages,eu.serializedLayers=this._serializedLayers;let ed={};if(eu&&eu.layers){if(!Array.isArray(eu.layers))return this.fire(new en.a7(Error("parameters.layers must be an Array."))),[];for(let el of eu.layers){let eu=this._mergedLayers[el];if(!eu)return this.fire(new en.a7(Error(`The layer '${el}' does not exist in the map's style and cannot be queried for features.`))),[];ed[eu.source]=!0}}let ef=[],em=eu.serializedLayers||{},e_=eu&&eu.layers?eu.layers.some(en=>{let el=this.getLayer(en);return el&&el.is3D()}):this.has3DLayers(),ew=Je.createFromScreenPoints(el,ec);for(let el in this._mergedSourceCaches){let eT=this._mergedSourceCaches[el].getSource();if(!eT||eT.scope!==eu.scope)continue;let eM=this._mergedSourceCaches[el].getSource().id;eu.layers&&!ed[eM]||ef.push(function(el,eu,ec,ed,ef,em,e_,ew=!1){let eT=el.tilesIn(ed,e_,ew);eT.sort(ct);let eM=[];for(let ed of eT)eM.push({wrappedTileID:ed.tile.tileID.wrapped().key,queryResults:ed.tile.queryRenderedFeatures(eu,ec,el._state,ed,ef,em,function(el,eu){let ec=en.m.identity([]);return en.m.scale(ec,ec,[.5*el.width,-(.5*el.height),1]),en.m.translate(ec,ec,[1,-1,0]),en.m.multiply(ec,ec,el.calculateProjMatrix(eu.toUnwrapped())),Float32Array.from(ec)}(el.transform,ed.tile.tileID),ew)});let eE=function(en){let el={},eu={};for(let ec of en){let en=ec.queryResults,ed=ec.wrappedTileID,ef=eu[ed]=eu[ed]||{};for(let eu in en){let ec=en[eu],ed=ef[eu]=ef[eu]||{},em=el[eu]=el[eu]||[];for(let en of ec)ed[en.featureIndex]||(ed[en.featureIndex]=!0,em.push(en))}}return el}(eM);for(let en in eE)eE[en].forEach(en=>{let eu=en.feature,ec=eu.layer;ec&&"background"!==ec.type&&"sky"!==ec.type&&"slot"!==ec.type&&(eu.source=ec.source,ec["source-layer"]&&(eu.sourceLayer=ec["source-layer"]),eu.state=void 0!==eu.id?el.getFeatureState(ec["source-layer"],eu.id):{})});return eE}(this._mergedSourceCaches[el],this._mergedLayers,em,ew,eu,ec,e_,!!this.map._showQueryGeometry))}return this.placement&&ef.push(function(en,el,eu,ec,ed,ef,em){let e_={},ew=ef.queryRenderedSymbols(ec),eT=[];for(let en of Object.keys(ew).map(Number))eT.push(em[en]);for(let eu of(eT.sort(ct),eT)){let ec=eu.featureIndex.lookupSymbolFeatures(ew[eu.bucketInstanceId],el,eu.bucketIndex,eu.sourceLayerIndex,ed.filter,ed.layers,ed.availableImages,en);for(let en in ec){let el=e_[en]=e_[en]||[],ed=ec[en];for(let en of(ed.sort((en,el)=>{let ec=eu.featureSortOrder;if(ec){let eu=ec.indexOf(en.featureIndex);return ec.indexOf(el.featureIndex)-eu}return el.featureIndex-en.featureIndex}),ed))el.push(en)}}for(let el in e_)e_[el].forEach(ec=>{let ed=ec.feature,ef=eu(en[el]);if(!ef)return;let em=ef.getFeatureState(ed.layer["source-layer"],ed.id);ed.source=ed.layer.source,ed.layer["source-layer"]&&(ed.sourceLayer=ed.layer["source-layer"]),ed.state=em});return e_}(this._mergedLayers,em,this.getLayerSourceCache.bind(this),ew.screenGeometry,eu,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(ef)}querySourceFeatures(el,eu){eu&&eu.filter&&this._validate(en.cz,"querySourceFeatures.filter",eu.filter,null,eu);let ec=this.getOwnSourceCaches(el),ed=[];for(let en of ec)ed=ed.concat(function(en,el){let eu=en.getRenderableIds().map(el=>en.getTileByID(el)),ec=[],ed={};for(let en=0;en<eu.length;en++){let ef=eu[en],em=ef.tileID.canonical.key;ed[em]||(ed[em]=!0,ef.querySourceFeatures(ec,el))}return ec}(en,eu));return ed}addSourceType(en,el,eu){return Dr.getSourceType(en)?eu(Error(`A source type called "${en}" already exists.`)):(Dr.setSourceType(en,el),el.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:en,url:el.workerSourceURL},eu):eu(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(en,el,eu={}){this._checkLoaded();let ec=this.light.getLight(),ed=!1;for(let el in en)if(!t(en[el],ec[el])){ed=!0;break}if(!ed)return;let ef=this._getTransitionParameters();this.light.setLight(en,el,eu),this.light.updateTransitions(ef)}getTerrain(){return this.terrain&&1===this.terrain.drapeRenderMode?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}setTerrain(el,eu=1){if(this._checkLoaded(),!el)return delete this.terrain,null===el?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);let ec=el,ed=null==el.source;if(1===eu){if("object"==typeof ec.source){let el="terrain-dem-src";this.addSource(el,ec.source),ec=en.co(ec),ec=en.ak(ec,{source:el})}let el=en.ak({},ec),eu={};if(this.terrain&&ed){el.source=this.terrain.get().source;let en=this.terrain?this.getFragmentStyle(this.terrain.scope):null;en&&(eu.style=en.serialize())}if(this._validate(en.cB,"terrain",el,eu))return}if(this.terrain&&(this.terrain.scope===this.scope||ed)&&(!this.terrain||eu===this.terrain.drapeRenderMode)){let eu=this.terrain,ed=eu.get();for(let el of Object.keys(en.ae.terrain))!ec.hasOwnProperty(el)&&en.ae.terrain[el].default&&(ec[el]=en.ae.terrain[el].default);for(let ec in el)if(!t(el[ec],ed[ec])){eu.set(el,this.options),this.stylesheet.terrain=el;let ec=this._getTransitionParameters({duration:0});eu.updateTransitions(ec),this.fire(new en.a8("data",{dataType:"style"}));break}}else{if(!ec)return;this._createTerrain(ec,eu),this.fire(new en.a8("data",{dataType:"style"}))}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(en){let el=this.fog=new He(en,this.map.transform);this.stylesheet.fog=el.get();let eu=this._getTransitionParameters({duration:0});el.updateTransitions(eu)}_updateMarkersOpacity(){0!==this.map._markers.length&&this.map._requestDomTask(()=>{for(let en of this.map._markers)en._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(en){if(this._checkLoaded(),!en)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){let el=this.fog;if(!t(el.get(),en)){el.set(en),this.stylesheet.fog=el.get();let eu=this._getTransitionParameters({duration:0});el.updateTransitions(eu)}}else this._createFog(en);this._markersNeedUpdate=!0}_getTransitionParameters(el){return{now:en.a4.now(),transition:en.ak(this.transition,el)}}updateDrapeFirstLayers(){if(!this.terrain)return;let en=[],el=[];for(let eu in this._mergedLayers)this.isLayerDraped(this._mergedLayers[eu])?en.push(eu):el.push(eu);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...en),this._drapedFirstOrder.push(...el)}_createTerrain(en,el){let eu=this.terrain=new eS(en,el,this.scope,this.options);1===el&&(this.stylesheet.terrain=en),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();let ec=this._getTransitionParameters({duration:0});eu.updateTransitions(ec)}_force3DLayerUpdate(){for(let en in this._layers){let el=this._layers[en];"fill-extrusion"===el.type&&this._updateLayer(el)}}_forceSymbolLayerUpdate(){for(let en in this._layers){let el=this._layers[en];"symbol"===el.type&&this._updateLayer(el)}}_validate(el,eu,ec,ed,ef={}){if(ef&&!1===ef.validate)return!1;let em=en.ak({},this.serialize());return Cr(this,el.call(en.aj,en.ak({key:eu,style:em,value:ec,styleSpec:en.ae},ed)))}_remove(){for(let el in this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),en.cC.off("pluginStateChange",this._rtlTextPluginCallback),this._mergedLayers)this._mergedLayers[el].setEventedParent(null);for(let en in this._mergedSourceCaches)this._mergedSourceCaches[en].clearTiles(),this._mergedSourceCaches[en].setEventedParent(null);this.setEventedParent(null),delete this.fog,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.dispatcher.remove())}clearSource(en){let el=this.getSourceCaches(en);for(let en of el)en.clearTiles()}clearSources(){for(let en in this._mergedSourceCaches)this._mergedSourceCaches[en].clearTiles()}reloadSource(en){let el=this.getSourceCaches(en);for(let en of el)en.resume(),en.reload()}reloadSources(){for(let en of this.getSources())en.reload&&en.reload()}updateSources(en){let el;for(let eu in this.directionalLight&&(el=br(this.directionalLight)),this._mergedSourceCaches)this._mergedSourceCaches[eu].update(en,void 0,void 0,el)}_generateCollisionBoxes(){for(let en in this._sourceCaches){let el=this._sourceCaches[en];el.resume(),el.reload()}}_updatePlacement(el,eu,ec,ed,ef=!1){let em=!1,e_=!1,ew={},eT={};for(let eu of this._mergedOrder){let ec=this._mergedLayers[eu];if("symbol"!==ec.type)continue;let ed=en.aE(ec.source,ec.scope),ef=ew[ed];if(!ef){let en=this.getLayerSourceCache(ec);if(!en)continue;let el=en.getRenderableIds(!0).map(el=>en.getTileByID(el));eT[ed]=el.slice(),ef=ew[ed]=el.sort((en,el)=>el.tileID.overscaledZ-en.tileID.overscaledZ||(en.tileID.isLessThan(el.tileID)?-1:1))}let e_=this.crossTileSymbolIndex.addLayer(ec,ef,el.center.lng,el.projection);em=em||e_}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),ef=ef||this._layerOrderChanged||0===ec,this._layerOrderChanged&&this.fire(new en.a8("neworder")),(ef||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(en.a4.now(),el.zoom))&&(this.pauseablePlacement=new $t(el,this._mergedOrder,ef,eu,ec,ed,this.placement,this.fog&&el.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,ew,eT),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(en.a4.now()),e_=!0),em&&this.pauseablePlacement.placement.setStale()),e_||em)for(let el of this._mergedOrder){let eu=this._mergedLayers[el];"symbol"===eu.type&&this.placement.updateLayerOpacities(eu,ew[en.aE(eu.source,eu.scope)])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(en.a4.now())}_releaseSymbolFadeTiles(){for(let en in this._sourceCaches)this._sourceCaches[en].releaseSymbolFadeTiles()}addImport(el){this._checkLoaded();let eu=this.stylesheet.imports=this.stylesheet.imports||[];return -1!==eu.findIndex(({id:en})=>en===el.id)?this.fire(new en.a7(Error(`Import with id '${el.id}' already exists in the map's style.`))):(eu.push(el),this._loadImports([el],!0),this)}setImportUrl(en,el){this._checkLoaded();let eu=this.stylesheet.imports||[],ec=this.getImportIndex(en);if(-1===ec)return this;eu[ec].url=el;let ed=this.fragments[ec];return ed.style=this._createFragmentStyle(eu[ec]),ed.style.on("style.import.load",()=>this.mergeAll()),ed.style.loadURL(el),this}setImportData(en,el){this._checkLoaded();let eu=this.getImportIndex(en),ec=this.stylesheet.imports||[];return -1===eu?this:el?(this.fragments[eu].style.setState(el),this._reloadImports(),this):(delete ec[eu].data,this.setImportUrl(en,ec[eu].url))}setImportConfig(en,el){this._checkLoaded();let eu=this.getImportIndex(en),ec=this.stylesheet.imports||[];if(-1===eu)return this;el?ec[eu].config=el:delete ec[eu].config;let ed=this.fragments[eu],ef=ed.style.stylesheet&&ed.style.stylesheet.schema;return ed.config=el,ed.style.setConfig(el,ef),this.updateConfigDependencies(),this}removeImport(en){this._checkLoaded();let el=this.stylesheet.imports||[],eu=this.getImportIndex(en);return -1===eu||(el.splice(eu,1),this.fragments[eu].style._remove(),this.fragments.splice(eu,1),this._reloadImports()),this}getImportIndex(el){let eu=(this.stylesheet.imports||[]).findIndex(en=>en.id===el);return -1===eu&&this.fire(new en.a7(Error(`Import '${el}' does not exist in the map's style and cannot be updated.`))),eu}getLayer(en){return this._mergedLayers[en]}getSources(){let en=[];for(let el in this._mergedOtherSourceCaches){let eu=this._mergedOtherSourceCaches[el];eu&&en.push(eu.getSource())}return en}getSource(en,el){let eu=this.getSourceCache(en,el);return eu&&eu.getSource()}getLayerSource(en){let el=this.getLayerSourceCache(en);return el&&el.getSource()}getSourceCache(el,eu){let ec=en.aE(el,eu);return this._mergedOtherSourceCaches[ec]}getLayerSourceCache(el){let eu=en.aE(el.source,el.scope);return"symbol"===el.type?this._mergedSymbolSourceCaches[eu]:this._mergedOtherSourceCaches[eu]}getSourceCaches(en){let el=[];return this._mergedOtherSourceCaches[en]&&el.push(this._mergedOtherSourceCaches[en]),this._mergedSymbolSourceCaches[en]&&el.push(this._mergedSymbolSourceCaches[en]),el}updateSourceCaches(){let en=this._changes.getUpdatedSourceCaches();for(let el in en){let eu=en[el];"reload"===eu?this.reloadSource(el):"clear"===eu&&this.clearSource(el)}}updateLayers(en){let el=this._changes.getUpdatedPaintProperties();for(let eu of el){let el=this.getLayer(eu);el&&el.updateTransitions(en)}}getImages(en,el,eu){this.imageManager.getImages(el.icons,el.scope,eu),this._updateTilesForChangedImages();let o=en=>{en&&en.setDependencies(el.tileID.key,el.type,el.icons)};o(this._otherSourceCaches[el.source]),o(this._symbolSourceCaches[el.source])}getGlyphs(en,el,eu){this.glyphManager.getGlyphs(el.stacks,el.scope,eu)}getResource(el,eu,ec){return en.cD(eu,ec)}getOwnSourceCache(en){return this._otherSourceCaches[en]}getOwnLayerSourceCache(en){return"symbol"===en.type?this._symbolSourceCaches[en.source]:this._otherSourceCaches[en.source]}getOwnSourceCaches(en){let el=[];return this._otherSourceCaches[en]&&el.push(this._otherSourceCaches[en]),this._symbolSourceCaches[en]&&el.push(this._symbolSourceCaches[en]),el}_isSourceCacheLoaded(el){let eu=this.getOwnSourceCaches(el);return 0===eu.length?(this.fire(new en.a7(Error(`There is no source with ID '${el}'`))),!1):eu.every(en=>en.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}};function Ar(en,el){let eu=!1,ec=null,r=()=>{ec=null,eu&&(en(),ec=setTimeout(r,el),eu=!1)};return()=>(eu=!0,ec||r(),ec)}Dr.getSourceType=function(en){return eP[en]},Dr.setSourceType=function(en,el){eP[en]=el},Dr.registerForPluginStateChange=en.ci;let Rr=class Rr{constructor(el){this._hashName=el&&encodeURIComponent(el),en.aR(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Ar(this._updateHashUnthrottled.bind(this),300)}addTo(en){return this._map=en,window.addEventListener("hashchange",this._onHashChange,!1),en.on("moveend",this._updateHash),this}remove(){return this._map&&(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0),this}getHashString(){let en=this._map;if(!en)return"";let el=zr(en);if(this._hashName){let en=this._hashName,eu=!1,ec=location.hash.slice(1).split("&").map(ec=>{let ed=ec.split("=")[0];return ed===en?(eu=!0,`${ed}=${el}`):ec}).filter(en=>en);return eu||ec.push(`${en}=${el}`),`#${ec.join("&")}`}return`#${el}`}_getCurrentHash(){let en=location.hash.replace("#","");if(this._hashName){let el;return en.split("&").map(en=>en.split("=")).forEach(en=>{en[0]===this._hashName&&(el=en)}),(el&&el[1]||"").split("/")}return en.split("/")}_onHashChange(){let en=this._map;if(!en)return!1;let el=this._getCurrentHash();if(el.length>=3&&!el.some(en=>isNaN(en))){let eu=en.dragRotate.isEnabled()&&en.touchZoomRotate.isEnabled()?+(el[3]||0):en.getBearing();return en.jumpTo({center:[+el[2],+el[1]],zoom:+el[0],bearing:eu,pitch:+(el[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}};function zr(en,el){let eu=en.getCenter(),ec=Math.round(100*en.getZoom())/100,ed=Math.ceil((ec*Math.LN2+Math.log(512/360/.5))/Math.LN10),ef=Math.pow(10,ed),em=Math.round(eu.lng*ef)/ef,e_=Math.round(eu.lat*ef)/ef,ew=en.getBearing(),eT=en.getPitch(),eM=el?`/${em}/${e_}/${ec}`:`${ec}/${e_}/${em}`;return(ew||eT)&&(eM+="/"+Math.round(10*ew)/10),eT&&(eM+=`/${Math.round(eT)}`),eM}let tL={linearity:.3,easing:en.cE(0,0,.3,1)},tk=en.ak({deceleration:2500,maxSpeed:1400},tL),tR=en.ak({deceleration:20,maxSpeed:1400},tL),tO=en.ak({deceleration:1e3,maxSpeed:360},tL),tB=en.ak({deceleration:1e3,maxSpeed:90},tL);let Ur=class Ur{constructor(en){this._map=en,this.clear()}clear(){this._inertiaBuffer=[]}record(el){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:en.a4.now(),settings:el})}_drainInertiaBuffer(){let el=this._inertiaBuffer,eu=en.a4.now();for(;el.length>0&&eu-el[0].time>160;)el.shift()}_onMoveEnd(el){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;let eu={zoom:0,bearing:0,pitch:0,pan:new en.P(0,0),pinchAround:void 0,around:void 0};for(let{settings:en}of this._inertiaBuffer)eu.zoom+=en.zoomDelta||0,eu.bearing+=en.bearingDelta||0,eu.pitch+=en.pitchDelta||0,en.panDelta&&eu.pan._add(en.panDelta),en.around&&(eu.around=en.around),en.pinchAround&&(eu.pinchAround=en.pinchAround);let ec=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,ed={};if(eu.pan.mag()){let ef=jr(eu.pan.mag(),ec,en.ak({},tk,el||{}));ed.offset=eu.pan.mult(ef.amount/eu.pan.mag()),ed.center=this._map.transform.center,Gr(ed,ef)}if(eu.zoom){let en=jr(eu.zoom,ec,tR);ed.zoom=this._map.transform.zoom+en.amount,Gr(ed,en)}if(eu.bearing){let el=jr(eu.bearing,ec,tO);ed.bearing=this._map.transform.bearing+en.c(el.amount,-179,179),Gr(ed,el)}if(eu.pitch){let en=jr(eu.pitch,ec,tB);ed.pitch=this._map.transform.pitch+en.amount,Gr(ed,en)}if(ed.zoom||ed.bearing){let en=void 0===eu.pinchAround?eu.around:eu.pinchAround;ed.around=en?this._map.unproject(en):this._map.getCenter()}return this.clear(),ed.noMoveStart=!0,ed}};function Gr(en,el){(!en.duration||en.duration<el.duration)&&(en.duration=el.duration,en.easing=el.easing)}function jr(el,eu,ec){let{maxSpeed:ed,linearity:ef,deceleration:em}=ec,e_=en.c(el*ef/(eu/1e3),-ed,ed),ew=Math.abs(e_)/(em*ef);return{easing:ec.easing,duration:1e3*ew,amount:e_*(ew/2)}}let Vr=class Vr extends en.a8{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(el,eu,ec,ed={}){let ef=p(eu.getCanvasContainer(),ec),em=eu.unproject(ef);super(el,en.ak({point:ef,lngLat:em,originalEvent:ec},ed)),this._defaultPrevented=!1,this.target=eu}};let Zr=class Zr extends en.a8{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(el,eu,ec){let ed="touchend"===el?ec.changedTouches:ec.touches,ef=m(eu.getCanvasContainer(),ed),em=ef.map(en=>eu.unproject(en)),e_=ef.reduce((en,el,eu,ec)=>en.add(el.div(ec.length)),new en.P(0,0));super(el,{points:ef,point:e_,lngLats:em,lngLat:eu.unproject(e_),originalEvent:ec}),this._defaultPrevented=!1}};let Wr=class Wr extends en.a8{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(en,el,eu){super(en,{originalEvent:eu}),this._defaultPrevented=!1}};let Hr=class Hr{constructor(en,el){this._map=en,this._clickTolerance=el.clickTolerance}reset(){this._mousedownPos=void 0}wheel(en){return this._firePreventable(new Wr(en.type,this._map,en))}mousedown(en,el){return this._mousedownPos=el,this._firePreventable(new Vr(en.type,this._map,en))}mouseup(en){this._map.fire(new Vr(en.type,this._map,en))}preclick(el){let eu=en.ak({},el);eu.type="preclick",this._map.fire(new Vr(eu.type,this._map,eu))}click(en,el){this._mousedownPos&&this._mousedownPos.dist(el)>=this._clickTolerance||(this.preclick(en),this._map.fire(new Vr(en.type,this._map,en)))}dblclick(en){return this._firePreventable(new Vr(en.type,this._map,en))}mouseover(en){this._map.fire(new Vr(en.type,this._map,en))}mouseout(en){this._map.fire(new Vr(en.type,this._map,en))}touchstart(en){return this._firePreventable(new Zr(en.type,this._map,en))}touchmove(en){this._map.fire(new Zr(en.type,this._map,en))}touchend(en){this._map.fire(new Zr(en.type,this._map,en))}touchcancel(en){this._map.fire(new Zr(en.type,this._map,en))}_firePreventable(en){if(this._map.fire(en),en.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}};let qr=class qr{constructor(en){this._map=en}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(en){this._map.fire(new Vr(en.type,this._map,en))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Vr("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(en){this._delayContextMenu?this._contextMenuEvent=en:this._map.fire(new Vr(en.type,this._map,en)),this._map.listens("contextmenu")&&en.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}};let $r=class $r{constructor(en,el){this._map=en,this._el=en.getCanvasContainer(),this._container=en.getContainer(),this._clickTolerance=el.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(en,el){this.isEnabled()&&en.shiftKey&&0===en.button&&(h(),this._startPos=this._lastPos=el,this._active=!0)}mousemoveWindow(en,el){if(!this._active)return;let eu=this._startPos,ec=this._lastPos;if(!eu||!ec||ec.equals(el)||!this._box&&el.dist(eu)<this._clickTolerance)return;this._lastPos=el,this._box||(this._box=s("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",en));let ed=Math.min(eu.x,el.x),ef=Math.max(eu.x,el.x),em=Math.min(eu.y,el.y),e_=Math.max(eu.y,el.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${ed}px,${em}px)`,this._box.style.width=ef-ed+"px",this._box.style.height=e_-em+"px")})}mouseupWindow(el,eu){if(!this._active)return;let ec=this._startPos;if(ec&&0===el.button){if(this.reset(),u(),ec.x!==eu.x||ec.y!==eu.y)return this._map.fire(new en.a8("boxzoomend",{originalEvent:el})),{cameraAnimation:en=>en.fitScreenCoordinates(ec,eu,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",el)}}keydown(en){this._active&&27===en.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",en))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),_(),delete this._startPos,delete this._lastPos}_fireEvent(el,eu){return this._map.fire(new en.a8(el,{originalEvent:eu}))}};function Xr(en,el){let eu={};for(let ec=0;ec<en.length;ec++)eu[en[ec].identifier]=el[ec];return eu}let Jr=class Jr{constructor(en){this.reset(),this.numTouches=en.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(el,eu,ec){(this.centroid||ec.length>this.numTouches)&&(this.aborted=!0),this.aborted||(0===this.startTime&&(this.startTime=el.timeStamp),ec.length===this.numTouches&&(this.centroid=function(el){let eu=new en.P(0,0);for(let en of el)eu._add(en);return eu.div(el.length)}(eu),this.touches=Xr(ec,eu)))}touchmove(en,el,eu){if(this.aborted||!this.centroid)return;let ec=Xr(eu,el);for(let en in this.touches){let el=ec[en];(!el||el.dist(this.touches[en])>30)&&(this.aborted=!0)}}touchend(en,el,eu){if((!this.centroid||en.timeStamp-this.startTime>500)&&(this.aborted=!0),0===eu.length){let en=!this.aborted&&this.centroid;if(this.reset(),en)return en}}};let Yr=class Yr{constructor(en){this.singleTap=new Jr(en),this.numTaps=en.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(en,el,eu){this.singleTap.touchstart(en,el,eu)}touchmove(en,el,eu){this.singleTap.touchmove(en,el,eu)}touchend(en,el,eu){let ec=this.singleTap.touchend(en,el,eu);if(ec){let el=en.timeStamp-this.lastTime<500,eu=!this.lastTap||30>this.lastTap.dist(ec);if(el&&eu||this.reset(),this.count++,this.lastTime=en.timeStamp,this.lastTap=ec,this.count===this.numTaps)return this.reset(),ec}}};let Kr=class Kr{constructor(){this._zoomIn=new Yr({numTouches:1,numTaps:2}),this._zoomOut=new Yr({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(en,el,eu){this._zoomIn.touchstart(en,el,eu),this._zoomOut.touchstart(en,el,eu)}touchmove(en,el,eu){this._zoomIn.touchmove(en,el,eu),this._zoomOut.touchmove(en,el,eu)}touchend(en,el,eu){let ec=this._zoomIn.touchend(en,el,eu),ed=this._zoomOut.touchend(en,el,eu);return ec?(this._active=!0,en.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:el=>el.easeTo({duration:300,zoom:el.getZoom()+1,around:el.unproject(ec)},{originalEvent:en})}):ed?(this._active=!0,en.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:el=>el.easeTo({duration:300,zoom:el.getZoom()-1,around:el.unproject(ed)},{originalEvent:en})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}};let tF={0:1,2:2};let es=class es{constructor(en){this.reset(),this._clickTolerance=en.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(en,el){return!1}_move(en,el){return{}}mousedown(en,el){if(this._lastPoint)return;let eu=f(en);this._correctButton(en,eu)&&(this._lastPoint=el,this._eventButton=eu)}mousemoveWindow(en,el){let eu=this._lastPoint;if(eu){if(en.preventDefault(),null!=this._eventButton&&function(en,el){let eu=tF[el];return void 0===en.buttons||(en.buttons&eu)!==eu}(en,this._eventButton))this.reset();else if(this._moved||!(el.dist(eu)<this._clickTolerance))return this._moved=!0,this._lastPoint=el,this._move(eu,el)}}mouseupWindow(en){this._lastPoint&&f(en)===this._eventButton&&(this._moved&&u(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}};let ts=class ts extends es{mousedown(en,el){super.mousedown(en,el),this._lastPoint&&(this._active=!0)}_correctButton(en,el){return 0===el&&!en.ctrlKey}_move(en,el){return{around:el,panDelta:el.sub(en)}}};let is=class is extends es{_correctButton(en,el){return 0===el&&en.ctrlKey||2===el}_move(en,el){let eu=.8*(el.x-en.x);if(eu)return this._active=!0,{bearingDelta:eu}}contextmenu(en){en.preventDefault()}};let os=class os extends es{_correctButton(en,el){return 0===el&&en.ctrlKey||2===el}_move(en,el){let eu=-.5*(el.y-en.y);if(eu)return this._active=!0,{pitchDelta:eu}}contextmenu(en){en.preventDefault()}};let rs=class rs{constructor(el,eu){this._map=el,this._el=el.getCanvasContainer(),this._minTouches=1,this._clickTolerance=eu.clickTolerance||1,this.reset(),en.aR(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new en.P(0,0)}touchstart(en,el,eu){return this._calculateTransform(en,el,eu)}touchmove(el,eu,ec){if(this._active&&!(ec.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(1===ec.length&&!en.cF())return void this._showTouchPanBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return el.cancelable&&el.preventDefault(),this._calculateTransform(el,eu,ec)}}touchend(en,el,eu){this._calculateTransform(en,el,eu),this._active&&eu.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(el,eu,ec){ec.length>0&&(this._active=!0);let ed=Xr(ec,eu),ef=new en.P(0,0),em=new en.P(0,0),e_=0;for(let en in ed){let el=ed[en],eu=this._touches[en];eu&&(ef._add(el),em._add(el.sub(eu)),e_++,ed[en]=el)}if(this._touches=ed,e_<this._minTouches||!em.mag())return;let ew=em.div(e_);return this._sum._add(ew),this._sum.mag()<this._clickTolerance?void 0:{around:ef.div(e_),panDelta:ew}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=s("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}};let ss=class ss{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(en){}_move(en,el,eu){return{}}touchstart(en,el,eu){this._firstTwoTouches||eu.length<2||(this._firstTwoTouches=[eu[0].identifier,eu[1].identifier],this._start([el[0],el[1]]))}touchmove(en,el,eu){let ec=this._firstTwoTouches;if(!ec)return;en.preventDefault();let[ed,ef]=ec,em=ns(eu,el,ed),e_=ns(eu,el,ef);if(!em||!e_)return;let ew=this._aroundCenter?null:em.add(e_).div(2);return this._move([em,e_],ew,en)}touchend(en,el,eu){if(!this._firstTwoTouches)return;let[ec,ed]=this._firstTwoTouches,ef=ns(eu,el,ec),em=ns(eu,el,ed);ef&&em||(this._active&&u(),this.reset())}touchcancel(){this.reset()}enable(en){this._enabled=!0,this._aroundCenter=!!en&&"center"===en.around}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}};function ns(en,el,eu){for(let ec=0;ec<en.length;ec++)if(en[ec].identifier===eu)return el[ec]}function as(en,el){return Math.log(en/el)/Math.LN2}let ls=class ls extends ss{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(en){this._startDistance=this._distance=en[0].dist(en[1])}_move(en,el){let eu=this._distance;if(this._distance=en[0].dist(en[1]),this._active||!(.1>Math.abs(as(this._distance,this._startDistance))))return this._active=!0,{zoomDelta:as(this._distance,eu),pinchAround:el}}};function cs(en,el){return 180*en.angleWith(el)/Math.PI}let hs=class hs extends ss{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(en){this._startVector=this._vector=en[0].sub(en[1]),this._minDiameter=en[0].dist(en[1])}_move(en,el){let eu=this._vector;if(this._vector=en[0].sub(en[1]),eu&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:cs(this._vector,eu),pinchAround:el}}_isBelowThreshold(en){this._minDiameter=Math.min(this._minDiameter,en.mag());let el=25/(Math.PI*this._minDiameter)*360,eu=this._startVector;if(!eu)return!1;let ec=cs(en,eu);return Math.abs(ec)<el}};function _s(en){return Math.abs(en.y)>Math.abs(en.x)}let ds=class ds extends ss{constructor(en){super(),this._map=en}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(en){this._lastPoints=en,_s(en[0].sub(en[1]))&&(this._valid=!1)}_move(el,eu,ec){let ed=this._lastPoints;if(!ed)return;let ef=el[0].sub(ed[0]),em=el[1].sub(ed[1]);return this._map._cooperativeGestures&&!en.cF()&&ec.touches.length<3||(this._valid=this.gestureBeginsVertically(ef,em,ec.timeStamp),!this._valid)?void 0:(this._lastPoints=el,this._active=!0,{pitchDelta:-((ef.y+em.y)/2*.5)})}gestureBeginsVertically(en,el,eu){if(void 0!==this._valid)return this._valid;let ec=en.mag()>=2,ed=el.mag()>=2;if(!ec&&!ed)return;if(!ec||!ed)return null==this._firstMove&&(this._firstMove=eu),eu-this._firstMove<100&&void 0;let ef=en.y>0==el.y>0;return _s(en)&&_s(el)&&ef}};let ps=class ps{constructor(){this._panStep=100,this._bearingStep=15,this._pitchStep=10,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(en){if(en.altKey||en.ctrlKey||en.metaKey)return;let el=0,eu=0,ec=0,ed=0,ef=0;switch(en.keyCode){case 61:case 107:case 171:case 187:el=1;break;case 189:case 109:case 173:el=-1;break;case 37:en.shiftKey?eu=-1:(en.preventDefault(),ed=-1);break;case 39:en.shiftKey?eu=1:(en.preventDefault(),ed=1);break;case 38:en.shiftKey?ec=1:(en.preventDefault(),ef=-1);break;case 40:en.shiftKey?ec=-1:(en.preventDefault(),ef=1);break;default:return}return this._rotationDisabled&&(eu=0,ec=0),{cameraAnimation:em=>{let e_=em.getZoom();em.easeTo({duration:300,easeId:"keyboardHandler",easing:ms,zoom:el?Math.round(e_)+el*(en.shiftKey?2:1):e_,bearing:em.getBearing()+eu*this._bearingStep,pitch:em.getPitch()+ec*this._pitchStep,offset:[-ed*this._panStep,-ef*this._panStep],center:em.getCenter()},{originalEvent:en})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}};function ms(en){return en*(2-en)}let gs=class gs{constructor(el,eu){this._map=el,this._el=el.getCanvasContainer(),this._handler=eu,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222,en.aR(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(en){this._defaultZoomRate=en}setWheelZoomRate(en){this._wheelZoomRate=en}isEnabled(){return!!this._enabled}isActive(){return this._active||void 0!==this._finishTimeout}isZooming(){return!!this._zooming}enable(en){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!en&&"center"===en.around,this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(el){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(el.ctrlKey||el.metaKey||this.isZooming()||en.cF()))return void this._showBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let eu=el.deltaMode===WheelEvent.DOM_DELTA_LINE?40*el.deltaY:el.deltaY,ec=en.a4.now(),ed=ec-(this._lastWheelEventTime||0);this._lastWheelEventTime=ec,0!==eu&&eu%4.000244140625==0?this._type="wheel":0!==eu&&4>Math.abs(eu)?this._type="trackpad":ed>400?(this._type=null,this._lastValue=eu,this._timeout=setTimeout(this._onTimeout,40,el)):this._type||(this._type=200>Math.abs(ed*eu)?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,eu+=this._lastValue)),el.shiftKey&&eu&&(eu/=4),this._type&&(this._lastWheelEvent=el,this._delta-=eu,this._active||this._start(el)),el.preventDefault()}_onTimeout(en){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(en)}_start(en){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);let el=p(this._el,en);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:el,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;let el=this._map.transform;"wheel"===this._type&&el.projection.wrap&&(el._center.lng>=180||el._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);let i=()=>el._terrainEnabled()&&this._aroundCoord?el.computeZoomRelativeTo(this._aroundCoord):el.zoom;if(0!==this._delta){let en="wheel"===this._type&&Math.abs(this._delta)>4.000244140625?this._wheelZoomRate:this._defaultZoomRate,eu=2/(1+Math.exp(-Math.abs(this._delta*en)));this._delta<0&&0!==eu&&(eu=1/eu);let ec=i(),ed=Math.pow(2,ec),ef="number"==typeof this._targetZoom?el.zoomScale(this._targetZoom):ed;this._targetZoom=Math.min(el.maxZoom,Math.max(el.minZoom,el.scaleZoom(ef*eu))),"wheel"===this._type&&(this._startZoom=ec,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}let eu="number"==typeof this._targetZoom?this._targetZoom:i(),ec=this._startZoom,ed=this._easing,ef,em=!1;if("wheel"===this._type&&ec&&ed){let el=Math.min((en.a4.now()-this._lastWheelEventTime)/200,1),e_=ed(el);ef=en.n(ec,eu,e_),el<1?this._frameId||(this._frameId=!0):em=!0}else ef=eu,em=!0;this._active=!0,em&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let e_=ef-i();return e_*this._lastDelta<0&&(e_=0),{noInertia:!0,needsRenderFrame:!em,zoomDelta:e_,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(el){let eu=en.cG;if(this._prevEase){let el=this._prevEase,ec=(en.a4.now()-el.start)/el.duration,ed=el.easing(ec+.01)-el.easing(ec),ef=.27/Math.sqrt(ed*ed+1e-4)*.01,em=Math.sqrt(.0729-ef*ef);eu=en.cE(ef,em,.25,1)}return this._prevEase={start:en.a4.now(),duration:el,easing:eu},eu}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=s("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}};let vs=class vs{constructor(en,el){this._clickZoom=en,this._tapZoom=el}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}};let xs=class xs{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(en,el){return en.preventDefault(),{cameraAnimation:eu=>{eu.easeTo({duration:300,zoom:eu.getZoom()+(en.shiftKey?-1:1),around:eu.unproject(el)},{originalEvent:en})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}};let ys=class ys{constructor(){this._tap=new Yr({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(en,el,eu){this._swipePoint||(this._tapTime&&en.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?eu.length>0&&(this._swipePoint=el[0],this._swipeTouch=eu[0].identifier):this._tap.touchstart(en,el,eu))}touchmove(en,el,eu){if(this._tapTime){if(this._swipePoint){if(eu[0].identifier!==this._swipeTouch)return;let ec=el[0],ed=ec.y-this._swipePoint.y;return this._swipePoint=ec,en.preventDefault(),this._active=!0,{zoomDelta:ed/128}}}else this._tap.touchmove(en,el,eu)}touchend(en,el,eu){this._tapTime?this._swipePoint&&0===eu.length&&this.reset():this._tap.touchend(en,el,eu)&&(this._tapTime=en.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}};let bs=class bs{constructor(en,el,eu){this._el=en,this._mousePan=el,this._touchPan=eu}enable(en){this._inertiaOptions=en||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}};let ws=class ws{constructor(en,el,eu){this._pitchWithRotate=en.pitchWithRotate,this._mouseRotate=el,this._mousePitch=eu}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}};let Ts=class Ts{constructor(en,el,eu,ec){this._el=en,this._touchZoom=el,this._touchRotate=eu,this._tapDragZoom=ec,this._rotationDisabled=!1,this._enabled=!0}enable(en){this._touchZoom.enable(en),this._rotationDisabled||this._touchRotate.enable(en),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}};let Es=en=>en.zoom||en.drag||en.pitch||en.rotate;let Cs=class Cs extends en.a8{};let Is=class Is{constructor(){this.constants=[1,1,.01],this.radius=0}setup(el,eu){let ec=en.v.sub([],eu,el);this.radius=en.v.length(ec[2]<0?en.v.div([],ec,this.constants):[ec[0],ec[1],0])}projectRay(el){en.v.div(el,el,this.constants),en.v.normalize(el,el),en.v.mul(el,el,this.constants);let eu=en.v.scale([],el,this.radius);if(eu[2]>0){let el=en.v.scale([],[0,0,1],en.v.dot(eu,[0,0,1])),ec=en.v.scale([],en.v.normalize([],[eu[0],eu[1],0]),this.radius),ed=en.v.add([],eu,en.v.scale([],en.v.sub([],en.v.add([],ec,el),eu),2));eu[0]=ed[0],eu[1]=ed[1]}return eu}};function Ss(en){return en.panDelta&&en.panDelta.mag()||en.zoomDelta||en.bearingDelta||en.pitchDelta}let Ms=class Ms{constructor(el,eu){this._map=el,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Ur(el),this._bearingSnap=eu.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Is,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(eu),en.aR(["handleEvent","handleWindowEvent"],this);let ec=this._el;for(let[en,el,eu]of(this._listeners=[[ec,"touchstart",{passive:!0}],[ec,"touchmove",{passive:!1}],[ec,"touchend",void 0],[ec,"touchcancel",void 0],[ec,"mousedown",void 0],[ec,"mousemove",void 0],[ec,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[ec,"mouseover",void 0],[ec,"mouseout",void 0],[ec,"dblclick",void 0],[ec,"click",void 0],[ec,"keydown",{capture:!1}],[ec,"keyup",void 0],[ec,"wheel",{passive:!1}],[ec,"contextmenu",void 0],[window,"blur",void 0]],this._listeners)){let ec=en===document?this.handleWindowEvent:this.handleEvent;en.addEventListener(el,ec,eu)}}destroy(){for(let[en,el,eu]of this._listeners){let ec=en===document?this.handleWindowEvent:this.handleEvent;en.removeEventListener(el,ec,eu)}}_addDefaultHandlers(en){let el=this._map,eu=el.getCanvasContainer();this._add("mapEvent",new Hr(el,en));let ec=el.boxZoom=new $r(el,en);this._add("boxZoom",ec);let ed=new Kr,ef=new xs;el.doubleClickZoom=new vs(ef,ed),this._add("tapZoom",ed),this._add("clickZoom",ef);let em=new ys;this._add("tapDragZoom",em);let e_=el.touchPitch=new ds(el);this._add("touchPitch",e_);let ew=new is(en),eT=new os(en);el.dragRotate=new ws(en,ew,eT),this._add("mouseRotate",ew,["mousePitch"]),this._add("mousePitch",eT,["mouseRotate"]);let eM=new ts(en),eE=new rs(el,en);el.dragPan=new bs(eu,eM,eE),this._add("mousePan",eM),this._add("touchPan",eE,["touchZoom","touchRotate"]);let eS=new hs,eA=new ls;el.touchZoomRotate=new Ts(eu,eA,eS,em),this._add("touchRotate",eS,["touchPan","touchZoom"]),this._add("touchZoom",eA,["touchPan","touchRotate"]),this._add("blockableMapEvent",new qr(el));let eI=el.scrollZoom=new gs(el,this);this._add("scrollZoom",eI,["mousePan"]);let eC=el.keyboard=new ps;for(let eu of(this._add("keyboard",eC),["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"]))en.interactive&&en[eu]&&el[eu].enable(en[eu])}_add(en,el,eu){this._handlers.push({handlerName:en,handler:el,allowed:eu}),this._handlersById[en]=el}stop(en){if(!this._updatingCamera){for(let{handler:en}of this._handlers)en.reset();this._inertia.clear(),this._fireEvents({},{},en),this._changes=[],this._originalZoom=void 0}}isActive(){for(let{handler:en}of this._handlers)if(en.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Es(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(en,el,eu){for(let ec in en)if(ec!==eu&&(!el||0>el.indexOf(ec)))return!0;return!1}handleWindowEvent(en){this.handleEvent(en,`${en.type}Window`)}_getMapTouches(en){let el=[];for(let eu of en)this._el.contains(eu.target)&&el.push(eu);return el}handleEvent(en,el){this._updatingCamera=!0;let eu="renderFrame"===en.type,ec=eu?void 0:en,ed={needsRenderFrame:!1},ef={},em={},e_=en.touches?this._getMapTouches(en.touches):void 0,ew=e_?m(this._el,e_):eu?void 0:p(this._el,en);for(let{handlerName:eu,handler:eT,allowed:eM}of this._handlers){let eE;eT.isEnabled()&&(this._blockedByActive(em,eM,eu)?eT.reset():eT[el||en.type]&&(eE=eT[el||en.type](en,ew,e_),this.mergeHandlerResult(ed,ef,eE,eu,ec),eE&&eE.needsRenderFrame&&this._triggerRenderFrame()),(eE||eT.isActive())&&(em[eu]=eT))}let eT={};for(let en in this._previousActiveHandlers)em[en]||(eT[en]=ec);this._previousActiveHandlers=em,(Object.keys(eT).length||Ss(ed))&&(this._changes.push([ed,ef,eT]),this._triggerRenderFrame()),(Object.keys(em).length||Ss(ed))&&this._map._stop(!0),this._updatingCamera=!1;let{cameraAnimation:eM}=ed;eM&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],eM(this._map))}mergeHandlerResult(el,eu,ec,ed,ef){if(!ec)return;en.ak(el,ec);let em={handlerName:ed,originalEvent:ec.originalEvent||ef};void 0!==ec.zoomDelta&&(eu.zoom=em),void 0!==ec.panDelta&&(eu.drag=em),void 0!==ec.pitchDelta&&(eu.pitch=em),void 0!==ec.bearingDelta&&(eu.rotate=em)}_applyChanges(){let el={},eu={},ec={};for(let[ed,ef,em]of this._changes)ed.panDelta&&(el.panDelta=(el.panDelta||new en.P(0,0))._add(ed.panDelta)),ed.zoomDelta&&(el.zoomDelta=(el.zoomDelta||0)+ed.zoomDelta),ed.bearingDelta&&(el.bearingDelta=(el.bearingDelta||0)+ed.bearingDelta),ed.pitchDelta&&(el.pitchDelta=(el.pitchDelta||0)+ed.pitchDelta),void 0!==ed.around&&(el.around=ed.around),void 0!==ed.aroundCoord&&(el.aroundCoord=ed.aroundCoord),void 0!==ed.pinchAround&&(el.pinchAround=ed.pinchAround),ed.noInertia&&(el.noInertia=ed.noInertia),en.ak(eu,ef),en.ak(ec,em);this._updateMapTransform(el,eu,ec),this._changes=[]}_updateMapTransform(el,eu,ec){var ed;let ef=this._map,em=ef.transform,n=en=>[en.x,en.y,en.z];if((en=>{let el=this._eventsInProgress.drag;return el&&!this._handlersById[el.handlerName].isActive()})()&&!Ss(el)){let en=em.zoom;em.cameraElevationReference="sea",null!=this._originalZoom&&em._orthographicProjectionAtLowPitch&&"globe"!==em.projection.name&&0===em.pitch?(em.cameraElevationReference="ground",em.zoom=this._originalZoom):(em.recenterOnTerrain(),em.cameraElevationReference="ground"),en!==em.zoom&&this._map._update(!0)}if(em._isCameraConstrained&&ef._stop(!0),!Ss(el))return void this._fireEvents(eu,ec,!0);let{panDelta:e_,zoomDelta:ew,bearingDelta:eT,pitchDelta:eM,around:eE,aroundCoord:eS,pinchAround:eA}=el;em._isCameraConstrained&&(ew>0&&(ew=0),em._isCameraConstrained=!1),void 0!==eA&&(eE=eA),(ew||eu[ed="drag"]&&!this._eventsInProgress[ed])&&eE&&(this._dragOrigin=n(em.pointCoordinate3D(eE)),this._originalZoom=em.zoom,this._trackingEllipsoid.setup(em._camera.position,this._dragOrigin)),em.cameraElevationReference="sea",ef._stop(!0),eE=eE||ef.transform.centerPoint,eT&&(em.bearing+=eT),eM&&(em.pitch+=eM),em._updateCameraState();let eI=[0,0,0];if(e_){if("mercator"===em.projection.name){let en=this._trackingEllipsoid.projectRay(em.screenPointToMercatorRay(eE).dir),el=this._trackingEllipsoid.projectRay(em.screenPointToMercatorRay(eE.sub(e_)).dir);eI[0]=el[0]-en[0],eI[1]=el[1]-en[1]}else{let el=em.pointCoordinate(eE);if("globe"===em.projection.name){e_=e_.rotate(-em.angle);let eu=em._pixelsPerMercatorPixel/em.worldSize;eI[0]=-e_.x*en.cH(en.l(el.y))*eu,eI[1]=-e_.y*en.cH(em.center.lat)*eu}else{let en=em.pointCoordinate(eE.sub(e_));el&&en&&(eI[0]=en.x-el.x,eI[1]=en.y-el.y)}}}let eC=em.zoom,eP=[0,0,0];if(ew){let el=n(eS||em.pointCoordinate3D(eE)),eu={dir:en.v.normalize([],en.v.sub([],el,em._camera.position))};if(eu.dir[2]<0){let ec=em.zoomDeltaToMovement(el,ew);en.v.scale(eP,eu.dir,ec)}}let ez=en.v.add(eI,eI,eP);em._translateCameraConstrained(ez),ew&&Math.abs(em.zoom-eC)>1e-4&&em.recenterOnTerrain(),em.cameraElevationReference="ground",this._map._update(),el.noInertia||this._inertia.record(el),this._fireEvents(eu,ec,!0)}_fireEvents(el,eu,ec){let ed;let ef=Es(this._eventsInProgress),em=Es(el),e_={};for(let en in el){let{originalEvent:eu}=el[en];this._eventsInProgress[en]||(e_[`${en}start`]=eu),this._eventsInProgress[en]=el[en]}for(let en in!ef&&em&&this._fireEvent("movestart",em.originalEvent),e_)this._fireEvent(en,e_[en]);for(let en in em&&this._fireEvent("move",em.originalEvent),el){let{originalEvent:eu}=el[en];this._fireEvent(en,eu)}let ew={};for(let en in this._eventsInProgress){let{handlerName:el,originalEvent:ec}=this._eventsInProgress[en];this._handlersById[el].isActive()||(delete this._eventsInProgress[en],ed=eu[el]||ec,ew[`${en}end`]=ed)}for(let en in ew)this._fireEvent(en,ew[en]);let eT=Es(this._eventsInProgress);if(ec&&(ef||em)&&!eT){var eM,eE;this._updatingCamera=!0;let el=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions);el?(0!==(eM=el.bearing||this._map.getBearing())&&-this._bearingSnap<eM&&eM<this._bearingSnap&&(el.bearing=0),this._map.easeTo(el,{originalEvent:ed})):(this._map.fire(new en.a8("moveend",{originalEvent:ed})),0!==(eE=this._map.getBearing())&&-this._bearingSnap<eE&&eE<this._bearingSnap&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(el,eu){this._map.fire(new en.a8(el,eu?{originalEvent:eu}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(en=>{this._frameId=void 0,this.handleEvent(new Cs("renderFrame",{timeStamp:en})),this._applyChanges()})}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame())}};let tN="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";let Ps=class Ps extends en.a6{constructor(el,eu){super(),this._moving=!1,this._zooming=!1,this.transform=el,this._bearingSnap=eu.bearingSnap,this._respectPrefersReducedMotion=!1!==eu.respectPrefersReducedMotion,en.aR(["_renderFrameCallback"],this)}getCenter(){return new en.L(this.transform.center.lng,this.transform.center.lat)}setCenter(en,el){return this.jumpTo({center:en},el)}panBy(el,eu,ec){return el=en.P.convert(el).mult(-1),this.panTo(this.transform.center,en.ak({offset:el},eu),ec)}panTo(el,eu,ec){return this.easeTo(en.ak({center:el},eu),ec)}getZoom(){return this.transform.zoom}setZoom(en,el){return this.jumpTo({zoom:en},el),this}zoomTo(el,eu,ec){return this.easeTo(en.ak({zoom:el},eu),ec)}zoomIn(en,el){return this.zoomTo(this.getZoom()+1,en,el),this}zoomOut(en,el){return this.zoomTo(this.getZoom()-1,en,el),this}getBearing(){return this.transform.bearing}setBearing(en,el){return this.jumpTo({bearing:en},el),this}getPadding(){return this.transform.padding}setPadding(en,el){return this.jumpTo({padding:en},el),this}rotateTo(el,eu,ec){return this.easeTo(en.ak({bearing:el},eu),ec)}resetNorth(el,eu){return this.rotateTo(0,en.ak({duration:1e3},el),eu),this}resetNorthPitch(el,eu){return this.easeTo(en.ak({bearing:0,pitch:0,duration:1e3},el),eu),this}snapToNorth(en,el){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(en,el):this}getPitch(){return this.transform.pitch}setPitch(en,el){return this.jumpTo({pitch:en},el),this}cameraForBounds(el,eu){el=en.D.convert(el);let ec=eu&&eu.bearing||0,ed=eu&&eu.pitch||0,ef=el.getNorthWest(),em=el.getSouthEast();return this._cameraForBounds(this.transform,ef,em,ec,ed,eu)}_extendCameraOptions(el){let eu={top:0,bottom:0,right:0,left:0};if("number"==typeof(el=en.ak({padding:eu,offset:[0,0],maxZoom:this.transform.maxZoom},el)).padding){let en=el.padding;el.padding={top:en,bottom:en,right:en,left:en}}return el.padding=en.ak(eu,el.padding),el}_minimumAABBFrustumDistance(en,el){let eu=el.max[0]-el.min[0],ec=el.max[1]-el.min[1];return eu/ec>en.aspect?eu/(2*Math.tan(.5*en.fovX)*en.aspect):ec/(2*Math.tan(.5*en.fovY)*en.aspect)}_cameraForBoundsOnGlobe(el,eu,ec,ed,ef,em){let e_=el.clone(),ew=this._extendCameraOptions(em);e_.bearing=ed,e_.pitch=ef;let eT=en.L.convert(eu),eM=en.L.convert(ec),eE=.5*(eT.lat+eM.lat),eS=.5*(eT.lng+eM.lng),eA=en.cI(eE,eS),eI=en.v.normalize([],eA),eC=en.v.normalize([],en.v.cross([],eI,[0,1,0])),eP=en.v.cross([],eC,eI),ez=[eC[0],eC[1],eC[2],0,eP[0],eP[1],eP[2],0,eI[0],eI[1],eI[2],0,0,0,0,1],eD=[eA,en.cI(eT.lat,eT.lng),en.cI(eM.lat,eT.lng),en.cI(eM.lat,eM.lng),en.cI(eT.lat,eM.lng),en.cI(eE,eT.lng),en.cI(eE,eM.lng),en.cI(eT.lat,eS),en.cI(eM.lat,eS)],eL=en.c3.fromPoints(eD.map(el=>[en.v.dot(eC,el),en.v.dot(eP,el),en.v.dot(eI,el)])),ek=en.v.transformMat4([],eL.center,ez);0===en.v.squaredLength(ek)&&en.v.set(ek,0,0,1),en.v.normalize(ek,ek),en.v.scale(ek,ek,en.aC),e_.center=en.cJ(ek);let eR=e_.getWorldToCameraMatrix(),eO=en.m.invert(new Float64Array(16),eR);eL=en.c3.applyTransform(eL,en.m.multiply([],eR,ez)),en.v.transformMat4(ek,ek,eR);let eB=.5*(eL.max[2]-eL.min[2]),eF=this._minimumAABBFrustumDistance(e_,eL),eN=en.v.scale([],[0,0,1],eB),eU=en.v.add(eN,ek,eN),eV=eF+(0===e_.pitch?0:en.v.distance(ek,eU)),ej=e_.globeCenterInViewSpace,eG=en.v.sub([],ek,[ej[0],ej[1],ej[2]]);en.v.normalize(eG,eG),en.v.scale(eG,eG,eV);let eq=en.v.add([],ek,eG);en.v.transformMat4(eq,eq,eO);let eZ=en.cL/en.aC,e$=en.v.length(eq),eW=en.b(Math.max(e$*eZ-en.cL,Number.EPSILON),0),eH=Math.min(e_.zoomFromMercatorZAdjusted(eW),ew.maxZoom);return eH>.5*(en.Z+en.G)?(e_.setProjection({name:"mercator"}),e_.zoom=eH,this._cameraForBounds(e_,eu,ec,ed,ef,em)):{center:e_.center,zoom:eH,bearing:ed,pitch:ef}}queryTerrainElevation(el,eu){let ec=this.transform.elevation;return ec?(eu=en.ak({},{exaggerated:!0},eu),ec.getAtPoint(en.M.fromLngLat(el),null,eu.exaggerated)):null}_cameraForBounds(el,eu,ec,ed,ef,em){if("globe"===el.projection.name)return this._cameraForBoundsOnGlobe(el,eu,ec,ed,ef,em);let e_=el.clone(),ew=this._extendCameraOptions(em),eT=e_.padding;e_.bearing=ed,e_.pitch=ef;let eM=en.L.convert(eu),eE=en.L.convert(ec),eS=new en.L(eM.lng,eE.lat),eA=new en.L(eE.lng,eM.lat),eI=e_.project(eM),eC=e_.project(eE),eP=this.queryTerrainElevation(eM),ez=this.queryTerrainElevation(eE),eD=this.queryTerrainElevation(eS),eL=this.queryTerrainElevation(eA),ek=[[eI.x,eI.y,Math.min(eP||0,ez||0,eD||0,eL||0)],[eC.x,eC.y,Math.max(eP||0,ez||0,eD||0,eL||0)]],eR=en.c3.fromPoints(ek),eO=e_.getWorldToCameraMatrix(),eB=en.m.invert(new Float64Array(16),eO);eR=en.c3.applyTransform(eR,eO);let eF=en.v.sub([],eR.max,eR.min),eN=eT.left||0,eU=eT.right||0,eV=eT.bottom||0,ej=eT.top||0,{left:eG,right:eq,top:eZ,bottom:e$}=ew.padding,eW=.5*(eN+eU),eH=.5*(ej+eV),eX=Math.min(e_.scaleZoom(e_.scale*Math.min((e_.width-(eN+eU+eG+eq))/eF[0],(e_.height-(eV+ej+e$+eZ))/eF[1])),ew.maxZoom),eK=e_.scale/e_.zoomScale(eX);eR=new en.c3([eR.min[0]-(eG+eW)*eK,eR.min[1]-(e$+eH)*eK,eR.min[2]],[eR.max[0]+(eq+eW)*eK,eR.max[1]+(eZ+eH)*eK,eR.max[2]]);let eJ=.5*eF[2],eY=this._minimumAABBFrustumDistance(e_,eR),eQ=[0,0,1,0];en.e.transformMat4(eQ,eQ,eO),en.e.normalize(eQ,eQ);let e0=en.v.scale([],eQ,eY+eJ),e1=en.v.add([],eR.center,e0),e2=("number"==typeof ew.offset.x&&"number"==typeof ew.offset.y?new en.P(ew.offset.x,ew.offset.y):en.P.convert(ew.offset)).rotate(-en.d(ed));eR.center[0]-=e2.x*eK,eR.center[1]+=e2.y*eK,en.v.transformMat4(eR.center,eR.center,eB),en.v.transformMat4(e1,e1,eB);let e3=[eR.center[0],eR.center[1],e1[2]*e_.pixelsPerMeter];en.v.scale(e3,e3,1/e_.worldSize);let e4=en.cK(e3[0]),e5=en.l(e3[1]),e6=Math.min(e_._zoomFromMercatorZ(e3[2]),ew.maxZoom),e8=new en.L(e4,e5);return e_.mercatorFromTransition&&e6<.5*(en.Z+en.G)?(e_.setProjection({name:"globe"}),e_.zoom=e6,this._cameraForBounds(e_,eu,ec,ed,ef,em)):{center:e8,zoom:e6,bearing:ed,pitch:ef}}fitBounds(en,el,eu){let ec=this.cameraForBounds(en,el);return this._fitInternal(ec,el,eu)}fitScreenCoordinates(el,eu,ec,ed,ef){let em=en.P.convert(el),e_=en.P.convert(eu),ew=new en.P(Math.min(em.x,e_.x),Math.min(em.y,e_.y)),eT=new en.P(Math.max(em.x,e_.x),Math.max(em.y,e_.y));if("mercator"===this.transform.projection.name&&this.transform.anyCornerOffEdge(em,e_))return this;let eM=this.transform.pointLocation3D(ew),eE=this.transform.pointLocation3D(eT),eS=this.transform.pointLocation3D(new en.P(ew.x,eT.y)),eA=this.transform.pointLocation3D(new en.P(eT.x,ew.y)),eI=[Math.min(eM.lng,eE.lng,eS.lng,eA.lng),Math.min(eM.lat,eE.lat,eS.lat,eA.lat)],eC=[Math.max(eM.lng,eE.lng,eS.lng,eA.lng),Math.max(eM.lat,eE.lat,eS.lat,eA.lat)],eP=ed&&ed.pitch?ed.pitch:this.getPitch(),ez=this._cameraForBounds(this.transform,eI,eC,ec,eP,ed);return this._fitInternal(ez,ed,ef)}_fitInternal(el,eu,ec){return el?(delete(eu=en.ak(el,eu)).padding,eu.linear?this.easeTo(eu,ec):this.flyTo(eu,ec)):this}jumpTo(el,eu){this.stop();let ec=el.preloadOnly?this.transform.clone():this.transform,ed=!1,ef=!1,em=!1;return"zoom"in el&&ec.zoom!==+el.zoom&&(ed=!0,ec.zoom=+el.zoom),void 0!==el.center&&(ec.center=en.L.convert(el.center)),"bearing"in el&&ec.bearing!==+el.bearing&&(ef=!0,ec.bearing=+el.bearing),"pitch"in el&&ec.pitch!==+el.pitch&&(em=!0,ec.pitch=+el.pitch),null==el.padding||ec.isPaddingEqual(el.padding)||(ec.padding=el.padding),el.preloadOnly?(this._preloadTiles(ec),this):(this.fire(new en.a8("movestart",eu)).fire(new en.a8("move",eu)),ed&&this.fire(new en.a8("zoomstart",eu)).fire(new en.a8("zoom",eu)).fire(new en.a8("zoomend",eu)),ef&&this.fire(new en.a8("rotatestart",eu)).fire(new en.a8("rotate",eu)).fire(new en.a8("rotateend",eu)),em&&this.fire(new en.a8("pitchstart",eu)).fire(new en.a8("pitch",eu)).fire(new en.a8("pitchend",eu)),this.fire(new en.a8("moveend",eu)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||en.X(tN),this.transform.getFreeCameraOptions()}setFreeCameraOptions(el,eu){let ec=this.transform;if(!ec.projection.supportsFreeCamera)return en.X(tN),this;this.stop();let ed=ec.zoom,ef=ec.pitch,em=ec.bearing;ec.setFreeCameraOptions(el);let e_=ed!==ec.zoom,ew=ef!==ec.pitch,eT=em!==ec.bearing;return this.fire(new en.a8("movestart",eu)).fire(new en.a8("move",eu)),e_&&this.fire(new en.a8("zoomstart",eu)).fire(new en.a8("zoom",eu)).fire(new en.a8("zoomend",eu)),eT&&this.fire(new en.a8("rotatestart",eu)).fire(new en.a8("rotate",eu)).fire(new en.a8("rotateend",eu)),ew&&this.fire(new en.a8("pitchstart",eu)).fire(new en.a8("pitch",eu)).fire(new en.a8("pitchend",eu)),this.fire(new en.a8("moveend",eu)),this}easeTo(el,eu){let ec,ed,ef,em,e_;this._stop(!1,el.easeId),(!1===(el=en.ak({offset:[0,0],duration:500,easing:en.cG},el)).animate||this._prefersReducedMotion(el))&&(el.duration=0);let ew=this.transform,eT=this.getZoom(),eM=this.getBearing(),eE=this.getPitch(),eS=this.getPadding(),eA="zoom"in el?+el.zoom:eT,eI="bearing"in el?this._normalizeBearing(el.bearing,eM):eM,eC="pitch"in el?+el.pitch:eE,eP="padding"in el?el.padding:ew.padding,ez=en.P.convert(el.offset);if("globe"===ew.projection.name){let eu=en.M.fromLngLat(ew.center),em=ez.rotate(-ew.angle);eu.x+=em.x/ew.worldSize,eu.y+=em.y/ew.worldSize;let e_=eu.toLngLat(),eT=en.L.convert(el.center||e_);this._normalizeCenter(eT),ec=ew.centerPoint.add(em),ed=new en.P(eu.x,eu.y).mult(ew.worldSize),ef=new en.P(en.E(eT.lng),en.H(eT.lat)).mult(ew.worldSize).sub(ed)}else{ec=ew.centerPoint.add(ez);let eu=ew.pointLocation(ec),em=en.L.convert(el.center||eu);this._normalizeCenter(em),ed=ew.project(eu),ef=ew.project(em).sub(ed)}let eD=ew.zoomScale(eA-eT);el.around&&(em=en.L.convert(el.around),e_=ew.locationPoint(em));let eL=this._zooming||eA!==eT,ek=this._rotating||eM!==eI,eR=this._pitching||eC!==eE,eO=!ew.isPaddingEqual(eP),T=ew=>eB=>{if(eL&&(ew.zoom=en.n(eT,eA,eB)),ek&&(ew.bearing=en.n(eM,eI,eB)),eR&&(ew.pitch=en.n(eE,eC,eB)),eO&&(ew.interpolatePadding(eS,eP,eB),ec=ew.centerPoint.add(ez)),em)ew.setLocationAtPoint(em,e_);else{let en=ew.zoomScale(ew.zoom-eT),el=eA>eT?Math.min(2,eD):Math.max(.5,eD),eu=Math.pow(el,1-eB),em=ew.unproject(ed.add(ef.mult(eB*eu)).mult(en));ew.setLocationAtPoint(ew.renderWorldCopies?em.wrap():em,ec)}return el.preloadOnly||this._fireMoveEvents(eu),ew};if(el.preloadOnly){let en=this._emulate(T,el.duration,ew);return this._preloadTiles(en),this}let eB={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=eL,this._rotating=ek,this._pitching=eR,this._easeId=el.easeId,this._prepareEase(eu,el.noMoveStart,eB),this._ease(T(ew),en=>{"sea"===ew.cameraElevationReference&&ew.recenterOnTerrain(),this._afterEase(eu,en)},el),this}_prepareEase(el,eu,ec={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&0===this.transform.pitch&&"globe"!==this.transform.projection.name&&(this.transform.cameraElevationReference="ground"),eu||ec.moving||this.fire(new en.a8("movestart",el)),this._zooming&&!ec.zooming&&this.fire(new en.a8("zoomstart",el)),this._rotating&&!ec.rotating&&this.fire(new en.a8("rotatestart",el)),this._pitching&&!ec.pitching&&this.fire(new en.a8("pitchstart",el))}_fireMoveEvents(el){this.fire(new en.a8("move",el)),this._zooming&&this.fire(new en.a8("zoom",el)),this._rotating&&this.fire(new en.a8("rotate",el)),this._pitching&&this.fire(new en.a8("pitch",el))}_afterEase(el,eu){if(this._easeId&&eu&&this._easeId===eu)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";let ec=this._zooming,ed=this._rotating,ef=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,ec&&this.fire(new en.a8("zoomend",el)),ed&&this.fire(new en.a8("rotateend",el)),ef&&this.fire(new en.a8("pitchend",el)),this.fire(new en.a8("moveend",el))}flyTo(el,eu){if(this._prefersReducedMotion(el)){let ec=en.p(el,["center","zoom","bearing","pitch","around"]);return this.jumpTo(ec,eu)}this.stop(),el=en.ak({offset:[0,0],speed:1.2,curve:1.42,easing:en.cG},el);let ec=this.transform,ed=this.getZoom(),ef=this.getBearing(),em=this.getPitch(),e_="zoom"in el?en.c(+el.zoom,ec.minZoom,ec.maxZoom):ed,ew="bearing"in el?this._normalizeBearing(el.bearing,ef):ef,eT="pitch"in el?+el.pitch:em,eM=ec.zoomScale(e_-ed),eE=en.P.convert(el.offset),eS=ec.centerPoint.add(eE),eA=ec.pointLocation(eS),eI=el.center;if(eI&&el.padding){let en=this._cameraForBounds(this.transform,eI,eI,ew,eT,el);en&&(eI=en.center)}eI=en.L.convert(eI||eA),this._normalizeCenter(eI);let eC=ec.project(eA),eP=ec.project(eI).sub(eC),ez=el.curve,eD=Math.max(ec.width,ec.height),eL=eD/eM,ek=eP.mag();if("minZoom"in el){let eu=en.c(Math.min(el.minZoom,ed,e_),ec.minZoom,ec.maxZoom),ef=eD/ec.zoomScale(eu-ed);ez=Math.sqrt(ef/ek*2)}let eR=ez*ez;function w(en){let el=(eL*eL-eD*eD+(en?-1:1)*eR*eR*ek*ek)/(2*(en?eL:eD)*eR*ek);return Math.log(Math.sqrt(el*el+1)-el)}function T(en){return(Math.exp(en)-Math.exp(-en))/2}function E(en){return(Math.exp(en)+Math.exp(-en))/2}let eO=w(0),I=function(en){return E(eO)/E(eO+ez*en)},S=function(en){var el;return eD*((E(eO)*(T(el=eO+ez*en)/E(el))-T(eO))/eR)/ek},eB=(w(1)-eO)/ez;if(1e-6>Math.abs(ek)||!isFinite(eB)){if(1e-6>Math.abs(eD-eL))return this.easeTo(el,eu);let en=eL<eD?-1:1;eB=Math.abs(Math.log(eL/eD))/ez,S=function(){return 0},I=function(el){return Math.exp(en*ez*el)}}el.duration="duration"in el?+el.duration:1e3*eB/("screenSpeed"in el?+el.screenSpeed/ez:+el.speed),el.maxDuration&&el.duration>el.maxDuration&&(el.duration=0);let eF=ef!==ew,eN=eT!==em,D=ec=>eM=>{let eE=eM*eB,eA=1/I(eE);ec.zoom=1===eM?e_:ed+ec.scaleZoom(eA),eF&&(ec.bearing=en.n(ef,ew,eM)),eN&&(ec.pitch=en.n(em,eT,eM));let ez=1===eM?eI:ec.unproject(eC.add(eP.mult(S(eE))).mult(eA));return ec.setLocationAtPoint(ec.renderWorldCopies?ez.wrap():ez,eS),ec._updateCameraOnTerrain(),el.preloadOnly||this._fireMoveEvents(eu),ec};if(el.preloadOnly){let en=this._emulate(D,el.duration,ec);return this._preloadTiles(en),this}return this._zooming=!0,this._rotating=eF,this._pitching=eN,this._prepareEase(eu,!1),this._ease(D(ec),()=>this._afterEase(eu),el),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(en,el){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){let en=this._onEaseEnd;this._onEaseEnd=void 0,en.call(this,el)}if(!en){let en=this.handlers;en&&en.stop(!1)}return this}_ease(el,eu,ec){!1===ec.animate||0===ec.duration?(el(1),eu()):(this._easeStart=en.a4.now(),this._easeOptions=ec,this._onEaseFrame=el,this._onEaseEnd=eu,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){let el=Math.min((en.a4.now()-this._easeStart)/this._easeOptions.duration,1),eu=this._onEaseFrame;eu&&eu(this._easeOptions.easing(el)),el<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(el,eu){el=en.w(el,-180,180);let ec=Math.abs(el-eu);return Math.abs(el-360-eu)<ec&&(el-=360),Math.abs(el+360-eu)<ec&&(el+=360),el}_normalizeCenter(en){let el=this.transform;if(el.maxBounds||"globe"!==el.projection.name&&!el.renderWorldCopies)return;let eu=en.lng-el.center.lng;en.lng+=eu>180?-360:eu<-180?360:0}_prefersReducedMotion(el){return this._respectPrefersReducedMotion&&en.a4.prefersReducedMotion&&!(el&&el.essential)}_emulate(en,el,eu){let ec=Math.ceil(15*el/1e3),ed=[],ef=en(eu.clone());for(let en=0;en<=ec;en++){let el=ef(en/ec);ed.push(el.clone())}return ed}};let Ds=class Ds{constructor(el={}){this.options=el,en.aR(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(en){let el=this.options&&this.options.compact;return this._map=en,this._container=s("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=s("button","mapboxgl-ctrl-attrib-button",this._container),s("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden","true"),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=s("div","mapboxgl-ctrl-attrib-inner",this._container),el&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),void 0===el&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(en,el){let eu=this._map._getUIString(`AttributionControl.${el}`);en.removeAttribute("title"),en.firstElementChild&&en.firstElementChild.setAttribute("title",eu)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let el=this._editLink;el||(el=this._editLink=this._container.querySelector(".mapbox-improve-map"));let eu=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||en.cM.ACCESS_TOKEN}];if(el){let ec=eu.reduce((en,el,ec)=>(el.value&&(en+=`${el.key}=${el.value}${ec<eu.length-1?"&":""}`),en),"?");el.href=`${en.cM.FEEDBACK_URL}/${ec}#${zr(this._map,!0)}`,el.rel="noopener nofollow",this._setElementTitle(el,"MapFeedback")}}_updateData(en){en&&("metadata"===en.sourceDataType||"visibility"===en.sourceDataType||"style"===en.dataType)&&(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let en=[];if(this._map.style.stylesheet){let en=this._map.style.stylesheet;this.styleOwner=en.owner,this.styleId=en.id}let el=this._map.style._mergedSourceCaches;for(let eu in el){let ec=el[eu];if(ec.used){let el=ec.getSource();el.attribution&&0>en.indexOf(el.attribution)&&en.push(el.attribution)}}en.sort((en,el)=>en.length-el.length),en=en.filter((el,eu)=>{for(let ec=eu+1;ec<en.length;ec++)if(en[ec].indexOf(el)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?en=[...this.options.customAttribution,...en]:en.unshift(this.options.customAttribution));let eu=en.join(" | ");eu!==this._attribHTML&&(this._attribHTML=eu,en.length?(this._innerContainer.innerHTML=eu,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}};let As=class As{constructor(){en.aR(["_updateLogo","_updateCompact"],this)}onAdd(en){this._map=en,this._container=s("div","mapboxgl-ctrl");let el=s("a","mapboxgl-ctrl-logo");return el.target="_blank",el.rel="noopener nofollow",el.href="https://www.mapbox.com/",el.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),el.setAttribute("rel","noopener nofollow"),this._container.appendChild(el),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(en){en&&"metadata"!==en.sourceDataType||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;let en=this._map.style._sourceCaches;if(0===Object.entries(en).length)return!0;for(let el in en){let eu=en[el].getSource();if(eu.hasOwnProperty("mapbox_logo")&&!eu.mapbox_logo)return!1}return!0}_updateCompact(){let en=this._container.children;if(en.length){let el=en[0];this._map.getCanvasContainer().offsetWidth<250?el.classList.add("mapboxgl-compact"):el.classList.remove("mapboxgl-compact")}}};let Rs=class Rs{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(en){let el=++this._id;return this._queue.push({callback:en,id:el,cancelled:!1}),el}remove(en){let el=this._currentlyRunning,eu=el?this._queue.concat(el):this._queue;for(let el of eu)if(el.id===en)return void(el.cancelled=!0)}run(en=0){let el=this._currentlyRunning=this._queue;for(let eu of(this._queue=[],el))if(!eu.cancelled&&(eu.callback(en),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}};function zs(el,eu,ec){if(el=new en.L(el.lng,el.lat),eu){let ed=new en.L(el.lng-360,el.lat),ef=new en.L(el.lng+360,el.lat),em=360*Math.ceil(Math.abs(el.lng-ec.center.lng)/360),e_=ec.locationPoint(el).distSqr(eu),ew=eu.x<0||eu.y<0||eu.x>ec.width||eu.y>ec.height;ec.locationPoint(ed).distSqr(eu)<e_&&(ew||Math.abs(ed.lng-ec.center.lng)<em)?el=ed:ec.locationPoint(ef).distSqr(eu)<e_&&(ew||Math.abs(ef.lng-ec.center.lng)<em)&&(el=ef)}for(;Math.abs(el.lng-ec.center.lng)>180;){let en=ec.locationPoint(el);if(en.x>=0&&en.y>=0&&en.x<=ec.width&&en.y<=ec.height)break;el.lng>ec.center.lng?el.lng-=360:el.lng+=360}return el}let tU={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};let Fs=class Fs extends en.a6{constructor(el,eu){if(super(),(el instanceof HTMLElement||eu)&&(el=en.ak({element:el},eu)),en.aR(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=el&&el.anchor||"center",this._color=el&&el.color||"#3FB1CE",this._scale=el&&el.scale||1,this._draggable=el&&el.draggable||!1,this._clickTolerance=el&&el.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=el&&el.rotation||0,this._rotationAlignment=el&&el.rotationAlignment||"auto",this._pitchAlignment=el&&el.pitchAlignment&&el.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=el&&el.occludedOpacity||.2,el&&el.element)this._element=el.element,this._offset=en.P.convert(el&&el.offset||[0,0]);else{this._defaultMarker=!0,this._element=s("div");let eu=n("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},this._element),ec=n("radialGradient",{id:"shadowGradient"},n("defs",{},eu));n("stop",{offset:"10%","stop-opacity":.4},ec),n("stop",{offset:"100%","stop-opacity":.05},ec),n("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},eu),n("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},eu),n("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},eu),n("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},eu),this._offset=en.P.convert(el&&el.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",en=>{en.preventDefault()}),this._element.addEventListener("mousedown",en=>{en.preventDefault()});let ec=this._element.classList;for(let en in tU)ec.remove(`mapboxgl-marker-anchor-${en}`);ec.add(`mapboxgl-marker-anchor-${this._anchor}`);let ed=el&&el.className?el.className.trim().split(/\s+/):[];ec.add(...ed),this._popup=null}addTo(en){return en===this._map||(this.remove(),this._map=en,en.getCanvasContainer().appendChild(this._element),en.on("move",this._updateMoving),en.on("moveend",this._update),en.on("remove",this._clearFadeTimer),en._addMarker(this),this.setDraggable(this._draggable),this._update(),en.on("click",this._onMapClick)),this}remove(){let en=this._map;return en&&(en.off("click",this._onMapClick),en.off("move",this._updateMoving),en.off("moveend",this._update),en.off("mousedown",this._addDragHandler),en.off("touchstart",this._addDragHandler),en.off("mouseup",this._onUp),en.off("touchend",this._onUp),en.off("mousemove",this._onMove),en.off("touchmove",this._onMove),en.off("remove",this._clearFadeTimer),en._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(el){return this._lngLat=en.L.convert(el),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(en){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),en){if(!("offset"in en.options)){let el=Math.sqrt(91.125);en.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[el,-1*(24.6+el)],"bottom-right":[-el,-1*(24.6+el)],left:[13.5,-24.6],right:[-13.5,-24.6]}:this._offset}this._popup=en,en._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(en){let el=en.code,eu=en.charCode||en.keyCode;"Space"!==el&&"Enter"!==el&&32!==eu&&13!==eu||this.togglePopup()}_onMapClick(en){let el=en.originalEvent.target,eu=this._element;this._popup&&(el===eu||eu.contains(el))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){let en=this._popup;return en&&(en.isOpen()?(en.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(en.addTo(this._map),this._element.setAttribute("aria-expanded","true"))),this}_behindTerrain(){let en=this._map,el=this._pos;if(!en||!el)return!1;let eu=en.unproject(el),ec=en.getFreeCameraOptions();if(!ec.position)return!1;let ed=ec.position.toLngLat();return ed.distanceTo(eu)<.9*ed.distanceTo(this._lngLat)}_evaluateOpacity(){let el;let eu=this._map;if(!eu)return;let ec=this._pos;if(!ec||ec.x<0||ec.x>eu.transform.width||ec.y<0||ec.y>eu.transform.height)return void this._clearFadeTimer();let ed=eu.unproject(ec);eu._showingGlobe()&&en.cN(eu.transform,this._lngLat)?el=0:(el=1-eu._queryFogOpacity(ed),eu.transform._terrainEnabled()&&eu.getTerrain()&&this._behindTerrain()&&(el*=this._occludedOpacity)),this._element.style.opacity=`${el}`,this._element.style.pointerEvents=el>0?"auto":"none",this._popup&&this._popup._setOpacity(el),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){let en=this._pos;if(!en||!this._map)return;let el=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${en.x}px,${en.y}px)
            ${tU[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${el.x}px,${el.y}px)
        `}_calculateXYTransform(){let el=this._pos,eu=this._map,ec=this.getPitchAlignment();if(!eu||!el||"map"!==ec)return"";if(!eu._showingGlobe()){let en=eu.getPitch();return en?`rotateX(${en}deg)`:""}let ed=en.Y(en.cO(eu.transform,this._lngLat)),ef=el.sub(en.cP(eu.transform)),em=Math.abs(ef.x)+Math.abs(ef.y);if(0===em)return"";let e_=ed/em;return`rotateX(${-ef.y*e_}deg) rotateY(${ef.x*e_}deg)`}_calculateZTransform(){let el=this._pos,eu=this._map;if(!eu||!el)return"";let ec=0,ed=this.getRotationAlignment();if("map"===ed){if(eu._showingGlobe()){let el=eu.project(new en.L(this._lngLat.lng,this._lngLat.lat+.001)),ed=eu.project(new en.L(this._lngLat.lng,this._lngLat.lat-.001)).sub(el);ec=en.Y(Math.atan2(ed.y,ed.x))-90}else ec=-eu.getBearing()}else if("horizon"===ed){let ed=en.an(4,6,eu.getZoom()),ef=en.cP(eu.transform);ef.y+=ed*eu.transform.height;let em=el.sub(ef),e_=en.Y(Math.atan2(em.y,em.x));ec=(e_>90?e_-270:e_+90)*(1-ed)}return(ec+=this._rotation)?`rotateZ(${ec}deg)`:""}_update(en){cancelAnimationFrame(this._updateFrameId);let el=this._map;el&&(el.transform.renderWorldCopies&&(this._lngLat=zs(this._lngLat,this._pos,el.transform)),this._pos=el.project(this._lngLat),!0===en?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),el._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(el._showingGlobe()||el.getTerrain()||el.getFog())&&!this._fadeTimer&&(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(el){return this._offset=en.P.convert(el),this._update(),this}addClassName(en){return this._element.classList.add(en),this}removeClassName(en){return this._element.classList.remove(en),this}toggleClassName(en){return this._element.classList.toggle(en)}_onMove(el){let eu=this._map;if(!eu)return;let ec=this._pointerdownPos,ed=this._positionDelta;if(ec&&ed){if(!this._isDragging){let en=this._clickTolerance||eu._clickTolerance;if(el.point.dist(ec)<en)return;this._isDragging=!0}this._pos=el.point.sub(ed),this._lngLat=eu.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new en.a8("dragstart"))),this.fire(new en.a8("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;let el=this._map;el&&(el.off("mousemove",this._onMove),el.off("touchmove",this._onMove)),"active"===this._state&&this.fire(new en.a8("dragend")),this._state="inactive"}_addDragHandler(en){let el=this._map,eu=this._pos;el&&eu&&this._element.contains(en.originalEvent.target)&&(en.preventDefault(),this._positionDelta=en.point.sub(eu),this._pointerdownPos=en.point,this._state="pending",el.on("mousemove",this._onMove),el.on("touchmove",this._onMove),el.once("mouseup",this._onUp),el.once("touchend",this._onUp))}setDraggable(en){this._draggable=!!en;let el=this._map;return el&&(en?(el.on("mousedown",this._addDragHandler),el.on("touchstart",this._addDragHandler)):(el.off("mousedown",this._addDragHandler),el.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(en){return this._rotation=en||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(en){return this._rotationAlignment=en||"auto",this._update(),this}getRotationAlignment(){return"auto"===this._rotationAlignment||"horizon"===this._rotationAlignment&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(en){return this._pitchAlignment=en||"auto",this._update(),this}getPitchAlignment(){return"auto"===this._pitchAlignment?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(en){return this._occludedOpacity=en||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}};let tV={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"};function Ns(el=new en.P(0,0),eu="bottom"){if("number"==typeof el){let ec=Math.round(Math.sqrt(.5*Math.pow(el,2)));switch(eu){case"top":return new en.P(0,el);case"top-left":return new en.P(ec,ec);case"top-right":return new en.P(-ec,ec);case"bottom":return new en.P(0,-el);case"bottom-left":return new en.P(ec,-ec);case"bottom-right":return new en.P(-ec,-ec);case"left":return new en.P(el,0);case"right":return new en.P(-el,0)}return new en.P(0,0)}return el instanceof en.P||Array.isArray(el)?en.P.convert(el):en.P.convert(el[eu]||[0,0])}let Us=class Us{constructor(en){this.jumpTo(en)}getValue(el){if(el<=this._startTime)return this._start;if(el>=this._endTime)return this._end;let eu=en.ba((el-this._startTime)/(this._endTime-this._startTime));return this._start*(1-eu)+this._end*eu}isEasing(en){return en>=this._startTime&&en<=this._endTime}jumpTo(en){this._startTime=-1/0,this._endTime=-1/0,this._start=en,this._end=en}easeTo(en,el,eu){this._start=this.getValue(el),this._end=en,this._startTime=el,this._endTime=el+eu}};let tj={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use  + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"},tG={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1};let Vs=class Vs{constructor(){this.showOverdrawInspector=!1,this.showTileBoundaries=!1,this.continuousRedraw=!1,this.showTerrainWireframe=!1,this.showLayers2DWireframe=!1,this.showLayers3DWireframe=!1}};let tq={showCompass:!0,showZoom:!0,visualizePitch:!1};let Ws=class Ws{constructor(el,eu,ec=!1){this._clickTolerance=10,this.element=eu,this.mouseRotate=new is({clickTolerance:el.dragRotate._mouseRotate._clickTolerance}),this.map=el,ec&&(this.mousePitch=new os({clickTolerance:el.dragRotate._mousePitch._clickTolerance})),en.aR(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),eu.addEventListener("mousedown",this.mousedown),eu.addEventListener("touchstart",this.touchstart,{passive:!1}),eu.addEventListener("touchmove",this.touchmove),eu.addEventListener("touchend",this.touchend),eu.addEventListener("touchcancel",this.reset)}down(en,el){this.mouseRotate.mousedown(en,el),this.mousePitch&&this.mousePitch.mousedown(en,el),h()}move(en,el){let eu=this.map,ec=this.mouseRotate.mousemoveWindow(en,el),ed=ec&&ec.bearingDelta;if(ed&&eu.setBearing(eu.getBearing()+ed),this.mousePitch){let ec=this.mousePitch.mousemoveWindow(en,el),ed=ec&&ec.pitchDelta;ed&&eu.setPitch(eu.getPitch()+ed)}}off(){let en=this.element;en.removeEventListener("mousedown",this.mousedown),en.removeEventListener("touchstart",this.touchstart,{passive:!1}),en.removeEventListener("touchmove",this.touchmove),en.removeEventListener("touchend",this.touchend),en.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){_(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(el){this.down(en.ak({},el,{ctrlKey:!0,preventDefault:()=>el.preventDefault()}),p(this.element,el)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(en){this.move(en,p(this.element,en))}mouseup(en){this.mouseRotate.mouseupWindow(en),this.mousePitch&&this.mousePitch.mouseupWindow(en),this.offTemp()}touchstart(en){1!==en.targetTouches.length?this.reset():(this._startPos=this._lastPos=m(this.element,en.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>en.preventDefault()},this._startPos))}touchmove(en){1!==en.targetTouches.length?this.reset():(this._lastPos=m(this.element,en.targetTouches)[0],this.move({preventDefault:()=>en.preventDefault()},this._lastPos))}touchend(en){0===en.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}};let tZ={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},t$={maxWidth:100,unit:"metric"},tW={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},tH={version:en.c$,supported:o,setRTLTextPlugin:en.d1,getRTLTextPluginStatus:en.d2,Map:class extends Ps{constructor(el){let eu=el;if(null!=(el=en.ak({},tG,el)).minZoom&&null!=el.maxZoom&&el.minZoom>el.maxZoom)throw Error("maxZoom must be greater than or equal to minZoom");if(null!=el.minPitch&&null!=el.maxPitch&&el.minPitch>el.maxPitch)throw Error("maxPitch must be greater than or equal to minPitch");if(null!=el.minPitch&&el.minPitch<0)throw Error("minPitch must be greater than or equal to 0");if(null!=el.maxPitch&&el.maxPitch>85)throw Error("maxPitch must be less than or equal to 85");if(el.antialias&&en.cQ(window)&&(el.antialias=!1,en.X("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new De(el.minZoom,el.maxZoom,el.minPitch,el.maxPitch,el.renderWorldCopies),el),this._repaint=!1,this._interactive=el.interactive,this._minTileCacheSize=el.minTileCacheSize,this._maxTileCacheSize=el.maxTileCacheSize,this._failIfMajorPerformanceCaveat=el.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=el.preserveDrawingBuffer,this._antialias=el.antialias,this._trackResize=el.trackResize,this._bearingSnap=el.bearingSnap,this._refreshExpiredTiles=el.refreshExpiredTiles,this._fadeDuration=el.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=el.crossSourceCollisions,this._collectResourceTiming=el.collectResourceTiming,this._language=this._parseLanguage(el.language),this._worldview=el.worldview,this._renderTaskQueue=new Rs,this._domRenderTaskQueue=new Rs,this._controls=[],this._markers=[],this._popups=[],this._mapId=en.cR(),this._locale=en.ak({},tj,el.locale),this._clickTolerance=el.clickTolerance,this._cooperativeGestures=el.cooperativeGestures,this._performanceMetricsCollection=el.performanceMetricsCollection,this._containerWidth=0,this._containerHeight=0,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new Us(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._requestManager=new en.cS(el.transformRequest,el.accessToken,el.testMode),this._silenceAuthErrors=!!el.testMode,this._contextCreateOptions=el.contextCreateOptions?{...el.contextCreateOptions}:{},"string"==typeof el.container){let en=document.getElementById(el.container);if(!en)throw Error(`Container '${el.container.toString()}' not found.`);this._container=en}else{if(!(el.container instanceof HTMLElement))throw Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=el.container}if(this._container.childNodes.length>0&&en.X("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),el.maxBounds&&this.setMaxBounds(el.maxBounds),en.aR(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._debugParams=new Vs,this._tp=el.devtools?new dr(this):new dr,this._tp.registerParameter(this._debugParams,["Debug"],"showOverdrawInspector",void 0,()=>{this._update()}),this._tp.registerParameter(this._debugParams,["Debug"],"showTileBoundaries",void 0,()=>{this._update()}),this._tp.registerParameter(this._debugParams,["Debug"],"continuousRedraw",void 0,en=>{this.repaint=en}),this._tp.registerParameter(this._debugParams,["Debug","Wireframe"],"showTerrainWireframe",void 0,()=>{this._update()}),this._tp.registerParameter(this._debugParams,["Debug","Wireframe"],"showLayers2DWireframe",void 0,()=>{this._update()}),this._tp.registerParameter(this._debugParams,["Debug","Wireframe"],"showLayers3DWireframe",void 0,()=>{this._update()}),this._setupPainter(),void 0===this.painter)throw Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new Ms(this,el),this._localFontFamily=el.localFontFamily,this._localIdeographFontFamily=el.localIdeographFontFamily,(el.style||!el.testMode)&&this.setStyle(el.style||en.cM.DEFAULT_STYLE,{localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),el.projection&&this.setProjection(el.projection),el.hash&&(this._hash=new Rr("string"==typeof el.hash&&el.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){null==eu.center&&null==eu.zoom||(this.transform._unmodified=!1),this.jumpTo({center:el.center,zoom:el.zoom,bearing:el.bearing,pitch:el.pitch});let ec=el.bounds;ec&&(this.resize(),this.fitBounds(ec,en.ak({},el.fitBoundsOptions,{duration:0})))}this.resize(),el.attributionControl&&this.addControl(new Ds({customAttribution:el.customAttribution})),this._logoControl=new As,this.addControl(this._logoControl,el.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)}),this.on("data",el=>{this._update("style"===el.dataType),this.fire(new en.a8(`${el.dataType}data`,el))}),this.on("dataloading",el=>{this.fire(new en.a8(`${el.dataType}dataloading`,el))})}_getMapId(){return this._mapId}addControl(el,eu){if(void 0===eu&&(eu=el.getDefaultPosition?el.getDefaultPosition():"top-right"),!el||!el.onAdd)return this.fire(new en.a7(Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));let ec=el.onAdd(this);this._controls.push(el);let ed=this._controlPositions[eu];return -1!==eu.indexOf("bottom")?ed.insertBefore(ec,ed.firstChild):ed.appendChild(ec),this}removeControl(el){if(!el||!el.onRemove)return this.fire(new en.a7(Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));let eu=this._controls.indexOf(el);return eu>-1&&this._controls.splice(eu,1),el.onRemove(this),this}hasControl(en){return this._controls.indexOf(en)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(el){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));let eu=!this._moving;return eu&&this.fire(new en.a8("movestart",el)).fire(new en.a8("move",el)),this.fire(new en.a8("resize",el)),eu&&this.fire(new en.a8("moveend",el)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(el){return this.transform.setMaxBounds(en.D.convert(el)),this._update()}setMinZoom(el){if((el=null==el?-2:el)>=-2&&el<=this.transform.maxZoom)return this.transform.minZoom=el,this._update(),this.getZoom()<el?this.setZoom(el):this.fire(new en.a8("zoomstart")).fire(new en.a8("zoom")).fire(new en.a8("zoomend")),this;throw Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(el){if((el=null==el?22:el)>=this.transform.minZoom)return this.transform.maxZoom=el,this._update(),this.getZoom()>el?this.setZoom(el):this.fire(new en.a8("zoomstart")).fire(new en.a8("zoom")).fire(new en.a8("zoomend")),this;throw Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(el){if((el=null==el?0:el)<0)throw Error("minPitch must be greater than or equal to 0");if(el>=0&&el<=this.transform.maxPitch)return this.transform.minPitch=el,this._update(),this.getPitch()<el?this.setPitch(el):this.fire(new en.a8("pitchstart")).fire(new en.a8("pitch")).fire(new en.a8("pitchend")),this;throw Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(el){if((el=null==el?85:el)>85)throw Error("maxPitch must be less than or equal to 85");if(el>=this.transform.minPitch)return this.transform.maxPitch=el,this._update(),this.getPitch()>el?this.setPitch(el):this.fire(new en.a8("pitchstart")).fire(new en.a8("pitch")).fire(new en.a8("pitchend")),this;throw Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(en){return this.transform.renderWorldCopies=en,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(en){return"auto"===en?navigator.language:Array.isArray(en)?0===en.length?void 0:en.map(en=>"auto"===en?navigator.language:en):en}setLanguage(en){let el=this._parseLanguage(en);if(!this.style||el===this._language)return this;for(let en of(this._language=el,this.style.reloadSources(),this._controls))en._setLanguage&&en._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(en){return this.style&&en!==this._worldview&&(this._worldview=en,this.style.reloadSources()),this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return"globe"===this.transform.projection.name}setProjection(en){return this._lazyInitEmptyStyle(),en?"string"==typeof en&&(en={name:en}):en=null,this._useExplicitProjection=!!en,this._prioritizeAndUpdateProjection(en,this.style.projection)}_updateProjectionTransition(){let el;if("globe"!==this.getProjection().name)return;let eu=this.transform,ec=eu.projection.name;"globe"===ec&&eu.zoom>=en.G?(eu.setMercatorFromTransition(),el=!0):"mercator"===ec&&eu.zoom<en.G&&(eu.setProjection({name:"globe"}),el=!0),el&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(en,el){return this._updateProjection(en||el||{name:"mercator"})}_updateProjection(el){let eu;return eu="globe"===el.name&&this.transform.zoom>=en.G?this.transform.setMercatorFromTransition():this.transform.setProjection(el),this.style.applyProjectionUpdate(),eu&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(el){return this.transform.locationPoint3D(en.L.convert(el))}unproject(el){return this.transform.pointLocation3D(en.P.convert(el))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(en,el,eu){if("mouseenter"===en||"mouseover"===en){let ec=!1;return{layers:new Set(el),listener:eu,delegates:{mousemove:ed=>{let ef=el.filter(en=>this.getLayer(en)),em=ef.length?this.queryRenderedFeatures(ed.point,{layers:ef}):[];em.length?ec||(ec=!0,eu.call(this,new Vr(en,this,ed.originalEvent,{features:em}))):ec=!1},mouseout:()=>{ec=!1}}}}if("mouseleave"===en||"mouseout"===en){let ec=!1;return{layers:new Set(el),listener:eu,delegates:{mousemove:ed=>{let ef=el.filter(en=>this.getLayer(en));(ef.length?this.queryRenderedFeatures(ed.point,{layers:ef}):[]).length?ec=!0:ec&&(ec=!1,eu.call(this,new Vr(en,this,ed.originalEvent)))},mouseout:el=>{ec&&(ec=!1,eu.call(this,new Vr(en,this,el.originalEvent)))}}}}return{layers:new Set(el),listener:eu,delegates:{[en]:en=>{let ec=el.filter(en=>this.getLayer(en)),ed=ec.length?this.queryRenderedFeatures(en.point,{layers:ec}):[];ed.length&&(en.features=ed,eu.call(this,en),delete en.features)}}}}on(en,el,eu){if(void 0===eu)return super.on(en,el);if(Array.isArray(el)||(el=[el]),el){for(let en of el)if(!this._isValidId(en))return this}let ec=this._createDelegatedListener(en,el,eu);for(let el in this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[en]=this._delegatedListeners[en]||[],this._delegatedListeners[en].push(ec),ec.delegates)this.on(el,ec.delegates[el]);return this}once(en,el,eu){if(void 0===eu)return super.once(en,el);if(Array.isArray(el)||(el=[el]),el){for(let en of el)if(!this._isValidId(en))return this}let ec=this._createDelegatedListener(en,el,eu);for(let en in ec.delegates)this.once(en,ec.delegates[en]);return this}off(en,el,eu){if(void 0===eu)return super.off(en,el);for(let en of el=new Set(Array.isArray(el)?el:[el]))if(!this._isValidId(en))return this;let o=(en,el)=>{if(en.size!==el.size)return!1;for(let eu of en)if(!el.has(eu))return!1;return!0},ec=this._delegatedListeners?this._delegatedListeners[en]:void 0;return ec&&(en=>{for(let ec=0;ec<en.length;ec++){let ed=en[ec];if(ed.listener===eu&&o(ed.layers,el)){for(let en in ed.delegates)this.off(en,ed.delegates[en]);return en.splice(ec,1),this}}})(ec),this}queryRenderedFeatures(el,eu){if(!this.style)return[];if(void 0!==eu||void 0===el||el instanceof en.P||Array.isArray(el)||(eu=el,el=void 0),el=el||[[0,0],[this.transform.width,this.transform.height]],(eu=eu||{}).layers&&Array.isArray(eu.layers)){for(let en of eu.layers)if(!this._isValidId(en))return[]}return this.style.queryRenderedFeatures(el,eu,this.transform)}querySourceFeatures(en,el){return this._isValidId(en)?this.style.querySourceFeatures(en,el):[]}isPointOnSurface(el){let{name:eu}=this.transform.projection;return"globe"!==eu&&"mercator"!==eu&&en.X(`${eu} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(en.P.convert(el))}setStyle(el,eu){return!1!==(eu=en.ak({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},eu)).diff&&eu.localIdeographFontFamily===this._localIdeographFontFamily&&eu.localFontFamily===this._localFontFamily&&this.style&&el?(this._diffStyle(el,eu),this):(this._localIdeographFontFamily=eu.localIdeographFontFamily,this._localFontFamily=eu.localFontFamily,this._updateStyle(el,eu))}_getUIString(en){let el=this._locale[en];if(null==el)throw Error(`Missing UI string '${en}'`);return el}_updateStyle(en,el){return this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),en&&(this.style=new Dr(this,el||{}),this.style.setEventedParent(this,{style:this.style}),"string"==typeof en?this.style.loadURL(en):this.style.loadJSON(en)),this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Dr(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(el,eu){if("string"==typeof el){let ec=this._requestManager.normalizeStyleURL(el),ed=this._requestManager.transformRequest(ec,en.a2.Style);en.a1(ed,(el,ec)=>{el?this.fire(new en.a7(el)):ec&&this._updateDiff(ec,eu)})}else"object"==typeof el&&this._updateDiff(el,eu)}_updateDiff(el,eu){try{this.style.setState(el)&&this._update(!0)}catch(ec){en.X(`Unable to perform style diff: ${ec.message||ec.error||ec}.  Rebuilding the style from scratch.`),this._updateStyle(el,eu)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(en.X("There is no style added to the map."),!1)}_isValidId(el){return null==el?(this.fire(new en.a7(Error("IDs can't be empty."))),!1):!en.cu(el)||(this.fire(new en.a7(Error(`IDs can't contain special symbols: "${el}".`))),!1)}addSource(en,el){return this._isValidId(en)?(this._lazyInitEmptyStyle(),this.style.addSource(en,el),this._update(!0)):this}isSourceLoaded(en){return!!this._isValidId(en)&&!!this.style&&this.style._isSourceCacheLoaded(en)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(en,el,eu){this._lazyInitEmptyStyle(),this.style.addSourceType(en,el,eu)}removeSource(en){return this._isValidId(en)?(this.style.removeSource(en),this._updateTerrain(),this._update(!0)):this}getSource(en){return this._isValidId(en)?this.style.getOwnSource(en):null}addImage(el,eu,{pixelRatio:ec=1,sdf:ed=!1,stretchX:ef,stretchY:em,content:e_}={}){if(this._lazyInitEmptyStyle(),eu instanceof HTMLImageElement||ImageBitmap&&eu instanceof ImageBitmap){let{width:ew,height:eT,data:eM}=en.a4.getImageData(eu);this.style.addImage(el,{data:new en.a5({width:ew,height:eT},eM),pixelRatio:ec,stretchX:ef,stretchY:em,content:e_,sdf:ed,version:0})}else if(void 0===eu.width||void 0===eu.height)this.fire(new en.a7(Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{let{width:ew,height:eT}=eu;this.style.addImage(el,{data:new en.a5({width:ew,height:eT},new Uint8Array(eu.data)),pixelRatio:ec,stretchX:ef,stretchY:em,content:e_,sdf:ed,version:0,userImage:eu}),eu.onAdd&&eu.onAdd(this,el)}}updateImage(el,eu){this._lazyInitEmptyStyle();let ec=this.style.getImage(el);if(!ec)return void this.fire(new en.a7(Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));let ed=eu instanceof HTMLImageElement||ImageBitmap&&eu instanceof ImageBitmap?en.a4.getImageData(eu):eu,{width:ef,height:em}=ed,e_=ed.data;if(void 0===ef||void 0===em)return void this.fire(new en.a7(Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(ef!==ec.data.width||em!==ec.data.height)return void this.fire(new en.a7(Error(`The width and height of the updated image (${ef}, ${em})
                must be that same as the previous version of the image
                (${ec.data.width}, ${ec.data.height})`)));let ew=!(eu instanceof HTMLImageElement||ImageBitmap&&eu instanceof ImageBitmap);ec.data.replace(e_,ew),this.style.updateImage(el,ec)}hasImage(el){return el?!!this.style&&!!this.style.getImage(el):(this.fire(new en.a7(Error("Missing required image id"))),!1)}removeImage(en){this.style.removeImage(en)}loadImage(el,eu){en.a3(this._requestManager.transformRequest(el,en.a2.Image),(el,ec)=>{eu(el,ec instanceof HTMLImageElement?en.a4.getImageData(ec):ec)})}listImages(){return this.style.listImages()}addModel(en,el){this._lazyInitEmptyStyle(),this.style.addModel(en,el)}hasModel(el){return el?this.style.hasModel(el):(this.fire(new en.a7(Error("Missing required model id"))),!1)}removeModel(en){this.style.removeModel(en)}listModels(){return this.style.listModels()}addLayer(en,el){return this._isValidId(en.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(en,el),this._update(!0)):this}moveLayer(en,el){return this._isValidId(en)?(this.style.moveLayer(en,el),this._update(!0)):this}removeLayer(en){return this._isValidId(en)?(this.style.removeLayer(en),this._update(!0)):this}getLayer(en){return this._isValidId(en)?this.style.getOwnLayer(en):null}setLayerZoomRange(en,el,eu){return this._isValidId(en)?(this.style.setLayerZoomRange(en,el,eu),this._update(!0)):this}setFilter(en,el,eu={}){return this._isValidId(en)?(this.style.setFilter(en,el,eu),this._update(!0)):this}getFilter(en){return this._isValidId(en)?this.style.getFilter(en):null}setPaintProperty(en,el,eu,ec={}){return this._isValidId(en)?(this.style.setPaintProperty(en,el,eu,ec),this._update(!0)):this}getPaintProperty(en,el){return this._isValidId(en)?this.style.getPaintProperty(en,el):null}setLayoutProperty(en,el,eu,ec={}){return this._isValidId(en)?(this.style.setLayoutProperty(en,el,eu,ec),this._update(!0)):this}getLayoutProperty(en,el){return this._isValidId(en)?this.style.getLayoutProperty(en,el):null}getConfigProperty(en,el){return this.style.getConfigProperty(en,el)}setConfigProperty(en,el,eu){return this.style.setConfigProperty(en,el,eu),this._update(!0)}setLights(en){if(this._lazyInitEmptyStyle(),en&&1===en.length&&"flat"===en[0].type){let el=en[0];el.properties?this.style.setFlatLight(el.properties,el.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(en),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){let en=this.style.getLights()||[];return 0===en.length&&en.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),en}setLight(en,el={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:en}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(en){return this._lazyInitEmptyStyle(),!en&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(en),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(en){return this._lazyInitEmptyStyle(),this.style.setFog(en),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setCamera(en){return this.style.setCamera(en),this._triggerCameraUpdate(en)}_triggerCameraUpdate(en){return this._update(this.transform.setOrthographicProjectionAtLowPitch("orthographic"===en["camera-projection"]))}getCamera(){return this.style.camera}_queryFogOpacity(el){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(en.L.convert(el),this.transform):0}setFeatureState(en,el){return this._isValidId(en.source)?(this.style.setFeatureState(en,el),this._update()):this}removeFeatureState(en,el){return this._isValidId(en.source)?(this.style.removeFeatureState(en,el),this._update()):this}getFeatureState(en){return this._isValidId(en.source)?this.style.getFeatureState(en):null}_updateContainerDimensions(){if(!this._container)return;let en=this._container.getBoundingClientRect().width||400,el=this._container.getBoundingClientRect().height||300,eu,ec,ed,ef=this._container;for(;ef&&(!ec||!ed);){let en=window.getComputedStyle(ef).transform;en&&"none"!==en&&((eu=en.match(/matrix.*\((.+)\)/)[1].split(", "))[0]&&"0"!==eu[0]&&"1"!==eu[0]&&(ec=eu[0]),eu[3]&&"0"!==eu[3]&&"1"!==eu[3]&&(ed=eu[3])),ef=ef.parentElement}this._containerWidth=ec?Math.abs(en/ec):en,this._containerHeight=ed?Math.abs(el/ed):el}_detectMissingCSS(){"rgb(250, 128, 114)"!==window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")&&en.X("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){let en=this._container;en.classList.add("mapboxgl-map"),(this._missingCSSCanary=s("div","mapboxgl-canary",en)).style.visibility="hidden",this._detectMissingCSS();let el=this._canvasContainer=s("div","mapboxgl-canvas-container",en);this._canvas=s("canvas","mapboxgl-canvas",el),this._interactive&&(el.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);let eu=this._controlContainer=s("div","mapboxgl-control-container",en),ec=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(en=>{ec[en]=s("div",`mapboxgl-ctrl-${en}`,eu)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(el,eu){let ec=en.a4.devicePixelRatio||1;this._canvas.width=ec*Math.ceil(el),this._canvas.height=ec*Math.ceil(eu),this._canvas.style.width=`${el}px`,this._canvas.style.height=`${eu}px`}_addMarker(en){this._markers.push(en)}_removeMarker(en){let el=this._markers.indexOf(en);-1!==el&&this._markers.splice(el,1)}_addPopup(en){this._popups.push(en)}_removePopup(en){let el=this._popups.indexOf(en);-1!==el&&this._popups.splice(el,1)}_setupPainter(){let el=en.ak({},o.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),eu=this._canvas.getContext("webgl2",el);eu?(en.cT(eu,!0),this.painter=new mr(eu,this._contextCreateOptions,this.transform,this._tp),this.on("data",en=>{"source"===en.dataType&&this.painter.setTileLoadedFlag(!0)}),en.cU.testSupport(eu)):this.fire(new en.a7(Error("Failed to initialize WebGL")))}_contextLost(el){el.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new en.a8("webglcontextlost",{originalEvent:el}))}_contextRestored(el){this._setupPainter(),this.resize(),this._update(),this.fire(new en.a8("webglcontextrestored",{originalEvent:el}))}_onMapScroll(en){if(en.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(en){return this.style&&(this._styleDirty=this._styleDirty||en,this._sourcesDirty=!0,this.triggerRepaint()),this}_requestRenderFrame(en){return this._update(),this._renderTaskQueue.add(en)}_cancelRenderFrame(en){this._renderTaskQueue.remove(en)}_requestDomTask(en){!this.loaded()||this.loaded()&&!this.isMoving()?en():this._domRenderTaskQueue.add(en)}_render(el){let eu;this.fire(new en.a8("renderstart"));let ec=this.painter.context.extTimerQuery,ed=en.a4.now(),ef=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(eu=ef.createQuery(),ef.beginQuery(ec.TIME_ELAPSED_EXT,eu)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(el),this._domRenderTaskQueue.run(el),this._removed)return;this._updateProjectionTransition();let em=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;let el=this.transform.zoom,eu=this.transform.pitch,ec=en.a4.now(),ed=new en.al(el,{now:ec,fadeDuration:em,pitch:eu,transition:this.style.transition});this.style.update(ed)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let e_=!1;if(this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),e_=this._updateAverageElevation(ed),this.style.updateSources(this.transform),this._forceMarkerAndPopupUpdate()):e_=this._updateAverageElevation(ed),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,em,this._crossSourceCollisions),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries||this._debugParams.showTileBoundaries,wireframe:{terrain:this.showTerrainWireframe||this._debugParams.showTerrainWireframe,layers2D:this.showLayers2DWireframe||this._debugParams.showLayers2DWireframe,layers3D:this.showLayers3DWireframe||this._debugParams.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector||this._debugParams.showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:em,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new en.a8("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,this.fire(new en.a8("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),eu){let el=en.a4.now()-ed;ef.endQuery(ec.TIME_ELAPSED_EXT),setTimeout(()=>{let ec=ef.getQueryParameter(eu,ef.QUERY_RESULT)/1e6;ef.deleteQuery(eu),this.fire(new en.a8("gpu-timing-frame",{cpuTime:el,gpuTime:ec}))},50)}if(this.listens("gpu-timing-layer")){let el=this.painter.collectGpuTimers();setTimeout(()=>{let eu=this.painter.queryGpuTimers(el);this.fire(new en.a8("gpu-timing-layer",{layerTimes:eu}))},50)}if(this.listens("gpu-timing-deferred-render")){let el=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{let eu=this.painter.queryGpuTimeDeferredRender(el);this.fire(new en.a8("gpu-timing-deferred-render",{gpuTime:eu}))},50)}let ew=this._sourcesDirty||this._styleDirty||this._placementDirty||e_;if(ew||this._repaint)this.triggerRepaint();else{let el=!this.isMoving()&&this.loaded();if(el&&(e_=this._updateAverageElevation(ed,!0)),e_)this.triggerRepaint();else if(this._triggerFrame(!1),el&&(this.fire(new en.a8("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){let el=this._calculateSpeedIndex();this.fire(new en.a8("speedindexcompleted",{speedIndex:el})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||ew||(this._fullyLoaded=!0,this._performanceMetricsCollection&&en.cV(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(en){for(let el of this._markers)en&&!this.getRenderWorldCopies()&&(el._lngLat=el._lngLat.wrap()),el._update();for(let el of this._popups)!en||this.getRenderWorldCopies()||el._trackPointer||(el._lngLat=el._lngLat.wrap()),el._update()}_updateAverageElevation(en,el=!1){let i=en=>(this.transform.averageElevation=en,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return 0!==this.transform.averageElevation&&i(0);let eu=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(eu||(el||en-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(en)){let el=this.transform.averageElevation,ec=this.transform.sampleAverageElevation();this.transform.elevation&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(ec)?ec=0:this._averageElevationLastSampledAt=en;let ed=Math.abs(el-ec);if(ed>1){if(this._isInitialLoad||eu)return this._averageElevation.jumpTo(ec),i(ec);this._averageElevation.easeTo(ec,en,300)}else if(ed>1e-4)return this._averageElevation.jumpTo(ec),i(ec)}return!!this._averageElevation.isEasing(en)&&i(this._averageElevation.getValue(en))}_authenticate(){en.cW(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,el=>{if(el&&(el.message===en.cX||401===el.status)){let el=this.painter.context.gl;en.cT(el,!1),this._logoControl instanceof As&&this._logoControl._updateLogo(),el&&el.clear(el.DEPTH_BUFFER_BIT|el.COLOR_BUFFER_BIT|el.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new en.a7(Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),en.cY(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_updateTerrain(){let en=this._isDragging();this.painter.updateTerrain(this.style,en)}_calculateSpeedIndex(){let en=this.painter.canvasCopy(),el=this.painter.getCanvasCopiesAndTimestamps();el.timeStamps.push(performance.now());let eu=this.painter.context.gl,ec=eu.createFramebuffer();function r(en){eu.framebufferTexture2D(eu.FRAMEBUFFER,eu.COLOR_ATTACHMENT0,eu.TEXTURE_2D,en,0);let el=new Uint8Array(eu.drawingBufferWidth*eu.drawingBufferHeight*4);return eu.readPixels(0,0,eu.drawingBufferWidth,eu.drawingBufferHeight,eu.RGBA,eu.UNSIGNED_BYTE,el),el}return eu.bindFramebuffer(eu.FRAMEBUFFER,ec),this._canvasPixelComparison(r(en),el.canvasCopies.map(r),el.timeStamps)}_canvasPixelComparison(en,el,eu){let ec=eu[1]-eu[0],ed=en.length/4;for(let ef=0;ef<el.length;ef++){let em=el[ef],e_=0;for(let el=0;el<em.length;el+=4)em[el]===en[el]&&em[el+1]===en[el+1]&&em[el+2]===en[el+2]&&em[el+3]===en[el+3]&&(e_+=1);ec+=(eu[ef+2]-eu[ef+1])*(1-e_/ed)}return ec}remove(){for(let en of(this._hash&&this._hash.remove(),this._controls))en.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);let el=this.painter.context.gl.getExtension("WEBGL_lose_context");el&&el.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),en.cZ(this.painter.context.gl),this._removed=!0,this.fire(new en.a8("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(el){this._renderNextFrame=this._renderNextFrame||el,this.style&&!this._frame&&(this._frame=en.a4.frame(en=>{let el=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,el&&this._render(en)}))}_preloadTiles(el){let eu=this.style?Object.values(this.style._sourceCaches):[];return en.c_(eu,(en,eu)=>en._preloadTiles(el,eu),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(en){this._trackResize&&this.resize({originalEvent:en})._update()}_onVisibilityChange(){"hidden"===document.visibilityState&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(en){this._showTileBoundaries!==en&&(this._showTileBoundaries=en,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(en){this._showTerrainWireframe!==en&&(this._showTerrainWireframe=en,this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(en){this._showLayers2DWireframe!==en&&(this._showLayers2DWireframe=en,this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(en){this._showLayers3DWireframe!==en&&(this._showLayers3DWireframe=en,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(en){this._speedIndexTiming!==en&&(this._speedIndexTiming=en,this._update())}get showPadding(){return!!this._showPadding}set showPadding(en){this._showPadding!==en&&(this._showPadding=en,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(en){this._showCollisionBoxes!==en&&(this._showCollisionBoxes=en,en?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(en){this._showOverdrawInspector!==en&&(this._showOverdrawInspector=en,this._update())}get repaint(){return!!this._repaint}set repaint(en){this._repaint!==en&&(this._repaint=en,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(en){this._vertices=en,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(en){this._showTileAABBs!==en&&(this._showTileAABBs=en,en&&this._update())}_setCacheLimits(el,eu){en.d0(el,eu)}get version(){return en.c$}},NavigationControl:class{constructor(el){this.options=en.ak({},tq,el),this._container=s("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",en=>en.preventDefault()),this.options.showZoom&&(en.aR(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",en=>{this._map&&this._map.zoomIn({},{originalEvent:en})}),s("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",en=>{this._map&&this._map.zoomOut({},{originalEvent:en})}),s("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(en.aR(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",en=>{let el=this._map;el&&(this.options.visualizePitch?el.resetNorthPitch({},{originalEvent:en}):el.resetNorth({},{originalEvent:en}))}),this._compassIcon=s("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){let en=this._map;if(!en)return;let el=en.getZoom(),eu=el===en.getMaxZoom(),ec=el===en.getMinZoom();this._zoomInButton.disabled=eu,this._zoomOutButton.disabled=ec,this._zoomInButton.setAttribute("aria-disabled",eu.toString()),this._zoomOutButton.setAttribute("aria-disabled",ec.toString())}_rotateCompassArrow(){let en=this._map;if(!en)return;let el=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(en.transform.pitch*(Math.PI/180)),.5)}) rotateX(${en.transform.pitch}deg) rotateZ(${en.transform.angle*(180/Math.PI)}deg)`:`rotate(${en.transform.angle*(180/Math.PI)}deg)`;en._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=el)})}onAdd(en){return this._map=en,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),en.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&en.on("pitch",this._rotateCompassArrow),en.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Ws(en,this._compass,this.options.visualizePitch)),this._container}onRemove(){let en=this._map;en&&(this._container.remove(),this.options.showZoom&&en.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&en.off("pitch",this._rotateCompassArrow),en.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(en,el){let eu=s("button",en,this._container);return eu.type="button",eu.addEventListener("click",el),eu}_setButtonTitle(en,el){if(!this._map)return;let eu=this._map._getUIString(`NavigationControl.${el}`);en.setAttribute("aria-label",eu),en.firstElementChild&&en.firstElementChild.setAttribute("title",eu)}},GeolocateControl:class extends en.a6{constructor(el){super();let eu=navigator.geolocation;this.options=en.ak({geolocation:eu},tZ,el),en.aR(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Ar(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(en){return this._map=en,this._container=s("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){void 0!==this._geolocationWatchID&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(en){let t=(el=!!this.options.geolocation)=>{this._supportsGeolocation=el,en(el)};void 0!==this._supportsGeolocation?en(this._supportsGeolocation):void 0!==navigator.permissions?navigator.permissions.query({name:"geolocation"}).then(en=>t("denied"!==en.state)).catch(()=>t()):t()}_isOutOfMapMaxBounds(en){let el=this._map.getMaxBounds(),eu=en.coords;return!!el&&(eu.longitude<el.getWest()||eu.longitude>el.getEast()||eu.latitude<el.getSouth()||eu.latitude>el.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(el){if(this._map){if(this._isOutOfMapMaxBounds(el))return this._setErrorState(),this.fire(new en.a8("outofmaxbounds",el)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=el,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(el),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(el),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new en.a8("geolocate",el)),this._finish()}}_updateCamera(el){let eu=new en.L(el.coords.longitude,el.coords.latitude),ec=el.coords.accuracy,ed=this._map.getBearing(),ef=en.ak({bearing:ed},this.options.fitBoundsOptions);this._map.fitBounds(eu.toBounds(ec),ef,{geolocateSource:!0})}_updateMarker(el){if(el){let eu=new en.L(el.coords.longitude,el.coords.latitude);this._accuracyCircleMarker.setLngLat(eu).addTo(this._map),this._userLocationDotMarker.setLngLat(eu).addTo(this._map),this._accuracy=el.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){let el=this._map.transform,eu=en.b(1,el._center.lat)*el.worldSize,ec=Math.ceil(2*this._accuracy*eu);this._circleElement.style.width=`${ec}px`,this._circleElement.style.height=`${ec}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&"number"==typeof this._heading?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(el){if(this._map){if(this.options.trackUserLocation){if(1===el.code){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;let en=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",en),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",en),void 0!==this._geolocationWatchID&&this._clearWatch()}else{if(3===el.code&&this._noTimeout)return;this._setErrorState()}}"OFF"!==this._watchState&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new en.a8("error",el)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(el){if(void 0!==this._map){if(this._container.addEventListener("contextmenu",en=>en.preventDefault()),this._geolocateButton=s("button","mapboxgl-ctrl-geolocate",this._container),s("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",!1===el){en.X("Geolocation support is not available so the GeolocateControl will be disabled.");let el=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",el),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",el)}else{let en=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",en),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",en)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=s("div","mapboxgl-user-location"),this._dotElement.appendChild(s("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(s("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Fs({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=s("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Fs({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",el=>{el.geolocateSource||"ACTIVE_LOCK"!==this._watchState||el.originalEvent&&"resize"===el.originalEvent.type||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new en.a8("trackuserlocationend")))})}}_onDeviceOrientation(en){this._userLocationDotMarker&&(en.webkitCompassHeading?this._heading=en.webkitCompassHeading:!0===en.absolute&&(this._heading=-1*en.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return en.X("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new en.a8("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new en.a8("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new en.a8("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let en;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(en={maximumAge:6e5,timeout:0},this._noTimeout=!0):(en=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,en),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){let e=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};"undefined"!=typeof DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceOrientationEvent.requestPermission().then(en=>{"granted"===en&&e()}).catch(console.error):e()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Ds,ScaleControl:class{constructor(el){this.options=en.ak({},t$,el),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch(en){return!1}}(),en.aR(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){let en=this.options.maxWidth||100,el=this._map,eu=el._containerHeight/2,ec=el._containerWidth/2-en/2,ed=el.unproject([ec,eu]),ef=el.unproject([ec+en,eu]),em=ed.distanceTo(ef);if("imperial"===this.options.unit){let el=3.2808*em;el>5280?this._setScale(en,el/5280,"mile"):this._setScale(en,el,"foot")}else"nautical"===this.options.unit?this._setScale(en,em/1852,"nautical-mile"):em>=1e3?this._setScale(en,em/1e3,"kilometer"):this._setScale(en,em,"meter")}_setScale(en,el,eu){this._map._requestDomTask(()=>{let ec=function(en){let el=Math.pow(10,`${Math.floor(en)}`.length-1),eu=en/el;return el*(eu=eu>=10?10:eu>=5?5:eu>=3?3:eu>=2?2:eu>=1?1:function(en){let el=Math.pow(10,Math.ceil(-Math.log(en)/Math.LN10));return Math.round(en*el)/el}(eu))}(el),ed=ec/el;this._container.innerHTML=this._isNumberFormatSupported&&"nautical-mile"!==eu?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:eu}).format(ec):`${ec}&nbsp;${tW[eu]}`,this._container.style.width=en*ed+"px"})}onAdd(en){return this._map=en,this._language=en.getLanguage(),this._container=s("div","mapboxgl-ctrl mapboxgl-ctrl-scale",en.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(en){this._language=en,this._update()}setUnit(en){this.options.unit=en,this._update()}},FullscreenControl:class{constructor(el){this._fullscreen=!1,el&&el.container&&(el.container instanceof HTMLElement?this._container=el.container:en.X("Full screen control 'container' must be a DOM element.")),en.aR(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(el){return this._map=el,this._container||(this._container=this._map.getContainer()),this._controlContainer=s("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",en.X("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){let en=this._fullscreenButton=s("button","mapboxgl-ctrl-fullscreen",this._controlContainer);s("span","mapboxgl-ctrl-icon",en).setAttribute("aria-hidden","true"),en.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){let en=this._getTitle();this._fullscreenButton.setAttribute("aria-label",en),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",en)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends en.a6{constructor(el){super(),this.options=en.ak(Object.create(tV),el),en.aR(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(el&&el.className?el.className.trim().split(/\s+/):[])}addTo(el){return this._map&&this.remove(),this._map=el,this.options.closeOnClick&&el.on("preclick",this._onClose),this.options.closeOnMove&&el.on("move",this._onClose),el.on("remove",this.remove),this._update(),el._addPopup(this),this._focusFirstElement(),this._trackPointer?(el.on("mousemove",this._onMouseEvent),el.on("mouseup",this._onMouseEvent),el._canvasContainer.classList.add("mapboxgl-track-pointer")):el.on("move",this._update),this.fire(new en.a8("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);let el=this._map;return el&&(el.off("move",this._update),el.off("move",this._onClose),el.off("preclick",this._onClose),el.off("click",this._onClose),el.off("remove",this.remove),el.off("mousemove",this._onMouseEvent),el.off("mouseup",this._onMouseEvent),el.off("drag",this._onMouseEvent),el._canvasContainer&&el._canvasContainer.classList.remove("mapboxgl-track-pointer"),el._removePopup(this),this._map=void 0),this.fire(new en.a8("close")),this}getLngLat(){return this._lngLat}setLngLat(el){this._lngLat=en.L.convert(el),this._pos=null,this._trackPointer=!1,this._update();let eu=this._map;return eu&&(eu.on("move",this._update),eu.off("mousemove",this._onMouseEvent),eu._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();let en=this._map;return en&&(en.off("move",this._update),en.on("mousemove",this._onMouseEvent),en.on("drag",this._onMouseEvent),en._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(en){return this.setDOMContent(document.createTextNode(en))}setHTML(en){let el;let eu=document.createDocumentFragment(),ec=document.createElement("body");for(ec.innerHTML=en;el=ec.firstChild;)eu.appendChild(el);return this.setDOMContent(eu)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(en){return this.options.maxWidth=en,this._update(),this}setDOMContent(en){let el=this._content;if(el)for(;el.hasChildNodes();)el.firstChild&&el.removeChild(el.firstChild);else el=this._content=s("div","mapboxgl-popup-content",this._container||void 0);if(el.appendChild(en),this.options.closeButton){let en=this._closeButton=s("button","mapboxgl-popup-close-button",el);en.type="button",en.setAttribute("aria-label","Close popup"),en.setAttribute("aria-hidden","true"),en.innerHTML="&#215;",en.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(en){return this._classList.add(en),this._updateClassList(),this}removeClassName(en){return this._classList.delete(en),this._updateClassList(),this}setOffset(en){return this.options.offset=en,this._update(),this}toggleClassName(en){let el;return this._classList.delete(en)?el=!1:(this._classList.add(en),el=!0),this._updateClassList(),el}_onMouseEvent(en){this._update(en.point)}_getAnchor(en){if(this.options.anchor)return this.options.anchor;let el=this._map,eu=this._container,ec=this._pos;if(!el||!eu||!ec)return"bottom";let ed=eu.offsetWidth,ef=eu.offsetHeight,em=ec.x<ed/2,e_=ec.x>el.transform.width-ed/2;if(ec.y+en<ef)return em?"top-left":e_?"top-right":"top";if(ec.y>el.transform.height-ef){if(em)return"bottom-left";if(e_)return"bottom-right"}return em?"left":e_?"right":"bottom"}_updateClassList(){let en=this._container;if(!en)return;let el=[...this._classList];el.push("mapboxgl-popup"),this._anchor&&el.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&el.push("mapboxgl-popup-track-pointer"),en.className=el.join(" ")}_update(el){let eu=this._map,ec=this._content;if(!eu||!this._lngLat&&!this._trackPointer||!ec)return;let ed=this._container;if(ed||(ed=this._container=s("div","mapboxgl-popup",eu.getContainer()),this._tip=s("div","mapboxgl-popup-tip",ed),ed.appendChild(ec)),this.options.maxWidth&&ed.style.maxWidth!==this.options.maxWidth&&(ed.style.maxWidth=this.options.maxWidth),eu.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=zs(this._lngLat,this._pos,eu.transform)),!this._trackPointer||el){let en=this._pos=this._trackPointer&&el?el:eu.project(this._lngLat),ec=Ns(this.options.offset),ed=this._anchor=this._getAnchor(ec.y),ef=Ns(this.options.offset,ed),em=en.add(ef).round();eu._requestDomTask(()=>{this._container&&ed&&(this._container.style.transform=`${tU[ed]} translate(${em.x}px,${em.y}px)`)})}if(!this._marker&&eu._showingGlobe()){let el=en.cN(eu.transform,this._lngLat)?0:1;this._setOpacity(el)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;let en=this._container.querySelector("a[href], [tabindex]:not([tabindex='-1']), [contenteditable]:not([contenteditable='false']), button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled])");en&&en.focus()}_onClose(){this.remove()}_setOpacity(en){this._container&&(this._container.style.opacity=`${en}`),this._content&&(this._content.style.pointerEvents=en?"auto":"none")}},Marker:Fs,Style:Dr,LngLat:en.L,LngLatBounds:en.D,Point:en.P,MercatorCoordinate:en.M,FreeCameraOptions:he,Evented:en.a6,config:en.cM,prewarm:en.d3,clearPrewarmedResources:en.d4,get accessToken(){return en.cM.ACCESS_TOKEN},set accessToken(t){en.cM.ACCESS_TOKEN=t},get baseApiUrl(){return en.cM.API_URL},set baseApiUrl(t){en.cM.API_URL=t},get workerCount(){return en.d5.workerCount},set workerCount(t){en.d5.workerCount=t},get maxParallelImageRequests(){return en.cM.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(t){en.cM.MAX_PARALLEL_IMAGE_REQUESTS=t},clearStorage(el){en.d6(el)},get workerUrl(){return en.d7.workerUrl},set workerUrl(t){en.d7.workerUrl=t},get workerClass(){return en.d7.workerClass},set workerClass(t){en.d7.workerClass=t},get workerParams(){return en.d7.workerParams},set workerParams(t){en.d7.workerParams=t},get dracoUrl(){return en.d8()},set dracoUrl(t){en.d9(t)},setNow:en.a4.setNow,restoreNow:en.a4.restoreNow};return tH}),eu}()}}]);